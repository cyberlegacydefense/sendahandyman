// netlify/functions/send-notification.js
export const handler = async (event, context) => {
  try {
    if (event.httpMethod === "OPTIONS") {
      return { statusCode: 200, headers: cors() };
    }
    if (event.httpMethod !== "POST") {
      return { statusCode: 405, headers: cors(), body: JSON.stringify({ error: "Method not allowed" }) };
    }

    const jobData = JSON.parse(event.body || "{}");

    // Create formatted email content based on type
    const emailContent = jobData.type === 'task_completion'
      ? createCompletionEmailContent(jobData)
      : jobData.type === 'additional_charge'
      ? createAdditionalChargeEmailContent(jobData)
      : createEmailContent(jobData);

    // Send email using a simple email service
    // For MVP, we'll use a webhook to Zapier or similar service
    // You can replace this with SendGrid, Mailgun, etc.

    try {
      // Option 1: Use Zapier webhook (replace with your webhook URL)
      const zapierWebhookUrl = process.env.ZAPIER_WEBHOOK_URL;

      if (zapierWebhookUrl) {
        await fetch(zapierWebhookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            to: jobData.type === 'task_completion' ? jobData.customer.email : 'info@sendahandyman.com',
            subject: jobData.type === 'task_completion'
              ? `âœ… Work Complete: ${jobData.task.category} - Payment Processed ($${jobData.payment.amount})`
              : `ðŸ”§ NEW JOB: ${jobData.task.category} - ${jobData.customer.name}`,
            message: emailContent,
            payment_amount: jobData.type === 'task_completion'
              ? `$${jobData.payment.amount}`
              : `$${jobData.amount}`,
            payment_id: jobData.type === 'task_completion'
              ? jobData.payment.payment_intent_id
              : jobData.payment_intent_id
          })
        });
      }

      // Option 2: Log to function logs (you can check these manually)
      console.log("=== NEW JOB NOTIFICATION ===");
      console.log(emailContent);
      console.log("================================");

      return {
        statusCode: 200,
        headers: cors(),
        body: JSON.stringify({ success: true, message: "Notification sent" })
      };

    } catch (emailError) {
      console.error('Email sending failed:', emailError);
      // Still log the job details even if email fails
      console.log("=== FAILED EMAIL - JOB DETAILS ===");
      console.log(emailContent);
      console.log("===================================");

      return {
        statusCode: 200,
        headers: cors(),
        body: JSON.stringify({ success: true, message: "Job logged" })
      };
    }

  } catch (error) {
    console.error('Notification function error:', error);
    return {
      statusCode: 500,
      headers: cors(),
      body: JSON.stringify({ error: 'Notification failed', detail: error.message })
    };
  }
};

function createEmailContent(jobData) {
  const { customer, task, estimate, amount, payment_intent_id } = jobData;

  return `
ðŸ”§ NEW HANDYMAN JOB REQUEST

ðŸ’° PAYMENT CONFIRMED: $${amount} (${payment_intent_id})

ðŸ‘¤ CUSTOMER INFO:
Name: ${customer.name}
Phone: ${customer.phone}
Email: ${customer.email}
Address: ${customer.address}

ðŸ“‹ JOB DETAILS:
Task: ${task.category}
Window: ${task.window}
Description: ${task.description}
Additional Details: ${task.task_details || 'None'}
Special Instructions: ${task.special_instructions || 'None'}

ðŸ” AI SCOPE FOR CUSTOMER:
${(estimate?.step_scope || []).map(step => `â€¢ ${step}`).join('\n')}

âš ï¸ CUSTOMER RISK FLAGS:
${(estimate?.risk_flags || []).map(flag => `â€¢ ${flag}`).join('\n')}

ðŸ› ï¸ HANDYMAN TECHNICAL INSTRUCTIONS:
${(estimate?.handyman_data?.scope || []).map(step => `â€¢ ${step}`).join('\n')}

âš ï¸ TECHNICAL RISK FLAGS:
${(estimate?.handyman_data?.risks || []).map(risk => `â€¢ ${risk}`).join('\n')}

ðŸ§° TOOLS & PARTS TO BRING:
${(estimate?.handyman_data?.tools || []).map(tool => `â€¢ ${tool}`).join('\n')}

â±ï¸ ESTIMATED DURATION: ${estimate?.estimated_duration_hours || 'Unknown'} hours

---
Generated by SendAHandyman AI
Time: ${new Date().toLocaleString()}
  `.trim();
}

function createCompletionEmailContent(jobData) {
  const { customer, task, handyman, payment, completion_photos } = jobData;

  return `
âœ… YOUR HANDYMAN WORK IS COMPLETE!

Dear ${customer.name},

Great news! Your handyman service has been completed successfully.

ðŸ“‹ JOB DETAILS:
Task ID: ${task.id}
Service: ${task.category}
Address: ${customer.address}
Completed: ${new Date(task.completed_at).toLocaleString()}

ðŸ‘· HANDYMAN:
Name: ${handyman.name || 'Professional Handyman'}
Phone: ${handyman.phone || 'Available via app'}

ðŸ’° PAYMENT PROCESSED:
Amount Charged: $${payment.amount}
Payment ID: ${payment.payment_intent_id}
Status: Payment completed successfully

ðŸ“ COMPLETION NOTES:
${task.completion_notes}

ðŸ“¸ COMPLETION PHOTOS:
${completion_photos && completion_photos.length > 0
  ? `${completion_photos.length} photo(s) have been uploaded showing the completed work.`
  : 'Photos available in your customer portal.'}

ðŸŒŸ HOW WAS OUR SERVICE?
We'd love to hear about your experience! Please take a moment to leave us a review.

ðŸ“ž QUESTIONS OR CONCERNS?
If you have any questions about the completed work or your payment, please contact us immediately.

Thank you for choosing SendAHandyman!

---
Generated by SendAHandyman
Time: ${new Date().toLocaleString()}
  `.trim();
}

function createAdditionalChargeEmailContent(jobData) {
  const { customer, task, additional_charge } = jobData;

  return `
ðŸ’³ ADDITIONAL MATERIALS CHARGE

Dear ${customer.name},

Your handyman has completed your service and needed to purchase additional materials for your project.

ðŸ“‹ JOB DETAILS:
Task ID: ${task.id}
Service: ${task.category}
Address: ${customer.address}

ðŸ’° ADDITIONAL CHARGES:
Travel Fee: $${additional_charge.travel_fee}
Materials Cost: $${additional_charge.material_costs}
Total Additional Charge: $${additional_charge.total_amount}

ðŸ“ WHAT HAPPENED:
Your handyman arrived and assessed your project. During the service, additional materials were needed to complete the work properly. Your handyman got your approval before purchasing these materials.

ðŸ’³ PAYMENT:
This additional amount has been automatically charged to the same payment method you used for your original booking.

ðŸ“¸ RECEIPTS:
${additional_charge.receipts && additional_charge.receipts.length > 0
  ? `${additional_charge.receipts.length} receipt(s) are attached showing the materials purchased.`
  : 'Material receipts will be provided by your handyman.'}

ðŸ“ž QUESTIONS OR CONCERNS?
If you have any questions about these additional charges or need clarification, please contact us immediately.

Thank you for choosing SendAHandyman!

---
Generated by SendAHandyman
Time: ${new Date().toLocaleString()}
  `.trim();
}

function cors() {
  return {
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Allow-Methods": "POST, OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type, Authorization"
  };
}