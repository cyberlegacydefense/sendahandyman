<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Handyman Dashboard - SendAHandyman</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="images/favicon.png">

  <!-- Tailwind CSS via CDN - For development only. In production, install as PostCSS plugin -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .shadow-soft{box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .shadow-md{box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06)}
    .tab-active { border-bottom: 3px solid #4f46e5; color: #4f46e5; }
    .progress-step.active { background: #4f46e5; color: white; }
    .progress-step.completed { background: #10b981; color: white; }
    .schedule-cell { cursor: pointer; transition: all 0.2s; }
    .schedule-cell:hover { background: #e0e7ff; }
    .schedule-cell.selected { background: #4f46e5; color: white; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
  </style>
</head>
<body class="bg-slate-50">

<!-- Login Page -->
<div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl p-8 shadow-soft border border-slate-100 w-full max-w-md">
    <div class="text-center mb-6 md:mb-8">
      <img src="images/helpinghands_logo.png" alt="SendAHandyman" class="h-16 md:h-20 w-auto mx-auto mb-4" />
      <h1 class="text-xl md:text-2xl font-bold mb-2">Handyman Portal</h1>
      <p class="text-sm md:text-base text-slate-600">Sign in to access your dashboard</p>
    </div>

    <form id="loginForm" class="space-y-4">
      <div>
        <label class="block text-xs md:text-sm font-semibold mb-1">Email</label>
        <input type="email" id="loginEmail" required class="w-full rounded-lg border border-slate-200 px-3 py-2" />
      </div>
      <div>
        <label class="block text-xs md:text-sm font-semibold mb-1">Password</label>
        <div class="relative">
          <input type="password" id="loginPassword" required class="w-full rounded-lg border border-slate-200 px-3 py-2 pr-10" />
          <button type="button" id="togglePassword" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-700 focus:outline-none">
            <svg id="eyeIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            </svg>
            <svg id="eyeSlashIcon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
            </svg>
          </button>
        </div>
      </div>
      <button type="submit" class="w-full rounded-xl bg-indigo-600 text-white px-4 py-2 md:py-3 text-sm md:text-base font-semibold hover:bg-indigo-700 transition-colors">
        Sign In
      </button>
      <div id="loginError" class="hidden text-sm text-red-600 text-center"></div>

      <!-- Forgot Password Link -->
      <div class="text-center mt-4">
        <button type="button" id="forgotPasswordBtn" class="text-sm text-indigo-600 hover:text-indigo-800 transition-colors">
          Forgot your password?
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Password Reset Modal -->
<div id="passwordResetModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
  <div class="bg-white rounded-2xl p-6 md:p-8 shadow-xl border border-slate-100 w-full max-w-md">
    <div class="text-center mb-6">
      <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100 mb-4">
        <svg class="h-6 w-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 0 1 2 2m4 0a6 6 0 0 1-7.743 5.743L11 17H9v2H7v2H4a1 1 0 0 1-1-1v-2.586a1 1 0 0 1 .293-.707l5.964-5.964A6 6 0 0 1 17 21z"></path>
        </svg>
      </div>
      <h3 class="text-xl font-bold text-gray-900 mb-2">Reset Password</h3>
      <p class="text-sm text-gray-600">Enter your email address and we'll send you a link to reset your password.</p>
    </div>

    <form id="passwordResetForm" class="space-y-4">
      <div>
        <label class="block text-sm font-semibold mb-2">Email Address</label>
        <input
          type="email"
          id="resetEmail"
          required
          placeholder="Enter your email"
          class="w-full rounded-lg border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
        />
      </div>

      <div id="resetError" class="hidden text-sm text-red-600 text-center"></div>
      <div id="resetSuccess" class="hidden text-sm text-green-600 text-center"></div>

      <div class="flex gap-3 pt-2">
        <button
          type="button"
          id="cancelResetBtn"
          class="flex-1 rounded-lg bg-gray-100 text-gray-700 px-4 py-2 font-semibold hover:bg-gray-200 transition-colors"
        >
          Cancel
        </button>
        <button
          type="submit"
          id="submitResetBtn"
          class="flex-1 rounded-lg bg-indigo-600 text-white px-4 py-2 font-semibold hover:bg-indigo-700 transition-colors"
        >
          <span id="resetBtnText">Send Reset Link</span>
          <span id="resetBtnLoading" class="hidden">Sending...</span>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Password Update Form (for recovery) -->
<div id="passwordUpdateModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
  <div class="bg-white rounded-2xl p-6 md:p-8 shadow-xl border border-slate-100 w-full max-w-md">
    <div class="text-center mb-6">
      <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
        <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 0 1 2 2m4 0a6 6 0 0 1-7.743 5.743L11 17H9v2H7v2H4a1 1 0 0 1-1-1v-2.586a1 1 0 0 1 .293-.707l5.964-5.964A6 6 0 0 1 17 21z"></path>
        </svg>
      </div>
      <h3 class="text-xl font-bold text-gray-900 mb-2">Create New Password</h3>
      <p class="text-sm text-gray-600">Please enter a new password for your account.</p>
    </div>

    <form id="passwordUpdateForm" class="space-y-4">
      <div>
        <label class="block text-sm font-semibold mb-2">New Password</label>
        <div class="relative">
          <input
            type="password"
            id="resetNewPassword"
            required
            placeholder="Enter new password"
            class="w-full rounded-lg border border-slate-200 px-3 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-green-500"
          />
          <button type="button" id="toggleNewPassword" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-700">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            </svg>
          </button>
        </div>
      </div>

      <div>
        <label class="block text-sm font-semibold mb-2">Confirm New Password</label>
        <input
          type="password"
          id="resetConfirmPassword"
          required
          placeholder="Confirm new password"
          class="w-full rounded-lg border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500"
        />
      </div>

      <div id="updateError" class="hidden text-sm text-red-600 text-center"></div>
      <div id="updateSuccess" class="hidden text-sm text-green-600 text-center"></div>

      <button
        type="submit"
        id="submitUpdateBtn"
        class="w-full rounded-lg bg-green-600 text-white px-4 py-2 font-semibold hover:bg-green-700 transition-colors"
      >
        <span id="updateBtnText">Update Password</span>
        <span id="updateBtnLoading" class="hidden">Updating...</span>
      </button>
    </form>
  </div>
</div>

<!-- Onboarding Wizard -->
<div id="onboardingWizard" class="hidden min-h-screen bg-slate-50">
  <div class="max-w-5xl mx-auto px-4 py-8">
    <!-- Progress Bar -->
    <div class="bg-white rounded-xl p-4 md:p-6 shadow-soft border border-slate-100 mb-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg md:text-xl font-bold">Complete Your Profile</h2>
        <span id="onboardingProgress" class="text-sm font-semibold text-indigo-600">Step 1 of 9</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="progress-step active flex items-center justify-center w-10 h-10 rounded-full bg-slate-200 text-sm font-bold">1</div>
        <div class="flex-1 h-2 bg-slate-200 rounded"></div>
        <div class="progress-step flex items-center justify-center w-10 h-10 rounded-full bg-slate-200 text-sm font-bold">2</div>
        <div class="flex-1 h-2 bg-slate-200 rounded"></div>
        <div class="progress-step flex items-center justify-center w-10 h-10 rounded-full bg-slate-200 text-sm font-bold">3</div>
        <div class="flex-1 h-2 bg-slate-200 rounded"></div>
        <div class="progress-step flex items-center justify-center w-10 h-10 rounded-full bg-slate-200 text-sm font-bold">4</div>
        <div class="flex-1 h-2 bg-slate-200 rounded"></div>
        <div class="progress-step flex items-center justify-center w-10 h-10 rounded-full bg-slate-200 text-sm font-bold">5</div>
        <div class="flex-1 h-2 bg-slate-200 rounded"></div>
        <div class="progress-step flex items-center justify-center w-10 h-10 rounded-full bg-slate-200 text-sm font-bold">6</div>
        <div class="flex-1 h-2 bg-slate-200 rounded"></div>
        <div class="progress-step flex items-center justify-center w-10 h-10 rounded-full bg-slate-200 text-sm font-bold">7</div>
        <div class="flex-1 h-2 bg-slate-200 rounded"></div>
        <div class="progress-step flex items-center justify-center w-10 h-10 rounded-full bg-slate-200 text-sm font-bold">8</div>
        <div class="flex-1 h-2 bg-slate-200 rounded"></div>
        <div class="progress-step flex items-center justify-center w-10 h-10 rounded-full bg-slate-200 text-sm font-bold">9</div>
      </div>
    </div>

    <!-- Step 1: Personal & Identity Verification -->
    <div id="step1" class="onboarding-step bg-white rounded-xl p-8 shadow-soft border border-slate-100">
      <h3 class="text-xl md:text-2xl font-bold mb-2">Personal & Identity Verification</h3>
      <p class="text-sm md:text-base text-slate-600 mb-4 md:mb-6">We need to verify your identity for insurance and payment purposes.</p>

      <form id="step1Form" class="space-y-6">
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-xs md:text-sm font-semibold mb-1">Full Legal Name *</label>
            <input type="text" id="legalName" required class="w-full rounded-lg border border-slate-200 px-3 py-2" />
          </div>
          <div>
            <label class="block text-xs md:text-sm font-semibold mb-1">Date of Birth *</label>
            <input type="date" id="dob" required class="w-full rounded-lg border border-slate-200 px-3 py-2" />
          </div>
        </div>

        <div>
          <label class="block text-xs md:text-sm font-semibold mb-2">Tax Identification</label>
          <div class="flex gap-4 mb-2">
            <label class="flex items-center gap-2">
              <input type="radio" name="taxIdType" value="ssn" checked onchange="toggleTaxIdField()" />
              <span class="text-sm">SSN (Individual)</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="radio" name="taxIdType" value="ein" onchange="toggleTaxIdField()" />
              <span class="text-sm">EIN (Business/LLC/Corp)</span>
            </label>
          </div>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-xs md:text-sm font-semibold mb-1" id="taxIdLabel">Social Security Number (SSN) *</label>
              <input type="text" id="ssn" required maxlength="11" placeholder="XXX-XX-XXXX" class="w-full rounded-lg border border-slate-200 px-3 py-2" />
              <p class="text-xs text-slate-500 mt-1">Required for 1099 tax reporting</p>
            </div>
            <div>
              <label class="block text-xs md:text-sm font-semibold mb-1">Driver's License / State ID Number *</label>
              <input type="text" id="idNumber" required class="w-full rounded-lg border border-slate-200 px-3 py-2" />
            </div>
          </div>
        </div>

        <div>
          <label class="block text-xs md:text-sm font-semibold mb-2">Upload Government-Issued ID *</label>
          <input type="file" id="govId" accept="image/*,.pdf" required class="w-full rounded-lg border border-slate-200 px-3 py-2" />
          <p class="text-xs text-slate-500 mt-1">Driver's license, passport, or state ID. Both sides if applicable.</p>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">Profile Photo *</label>
          <input type="file" id="profilePhoto" accept="image/*" required class="w-full rounded-lg border border-slate-200 px-3 py-2" />
          <p class="text-xs text-slate-500 mt-1">Professional headshot for your profile</p>
        </div>

        <div class="flex justify-end gap-3">
          <button type="submit" class="rounded-xl bg-indigo-600 text-white px-6 py-3 font-semibold hover:bg-indigo-700 transition-colors">
            Next Step ‚Üí
          </button>
        </div>
      </form>
    </div>

    <!-- Step 2: Licensing & Insurance -->
    <div id="step2" class="onboarding-step hidden bg-white rounded-xl p-8 shadow-soft border border-slate-100">
      <h3 class="text-2xl font-bold mb-2">Licensing & Insurance</h3>
      <p class="text-slate-600 mb-6">Depending on your services, you may need specific licenses and insurance.</p>

      <form id="step2Form" class="space-y-6">
        <div>
          <label class="block text-sm font-semibold mb-3">Do you have any trade licenses? <span class="text-slate-500 font-normal">(Optional)</span></label>
          <div class="space-y-3" id="licenseContainer">
            <div class="border border-slate-200 rounded-lg p-4">
              <div class="grid md:grid-cols-3 gap-3">
                <input type="text" placeholder="License Type (e.g., Electrician)" class="license-type rounded-lg border border-slate-200 px-3 py-2" />
                <input type="text" placeholder="License Number" class="license-number rounded-lg border border-slate-200 px-3 py-2" />
                <input type="date" placeholder="Expiration Date" class="license-expiry rounded-lg border border-slate-200 px-3 py-2" />
              </div>
              <input type="file" accept="image/*,.pdf" class="license-file w-full rounded-lg border border-slate-200 px-3 py-2 mt-2" />
            </div>
          </div>
          <button type="button" id="addLicense" class="mt-2 text-sm text-indigo-600 hover:text-indigo-700 font-semibold">+ Add Another License</button>
        </div>

        <div class="border-t border-slate-200 pt-6">
          <label class="block text-sm font-semibold mb-3">General Liability Insurance <span class="text-slate-500 font-normal">(Optional)</span></label>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-medium mb-1">Insurance Status <span class="text-slate-500 font-normal">(Optional)</span></label>
              <select id="insuranceStatus" class="w-full rounded-lg border border-slate-200 px-3 py-2">
                <option value="">Select Status</option>
                <option value="active">Active</option>
                <option value="pending">Pending</option>
                <option value="inactive">Not Yet Obtained</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium mb-1">Insurance Provider <span class="text-slate-500 font-normal">(Optional)</span></label>
              <input type="text" id="insuranceProvider" class="w-full rounded-lg border border-slate-200 px-3 py-2" placeholder="Company name" />
            </div>
          </div>
          <div class="mt-3">
            <label class="block text-xs font-medium mb-1">Upload Proof of Insurance <span class="text-slate-500 font-normal">(Optional)</span></label>
            <input type="file" id="insuranceProof" accept="image/*,.pdf" class="w-full rounded-lg border border-slate-200 px-3 py-2" />
            <p class="text-xs text-slate-500 mt-1">Certificate of Insurance showing minimum $1M coverage</p>
          </div>
        </div>

        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <div class="flex items-start gap-3">
            <input type="checkbox" id="complianceAck" class="mt-1" />
            <label for="complianceAck" class="text-sm">
              I acknowledge that I am responsible for obtaining and maintaining all required licenses, permits, and insurance for the services I provide. I understand that SendAHandyman may verify these credentials at any time. <span class="text-slate-500 font-normal">(Optional)</span>
            </label>
          </div>
        </div>

        <div class="flex justify-between">
          <button type="button" onclick="prevStep()" class="rounded-xl bg-slate-200 text-slate-700 px-6 py-3 font-semibold hover:bg-slate-300 transition-colors">
            ‚Üê Previous
          </button>
          <button type="submit" id="step2SubmitBtn" class="rounded-xl bg-indigo-600 text-white px-6 py-3 font-semibold hover:bg-indigo-700 transition-colors">
            Next Step ‚Üí
          </button>
        </div>
      </form>
    </div>

    <!-- Step 3: Tools, Equipment & Vehicle -->
    <div id="step3" class="onboarding-step hidden bg-white rounded-xl p-8 shadow-soft border border-slate-100">
      <h3 class="text-2xl font-bold mb-2">Tools, Equipment & Vehicle</h3>
      <p class="text-slate-600 mb-6">Confirm you have the necessary resources to complete jobs professionally.</p>

      <form id="step3Form" class="space-y-4">
        <div class="space-y-3">
          <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 flex items-center gap-3">
            <input type="checkbox" id="hasVehicle" required class="w-5 h-5" />
            <label for="hasVehicle" class="flex-1">
              <div class="font-semibold">Reliable Transportation</div>
              <div class="text-sm text-slate-600">I have a reliable vehicle to travel to job sites</div>
            </label>
          </div>

          <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 flex items-center gap-3">
            <input type="checkbox" id="hasTools" required class="w-5 h-5" />
            <label for="hasTools" class="flex-1">
              <div class="font-semibold">Essential Toolkit</div>
              <div class="text-sm text-slate-600">I own basic hand tools and power tools needed for standard handyman tasks</div>
            </label>
          </div>

          <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 flex items-center gap-3">
            <input type="checkbox" id="hasSmartphone" required class="w-5 h-5" />
            <label for="hasSmartphone" class="flex-1">
              <div class="font-semibold">Smartphone</div>
              <div class="text-sm text-slate-600">I have a smartphone to receive job notifications, take photos, and use GPS</div>
            </label>
          </div>

          <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 flex items-center gap-3">
            <input type="checkbox" id="hasPPE" required class="w-5 h-5" />
            <label for="hasPPE" class="flex-1">
              <div class="font-semibold">Personal Protective Equipment (PPE)</div>
              <div class="text-sm text-slate-600">I have safety glasses, gloves, and other PPE as needed</div>
            </label>
          </div>

          <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 flex items-center gap-3">
            <input type="checkbox" id="hasLadder" class="w-5 h-5" />
            <label for="hasLadder" class="flex-1">
              <div class="font-semibold">Ladder (Optional but Recommended)</div>
              <div class="text-sm text-slate-600">I have a sturdy ladder for reaching high areas</div>
            </label>
          </div>
        </div>

        <div class="border-t border-slate-200 pt-6">
          <label class="block text-sm font-semibold mb-2">Additional Equipment or Specializations</label>
          <textarea id="additionalEquipment" rows="3" class="w-full rounded-lg border border-slate-200 px-3 py-2" placeholder="List any specialized tools, equipment, or certifications you have..."></textarea>
        </div>

        <div class="flex justify-between">
          <button type="button" onclick="prevStep()" class="rounded-xl bg-slate-200 text-slate-700 px-6 py-3 font-semibold hover:bg-slate-300 transition-colors">
            ‚Üê Previous
          </button>
          <button type="submit" class="rounded-xl bg-indigo-600 text-white px-6 py-3 font-semibold hover:bg-indigo-700 transition-colors">
            Next Step ‚Üí
          </button>
        </div>
      </form>
    </div>

    <!-- Step 4: Platform & Technology Setup -->
    <div id="step4" class="onboarding-step hidden bg-white rounded-xl p-8 shadow-soft border border-slate-100">
      <h3 class="text-2xl font-bold mb-2">Platform & Technology Setup</h3>
      <p class="text-slate-600 mb-6">Review platform policies and complete your profile setup.</p>

      <form id="step4Form" class="space-y-6">
        <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-6">
          <h4 class="font-bold mb-3">üìã SendAHandyman Service Agreement</h4>
          <div class="bg-white rounded-lg p-4 max-h-64 overflow-y-auto text-sm border border-indigo-100 mb-4">
            <p class="mb-3"><strong>Independent Contractor Relationship:</strong> You are an independent contractor, not an employee. You control when and how you work.</p>
            <p class="mb-3"><strong>Payment Terms:</strong> You receive 80% of the customer payment. SendAHandyman retains 20% as a platform fee. Payments are processed weekly via direct deposit.</p>
            <p class="mb-3"><strong>Hourly Rate:</strong> Your base pay is 80% of $80/hour ($64/hour). Additional service fees apply for rush jobs, same-day service, and premium time slots.</p>
            <p class="mb-3"><strong>Job Acceptance:</strong> You may accept or decline jobs at your discretion. However, consistent declining may affect your ranking and job offers.</p>
            <p class="mb-3"><strong>Quality Standards:</strong> All work must meet professional standards. Jobs must be completed as described. Photo documentation is required before and after.</p>
            <p class="mb-3"><strong>Customer Communication:</strong> All customer communication must be professional and courteous. No solicitation of off-platform business.</p>
            <p class="mb-3"><strong>Cancellation Policy:</strong> Jobs must be completed as scheduled. Cancellations within 24 hours may result in penalties.</p>
            <p><strong>Termination:</strong> Either party may terminate this agreement at any time with written notice.</p>
          </div>
          <div class="flex items-start gap-3">
            <input type="checkbox" id="agreeServiceTerms" required class="mt-1" />
            <label for="agreeServiceTerms" class="text-sm">I have read and agree to the SendAHandyman Service Agreement *</label>
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">Profile Completion</label>
          <div class="space-y-3">
            <div>
              <label class="block text-xs font-medium mb-1">Professional Bio *</label>
              <textarea id="profileBioSetup" required rows="3" class="w-full rounded-lg border border-slate-200 px-3 py-2" placeholder="Describe your experience, specialties, and what makes you a great handyman..."></textarea>
            </div>
            <div class="space-y-3">
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex justify-between items-center">
                  <div>
                    <h4 class="font-semibold text-blue-900">Hourly Rate</h4>
                    <p class="text-sm text-blue-700">Fixed rate for all handymen</p>
                  </div>
                  <div class="text-right">
                    <div class="text-2xl font-bold text-blue-900">$80/hr</div>
                    <p class="text-xs text-blue-600">You receive 80% ($64/hr)</p>
                  </div>
                </div>
              </div>
              <div>
                <label class="block text-xs font-medium mb-1">Years of Experience *</label>
                <input type="number" id="yearsExp" required min="0" max="50" class="w-full rounded-lg border border-slate-200 px-3 py-2" />
              </div>
            </div>
          </div>
        </div>

        <div class="flex justify-between">
          <button type="button" onclick="prevStep()" class="rounded-xl bg-slate-200 text-slate-700 px-6 py-3 font-semibold hover:bg-slate-300 transition-colors">
            ‚Üê Previous
          </button>
          <button type="submit" class="rounded-xl bg-indigo-600 text-white px-6 py-3 font-semibold hover:bg-indigo-700 transition-colors">
            Next Step ‚Üí
          </button>
        </div>
      </form>
    </div>

    <!-- Step 5: Compliance & Brand Standards -->
    <div id="step5" class="onboarding-step hidden bg-white rounded-xl p-8 shadow-soft border border-slate-100">
      <h3 class="text-2xl font-bold mb-2">Compliance & Brand Standards</h3>
      <p class="text-slate-600 mb-6">Understanding our brand standards ensures consistent, professional service.</p>

      <form id="step5Form" class="space-y-6">
        <div class="space-y-4">
          <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
            <h4 class="font-bold mb-2">üëî Professional Dress Code</h4>
            <ul class="text-sm space-y-1 text-slate-700 list-disc list-inside">
              <li>Clean, professional work clothes (polo shirts preferred)</li>
              <li>Closed-toe work shoes or boots</li>
              <li>No offensive graphics, excessive logos, or torn clothing</li>
              <li>Personal hygiene maintained at all times</li>
            </ul>
          </div>

          <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
            <h4 class="font-bold mb-2">üí¨ Communication Standards</h4>
            <ul class="text-sm space-y-1 text-slate-700 list-disc list-inside">
              <li>Respond to job offers within 30 minutes</li>
              <li>Arrive within scheduled time window</li>
              <li>Call customer 15 minutes before arrival</li>
              <li>Professional, courteous language at all times</li>
              <li>No discussion of pricing or payment with customers</li>
            </ul>
          </div>

          <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
            <h4 class="font-bold mb-2">üì∏ Photo Documentation Requirements</h4>
            <ul class="text-sm space-y-1 text-slate-700 list-disc list-inside">
              <li>Before photos: Document initial conditions</li>
              <li>After photos: Show completed work</li>
              <li>Issue photos: Document any problems or additional needs</li>
              <li>Photos must be clear, well-lit, and focused</li>
            </ul>
          </div>

          <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
            <h4 class="font-bold mb-2">üö´ No Upselling Policy</h4>
            <p class="text-sm text-slate-700">Do NOT attempt to upsell additional services or collect payment directly from customers. If additional work is needed, document it in the app and we will create a new booking. Violation of this policy may result in immediate removal from the platform.</p>
          </div>
        </div>

        <div class="space-y-3">
          <div class="flex items-start gap-3">
            <input type="checkbox" id="agreeCodeOfConduct" required class="mt-1" />
            <label for="agreeCodeOfConduct" class="text-sm">I agree to uphold SendAHandyman's Code of Conduct *</label>
          </div>
          <div class="flex items-start gap-3">
            <input type="checkbox" id="agreeDressCode" required class="mt-1" />
            <label for="agreeDressCode" class="text-sm">I understand and will follow the dress code standards *</label>
          </div>
          <div class="flex items-start gap-3">
            <input type="checkbox" id="agreeComm" required class="mt-1" />
            <label for="agreeComm" class="text-sm">I understand and will meet communication expectations *</label>
          </div>
          <div class="flex items-start gap-3">
            <input type="checkbox" id="agreePhotos" required class="mt-1" />
            <label for="agreePhotos" class="text-sm">I will provide photo documentation as required *</label>
          </div>
          <div class="flex items-start gap-3">
            <input type="checkbox" id="agreeNoUpsell" required class="mt-1" />
            <label for="agreeNoUpsell" class="text-sm">I will NOT upsell services or collect direct payment from customers *</label>
          </div>
        </div>

        <div class="flex justify-between">
          <button type="button" onclick="prevStep()" class="rounded-xl bg-slate-200 text-slate-700 px-6 py-3 font-semibold hover:bg-slate-300 transition-colors">
            ‚Üê Previous
          </button>
          <button type="submit" class="rounded-xl bg-indigo-600 text-white px-6 py-3 font-semibold hover:bg-indigo-700 transition-colors">
            Next Step ‚Üí
          </button>
        </div>
      </form>
    </div>

    <!-- Step 6: Health, Safety & Risk Policy -->
    <div id="step6" class="onboarding-step hidden bg-white rounded-xl p-8 shadow-soft border border-slate-100">
      <h3 class="text-xl md:text-2xl font-bold mb-2">Health, Safety & Risk Policy</h3>
      <p class="text-sm md:text-base text-slate-600 mb-4 md:mb-6">Your safety and that of our customers is our top priority.</p>

      <form id="step6Form" class="space-y-6">
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
          <h4 class="font-bold mb-3">‚ö†Ô∏è Safety Training</h4>
          <div class="space-y-2 text-sm">
            <p><strong>Personal Safety:</strong> Always wear appropriate PPE. Never attempt work beyond your skill level. Use proper lifting techniques. Maintain three points of contact on ladders.</p>
            <p><strong>Customer Property:</strong> Use drop cloths and protective coverings. Turn off water/electricity when needed. Report any damage immediately.</p>
            <p><strong>Electrical Safety:</strong> Only perform electrical work if properly licensed. Turn off breakers before work. Test for live wires.</p>
            <p><strong>Fall Prevention:</strong> Inspect ladders before use. Never overreach. Use fall protection when required.</p>
            <p><strong>Tool Safety:</strong> Maintain tools in good condition. Follow manufacturer guidelines. Never bypass safety features.</p>
          </div>
        </div>

        <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
          <h4 class="font-bold mb-3">üìã Job Hazard Reporting</h4>
          <p class="text-sm mb-2">You must report the following immediately through the app:</p>
          <ul class="text-sm space-y-1 text-slate-700 list-disc list-inside">
            <li>Unsafe working conditions (structural damage, mold, asbestos)</li>
            <li>Electrical hazards beyond scope of work</li>
            <li>Gas leaks or carbon monoxide concerns</li>
            <li>Water damage or active leaks</li>
            <li>Pest infestations</li>
            <li>Any situation where work cannot be completed safely</li>
          </ul>
        </div>

        <div>
          <label class="block text-xs md:text-sm font-semibold mb-2">Emergency Contact Information *</label>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-medium mb-1">Emergency Contact Name</label>
              <input type="text" id="emergencyName" required class="w-full rounded-lg border border-slate-200 px-3 py-2" />
            </div>
            <div>
              <label class="block text-xs font-medium mb-1">Emergency Contact Phone</label>
              <input type="tel" id="emergencyPhone" required class="w-full rounded-lg border border-slate-200 px-3 py-2" />
            </div>
          </div>
          <div class="mt-2">
            <label class="block text-xs font-medium mb-1">Relationship</label>
            <input type="text" id="emergencyRelation" required class="w-full rounded-lg border border-slate-200 px-3 py-2" placeholder="Spouse, Parent, Sibling, etc." />
          </div>
        </div>

        <div class="space-y-3">
          <div class="flex items-start gap-3">
            <input type="checkbox" id="agreeSafety" required class="mt-1" />
            <label for="agreeSafety" class="text-sm">I have reviewed and understand the safety guidelines *</label>
          </div>
          <div class="flex items-start gap-3">
            <input type="checkbox" id="agreeReportHazards" required class="mt-1" />
            <label for="agreeReportHazards" class="text-sm">I will immediately report any safety hazards or unsafe conditions *</label>
          </div>
          <div class="flex items-start gap-3">
            <input type="checkbox" id="agreeRefuseUnsafe" required class="mt-1" />
            <label for="agreeRefuseUnsafe" class="text-sm">I understand I have the right to refuse unsafe work *</label>
          </div>
        </div>

        <div class="flex justify-between">
          <button type="button" onclick="prevStep()" class="rounded-xl bg-slate-200 text-slate-700 px-6 py-3 font-semibold hover:bg-slate-300 transition-colors">
            ‚Üê Previous
          </button>
          <button type="submit" class="rounded-xl bg-indigo-600 text-white px-6 py-3 font-semibold hover:bg-indigo-700 transition-colors">
            Next Step ‚Üí
          </button>
        </div>
      </form>
    </div>

    <!-- Step 7: Tax & Financial Information -->
    <div id="step7" class="onboarding-step hidden bg-white rounded-xl p-8 shadow-soft border border-slate-100">
      <h3 class="text-2xl font-bold mb-2">Tax & Financial Information</h3>
      <p class="text-slate-600 mb-6">Set up payment information and understand your tax obligations.</p>

      <form id="step7Form" class="space-y-6">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <h4 class="font-bold mb-2">üìù W-9 Form</h4>
          <p class="text-sm mb-3">As an independent contractor, you'll receive a 1099-NEC for earnings over $600/year. You're responsible for paying self-employment taxes.</p>
          <p class="text-sm mb-3 font-semibold text-blue-900">LLC/Corporation Note: If you operate as an LLC or Inc, you'll still need to complete a W-9 with your business EIN. S-Corps and C-Corps may be exempt from 1099 reporting but a W-9 is still required for our records.</p>
          <div>
            <label class="block text-xs font-medium mb-1">Upload Completed W-9 *</label>
            <input type="file" id="w9Upload" accept=".pdf,.jpg,.jpeg,.png" required class="w-full rounded-lg border border-slate-200 px-3 py-2" />
            <p class="text-xs text-slate-500 mt-1">Download blank W-9 at <a href="https://www.irs.gov/pub/irs-pdf/fw9.pdf" target="_blank" class="text-indigo-600 hover:underline">irs.gov</a></p>
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-3">Direct Deposit Information *</label>
          <div class="space-y-3">
            <div>
              <label class="block text-xs font-medium mb-1">Bank Name</label>
              <input type="text" id="bankName" required class="w-full rounded-lg border border-slate-200 px-3 py-2" />
            </div>
            <div class="grid md:grid-cols-2 gap-3">
              <div>
                <label class="block text-xs font-medium mb-1">Routing Number (9 digits)</label>
                <input type="text" id="routingNumber" required maxlength="9" pattern="[0-9]{9}" class="w-full rounded-lg border border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-xs font-medium mb-1">Account Number</label>
                <input type="text" id="accountNumber" required class="w-full rounded-lg border border-slate-200 px-3 py-2" />
              </div>
            </div>
            <div>
              <label class="block text-xs font-medium mb-1">Confirm Account Number</label>
              <input type="text" id="accountNumberConfirm" required class="w-full rounded-lg border border-slate-200 px-3 py-2" />
            </div>
            <div>
              <label class="block text-xs font-medium mb-1">Account Type</label>
              <select id="accountType" required class="w-full rounded-lg border border-slate-200 px-3 py-2">
                <option value="">Select Type</option>
                <option value="checking">Checking</option>
                <option value="savings">Savings</option>
              </select>
            </div>
          </div>
        </div>

        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
          <h4 class="font-bold mb-2">üí∞ Payment Schedule</h4>
          <p class="text-sm">Payments are processed weekly on Fridays for all completed jobs from the previous week. Funds typically arrive in your account within 2-3 business days.</p>
        </div>

        <div class="space-y-3">
          <div class="flex items-start gap-3">
            <input type="checkbox" id="agree1099" required class="mt-1" />
            <label for="agree1099" class="text-sm">I understand I am an independent contractor and will receive a 1099-NEC *</label>
          </div>
          <div class="flex items-start gap-3">
            <input type="checkbox" id="agreeTaxes" required class="mt-1" />
            <label for="agreeTaxes" class="text-sm">I understand I am responsible for my own income taxes and self-employment taxes *</label>
          </div>
          <div class="flex items-start gap-3">
            <input type="checkbox" id="agreeBankInfo" required class="mt-1" />
            <label for="agreeBankInfo" class="text-sm">I confirm the bank account information provided is accurate *</label>
          </div>
        </div>

        <div class="flex justify-between">
          <button type="button" onclick="prevStep()" class="rounded-xl bg-slate-200 text-slate-700 px-6 py-3 font-semibold hover:bg-slate-300 transition-colors">
            ‚Üê Previous
          </button>
          <button type="submit" class="rounded-xl bg-indigo-600 text-white px-6 py-3 font-semibold hover:bg-indigo-700 transition-colors">
            Next Step ‚Üí
          </button>
        </div>
      </form>
    </div>

    <!-- Step 8: Customer Satisfaction & Review Protocol -->
    <div id="step8" class="onboarding-step hidden bg-white rounded-xl p-8 shadow-soft border border-slate-100">
      <h3 class="text-2xl font-bold mb-2">Customer Satisfaction & Review Protocol</h3>
      <p class="text-slate-600 mb-6">Understanding how reviews impact your success on the platform.</p>

      <form id="step8Form" class="space-y-6">
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
          <h4 class="font-bold mb-3">‚≠ê Review Impact on Your Business</h4>
          <div class="space-y-2 text-sm">
            <p><strong>Job Ranking:</strong> Higher-rated handymen receive priority job offers. We aim for every handyman to maintain a 4.5+ star average.</p>
            <p><strong>Customer Trust:</strong> Reviews are public and heavily influence customer decisions. Professional service leads to repeat business.</p>
            <p><strong>Platform Standing:</strong> Consistent ratings below 4.0 may result in reduced job offers or removal from platform.</p>
          </div>
        </div>

        <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
          <h4 class="font-bold mb-3">üîÑ Generating Repeat Business</h4>
          <ul class="text-sm space-y-1 text-slate-700 list-disc list-inside">
            <li>Arrive on time and communicate proactively</li>
            <li>Go above and beyond - clean up thoroughly, notice small things</li>
            <li>Be friendly but professional - customers remember great interactions</li>
            <li>Document work with quality photos showing before/after</li>
            <li>Complete jobs efficiently without cutting corners</li>
            <li>Customers can request you specifically for future jobs</li>
          </ul>
        </div>

        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <h4 class="font-bold mb-3">üèòÔ∏è Community Reputation</h4>
          <p class="text-sm mb-2">You represent SendAHandyman in the community. Your reputation affects all of us:</p>
          <ul class="text-sm space-y-1 text-slate-700 list-disc list-inside">
            <li>Treat every property with respect - you're a guest in their home</li>
            <li>Park considerately and follow any community rules</li>
            <li>Keep work areas clean and minimize disruption</li>
            <li>Negative community feedback affects platform reputation</li>
            <li>Word-of-mouth referrals drive our growth</li>
          </ul>
        </div>

        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
          <h4 class="font-bold mb-3">üìâ Addressing Poor Reviews</h4>
          <p class="text-sm">If you receive a poor review:</p>
          <ul class="text-sm space-y-1 text-slate-700 list-disc list-inside mt-2">
            <li>We'll reach out to discuss what happened</li>
            <li>You can provide your perspective and documentation</li>
            <li>We may contact the customer for additional context</li>
            <li>One bad review won't end your partnership, but patterns matter</li>
            <li>We're here to help you succeed and improve</li>
          </ul>
        </div>

        <div class="space-y-3">
          <div class="flex items-start gap-3">
            <input type="checkbox" id="understandReviews" required class="mt-1" />
            <label for="understandReviews" class="text-sm">I understand how reviews impact my job opportunities and success *</label>
          </div>
          <div class="flex items-start gap-3">
            <input type="checkbox" id="commitQuality" required class="mt-1" />
            <label for="commitQuality" class="text-sm">I commit to providing excellent service to earn positive reviews *</label>
          </div>
          <div class="flex items-start gap-3">
            <input type="checkbox" id="respectCommunity" required class="mt-1" />
            <label for="respectCommunity" class="text-sm">I will respect customer properties and represent SendAHandyman professionally *</label>
          </div>
        </div>

        <div class="flex justify-between">
          <button type="button" onclick="prevStep()" class="rounded-xl bg-slate-200 text-slate-700 px-6 py-3 font-semibold hover:bg-slate-300 transition-colors">
            ‚Üê Previous
          </button>
          <button type="submit" class="rounded-xl bg-indigo-600 text-white px-6 py-3 font-semibold hover:bg-indigo-700 transition-colors">
            Next Step ‚Üí
          </button>
        </div>
      </form>
    </div>

    <!-- Step 9: First Job Readiness -->
    <div id="step9" class="onboarding-step hidden bg-white rounded-xl p-8 shadow-soft border border-slate-100">
      <h3 class="text-xl md:text-2xl font-bold mb-2">First Job Readiness</h3>
      <p class="text-sm md:text-base text-slate-600 mb-4 md:mb-6">You're almost ready! Let's schedule your welcome call and set your availability.</p>

      <form id="step9Form" class="space-y-6">
        <div class="gradient-bg text-white rounded-xl p-6">
          <h4 class="font-bold text-lg mb-3">üéâ Welcome to SendAHandyman!</h4>
          <p class="mb-4">You've completed the onboarding process. Before you start receiving jobs, we'll schedule a brief welcome call to:</p>
          <ul class="space-y-2 text-sm">
            <li>‚úì Walk through your first job workflow</li>
            <li>‚úì Answer any remaining questions</li>
            <li>‚úì Review app features and support resources</li>
            <li>‚úì Help you set your service areas and skills</li>
          </ul>
        </div>

        <div>
          <label class="block text-xs md:text-sm font-semibold mb-3">Preferred Welcome Call Time *</label>
          <div class="grid md:grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-medium mb-1">Date</label>
              <input type="date" id="welcomeCallDate" required class="w-full rounded-lg border border-slate-200 px-3 py-2" />
            </div>
            <div>
              <label class="block text-xs font-medium mb-1">Time</label>
              <select id="welcomeCallTime" required class="w-full rounded-lg border border-slate-200 px-3 py-2">
                <option value="">Select Time</option>
                <option value="9am">9:00 AM</option>
                <option value="10am">10:00 AM</option>
                <option value="11am">11:00 AM</option>
                <option value="1pm">1:00 PM</option>
                <option value="2pm">2:00 PM</option>
                <option value="3pm">3:00 PM</option>
                <option value="4pm">4:00 PM</option>
              </select>
            </div>
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-3">When are you available to start taking jobs? *</label>
          <select id="availableStart" required class="w-full rounded-lg border border-slate-200 px-3 py-2">
            <option value="">Select Availability</option>
            <option value="immediately">Immediately after welcome call</option>
            <option value="1week">Within 1 week</option>
            <option value="2weeks">Within 2 weeks</option>
            <option value="1month">Within 1 month</option>
          </select>
        </div>

        <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
          <h4 class="font-bold mb-3">üì± Next Steps After Submission</h4>
          <ol class="space-y-2 text-sm list-decimal list-inside">
            <li>Our team will review your application (typically 24-48 hours)</li>
            <li>You'll receive a call to schedule your welcome session</li>
            <li>After the welcome call, you'll be activated in the system</li>
            <li>You'll start receiving job notifications based on your skills and areas</li>
            <li>Your first few jobs may be monitored for quality assurance</li>
          </ol>
        </div>

        <div class="space-y-3">
          <div class="flex items-start gap-3">
            <input type="checkbox" id="reviewedWorkflow" required class="mt-1" />
            <label for="reviewedWorkflow" class="text-sm">I understand the job workflow and notification system *</label>
          </div>
          <div class="flex items-start gap-3">
            <input type="checkbox" id="readyToStart" required class="mt-1" />
            <label for="readyToStart" class="text-sm">I am ready to provide excellent service and build my reputation *</label>
          </div>
          <div class="flex items-start gap-3">
            <input type="checkbox" id="finalAgreement" required class="mt-1" />
            <label for="finalAgreement" class="text-sm">I confirm all information provided is accurate and complete *</label>
          </div>
        </div>

        <div class="flex justify-between">
          <button type="button" onclick="prevStep()" class="rounded-xl bg-slate-200 text-slate-700 px-6 py-3 font-semibold hover:bg-slate-300 transition-colors">
            ‚Üê Previous
          </button>
          <button type="submit" class="rounded-xl bg-green-600 text-white px-6 py-3 font-semibold hover:bg-green-700 transition-colors">
            üéâ Complete Onboarding
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Main Dashboard -->
<div id="dashboardPage" class="hidden min-h-screen">
  <!-- Header -->
  <header class="bg-white border-b border-slate-200 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="images/helpinghands_logo.png" alt="SendAHandyman" class="h-8 md:h-10 w-auto" />
          <h1 class="text-lg md:text-xl font-bold">SendAHandyman Dashboard</h1>
        </div>
        <div class="flex items-center gap-2 md:gap-4">
          <span id="handymanName" class="text-xs md:text-sm font-semibold text-slate-700 truncate max-w-32 md:max-w-none"></span>
          <button id="adminBtn" class="hidden text-xs md:text-sm bg-red-600 text-white px-3 py-1 rounded-lg hover:bg-red-700 transition-colors whitespace-nowrap">Admin</button>
          <button id="logoutBtn" class="text-xs md:text-sm text-slate-600 hover:text-slate-900 whitespace-nowrap">Sign Out</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <div class="bg-white border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4">
      <nav class="flex gap-4 md:gap-8 overflow-x-auto scrollbar-hide">
        <button class="tab-btn py-3 md:py-4 font-semibold text-xs md:text-sm tab-active whitespace-nowrap px-2" data-tab="overview">Overview</button>
        <button class="tab-btn py-3 md:py-4 font-semibold text-xs md:text-sm whitespace-nowrap px-2" data-tab="tasks">Tasks</button>
        <button class="tab-btn py-3 md:py-4 font-semibold text-xs md:text-sm whitespace-nowrap px-2" data-tab="history">History</button>
        <button class="tab-btn py-3 md:py-4 font-semibold text-xs md:text-sm whitespace-nowrap px-2" data-tab="earnings">Earnings</button>
        <button class="tab-btn py-3 md:py-4 font-semibold text-xs md:text-sm whitespace-nowrap px-2" data-tab="profile">Profile</button>
        <button class="tab-btn py-3 md:py-4 font-semibold text-xs md:text-sm whitespace-nowrap px-2" data-tab="expert">üí° Expert</button>
      </nav>
    </div>
  </div>

  <!-- Content -->
  <div class="max-w-7xl mx-auto px-3 md:px-4 py-4 md:py-8">

    <!-- Overview Tab -->
    <div id="overviewTab" class="tab-content">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-6 mb-6 md:mb-8">
        <div class="bg-white rounded-xl p-4 md:p-6 shadow-soft border border-slate-100">
          <div class="text-slate-600 text-xs md:text-sm font-semibold mb-1">Active Tasks</div>
          <div id="activeTasksCount" class="text-2xl md:text-3xl font-bold text-indigo-600">0</div>
        </div>
        <div class="bg-white rounded-xl p-4 md:p-6 shadow-soft border border-slate-100">
          <div class="text-slate-600 text-xs md:text-sm font-semibold mb-1">Completed This Month</div>
          <div id="completedCount" class="text-2xl md:text-3xl font-bold text-green-600">0</div>
        </div>
        <div class="bg-white rounded-xl p-4 md:p-6 shadow-soft border border-slate-100">
          <div class="text-slate-600 text-xs md:text-sm font-semibold mb-1">Earned This Month</div>
          <div id="earnedMonth" class="text-2xl md:text-3xl font-bold text-green-600">$0</div>
        </div>
        <div class="bg-white rounded-xl p-4 md:p-6 shadow-soft border border-slate-100">
          <div class="text-slate-600 text-xs md:text-sm font-semibold mb-1">Payment Pending</div>
          <div id="pendingAmount" class="text-2xl md:text-3xl font-bold text-amber-600">$0</div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="grid md:grid-cols-2 gap-6 mb-8">
        <div class="bg-white rounded-xl p-4 md:p-6 shadow-soft border border-slate-100">
          <h3 class="text-lg font-bold mb-4">Monthly Performance</h3>
          <div style="height: 250px; max-height: 250px;">
            <canvas id="performanceChart"></canvas>
          </div>
        </div>
        <div class="bg-white rounded-xl p-4 md:p-6 shadow-soft border border-slate-100">
          <h3 class="text-lg font-bold mb-4">Service Breakdown</h3>
          <div style="height: 250px; max-height: 250px;">
            <canvas id="serviceChart"></canvas>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl p-4 md:p-6 shadow-soft border border-slate-100">
        <h3 class="text-lg font-bold mb-4">Upcoming Tasks</h3>
        <div id="upcomingTasksList" class="space-y-3">
          <p class="text-slate-500 text-sm">No upcoming tasks</p>
        </div>
      </div>
    </div>

    <!-- Current Tasks Tab -->
    <div id="tasksTab" class="tab-content hidden">
      <div class="bg-white rounded-xl p-4 md:p-6 shadow-soft border border-slate-100">
        <h3 class="text-lg font-bold mb-4">Current Tasks</h3>
        <div id="currentTasksList" class="space-y-4">
          <p class="text-slate-500 text-sm">No current tasks</p>
        </div>
      </div>
    </div>

    <!-- Task History Tab -->
    <div id="historyTab" class="tab-content hidden">
      <div class="bg-white rounded-xl p-4 md:p-6 shadow-soft border border-slate-100">
        <h3 class="text-lg font-bold mb-4">Completed Tasks</h3>
        <div id="historyTasksList" class="space-y-4">
          <p class="text-slate-500 text-sm">No completed tasks</p>
        </div>
      </div>
    </div>

    <!-- Earnings Tab -->
    <div id="earningsTab" class="tab-content hidden">
      <div class="grid md:grid-cols-3 gap-6 mb-6">
        <div class="bg-white rounded-xl p-4 md:p-6 shadow-soft border border-slate-100">
          <div class="text-slate-600 text-xs md:text-sm font-semibold mb-1">Total Earned</div>
          <div id="totalEarned" class="text-2xl md:text-3xl font-bold text-green-600">$0</div>
        </div>
        <div class="bg-white rounded-xl p-4 md:p-6 shadow-soft border border-slate-100">
          <div class="text-slate-600 text-xs md:text-sm font-semibold mb-1">Paid Out</div>
          <div id="totalPaid" class="text-2xl md:text-3xl font-bold text-indigo-600">$0</div>
        </div>
        <div class="bg-white rounded-xl p-4 md:p-6 shadow-soft border border-slate-100">
          <div class="text-slate-600 text-xs md:text-sm font-semibold mb-1">Awaiting Payment</div>
          <div id="awaitingPayment" class="text-2xl md:text-3xl font-bold text-amber-600">$0</div>
        </div>
      </div>

      <div class="bg-white rounded-xl p-4 md:p-6 shadow-soft border border-slate-100">
        <h3 class="text-lg font-bold mb-4">Payment History</h3>
        <div id="paymentHistoryList" class="space-y-3">
          <p class="text-slate-500 text-sm">No payment history</p>
        </div>
      </div>
    </div>

    <!-- Profile Tab (Enhanced) -->
    <div id="profileTab" class="tab-content hidden">
      <div class="grid gap-6">
        <!-- Personal Info -->
        <div class="bg-white rounded-xl p-4 md:p-6 shadow-soft border border-slate-100">
          <h3 class="text-lg font-bold mb-4">Personal Information</h3>
          <form id="profileForm" class="space-y-4">
            <!-- Profile Picture Section -->
            <div class="flex items-start gap-6">
              <div class="flex-shrink-0">
                <div class="w-24 h-24 rounded-full bg-slate-200 overflow-hidden">
                  <img id="currentProfilePic" src="" alt="Profile" class="w-full h-full object-cover hidden" />
                  <div id="profilePicPlaceholder" class="w-full h-full flex items-center justify-center text-slate-500">
                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                    </svg>
                  </div>
                </div>
                <div class="mt-2">
                  <input type="file" id="newProfilePhoto" accept="image/*" class="hidden" />
                  <button type="button" onclick="document.getElementById('newProfilePhoto').click()" class="text-sm text-indigo-600 hover:text-indigo-700 font-semibold">
                    Change Photo
                  </button>
                </div>
              </div>
              <div class="flex-1 space-y-4">
                <div class="grid md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-xs md:text-sm font-semibold mb-1">Full Name</label>
                    <input type="text" id="profileName" required class="w-full rounded-lg border border-slate-200 px-3 py-2" />
                  </div>
                  <div>
                    <label class="block text-xs md:text-sm font-semibold mb-1">Phone</label>
                    <input type="tel" id="profilePhone" required class="w-full rounded-lg border border-slate-200 px-3 py-2" />
                  </div>
                </div>
              </div>
            </div>

            <!-- Location & Service Area -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3 md:gap-4">
              <div>
                <label class="block text-xs md:text-sm font-semibold mb-1">State</label>
                <select id="profileState" class="w-full rounded-lg border border-slate-200 px-3 py-2">
                  <option value="">Select State</option>
                  <option value="FL">Florida</option>
                  <option value="TX">Texas</option>
                </select>
              </div>
              <div>
                <label class="block text-xs md:text-sm font-semibold mb-1">County</label>
                <select id="profileCounty" class="w-full rounded-lg border border-slate-200 px-3 py-2">
                  <option value="">Select County</option>
                </select>
              </div>
              <div>
                <label class="block text-xs md:text-sm font-semibold mb-1">City</label>
                <input type="text" id="profileCity" class="w-full rounded-lg border border-slate-200 px-3 py-2" />
              </div>
              <div>
                <label class="block text-xs md:text-sm font-semibold mb-1">ZIP Code</label>
                <input type="text" id="profileZip" class="w-full rounded-lg border border-slate-200 px-3 py-2" />
              </div>
            </div>

            <!-- Fixed Rate Display -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 md:p-4">
              <div class="flex justify-between items-center">
                <div>
                  <h4 class="font-semibold text-blue-900">Hourly Rate</h4>
                  <p class="text-sm text-blue-700">Fixed rate for all handymen</p>
                </div>
                <div class="text-right">
                  <div class="text-xl md:text-2xl font-bold text-blue-900">$80/hr</div>
                  <p class="text-xs text-blue-600">You receive 80% ($64/hr)</p>
                </div>
              </div>
            </div>

            <div>
              <label class="block text-xs md:text-sm font-semibold mb-1">Professional Bio</label>
              <textarea id="profileBio" rows="3" class="w-full rounded-lg border border-slate-200 px-3 py-2"></textarea>
            </div>
            <button type="submit" class="w-full md:w-auto rounded-xl bg-indigo-600 text-white px-6 py-2 md:py-3 text-sm md:text-base font-semibold hover:bg-indigo-700 transition-colors">
              Save Changes
            </button>
            <div id="profileSuccess" class="hidden text-sm text-green-600">Profile updated successfully!</div>
          </form>
        </div>

        <!-- Skills & Service Areas -->
        <div class="bg-white rounded-xl p-4 md:p-6 shadow-soft border border-slate-100">
          <h3 class="text-lg font-bold mb-4">Skills & Services</h3>
          <form id="skillsForm" class="space-y-4">
            <div>
              <label class="block text-xs md:text-sm font-semibold mb-2">Select Your Skills</label>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-2 md:gap-3">
                <label class="flex items-center gap-2">
                  <input type="checkbox" class="skill-checkbox" value="tv-mounting" />
                  <span class="text-sm">TV Mounting</span>
                </label>
                <label class="flex items-center gap-2">
                  <input type="checkbox" class="skill-checkbox" value="furniture-assembly" />
                  <span class="text-sm">Furniture Assembly</span>
                </label>
                <label class="flex items-center gap-2">
                  <input type="checkbox" class="skill-checkbox" value="drywall-repair" />
                  <span class="text-sm">Drywall Repair</span>
                </label>
                <label class="flex items-center gap-2">
                  <input type="checkbox" class="skill-checkbox" value="door-repair" />
                  <span class="text-sm">Door Repair</span>
                </label>
                <label class="flex items-center gap-2">
                  <input type="checkbox" class="skill-checkbox" value="painting" />
                  <span class="text-sm">Painting</span>
                </label>
                <label class="flex items-center gap-2">
                  <input type="checkbox" class="skill-checkbox" value="plumbing" />
                  <span class="text-sm">Basic Plumbing</span>
                </label>
                <label class="flex items-center gap-2">
                  <input type="checkbox" class="skill-checkbox" value="electrical" />
                  <span class="text-sm">Basic Electrical</span>
                </label>
                <label class="flex items-center gap-2">
                  <input type="checkbox" class="skill-checkbox" value="flooring" />
                  <span class="text-sm">Flooring</span>
                </label>
                <label class="flex items-center gap-2">
                  <input type="checkbox" class="skill-checkbox" value="carpentry" />
                  <span class="text-sm">Carpentry</span>
                </label>
                <label class="flex items-center gap-2">
                  <input type="checkbox" class="skill-checkbox" value="deck-repair" />
                  <span class="text-sm">Deck Repair</span>
                </label>
                <label class="flex items-center gap-2">
                  <input type="checkbox" class="skill-checkbox" value="pressure-washing" />
                  <span class="text-sm">Pressure Washing</span>
                </label>
              </div>
            </div>

            <div>
              <label class="block text-xs md:text-sm font-semibold mb-2">Service Areas</label>
              <div class="space-y-2">
                <select id="serviceState" class="w-full rounded-lg border border-slate-200 px-3 py-2">
                  <option value="">Select State</option>
                  <option value="FL">Florida</option>
                  <option value="TX">Texas</option>
                </select>
                <div id="citySelection" class="hidden grid grid-cols-1 md:grid-cols-3 gap-2 md:gap-3 mt-3">
                  <!-- Counties will be populated dynamically -->
                </div>
              </div>
            </div>

            <button type="submit" class="w-full md:w-auto rounded-xl bg-indigo-600 text-white px-6 py-2 md:py-3 text-sm md:text-base font-semibold hover:bg-indigo-700 transition-colors">
              Save Skills & Areas
            </button>
            <div id="skillsSuccess" class="hidden text-sm text-green-600">Skills updated successfully!</div>
          </form>
        </div>

        <!-- Weekly Schedule -->
        <div class="bg-white rounded-xl p-4 md:p-6 shadow-soft border border-slate-100">
          <h3 class="text-lg font-bold mb-4">Weekly Availability</h3>
          <p class="text-xs md:text-sm text-slate-600 mb-4">Click cells to toggle your availability. Select the hours you're available to work.</p>
          <div class="overflow-x-auto">
            <table class="w-full text-xs md:text-sm" id="scheduleTable">
              <thead>
              <tr class="border-b border-slate-200">
                <th class="text-left py-1 md:py-2 px-1 md:px-3">Time</th>
                <th class="text-center py-1 md:py-2 px-1 md:px-3">Mon</th>
                <th class="text-center py-1 md:py-2 px-1 md:px-3">Tue</th>
                <th class="text-center py-1 md:py-2 px-1 md:px-3">Wed</th>
                <th class="text-center py-1 md:py-2 px-1 md:px-3">Thu</th>
                <th class="text-center py-1 md:py-2 px-1 md:px-3">Fri</th>
                <th class="text-center py-1 md:py-2 px-1 md:px-3">Sat</th>
              </tr>
              </thead>
              <tbody id="scheduleBody">
              <!-- Populated by JavaScript -->
              </tbody>
            </table>
          </div>
          <button type="button" id="saveSchedule" class="mt-4 w-full md:w-auto rounded-xl bg-indigo-600 text-white px-6 py-2 md:py-3 text-sm md:text-base font-semibold hover:bg-indigo-700 transition-colors">
            Save Schedule
          </button>
          <div id="scheduleSuccess" class="hidden text-sm text-green-600 mt-2">Schedule updated successfully!</div>
        </div>

        <!-- Insurance & Licenses -->
        <div class="bg-white rounded-xl p-4 md:p-6 shadow-soft border border-slate-100">
          <h3 class="text-lg font-bold mb-4">Insurance & Licenses</h3>
          <form id="insuranceForm" class="space-y-4">
            <div>
              <h4 class="font-semibold mb-3">General Liability Insurance</h4>
              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm mb-1">Status</label>
                  <select id="editInsuranceStatus" class="w-full rounded-lg border border-slate-200 px-3 py-2">
                    <option value="active">Active</option>
                    <option value="pending">Pending</option>
                    <option value="inactive">Inactive</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm mb-1">Provider</label>
                  <input type="text" id="editInsuranceProvider" class="w-full rounded-lg border border-slate-200 px-3 py-2" />
                </div>
              </div>
              <div class="mt-3">
                <label class="block text-sm mb-1">Upload Updated Proof</label>
                <input type="file" id="editInsuranceProof" accept="image/*,.pdf" class="w-full rounded-lg border border-slate-200 px-3 py-2" />
              </div>
            </div>

            <div class="border-t border-slate-200 pt-4">
              <h4 class="font-semibold mb-3">Trade Licenses</h4>
              <div id="editLicenseContainer" class="space-y-3">
                <!-- Populated by JavaScript -->
              </div>
              <button type="button" id="addEditLicense" class="mt-2 text-sm text-indigo-600 hover:text-indigo-700 font-semibold">+ Add License</button>
            </div>

            <button type="submit" class="w-full md:w-auto rounded-xl bg-indigo-600 text-white px-6 py-2 md:py-3 text-sm md:text-base font-semibold hover:bg-indigo-700 transition-colors">
              Update Insurance & Licenses
            </button>
            <div id="insuranceSuccess" class="hidden text-sm text-green-600">Updated successfully!</div>
          </form>
        </div>

        <!-- Change Password -->
        <div class="bg-white rounded-xl p-4 md:p-6 shadow-soft border border-slate-100">
          <h3 class="text-lg font-bold mb-4">Change Password</h3>
          <form id="passwordForm" class="space-y-4">
            <div>
              <label class="block text-xs md:text-sm font-semibold mb-1">New Password</label>
              <input type="password" id="settingsNewPassword" required minlength="8" class="w-full rounded-lg border border-slate-200 px-3 py-2" />
            </div>
            <div>
              <label class="block text-xs md:text-sm font-semibold mb-1">Confirm Password</label>
              <input type="password" id="settingsConfirmPassword" required class="w-full rounded-lg border border-slate-200 px-3 py-2" />
            </div>
            <button type="submit" class="w-full md:w-auto rounded-xl bg-indigo-600 text-white px-6 py-2 md:py-3 text-sm md:text-base font-semibold hover:bg-indigo-700 transition-colors">
              Update Password
            </button>
            <div id="passwordError" class="hidden text-sm text-red-600"></div>
            <div id="passwordSuccess" class="hidden text-sm text-green-600">Password updated successfully!</div>
          </form>
        </div>
      </div>
    </div>

    <!-- Expert Advice Tab (NEW) -->
    <div id="expertTab" class="tab-content hidden">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
        <!-- Canned Prompts -->
        <div class="bg-white rounded-xl p-4 md:p-6 shadow-soft border border-slate-100">
          <h3 class="text-lg font-bold mb-2">üöÄ Quick Business Advice</h3>
          <p class="text-xs md:text-sm text-slate-600 mb-4">Get instant AI-powered advice on common business challenges</p>

          <div class="space-y-3">
            <button onclick="askExpert('service-optimization')" class="w-full text-left border border-slate-200 rounded-lg p-3 md:p-4 hover:border-indigo-500 hover:bg-indigo-50 transition-all">
              <div class="font-semibold text-indigo-600">üìä Service Optimization</div>
              <div class="text-sm text-slate-600 mt-1">How can I improve my efficiency and service quality?</div>
            </button>

            <button onclick="askExpert('more-bookings')" class="w-full text-left border border-slate-200 rounded-lg p-3 md:p-4 hover:border-indigo-500 hover:bg-indigo-50 transition-all">
              <div class="font-semibold text-indigo-600">üìà Get More Bookings</div>
              <div class="text-sm text-slate-600 mt-1">Strategies to increase my job volume and visibility</div>
            </button>

            <button onclick="askExpert('client-retention')" class="w-full text-left border border-slate-200 rounded-lg p-3 md:p-4 hover:border-indigo-500 hover:bg-indigo-50 transition-all">
              <div class="font-semibold text-indigo-600">üîÑ Client Retention</div>
              <div class="text-sm text-slate-600 mt-1">How to turn one-time customers into repeat clients</div>
            </button>

            <button onclick="askExpert('review-improvement')" class="w-full text-left border border-slate-200 rounded-lg p-3 md:p-4 hover:border-indigo-500 hover:bg-indigo-50 transition-all">
              <div class="font-semibold text-indigo-600">‚≠ê Improve Reviews</div>
              <div class="text-sm text-slate-600 mt-1">Tips for consistently earning 5-star reviews</div>
            </button>

            <button onclick="askExpert('time-management')" class="w-full text-left border border-slate-200 rounded-lg p-3 md:p-4 hover:border-indigo-500 hover:bg-indigo-50 transition-all">
              <div class="font-semibold text-indigo-600">‚è∞ Time Management</div>
              <div class="text-sm text-slate-600 mt-1">How to fit more jobs in my schedule efficiently</div>
            </button>
          </div>
        </div>

        <!-- Custom Problem Solver -->
        <div class="bg-white rounded-xl p-4 md:p-6 shadow-soft border border-slate-100">
          <h3 class="text-lg font-bold mb-2">üí° Custom Problem Solver</h3>
          <p class="text-xs md:text-sm text-slate-600 mb-4">Ask anything about your handyman business or specific technical questions</p>

          <form id="expertForm" class="space-y-4">
            <div>
              <label class="block text-xs md:text-sm font-semibold mb-2">Your Question</label>
              <textarea id="customQuestion" rows="6" required class="w-full rounded-lg border border-slate-200 px-3 py-2" placeholder="Examples:
- How do I install a ceiling fan safely?
- What's the best way to patch a large drywall hole?
- How can I expand into new service areas?
- Tips for dealing with difficult customers?"></textarea>
            </div>

            <button type="submit" id="askExpertBtn" class="w-full rounded-xl bg-indigo-600 text-white px-6 py-2 md:py-3 text-sm md:text-base font-semibold hover:bg-indigo-700 transition-colors">
              Get Expert Advice
            </button>
          </form>

          <!-- Expert Response -->
          <div id="expertResponse" class="hidden mt-6 p-4 bg-slate-50 border border-slate-200 rounded-lg">
            <div class="flex items-start gap-3 mb-3">
              <div class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center flex-shrink-0 font-bold text-sm">AI</div>
              <div class="flex-1">
                <div class="font-semibold mb-1">Expert Advice</div>
                <div id="expertResponseText" class="text-sm text-slate-700 prose prose-sm max-w-none"></div>
              </div>
            </div>
            <button onclick="closeExpertResponse()" class="text-sm text-indigo-600 hover:text-indigo-700 font-semibold">Ask Another Question</button>
          </div>

          <!-- Loading State -->
          <div id="expertLoading" class="hidden mt-6 text-center py-8">
            <div class="inline-block w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="text-sm text-slate-600 mt-3">Getting expert advice...</p>
          </div>
        </div>
      </div>

      <!-- Recent Questions -->
      <div class="mt-6 bg-white rounded-xl p-4 md:p-6 shadow-soft border border-slate-100">
        <h3 class="text-lg font-bold mb-4">üìù Your Recent Questions</h3>
        <div id="recentQuestions" class="space-y-3">
          <p class="text-sm text-slate-500">No questions asked yet. Try asking something above!</p>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  // Configuration
  const SUPABASE_URL = 'https://ynbhskdiplwabsksamxa.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InluYmhza2RpcGx3YWJza3NhbXhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2OTYwMjAsImV4cCI6MjA3NTI3MjAyMH0.PedsTR4JQOioRWD28mVafR4I6wmHApUG5q2-Y7G7ljw';

  let supabaseClient;
  let currentHandyman = null;
  let currentStep = 1;
  let scheduleData = {};

  // Initialize Supabase
  async function initializeSupabase() {
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Handle password reset URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const accessToken = urlParams.get('access_token');
    const refreshToken = urlParams.get('refresh_token');
    const type = urlParams.get('type');

    if (type === 'recovery' && accessToken) {
      console.log('üîÑ Handling password recovery from email link');

      // For password recovery, we use verifyOtp to establish a proper session
      const { data, error } = await supabaseClient.auth.verifyOtp({
        token_hash: accessToken,
        type: 'recovery'
      });

      if (error) {
        console.error('‚ùå Error verifying recovery token:', error);
        showPasswordUpdateForm('Error: Invalid or expired reset link. Please request a new password reset.');
      } else {
        console.log('‚úÖ Recovery session established, showing password update form');
        console.log('Session data:', data);
        showPasswordUpdateForm();
      }

      // Clean up URL parameters
      window.history.replaceState({}, document.title, window.location.pathname);
      return;
    }
  }

  // Toggle password visibility
  document.getElementById('togglePassword').addEventListener('click', () => {
    const passwordInput = document.getElementById('loginPassword');
    const eyeIcon = document.getElementById('eyeIcon');
    const eyeSlashIcon = document.getElementById('eyeSlashIcon');

    if (passwordInput.type === 'password') {
      passwordInput.type = 'text';
      eyeIcon.classList.add('hidden');
      eyeSlashIcon.classList.remove('hidden');
    } else {
      passwordInput.type = 'password';
      eyeIcon.classList.remove('hidden');
      eyeSlashIcon.classList.add('hidden');
    }
  });

  // Login
  document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;

    console.log('üîê Attempting login for:', email);

    const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

    if (error) {
      console.error('üö® Authentication failed:', error);
      document.getElementById('loginError').textContent = error.message;
      document.getElementById('loginError').classList.remove('hidden');
      return;
    }

    console.log('‚úÖ Authentication successful for user:', data.user.id);
    console.log('üë§ User data:', data.user);

    try {
      await loadHandymanData(data.user.id);
    } catch (err) {
      console.error('üö® Failed to load handyman data:', err);
      document.getElementById('loginError').textContent = 'Failed to load dashboard. Please check console for details.';
      document.getElementById('loginError').classList.remove('hidden');
    }
  });

  // Password Reset Modal Functions
  document.getElementById('forgotPasswordBtn').addEventListener('click', () => {
    document.getElementById('passwordResetModal').classList.remove('hidden');
    document.getElementById('resetEmail').focus();
  });

  document.getElementById('cancelResetBtn').addEventListener('click', () => {
    closePasswordResetModal();
  });

  // Close modal when clicking outside
  document.getElementById('passwordResetModal').addEventListener('click', (e) => {
    if (e.target === document.getElementById('passwordResetModal')) {
      closePasswordResetModal();
    }
  });

  // Password Reset Form Handler
  document.getElementById('passwordResetForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const email = document.getElementById('resetEmail').value;
    const submitBtn = document.getElementById('submitResetBtn');
    const btnText = document.getElementById('resetBtnText');
    const btnLoading = document.getElementById('resetBtnLoading');
    const errorDiv = document.getElementById('resetError');
    const successDiv = document.getElementById('resetSuccess');

    // Clear previous messages
    errorDiv.classList.add('hidden');
    successDiv.classList.add('hidden');

    // Show loading state
    submitBtn.disabled = true;
    btnText.classList.add('hidden');
    btnLoading.classList.remove('hidden');

    try {
      console.log('üîÑ Sending password reset email to:', email);

      const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
        redirectTo: window.location.origin + '/dashboard.html'
      });

      if (error) {
        console.error('‚ùå Password reset error:', error);
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('hidden');
        return;
      }

      console.log('‚úÖ Password reset email sent successfully');
      successDiv.textContent = 'Password reset email sent! Check your inbox and spam folder.';
      successDiv.classList.remove('hidden');

      // Close modal after 3 seconds
      setTimeout(() => {
        closePasswordResetModal();
      }, 3000);

    } catch (err) {
      console.error('‚ùå Unexpected error during password reset:', err);
      errorDiv.textContent = 'An unexpected error occurred. Please try again.';
      errorDiv.classList.remove('hidden');
    } finally {
      // Reset button state
      submitBtn.disabled = false;
      btnText.classList.remove('hidden');
      btnLoading.classList.add('hidden');
    }
  });

  function closePasswordResetModal() {
    document.getElementById('passwordResetModal').classList.add('hidden');
    document.getElementById('passwordResetForm').reset();
    document.getElementById('resetError').classList.add('hidden');
    document.getElementById('resetSuccess').classList.add('hidden');
  }

  // Show Password Update Form
  function showPasswordUpdateForm(errorMessage = null) {
    // Hide login page and show password update modal
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('passwordUpdateModal').classList.remove('hidden');

    if (errorMessage) {
      document.getElementById('updateError').textContent = errorMessage;
      document.getElementById('updateError').classList.remove('hidden');
    }

    document.getElementById('resetNewPassword').focus();
  }

  // Toggle new password visibility
  document.getElementById('toggleNewPassword').addEventListener('click', () => {
    const passwordInput = document.getElementById('resetNewPassword');
    const icon = document.getElementById('toggleNewPassword');

    if (passwordInput.type === 'password') {
      passwordInput.type = 'text';
      icon.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
      </svg>`;
    } else {
      passwordInput.type = 'password';
      icon.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
      </svg>`;
    }
  });

  // Password Update Form Handler
  document.getElementById('passwordUpdateForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const newPassword = document.getElementById('resetNewPassword').value;
    const confirmPassword = document.getElementById('resetConfirmPassword').value;
    const submitBtn = document.getElementById('submitUpdateBtn');
    const btnText = document.getElementById('updateBtnText');
    const btnLoading = document.getElementById('updateBtnLoading');
    const errorDiv = document.getElementById('updateError');
    const successDiv = document.getElementById('updateSuccess');

    // Clear previous messages
    errorDiv.classList.add('hidden');
    successDiv.classList.add('hidden');

    // Validate passwords match
    if (newPassword !== confirmPassword) {
      errorDiv.textContent = 'Passwords do not match.';
      errorDiv.classList.remove('hidden');
      return;
    }

    // Validate password length
    if (newPassword.length < 6) {
      errorDiv.textContent = 'Password must be at least 6 characters long.';
      errorDiv.classList.remove('hidden');
      return;
    }

    // Show loading state
    submitBtn.disabled = true;
    btnText.classList.add('hidden');
    btnLoading.classList.remove('hidden');

    try {
      console.log('üîÑ Updating password...');

      const { error } = await supabaseClient.auth.updateUser({
        password: newPassword
      });

      if (error) {
        console.error('‚ùå Password update error:', error);
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('hidden');
        return;
      }

      console.log('‚úÖ Password updated successfully');
      successDiv.textContent = 'Password updated successfully! Redirecting to dashboard...';
      successDiv.classList.remove('hidden');

      // Hide the modal and show login page
      setTimeout(() => {
        document.getElementById('passwordUpdateModal').classList.add('hidden');
        document.getElementById('loginPage').classList.remove('hidden');

        // Show success message on login page
        const loginError = document.getElementById('loginError');
        loginError.textContent = 'Password updated successfully! Please log in with your new password.';
        loginError.className = 'text-sm text-green-600 text-center';
        loginError.classList.remove('hidden');
      }, 2000);

    } catch (err) {
      console.error('‚ùå Unexpected error during password update:', err);
      errorDiv.textContent = 'An unexpected error occurred. Please try again.';
      errorDiv.classList.remove('hidden');
    } finally {
      // Reset button state
      submitBtn.disabled = false;
      btnText.classList.remove('hidden');
      btnLoading.classList.add('hidden');
    }
  });

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await supabaseClient.auth.signOut();
    location.reload();
  });

  // Admin button functionality
  document.getElementById('adminBtn').addEventListener('click', () => {
    window.open('/admin.html', '_blank');
  });

  // Check authentication
  async function checkAuth() {
    const { data: { user } } = await supabaseClient.auth.getUser();

    if (user) {
      await loadHandymanData(user.id);
    } else {
      document.getElementById('loginPage').classList.remove('hidden');
    }
  }

  // Load handyman data
  async function loadHandymanData(userId) {
    console.log('üîç Loading handyman data for user_id:', userId);

    // Handle potential duplicate records - get the one with a name (correct one)
    const { data: handymenList, error: listError } = await supabaseClient
      .from('handymen')
      .select('*')
      .eq('user_id', userId)
      .order('created_at', { ascending: false });

    if (listError) {
      console.error('üö® Error loading handyman records:', listError);
      throw new Error(`No handyman record found for user ${userId}: ${listError.message}`);
    }

    if (!handymenList || handymenList.length === 0) {
      throw new Error(`No handyman record found for user ${userId}`);
    }

    // If multiple records exist, prefer the one with full_name
    let handyman;
    if (handymenList.length > 1) {
      console.warn(`üö® Found ${handymenList.length} handyman records for user ${userId}, selecting the one with full_name`);
      handyman = handymenList.find(h => h.full_name) || handymenList[0];
      console.log('üìù Selected handyman record:', handyman);
    } else {
      handyman = handymenList[0];
    }

    const error = null; // Reset error since we handled the multiple records

    if (error) {
      console.error('üö® Error loading handyman record:', error);
      console.error('üîç Error details:', {
        message: error.message,
        code: error.code,
        details: error.details,
        hint: error.hint
      });
      throw new Error(`No handyman record found for user ${userId}: ${error.message}`);
    }

    if (!handyman) {
      console.error('üö® No handyman record returned for user_id:', userId);
      throw new Error(`No handyman record exists for user ${userId}`);
    }

    currentHandyman = handyman;
    console.log('‚úÖ Loaded handyman data:', handyman);
    console.log('üîç Handyman record details:', {
      id: handyman.id,
      user_id: handyman.user_id,
      full_name: handyman.full_name,
      email: handyman.email,
      is_active: handyman.is_active,
      onboarding_completed: handyman.onboarding_completed
    });

    console.log('üéØ Onboarding status check:', {
      onboarding_completed: handyman.onboarding_completed,
      typeof: typeof handyman.onboarding_completed,
      will_show: handyman.onboarding_completed ? 'Dashboard' : 'Onboarding'
    });

    const displayName = handyman.full_name || 'Handyman';
    const phone = handyman.phone ? ` ‚Ä¢ ${handyman.phone}` : '';
    document.getElementById('handymanName').textContent = `${displayName}${phone}`;

    // Check if user is admin by querying admin_users table
    console.log('üîç About to check admin access with handyman email:', handyman.email);
    await checkAdminAccess(handyman.email);

    // Also check using current auth user email as backup
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (user && user.email && user.email !== handyman.email) {
      console.log('üîç Also checking admin access with auth user email:', user.email);
      await checkAdminAccess(user.email);
    }

    // Check if onboarding is complete
    if (!handyman.onboarding_completed) {
      console.log('üìù Showing onboarding wizard - new user needs to complete setup');
      showOnboarding();
    } else {
      console.log('üìä Showing dashboard because onboarding is complete');
      showDashboard();
    }
  }

  // Refresh handyman data from database
  async function refreshHandymanData() {
    if (!currentHandyman) return;

    console.log('Refreshing handyman data from database');
    const { data: handyman, error } = await supabaseClient
      .from('handymen')
      .select('*')
      .eq('id', currentHandyman.id)
      .single();

    if (error) {
      console.error('Error refreshing handyman data:', error);
      return;
    }

    console.log('Refreshed handyman data:', handyman);
    currentHandyman = handyman;
    return handyman;
  }

  // Show onboarding wizard
  function showOnboarding() {
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('onboardingWizard').classList.remove('hidden');
    currentStep = 1;
    showStep(1);
  }

  // Show dashboard
  function showDashboard() {
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('onboardingWizard').classList.add('hidden');
    document.getElementById('dashboardPage').classList.remove('hidden');

    // Load all data
    loadOverviewData();
    loadCurrentTasks();
    loadTaskHistory();
    loadEarnings();
    loadProfile();
    initializeSchedule();
    initializeCharts();
  }

  // Generate clean folder name for storage
  function generateHandymanFolderName(userId, fullName) {
    // Clean the full name: remove spaces, special chars, limit length
    const cleanName = fullName
      .replace(/[^a-zA-Z0-9]/g, '') // Remove special characters
      .toLowerCase()
      .substring(0, 20); // Limit to 20 characters

    return `${userId}_${cleanName}`;
  }

  // File upload helper function
  async function uploadFile(file, bucketName, filePath) {
    if (!file) return null;

    try {
      console.log(`Uploading ${file.name} to ${bucketName}/${filePath}`);

      const { data, error } = await supabaseClient.storage
        .from(bucketName)
        .upload(filePath, file, {
          cacheControl: '3600',
          upsert: true
        });

      if (error) {
        console.error('Upload error:', error);
        return null;
      }

      console.log('Upload successful:', data);
      return data.path;
    } catch (error) {
      console.error('Upload exception:', error);
      return null;
    }
  }

  // Onboarding navigation
  function showStep(step) {
    console.log('showStep() called with step:', step);

    // Hide all steps
    document.querySelectorAll('.onboarding-step').forEach(s => s.classList.add('hidden'));

    // Show current step
    const targetStep = document.getElementById('step' + step);
    console.log('Target step element:', targetStep);
    if (targetStep) {
      targetStep.classList.remove('hidden');
      console.log('Successfully showed step', step);
    } else {
      console.error('Step element not found:', 'step' + step);
    }

    // Update progress
    document.getElementById('onboardingProgress').textContent = `Step ${step} of 9`;

    // Update progress circles
    document.querySelectorAll('.progress-step').forEach((circle, index) => {
      circle.classList.remove('active', 'completed');
      if (index + 1 < step) {
        circle.classList.add('completed');
      } else if (index + 1 === step) {
        circle.classList.add('active');
      }
    });

    currentStep = step;
  }

  function nextStep() {
    console.log('nextStep() called, currentStep:', currentStep);
    if (currentStep < 9) {
      console.log('Advancing to step:', currentStep + 1);
      showStep(currentStep + 1);
    } else {
      console.log('Already at final step, not advancing');
    }
  }

  function prevStep() {
    if (currentStep > 1) {
      showStep(currentStep - 1);
    }
  }

  // Toggle between SSN and EIN input
  function toggleTaxIdField() {
    const taxIdType = document.querySelector('input[name="taxIdType"]:checked').value;
    const label = document.getElementById('taxIdLabel');
    const input = document.getElementById('ssn');

    if (taxIdType === 'ein') {
      label.textContent = 'Employer Identification Number (EIN) *';
      input.placeholder = 'XX-XXXXXXX';
      input.maxLength = 10;
    } else {
      label.textContent = 'Social Security Number (SSN) *';
      input.placeholder = 'XXX-XX-XXXX';
      input.maxLength = 11;
    }
  }

  // Step form handlers
  // FILE STORAGE NOTES:
  // All uploaded files (govId, profilePhoto, licenses, insurance, W9, etc.) should be stored in Supabase Storage.
  // Recommended structure: /handyman-documents/{handyman-documents}/{file_type}/{filename}
  // Example implementation:
  // const file = document.getElementById('govId').files[0];
  // const { data, error } = await supabaseClient.storage
  //   .from('handyman-documents')
  //   .upload(`${currentHandyman.id}/gov-id/${file.name}`, file);
  // Then store the file path in the database column (e.g., gov_id_url)

  document.getElementById('step1Form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const taxIdType = document.querySelector('input[name="taxIdType"]:checked').value;

    // Get user info for folder naming - use just user ID to match RLS policies
    const user = (await supabaseClient.auth.getUser()).data.user;
    const folderName = user.id;
    console.log('Step 1 - User ID:', user.id);
    console.log('Step 1 - Folder name:', folderName);

    // Upload files to Supabase Storage
    const govIdFile = document.getElementById('govId').files[0];
    const profilePhotoFile = document.getElementById('profilePhoto').files[0];

    let govIdUrl = null;
    let profilePhotoUrl = null;

    if (govIdFile) {
      const govIdPath = await uploadFile(
        govIdFile,
        'handyman-documents',
        `${folderName}/gov-id/${Date.now()}-${govIdFile.name}`
      );
      if (govIdPath) {
        govIdUrl = `https://ynbhskdiplwabsksamxa.supabase.co/storage/v1/object/public/handyman-documents/${govIdPath}`;
      }
    }

    if (profilePhotoFile) {
      const profilePhotoPath = await uploadFile(
        profilePhotoFile,
        'handyman-documents',
        `${folderName}/profile/${Date.now()}-${profilePhotoFile.name}`
      );
      if (profilePhotoPath) {
        profilePhotoUrl = `https://ynbhskdiplwabsksamxa.supabase.co/storage/v1/object/public/handyman-documents/${profilePhotoPath}`;
      }
    }

    // Collect form data
    const formData = {
      full_name: document.getElementById('legalName').value,
      date_of_birth: document.getElementById('dob').value,
      tax_id_type: taxIdType,
      tax_id: document.getElementById('ssn').value,
      drivers_license: document.getElementById('idNumber').value,
      gov_id_url: govIdUrl,
      profile_photo_url: profilePhotoUrl,
      updated_at: new Date().toISOString()
    };

    const { error } = await supabaseClient
      .from('handymen')
      .update(formData)
      .eq('id', currentHandyman.id);

    if (error) {
      console.error('Error saving step 1:', error);
      alert('Error saving data: ' + error.message);
      return;
    }

    nextStep();
  });

  document.getElementById('step2Form').addEventListener('submit', async (e) => {
    e.preventDefault();
    console.log('Step 2 form submission started');

    // Check form validity
    const form = e.target;
    if (!form.checkValidity()) {
      console.log('Form validation failed');
      form.reportValidity();
      return;
    }

    // Collect license data
    const licenses = [];
    console.log('License containers found:', document.querySelectorAll('#licenseContainer > div').length);
    document.querySelectorAll('#licenseContainer > div').forEach(licenseDiv => {
      const type = licenseDiv.querySelector('.license-type')?.value;
      const number = licenseDiv.querySelector('.license-number')?.value;
      const expiry = licenseDiv.querySelector('.license-expiry')?.value;
      console.log('License data:', { type, number, expiry });
      if (type || number) {
        licenses.push({ type, number, expiry });
      }
    });

    // Check individual field values
    const insuranceStatus = document.getElementById('insuranceStatus')?.value;
    const insuranceProvider = document.getElementById('insuranceProvider')?.value;
    console.log('Insurance status:', insuranceStatus);
    console.log('Insurance provider:', insuranceProvider);

    // Get user info for folder naming - use just user ID to match RLS policies
    const user = (await supabaseClient.auth.getUser()).data.user;
    const folderName = user.id;

    // Upload insurance proof if provided
    const insuranceProofFile = document.getElementById('insuranceProof').files[0];
    let insuranceProofUrl = null;

    if (insuranceProofFile) {
      const insuranceProofPath = await uploadFile(
        insuranceProofFile,
        'handyman-documents',
        `${folderName}/insurance/${Date.now()}-${insuranceProofFile.name}`
      );
      if (insuranceProofPath) {
        insuranceProofUrl = `https://ynbhskdiplwabsksamxa.supabase.co/storage/v1/object/public/handyman-documents/${insuranceProofPath}`;
      }
    }

    // Upload license files if any
    const licenseFiles = [];
    document.querySelectorAll('#licenseContainer .license-file').forEach(async (fileInput, index) => {
      if (fileInput.files[0]) {
        const licenseFile = fileInput.files[0];
        const licenseFilePath = await uploadFile(
          licenseFile,
          'handyman-documents',
          `${folderName}/licenses/${Date.now()}-${index}-${licenseFile.name}`
        );
        if (licenseFilePath) {
          licenseFiles.push(`https://ynbhskdiplwabsksamxa.supabase.co/storage/v1/object/public/handyman-documents/${licenseFilePath}`);
        }
      }
    });

    // Collect form data
    const formData = {
      licenses: licenses.length > 0 ? licenses : null,
      license_files: licenseFiles.length > 0 ? licenseFiles : null,
      insurance_status: insuranceStatus || null,
      insurance_provider: insuranceProvider || null,
      insurance_proof_url: insuranceProofUrl,
      updated_at: new Date().toISOString()
    };

    console.log('Step 2 form data:', JSON.stringify(formData, null, 2));

    console.log('About to save to database...');
    console.log('Current handyman ID:', currentHandyman?.id);

    const { error } = await supabaseClient
      .from('handymen')
      .update(formData)
      .eq('id', currentHandyman.id);

    if (error) {
      console.error('Error saving step 2:', error);
      alert('Error saving data: ' + error.message);
      return;
    }

    console.log('Step 2 saved successfully, proceeding to next step...');
    nextStep();
  });

  // Debug button click
  document.getElementById('step2SubmitBtn').addEventListener('click', (e) => {
    console.log('Step 2 submit button clicked');
  });

  document.getElementById('step3Form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = {
      has_vehicle: document.getElementById('hasVehicle').checked,
      has_tools: document.getElementById('hasTools').checked,
      has_smartphone: document.getElementById('hasSmartphone').checked,
      has_ppe: document.getElementById('hasPPE').checked,
      has_ladder: document.getElementById('hasLadder').checked,
      additional_equipment: document.getElementById('additionalEquipment').value || null,
      updated_at: new Date().toISOString()
    };

    const { error } = await supabaseClient
      .from('handymen')
      .update(formData)
      .eq('id', currentHandyman.id);

    if (error) {
      console.error('Error saving step 3:', error);
      alert('Error saving data: ' + error.message);
      return;
    }

    nextStep();
  });

  document.getElementById('step4Form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = {
      agreed_to_service_terms: document.getElementById('agreeServiceTerms').checked,
      bio: document.getElementById('profileBioSetup').value,
      hourly_rate: 80, // Fixed rate for all handymen
      years_experience: parseInt(document.getElementById('yearsExp').value),
      updated_at: new Date().toISOString()
    };

    const { error } = await supabaseClient
      .from('handymen')
      .update(formData)
      .eq('id', currentHandyman.id);

    if (error) {
      console.error('Error saving step 4:', error);
      alert('Error saving data: ' + error.message);
      return;
    }

    nextStep();
  });

  document.getElementById('step5Form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = {
      agreed_code_of_conduct: document.getElementById('agreeCodeOfConduct').checked,
      agreed_dress_code: document.getElementById('agreeDressCode').checked,
      agreed_communication_standards: document.getElementById('agreeComm').checked,
      agreed_photo_documentation: document.getElementById('agreePhotos').checked,
      agreed_no_upsell: document.getElementById('agreeNoUpsell').checked,
      updated_at: new Date().toISOString()
    };

    const { error } = await supabaseClient
      .from('handymen')
      .update(formData)
      .eq('id', currentHandyman.id);

    if (error) {
      console.error('Error saving step 5:', error);
      alert('Error saving data: ' + error.message);
      return;
    }

    nextStep();
  });

  document.getElementById('step6Form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = {
      emergency_contact_name: document.getElementById('emergencyName').value,
      emergency_contact_phone: document.getElementById('emergencyPhone').value,
      emergency_contact_relation: document.getElementById('emergencyRelation').value,
      agreed_safety_policy: document.getElementById('agreeSafety').checked,
      agreed_hazard_reporting: document.getElementById('agreeReportHazards').checked,
      agreed_refuse_unsafe: document.getElementById('agreeRefuseUnsafe').checked,
      updated_at: new Date().toISOString()
    };

    const { error } = await supabaseClient
      .from('handymen')
      .update(formData)
      .eq('id', currentHandyman.id);

    if (error) {
      console.error('Error saving step 6:', error);
      alert('Error saving data: ' + error.message);
      return;
    }

    nextStep();
  });

  document.getElementById('step7Form').addEventListener('submit', async (e) => {
    e.preventDefault();

    // Validate account numbers match
    const accountNum = document.getElementById('accountNumber').value;
    const confirmAccountNum = document.getElementById('accountNumberConfirm').value;
    if (accountNum !== confirmAccountNum) {
      alert('Account numbers do not match. Please verify and try again.');
      return;
    }

    // Get user info for folder naming - use just user ID to match RLS policies
    const user = (await supabaseClient.auth.getUser()).data.user;
    const folderName = user.id;

    // Upload W-9 file
    const w9File = document.getElementById('w9Upload').files[0];
    let w9Url = null;

    if (w9File) {
      const w9Path = await uploadFile(
        w9File,
        'handyman-documents',
        `${folderName}/tax/${Date.now()}-${w9File.name}`
      );
      if (w9Path) {
        w9Url = `https://ynbhskdiplwabsksamxa.supabase.co/storage/v1/object/public/handyman-documents/${w9Path}`;
      }
    }

    const formData = {
      bank_name: document.getElementById('bankName').value,
      routing_number: document.getElementById('routingNumber').value,
      account_number: accountNum,
      account_type: document.getElementById('accountType').value,
      w9_form_url: w9Url,
      agreed_1099: document.getElementById('agree1099').checked,
      agreed_taxes: document.getElementById('agreeTaxes').checked,
      agreed_bank_info: document.getElementById('agreeBankInfo').checked,
      updated_at: new Date().toISOString()
    };

    const { error } = await supabaseClient
      .from('handymen')
      .update(formData)
      .eq('id', currentHandyman.id);

    if (error) {
      console.error('Error saving step 7:', error);
      alert('Error saving data: ' + error.message);
      return;
    }

    nextStep();
  });

  document.getElementById('step8Form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = {
      agreed_review_policy: document.getElementById('understandReviews').checked,
      agreed_quality_standards: document.getElementById('commitQuality').checked,
      agreed_reputation: document.getElementById('respectCommunity').checked,
      updated_at: new Date().toISOString()
    };

    const { error } = await supabaseClient
      .from('handymen')
      .update(formData)
      .eq('id', currentHandyman.id);

    if (error) {
      console.error('Error saving step 8:', error);
      alert('Error saving data: ' + error.message);
      return;
    }

    nextStep();
  });

  document.getElementById('step9Form').addEventListener('submit', async (e) => {
    e.preventDefault();

    // Collect Step 9 form data
    const formData = {
      welcome_call_scheduled: document.getElementById('welcomeCallDate').value,
      welcome_call_time: document.getElementById('welcomeCallTime').value,
      availability_start: document.getElementById('availableStart').value,
      workflow_reviewed: document.getElementById('reviewedWorkflow').checked,
      ready_to_start: document.getElementById('readyToStart').checked,
      onboarding_completed: true,
      onboarding_completed_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    };

    console.log('Step 9 form data being saved:', formData);

    // Mark onboarding as complete
    const { error } = await supabaseClient
      .from('handymen')
      .update(formData)
      .eq('id', currentHandyman.id);

    if (error) {
      console.error('Error saving Step 9:', error);
    } else {
      console.log('Step 9 saved successfully');
    }

    if (!error) {
      await loadHandymanData((await supabaseClient.auth.getUser()).data.user.id);
    }
  });

  // Add license button
  document.getElementById('addLicense').addEventListener('click', () => {
    const container = document.getElementById('licenseContainer');
    const newLicense = document.createElement('div');
    newLicense.className = 'border border-slate-200 rounded-lg p-4';
    newLicense.innerHTML = `
      <div class="grid md:grid-cols-3 gap-3">
        <input type="text" placeholder="License Type" class="license-type rounded-lg border border-slate-200 px-3 py-2" />
        <input type="text" placeholder="License Number" class="license-number rounded-lg border border-slate-200 px-3 py-2" />
        <input type="date" placeholder="Expiration Date" class="license-expiry rounded-lg border border-slate-200 px-3 py-2" />
      </div>
      <input type="file" accept="image/*,.pdf" class="license-file w-full rounded-lg border border-slate-200 px-3 py-2 mt-2" />
    `;
    container.appendChild(newLicense);
  });

  // Service state selector
  document.getElementById('serviceState').addEventListener('change', (e) => {
    if (e.target.value === 'FL') {
      document.getElementById('citySelection').classList.remove('hidden');
    } else {
      document.getElementById('citySelection').classList.add('hidden');
    }
  });

  // Initialize schedule grid
  function initializeSchedule() {
    const tbody = document.getElementById('scheduleBody');
    tbody.innerHTML = '';

    const hours = ['8 AM', '9 AM', '10 AM', '11 AM', '12 PM', '1 PM', '2 PM', '3 PM', '4 PM', '5 PM', '6 PM', '7 PM', '8 PM'];
    const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat'];

    hours.forEach(hour => {
      const row = document.createElement('tr');
      row.innerHTML = `<td class="py-2 px-3 border-b border-slate-100">${hour}</td>`;

      days.forEach(day => {
        const cell = document.createElement('td');
        cell.className = 'schedule-cell py-2 px-3 border-b border-slate-100 text-center cursor-pointer hover:bg-slate-100';
        cell.dataset.day = day;
        cell.dataset.hour = hour;

        cell.addEventListener('click', () => {
          cell.classList.toggle('selected');
        });

        row.appendChild(cell);
      });

      tbody.appendChild(row);
    });
  }

  // Save schedule
  document.getElementById('saveSchedule').addEventListener('click', async () => {
    const schedule = {};
    document.querySelectorAll('.schedule-cell.selected').forEach(cell => {
      const day = cell.dataset.day;
      const hour = cell.dataset.hour;
      if (!schedule[day]) schedule[day] = [];
      schedule[day].push(hour);
    });

    const { error } = await supabaseClient
      .from('handymen')
      .update({
        schedule: schedule,
        updated_at: new Date().toISOString()
      })
      .eq('id', currentHandyman.id);

    if (!error) {
      document.getElementById('scheduleSuccess').classList.remove('hidden');
      setTimeout(() => {
        document.getElementById('scheduleSuccess').classList.add('hidden');
      }, 3000);
    }
  });

  // Initialize charts with real data
  async function initializeCharts() {
    if (!currentHandyman) return;

    // Destroy existing charts if they exist
    Chart.getChart('performanceChart')?.destroy();
    Chart.getChart('serviceChart')?.destroy();

    try {
      // Get all completed tasks for this handyman
      const { data: completedTasks, error } = await supabaseClient
        .from('tasks')
        .select('completed_at, task_category')
        .eq('handyman_id', currentHandyman.id)
        .eq('status', 'completed')
        .not('completed_at', 'is', null);

      if (error) {
        console.error('Error fetching chart data:', error);
        return;
      }

      // Process data for monthly performance chart
      const monthlyData = processMonthlyPerformance(completedTasks || []);

      // Process data for service breakdown chart
      const serviceData = processServiceBreakdown(completedTasks || []);

      // Create performance chart
      const perfCtx = document.getElementById('performanceChart').getContext('2d');
      new Chart(perfCtx, {
        type: 'line',
        data: {
          labels: monthlyData.labels,
          datasets: [{
            label: 'Jobs Completed',
            data: monthlyData.data,
            borderColor: '#4f46e5',
            backgroundColor: 'rgba(79, 70, 229, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });

      // Create service breakdown chart
      const serviceCtx = document.getElementById('serviceChart').getContext('2d');
      new Chart(serviceCtx, {
        type: 'doughnut',
        data: {
          labels: serviceData.labels,
          datasets: [{
            data: serviceData.data,
            backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#6b7280', '#8b5cf6', '#f97316']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                usePointStyle: true,
                padding: 15
              }
            }
          }
        }
      });

    } catch (error) {
      console.error('Error initializing charts:', error);
    }
  }

  // Process monthly performance data
  function processMonthlyPerformance(tasks) {
    const now = new Date();
    const months = [];
    const counts = [];

    // Get last 6 months
    for (let i = 5; i >= 0; i--) {
      const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
      const monthName = date.toLocaleDateString('en-US', { month: 'short' });
      months.push(monthName);

      // Count tasks completed in this month
      const monthTasks = tasks.filter(task => {
        const completedDate = new Date(task.completed_at);
        return completedDate.getMonth() === date.getMonth() &&
               completedDate.getFullYear() === date.getFullYear();
      });
      counts.push(monthTasks.length);
    }

    return { labels: months, data: counts };
  }

  // Process service breakdown data
  function processServiceBreakdown(tasks) {
    const serviceCounts = {};

    // Count each service category
    tasks.forEach(task => {
      const category = task.task_category || 'Other';
      serviceCounts[category] = (serviceCounts[category] || 0) + 1;
    });

    // Convert to arrays and sort by count (descending)
    const sorted = Object.entries(serviceCounts)
      .sort(([,a], [,b]) => b - a)
      .slice(0, 7); // Top 7 categories

    // Format category names
    const formatCategoryName = (category) => {
      return category.replace(/_/g, ' ')
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    };

    const labels = sorted.map(([category]) => formatCategoryName(category));
    const data = sorted.map(([,count]) => count);

    // If no data, show placeholder
    if (labels.length === 0) {
      return {
        labels: ['No Services Yet'],
        data: [1]
      };
    }

    return { labels, data };
  }

  // Claude API Expert Advice
  async function askExpert(promptType) {
    const prompts = {
      'service-optimization': `Based on my handyman profile and task history, provide specific recommendations to improve my service efficiency and quality. Include tips on time management, tool organization, and workflow optimization.`,
      'more-bookings': `Analyze my profile and suggest strategies to increase my booking volume. Consider my current skills, service areas, pricing, and availability. Provide actionable steps I can take this week.`,
      'client-retention': `How can I turn one-time customers into repeat clients? Provide specific strategies for follow-up, building relationships, and creating a memorable service experience.`,
      'review-improvement': `Give me a detailed guide on consistently earning 5-star reviews. Include communication tips, service delivery best practices, and how to handle difficult situations professionally.`,
      'time-management': `Help me optimize my schedule to fit more jobs without sacrificing quality. Include strategies for route planning, time estimation, and minimizing downtime between jobs.`
    };

    const question = prompts[promptType];
    await getClaudeAdvice(question);
  }

  async function getClaudeAdvice(question) {
    document.getElementById('expertLoading').classList.remove('hidden');
    document.getElementById('expertResponse').classList.add('hidden');

    try {
      // Call Netlify function instead of Claude API directly
      const response = await fetch('/.netlify/functions/expert-advice', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          question: question,
          handymanProfile: {
            id: currentHandyman.id,
            full_name: currentHandyman.full_name,
            hourly_rate: currentHandyman.hourly_rate,
            years_experience: currentHandyman.years_experience,
            city: currentHandyman.city,
            zip: currentHandyman.zip,
            skills: currentHandyman.skills,
            average_rating: currentHandyman.average_rating
          }
        })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to get advice');
      }

      const data = await response.json();
      const advice = data.advice;

      document.getElementById('expertResponseText').textContent = advice;
      document.getElementById('expertLoading').classList.add('hidden');
      document.getElementById('expertResponse').classList.remove('hidden');

      // Save to recent questions
      saveRecentQuestion(question, advice);
    } catch (error) {
      console.error('Error getting advice:', error);
      document.getElementById('expertResponseText').textContent = 'Sorry, there was an error getting advice. Please try again. Error: ' + error.message;
      document.getElementById('expertLoading').classList.add('hidden');
      document.getElementById('expertResponse').classList.remove('hidden');
    }
  }

  // Custom expert question
  document.getElementById('expertForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const question = document.getElementById('customQuestion').value;
    await getClaudeAdvice(question);
  });

  function closeExpertResponse() {
    document.getElementById('expertResponse').classList.add('hidden');
    document.getElementById('customQuestion').value = '';
  }

  function saveRecentQuestion(question, answer) {
    // TODO: Save to database or local storage
    const container = document.getElementById('recentQuestions');
    const questionDiv = document.createElement('div');
    questionDiv.className = 'border-b border-slate-200 pb-3';
    questionDiv.innerHTML = `
      <div class="text-sm font-semibold">${question.substring(0, 100)}...</div>
      <div class="text-xs text-slate-500 mt-1">${new Date().toLocaleString()}</div>
    `;
    container.prepend(questionDiv);
  }

  // Load overview data
  async function loadOverviewData() {
    const now = new Date();
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);

    const { data: tasks } = await supabaseClient
      .from('tasks')
      .select('*')
      .eq('handyman_id', currentHandyman.id);

    const activeTasks = tasks?.filter(t => ['assigned', 'in_progress'].includes(t.status)).length || 0;
    const completedThisMonth = tasks?.filter(t =>
      t.status === 'completed' &&
      new Date(t.completed_at) >= firstDay
    ).length || 0;

    const earnedThisMonth = tasks?.filter(t =>
      t.status === 'completed' &&
      new Date(t.completed_at) >= firstDay
    ).reduce((sum, t) => sum + (parseFloat(t.total_amount) * 0.8), 0) || 0;

    const pendingAmount = tasks?.filter(t =>
      t.status === 'completed' && !t.paid
    ).reduce((sum, t) => sum + (parseFloat(t.total_amount) * 0.8), 0) || 0;

    document.getElementById('activeTasksCount').textContent = activeTasks;
    document.getElementById('completedCount').textContent = completedThisMonth;
    document.getElementById('earnedMonth').textContent = '$' + Math.round(earnedThisMonth);
    document.getElementById('pendingAmount').textContent = '$' + Math.round(pendingAmount);

    // Load upcoming tasks
    const upcomingTasks = tasks?.filter(t => t.status === 'assigned').slice(0, 5) || [];
    const upcomingHtml = upcomingTasks.length > 0 ? upcomingTasks.map(task => `
      <div class="border border-slate-200 rounded-lg p-3">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <div class="font-semibold">${task.task_category}</div>
            <div class="text-sm text-slate-600">${task.scheduled_date || 'TBD'} ‚Ä¢ ${task.customer_name}</div>
          </div>
          <span class="px-2 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-700">Upcoming</span>
        </div>
      </div>
    `).join('') : '<p class="text-slate-500 text-sm">No upcoming tasks</p>';

    document.getElementById('upcomingTasksList').innerHTML = upcomingHtml;
  }

  // Load current tasks
  async function loadCurrentTasks() {
    const { data: tasks } = await supabaseClient
      .from('tasks')
      .select('*')
      .eq('handyman_id', currentHandyman.id)
      .in('status', ['assigned', 'in_progress'])
      .order('scheduled_date', { ascending: true });

    const tasksHtml = tasks?.length > 0 ? tasks.map(task => {
      const statusColors = {
        'assigned': 'bg-blue-100 text-blue-700',
        'in_progress': 'bg-amber-100 text-amber-700'
      };

      return `
        <div class="border border-slate-200 rounded-lg p-4" id="task-${task.id}">
          <div class="flex items-start justify-between mb-3">
            <div>
              <div class="font-bold text-lg">${task.task_category}</div>
              <div class="text-sm text-slate-600">${task.customer_name}</div>
            </div>
            <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusColors[task.status]}">${task.status}</span>
          </div>
          <div class="space-y-1 text-sm mb-4">
            <div><strong>Phone:</strong> ${task.customer_phone || 'N/A'}</div>
            <div><strong>Address:</strong> ${task.customer_address || 'N/A'}</div>
            <div><strong>Scheduled:</strong> ${task.scheduled_date || 'TBD'}</div>
            <div><strong>Time Window:</strong> ${task.time_window || 'N/A'}</div>
            <div><strong>Amount:</strong> $${task.total_amount || 0}</div>
            ${task.notes ? `<div><strong>Notes:</strong> ${task.notes}</div>` : ''}
          </div>

          <!-- Task Completion Section -->
          <div class="border-t border-slate-200 pt-4 mt-4">
            <div class="mb-3">
              <label class="block text-sm font-semibold mb-2">Upload Completion Photos *</label>
              <input type="file"
                     id="completion-photos-${task.id}"
                     accept="image/*"
                     multiple
                     class="w-full text-sm border border-slate-200 rounded-lg px-3 py-2"
                     onchange="previewCompletionPhotos('${task.id}')" />
              <p class="text-xs text-slate-500 mt-1">Upload photos showing completed work (required for payment)</p>
            </div>

            <div id="photo-preview-${task.id}" class="mb-3 hidden">
              <div class="text-sm font-semibold mb-2">Photo Preview:</div>
              <div id="preview-container-${task.id}" class="grid grid-cols-2 md:grid-cols-3 gap-2"></div>
            </div>

            <div class="mb-3">
              <label class="block text-sm font-semibold mb-2">Completion Notes (Optional)</label>
              <textarea id="completion-notes-${task.id}"
                        rows="3"
                        class="w-full text-sm border border-slate-200 rounded-lg px-3 py-2"
                        placeholder="Any additional notes about the completed work..."></textarea>
            </div>

            <!-- Additional Materials Section -->
            <div class="border-t border-slate-200 pt-4 mt-4">
              <label class="flex items-center gap-2 mb-4 cursor-pointer">
                <input type="checkbox"
                       id="additional-materials-${task.id}"
                       class="rounded border-slate-300"
                       onchange="toggleMaterialsForm('${task.id}')">
                <span class="text-sm font-semibold">Additional materials were needed for this job</span>
              </label>

              <div id="materials-form-${task.id}" class="hidden space-y-3 bg-slate-50 p-4 rounded-lg border border-slate-200">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm font-semibold mb-1">Materials Cost ($) *</label>
                    <input type="number"
                           id="materials-cost-${task.id}"
                           step="0.01"
                           placeholder="0.00"
                           class="w-full text-sm border border-slate-200 rounded-lg px-3 py-2">
                    <p class="text-xs text-slate-500 mt-1">Enter total cost of materials purchased</p>
                  </div>

                  <div>
                    <label class="block text-sm font-semibold mb-1">Upload Receipts</label>
                    <input type="file"
                           id="materials-receipts-${task.id}"
                           multiple
                           accept="image/*"
                           class="w-full text-sm border border-slate-200 rounded-lg px-3 py-2">
                    <p class="text-xs text-slate-500 mt-1">Upload photos of receipts</p>
                  </div>
                </div>

                <div>
                  <label class="block text-sm font-semibold mb-1">Materials Description *</label>
                  <textarea id="materials-notes-${task.id}"
                            rows="2"
                            class="w-full text-sm border border-slate-200 rounded-lg px-3 py-2"
                            placeholder="What materials were purchased and why were they needed..."></textarea>
                </div>

                <div class="bg-amber-50 p-3 rounded-lg border border-amber-200">
                  <div class="flex items-start gap-2">
                    <span class="text-amber-600">üí∞</span>
                    <div>
                      <p class="text-sm font-semibold text-amber-800">Total Customer Charge</p>
                      <p class="text-sm text-amber-700">
                        $80 travel fee + materials cost = $<span id="total-additional-${task.id}">80.00</span>
                      </p>
                      <p class="text-xs text-amber-600 mt-1">
                        This will be automatically charged to the customer's saved payment method
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="flex gap-3">
              <button onclick="markTaskComplete('${task.id}')"
                      class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition-colors">
                ‚úÖ Mark Complete & Process Payment
              </button>
              <button onclick="markTaskInProgress('${task.id}')"
                      class="px-4 py-2 border border-slate-300 text-slate-700 rounded-lg font-semibold hover:bg-slate-50 transition-colors">
                üîÑ Mark In Progress
              </button>
            </div>
          </div>
        </div>
      `;
    }).join('') : '<p class="text-slate-500 text-sm">No current tasks</p>';

    document.getElementById('currentTasksList').innerHTML = tasksHtml;
  }

  // Load task history
  async function loadTaskHistory() {
    const { data: tasks } = await supabaseClient
      .from('tasks')
      .select('*')
      .eq('handyman_id', currentHandyman.id)
      .eq('status', 'completed')
      .order('completed_at', { ascending: false })
      .limit(20);

    const historyHtml = tasks?.length > 0 ? tasks.map(task => {
      const paymentStatus = task.payment_status === 'paid' ?
        '<span class="px-2 py-1 rounded text-xs font-semibold bg-green-100 text-green-700">üí∞ Paid</span>' :
        '<span class="px-2 py-1 rounded text-xs font-semibold bg-amber-100 text-amber-700">‚è≥ Processing</span>';

      const completionPhotos = task.completion_photo_urls && task.completion_photo_urls.length > 0 ?
        `<div class="mt-3">
          <div class="text-sm font-semibold mb-2">Completion Photos (${task.completion_photo_urls.length}):</div>
          <div class="grid grid-cols-3 gap-2">
            ${task.completion_photo_urls.slice(0, 3).map(photoUrl =>
              `<img src="${photoUrl}" alt="Completion photo" class="w-full h-16 object-cover rounded border cursor-pointer" onclick="window.open('${photoUrl}', '_blank')" />`
            ).join('')}
            ${task.completion_photo_urls.length > 3 ? `<div class="w-full h-16 bg-slate-100 rounded border flex items-center justify-center text-xs text-slate-600">+${task.completion_photo_urls.length - 3} more</div>` : ''}
          </div>
        </div>` : '';

      return `
        <div class="border border-slate-200 rounded-lg p-4">
          <div class="flex items-start justify-between mb-2">
            <div>
              <div class="font-bold">${task.task_category}</div>
              <div class="text-sm text-slate-600">Completed: ${new Date(task.completed_at).toLocaleDateString()}</div>
            </div>
            <div class="flex gap-2">
              <span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">‚úÖ Completed</span>
              ${paymentStatus}
            </div>
          </div>
          <div class="text-sm space-y-1">
            <div><strong>Customer:</strong> ${task.customer_name}</div>
            <div><strong>Amount:</strong> $${task.total_amount || 0}</div>
            ${task.completion_notes ? `<div><strong>Notes:</strong> ${task.completion_notes}</div>` : ''}
          </div>
          ${completionPhotos}
        </div>
      `;
    }).join('') : '<p class="text-slate-500 text-sm">No completed tasks</p>';

    document.getElementById('historyTasksList').innerHTML = historyHtml;
  }

  // Load earnings
  async function loadEarnings() {
    const { data: tasks } = await supabaseClient
      .from('tasks')
      .select('*')
      .eq('handyman_id', currentHandyman.id)
      .eq('status', 'completed');

    const totalEarned = tasks?.reduce((sum, t) => sum + (parseFloat(t.total_amount) * 0.8), 0) || 0;
    const totalPaid = tasks?.filter(t => t.payment_status === 'paid').reduce((sum, t) => sum + (parseFloat(t.total_amount) * 0.8), 0) || 0;
    const awaiting = totalEarned - totalPaid;

    document.getElementById('totalEarned').textContent = '$' + Math.round(totalEarned);
    document.getElementById('totalPaid').textContent = '$' + Math.round(totalPaid);
    document.getElementById('awaitingPayment').textContent = '$' + Math.round(awaiting);

    const paymentsHtml = tasks?.length > 0 ? tasks.map(task => `
      <div class="border-b border-slate-100 pb-3 flex items-center justify-between">
        <div>
          <div class="font-semibold">$${(parseFloat(task.total_amount) * 0.8).toFixed(2)}</div>
          <div class="text-xs text-slate-600">${new Date(task.completed_at).toLocaleDateString()}</div>
        </div>
        <span class="px-3 py-1 rounded-full text-xs font-semibold ${task.payment_status === 'paid' ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'}">
          ${task.payment_status === 'paid' ? 'Paid' : 'Pending'}
        </span>
      </div>
    `).join('') : '<p class="text-slate-500 text-sm">No payment history</p>';

    document.getElementById('paymentHistoryList').innerHTML = paymentsHtml;
  }

  // Load profile
  async function loadProfile() {
    if (!currentHandyman) {
      console.log('No currentHandyman data available');
      return;
    }

    console.log('Loading profile for handyman:', currentHandyman);

    document.getElementById('profileName').value = currentHandyman.full_name || '';
    document.getElementById('profilePhone').value = currentHandyman.phone || '';
    document.getElementById('profileCity').value = currentHandyman.city || '';
    document.getElementById('profileZip').value = currentHandyman.zip || '';
    document.getElementById('profileBio').value = currentHandyman.bio || '';
    document.getElementById('profileState').value = currentHandyman.service_state || '';

    // Trigger county loading if state is selected
    if (currentHandyman.service_state) {
      const event = new Event('change');
      document.getElementById('profileState').dispatchEvent(event);
    }

    // Load profile picture with better error handling
    console.log('Profile photo URL from database:', currentHandyman.profile_photo_url);
    const img = document.getElementById('currentProfilePic');
    const placeholder = document.getElementById('profilePicPlaceholder');

    if (!img || !placeholder) {
      console.error('Profile picture elements not found:', { img, placeholder });
      return;
    }

    if (currentHandyman.profile_photo_url && currentHandyman.profile_photo_url.trim() !== '') {
      console.log('Setting profile picture URL:', currentHandyman.profile_photo_url);

      // Try multiple approaches to load the image
      let imageUrl = currentHandyman.profile_photo_url;

      // Check if this is an expired signed URL and regenerate if needed
      if (imageUrl.includes('/object/sign/') && imageUrl.includes('token=')) {
        console.log('Detected signed URL, checking if expired and regenerating...');
        try {
          const urlParts = imageUrl.split('/object/sign/handyman-documents/')[1];
          if (urlParts) {
            const filePath = urlParts.split('?token=')[0];
            console.log('Regenerating signed URL for path:', filePath);

            const { data: signedUrlData, error: signedUrlError } = await supabaseClient.storage
              .from('handyman-documents')
              .createSignedUrl(filePath, 3600);

            if (signedUrlData && !signedUrlError) {
              imageUrl = signedUrlData.signedUrl;
              console.log('Using regenerated signed URL:', imageUrl);

              // Add handlers and set image
              img.onload = function() {
                console.log('Profile picture loaded successfully with regenerated URL');
                img.classList.remove('hidden');
                placeholder.classList.add('hidden');
              };
              img.onerror = function() {
                console.error('Even regenerated signed URL failed');
                img.classList.add('hidden');
                placeholder.classList.remove('hidden');
              };
              img.src = imageUrl;
              return;
            }
          }
        } catch (error) {
          console.log('Error regenerating signed URL:', error);
        }
      }

      // If it's a Supabase storage URL, try to get proper access
      if (imageUrl.includes('supabase.co/storage')) {
        try {
          // Extract the file path from the URL
          const urlParts = imageUrl.split('/object/public/handyman-documents/');
          if (urlParts.length === 2) {
            const filePath = urlParts[1];
            console.log('File path extracted:', filePath);

            // Try to get a fresh public URL
            const { data: publicUrlData } = supabaseClient.storage
              .from('handyman-documents')
              .getPublicUrl(filePath);

            if (publicUrlData && publicUrlData.publicUrl) {
              imageUrl = publicUrlData.publicUrl;
              console.log('Using fresh public URL:', imageUrl);
            }

            // Also try signed URL as backup
            const { data: signedUrlData, error: signedUrlError } = await supabaseClient.storage
              .from('handyman-documents')
              .createSignedUrl(filePath, 3600);

            if (signedUrlData && !signedUrlError) {
              console.log('Signed URL available as backup:', signedUrlData.signedUrl);

              // Test if public URL works first, if not use signed URL
              const testImg = new Image();
              testImg.onload = function() {
                console.log('Public URL works, using it');
                img.classList.remove('hidden');
                placeholder.classList.add('hidden');
                img.src = imageUrl;
              };
              testImg.onerror = function() {
                console.log('Public URL failed, using signed URL');
                img.classList.remove('hidden');
                placeholder.classList.add('hidden');
                img.src = signedUrlData.signedUrl;
              };
              testImg.src = imageUrl;

              // Don't set img.src here, let the test image handlers do it
              return;
            }
          }
        } catch (error) {
          console.log('Error processing Supabase URL:', error);
        }
      }

      // Add error and load handlers
      img.onerror = function() {
        console.error('Failed to load profile image:', imageUrl);
        console.log('Trying to reload with cache busting...');

        // Try cache busting
        const cacheBustUrl = imageUrl + (imageUrl.includes('?') ? '&' : '?') + 'cb=' + Date.now();
        console.log('Cache bust URL:', cacheBustUrl);

        const retryImg = new Image();
        retryImg.onload = function() {
          console.log('Cache bust successful');
          img.src = cacheBustUrl;
          img.classList.remove('hidden');
          placeholder.classList.add('hidden');
        };
        retryImg.onerror = function() {
          console.log('Cache bust also failed, showing placeholder');
          img.classList.add('hidden');
          placeholder.classList.remove('hidden');
        };
        retryImg.src = cacheBustUrl;
      };

      img.onload = function() {
        console.log('Profile picture loaded successfully');
        img.classList.remove('hidden');
        placeholder.classList.add('hidden');
      };

      // Set the image source
      img.src = imageUrl;
    } else {
      console.log('No profile photo URL found, showing placeholder');
      img.classList.add('hidden');
      placeholder.classList.remove('hidden');
    }

    // Load skills
    if (currentHandyman.skills) {
      document.querySelectorAll('.skill-checkbox').forEach(cb => {
        cb.checked = currentHandyman.skills.includes(cb.value);
      });
    }

    // Load service areas
    if (currentHandyman.service_state) {
      document.getElementById('serviceState').value = currentHandyman.service_state;
      // Trigger the change event to load counties
      const event = new Event('change');
      document.getElementById('serviceState').dispatchEvent(event);

      // Set selected counties after a short delay to ensure they're loaded
      setTimeout(() => {
        if (currentHandyman.service_areas) {
          document.querySelectorAll('.city-checkbox').forEach(cb => {
            cb.checked = currentHandyman.service_areas.includes(cb.value);
          });
        }
      }, 100);
    }

    // Load insurance
    if (currentHandyman.insurance_status) {
      document.getElementById('editInsuranceStatus').value = currentHandyman.insurance_status;
      document.getElementById('editInsuranceProvider').value = currentHandyman.insurance_provider || '';
    }
  }


  // Handle state selection
  document.getElementById('profileState').addEventListener('change', function() {
    const state = this.value;
    const countySelect = document.getElementById('profileCounty');

    // Clear existing options
    countySelect.innerHTML = '<option value="">Select County</option>';

    if (state && stateCounties[state]) {
      stateCounties[state].forEach(county => {
        const option = document.createElement('option');
        option.value = county;
        option.textContent = county;
        countySelect.appendChild(option);
      });
    }
  });

  // Handle profile picture upload
  document.getElementById('newProfilePhoto').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    console.log('Profile photo file selected:', file.name);

    // Show preview immediately
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = document.getElementById('currentProfilePic');
      const placeholder = document.getElementById('profilePicPlaceholder');

      if (img && placeholder) {
        img.src = e.target.result;
        img.classList.remove('hidden');
        placeholder.classList.add('hidden');
        console.log('Profile photo preview loaded');
      }
    };
    reader.readAsDataURL(file);

    // Upload to storage
    const user = (await supabaseClient.auth.getUser()).data.user;
    console.log('Uploading profile photo for user:', user.id);

    const filePath = await uploadFile(
      file,
      'handyman-documents',
      `${user.id}/profile/${Date.now()}-${file.name}`
    );

    if (filePath) {
      // Store the file path in database, not the full URL (since we need signed URLs)
      // We'll reconstruct the URL when needed
      const profilePhotoPath = filePath;
      console.log('Profile photo uploaded, path:', profilePhotoPath);

      // Get a fresh signed URL for immediate use
      const { data: signedUrlData, error: signedUrlError } = await supabaseClient.storage
        .from('handyman-documents')
        .createSignedUrl(profilePhotoPath, 3600);

      const profilePhotoUrl = signedUrlData?.signedUrl || `https://ynbhskdiplwabsksamxa.supabase.co/storage/v1/object/public/handyman-documents/${profilePhotoPath}`;

      // Update database
      const { error } = await supabaseClient
        .from('handymen')
        .update({ profile_photo_url: profilePhotoUrl })
        .eq('id', currentHandyman.id);

      if (error) {
        console.error('Error updating profile photo in database:', error);
        alert('Failed to save profile photo. Please try again.');
      } else {
        console.log('Profile photo updated successfully in database');
        currentHandyman.profile_photo_url = profilePhotoUrl;

        // Show success message
        const successMsg = document.createElement('div');
        successMsg.className = 'text-sm text-green-600 mt-2';
        successMsg.textContent = 'Profile photo updated successfully!';
        document.querySelector('[onclick="document.getElementById(\'newProfilePhoto\').click()"]').parentNode.appendChild(successMsg);

        setTimeout(() => successMsg.remove(), 3000);
      }
    } else {
      console.error('Failed to upload profile photo');
      alert('Failed to upload profile photo. Please try again.');
    }
  });

  // State counties mapping
  const stateCounties = {
    'FL': [
      'Alachua', 'Baker', 'Bay', 'Bradford', 'Brevard', 'Broward', 'Calhoun', 'Charlotte', 'Citrus', 'Clay',
      'Collier', 'Columbia', 'DeSoto', 'Dixie', 'Duval', 'Escambia', 'Flagler', 'Franklin', 'Gadsden', 'Gilchrist',
      'Glades', 'Gulf', 'Hamilton', 'Hardee', 'Hendry', 'Hernando', 'Highlands', 'Hillsborough', 'Holmes', 'Indian River',
      'Jackson', 'Jefferson', 'Lafayette', 'Lake', 'Lee', 'Leon', 'Levy', 'Liberty', 'Madison', 'Manatee',
      'Marion', 'Martin', 'Miami-Dade', 'Monroe', 'Nassau', 'Okaloosa', 'Okeechobee', 'Orange', 'Osceola', 'Palm Beach',
      'Pasco', 'Pinellas', 'Polk', 'Putnam', 'Saint Johns', 'Saint Lucie', 'Santa Rosa', 'Sarasota', 'Seminole', 'Sumter',
      'Suwannee', 'Taylor', 'Union', 'Volusia', 'Wakulla', 'Walton', 'Washington'
    ],
    'TX': [
      'Travis', 'Williamson', 'Hays', 'Caldwell', 'Bastrop', 'Harris', 'Dallas', 'Tarrant', 'Bexar', 'Collin',
      'Denton', 'Fort Bend', 'Hidalgo', 'Montgomery', 'Galveston', 'Brazoria', 'Jefferson', 'Nueces', 'Bell',
      'McLennan', 'Guadalupe', 'Comal', 'Wilson', 'Blanco'
    ]
  };

  // Handle service area state selection
  document.getElementById('serviceState').addEventListener('change', function() {
    console.log('Service state changed to:', this.value);
    const state = this.value;
    const citySelection = document.getElementById('citySelection');

    if (state && stateCounties[state]) {
      console.log('Loading counties for state:', state, 'Counties:', stateCounties[state]);
      // Show city selection
      citySelection.classList.remove('hidden');

      // Clear existing options
      citySelection.innerHTML = '';

      // Add counties as checkboxes
      stateCounties[state].forEach(county => {
        const label = document.createElement('label');
        label.className = 'flex items-center gap-2';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'city-checkbox';
        checkbox.value = county.toLowerCase().replace(/[^a-z0-9]/g, '-');

        const span = document.createElement('span');
        span.className = 'text-sm';
        span.textContent = county + ' County';

        label.appendChild(checkbox);
        label.appendChild(span);
        citySelection.appendChild(label);
      });
    } else {
      // Hide city selection
      citySelection.classList.add('hidden');
    }
  });

  // Update profile
  document.getElementById('profileForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const { error } = await supabaseClient
      .from('handymen')
      .update({
        full_name: document.getElementById('profileName').value,
        phone: document.getElementById('profilePhone').value,
        city: document.getElementById('profileCity').value,
        zip: document.getElementById('profileZip').value,
        bio: document.getElementById('profileBio').value,
        service_state: document.getElementById('profileState').value,
        updated_at: new Date().toISOString()
      })
      .eq('id', currentHandyman.id);

    if (!error) {
      document.getElementById('profileSuccess').classList.remove('hidden');
      setTimeout(() => {
        document.getElementById('profileSuccess').classList.add('hidden');
      }, 3000);
      await loadHandymanData((await supabaseClient.auth.getUser()).data.user.id);
    }
  });

  // Update skills
  document.getElementById('skillsForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const skills = Array.from(document.querySelectorAll('.skill-checkbox:checked')).map(cb => cb.value);
    const serviceAreas = Array.from(document.querySelectorAll('.city-checkbox:checked')).map(cb => cb.value);

    const { error } = await supabaseClient
      .from('handymen')
      .update({
        skills: skills,
        service_areas: serviceAreas,
        updated_at: new Date().toISOString()
      })
      .eq('id', currentHandyman.id);

    if (!error) {
      document.getElementById('skillsSuccess').classList.remove('hidden');
      setTimeout(() => {
        document.getElementById('skillsSuccess').classList.add('hidden');
      }, 3000);
    }
  });

  // Update insurance
  document.getElementById('insuranceForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const { error } = await supabaseClient
      .from('handymen')
      .update({
        insurance_status: document.getElementById('editInsuranceStatus').value,
        insurance_provider: document.getElementById('editInsuranceProvider').value,
        updated_at: new Date().toISOString()
      })
      .eq('id', currentHandyman.id);

    if (!error) {
      document.getElementById('insuranceSuccess').classList.remove('hidden');
      setTimeout(() => {
        document.getElementById('insuranceSuccess').classList.add('hidden');
      }, 3000);
    }
  });

  // Change password
  document.getElementById('passwordForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const newPass = document.getElementById('settingsNewPassword').value;
    const confirmPass = document.getElementById('settingsConfirmPassword').value;

    if (newPass !== confirmPass) {
      document.getElementById('passwordError').textContent = 'Passwords do not match';
      document.getElementById('passwordError').classList.remove('hidden');
      return;
    }

    const { error } = await supabaseClient.auth.updateUser({ password: newPass });

    if (error) {
      document.getElementById('passwordError').textContent = error.message;
      document.getElementById('passwordError').classList.remove('hidden');
    } else {
      document.getElementById('passwordError').classList.add('hidden');
      document.getElementById('passwordSuccess').classList.remove('hidden');
      document.getElementById('passwordForm').reset();
      setTimeout(() => {
        document.getElementById('passwordSuccess').classList.add('hidden');
      }, 3000);
    }
  });

  // Tab navigation
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const tab = btn.dataset.tab;

      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
      btn.classList.add('tab-active');

      document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
      document.getElementById(tab + 'Tab').classList.remove('hidden');

      // Refresh profile data when profile tab is clicked
      if (tab === 'profile') {
        console.log('Profile tab clicked, refreshing profile data');
        refreshHandymanData().then(() => {
          loadProfile();
        });
      }
    });
  });

  // Test profile picture loading
  async function testProfilePicture() {
    if (!currentHandyman || !currentHandyman.profile_photo_url) {
      alert('No profile picture URL found');
      return;
    }

    console.log('Testing profile picture URL:', currentHandyman.profile_photo_url);

    // Test 1: Try to fetch the URL directly
    try {
      const response = await fetch(currentHandyman.profile_photo_url, { method: 'HEAD' });
      console.log('Direct fetch response:', response.status, response.statusText);

      if (response.ok) {
        console.log('‚úÖ Direct fetch successful');
        loadProfile(); // Retry loading
      } else {
        console.log('‚ùå Direct fetch failed');

        // Test 2: Try signed URL
        const urlParts = currentHandyman.profile_photo_url.split('/object/public/handyman-documents/');
        if (urlParts.length === 2) {
          const filePath = urlParts[1];
          const { data: signedUrlData, error } = await supabaseClient.storage
            .from('handyman-documents')
            .createSignedUrl(filePath, 60);

          if (signedUrlData && !error) {
            console.log('‚úÖ Signed URL created:', signedUrlData.signedUrl);

            // Test the signed URL
            const signedResponse = await fetch(signedUrlData.signedUrl, { method: 'HEAD' });
            console.log('Signed URL fetch response:', signedResponse.status, signedResponse.statusText);

            if (signedResponse.ok) {
              // Don't store signed URL in database (it expires), just use it temporarily
              currentHandyman.profile_photo_url = signedUrlData.signedUrl;
              loadProfile();
              console.log('‚úÖ Using signed URL (temporary)');
            }
          } else {
            console.log('‚ùå Signed URL creation failed:', error);
          }
        }
      }
    } catch (error) {
      console.error('Test failed:', error);
      alert('Test failed - check console for details');
    }
  }

  // Initialize app
  async function initializeApp() {
    try {
      await initializeSupabase();
      await checkAuth();
    } catch (error) {
      console.error('Initialization error:', error);
      alert('Failed to initialize dashboard. Please refresh the page.');
    }
  }

  // Preview completion photos
  function previewCompletionPhotos(taskId) {
    const fileInput = document.getElementById(`completion-photos-${taskId}`);
    const previewContainer = document.getElementById(`preview-container-${taskId}`);
    const previewSection = document.getElementById(`photo-preview-${taskId}`);

    if (!fileInput.files || fileInput.files.length === 0) {
      previewSection.classList.add('hidden');
      return;
    }

    previewContainer.innerHTML = '';
    previewSection.classList.remove('hidden');

    Array.from(fileInput.files).forEach((file, index) => {
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.className = 'w-full h-20 object-cover rounded border';
          img.alt = `Completion photo ${index + 1}`;
          previewContainer.appendChild(img);
        };
        reader.readAsDataURL(file);
      }
    });
  }

  // Mark task as in progress
  async function markTaskInProgress(taskId) {
    try {
      const { error } = await supabaseClient
        .from('tasks')
        .update({
          status: 'in_progress',
          updated_at: new Date().toISOString()
        })
        .eq('id', taskId);

      if (error) throw error;

      alert('Task marked as in progress');
      loadCurrentTasks();
    } catch (error) {
      console.error('Error updating task status:', error);
      alert('Failed to update task status');
    }
  }

  // Mark task as complete and process payment
  async function markTaskComplete(taskId) {
    const fileInput = document.getElementById(`completion-photos-${taskId}`);
    const notes = document.getElementById(`completion-notes-${taskId}`).value;

    // Validate required photos
    if (!fileInput.files || fileInput.files.length === 0) {
      alert('Please upload at least one completion photo before marking the task as complete.');
      return;
    }

    if (!confirm('Are you sure you want to mark this task as complete? This will process the customer payment and cannot be undone.')) {
      return;
    }

    try {
      // Show loading state
      const button = document.querySelector(`button[onclick="markTaskComplete('${taskId}')"]`);
      const originalText = button.textContent;
      button.disabled = true;
      button.textContent = 'Processing...';

      // Upload completion photos
      const user = (await supabaseClient.auth.getUser()).data.user;
      const photoUrls = [];

      for (let i = 0; i < fileInput.files.length; i++) {
        const file = fileInput.files[i];
        const timestamp = Date.now();
        const fileName = `completion-${timestamp}-${i + 1}-${file.name}`;

        const filePath = await uploadFile(
          file,
          'handyman-documents',
          `${user.id}/completions/${taskId}/${fileName}`
        );

        if (filePath) {
          // Get signed URL for the uploaded image
          const { data: signedUrlData } = await supabaseClient.storage
            .from('handyman-documents')
            .createSignedUrl(filePath, 31536000); // 1 year expiry for completion photos

          if (signedUrlData) {
            photoUrls.push(signedUrlData.signedUrl);
          }
        }
      }

      if (photoUrls.length === 0) {
        throw new Error('Failed to upload completion photos');
      }

      console.log('üì∏ Uploaded completion photos:', photoUrls.length);

      // Update task status and add completion data
      const { error: taskError } = await supabaseClient
        .from('tasks')
        .update({
          status: 'completed',
          completed_at: new Date().toISOString(),
          completion_photo_urls: photoUrls,
          completion_notes: notes || null,
          updated_at: new Date().toISOString()
        })
        .eq('id', taskId);

      if (taskError) throw taskError;

      console.log('‚úÖ Task marked as completed in database');

      // Process payment capture
      const response = await fetch('/.netlify/functions/capture-payment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          task_id: taskId,
          completion_photos: photoUrls,
          completion_notes: notes || 'Task completed successfully'
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Payment processing failed');
      }

      const result = await response.json();
      console.log('üí∞ Payment captured successfully:', result);

      // Check if additional materials are needed
      const additionalMaterialsCheckbox = document.getElementById(`additional-materials-${taskId}`);
      if (additionalMaterialsCheckbox && additionalMaterialsCheckbox.checked) {
        await processAdditionalMaterials(taskId);
      }

      // Show success message
      alert('‚úÖ Task completed successfully! Payment has been processed and customer has been charged.');

      // Refresh task lists
      loadCurrentTasks();
      loadTaskHistory();
      loadEarnings();

    } catch (error) {
      console.error('‚ùå Error completing task:', error);
      alert(`Failed to complete task: ${error.message}`);

      // Restore button state
      button.disabled = false;
      button.textContent = originalText;
    }
  }

  // Toggle materials form visibility
  function toggleMaterialsForm(taskId) {
    const checkbox = document.getElementById(`additional-materials-${taskId}`);
    const form = document.getElementById(`materials-form-${taskId}`);
    const costInput = document.getElementById(`materials-cost-${taskId}`);

    if (checkbox.checked) {
      form.classList.remove('hidden');
      costInput.addEventListener('input', () => updateMaterialsTotal(taskId));
    } else {
      form.classList.add('hidden');
      costInput.value = '';
      updateMaterialsTotal(taskId);
    }
  }

  // Update total additional cost display
  function updateMaterialsTotal(taskId) {
    const costInput = document.getElementById(`materials-cost-${taskId}`);
    const totalSpan = document.getElementById(`total-additional-${taskId}`);
    const materialsCost = parseFloat(costInput.value) || 0;
    const travelFee = 80;
    const total = materialsCost + travelFee;
    totalSpan.textContent = total.toFixed(2);
  }

  // Upload materials receipts
  async function uploadMaterialsReceipts(taskId, files) {
    const user = (await supabaseClient.auth.getUser()).data.user;
    const receiptUrls = [];

    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const timestamp = Date.now();
      const fileName = `receipt-${timestamp}-${i + 1}-${file.name}`;

      const filePath = await uploadFile(
        file,
        'handyman-documents',
        `${user.id}/receipts/${taskId}/${fileName}`
      );

      if (filePath) {
        const { data: signedUrlData } = await supabaseClient.storage
          .from('handyman-documents')
          .createSignedUrl(filePath, 31536000); // 1 year expiry

        if (signedUrlData) {
          receiptUrls.push(signedUrlData.signedUrl);
        }
      }
    }

    return receiptUrls;
  }

  // Process additional materials charge
  async function processAdditionalMaterials(taskId) {
    try {
      console.log('üí∞ Processing additional materials for task:', taskId);

      // Get materials form data
      const materialsCost = parseFloat(document.getElementById(`materials-cost-${taskId}`).value) || 0;
      const materialsNotes = document.getElementById(`materials-notes-${taskId}`).value;
      const receiptsInput = document.getElementById(`materials-receipts-${taskId}`);

      // Validate required fields
      if (materialsCost <= 0) {
        throw new Error('Please enter a valid materials cost');
      }
      if (!materialsNotes.trim()) {
        throw new Error('Please provide a description of the materials purchased');
      }

      // Upload receipt photos if any
      let receiptUrls = [];
      if (receiptsInput.files && receiptsInput.files.length > 0) {
        console.log('üì∏ Uploading receipt photos...');
        receiptUrls = await uploadMaterialsReceipts(taskId, receiptsInput.files);
      }

      // Charge additional materials
      const additionalChargeResponse = await fetch('/.netlify/functions/charge-additional-materials', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          task_id: taskId,
          material_costs: materialsCost,
          travel_fee: 80,
          material_receipts: receiptUrls,
          handyman_notes: materialsNotes,
          customer_approved: true // Handyman confirms customer approved the purchase
        })
      });

      if (!additionalChargeResponse.ok) {
        const errorData = await additionalChargeResponse.json();
        throw new Error(errorData.error || 'Additional materials charge failed');
      }

      const additionalResult = await additionalChargeResponse.json();
      console.log('üí∞ Additional materials charged successfully:', additionalResult);

      const totalAdditional = materialsCost + 80;
      alert(`‚úÖ Additional materials charged successfully!\n\nMaterials: $${materialsCost}\nTravel fee: $80\nTotal additional charge: $${totalAdditional}\n\nCustomer has been notified and charged.`);

    } catch (error) {
      console.error('‚ùå Error processing additional materials:', error);
      alert(`Failed to process additional materials: ${error.message}`);
      throw error; // Re-throw to handle in parent function
    }
  }

  // Check admin access using admin_users table
  async function checkAdminAccess(email) {
    if (!email) {
      console.log('‚ùå No email provided to checkAdminAccess');
      return;
    }

    try {
      console.log('üîê Checking admin access for:', email);

      // Get current auth user to use their UUID
      const { data: { user } } = await supabaseClient.auth.getUser();

      if (user) {
        // First try to find by auth UUID - handle potential duplicates
        const { data: adminUsers, error: adminError } = await supabaseClient
          .from('admin_users')
          .select('id, email, full_name, role, is_active')
          .eq('id', user.id)
          .eq('is_active', true);

        let adminUser = null;
        let error = adminError;

        if (adminUsers && adminUsers.length > 0) {
          adminUser = adminUsers[0]; // Use first match if multiple exist
          error = null;
          if (adminUsers.length > 1) {
            console.warn(`üö® Multiple admin records found for user ${user.id}, using first one`);
          }
        }

        if (error) {
          console.log('üîç Admin table query error (UUID):', error.code, error.message);
          // Don't log as error if it's just access denied or table doesn't exist
        }

        if (!error && adminUser) {
          console.log('‚úÖ Admin access granted:', adminUser.role);
          document.getElementById('adminBtn').classList.remove('hidden');

          // Update last login time
          try {
            await supabaseClient
              .from('admin_users')
              .update({ last_login_at: new Date().toISOString() })
              .eq('id', adminUser.id);
          } catch (updateError) {
            console.log('‚ö†Ô∏è Could not update admin login time:', updateError);
          }
          return;
        }
      }

      // Fallback: check by email for existing records - handle potential duplicates
      const { data: adminUsersByEmail, error: emailError } = await supabaseClient
        .from('admin_users')
        .select('id, email, full_name, role, is_active')
        .eq('email', email.toLowerCase())
        .eq('is_active', true);

      let adminUser = null;
      let error = emailError;

      if (adminUsersByEmail && adminUsersByEmail.length > 0) {
        adminUser = adminUsersByEmail[0]; // Use first match if multiple exist
        error = null;
        if (adminUsersByEmail.length > 1) {
          console.warn(`üö® Multiple admin records found for email ${email}, using first one`);
        }
      }

      if (error) {
        console.log('üîç Admin table query error (email):', error.code, error.message);
        console.log('‚ÑπÔ∏è No admin access for this user (table query failed)');
        return;
      }

      if (adminUser) {
        console.log('‚úÖ Admin access granted (by email):', adminUser.role);
        document.getElementById('adminBtn').classList.remove('hidden');

        // Update last login time
        try {
          await supabaseClient
            .from('admin_users')
            .update({ last_login_at: new Date().toISOString() })
            .eq('id', adminUser.id);
        } catch (updateError) {
          console.log('‚ö†Ô∏è Could not update admin login time:', updateError);
        }
      } else {
        console.log('‚ÑπÔ∏è No admin access for this user');
      }
    } catch (error) {
      console.error('‚ùå Error checking admin access:', error);
    }
  }


  // Start
  initializeApp();
</script>

</body>
</html>