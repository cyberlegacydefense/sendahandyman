<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Handyman Dashboard - SendAHandyman</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="images/favicon.png">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .shadow-soft{box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .tab-active { border-bottom: 3px solid #4f46e5; color: #4f46e5; }
  </style>
</head>
<body class="bg-slate-50">

<!-- Login Page -->
<div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl p-8 shadow-soft border border-slate-100 w-full max-w-md">
    <div class="text-center mb-8">
      <h1 class="text-2xl font-bold mb-2">Handyman Portal</h1>
      <p class="text-slate-600">Sign in to access your dashboard</p>
    </div>

    <form id="loginForm" class="space-y-4">
      <div>
        <label class="block text-sm font-semibold mb-1">Email</label>
        <input type="email" id="loginEmail" required class="w-full rounded-lg border border-slate-200 px-3 py-2" />
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Password</label>
        <div class="relative">
          <input type="password" id="loginPassword" required class="w-full rounded-lg border border-slate-200 px-3 py-2 pr-10" />
          <button type="button" id="togglePassword" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-700 focus:outline-none">
            <svg id="eyeIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            </svg>
            <svg id="eyeSlashIcon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
            </svg>
          </button>
        </div>
      </div>
      <button type="submit" class="w-full rounded-xl bg-indigo-600 text-white px-4 py-3 font-semibold hover:bg-indigo-700 transition-colors">
        Sign In
      </button>
      <div id="loginError" class="hidden text-sm text-red-600 text-center"></div>
    </form>
  </div>
</div>

<!-- Dashboard -->
<div id="dashboardPage" class="hidden min-h-screen">
  <!-- Header -->
  <header class="bg-white border-b border-slate-200 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <h1 class="text-xl font-bold">SendAHandyman Dashboard</h1>
        </div>
        <div class="flex items-center gap-4">
          <span id="handymanName" class="text-sm font-semibold text-slate-700"></span>
          <button id="logoutBtn" class="text-sm text-slate-600 hover:text-slate-900">Sign Out</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <div class="bg-white border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4">
      <nav class="flex gap-8">
        <button class="tab-btn py-4 font-semibold text-sm tab-active" data-tab="overview">Overview</button>
        <button class="tab-btn py-4 font-semibold text-sm" data-tab="tasks">Current Tasks</button>
        <button class="tab-btn py-4 font-semibold text-sm" data-tab="history">Task History</button>
        <button class="tab-btn py-4 font-semibold text-sm" data-tab="earnings">Earnings</button>
        <button class="tab-btn py-4 font-semibold text-sm" data-tab="profile">Profile</button>
      </nav>
    </div>
  </div>

  <!-- Content -->
  <div class="max-w-7xl mx-auto px-4 py-8">

    <!-- Overview Tab -->
    <div id="overviewTab" class="tab-content">
      <div class="grid md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-xl p-6 shadow-soft border border-slate-100">
          <div class="text-slate-600 text-sm font-semibold mb-1">Active Tasks</div>
          <div id="activeTasksCount" class="text-3xl font-bold text-indigo-600">0</div>
        </div>
        <div class="bg-white rounded-xl p-6 shadow-soft border border-slate-100">
          <div class="text-slate-600 text-sm font-semibold mb-1">Completed This Month</div>
          <div id="completedCount" class="text-3xl font-bold text-green-600">0</div>
        </div>
        <div class="bg-white rounded-xl p-6 shadow-soft border border-slate-100">
          <div class="text-slate-600 text-sm font-semibold mb-1">Earned This Month</div>
          <div id="earnedMonth" class="text-3xl font-bold text-green-600">$0</div>
        </div>
        <div class="bg-white rounded-xl p-6 shadow-soft border border-slate-100">
          <div class="text-slate-600 text-sm font-semibold mb-1">Payment Pending</div>
          <div id="pendingAmount" class="text-3xl font-bold text-amber-600">$0</div>
        </div>
      </div>

      <div class="bg-white rounded-xl p-6 shadow-soft border border-slate-100">
        <h3 class="text-lg font-bold mb-4">Upcoming Tasks</h3>
        <div id="upcomingTasksList" class="space-y-3">
          <p class="text-slate-500 text-sm">No upcoming tasks</p>
        </div>
      </div>
    </div>

    <!-- Current Tasks Tab -->
    <div id="tasksTab" class="tab-content hidden">
      <div class="bg-white rounded-xl p-6 shadow-soft border border-slate-100">
        <h3 class="text-lg font-bold mb-4">Current Tasks</h3>
        <div id="currentTasksList" class="space-y-4">
          <p class="text-slate-500 text-sm">No current tasks</p>
        </div>
      </div>
    </div>

    <!-- Task History Tab -->
    <div id="historyTab" class="tab-content hidden">
      <div class="bg-white rounded-xl p-6 shadow-soft border border-slate-100">
        <h3 class="text-lg font-bold mb-4">Completed Tasks</h3>
        <div id="historyTasksList" class="space-y-4">
          <p class="text-slate-500 text-sm">No completed tasks</p>
        </div>
      </div>
    </div>

    <!-- Earnings Tab -->
    <div id="earningsTab" class="tab-content hidden">
      <div class="grid md:grid-cols-3 gap-6 mb-6">
        <div class="bg-white rounded-xl p-6 shadow-soft border border-slate-100">
          <div class="text-slate-600 text-sm font-semibold mb-1">Total Earned</div>
          <div id="totalEarned" class="text-3xl font-bold text-green-600">$0</div>
        </div>
        <div class="bg-white rounded-xl p-6 shadow-soft border border-slate-100">
          <div class="text-slate-600 text-sm font-semibold mb-1">Paid Out</div>
          <div id="totalPaid" class="text-3xl font-bold text-indigo-600">$0</div>
        </div>
        <div class="bg-white rounded-xl p-6 shadow-soft border border-slate-100">
          <div class="text-slate-600 text-sm font-semibold mb-1">Awaiting Payment</div>
          <div id="awaitingPayment" class="text-3xl font-bold text-amber-600">$0</div>
        </div>
      </div>

      <div class="bg-white rounded-xl p-6 shadow-soft border border-slate-100">
        <h3 class="text-lg font-bold mb-4">Payment History</h3>
        <div id="paymentHistoryList" class="space-y-3">
          <p class="text-slate-500 text-sm">No payment history</p>
        </div>
      </div>
    </div>

    <!-- Profile Tab -->
    <div id="profileTab" class="tab-content hidden">
      <div class="grid md:grid-cols-2 gap-6">
        <div class="bg-white rounded-xl p-6 shadow-soft border border-slate-100">
          <h3 class="text-lg font-bold mb-4">Profile Information</h3>
          <form id="profileForm" class="space-y-4">
            <div>
              <label class="block text-sm font-semibold mb-1">Full Name</label>
              <input type="text" id="profileName" required class="w-full rounded-lg border border-slate-200 px-3 py-2" />
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">Phone</label>
              <input type="tel" id="profilePhone" class="w-full rounded-lg border border-slate-200 px-3 py-2" />
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">City</label>
              <input type="text" id="profileCity" class="w-full rounded-lg border border-slate-200 px-3 py-2" />
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">ZIP Code</label>
              <input type="text" id="profileZip" class="w-full rounded-lg border border-slate-200 px-3 py-2" />
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">Bio</label>
              <textarea id="profileBio" rows="3" class="w-full rounded-lg border border-slate-200 px-3 py-2"></textarea>
            </div>
            <button type="submit" class="w-full rounded-xl bg-indigo-600 text-white px-4 py-3 font-semibold hover:bg-indigo-700 transition-colors">
              Save Changes
            </button>
            <div id="profileSuccess" class="hidden text-sm text-green-600 text-center">Profile updated successfully!</div>
          </form>
        </div>

        <div class="bg-white rounded-xl p-6 shadow-soft border border-slate-100">
          <h3 class="text-lg font-bold mb-4">Change Password</h3>
          <form id="passwordForm" class="space-y-4">
            <div>
              <label class="block text-sm font-semibold mb-1">New Password</label>
              <input type="password" id="newPassword" required class="w-full rounded-lg border border-slate-200 px-3 py-2" />
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">Confirm Password</label>
              <input type="password" id="confirmPassword" required class="w-full rounded-lg border border-slate-200 px-3 py-2" />
            </div>
            <button type="submit" class="w-full rounded-xl bg-indigo-600 text-white px-4 py-3 font-semibold hover:bg-indigo-700 transition-colors">
              Update Password
            </button>
            <div id="passwordError" class="hidden text-sm text-red-600 text-center"></div>
            <div id="passwordSuccess" class="hidden text-sm text-green-600 text-center">Password updated successfully!</div>
          </form>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  // Supabase config - Load from secure endpoint
  let supabase = null;

  // Initialize Supabase client
  async function initializeSupabase() {
    try {
      // Try to get config from secure endpoint first
      const configResponse = await fetch('/.netlify/functions/get-config');
      if (configResponse.ok) {
        const config = await configResponse.json();
        supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseKey);
        console.log('‚úÖ Supabase initialized from secure config');
        return;
      }
    } catch (error) {
      console.log('‚ö†Ô∏è Secure config not available, using fallback');
    }

    // Fallback to environment detection
    const currentHost = window.location.hostname;
    let SUPABASE_URL, SUPABASE_ANON_KEY;

    if (currentHost.includes('localhost') || currentHost.includes('127.0.0.1')) {
      // Development environment
      SUPABASE_URL = 'https://ynbhskdiplwabsksamxa.supabase.co';
      SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InluYmhza2RpcGx3YWJza3NhbXhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2OTYwMjAsImV4cCI6MjA3NTI3MjAyMH0.PedsTR4JQOioRWD28mVafR4I6wmHApUG5q2-Y7G7ljw';
    } else {
      // Production environment
      SUPABASE_URL = 'https://ynbhskdiplwabsksamxa.supabase.co';
      SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InluYmhza2RpcGx3YWJza3NhbXhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2OTYwMjAsImV4cCI6MjA3NTI3MjAyMH0.PedsTR4JQOioRWD28mVafR4I6wmHApUG5q2-Y7G7ljw';
    }

    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
      throw new Error('Supabase configuration not found');
    }

    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log('‚úÖ Supabase initialized with fallback config');
  }

  let currentHandyman = null;

  // Password visibility toggle
  document.getElementById('togglePassword').addEventListener('click', function() {
    const passwordInput = document.getElementById('loginPassword');
    const eyeIcon = document.getElementById('eyeIcon');
    const eyeSlashIcon = document.getElementById('eyeSlashIcon');

    if (passwordInput.type === 'password') {
      passwordInput.type = 'text';
      eyeIcon.classList.add('hidden');
      eyeSlashIcon.classList.remove('hidden');
    } else {
      passwordInput.type = 'password';
      eyeIcon.classList.remove('hidden');
      eyeSlashIcon.classList.add('hidden');
    }
  });

  // Check authentication
  async function checkAuth() {
    if (!supabase) {
      console.error('‚ùå Supabase not initialized');
      throw new Error('Supabase client not initialized');
    }

    const { data: { user } } = await supabase.auth.getUser();

    if (user) {
      await loadHandymanData(user.id);
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('dashboardPage').classList.remove('hidden');
    } else {
      document.getElementById('loginPage').classList.remove('hidden');
      document.getElementById('dashboardPage').classList.add('hidden');
    }
  }

  // Login
  document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;

    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password
    });

    if (error) {
      document.getElementById('loginError').textContent = error.message;
      document.getElementById('loginError').classList.remove('hidden');
    } else {
      await loadHandymanData(data.user.id);
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('dashboardPage').classList.remove('hidden');
    }
  });

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await supabase.auth.signOut();
    location.reload();
  });

  // Load handyman data
  async function loadHandymanData(userId) {
    const { data, error } = await supabase
      .from('handymen')
      .select('*')
      .eq('auth_user_id', userId)
      .single();

    if (!error && data) {
      currentHandyman = data;
      document.getElementById('handymanName').textContent = data.full_name || 'Handyman';
      await loadDashboard();
    }
  }

  // Load dashboard
  async function loadDashboard() {
    await loadOverview();
    await loadUpcomingTasks();
    await loadCurrentTasks();
    await loadTaskHistory();
    await loadEarnings();
    await loadProfile();
  }

  // Load overview stats
  async function loadOverview() {
    const { data: tasks } = await supabase
      .from('tasks')
      .select('*')
      .eq('handyman_id', currentHandyman.id);

    const activeTasks = tasks?.filter(t => ['pending', 'en_route', 'in_progress'].includes(t.status)).length || 0;

    const startOfMonth = new Date();
    startOfMonth.setDate(1);
    startOfMonth.setHours(0, 0, 0, 0);

    const completedThisMonth = tasks?.filter(t =>
      t.status === 'completed' &&
      new Date(t.completed_at) >= startOfMonth
    ).length || 0;

    const earnedThisMonth = tasks?.filter(t =>
      t.status === 'completed' &&
      new Date(t.completed_at) >= startOfMonth
    ).reduce((sum, t) => sum + parseFloat(t.total_amount || 0), 0) || 0;

    const pendingAmount = tasks?.filter(t =>
      ['pending_review', 'awaiting_client_approval'].includes(t.status)
    ).reduce((sum, t) => sum + parseFloat(t.total_amount || 0), 0) || 0;

    document.getElementById('activeTasksCount').textContent = activeTasks;
    document.getElementById('completedCount').textContent = completedThisMonth;
    document.getElementById('earnedMonth').textContent = '$' + earnedThisMonth.toFixed(0);
    document.getElementById('pendingAmount').textContent = '$' + pendingAmount.toFixed(0);
  }

  // Load upcoming tasks
  async function loadUpcomingTasks() {
    const { data: tasks } = await supabase
      .from('tasks')
      .select('*')
      .eq('handyman_id', currentHandyman.id)
      .eq('status', 'pending')
      .order('scheduled_date', { ascending: true })
      .limit(5);

    const upcomingHtml = tasks?.length > 0 ? tasks.map(task => `
      <div class="border-b border-slate-100 pb-2">
        <div class="font-semibold">${task.task_category}</div>
        <div class="text-xs text-slate-600">${task.scheduled_date || 'TBD'} ‚Ä¢ ${task.customer_name}</div>
      </div>
    `).join('') : '<p class="text-slate-500 text-sm">No upcoming tasks</p>';

    document.getElementById('upcomingTasksList').innerHTML = upcomingHtml;
  }

  // Mark as en route
  async function markEnRoute(taskId) {
    // Get GPS location
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(async (position) => {
        const { error } = await supabase
          .from('tasks')
          .update({
            status: 'en_route',
            en_route_at: new Date().toISOString(),
            gps_lat: position.coords.latitude,
            gps_lng: position.coords.longitude
          })
          .eq('id', taskId);

        if (!error) {
          alert('‚úÖ Marked as en route!');
          location.reload();
        } else {
          alert('Failed to update status. Please try again.');
        }
      }, (error) => {
        console.error('GPS error:', error);
        alert('Unable to get GPS location. Please enable location services.');
      });
    } else {
      alert('Geolocation is not supported by this browser.');
    }
  }

  // Start task
  async function startTask(taskId) {
    const { error } = await supabase
      .from('tasks')
      .update({
        status: 'in_progress',
        task_started_at: new Date().toISOString()
      })
      .eq('id', taskId);

    if (!error) {
      alert('‚úÖ Task started!');
      location.reload();
    } else {
      alert('Failed to start task. Please try again.');
    }
  }

  // Complete task
  async function completeTask(taskId) {
    // Show modal to upload photos and enter actual hours
    const modal = `
      <div id="completionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-md w-full">
          <h3 class="text-xl font-bold mb-4">Complete Task</h3>

          <label class="block mb-2 font-semibold">Actual Hours Worked</label>
          <input type="number" id="actualHours" step="0.5" min="0.5"
                 class="w-full border rounded px-3 py-2 mb-4" required>

          <label class="block mb-2 font-semibold">Upload Completion Photos (Optional)</label>
          <input type="file" id="completionPhotos" accept="image/*" multiple
                 class="w-full border rounded px-3 py-2 mb-4">

          <div class="flex gap-2">
            <button onclick="submitCompletion('${taskId}')"
                    class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
              Submit
            </button>
            <button onclick="closeModal()"
                    class="flex-1 bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500">
              Cancel
            </button>
          </div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modal);
  }

  // Submit completion with approval logic
  async function submitCompletion(taskId) {
    const actualHours = document.getElementById('actualHours').value;
    const photos = document.getElementById('completionPhotos').files;

    if (!actualHours || parseFloat(actualHours) <= 0) {
      alert('Please enter valid hours worked');
      return;
    }

    try {
      // Fetch task with handyman details for approval logic
      const { data: task, error: fetchError } = await supabase
        .from('tasks')
        .select('*, handymen!tasks_handyman_id_fkey(*)')
        .eq('id', taskId)
        .single();

      if (fetchError) {
        throw new Error('Failed to fetch task details');
      }

      // APPROVAL LOGIC - Determines single-side vs two-side approval
      const requiresTwoSideApproval = (task) => {
        const handyman = task.handymen;

        // Two-side approval required if ANY of these conditions are true:
        return (
          task.total_amount > 500 ||                                    // High-value jobs
          (handyman.total_completed_tasks || 0) < 10 ||                 // New handymen
          (handyman.average_rating && handyman.average_rating < 4.0) || // Low-rated handymen
          task.property_type === 'commercial'                           // Commercial properties
        );
      };

      const needsTwoSide = requiresTwoSideApproval(task);
      const newStatus = needsTwoSide ? 'awaiting_client_approval' : 'pending_review';

      // Upload photos to Supabase Storage (if any)
      let photoUrls = [];
      if (photos.length > 0) {
        for (let i = 0; i < photos.length; i++) {
          const fileName = `${taskId}_completion_${Date.now()}_${i}.jpg`;
          const { data, error } = await supabase.storage
            .from('task-photos')
            .upload(fileName, photos[i]);

          if (!error) {
            const { data: { publicUrl } } = supabase.storage
              .from('task-photos')
              .getPublicUrl(fileName);
            photoUrls.push(publicUrl);
          }
        }
      }

      // Update task with appropriate status
      const { error: updateError } = await supabase
        .from('tasks')
        .update({
          status: newStatus,
          actual_hours: parseFloat(actualHours),
          completion_requested_at: new Date().toISOString(),
          completion_photo_urls: photoUrls
        })
        .eq('id', taskId);

      if (updateError) {
        throw new Error('Failed to update task');
      }

      // Show appropriate success message
      if (needsTwoSide) {
        alert('‚úÖ Submitted for client approval!\n\nThe client will review and approve before payment is processed.');
      } else {
        alert('‚úÖ Task complete! Payment will be processed automatically in 24 hours.');
      }

      closeModal();
      location.reload();

    } catch (error) {
      console.error('Completion error:', error);
      alert('‚ùå Error: ' + error.message);
    }
  }

  // Close modal
  function closeModal() {
    const modal = document.getElementById('completionModal');
    if (modal) {
      modal.remove();
    }
  }

  // Load current tasks
  async function loadCurrentTasks() {
    const { data: tasks } = await supabase
      .from('tasks')
      .select('*')
      .eq('handyman_id', currentHandyman.id)
      .in('status', ['pending', 'en_route', 'in_progress'])
      .order('scheduled_date', { ascending: true });

    const tasksHtml = tasks?.length > 0 ? tasks.map(task => {
      // Check if task is within 2 hours of scheduled time
      const isWithin2Hours = () => {
        if (!task.scheduled_date || !task.time_window) return false;
        const scheduledDateTime = new Date(task.scheduled_date + ' ' + task.time_window.split('-')[0]);
        const now = new Date();
        const diffInHours = (scheduledDateTime - now) / (1000 * 60 * 60);
        return diffInHours <= 2 && diffInHours >= 0;
      };

      // Determine button to show based on status
      let actionButton = '';
      if (task.status === 'pending' && isWithin2Hours()) {
        actionButton = `
          <button onclick="markEnRoute('${task.id}')"
                  class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm font-semibold">
            üöó Mark En Route
          </button>`;
      } else if (task.status === 'en_route') {
        actionButton = `
          <button onclick="startTask('${task.id}')"
                  class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm font-semibold">
            ‚ñ∂Ô∏è Start Task
          </button>`;
      } else if (task.status === 'in_progress') {
        actionButton = `
          <button onclick="completeTask('${task.id}')"
                  class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors text-sm font-semibold">
            ‚úÖ Complete Task
          </button>`;
      }

      // Get status display
      const statusConfig = {
        'pending': { class: 'bg-amber-100 text-amber-700', label: 'Pending' },
        'en_route': { class: 'bg-blue-100 text-blue-700', label: 'En Route' },
        'in_progress': { class: 'bg-green-100 text-green-700', label: 'In Progress' }
      };
      const status = statusConfig[task.status] || statusConfig['pending'];

      return `
        <div class="border border-slate-200 rounded-lg p-4">
          <div class="flex items-start justify-between mb-2">
            <div>
              <div class="font-bold text-lg">${task.task_category}</div>
              <div class="text-sm text-slate-600">Task ID: ${task.task_id}</div>
            </div>
            <span class="px-3 py-1 rounded-full text-xs font-semibold ${status.class}">
              ${status.label}
            </span>
          </div>
          <div class="space-y-1 text-sm">
            <div><strong>Customer:</strong> ${task.customer_name}</div>
            <div><strong>Phone:</strong> ${task.customer_phone || 'N/A'}</div>
            <div><strong>Address:</strong> ${task.customer_address || 'N/A'}</div>
            <div><strong>Scheduled:</strong> ${task.scheduled_date || 'TBD'} ${task.time_window || ''}</div>
            <div><strong>Estimated:</strong> ${task.estimated_hours || 0} hours ‚Ä¢ $${task.total_amount || 0}</div>
          </div>
          ${task.task_description ? `<div class="mt-2 text-sm text-slate-600">${task.task_description}</div>` : ''}
          ${actionButton ? `<div class="mt-4">${actionButton}</div>` : ''}
        </div>
      `;
    }).join('') : '<p class="text-slate-500 text-sm">No current tasks</p>';

    document.getElementById('currentTasksList').innerHTML = tasksHtml;
  }

  // Load task history
  async function loadTaskHistory() {
    const { data: tasks } = await supabase
      .from('tasks')
      .select('*')
      .eq('handyman_id', currentHandyman.id)
      .eq('status', 'completed')
      .order('completed_at', { ascending: false })
      .limit(20);

    const historyHtml = tasks?.length > 0 ? tasks.map(task => `
      <div class="border border-slate-200 rounded-lg p-4">
        <div class="flex items-start justify-between mb-2">
          <div>
            <div class="font-bold">${task.task_category}</div>
            <div class="text-sm text-slate-600">Completed: ${new Date(task.completed_at).toLocaleDateString()}</div>
          </div>
          <span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">Completed</span>
        </div>
        <div class="text-sm space-y-1">
          <div><strong>Customer:</strong> ${task.customer_name}</div>
          <div><strong>Hours:</strong> ${task.actual_hours || task.estimated_hours || 0}</div>
          <div><strong>Amount:</strong> $${task.total_amount || 0}</div>
        </div>
      </div>
    `).join('') : '<p class="text-slate-500 text-sm">No completed tasks</p>';

    document.getElementById('historyTasksList').innerHTML = historyHtml;
  }

  // Load earnings
  async function loadEarnings() {
    const { data: payments } = await supabase
      .from('payments')
      .select('*')
      .eq('handyman_id', currentHandyman.id)
      .order('created_at', { ascending: false });

    const totalEarned = payments?.reduce((sum, p) => sum + parseFloat(p.amount), 0) || 0;
    const totalPaid = payments?.filter(p => p.status === 'paid').reduce((sum, p) => sum + parseFloat(p.amount), 0) || 0;
    const awaiting = totalEarned - totalPaid;

    document.getElementById('totalEarned').textContent = '$' + totalEarned.toFixed(0);
    document.getElementById('totalPaid').textContent = '$' + totalPaid.toFixed(0);
    document.getElementById('awaitingPayment').textContent = '$' + awaiting.toFixed(0);

    const paymentsHtml = payments?.length > 0 ? payments.map(payment => `
      <div class="border-b border-slate-100 pb-3 flex items-center justify-between">
        <div>
          <div class="font-semibold">$${parseFloat(payment.amount).toFixed(2)}</div>
          <div class="text-xs text-slate-600">${new Date(payment.created_at).toLocaleDateString()}</div>
        </div>
        <span class="px-3 py-1 rounded-full text-xs font-semibold ${payment.status === 'paid' ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'}">
          ${payment.status === 'paid' ? 'Paid' : 'Pending'}
        </span>
      </div>
    `).join('') : '<p class="text-slate-500 text-sm">No payment history</p>';

    document.getElementById('paymentHistoryList').innerHTML = paymentsHtml;
  }

  // Load profile
  async function loadProfile() {
    if (!currentHandyman) return;

    document.getElementById('profileName').value = currentHandyman.full_name || '';
    document.getElementById('profilePhone').value = currentHandyman.phone || '';
    document.getElementById('profileCity').value = currentHandyman.city || '';
    document.getElementById('profileZip').value = currentHandyman.zip || '';
    document.getElementById('profileBio').value = currentHandyman.bio || '';
  }

  // Update profile
  document.getElementById('profileForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const { error } = await supabase
      .from('handymen')
      .update({
        full_name: document.getElementById('profileName').value,
        phone: document.getElementById('profilePhone').value,
        city: document.getElementById('profileCity').value,
        zip: document.getElementById('profileZip').value,
        bio: document.getElementById('profileBio').value,
        updated_at: new Date().toISOString()
      })
      .eq('id', currentHandyman.id);

    if (!error) {
      document.getElementById('profileSuccess').classList.remove('hidden');
      setTimeout(() => {
        document.getElementById('profileSuccess').classList.add('hidden');
      }, 3000);
      await loadHandymanData((await supabase.auth.getUser()).data.user.id);
    }
  });

  // Change password
  document.getElementById('passwordForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const newPass = document.getElementById('newPassword').value;
    const confirmPass = document.getElementById('confirmPassword').value;

    if (newPass !== confirmPass) {
      document.getElementById('passwordError').textContent = 'Passwords do not match';
      document.getElementById('passwordError').classList.remove('hidden');
      return;
    }

    const { error } = await supabase.auth.updateUser({ password: newPass });

    if (error) {
      document.getElementById('passwordError').textContent = error.message;
      document.getElementById('passwordError').classList.remove('hidden');
    } else {
      document.getElementById('passwordError').classList.add('hidden');
      document.getElementById('passwordSuccess').classList.remove('hidden');
      document.getElementById('passwordForm').reset();
      setTimeout(() => {
        document.getElementById('passwordSuccess').classList.add('hidden');
      }, 3000);
    }
  });

  // Tab navigation
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const tab = btn.dataset.tab;

      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
      btn.classList.add('tab-active');

      document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
      document.getElementById(tab + 'Tab').classList.remove('hidden');
    });
  });

  // Initialize app
  async function initializeApp() {
    try {
      console.log('üîÑ Initializing dashboard...');
      await initializeSupabase();
      console.log('üîÑ Checking authentication...');
      await checkAuth();
      console.log('‚úÖ Dashboard initialized successfully');
    } catch (error) {
      console.error('‚ùå Dashboard initialization failed:', error);
      alert('Failed to initialize dashboard. Please refresh the page.');
    }
  }

  // Start initialization
  initializeApp();
</script>

</body>
</html>