<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard - SendAHandyman</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="images/favicon.png">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .shadow-soft{box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .shadow-md{box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06)}
    .admin-section { display: none; }
    .admin-section.active { display: block; }
    .admin-nav-btn.active { background: #4f46e5; color: white; }
    .status-badge { padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; }
    .status-active { background: #10b981; color: white; }
    .status-pending { background: #f59e0b; color: white; }
    .status-inactive { background: #6b7280; color: white; }
    .status-paid { background: #10b981; color: white; }
    .status-expired { background: #ef4444; color: white; }
  </style>
</head>
<body class="bg-slate-50">

<!-- Admin Login Page -->
<div id="adminLoginPage" class="min-h-screen flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl p-8 shadow-soft border border-slate-100 w-full max-w-md">
    <div class="text-center mb-6">
      <img src="images/helpinghands_logo.png" alt="SendAHandyman" class="h-16 w-auto mx-auto mb-4" />
      <h1 class="text-2xl font-bold mb-2 text-red-600">Admin Portal</h1>
      <p class="text-slate-600">Administrative access required</p>
    </div>

    <form id="adminLoginForm" class="space-y-4">
      <div>
        <label class="block text-sm font-semibold mb-1">Admin Email</label>
        <input type="email" id="adminEmail" required class="w-full rounded-lg border border-slate-200 px-3 py-2" />
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Admin Password</label>
        <input type="password" id="adminPassword" required class="w-full rounded-lg border border-slate-200 px-3 py-2" />
      </div>
      <button type="submit" class="w-full bg-red-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-700 transition-colors">
        Access Admin Portal
      </button>
    </form>
  </div>
</div>

<!-- Admin Dashboard -->
<div id="adminDashboard" class="hidden min-h-screen">
  <!-- Header -->
  <header class="bg-white border-b border-slate-200 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="images/helpinghands_logo.png" alt="SendAHandyman" class="h-10 w-auto" />
          <h1 class="text-xl font-bold text-red-600">Admin Dashboard</h1>
        </div>
        <div class="flex items-center gap-4">
          <span id="adminUserName" class="text-sm font-semibold text-slate-700"></span>
          <button id="adminLogoutBtn" class="text-sm text-slate-600 hover:text-slate-900">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Navigation -->
  <div class="bg-white border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4">
      <nav class="flex gap-8 overflow-x-auto">
        <button id="nav-overview" class="admin-nav-btn active py-4 px-2 border-b-2 border-transparent font-semibold text-sm whitespace-nowrap transition-colors">
          üìä Overview
        </button>
        <button id="nav-handymen" class="admin-nav-btn py-4 px-2 border-b-2 border-transparent font-semibold text-sm whitespace-nowrap transition-colors">
          üë• Handyman Management
        </button>
        <button id="nav-quotes" class="admin-nav-btn py-4 px-2 border-b-2 border-transparent font-semibold text-sm whitespace-nowrap transition-colors">
          üí∞ Quote Management
        </button>
        <button id="nav-tasks" class="admin-nav-btn py-4 px-2 border-b-2 border-transparent font-semibold text-sm whitespace-nowrap transition-colors">
          üìã Task Management
        </button>
        <button id="nav-analytics" class="admin-nav-btn py-4 px-2 border-b-2 border-transparent font-semibold text-sm whitespace-nowrap transition-colors">
          üìà Analytics
        </button>
      </nav>
    </div>
  </div>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 py-6">

    <!-- Overview Section -->
    <section id="section-overview" class="admin-section active">
      <div class="mb-6">
        <h2 class="text-2xl font-bold mb-2">System Overview</h2>
        <p class="text-slate-600">Real-time metrics and quick actions</p>
      </div>

      <!-- Metrics Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-lg p-6 shadow-soft">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-slate-600">Completed Onboarding</p>
              <p id="activeHandymenCount" class="text-2xl font-bold text-green-600">-</p>
            </div>
            <div class="bg-green-100 p-3 rounded-lg">
              <span class="text-green-600 text-xl">üë•</span>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg p-6 shadow-soft">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-slate-600">Active Tasks</p>
              <p id="activeTasksCount" class="text-2xl font-bold text-blue-600">-</p>
            </div>
            <div class="bg-blue-100 p-3 rounded-lg">
              <span class="text-blue-600 text-xl">üîß</span>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg p-6 shadow-soft">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-slate-600">Pending Quotes</p>
              <p id="pendingQuotesCount" class="text-2xl font-bold text-orange-600">-</p>
            </div>
            <div class="bg-orange-100 p-3 rounded-lg">
              <span class="text-orange-600 text-xl">üí∞</span>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg p-6 shadow-soft">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-slate-600">Today's Revenue</p>
              <p id="todayRevenue" class="text-2xl font-bold text-purple-600">$-</p>
            </div>
            <div class="bg-purple-100 p-3 rounded-lg">
              <span class="text-purple-600 text-xl">üí∏</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="bg-white rounded-lg p-6 shadow-soft mb-8">
        <h3 class="text-lg font-bold mb-4">Quick Actions</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <button id="quickCreateQuote" class="bg-green-600 text-white p-4 rounded-lg hover:bg-green-700 transition-colors">
            <div class="text-xl mb-2">üí∞</div>
            <div class="font-semibold">Create Quote</div>
          </button>
          <button id="quickAddHandyman" class="bg-blue-600 text-white p-4 rounded-lg hover:bg-blue-700 transition-colors">
            <div class="text-xl mb-2">üë∑</div>
            <div class="font-semibold">Add Handyman</div>
          </button>
          <button id="quickViewTasks" class="bg-purple-600 text-white p-4 rounded-lg hover:bg-purple-700 transition-colors">
            <div class="text-xl mb-2">üìã</div>
            <div class="font-semibold">Assign Tasks</div>
          </button>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="bg-white rounded-lg p-6 shadow-soft">
        <h3 class="text-lg font-bold mb-4">Recent Activity</h3>
        <div id="recentActivity" class="space-y-3">
          <div class="text-center py-8 text-slate-500">Loading recent activity...</div>
        </div>
      </div>
    </section>

    <!-- Handyman Management Section -->
    <section id="section-handymen" class="admin-section">
      <div class="mb-6 flex justify-between items-center">
        <div>
          <h2 class="text-2xl font-bold mb-2">Handyman Management</h2>
          <p class="text-slate-600">Manage handyman profiles, status, and assignments</p>
        </div>
        <button id="addNewHandyman" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
          ‚ûï Add New Handyman
        </button>
      </div>

      <!-- Handyman Filters -->
      <div class="bg-white rounded-lg p-4 shadow-soft mb-6">
        <div class="flex flex-wrap gap-4">
          <select id="handymanStatusFilter" class="border border-slate-200 rounded-lg px-3 py-2">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="pending">Pending</option>
            <option value="inactive">Inactive</option>
          </select>
          <input type="text" id="handymanSearchInput" placeholder="Search by name or email..." class="border border-slate-200 rounded-lg px-3 py-2 flex-1 min-w-64">
          <button id="refreshHandymen" class="bg-slate-600 text-white px-4 py-2 rounded-lg hover:bg-slate-700 transition-colors">
            üîÑ Refresh
          </button>
        </div>
      </div>

      <!-- Handyman List -->
      <div class="bg-white rounded-lg shadow-soft overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-slate-50 border-b border-slate-200">
              <tr>
                <th class="text-left py-3 px-4 font-semibold text-sm">Name</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Contact</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Status</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Skills</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Joined</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Actions</th>
              </tr>
            </thead>
            <tbody id="handymenTableBody">
              <tr>
                <td colspan="6" class="text-center py-8 text-slate-500">Loading handymen...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Quote Management Section -->
    <section id="section-quotes" class="admin-section">
      <div class="mb-6 flex justify-between items-center">
        <div>
          <h2 class="text-2xl font-bold mb-2">Quote Management</h2>
          <p class="text-slate-600">Create, manage, and track custom quotes</p>
        </div>
        <button id="createNewQuote" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
          üí∞ Create New Quote
        </button>
      </div>

      <!-- Quote Filters -->
      <div class="bg-white rounded-lg p-4 shadow-soft mb-6">
        <div class="flex flex-wrap gap-4">
          <select id="quoteStatusFilter" class="border border-slate-200 rounded-lg px-3 py-2">
            <option value="">All Status</option>
            <option value="pending">Pending</option>
            <option value="paid">Paid</option>
            <option value="expired">Expired</option>
          </select>
          <input type="text" id="quoteSearchInput" placeholder="Search by customer name..." class="border border-slate-200 rounded-lg px-3 py-2 flex-1 min-w-64">
          <button id="refreshQuotes" class="bg-slate-600 text-white px-4 py-2 rounded-lg hover:bg-slate-700 transition-colors">
            üîÑ Refresh
          </button>
        </div>
      </div>

      <!-- Quote List -->
      <div class="bg-white rounded-lg shadow-soft overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-slate-50 border-b border-slate-200">
              <tr>
                <th class="text-left py-3 px-4 font-semibold text-sm">Quote ID</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Customer</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Service</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Amount</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Status</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Created</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Quote Link</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Actions</th>
              </tr>
            </thead>
            <tbody id="quotesTableBody">
              <tr>
                <td colspan="8" class="text-center py-8 text-slate-500">Loading quotes...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Task Management Section -->
    <section id="section-tasks" class="admin-section">
      <div class="mb-6 flex justify-between items-center">
        <div>
          <h2 class="text-2xl font-bold mb-2">Task Management</h2>
          <p class="text-slate-600">View and assign tasks to handymen</p>
        </div>
        <div class="flex gap-2">
          <button id="assignBulkTasks" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
            üìã Bulk Assign
          </button>
        </div>
      </div>

      <!-- Task Filters -->
      <div class="bg-white rounded-lg p-4 shadow-soft mb-6">
        <div class="flex flex-wrap gap-4">
          <select id="taskStatusFilter" class="border border-slate-200 rounded-lg px-3 py-2">
            <option value="">All Status</option>
            <option value="pending">Unassigned</option>
            <option value="assigned">Assigned</option>
            <option value="in_progress">In Progress</option>
            <option value="completed">Completed</option>
          </select>
          <select id="handymanFilter" class="border border-slate-200 rounded-lg px-3 py-2">
            <option value="">All Handymen</option>
            <option value="unassigned">Unassigned Tasks</option>
          </select>
          <input type="text" id="taskSearchInput" placeholder="Search by customer name or task ID..." class="border border-slate-200 rounded-lg px-3 py-2 flex-1 min-w-64">
          <button id="refreshTasks" class="bg-slate-600 text-white px-4 py-2 rounded-lg hover:bg-slate-700 transition-colors">
            üîÑ Refresh
          </button>
        </div>
      </div>

      <!-- Task Assignment Summary -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg p-4 shadow-soft">
          <div class="text-center">
            <div class="text-2xl font-bold text-red-600" id="unassignedTasksCount">-</div>
            <div class="text-sm text-slate-600">Unassigned Tasks</div>
          </div>
        </div>
        <div class="bg-white rounded-lg p-4 shadow-soft">
          <div class="text-center">
            <div class="text-2xl font-bold text-orange-600" id="assignedTasksCount">-</div>
            <div class="text-sm text-slate-600">Assigned Tasks</div>
          </div>
        </div>
        <div class="bg-white rounded-lg p-4 shadow-soft">
          <div class="text-center">
            <div class="text-2xl font-bold text-blue-600" id="inProgressTasksCount">-</div>
            <div class="text-sm text-slate-600">In Progress</div>
          </div>
        </div>
        <div class="bg-white rounded-lg p-4 shadow-soft">
          <div class="text-center">
            <div class="text-2xl font-bold text-green-600" id="completedTasksCount">-</div>
            <div class="text-sm text-slate-600">Completed Today</div>
          </div>
        </div>
      </div>

      <!-- Tasks List -->
      <div class="bg-white rounded-lg shadow-soft overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-slate-50 border-b border-slate-200">
              <tr>
                <th class="text-left py-3 px-4 font-semibold text-sm">
                  <input type="checkbox" id="selectAllTasks" class="rounded">
                </th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Task ID</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Customer</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Service</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Amount</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Assigned To</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Status</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Actions</th>
              </tr>
            </thead>
            <tbody id="tasksTableBody">
              <tr>
                <td colspan="8" class="text-center py-8 text-slate-500">Loading tasks...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Analytics Section -->
    <section id="section-analytics" class="admin-section">
      <div class="mb-6">
        <h2 class="text-2xl font-bold mb-2">Analytics & Reports</h2>
        <p class="text-slate-600">Business insights and performance metrics</p>
      </div>

      <!-- Charts and Analytics -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="bg-white rounded-lg p-6 shadow-soft">
          <h3 class="text-lg font-bold mb-4">Revenue Trend (30 days)</h3>
          <canvas id="revenueChart" width="400" height="200"></canvas>
        </div>

        <div class="bg-white rounded-lg p-6 shadow-soft">
          <h3 class="text-lg font-bold mb-4">Quote Conversion Rate</h3>
          <canvas id="conversionChart" width="400" height="200"></canvas>
        </div>
      </div>

      <!-- Performance Metrics -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white rounded-lg p-6 shadow-soft">
          <h3 class="text-lg font-bold mb-4">Top Performing Handymen</h3>
          <div id="topHandymen" class="space-y-3">
            <div class="text-center py-4 text-slate-500">Loading data...</div>
          </div>
        </div>

        <div class="bg-white rounded-lg p-6 shadow-soft">
          <h3 class="text-lg font-bold mb-4">Popular Services</h3>
          <div id="popularServices" class="space-y-3">
            <div class="text-center py-4 text-slate-500">Loading data...</div>
          </div>
        </div>

        <div class="bg-white rounded-lg p-6 shadow-soft">
          <h3 class="text-lg font-bold mb-4">System Health</h3>
          <div id="systemHealth" class="space-y-3">
            <div class="flex justify-between">
              <span class="text-sm text-slate-600">Database</span>
              <span class="text-sm font-semibold text-green-600">‚úÖ Online</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm text-slate-600">Payment System</span>
              <span class="text-sm font-semibold text-green-600">‚úÖ Online</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm text-slate-600">Notifications</span>
              <span class="text-sm font-semibold text-green-600">‚úÖ Online</span>
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>
</div>

<!-- Modals -->

<!-- Create Quote Modal -->
<div id="createQuoteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-2xl w-full max-h-96 overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold">Create New Quote</h3>
        <button id="closeQuoteModal" class="text-slate-500 hover:text-slate-700">‚úï</button>
      </div>

      <form id="createQuoteForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1">Customer Name *</label>
            <input type="text" id="quoteCustomerName" required class="w-full border border-slate-200 rounded-lg px-3 py-2">
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Customer Phone *</label>
            <input type="tel" id="quoteCustomerPhone" required class="w-full border border-slate-200 rounded-lg px-3 py-2">
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Customer Email</label>
          <input type="email" id="quoteCustomerEmail" class="w-full border border-slate-200 rounded-lg px-3 py-2">
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1">Service Type *</label>
            <select id="quoteServiceType" required class="w-full border border-slate-200 rounded-lg px-3 py-2" onchange="updateServicePricing()">
              <option value="">Select Service</option>
              <option value="tv_mount" data-price="160">üì∫ TV Wall Mount (32‚Äì65") - Starting at $160</option>
              <option value="ceiling_fan" data-price="160">üí° Ceiling Fan Install/Replace - Starting at $160</option>
              <option value="light_fixture" data-price="120">‚ú® Light Fixture / Chandelier Swap - Starting at $120</option>
              <option value="faucet_showerhead" data-price="120">üö∞ Faucet / Showerhead Replace - Starting at $120</option>
              <option value="smart_doorbell" data-price="100">üîî Smart Doorbell Install - Starting at $100</option>
              <option value="curtains_blinds" data-price="120">ü™ü Curtain Rods / Blinds - Starting at $120</option>
              <option value="floating_shelf" data-price="120">üìö Floating Shelf Install - Starting at $120</option>
              <option value="appliance_hookup" data-price="160">‚ö° Appliance Hookup (W/D/DW) - Starting at $160</option>
              <option value="furniture_assembly" data-price="160">ü™ë Furniture Assembly (S‚ÄìM) - Starting at $160</option>
              <option value="closet_organizer" data-price="200">üëï Closet Organizer Install - Starting at $200</option>
              <option value="premium_moveout" data-price="300">üè† Premium Move-Out Removal - Starting at $300</option>
              <option value="general_handyman" data-price="240">üîß General Handyman (3+ hours) - Starting at $240</option>
              <option value="custom" data-price="">üíº Custom Service - Set Custom Price</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Quote Amount ($) *</label>
            <input type="number" id="quoteAmount" step="0.01" required class="w-full border border-slate-200 rounded-lg px-3 py-2" placeholder="Amount will auto-populate">
            <p class="text-xs text-slate-500 mt-1">Base price auto-fills when service is selected. Adjust as needed.</p>
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Service Description</label>
          <textarea id="quoteDescription" rows="3" class="w-full border border-slate-200 rounded-lg px-3 py-2" placeholder="Describe the specific work to be done..."></textarea>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Quote Expiry (days)</label>
          <select id="quoteExpiry" class="w-full border border-slate-200 rounded-lg px-3 py-2">
            <option value="7">7 days</option>
            <option value="14" selected>14 days</option>
            <option value="30">30 days</option>
          </select>
        </div>

        <div class="flex gap-3 pt-4">
          <button type="button" id="cancelQuoteCreation" class="flex-1 border border-slate-200 text-slate-600 py-2 px-4 rounded-lg hover:bg-slate-50">
            Cancel
          </button>
          <button type="submit" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700">
            Create Quote
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Quote Success Modal -->
<div id="quoteSuccessModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-lg w-full">
    <div class="p-6">
      <div class="text-center mb-4">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
          <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
        <h3 class="text-xl font-bold text-green-600 mb-2">Quote Created Successfully!</h3>
        <p class="text-slate-600 mb-4">Your quote has been created and is ready to send to the customer.</p>
      </div>

      <div class="bg-slate-50 rounded-lg p-4 mb-6">
        <label class="block text-sm font-semibold mb-2">Quote Link:</label>
        <div class="flex gap-2">
          <input type="text" id="quoteSuccessLink" readonly class="flex-1 bg-white border border-slate-200 rounded px-3 py-2 text-sm font-mono text-slate-600">
          <button id="copyQuoteSuccessLink" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm font-semibold">
            Copy
          </button>
        </div>
      </div>

      <div class="text-center">
        <button id="closeQuoteSuccessModal" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 font-semibold">
          Got it!
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Assign Task Modal -->
<div id="assignTaskModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-2xl w-full max-h-96 overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 id="assignModalTitle" class="text-xl font-bold">Assign Task to Handyman</h3>
        <button id="closeAssignModal" class="text-slate-500 hover:text-slate-700">‚úï</button>
      </div>

      <form id="assignTaskForm" class="space-y-4">
        <input type="hidden" id="assignTaskId">

        <!-- Task Info Display -->
        <div id="taskInfoDisplay" class="bg-slate-50 rounded-lg p-4 mb-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <div>
              <span class="font-semibold">Task ID:</span>
              <span id="displayTaskId">-</span>
            </div>
            <div>
              <span class="font-semibold">Customer:</span>
              <span id="displayCustomer">-</span>
            </div>
            <div>
              <span class="font-semibold">Service:</span>
              <span id="displayService">-</span>
            </div>
            <div>
              <span class="font-semibold">Amount:</span>
              <span id="displayAmount">-</span>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1">Select Handyman *</label>
            <select id="assignHandymanSelect" required class="w-full border border-slate-200 rounded-lg px-3 py-2">
              <option value="">Choose handyman...</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Priority</label>
            <select id="assignPriority" class="w-full border border-slate-200 rounded-lg px-3 py-2">
              <option value="normal">Normal</option>
              <option value="high">High</option>
              <option value="urgent">Urgent</option>
            </select>
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Scheduled Date</label>
          <input type="date" id="assignScheduledDate" class="w-full border border-slate-200 rounded-lg px-3 py-2">
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Assignment Notes</label>
          <textarea id="assignmentNotes" rows="3" class="w-full border border-slate-200 rounded-lg px-3 py-2" placeholder="Special instructions or notes for the handyman..."></textarea>
        </div>

        <div class="flex gap-3 pt-4">
          <button type="button" id="cancelAssignment" class="flex-1 border border-slate-200 text-slate-600 py-2 px-4 rounded-lg hover:bg-slate-50">
            Cancel
          </button>
          <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">
            Assign Task
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Handyman Modal -->
<div id="editHandymanModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-2xl w-full max-h-96 overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold">Edit Handyman</h3>
        <button id="closeEditHandymanModal" class="text-slate-500 hover:text-slate-700">‚úï</button>
      </div>
      <form id="editHandymanForm" class="space-y-4">
        <input type="hidden" id="editHandymanId">

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="editFullName" class="block text-sm font-medium mb-1">Full Name</label>
            <input type="text" id="editFullName" class="w-full border rounded-lg px-3 py-2" required>
          </div>
          <div>
            <label for="editEmail" class="block text-sm font-medium mb-1">Email</label>
            <input type="email" id="editEmail" class="w-full border rounded-lg px-3 py-2" required>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="editPhone" class="block text-sm font-medium mb-1">Phone</label>
            <input type="tel" id="editPhone" class="w-full border rounded-lg px-3 py-2">
          </div>
          <div>
            <label for="editHourlyRate" class="block text-sm font-medium mb-1">Hourly Rate ($)</label>
            <input type="number" id="editHourlyRate" class="w-full border rounded-lg px-3 py-2" step="0.01" min="0">
          </div>
        </div>

        <div>
          <label for="editSkills" class="block text-sm font-medium mb-1">Skills (comma-separated)</label>
          <input type="text" id="editSkills" class="w-full border rounded-lg px-3 py-2"
                 placeholder="e.g. Plumbing, Electrical, Painting">
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="editOnboardingStatus" class="block text-sm font-medium mb-1">Onboarding Status</label>
            <select id="editOnboardingStatus" class="w-full border rounded-lg px-3 py-2">
              <option value="false">Pending</option>
              <option value="true">Completed</option>
            </select>
          </div>
          <div>
            <label for="editActiveStatus" class="block text-sm font-medium mb-1">Active Status</label>
            <select id="editActiveStatus" class="w-full border rounded-lg px-3 py-2">
              <option value="true">Active</option>
              <option value="false">Inactive</option>
            </select>
          </div>
        </div>

        <div class="flex gap-3 pt-4">
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
            Save Changes
          </button>
          <button type="button" id="cancelEditHandyman" class="bg-slate-300 text-slate-700 px-4 py-2 rounded-lg hover:bg-slate-400 transition-colors">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Photo Modal -->
<div id="photoModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4">
  <div class="max-w-4xl w-full h-full flex flex-col">
    <div class="flex justify-between items-center mb-4">
      <h3 id="photoModalTitle" class="text-xl font-bold text-white">Photo</h3>
      <button onclick="closePhotoModal()" class="text-white hover:text-gray-300 text-2xl">&times;</button>
    </div>
    <div class="flex-1 flex items-center justify-center">
      <img id="photoModalImage" src="" alt="Task Photo" class="max-w-full max-h-full object-contain rounded-lg">
    </div>
  </div>
</div>

<!-- Bulk Assignment Modal -->
<div id="bulkAssignModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-3xl w-full max-h-96 overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold">Bulk Assign Tasks</h3>
        <button id="closeBulkAssignModal" class="text-slate-500 hover:text-slate-700">‚úï</button>
      </div>

      <div class="mb-4">
        <p class="text-sm text-slate-600">
          <span id="selectedTasksCount">0</span> tasks selected for assignment
        </p>
      </div>

      <form id="bulkAssignForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1">Assign to Handyman *</label>
            <select id="bulkHandymanSelect" required class="w-full border border-slate-200 rounded-lg px-3 py-2">
              <option value="">Choose handyman...</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Priority</label>
            <select id="bulkPriority" class="w-full border border-slate-200 rounded-lg px-3 py-2">
              <option value="normal">Normal</option>
              <option value="high">High</option>
              <option value="urgent">Urgent</option>
            </select>
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Assignment Strategy</label>
          <select id="assignmentStrategy" class="w-full border border-slate-200 rounded-lg px-3 py-2">
            <option value="immediate">Assign All Immediately</option>
            <option value="distributed">Distribute Over Multiple Days</option>
            <option value="workload_based">Based on Current Workload</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">General Notes</label>
          <textarea id="bulkAssignmentNotes" rows="2" class="w-full border border-slate-200 rounded-lg px-3 py-2" placeholder="Notes that will be added to all selected tasks..."></textarea>
        </div>

        <div class="flex gap-3 pt-4">
          <button type="button" id="cancelBulkAssignment" class="flex-1 border border-slate-200 text-slate-600 py-2 px-4 rounded-lg hover:bg-slate-50">
            Cancel
          </button>
          <button type="submit" class="flex-1 bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700">
            Assign Selected Tasks
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Handyman Modal -->
<div id="addHandymanModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-xl">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-bold">Add New Handyman</h3>
      <button onclick="closeAddHandymanModal()" class="text-slate-400 hover:text-slate-600">
        <span class="text-xl">√ó</span>
      </button>
    </div>

    <form id="addHandymanForm">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-semibold mb-1">Full Name</label>
          <input type="text" id="handymanFullName" required class="w-full border border-slate-200 rounded-lg px-3 py-2">
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Email</label>
          <input type="email" id="handymanEmail" required class="w-full border border-slate-200 rounded-lg px-3 py-2" placeholder="user@example.com">
          <div class="text-xs text-slate-500 mt-1">Must be a valid email format (e.g., name@domain.com)</div>
        </div>

        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
          <div class="flex items-center gap-2 text-blue-800">
            <span>üîê</span>
            <span class="text-sm font-medium">Secure Password Auto-Generated</span>
          </div>
          <p class="text-xs text-blue-600 mt-1">A secure temporary password will be automatically created and shown after account creation.</p>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Phone</label>
          <input type="tel" id="handymanPhone" class="w-full border border-slate-200 rounded-lg px-3 py-2">
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">City</label>
          <input type="text" id="handymanCity" class="w-full border border-slate-200 rounded-lg px-3 py-2">
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Skills (comma separated)</label>
          <input type="text" id="handymanSkills" placeholder="plumbing, electrical, carpentry" class="w-full border border-slate-200 rounded-lg px-3 py-2">
        </div>

        <div class="flex gap-3 pt-4">
          <button type="button" onclick="closeAddHandymanModal()" class="flex-1 border border-slate-200 text-slate-600 py-2 px-4 rounded-lg hover:bg-slate-50">
            Cancel
          </button>
          <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">
            Add Handyman
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Task Details Modal -->
<div id="taskDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-4xl w-full max-h-96 overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold">Task Details</h3>
        <button onclick="closeTaskDetailsModal()" class="text-slate-500 hover:text-slate-700">‚úï</button>
      </div>

      <div id="taskDetailContent" class="space-y-4">
        <!-- Task details will be populated here -->
        <div class="text-center py-8 text-slate-500">Loading task details...</div>
      </div>
    </div>
  </div>
</div>

<script>
// Initialize Supabase
const supabaseUrl = 'https://ynbhskdiplwabsksamxa.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InluYmhza2RpcGx3YWJza3NhbXhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2OTYwMjAsImV4cCI6MjA3NTI3MjAyMH0.PedsTR4JQOioRWD28mVafR4I6wmHApUG5q2-Y7G7ljw';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

let currentAdminUser = null;
let handymenData = [];
let quotesData = [];

// Admin authentication check
document.addEventListener('DOMContentLoaded', async () => {
  console.log('üîê Admin portal initialized');

  // Check if user is already authenticated and has admin access
  await checkExistingAuth();
});

// Admin login
document.getElementById('adminLoginForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const email = document.getElementById('adminEmail').value.toLowerCase();
  const password = document.getElementById('adminPassword').value;

  try {
    console.log('üîê Attempting admin login for:', email);

    // First authenticate with Supabase
    const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
      email: email,
      password: password
    });

    if (authError) {
      console.error('‚ùå Authentication failed:', authError);
      alert('Invalid credentials. Please check your email and password.');
      return;
    }

    // Now check if user exists in admin_users table using the auth UUID
    const authUserId = authData.user.id;

    let { data: adminUser, error } = await supabase
      .from('admin_users')
      .select('id, email, full_name, role, is_active')
      .eq('id', authUserId)  // Match by UUID instead of email
      .eq('is_active', true)
      .single();

    // If admin record doesn't exist but auth succeeded, check by email as fallback
    if (error && error.code === 'PGRST116') {
      const { data: adminByEmail, error: emailError } = await supabase
        .from('admin_users')
        .select('id, email, full_name, role, is_active')
        .eq('email', email)
        .eq('is_active', true)
        .single();

      if (!emailError && adminByEmail) {
        // Update the admin record to use the correct auth UUID
        const { data: updatedAdmin, error: updateError } = await supabase
          .from('admin_users')
          .update({ id: authUserId })
          .eq('email', email)
          .select()
          .single();

        if (!updateError) {
          adminUser = updatedAdmin;
          console.log('‚úÖ Admin record updated with auth UUID');
        }
      }
    }

    if (error || !adminUser) {
      console.error('‚ùå Admin user not found or inactive:', error);
      alert('Access denied: You are not authorized to access the admin portal.');
      return;
    }

    // Successful authentication
    currentAdminUser = {
      id: adminUser.id,
      email: adminUser.email,
      name: adminUser.full_name,
      role: adminUser.role
    };

    console.log('‚úÖ Admin login successful:', adminUser.role);

    // Update last login time
    await supabase
      .from('admin_users')
      .update({ last_login_at: new Date().toISOString() })
      .eq('id', adminUser.id);

    // Show dashboard
    document.getElementById('adminLoginPage').classList.add('hidden');
    document.getElementById('adminDashboard').classList.remove('hidden');
    document.getElementById('adminUserName').textContent = `${currentAdminUser.name} (${currentAdminUser.role})`;

    // Load dashboard data
    loadDashboardData();

  } catch (error) {
    console.error('‚ùå Login error:', error);
    alert('Login failed: ' + error.message);
  }
});

// Check if user is already authenticated
async function checkExistingAuth() {
  try {
    console.log('üîç Checking existing authentication...');

    const { data: { user } } = await supabase.auth.getUser();

    if (user) {
      console.log('‚úÖ User already authenticated:', user.email);

      // Check if user has admin access
      const { data: adminUser, error } = await supabase
        .from('admin_users')
        .select('id, email, full_name, role, is_active')
        .eq('id', user.id)
        .eq('is_active', true)
        .single();

      if (!error && adminUser) {
        console.log('‚úÖ Admin access confirmed:', adminUser.role);
        await setupAdminUser(adminUser);
        return;
      }

      // Fallback: check by email for existing records
      console.log('üîÑ Trying email-based lookup as fallback...');
      const { data: adminUserByEmail, error: emailError } = await supabase
        .from('admin_users')
        .select('id, email, full_name, role, is_active')
        .eq('email', user.email.toLowerCase())
        .eq('is_active', true)
        .single();

      if (!emailError && adminUserByEmail) {
        console.log('‚úÖ Admin access confirmed by email:', adminUserByEmail.role);
        await setupAdminUser(adminUserByEmail);
        return;
      }

      console.log('‚ùå User authenticated but no admin access');
      showAccessDeniedMessage();
      return;
    }

    console.log('‚ÑπÔ∏è No existing authentication found');
    // Show login form
    document.getElementById('adminLoginPage').classList.remove('hidden');

  } catch (error) {
    console.error('‚ùå Error checking existing auth:', error);
    document.getElementById('adminLoginPage').classList.remove('hidden');
  }
}

// Helper function to setup admin user and show dashboard
async function setupAdminUser(adminUser) {
  // Set current admin user
  currentAdminUser = {
    id: adminUser.id,
    email: adminUser.email,
    name: adminUser.full_name,
    role: adminUser.role
  };

  // Update last login time
  await supabase
    .from('admin_users')
    .update({ last_login_at: new Date().toISOString() })
    .eq('id', adminUser.id);

  // Show dashboard directly
  document.getElementById('adminLoginPage').classList.add('hidden');
  document.getElementById('adminDashboard').classList.remove('hidden');
  document.getElementById('adminUserName').textContent = `${currentAdminUser.name} (${currentAdminUser.role})`;

  // Load dashboard data
  loadDashboardData();
}

// Show access denied message instead of login form
function showAccessDeniedMessage() {
  const loginPage = document.getElementById('adminLoginPage');
  loginPage.innerHTML = `
    <div class="bg-white rounded-2xl p-8 shadow-soft border border-slate-100 w-full max-w-md">
      <div class="text-center mb-6">
        <img src="images/helpinghands_logo.png" alt="SendAHandyman" class="h-16 w-auto mx-auto mb-4" />
        <h1 class="text-2xl font-bold mb-2 text-red-600">Access Denied</h1>
        <p class="text-slate-600">You don't have admin permissions</p>
      </div>
      <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
        <p class="text-sm text-red-700">
          Your account doesn't have administrative privileges. Contact your system administrator to request access.
        </p>
      </div>
      <button onclick="window.close()" class="w-full bg-slate-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-slate-700 transition-colors">
        Close Window
      </button>
    </div>
  `;
  loginPage.classList.remove('hidden');
}

// Admin logout
document.getElementById('adminLogoutBtn').addEventListener('click', async () => {
  try {
    // Don't sign out from Supabase completely - just close admin portal
    // This preserves the handyman dashboard session

    currentAdminUser = null;

    // Close the admin window if opened from dashboard
    if (window.opener) {
      window.close();
    } else {
      // If accessed directly, show login page
      document.getElementById('adminDashboard').classList.add('hidden');
      document.getElementById('adminLoginPage').classList.remove('hidden');
      document.getElementById('adminEmail').value = '';
      document.getElementById('adminPassword').value = '';
    }

    console.log('üîê Admin portal closed');
  } catch (error) {
    console.error('‚ùå Logout error:', error);
  }
});

// Navigation
document.querySelectorAll('.admin-nav-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    const sectionId = e.target.id.replace('nav-', 'section-');

    // Update nav buttons
    document.querySelectorAll('.admin-nav-btn').forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');

    // Update sections
    document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
    document.getElementById(sectionId).classList.add('active');

    // Load section-specific data
    loadSectionData(sectionId);
  });
});

// Load dashboard data
async function loadDashboardData() {
  console.log('üìä Loading dashboard data...');

  try {
    // Load metrics
    await loadMetrics();
    await loadRecentActivity();

    // Load initial section data
    loadSectionData('section-overview');

  } catch (error) {
    console.error('Error loading dashboard data:', error);
  }
}

// Load metrics
async function loadMetrics() {
  try {
    // Count active handymen based on onboarding and skills
    const { data: handymen, error: handymenError } = await supabase
      .from('handymen')
      .select('id, onboarding_completed, skills');

    if (!handymenError) {
      const completedHandymen = handymen?.filter(h => h.onboarding_completed) || [];
      document.getElementById('activeHandymenCount').textContent = completedHandymen.length;
    }

    // Count active tasks
    const { data: tasks, error: tasksError } = await supabase
      .from('tasks')
      .select('id, status')
      .in('status', ['pending', 'in_progress']);

    if (!tasksError) {
      document.getElementById('activeTasksCount').textContent = tasks?.length || 0;
    }

    // Count pending quotes from quotes table
    const { data: quotes, error: quotesError } = await supabase
      .from('quotes')
      .select('id, status')
      .eq('status', 'pending');

    if (!quotesError) {
      document.getElementById('pendingQuotesCount').textContent = quotes?.length || 0;
    } else {
      console.warn('Quotes table may not exist:', quotesError);
      document.getElementById('pendingQuotesCount').textContent = '0';
    }

    // Calculate today's revenue from completed tasks
    const today = new Date();
    const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const todayEnd = new Date(todayStart);
    todayEnd.setDate(todayEnd.getDate() + 1);

    const { data: completedTasks, error: revenueError } = await supabase
      .from('tasks')
      .select('total_amount')
      .eq('status', 'completed')
      .gte('updated_at', todayStart.toISOString())
      .lt('updated_at', todayEnd.toISOString());

    if (!revenueError && completedTasks) {
      const todayRevenue = completedTasks.reduce((sum, task) => sum + (task.total_amount || 0), 0);
      document.getElementById('todayRevenue').textContent = `$${todayRevenue.toFixed(2)}`;
    } else {
      document.getElementById('todayRevenue').textContent = '$0.00';
    }

  } catch (error) {
    console.error('Error loading metrics:', error);
  }
}

// Load recent activity
async function loadRecentActivity() {
  const activityContainer = document.getElementById('recentActivity');

  try {
    const activities = [];

    // Get recent completed tasks (with error handling)
    let recentTasks = [];
    try {
      const { data: tasks, error: tasksError } = await supabase
        .from('tasks')
        .select('id, task_category, status, total_amount, updated_at, handyman_id')
        .eq('status', 'completed')
        .order('updated_at', { ascending: false })
        .limit(3);

      if (!tasksError && tasks) {
        // Get handyman names for the tasks that have assignments
        const handymanIds = [...new Set(tasks.filter(t => t.handyman_id).map(t => t.handyman_id))];
        let handymenMap = {};

        if (handymanIds.length > 0) {
          const { data: handymen } = await supabase
            .from('handymen')
            .select('id, full_name')
            .in('id', handymanIds);

          if (handymen) {
            handymenMap = Object.fromEntries(handymen.map(h => [h.id, h.full_name]));
          }
        }

        // Add handyman names to tasks
        recentTasks = tasks.map(task => ({
          ...task,
          handyman_name: task.handyman_id ? handymenMap[task.handyman_id] : null
        }));
      } else {
        console.warn('Tasks query failed, trying fallback:', tasksError);
        // Fallback: get tasks with minimal columns (no service_type)
        const { data: simpleTasks, error: simpleError } = await supabase
          .from('tasks')
          .select('id, status, total_amount, updated_at')
          .eq('status', 'completed')
          .order('updated_at', { ascending: false })
          .limit(3);

        if (!simpleError && simpleTasks) {
          recentTasks = simpleTasks.map(task => ({
            ...task,
            task_category: 'Task', // Default task category
            handyman_name: 'Unknown'
          }));
        }
      }
    } catch (err) {
      console.error('Error in tasks query:', err);
      recentTasks = [];
    }

    if (recentTasks && recentTasks.length > 0) {
      recentTasks.forEach(task => {
        const handymanName = task.handyman_name || 'Unknown';
        activities.push({
          type: 'task_completed',
          message: `${task.task_category || 'Task'} completed by ${handymanName} - $${task.total_amount || 0}`,
          time: formatTimeAgo(task.updated_at),
          timestamp: task.updated_at
        });
      });
    }

    // Get recent quotes
    const { data: recentQuotes, error: quotesError } = await supabase
      .from('quotes')
      .select('quote_id, service_type, custom_amount, created_at')
      .order('created_at', { ascending: false })
      .limit(2);

    if (!quotesError && recentQuotes) {
      recentQuotes.forEach(quote => {
        activities.push({
          type: 'quote_created',
          message: `New quote created for ${quote.service_type} - $${quote.custom_amount}`,
          time: formatTimeAgo(quote.created_at),
          timestamp: quote.created_at
        });
      });
    }

    // Get recent handymen who joined
    const { data: recentHandymen, error: handymenError } = await supabase
      .from('handymen')
      .select('full_name, created_at')
      .order('created_at', { ascending: false })
      .limit(2);

    if (!handymenError && recentHandymen) {
      recentHandymen.forEach(handyman => {
        activities.push({
          type: 'handyman_joined',
          message: `${handyman.full_name} joined as handyman`,
          time: formatTimeAgo(handyman.created_at),
          timestamp: handyman.created_at
        });
      });
    }

    // Sort all activities by time (newest first) and limit to 5
    activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    const displayActivities = activities.slice(0, 5);

    // If no real activities, show a placeholder
    if (displayActivities.length === 0) {
      activityContainer.innerHTML = `
        <div class="flex items-center justify-center p-8 text-gray-500">
          <div class="text-center">
            <p class="text-sm">No recent activity</p>
            <p class="text-xs mt-1">Activity will appear here as tasks are completed</p>
          </div>
        </div>
      `;
      return;
    }

    activityContainer.innerHTML = displayActivities.map(activity => `
      <div class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg">
        <div class="text-lg">
          ${activity.type === 'task_completed' ? '‚úÖ' :
            activity.type === 'quote_created' ? 'üí∞' :
            activity.type === 'handyman_joined' ? 'üë∑' : 'üí≥'}
        </div>
        <div class="flex-1">
          <p class="text-sm font-medium">${activity.message}</p>
          <p class="text-xs text-slate-500">${activity.time}</p>
        </div>
      </div>
    `).join('');

  } catch (error) {
    console.error('Error loading recent activity:', error);
    activityContainer.innerHTML = `
      <div class="flex items-center justify-center p-8 text-red-500">
        <p class="text-sm">Error loading activity data</p>
      </div>
    `;
  }
}

// Helper function to format time ago
function formatTimeAgo(timestamp) {
  const now = new Date();
  const time = new Date(timestamp);
  const diffMs = now - time;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins} minute${diffMins === 1 ? '' : 's'} ago`;
  if (diffHours < 24) return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
  if (diffDays < 7) return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
  return time.toLocaleDateString();
}

// Load section-specific data
function loadSectionData(sectionId) {
  switch (sectionId) {
    case 'section-handymen':
      loadHandymenData();
      break;
    case 'section-quotes':
      loadQuotesData();
      break;
    case 'section-tasks':
      loadTasksData();
      break;
    case 'section-analytics':
      loadAnalyticsData();
      break;
  }
}

// Load handymen data
async function loadHandymenData() {
  console.log('üë• Loading handymen data...');

  try {
    console.log('üîç Running handymen query...');

    // First, try to get a count to see if RLS is blocking
    const { count, error: countError } = await supabase
      .from('handymen')
      .select('*', { count: 'exact', head: true });

    console.log('üìä Total handymen count (with RLS):', count);
    if (countError) console.error('Count error:', countError);

    const { data: handymen, error } = await supabase
      .from('handymen')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) {
      console.error('‚ùå Handymen query error:', error);
      throw error;
    }

    handymenData = handymen || [];
    console.log('üìä Loaded handymen:', handymenData.length, 'records');

    // Log status breakdown
    const completedCount = handymenData.filter(h => h.onboarding_completed).length;
    const pendingCount = handymenData.filter(h => !h.onboarding_completed).length;
    console.log(`üìä Onboarding status: ${completedCount} completed, ${pendingCount} pending`);

    handymenData.forEach(h => {
      const hasSkills = h.skills &&
        ((Array.isArray(h.skills) && h.skills.length > 0) ||
         (typeof h.skills === 'string' && h.skills.trim().length > 0));
      console.log(`üë§ ${h.full_name}: onboarding=${h.onboarding_completed ? 'COMPLETED' : 'PENDING'}, skills=${hasSkills ? 'SET' : 'NEEDS SKILLS'} (${Array.isArray(h.skills) ? h.skills.length + ' items' : typeof h.skills})`);
    });

    renderHandymenTable();

  } catch (error) {
    console.error('Error loading handymen:', error);
    document.getElementById('handymenTableBody').innerHTML = `
      <tr><td colspan="6" class="text-center py-8 text-red-500">Error loading handymen data</td></tr>
    `;
  }
}

// Render handymen table
function renderHandymenTable() {
  const tbody = document.getElementById('handymenTableBody');

  if (handymenData.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-500">No handymen found</td></tr>';
    return;
  }

  tbody.innerHTML = handymenData.map(handyman => `
    <tr class="border-b border-slate-200 hover:bg-slate-50">
      <td class="py-3 px-4">
        <div class="font-semibold">${handyman.full_name || 'N/A'}</div>
        <div class="text-sm text-slate-500">${handyman.email || 'N/A'}</div>
      </td>
      <td class="py-3 px-4">
        <div class="text-sm">${handyman.phone || 'N/A'}</div>
        <div class="text-xs text-slate-500">${handyman.city || 'N/A'}</div>
      </td>
      <td class="py-3 px-4">
        ${getHandymanStatusBadge(handyman)}
      </td>
      <td class="py-3 px-4">
        <div class="text-sm">${formatSkills(handyman.skills)}</div>
        <div class="text-xs text-slate-500">${handyman.specialties || ''}</div>
      </td>
      <td class="py-3 px-4">
        <div class="text-sm">${handyman.created_at ? new Date(handyman.created_at).toLocaleDateString() : 'N/A'}</div>
      </td>
      <td class="py-3 px-4">
        <div class="flex gap-2">
          <button class="edit-handyman-btn text-blue-600 hover:text-blue-800 text-sm" data-handyman-id="${handyman.id}">Edit</button>
          <button onclick="toggleHandymanStatus('${handyman.id}')" class="text-orange-600 hover:text-orange-800 text-sm">
            ${handyman.is_active ? 'Suspend' : 'Activate'}
          </button>
        </div>
      </td>
    </tr>
  `).join('');
}

// Load quotes data
async function loadQuotesData() {
  console.log('üí∞ Loading quotes data...');

  try {
    // Load actual quotes from database
    const { data: quotes, error: quotesError } = await supabase
      .from('quotes')
      .select('*')
      .order('created_at', { ascending: false });

    if (quotesError) {
      console.error('‚ùå Error loading quotes:', quotesError);
      // Fallback to empty array instead of mock data
      quotesData = [];
    } else {
      console.log(`üìä Loaded ${quotes.length} quotes from database`);
      quotesData = quotes || [];
    }

    renderQuotesTable();

  } catch (error) {
    console.error('‚ùå Failed to load quotes:', error);
    quotesData = [];
    renderQuotesTable();
  }
}

// Render quotes table
function renderQuotesTable() {
  const tbody = document.getElementById('quotesTableBody');

  if (quotesData.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-slate-500">No quotes found</td></tr>';
    return;
  }

  tbody.innerHTML = quotesData.map(quote => `
    <tr class="border-b border-slate-200 hover:bg-slate-50">
      <td class="py-3 px-4">
        <div class="font-mono text-sm">${quote.quote_id || quote.id}</div>
      </td>
      <td class="py-3 px-4">
        <div class="font-semibold">${quote.customer_name}</div>
        <div class="text-sm text-slate-500">${quote.customer_phone}</div>
      </td>
      <td class="py-3 px-4">${quote.service_type}</td>
      <td class="py-3 px-4 font-semibold">$${quote.custom_amount || quote.amount}</td>
      <td class="py-3 px-4">
        <span class="status-badge status-${quote.status}">
          ${quote.status.toUpperCase()}
        </span>
      </td>
      <td class="py-3 px-4">
        <div class="text-sm">${new Date(quote.created_at).toLocaleDateString()}</div>
      </td>
      <td class="py-3 px-4">
        <div class="flex items-center gap-2">
          <input type="text" value="${window.location.origin}/quote.html?token=${quote.quote_token}" readonly class="flex-1 text-xs font-mono bg-slate-50 border border-slate-200 rounded px-2 py-1 max-w-48">
          <button onclick="copyQuoteLink('${quote.quote_token}')" class="text-blue-600 hover:text-blue-800 text-xs px-2 py-1 border border-blue-200 rounded hover:bg-blue-50" title="Copy link">
            üìã
          </button>
        </div>
      </td>
      <td class="py-3 px-4">
        <div class="flex gap-2">
          <button onclick="resendQuote('${quote.id}')" class="text-green-600 hover:text-green-800 text-sm">Resend</button>
        </div>
      </td>
    </tr>
  `).join('');
}

// Global chart instances for cleanup
let revenueChart = null;
let conversionChart = null;

// Load analytics data
async function loadAnalyticsData() {
  console.log('üìà Loading analytics data...');

  try {
    // Destroy existing charts before creating new ones
    if (revenueChart) {
      revenueChart.destroy();
      revenueChart = null;
    }
    if (conversionChart) {
      conversionChart.destroy();
      conversionChart = null;
    }
    // Get real revenue data from completed tasks
    const { data: completedTasks, error } = await supabase
      .from('tasks')
      .select('total_amount, completed_at, created_at')
      .eq('status', 'completed')
      .not('total_amount', 'is', null)
      .order('completed_at', { ascending: false });

    if (error) {
      console.error('Error loading analytics data:', error);
      // Create charts with empty data if real data fails
      createChartsWithData([]);
      return;
    }

    // Process real data for charts
    createChartsWithData(completedTasks || []);

  } catch (error) {
    console.error('Error in loadAnalyticsData:', error);
    // Create charts with empty data
    createChartsWithData([]);
  }
}

// Create charts with provided data
function createChartsWithData(completedTasks) {
  // Process revenue data by week
  const weeks = [];
  const revenueData = [];

  if (completedTasks.length > 0) {
    // Group by week and calculate revenue
    const weeklyRevenue = {};
    const now = new Date();

    for (let i = 3; i >= 0; i--) {
      const weekStart = new Date(now);
      weekStart.setDate(now.getDate() - (i + 1) * 7);
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekStart.getDate() + 7);

      const weekLabel = `Week ${4 - i}`;
      weeks.push(weekLabel);

      const weekRevenue = completedTasks
        .filter(task => {
          const completedDate = new Date(task.completed_at);
          return completedDate >= weekStart && completedDate < weekEnd;
        })
        .reduce((sum, task) => sum + (parseFloat(task.total_amount) || 0), 0);

      revenueData.push(weekRevenue);
    }
  } else {
    // No data available - show empty chart
    weeks.push('Week 1', 'Week 2', 'Week 3', 'Week 4');
    revenueData.push(0, 0, 0, 0);
  }

  // Revenue chart
  const revenueCtx = document.getElementById('revenueChart').getContext('2d');
  revenueChart = new Chart(revenueCtx, {
    type: 'line',
    data: {
      labels: weeks,
      datasets: [{
        label: 'Revenue ($)',
        data: revenueData,
        borderColor: '#10b981',
        backgroundColor: 'rgba(16, 185, 129, 0.1)',
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: false
        }
      }
    }
  });

  // Conversion chart
  const conversionCtx = document.getElementById('conversionChart').getContext('2d');
  conversionChart = new Chart(conversionCtx, {
    type: 'doughnut',
    data: {
      labels: ['Converted', 'Pending', 'Expired'],
      datasets: [{
        data: [65, 25, 10],
        backgroundColor: ['#10b981', '#f59e0b', '#ef4444']
      }]
    },
    options: {
      responsive: true
    }
  });
}

// Quote management functions
document.getElementById('createNewQuote').addEventListener('click', () => {
  document.getElementById('createQuoteModal').classList.remove('hidden');
});

document.getElementById('quickCreateQuote').addEventListener('click', () => {
  document.getElementById('createQuoteModal').classList.remove('hidden');
});

document.getElementById('closeQuoteModal').addEventListener('click', () => {
  document.getElementById('createQuoteModal').classList.add('hidden');
});

document.getElementById('cancelQuoteCreation').addEventListener('click', () => {
  document.getElementById('createQuoteModal').classList.add('hidden');
});

// Quote success modal event listeners
document.getElementById('closeQuoteSuccessModal').addEventListener('click', () => {
  document.getElementById('quoteSuccessModal').classList.add('hidden');
});

document.getElementById('copyQuoteSuccessLink').addEventListener('click', () => {
  copyQuoteSuccessLink();
});

// Create quote form
document.getElementById('createQuoteForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const quoteData = {
    customer_name: document.getElementById('quoteCustomerName').value,
    customer_phone: document.getElementById('quoteCustomerPhone').value,
    customer_email: document.getElementById('quoteCustomerEmail').value,
    service_type: document.getElementById('quoteServiceType').value,
    amount: parseFloat(document.getElementById('quoteAmount').value),
    description: document.getElementById('quoteDescription').value,
    expiry_days: parseInt(document.getElementById('quoteExpiry').value)
  };

  try {
    // Call the create quote function
    const response = await fetch('/.netlify/functions/admin-create-quote', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(quoteData)
    });

    if (response.ok) {
      const result = await response.json();
      const quoteLink = `${window.location.origin}/quote.html?token=${result.quote_token}`;

      // Show success modal with copy functionality
      showQuoteSuccessModal(quoteLink, result);

      // Reset form and close create modal
      document.getElementById('createQuoteForm').reset();
      document.getElementById('createQuoteModal').classList.add('hidden');

      // Reload quotes data
      loadQuotesData();
    } else {
      throw new Error('Failed to create quote');
    }

  } catch (error) {
    console.error('Error creating quote:', error);
    alert('Failed to create quote: ' + error.message);
  }
});

// Initialize charts with fallback data (only used if analytics data fails)
function initializeCharts() {
  // Only initialize if charts don't already exist
  if (revenueChart || conversionChart) {
    console.log('Charts already initialized, skipping...');
    return;
  }

  // Revenue chart with fallback data
  const revenueCtx = document.getElementById('revenueChart').getContext('2d');
  revenueChart = new Chart(revenueCtx, {
    type: 'line',
    data: {
      labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
      datasets: [{
        label: 'Revenue ($)',
        data: [0, 0, 0, 0], // Show zeros instead of fake data
        borderColor: '#10b981',
        backgroundColor: 'rgba(16, 185, 129, 0.1)',
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return '$' + value;
            }
          }
        }
      }
    }
  });
}

// Get handyman status badge based on ONBOARDING completion only
function getHandymanStatusBadge(handyman) {
  let statusClass, statusText;

  if (handyman.onboarding_completed) {
    statusClass = 'bg-green-100 text-green-800';
    statusText = 'COMPLETED';
  } else {
    statusClass = 'bg-red-100 text-red-800';
    statusText = 'PENDING';
  }

  return `<span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">${statusText}</span>`;
}

// Format skills for display
function formatSkills(skills) {
  if (!skills) return '<span class="text-red-600 font-medium">NEEDS SKILLS</span>';

  if (Array.isArray(skills)) {
    if (skills.length === 0) return '<span class="text-red-600 font-medium">NEEDS SKILLS</span>';
    return skills.join(', ').replace(/-/g, ' ');
  }

  if (typeof skills === 'string') {
    const trimmed = skills.trim();
    return trimmed || '<span class="text-red-600 font-medium">NEEDS SKILLS</span>';
  }

  return '<span class="text-red-600 font-medium">NEEDS SKILLS</span>';
}

// Helper functions
function updateServicePricing() {
  const serviceSelect = document.getElementById('quoteServiceType');
  const amountInput = document.getElementById('quoteAmount');
  const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];

  if (selectedOption && selectedOption.dataset.price) {
    amountInput.value = selectedOption.dataset.price;
  } else {
    amountInput.value = '';
  }
}

function showNotification(message, type = 'info') {
  // Create notification element
  const notification = document.createElement('div');
  notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-semibold ${
    type === 'success' ? 'bg-green-600' :
    type === 'error' ? 'bg-red-600' :
    'bg-blue-600'
  } transform translate-x-full opacity-0 transition-all duration-300`;
  notification.textContent = message;

  document.body.appendChild(notification);

  // Show notification
  setTimeout(() => {
    notification.classList.remove('translate-x-full', 'opacity-0');
  }, 100);

  // Hide notification after 3 seconds
  setTimeout(() => {
    notification.classList.add('translate-x-full', 'opacity-0');
    setTimeout(() => {
      document.body.removeChild(notification);
    }, 300);
  }, 3000);
}

function showQuoteSuccessModal(quoteLink, quoteData) {
  const modal = document.getElementById('quoteSuccessModal');
  const linkInput = document.getElementById('quoteSuccessLink');

  linkInput.value = quoteLink;
  modal.classList.remove('hidden');
}

function copyQuoteSuccessLink() {
  const linkInput = document.getElementById('quoteSuccessLink');
  linkInput.select();
  navigator.clipboard.writeText(linkInput.value).then(() => {
    showNotification('Quote link copied to clipboard!', 'success');
  }).catch(() => {
    // Fallback for older browsers
    document.execCommand('copy');
    showNotification('Quote link copied to clipboard!', 'success');
  });
}

function copyQuoteLink(quoteToken) {
  const link = `${window.location.origin}/quote.html?token=${quoteToken}`;
  navigator.clipboard.writeText(link).then(() => {
    showNotification('Quote link copied to clipboard!', 'success');
  }).catch(() => {
    // Fallback for older browsers
    const textArea = document.createElement('textarea');
    textArea.value = link;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    showNotification('Quote link copied to clipboard!', 'success');
  });
}

function resendQuote(quoteId) {
  alert('Resend functionality would be implemented here');
}

async function editHandyman(handymanId) {
  try {
    console.log(`üîß EDIT HANDYMAN FUNCTION CALLED for handyman: ${handymanId}`);
    console.log('üîß Function triggered successfully');

    // Load handyman data
    const { data: handyman, error } = await supabase
      .from('handymen')
      .select('*')
      .eq('id', handymanId)
      .single();

    if (error) throw error;
    if (!handyman) {
      alert('Handyman not found');
      return;
    }

    console.log('üìã Handyman data loaded:', handyman);

    // Check if form elements exist
    const formElements = {
      editHandymanId: document.getElementById('editHandymanId'),
      editFullName: document.getElementById('editFullName'),
      editEmail: document.getElementById('editEmail'),
      editPhone: document.getElementById('editPhone'),
      editHourlyRate: document.getElementById('editHourlyRate'),
      editSkills: document.getElementById('editSkills'),
      editOnboardingStatus: document.getElementById('editOnboardingStatus'),
      editActiveStatus: document.getElementById('editActiveStatus')
    };

    // Check which elements are missing
    const missingElements = Object.entries(formElements)
      .filter(([name, element]) => !element)
      .map(([name]) => name);

    if (missingElements.length > 0) {
      console.error('‚ùå Missing form elements:', missingElements);
      alert(`Error: Missing form elements: ${missingElements.join(', ')}`);
      return;
    }

    console.log('‚úÖ All form elements found');

    // Populate form with current data
    formElements.editHandymanId.value = handyman.id;
    formElements.editFullName.value = handyman.full_name || '';
    formElements.editEmail.value = handyman.email || '';
    formElements.editPhone.value = handyman.phone || '';
    formElements.editHourlyRate.value = handyman.hourly_rate || '';

    // Handle skills (could be array or string)
    let skillsValue = '';
    if (handyman.skills) {
      if (Array.isArray(handyman.skills)) {
        skillsValue = handyman.skills.join(', ');
      } else if (typeof handyman.skills === 'string') {
        skillsValue = handyman.skills;
      }
    }
    formElements.editSkills.value = skillsValue;

    formElements.editOnboardingStatus.value = handyman.onboarding_completed ? 'true' : 'false';
    formElements.editActiveStatus.value = handyman.is_active ? 'true' : 'false';

    console.log('‚úÖ Form populated with data');

    // Show modal
    const modal = document.getElementById('editHandymanModal');
    if (!modal) {
      console.error('‚ùå Edit modal not found!');
      alert('Error: Edit modal not found in DOM');
      return;
    }

    modal.classList.remove('hidden');
    console.log('‚úÖ Edit modal opened');

  } catch (error) {
    console.error('‚ùå Error loading handyman:', error);
    alert('Error loading handyman data: ' + error.message);
  }
}

async function saveHandymanEdits() {
  try {
    const handymanId = document.getElementById('editHandymanId').value;
    const fullName = document.getElementById('editFullName').value.trim();
    const email = document.getElementById('editEmail').value.trim();
    const phone = document.getElementById('editPhone').value.trim();
    const hourlyRate = parseFloat(document.getElementById('editHourlyRate').value) || null;
    const skillsInput = document.getElementById('editSkills').value.trim();
    const onboardingCompleted = document.getElementById('editOnboardingStatus').value === 'true';
    const isActive = document.getElementById('editActiveStatus').value === 'true';

    console.log('üíæ Saving handyman edits:', {
      handymanId,
      fullName,
      email,
      phone,
      hourlyRate,
      skillsInput,
      onboardingCompleted,
      isActive
    });

    // Validate required fields
    if (!fullName || !email) {
      alert('Full name and email are required');
      return;
    }

    if (!handymanId) {
      alert('Handyman ID is missing');
      return;
    }

    // Process skills
    let skills = null;
    if (skillsInput) {
      skills = skillsInput.split(',').map(s => s.trim()).filter(s => s.length > 0);
    }

    console.log('üîÑ Updating handyman in database...');

    // Check current user session first
    const { data: session } = await supabase.auth.getSession();
    console.log('üîê Current session:', {
      user: session.session?.user?.id,
      email: session.session?.user?.email
    });

    // Check admin user role and permissions
    const { data: adminUser, error: adminError } = await supabase
      .from('admin_users')
      .select('*')
      .eq('id', session.session?.user?.id)
      .single();

    console.log('üëë Admin user data:', { adminUser, adminError });

    // First, let's verify the record exists and we can read it
    const { data: existingRecord, error: readError } = await supabase
      .from('handymen')
      .select('*')
      .eq('id', handymanId);

    console.log('üîç Record check before update:', {
      found: existingRecord?.length > 0,
      record: existingRecord?.[0],
      readError
    });

    if (!existingRecord || existingRecord.length === 0) {
      throw new Error('Handyman record not found or not accessible for updates');
    }

    // Since RLS policies are inconsistently blocking updates, use Edge Function for all admin updates
    console.log('üöÄ Using Edge Function for reliable admin updates...');

    const updateData = {
      full_name: fullName,
      email: email.toLowerCase(),
      phone: phone || null,
      hourly_rate: hourlyRate,
      skills: skills,
      onboarding_completed: onboardingCompleted,
      is_active: isActive
    };

    console.log('üîç Update payload:', updateData);

    const response = await fetch('/.netlify/functions/admin-update-handyman', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${(await supabase.auth.getSession()).data.session?.access_token}`
      },
      body: JSON.stringify({
        handyman_id: handymanId,
        updates: updateData
      })
    });

    if (!response.ok) {
      const errorData = await response.json();
      console.error('‚ùå Edge Function error:', errorData);
      throw new Error(`Update failed: ${errorData.error || response.statusText}`);
    }

    const edgeResult = await response.json();
    console.log('‚úÖ Edge Function update successful:', edgeResult);

    if (!edgeResult.success) {
      throw new Error(edgeResult.error || 'Update failed');
    }

    // Verify the update worked by reading the record again
    const { data: verifyRecord, error: verifyError } = await supabase
      .from('handymen')
      .select('*')
      .eq('id', handymanId)
      .single();

    if (!verifyError && verifyRecord) {
      console.log('üîç Verification - Record after update:', {
        expectedName: fullName,
        actualName: verifyRecord.full_name,
        nameUpdated: verifyRecord.full_name === fullName,
        expectedPhone: phone || null,
        actualPhone: verifyRecord.phone,
        phoneUpdated: verifyRecord.phone === (phone || null),
        expectedEmail: email.toLowerCase(),
        actualEmail: verifyRecord.email,
        emailUpdated: verifyRecord.email === email.toLowerCase()
      });
    }

    console.log('‚úÖ Handyman updated successfully');

    // Close modal and refresh data
    closeEditHandymanModal();
    loadHandymenData();
    showNotification('Handyman updated successfully!', 'success');

  } catch (error) {
    console.error('‚ùå Error updating handyman:', error);
    alert('Error updating handyman: ' + error.message);
  }
}

function closeEditHandymanModal() {
  document.getElementById('editHandymanModal').classList.add('hidden');
  document.getElementById('editHandymanForm').reset();
}

async function toggleHandymanStatus(handymanId) {
  try {
    // Get current handyman data
    const { data: handyman, error: fetchError } = await supabase
      .from('handymen')
      .select('full_name, is_active')
      .eq('id', handymanId)
      .single();

    if (fetchError) throw fetchError;
    if (!handyman) {
      alert('Handyman not found');
      return;
    }

    const currentStatus = handyman.is_active;
    const newStatus = !currentStatus;
    const action = newStatus ? 'activate' : 'suspend';
    const actionPast = newStatus ? 'activated' : 'suspended';

    // Confirm the action
    const confirmMessage = `Are you sure you want to ${action} ${handyman.full_name}?\n\n` +
      (newStatus
        ? 'They will be able to receive new task assignments.'
        : 'They will stop receiving new task assignments (existing tasks will remain assigned).');

    if (!confirm(confirmMessage)) {
      return;
    }

    // Update the status
    const { error: updateError } = await supabase
      .from('handymen')
      .update({ is_active: newStatus })
      .eq('id', handymanId);

    if (updateError) throw updateError;

    // Refresh the handyman list and show success message
    loadHandymenData();
    showNotification(`${handyman.full_name} has been ${actionPast}!`, 'success');

  } catch (error) {
    console.error('Error toggling handyman status:', error);
    alert('Error updating handyman status: ' + error.message);
  }
}

// Task Management Functions
let tasksData = [];
let selectedTasks = [];

// Load tasks data
async function loadTasksData() {
  console.log('üìã Loading tasks data...');

  try {
    const { data: tasks, error } = await supabase
      .from('tasks')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) throw error;

    // Get handyman names for all assigned tasks
    const handymanIds = [...new Set(tasks.filter(t => t.handyman_id).map(t => t.handyman_id))];
    let handymenMap = {};

    if (handymanIds.length > 0) {
      const { data: handymen } = await supabase
        .from('handymen')
        .select('id, full_name')
        .in('id', handymanIds);

      if (handymen) {
        handymenMap = Object.fromEntries(handymen.map(h => [h.id, h.full_name]));
      }
    }

    // Add handyman names to tasks
    tasksData = (tasks || []).map(task => ({
      ...task,
      handyman_name: task.handyman_id ? handymenMap[task.handyman_id] : null
    }));
    renderTasksTable();
    updateTaskSummary();

  } catch (error) {
    console.error('Error loading tasks:', error);
    document.getElementById('tasksTableBody').innerHTML = `
      <tr><td colspan="8" class="text-center py-8 text-red-500">Error loading tasks data</td></tr>
    `;
  }
}

// Render tasks table
function renderTasksTable() {
  const tbody = document.getElementById('tasksTableBody');

  if (!tasksData.length) {
    tbody.innerHTML = `
      <tr><td colspan="8" class="text-center py-8 text-slate-500">No tasks found</td></tr>
    `;
    return;
  }

  tbody.innerHTML = tasksData.map(task => `
    <tr class="border-b border-slate-100 hover:bg-slate-50">
      <td class="px-4 py-3">
        <input type="checkbox" class="task-checkbox" value="${task.id}"
               onchange="handleTaskSelection(this)">
      </td>
      <td class="px-4 py-3 font-medium">#${task.id.slice(0, 8)}</td>
      <td class="px-4 py-3">${task.customer_name}</td>
      <td class="px-4 py-3">${task.task_category || 'N/A'}</td>
      <td class="px-4 py-3 font-semibold">$${task.total_amount || task.estimated_cost || 'N/A'}</td>
      <td class="px-4 py-3">
        ${task.handyman_name ?
          `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">${task.handyman_name}</span>` :
          `<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs">Unassigned</span>`
        }
      </td>
      <td class="px-4 py-3">
        <span class="px-2 py-1 rounded-full text-xs ${getStatusColor(task.status)}">${task.status}</span>
      </td>
      <td class="px-4 py-3">
        <div class="flex gap-2">
          ${!task.handyman_id ?
            `<button onclick="openAssignModal('${task.id}')" class="text-blue-600 hover:text-blue-800 text-sm">Assign</button>` :
            `<button onclick="reassignTask('${task.id}')" class="text-orange-600 hover:text-orange-800 text-sm">Reassign</button>`
          }
          <button onclick="viewTaskDetails('${task.id}')" class="text-slate-600 hover:text-slate-800 text-sm">View</button>
        </div>
      </td>
    </tr>
  `).join('');
}

// Update task summary cards
function updateTaskSummary() {
  const unassignedTasks = tasksData.filter(task => !task.handyman_id).length;
  const assignedTasks = tasksData.filter(task => task.handyman_id && task.status === 'assigned').length;
  const inProgressTasks = tasksData.filter(task => task.status === 'in_progress').length;
  const completedTasks = tasksData.filter(task => task.status === 'completed').length;

  document.getElementById('unassignedTasksCount').textContent = unassignedTasks;
  document.getElementById('assignedTasksCount').textContent = assignedTasks;
  document.getElementById('inProgressTasksCount').textContent = inProgressTasks;
  document.getElementById('completedTasksCount').textContent = completedTasks;
}

// Handle task selection for bulk operations
function handleTaskSelection(checkbox) {
  const taskId = checkbox.value;

  if (checkbox.checked) {
    selectedTasks.push(taskId);
  } else {
    selectedTasks = selectedTasks.filter(id => id !== taskId);
  }

  // Update bulk actions visibility
  const bulkActions = document.getElementById('bulkActions');
  const selectedCount = document.getElementById('selectedCount');

  if (selectedTasks.length > 0) {
    if (bulkActions) bulkActions.style.display = 'block';
    if (selectedCount) selectedCount.textContent = selectedTasks.length;
  } else {
    if (bulkActions) bulkActions.style.display = 'none';
  }
}

// Filter tasks
function filterTasks() {
  const statusFilter = document.getElementById('statusFilter').value;
  const assignmentFilter = document.getElementById('assignmentFilter').value;

  let filteredTasks = [...tasksData];

  if (statusFilter && statusFilter !== 'all') {
    filteredTasks = filteredTasks.filter(task => task.status === statusFilter);
  }

  if (assignmentFilter && assignmentFilter !== 'all') {
    if (assignmentFilter === 'assigned') {
      filteredTasks = filteredTasks.filter(task => task.handyman_id);
    } else if (assignmentFilter === 'unassigned') {
      filteredTasks = filteredTasks.filter(task => !task.handyman_id);
    }
  }

  // Update display with filtered tasks
  const originalTasksData = tasksData;
  tasksData = filteredTasks;
  renderTasksTable();
  tasksData = originalTasksData; // Restore original data
}

// Open assignment modal
async function openAssignModal(taskId = null) {
  try {
    // Load available handymen
    const { data: handymen, error } = await supabase
      .from('handymen')
      .select('id, full_name, email, skills')
      .eq('is_active', true)
      .order('full_name');

    if (error) throw error;

    const handymenSelect = document.getElementById('assignHandymanSelect');
    handymenSelect.innerHTML = '<option value="">Select a handyman...</option>' +
      handymen.map(handyman => {
        const skillsText = handyman.skills && Array.isArray(handyman.skills) && handyman.skills.length > 0
          ? handyman.skills.slice(0, 2).join(', ') + (handyman.skills.length > 2 ? '...' : '')
          : 'General';
        return `<option value="${handyman.id}">${handyman.full_name} - ${skillsText}</option>`;
      }).join('');

    // Set modal title and behavior based on single vs bulk assignment
    const modal = document.getElementById('assignTaskModal');
    const title = document.getElementById('assignModalTitle');

    if (taskId) {
      // Single task assignment
      title.textContent = 'Assign Task';
      modal.dataset.taskId = taskId;
      modal.dataset.mode = 'single';

      // Populate task details in the assignment form
      const task = tasksData.find(t => t.id === taskId);
      if (task) {
        document.getElementById('assignTaskId').value = taskId;
        document.getElementById('displayTaskId').textContent = `#${taskId.slice(0, 8)}`;
        document.getElementById('displayCustomer').textContent = task.customer_name || 'N/A';
        document.getElementById('displayService').textContent = task.task_category || 'N/A';
        document.getElementById('displayAmount').textContent = `$${task.total_amount || 0}`;
      }
    } else {
      // Bulk assignment
      title.textContent = `Assign ${selectedTasks.length} Tasks`;
      modal.dataset.mode = 'bulk';

      // Clear task details for bulk assignment
      document.getElementById('displayTaskId').textContent = `${selectedTasks.length} tasks selected`;
      document.getElementById('displayCustomer').textContent = 'Multiple customers';
      document.getElementById('displayService').textContent = 'Multiple services';
      document.getElementById('displayAmount').textContent = 'Various amounts';
    }

    modal.classList.remove('hidden');

  } catch (error) {
    console.error('Error loading handymen for assignment:', error);
    alert('Failed to load handymen list');
  }
}

// Handle task assignment
async function handleTaskAssignment() {
  const modal = document.getElementById('assignTaskModal');
  const handymanId = document.getElementById('assignHandymanSelect').value;
  const notes = document.getElementById('assignmentNotes').value;

  if (!handymanId) {
    alert('Please select a handyman');
    return;
  }

  try {
    const mode = modal.dataset.mode;
    let taskIds = [];

    if (mode === 'single') {
      taskIds = [modal.dataset.taskId];
    } else {
      taskIds = selectedTasks;
    }

    // Log assignment notes (admin_notes column doesn't exist in current schema)
    if (notes) {
      console.log(`Assignment notes for task(s): ${notes}`);
    }

    // Update tasks with assignment
    for (const taskId of taskIds) {
      const { error } = await supabase
        .from('tasks')
        .update({
          handyman_id: handymanId,
          status: 'assigned'
        })
        .eq('id', taskId);

      if (error) throw error;
    }

    alert(`Successfully assigned ${taskIds.length} task(s)`);

    // Reset form and close modal
    document.getElementById('assignTaskForm').reset();
    modal.classList.add('hidden');

    // Clear selections
    selectedTasks = [];
    const bulkActionsEl = document.getElementById('bulkActions');
    if (bulkActionsEl) {
      bulkActionsEl.style.display = 'none';
    }

    // Reload tasks
    loadTasksData();

  } catch (error) {
    console.error('Error assigning tasks:', error);
    alert('Failed to assign tasks: ' + error.message);
  }
}

// Quick assign selected tasks
function quickAssignSelected() {
  if (selectedTasks.length === 0) {
    alert('Please select tasks to assign');
    return;
  }
  openAssignModal();
}

// Reassign task
async function reassignTask(taskId) {
  openAssignModal(taskId);
}

// View task details
async function viewTaskDetails(taskId) {
  try {
    const { data: task, error } = await supabase
      .from('tasks')
      .select('*')
      .eq('id', taskId)
      .single();

    if (error) throw error;

    // Get handyman details separately if assigned
    let handyman = null;
    if (task.handyman_id) {
      const { data: handymanData, error: handymanError } = await supabase
        .from('handymen')
        .select('id, full_name, email, phone')
        .eq('id', task.handyman_id)
        .single();

      if (!handymanError) {
        handyman = handymanData;
      }
    }

    // Get completion details if task is completed
    let completionDetails = '';
    if (task.status === 'completed' && task.handyman_id) {
      completionDetails = `
        <div class="border-t pt-4">
          <h4 class="text-lg font-semibold mb-3 text-green-700">Job Completion Details</h4>
          <div class="space-y-3">`;

      if (task.completed_at) {
        completionDetails += `
            <div>
              <label class="block text-sm font-medium text-slate-700">Completion Date</label>
              <p class="text-sm text-slate-900">${new Date(task.completed_at).toLocaleString()}</p>
            </div>`;
      }

      if (task.completion_notes) {
        completionDetails += `
            <div>
              <label class="block text-sm font-medium text-slate-700">Handyman Completion Notes</label>
              <p class="text-sm text-slate-900 bg-green-50 p-3 rounded-lg">${task.completion_notes}</p>
            </div>`;
      }

      if (task.time_spent) {
        completionDetails += `
            <div>
              <label class="block text-sm font-medium text-slate-700">Time Spent</label>
              <p class="text-sm text-slate-900">${task.time_spent} hours</p>
            </div>`;
      }

      completionDetails += `
          </div>
        </div>`;

      // Handle completion photos
      if (task.completion_photo_urls && task.completion_photo_urls.length > 0) {
        completionDetails += `
        <div class="border-t pt-4">
          <h4 class="text-lg font-semibold mb-3 text-green-700">Completion Photos</h4>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
            ${task.completion_photo_urls.map((photoUrl, index) => `
              <div class="relative">
                <img src="${photoUrl}" alt="Completion Photo ${index + 1}"
                     class="w-full h-32 object-cover rounded-lg cursor-pointer hover:opacity-75 transition-opacity border border-green-200"
                     onclick="openPhotoModal('${photoUrl}', 'Completion Photo ${index + 1}')">
                <div class="absolute top-1 right-1 bg-green-600 text-white text-xs px-1 rounded">
                  ${index + 1}
                </div>
              </div>
            `).join('')}
          </div>
        </div>`;
      }
    }

    // Populate task details modal
    const modal = document.getElementById('taskDetailsModal');
    document.getElementById('taskDetailContent').innerHTML = `
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700">Task ID</label>
            <p class="text-sm text-slate-900">#${task.id.slice(0, 8)}</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700">Status</label>
            <span class="px-2 py-1 rounded-full text-xs ${getStatusColor(task.status)}">${task.status}</span>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700">Customer</label>
            <p class="text-sm text-slate-900">${task.customer_name || 'N/A'}</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700">Service Type</label>
            <p class="text-sm text-slate-900">${task.task_category || 'N/A'}</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700">Amount</label>
            <p class="text-sm text-slate-900 font-semibold">$${task.total_amount || task.estimated_cost || 'N/A'}</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700">Assigned To</label>
            <p class="text-sm text-slate-900">${handyman ? handyman.full_name : 'Unassigned'}</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700">Created</label>
            <p class="text-sm text-slate-900">${new Date(task.created_at).toLocaleDateString()}</p>
          </div>
          ${task.scheduled_date ? `
          <div>
            <label class="block text-sm font-medium text-slate-700">Scheduled Date</label>
            <p class="text-sm text-slate-900">${new Date(task.scheduled_date).toLocaleDateString()}</p>
          </div>
          ` : ''}
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700">Description</label>
          <p class="text-sm text-slate-900">${task.description || 'No description provided'}</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700">Customer Address</label>
          <p class="text-sm text-slate-900">${task.customer_address || 'No address provided'}</p>
        </div>
        ${task.customer_phone ? `
        <div>
          <label class="block text-sm font-medium text-slate-700">Customer Phone</label>
          <p class="text-sm text-slate-900">${task.customer_phone}</p>
        </div>
        ` : ''}
        ${task.admin_notes ? `
        <div>
          <label class="block text-sm font-medium text-slate-700">Admin Notes</label>
          <p class="text-sm text-slate-900">${task.admin_notes}</p>
        </div>
        ` : ''}
        ${completionDetails}
      </div>
    `;

    modal.classList.remove('hidden');

  } catch (error) {
    console.error('Error loading task details:', error);
    alert('Failed to load task details');
  }
}

// Helper function for status colors
function getStatusColor(status) {
  const colors = {
    'pending': 'bg-yellow-100 text-yellow-800',
    'assigned': 'bg-blue-100 text-blue-800',
    'in_progress': 'bg-purple-100 text-purple-800',
    'completed': 'bg-green-100 text-green-800',
    'cancelled': 'bg-red-100 text-red-800'
  };
  return colors[status] || 'bg-slate-100 text-slate-800';
}

// Close modals
function closeAssignModal() {
  document.getElementById('assignTaskModal').classList.add('hidden');
  document.getElementById('assignTaskForm').reset();
}

function closeTaskDetailsModal() {
  document.getElementById('taskDetailsModal').classList.add('hidden');
}

function openPhotoModal(photoUrl, description) {
  const modal = document.getElementById('photoModal');
  const image = document.getElementById('photoModalImage');
  const title = document.getElementById('photoModalTitle');

  image.src = photoUrl;
  title.textContent = description || 'Task Photo';
  modal.classList.remove('hidden');
}

function closePhotoModal() {
  document.getElementById('photoModal').classList.add('hidden');
}

// Event listeners for task assignment form
document.getElementById('assignTaskForm').addEventListener('submit', (e) => {
  e.preventDefault();
  handleTaskAssignment();
});

// Event listeners for assignment modal close buttons
document.getElementById('closeAssignModal').addEventListener('click', () => {
  closeAssignModal();
});

document.getElementById('cancelAssignment').addEventListener('click', () => {
  closeAssignModal();
});

// Event listeners for handyman management
document.getElementById('quickAddHandyman').addEventListener('click', () => {
  document.getElementById('addHandymanModal').classList.remove('hidden');
});

// Add event listener for the "Add New Handyman" button in Handyman Management tab
document.getElementById('addNewHandyman').addEventListener('click', () => {
  document.getElementById('addHandymanModal').classList.remove('hidden');
});

// Event listeners for bulk task assignment
document.getElementById('assignBulkTasks').addEventListener('click', () => {
  quickAssignSelected();
});

// Event listener for select all tasks checkbox
document.getElementById('selectAllTasks').addEventListener('change', (e) => {
  const checkboxes = document.querySelectorAll('.task-checkbox');
  checkboxes.forEach(checkbox => {
    checkbox.checked = e.target.checked;
    handleTaskSelection(checkbox);
  });
});

// Add Handyman modal functions
function closeAddHandymanModal() {
  document.getElementById('addHandymanModal').classList.add('hidden');
  document.getElementById('addHandymanForm').reset();
}

// Generate a secure temporary password (same as PostMyStyle approach)
function generateSecurePassword() {
  const adjectives = ['Quick', 'Smart', 'Brave', 'Swift', 'Bright', 'Strong', 'Fast', 'Bold'];
  const nouns = ['Tiger', 'Eagle', 'Wolf', 'Lion', 'Bear', 'Hawk', 'Fox', 'Shark'];
  const numbers = Math.floor(100 + Math.random() * 900); // 3-digit number

  const adjective = adjectives[Math.floor(Math.random() * adjectives.length)];
  const noun = nouns[Math.floor(Math.random() * nouns.length)];

  return `${adjective}${noun}${numbers}`;
}

// Add Handyman form handler
document.getElementById('addHandymanForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const email = document.getElementById('handymanEmail').value.trim();
  const fullName = document.getElementById('handymanFullName').value.trim();
  const phone = document.getElementById('handymanPhone').value.trim();
  const city = document.getElementById('handymanCity').value.trim();
  const skills = document.getElementById('handymanSkills').value.trim();

  // Validate email format
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    alert('Please enter a valid email address (e.g., name@domain.com)');
    return;
  }

  try {
    console.log('üîê Creating handyman via Supabase Edge Function...');

    // Get current user session for authentication
    const { data: { session }, error: sessionError } = await supabase.auth.getSession();

    if (sessionError || !session) {
      throw new Error('You must be logged in to create handymen. Please refresh and log in again.');
    }

    console.log('User session verified, calling Edge Function...');

    // Call the Edge Function directly with fetch
    const response = await fetch(`${supabase.supabaseUrl}/functions/v1/create-handyman`, {
      method: 'POST',
      headers: {
        'authorization': `Bearer ${session.access_token}`,
        'apikey': supabase.supabaseKey
      },
      body: JSON.stringify({
        name: fullName,
        email: email,
        phone: phone || null
      })
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('‚ùå Edge Function error response:', errorText);
      let errorData;
      try {
        errorData = JSON.parse(errorText);
      } catch (e) {
        console.error('‚ùå Failed to parse error response as JSON:', e);
        throw new Error(`Edge Function call failed (${response.status}): ${errorText}`);
      }
      throw new Error(errorData.error || errorData.details || 'Edge Function call failed');
    }

    const data = await response.json();

    if (!data.success) {
      throw new Error(data.error || 'Unknown error occurred');
    }

    console.log('‚úÖ Handyman created successfully:', data.handyman);

    // Show PostMyStyle-style success modal with generated credentials
    showHandymanCreatedModal(
      data.handyman.name,
      data.credentials.email,
      data.credentials.password,
      data.handyman.auth_user_id,
      data.handyman.id
    );

    closeAddHandymanModal();
    loadHandymenData(); // Refresh the table

  } catch (error) {
    console.error('‚ùå Error creating handyman:', error);
    alert(`Failed to create handyman: ${error.message}`);
  }
});

// PostMyStyle-style success modal for handyman creation
function showHandymanCreatedModal(fullName, email, password, authUserId, handymanId) {
  // Create modal HTML dynamically
  const modalHtml = `
    <div id="handymanCreatedModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
      <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
        <div class="text-center">
          <!-- Success Icon -->
          <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
            <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>

          <!-- Title -->
          <h3 class="text-lg font-medium text-gray-900 mb-2">Handyman Created Successfully!</h3>
          <p class="text-sm text-gray-500 mb-6">${fullName} has been added to the system</p>

          <!-- Credentials Section -->
          <div class="bg-gray-50 rounded-lg p-4 mb-4">
            <h4 class="text-sm font-medium text-gray-900 mb-3">Account Credentials</h4>

            <!-- Email Row -->
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm text-gray-600">Email:</span>
              <div class="flex items-center gap-2">
                <span class="text-sm font-mono bg-white px-2 py-1 rounded border">${email}</span>
                <button onclick="copyToClipboard('${email}')" class="text-blue-600 hover:text-blue-800">
                  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                  </svg>
                </button>
              </div>
            </div>

            <!-- Password Row -->
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm text-gray-600">Password:</span>
              <div class="flex items-center gap-2">
                <span class="text-sm font-mono bg-white px-2 py-1 rounded border">${password}</span>
                <button onclick="copyToClipboard('${password}')" class="text-blue-600 hover:text-blue-800">
                  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                  </svg>
                </button>
              </div>
            </div>

            <!-- IDs for reference -->
            <div class="mt-3 pt-3 border-t border-gray-200">
              <div class="text-xs text-gray-500">
                <div>Auth ID: ${authUserId}</div>
                <div>Handyman ID: ${handymanId}</div>
              </div>
            </div>
          </div>

          <!-- Next Steps -->
          <div class="bg-blue-50 rounded-lg p-4 mb-4">
            <h4 class="text-sm font-medium text-blue-900 mb-2">Next Steps</h4>
            <ul class="text-sm text-blue-800 space-y-1 text-left">
              <li>‚Ä¢ Share credentials with ${fullName}</li>
              <li>‚Ä¢ Direct them to <span class="font-mono">sendahandyman.com/dashboard</span></li>
              <li>‚Ä¢ They need to complete onboarding process</li>
              <li>‚Ä¢ Skills and profile setup required</li>
            </ul>
          </div>

          <!-- Copy All Button -->
          <button onclick="copyAllCredentials('${email}', '${password}')"
                  class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200 mb-3">
            üìã Copy All Credentials
          </button>

          <!-- Close Button -->
          <button onclick="closeHandymanCreatedModal()"
                  class="w-full bg-gray-100 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-200 transition duration-200">
            Close
          </button>
        </div>
      </div>
    </div>
  `;

  // Remove existing modal if present
  const existingModal = document.getElementById('handymanCreatedModal');
  if (existingModal) {
    existingModal.remove();
  }

  // Add modal to DOM
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// Copy functions for the success modal
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    // Show brief success feedback
    const event = new CustomEvent('showToast', {
      detail: { message: 'Copied to clipboard!', type: 'success' }
    });
    window.dispatchEvent(event);
  }).catch(err => {
    console.error('Failed to copy: ', err);
    // Fallback - show alert
    alert('Copied: ' + text);
  });
}

function copyAllCredentials(email, password) {
  const credentials = `Handyman Account Credentials:
Email: ${email}
Password: ${password}
Dashboard: sendahandyman.com/dashboard

Please complete your onboarding process after logging in.`;

  navigator.clipboard.writeText(credentials).then(() => {
    const event = new CustomEvent('showToast', {
      detail: { message: 'All credentials copied to clipboard!', type: 'success' }
    });
    window.dispatchEvent(event);
  }).catch(err => {
    console.error('Failed to copy: ', err);
    alert('Credentials copied!');
  });
}

function closeHandymanCreatedModal() {
  const modal = document.getElementById('handymanCreatedModal');
  if (modal) {
    modal.remove();
  }
}

// Simple toast notification system for copy feedback
window.addEventListener('showToast', (e) => {
  const { message, type } = e.detail;

  // Remove existing toast
  const existingToast = document.getElementById('copyToast');
  if (existingToast) {
    existingToast.remove();
  }

  // Create toast
  const toast = document.createElement('div');
  toast.id = 'copyToast';
  toast.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white text-sm font-medium ${
    type === 'success' ? 'bg-green-500' : 'bg-red-500'
  } transform transition-all duration-300`;
  toast.textContent = message;

  document.body.appendChild(toast);

  // Auto remove after 2 seconds
  setTimeout(() => {
    if (toast) {
      toast.remove();
    }
  }, 2000);
});

// Initialize event listeners when DOM is ready
function initializeEventListeners() {
  console.log('üîß Initializing event listeners...');

  // Edit handyman modal event listeners
  const editForm = document.getElementById('editHandymanForm');
  const closeEditModal = document.getElementById('closeEditHandymanModal');
  const cancelEditButton = document.getElementById('cancelEditHandyman');

  if (editForm) {
    editForm.addEventListener('submit', (e) => {
      e.preventDefault();
      saveHandymanEdits();
    });
    console.log('‚úÖ Edit form submit listener attached');
  } else {
    console.error('‚ùå Edit form not found');
  }

  if (closeEditModal) {
    closeEditModal.addEventListener('click', () => {
      closeEditHandymanModal();
    });
    console.log('‚úÖ Close edit modal listener attached');
  } else {
    console.error('‚ùå Close edit modal button not found');
  }

  if (cancelEditButton) {
    cancelEditButton.addEventListener('click', () => {
      closeEditHandymanModal();
    });
    console.log('‚úÖ Cancel edit button listener attached');
  } else {
    console.error('‚ùå Cancel edit button not found');
  }

  console.log('‚úÖ All event listeners initialized');

  // Add event delegation for edit handyman buttons
  document.addEventListener('click', function(e) {
    console.log('üëÜ Click detected on element:', e.target.tagName, e.target.className);

    if (e.target && e.target.classList.contains('edit-handyman-btn')) {
      const handymanId = e.target.getAttribute('data-handyman-id');
      console.log(`üéØ Edit button clicked for handyman: ${handymanId}`);
      if (handymanId) {
        try {
          console.log('üîÑ Calling editHandyman function...');
          editHandyman(handymanId);
        } catch (error) {
          console.error('‚ùå Error calling editHandyman:', error);
        }
      } else {
        console.error('‚ùå No handyman ID found on edit button');
      }
    }
  });
  console.log('‚úÖ Event delegation for edit buttons added');

  // Test if editHandyman function is available
  if (typeof editHandyman === 'function') {
    console.log('‚úÖ editHandyman function is available');
  } else {
    console.error('‚ùå editHandyman function is not available');
  }

  // Ensure function is globally accessible
  if (typeof window.editHandyman !== 'function') {
    window.editHandyman = editHandyman;
    console.log('üìå editHandyman attached to window object');
  }

  // Test window function
  if (typeof window.editHandyman === 'function') {
    console.log('‚úÖ window.editHandyman is available');
  } else {
    console.error('‚ùå window.editHandyman is not available');
  }
}

// Initialize when DOM is fully loaded
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeEventListeners);
} else {
  initializeEventListeners();
}

console.log('üîê Admin dashboard loaded');
</script>

</body>
</html>