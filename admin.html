<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard - SendAHandyman</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="images/favicon.png">

  <!-- Analytics -->
  <!-- Google Analytics 4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    // Google Analytics 4 (replace with your actual GA4 measurement ID)
    gtag('config', 'G-XXXXXXXXXX', {
      page_title: 'Admin Dashboard - SendAHandyman',
      page_location: window.location.href
    });
  </script>

  <!-- Admin Analytics System -->
  <script>
    const AdminAnalytics = {
      sessionId: null,

      init() {
        this.sessionId = this.getOrCreateSessionId();
        this.trackPageView();
        console.log('üìä Admin Analytics initialized for session:', this.sessionId);
      },

      getOrCreateSessionId() {
        let sessionId = sessionStorage.getItem('admin_session_id');
        if (!sessionId) {
          sessionId = 'admin_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          sessionStorage.setItem('admin_session_id', sessionId);
        }
        return sessionId;
      },

      trackPageView() {
        this.trackEvent('admin_page_view', {
          page_title: document.title,
          page_url: window.location.href,
          user_agent: navigator.userAgent
        });
      },

      trackEvent(eventName, eventData = {}) {
        const eventPayload = {
          event_name: eventName,
          session_id: this.sessionId,
          timestamp: new Date().toISOString(),
          page_url: window.location.href,
          user_type: 'admin',
          ...eventData
        };

        // Send to Google Analytics if available
        if (typeof gtag !== 'undefined') {
          gtag('event', eventName, eventData);
        }

        console.log('üìä Admin Event:', eventName, eventData);
      },

      // Admin-specific tracking methods
      trackSectionView(sectionName) {
        this.trackEvent('admin_section_viewed', {
          section: sectionName
        });
      },

      trackTaskAction(action, taskId) {
        this.trackEvent('admin_task_action', {
          action: action,
          task_id: taskId
        });
      },

      trackQuoteAction(action, quoteId) {
        this.trackEvent('admin_quote_action', {
          action: action,
          quote_id: quoteId
        });
      },

      trackHandymanAction(action, handymanId) {
        this.trackEvent('admin_handyman_action', {
          action: action,
          handyman_id: handymanId
        });
      }
    };

    // Initialize admin analytics when page loads
    document.addEventListener('DOMContentLoaded', () => {
      AdminAnalytics.init();
    });
  </script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .shadow-soft{box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .shadow-md{box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06)}
    .admin-section { display: none; }
    .admin-section.active { display: block; }
    .admin-nav-btn.active { background: #4f46e5; color: white; }
    .status-badge { padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; }
    .status-active { background: #10b981; color: white; }
    .status-pending { background: #f59e0b; color: white; }
    .status-inactive { background: #6b7280; color: white; }
    .status-paid { background: #10b981; color: white; }
    .status-expired { background: #ef4444; color: white; }
  </style>
</head>
<body class="bg-slate-50">

<!-- Admin Login Page -->
<div id="adminLoginPage" class="min-h-screen flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl p-8 shadow-soft border border-slate-100 w-full max-w-md">
    <div class="text-center mb-6">
      <img src="images/helpinghands_logo.png" alt="SendAHandyman" class="h-16 w-auto mx-auto mb-4" />
      <h1 class="text-2xl font-bold mb-2 text-red-600">Admin Portal</h1>
      <p class="text-slate-600">Administrative access required</p>
    </div>

    <form id="adminLoginForm" class="space-y-4">
      <div>
        <label class="block text-sm font-semibold mb-1">Admin Email *</label>
        <input type="email" id="adminEmail" required class="w-full rounded-lg border border-slate-200 px-3 py-2" />
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Admin Password *</label>
        <input type="password" id="adminPassword" required class="w-full rounded-lg border border-slate-200 px-3 py-2" />
      </div>
      <button type="submit" class="w-full bg-red-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-700 transition-colors">
        Access Admin Portal
      </button>
    </form>
  </div>
</div>

<!-- Admin Dashboard -->
<div id="adminDashboard" class="hidden min-h-screen">
  <!-- Header -->
  <header class="bg-white border-b border-slate-200 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="images/helpinghands_logo.png" alt="SendAHandyman" class="h-10 w-auto" />
          <h1 class="text-xl font-bold text-red-600">Admin Dashboard</h1>
        </div>
        <div class="flex items-center gap-4">
          <span id="adminUserName" class="text-sm font-semibold text-slate-700"></span>
          <button id="adminLogoutBtn" class="text-sm text-slate-600 hover:text-slate-900">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Navigation -->
  <div class="bg-white border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4">
      <nav class="flex gap-8 overflow-x-auto">
        <button id="nav-overview" class="admin-nav-btn active py-4 px-2 border-b-2 border-transparent font-semibold text-sm whitespace-nowrap transition-colors">
          üìä Overview
        </button>
        <button id="nav-handymen" class="admin-nav-btn py-4 px-2 border-b-2 border-transparent font-semibold text-sm whitespace-nowrap transition-colors">
          üë• Handyman Management
        </button>
        <button id="nav-quotes" class="admin-nav-btn py-4 px-2 border-b-2 border-transparent font-semibold text-sm whitespace-nowrap transition-colors">
          üí∞ Quote Management
        </button>
        <button id="nav-tasks" class="admin-nav-btn py-4 px-2 border-b-2 border-transparent font-semibold text-sm whitespace-nowrap transition-colors">
          üìã Task Management
        </button>
        <button id="nav-analytics" class="admin-nav-btn py-4 px-2 border-b-2 border-transparent font-semibold text-sm whitespace-nowrap transition-colors">
          üìà Analytics
        </button>
      </nav>
    </div>
  </div>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 py-6">

    <!-- Overview Section -->
    <section id="section-overview" class="admin-section active">
      <div class="mb-6">
        <h2 class="text-2xl font-bold mb-2">System Overview</h2>
        <p class="text-slate-600">Real-time metrics and quick actions</p>
      </div>

      <!-- Metrics Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-lg p-6 shadow-soft">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-slate-600">Completed Onboarding</p>
              <p id="activeHandymenCount" class="text-2xl font-bold text-green-600">-</p>
            </div>
            <div class="bg-green-100 p-3 rounded-lg">
              <span class="text-green-600 text-xl">üë•</span>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg p-6 shadow-soft">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-slate-600">Active Tasks</p>
              <p id="activeTasksCount" class="text-2xl font-bold text-blue-600">-</p>
            </div>
            <div class="bg-blue-100 p-3 rounded-lg">
              <span class="text-blue-600 text-xl">üîß</span>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg p-6 shadow-soft">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-slate-600">Pending Quotes</p>
              <p id="pendingQuotesCount" class="text-2xl font-bold text-orange-600">-</p>
            </div>
            <div class="bg-orange-100 p-3 rounded-lg">
              <span class="text-orange-600 text-xl">üí∞</span>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg p-6 shadow-soft">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-slate-600">Today's Revenue</p>
              <p id="todayRevenue" class="text-2xl font-bold text-purple-600">$-</p>
            </div>
            <div class="bg-purple-100 p-3 rounded-lg">
              <span class="text-purple-600 text-xl">üí∏</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="bg-white rounded-lg p-6 shadow-soft mb-8">
        <h3 class="text-lg font-bold mb-4">Quick Actions</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <button id="quickCreateQuote" class="bg-green-600 text-white p-4 rounded-lg hover:bg-green-700 transition-colors">
            <div class="text-xl mb-2">üí∞</div>
            <div class="font-semibold">Create Quote</div>
          </button>
          <button id="quickAddHandyman" class="bg-blue-600 text-white p-4 rounded-lg hover:bg-blue-700 transition-colors">
            <div class="text-xl mb-2">üë∑</div>
            <div class="font-semibold">Add Handyman</div>
          </button>
          <button id="quickViewTasks" class="bg-purple-600 text-white p-4 rounded-lg hover:bg-purple-700 transition-colors">
            <div class="text-xl mb-2">üìã</div>
            <div class="font-semibold">Assign Tasks</div>
          </button>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="bg-white rounded-lg p-6 shadow-soft">
        <h3 class="text-lg font-bold mb-4">Recent Activity</h3>
        <div id="recentActivity" class="space-y-3">
          <div class="text-center py-8 text-slate-500">Loading recent activity...</div>
        </div>
      </div>
    </section>

    <!-- Handyman Management Section -->
    <section id="section-handymen" class="admin-section">
      <div class="mb-6 flex justify-between items-center">
        <div>
          <h2 class="text-2xl font-bold mb-2">Handyman Management</h2>
          <p class="text-slate-600">Manage handyman profiles, status, and assignments</p>
        </div>
        <button id="addNewHandyman" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
          ‚ûï Add New Handyman
        </button>
      </div>

      <!-- Handyman Filters -->
      <div class="bg-white rounded-lg p-4 shadow-soft mb-6">
        <div class="flex flex-wrap gap-4">
          <select id="handymanStatusFilter" class="border border-slate-200 rounded-lg px-3 py-2">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="pending">Pending</option>
            <option value="inactive">Inactive</option>
          </select>
          <input type="text" id="handymanSearchInput" placeholder="Search by name or email..." class="border border-slate-200 rounded-lg px-3 py-2 flex-1 min-w-64">
          <button id="refreshHandymen" class="bg-slate-600 text-white px-4 py-2 rounded-lg hover:bg-slate-700 transition-colors">
            üîÑ Refresh
          </button>
        </div>
      </div>

      <!-- Handyman List -->
      <div class="bg-white rounded-lg shadow-soft overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-slate-50 border-b border-slate-200">
              <tr>
                <th class="text-left py-3 px-4 font-semibold text-sm">Name</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Contact</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Status</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Skills</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Joined</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Actions</th>
              </tr>
            </thead>
            <tbody id="handymenTableBody">
              <tr>
                <td colspan="6" class="text-center py-8 text-slate-500">Loading handymen...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Quote Management Section -->
    <section id="section-quotes" class="admin-section">
      <div class="mb-6 flex justify-between items-center">
        <div>
          <h2 class="text-2xl font-bold mb-2">Quote Management</h2>
          <p class="text-slate-600">Create, manage, and track custom quotes</p>
        </div>
        <button id="createNewQuote" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
          üí∞ Create New Quote
        </button>
      </div>

      <!-- Quote Filters -->
      <div class="bg-white rounded-lg p-4 shadow-soft mb-6">
        <div class="flex flex-wrap gap-4">
          <select id="quoteStatusFilter" class="border border-slate-200 rounded-lg px-3 py-2">
            <option value="">All Status</option>
            <option value="pending">Pending</option>
            <option value="paid">Paid</option>
            <option value="expired">Expired</option>
          </select>
          <input type="text" id="quoteSearchInput" placeholder="Search by customer name..." class="border border-slate-200 rounded-lg px-3 py-2 flex-1 min-w-64">
          <button id="refreshQuotes" class="bg-slate-600 text-white px-4 py-2 rounded-lg hover:bg-slate-700 transition-colors">
            üîÑ Refresh
          </button>
        </div>
      </div>

      <!-- Quote List -->
      <div class="bg-white rounded-lg shadow-soft overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-slate-50 border-b border-slate-200">
              <tr>
                <th class="text-left py-3 px-4 font-semibold text-sm">Quote ID</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Customer</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Service</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Amount</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Status</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Created</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Quote Link</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Actions</th>
              </tr>
            </thead>
            <tbody id="quotesTableBody">
              <tr>
                <td colspan="8" class="text-center py-8 text-slate-500">Loading quotes...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Task Management Section -->
    <section id="section-tasks" class="admin-section">
      <div class="mb-6 flex justify-between items-center">
        <div>
          <h2 class="text-2xl font-bold mb-2">Task Management</h2>
          <p class="text-slate-600">View and assign tasks to handymen</p>
        </div>
        <div class="flex gap-2">
          <button id="assignBulkTasks" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
            üìã Bulk Assign
          </button>
        </div>
      </div>

      <!-- Task Filters -->
      <div class="bg-white rounded-lg p-4 shadow-soft mb-6">
        <div class="flex flex-wrap gap-4">
          <select id="taskStatusFilter" class="border border-slate-200 rounded-lg px-3 py-2">
            <option value="">All Status</option>
            <option value="pending">Unassigned</option>
            <option value="assigned">Assigned</option>
            <option value="in_progress">In Progress</option>
            <option value="completed">Completed</option>
          </select>
          <select id="handymanFilter" class="border border-slate-200 rounded-lg px-3 py-2">
            <option value="">All Handymen</option>
            <option value="unassigned">Unassigned Tasks</option>
          </select>
          <input type="text" id="taskSearchInput" placeholder="Search by customer name or task ID..." class="border border-slate-200 rounded-lg px-3 py-2 flex-1 min-w-64">
          <button id="refreshTasks" class="bg-slate-600 text-white px-4 py-2 rounded-lg hover:bg-slate-700 transition-colors">
            üîÑ Refresh
          </button>
        </div>
      </div>

      <!-- Task Assignment Summary -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg p-4 shadow-soft">
          <div class="text-center">
            <div class="text-2xl font-bold text-red-600" id="unassignedTasksCount">-</div>
            <div class="text-sm text-slate-600">Unassigned Tasks</div>
          </div>
        </div>
        <div class="bg-white rounded-lg p-4 shadow-soft">
          <div class="text-center">
            <div class="text-2xl font-bold text-orange-600" id="assignedTasksCount">-</div>
            <div class="text-sm text-slate-600">Assigned Tasks</div>
          </div>
        </div>
        <div class="bg-white rounded-lg p-4 shadow-soft">
          <div class="text-center">
            <div class="text-2xl font-bold text-blue-600" id="inProgressTasksCount">-</div>
            <div class="text-sm text-slate-600">In Progress</div>
          </div>
        </div>
        <div class="bg-white rounded-lg p-4 shadow-soft">
          <div class="text-center">
            <div class="text-2xl font-bold text-green-600" id="completedTasksCount">-</div>
            <div class="text-sm text-slate-600">Completed Today</div>
          </div>
        </div>
      </div>

      <!-- Tasks List -->
      <div class="bg-white rounded-lg shadow-soft overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-slate-50 border-b border-slate-200">
              <tr>
                <th class="text-left py-3 px-4 font-semibold text-sm">
                  <input type="checkbox" id="selectAllTasks" class="rounded">
                </th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Task ID</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Customer</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Service</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Amount</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Assigned To</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Status</th>
                <th class="text-left py-3 px-4 font-semibold text-sm">Actions</th>
              </tr>
            </thead>
            <tbody id="tasksTableBody">
              <tr>
                <td colspan="8" class="text-center py-8 text-slate-500">Loading tasks...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Analytics Section -->
    <section id="section-analytics" class="admin-section">
      <div class="mb-6">
        <h2 class="text-2xl font-bold mb-2">Analytics & Reports</h2>
        <p class="text-slate-600">Business insights and performance metrics</p>
      </div>

      <!-- Charts and Analytics -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="bg-white rounded-lg p-6 shadow-soft">
          <h3 class="text-lg font-bold mb-4">Revenue Trend (30 days)</h3>
          <canvas id="revenueChart" width="400" height="200"></canvas>
        </div>

        <div class="bg-white rounded-lg p-6 shadow-soft">
          <h3 class="text-lg font-bold mb-4">Quote Conversion Rate</h3>
          <canvas id="conversionChart" width="400" height="200"></canvas>
        </div>
      </div>

      <!-- Performance Metrics -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white rounded-lg p-6 shadow-soft">
          <h3 class="text-lg font-bold mb-4">Top Performing Handymen</h3>
          <div id="topHandymen" class="space-y-3">
            <div class="text-center py-4 text-slate-500">Loading data...</div>
          </div>
        </div>

        <div class="bg-white rounded-lg p-6 shadow-soft">
          <h3 class="text-lg font-bold mb-4">Popular Services</h3>
          <div id="popularServices" class="space-y-3">
            <div class="text-center py-4 text-slate-500">Loading data...</div>
          </div>
        </div>

        <div class="bg-white rounded-lg p-6 shadow-soft">
          <h3 class="text-lg font-bold mb-4">System Health</h3>
          <div id="systemHealth" class="space-y-3">
            <div class="flex justify-between">
              <span class="text-sm text-slate-600">Database</span>
              <span class="text-sm font-semibold text-green-600">‚úÖ Online</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm text-slate-600">Payment System</span>
              <span class="text-sm font-semibold text-green-600">‚úÖ Online</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm text-slate-600">Notifications</span>
              <span class="text-sm font-semibold text-green-600">‚úÖ Online</span>
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>
</div>

<!-- Modals -->

<!-- Create Quote Modal -->
<div id="createQuoteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-2xl w-full max-h-96 overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold">Create New Quote</h3>
        <button id="closeQuoteModal" class="text-slate-500 hover:text-slate-700">‚úï</button>
      </div>

      <form id="createQuoteForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1">Customer Name *</label>
            <input type="text" id="quoteCustomerName" required class="w-full border border-slate-200 rounded-lg px-3 py-2">
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Customer Phone *</label>
            <input type="tel" id="quoteCustomerPhone" required class="w-full border border-slate-200 rounded-lg px-3 py-2">
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Customer Email</label>
          <input type="email" id="quoteCustomerEmail" class="w-full border border-slate-200 rounded-lg px-3 py-2">
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1">Service Type *</label>
            <select id="quoteServiceType" required class="w-full border border-slate-200 rounded-lg px-3 py-2" onchange="updateServicePricing()">
              <option value="">Select Service</option>
              <option value="tv_mount" data-price="160">üì∫ TV Wall Mount (32‚Äì65") - Starting at $160</option>
              <option value="ceiling_fan" data-price="160">üí° Ceiling Fan Install/Replace - Starting at $160</option>
              <option value="light_fixture" data-price="120">‚ú® Light Fixture / Chandelier Swap - Starting at $120</option>
              <option value="faucet_showerhead" data-price="120">üö∞ Faucet / Showerhead Replace - Starting at $120</option>
              <option value="smart_doorbell" data-price="100">üîî Smart Doorbell Install - Starting at $100</option>
              <option value="curtains_blinds" data-price="120">ü™ü Curtain Rods / Blinds - Starting at $120</option>
              <option value="floating_shelf" data-price="120">üìö Floating Shelf Install - Starting at $120</option>
              <option value="appliance_hookup" data-price="160">‚ö° Appliance Hookup (W/D/DW) - Starting at $160</option>
              <option value="furniture_assembly" data-price="160">ü™ë Furniture Assembly (S‚ÄìM) - Starting at $160</option>
              <option value="closet_organizer" data-price="200">üëï Closet Organizer Install - Starting at $200</option>
              <option value="premium_moveout" data-price="300">üè† Premium Move-Out Removal - Starting at $300</option>
              <option value="general_handyman" data-price="240">üîß General Handyman (3+ hours) - Starting at $240</option>
              <option value="custom" data-price="">üíº Custom Service - Set Custom Price</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Quote Amount ($) *</label>
            <input type="number" id="quoteAmount" step="0.01" required class="w-full border border-slate-200 rounded-lg px-3 py-2" placeholder="Amount will auto-populate">
            <p class="text-xs text-slate-500 mt-1">Base price auto-fills when service is selected. Adjust as needed.</p>
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Service Description</label>
          <textarea id="quoteDescription" rows="3" class="w-full border border-slate-200 rounded-lg px-3 py-2" placeholder="Describe the specific work to be done..."></textarea>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Quote Expiry (days)</label>
          <select id="quoteExpiry" class="w-full border border-slate-200 rounded-lg px-3 py-2">
            <option value="7">7 days</option>
            <option value="14" selected>14 days</option>
            <option value="30">30 days</option>
          </select>
        </div>

        <div class="flex gap-3 pt-4">
          <button type="button" id="cancelQuoteCreation" class="flex-1 border border-slate-200 text-slate-600 py-2 px-4 rounded-lg hover:bg-slate-50">
            Cancel
          </button>
          <button type="submit" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700">
            Create Quote
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Quote Success Modal -->
<div id="quoteSuccessModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-lg w-full">
    <div class="p-6">
      <div class="text-center mb-4">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
          <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
        <h3 class="text-xl font-bold text-green-600 mb-2">Quote Created Successfully!</h3>
        <p class="text-slate-600 mb-4">Your quote has been created and is ready to send to the customer.</p>
      </div>

      <div class="bg-slate-50 rounded-lg p-4 mb-6">
        <label class="block text-sm font-semibold mb-2">Quote Link:</label>
        <div class="flex gap-2">
          <input type="text" id="quoteSuccessLink" readonly class="flex-1 bg-white border border-slate-200 rounded px-3 py-2 text-sm font-mono text-slate-600">
          <button id="copyQuoteSuccessLink" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm font-semibold">
            Copy
          </button>
        </div>
      </div>

      <div class="text-center">
        <button id="closeQuoteSuccessModal" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 font-semibold">
          Got it!
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Assign Task Modal -->
<div id="assignTaskModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-2xl w-full max-h-96 overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 id="assignModalTitle" class="text-xl font-bold">Assign Task to Handyman</h3>
        <button id="closeAssignModal" class="text-slate-500 hover:text-slate-700">‚úï</button>
      </div>

      <form id="assignTaskForm" class="space-y-4">
        <input type="hidden" id="assignTaskId">

        <!-- Task Info Display -->
        <div id="taskInfoDisplay" class="bg-slate-50 rounded-lg p-4 mb-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <div>
              <span class="font-semibold">Task ID:</span>
              <span id="displayTaskId">-</span>
            </div>
            <div>
              <span class="font-semibold">Customer:</span>
              <span id="displayCustomer">-</span>
            </div>
            <div>
              <span class="font-semibold">Service:</span>
              <span id="displayService">-</span>
            </div>
            <div>
              <span class="font-semibold">Amount:</span>
              <span id="displayAmount">-</span>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1">Select Handyman *</label>
            <select id="assignHandymanSelect" required class="w-full border border-slate-200 rounded-lg px-3 py-2">
              <option value="">Choose handyman...</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Priority</label>
            <select id="assignPriority" class="w-full border border-slate-200 rounded-lg px-3 py-2">
              <option value="normal">Normal</option>
              <option value="high">High</option>
              <option value="urgent">Urgent</option>
            </select>
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Scheduled Date</label>
          <input type="date" id="assignScheduledDate" class="w-full border border-slate-200 rounded-lg px-3 py-2">
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Assignment Notes</label>
          <textarea id="assignmentNotes" rows="3" class="w-full border border-slate-200 rounded-lg px-3 py-2" placeholder="Special instructions or notes for the handyman..."></textarea>
        </div>

        <div class="flex gap-3 pt-4">
          <button type="button" id="cancelAssignment" class="flex-1 border border-slate-200 text-slate-600 py-2 px-4 rounded-lg hover:bg-slate-50">
            Cancel
          </button>
          <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">
            Assign Task
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Handyman Modal -->
<div id="editHandymanModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-6xl w-full max-h-[95vh] overflow-y-auto">
    <div class="p-6">
      <!-- Header -->
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold">Edit Handyman Profile</h3>
        <button id="closeEditHandymanModal" class="text-slate-500 hover:text-slate-700 text-xl">‚úï</button>
      </div>

      <!-- Tab Navigation -->
      <div class="border-b border-slate-200 mb-6">
        <nav class="flex space-x-8">
          <button type="button" class="edit-tab active py-2 px-1 border-b-2 border-blue-600 text-blue-600 font-medium" data-tab="basic">
            Basic Info
          </button>
          <button type="button" class="edit-tab py-2 px-1 border-b-2 border-transparent text-slate-500 hover:text-slate-700" data-tab="personal">
            Personal Details
          </button>
          <button type="button" class="edit-tab py-2 px-1 border-b-2 border-transparent text-slate-500 hover:text-slate-700" data-tab="work">
            Work & Skills
          </button>
          <button type="button" class="edit-tab py-2 px-1 border-b-2 border-transparent text-slate-500 hover:text-slate-700" data-tab="documents">
            Documents & Files
          </button>
          <button type="button" class="edit-tab py-2 px-1 border-b-2 border-transparent text-slate-500 hover:text-slate-700" data-tab="financial">
            Financial & Tax
          </button>
          <button type="button" class="edit-tab py-2 px-1 border-b-2 border-transparent text-slate-500 hover:text-slate-700" data-tab="agreements">
            Agreements
          </button>
        </nav>
      </div>

      <form id="editHandymanForm" class="space-y-6">
        <input type="hidden" id="editHandymanId">

        <!-- Basic Info Tab -->
        <div id="edit-tab-basic" class="edit-tab-content">
          <h4 class="text-lg font-semibold mb-4">Basic Information</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="editFullName" class="block text-sm font-medium mb-1">Full Name *</label>
              <input type="text" id="editFullName" class="w-full border rounded-lg px-3 py-2" required>
            </div>
            <div>
              <label for="editLegalName" class="block text-sm font-medium mb-1">Legal Name</label>
              <input type="text" id="editLegalName" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
              <label for="editEmail" class="block text-sm font-medium mb-1">Email *</label>
              <input type="email" id="editEmail" class="w-full border rounded-lg px-3 py-2" required>
            </div>
            <div>
              <label for="editPhone" class="block text-sm font-medium mb-1">Phone</label>
              <input type="tel" id="editPhone" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
              <label for="editCity" class="block text-sm font-medium mb-1">City</label>
              <input type="text" id="editCity" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
              <label for="editZip" class="block text-sm font-medium mb-1">ZIP Code</label>
              <input type="text" id="editZip" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
              <label for="editServiceState" class="block text-sm font-medium mb-1">Service State</label>
              <input type="text" id="editServiceState" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
              <label for="editActiveStatus" class="block text-sm font-medium mb-1">Status</label>
              <select id="editActiveStatus" class="w-full border rounded-lg px-3 py-2">
                <option value="true">Active</option>
                <option value="false">Inactive</option>
              </select>
            </div>
          </div>
          <div class="mt-4">
            <label for="editBio" class="block text-sm font-medium mb-1">Bio</label>
            <textarea id="editBio" class="w-full border rounded-lg px-3 py-2" rows="3"></textarea>
          </div>
        </div>

        <!-- Personal Details Tab -->
        <div id="edit-tab-personal" class="edit-tab-content hidden">
          <h4 class="text-lg font-semibold mb-4">Personal Details</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="editDateOfBirth" class="block text-sm font-medium mb-1">Date of Birth</label>
              <input type="date" id="editDateOfBirth" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
              <label for="editDriversLicense" class="block text-sm font-medium mb-1">Driver's License</label>
              <input type="text" id="editDriversLicense" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
              <label for="editEmergencyContactName" class="block text-sm font-medium mb-1">Emergency Contact Name</label>
              <input type="text" id="editEmergencyContactName" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
              <label for="editEmergencyContactPhone" class="block text-sm font-medium mb-1">Emergency Contact Phone</label>
              <input type="tel" id="editEmergencyContactPhone" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
              <label for="editEmergencyContactRelation" class="block text-sm font-medium mb-1">Emergency Contact Relation</label>
              <input type="text" id="editEmergencyContactRelation" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
              <label for="editBackgroundCheckStatus" class="block text-sm font-medium mb-1">Background Check Status</label>
              <select id="editBackgroundCheckStatus" class="w-full border rounded-lg px-3 py-2">
                <option value="pending">Pending</option>
                <option value="in_progress">In Progress</option>
                <option value="completed">Completed</option>
                <option value="failed">Failed</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Work & Skills Tab -->
        <div id="edit-tab-work" class="edit-tab-content hidden">
          <h4 class="text-lg font-semibold mb-4">Work & Skills</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="editHourlyRate" class="block text-sm font-medium mb-1">Hourly Rate ($)</label>
              <input type="number" id="editHourlyRate" class="w-full border rounded-lg px-3 py-2" step="0.01" min="0">
            </div>
            <div>
              <label for="editYearsExperience" class="block text-sm font-medium mb-1">Years of Experience</label>
              <input type="number" id="editYearsExperience" class="w-full border rounded-lg px-3 py-2" min="0">
            </div>
            <div>
              <label for="editOnboardingStatus" class="block text-sm font-medium mb-1">Onboarding Status</label>
              <select id="editOnboardingStatus" class="w-full border rounded-lg px-3 py-2">
                <option value="false">Pending</option>
                <option value="true">Completed</option>
              </select>
            </div>
            <div>
              <label for="editOnboardingStep" class="block text-sm font-medium mb-1">Onboarding Step</label>
              <input type="number" id="editOnboardingStep" class="w-full border rounded-lg px-3 py-2" min="1">
            </div>
          </div>

          <div class="mt-4">
            <label for="editSkills" class="block text-sm font-medium mb-1">Skills (comma-separated)</label>
            <input type="text" id="editSkills" class="w-full border rounded-lg px-3 py-2" placeholder="e.g. Plumbing, Electrical, Painting">
          </div>

          <div class="mt-4">
            <label for="editServiceAreas" class="block text-sm font-medium mb-1">Service Areas (comma-separated)</label>
            <input type="text" id="editServiceAreas" class="w-full border rounded-lg px-3 py-2" placeholder="e.g. Miami, Fort Lauderdale">
          </div>

          <div class="mt-4">
            <h5 class="font-medium mb-2">Equipment & Tools</h5>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
              <label class="flex items-center space-x-2">
                <input type="checkbox" id="editHasVehicle" class="rounded">
                <span class="text-sm">Has Vehicle</span>
              </label>
              <label class="flex items-center space-x-2">
                <input type="checkbox" id="editHasTools" class="rounded">
                <span class="text-sm">Has Tools</span>
              </label>
              <label class="flex items-center space-x-2">
                <input type="checkbox" id="editHasSmartphone" class="rounded">
                <span class="text-sm">Has Smartphone</span>
              </label>
              <label class="flex items-center space-x-2">
                <input type="checkbox" id="editHasPpe" class="rounded">
                <span class="text-sm">Has PPE</span>
              </label>
              <label class="flex items-center space-x-2">
                <input type="checkbox" id="editHasLadder" class="rounded">
                <span class="text-sm">Has Ladder</span>
              </label>
            </div>
          </div>

          <div class="mt-4">
            <label for="editAdditionalEquipment" class="block text-sm font-medium mb-1">Additional Equipment</label>
            <textarea id="editAdditionalEquipment" class="w-full border rounded-lg px-3 py-2" rows="2"></textarea>
          </div>
        </div>

        <!-- Documents & Files Tab -->
        <div id="edit-tab-documents" class="edit-tab-content hidden">
          <h4 class="text-lg font-semibold mb-4">Documents & Files</h4>
          <div class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="editProfilePhotoUrl" class="block text-sm font-medium mb-1">Profile Photo URL</label>
                <input type="url" id="editProfilePhotoUrl" class="w-full border rounded-lg px-3 py-2">
              </div>
              <div>
                <label for="editGovIdUrl" class="block text-sm font-medium mb-1">Government ID URL</label>
                <input type="url" id="editGovIdUrl" class="w-full border rounded-lg px-3 py-2">
              </div>
              <div>
                <label for="editInsuranceProofUrl" class="block text-sm font-medium mb-1">Insurance Proof URL</label>
                <input type="url" id="editInsuranceProofUrl" class="w-full border rounded-lg px-3 py-2">
              </div>
              <div>
                <label for="editW9FormUrl" class="block text-sm font-medium mb-1">W9 Form URL</label>
                <input type="url" id="editW9FormUrl" class="w-full border rounded-lg px-3 py-2">
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="editInsuranceProvider" class="block text-sm font-medium mb-1">Insurance Provider</label>
                <input type="text" id="editInsuranceProvider" class="w-full border rounded-lg px-3 py-2">
              </div>
              <div>
                <label for="editInsuranceExpiry" class="block text-sm font-medium mb-1">Insurance Expiry Date</label>
                <input type="date" id="editInsuranceExpiry" class="w-full border rounded-lg px-3 py-2">
              </div>
              <div>
                <label for="editInsuranceStatus" class="block text-sm font-medium mb-1">Insurance Status</label>
                <select id="editInsuranceStatus" class="w-full border rounded-lg px-3 py-2">
                  <option value="">Not Set</option>
                  <option value="pending">Pending</option>
                  <option value="verified">Verified</option>
                  <option value="expired">Expired</option>
                </select>
              </div>
              <div>
                <label for="editLicenses" class="block text-sm font-medium mb-1">Licenses</label>
                <textarea id="editLicenses" class="w-full border rounded-lg px-3 py-2" rows="2"></textarea>
              </div>
            </div>

            <div class="mt-4">
              <label for="editLicenseFiles" class="block text-sm font-medium mb-1">License Files (JSON)</label>
              <textarea id="editLicenseFiles" class="w-full border rounded-lg px-3 py-2" rows="3" placeholder="JSON format for license files"></textarea>
            </div>
          </div>
        </div>

        <!-- Financial & Tax Tab -->
        <div id="edit-tab-financial" class="edit-tab-content hidden">
          <h4 class="text-lg font-semibold mb-4">Financial & Tax Information</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="editTaxClassification" class="block text-sm font-medium mb-1">Tax Classification</label>
              <select id="editTaxClassification" class="w-full border rounded-lg px-3 py-2">
                <option value="1099">1099 Contractor</option>
                <option value="w2">W2 Employee</option>
              </select>
            </div>
            <div>
              <label for="editTaxIdType" class="block text-sm font-medium mb-1">Tax ID Type</label>
              <select id="editTaxIdType" class="w-full border rounded-lg px-3 py-2">
                <option value="ssn">SSN</option>
                <option value="ein">EIN</option>
              </select>
            </div>
            <div>
              <label for="editTaxId" class="block text-sm font-medium mb-1">Tax ID</label>
              <input type="text" id="editTaxId" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
              <label for="editBankName" class="block text-sm font-medium mb-1">Bank Name</label>
              <input type="text" id="editBankName" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
              <label for="editAccountType" class="block text-sm font-medium mb-1">Account Type</label>
              <select id="editAccountType" class="w-full border rounded-lg px-3 py-2">
                <option value="">Select Type</option>
                <option value="checking">Checking</option>
                <option value="savings">Savings</option>
              </select>
            </div>
            <div>
              <label for="editRoutingNumber" class="block text-sm font-medium mb-1">Routing Number</label>
              <input type="text" id="editRoutingNumber" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
              <label for="editAccountNumber" class="block text-sm font-medium mb-1">Account Number</label>
              <input type="text" id="editAccountNumber" class="w-full border rounded-lg px-3 py-2">
            </div>
          </div>

          <div class="mt-6">
            <h5 class="font-medium mb-2">Tax & Financial Status</h5>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
              <label class="flex items-center space-x-2">
                <input type="checkbox" id="editW9Uploaded" class="rounded">
                <span class="text-sm">W9 Uploaded</span>
              </label>
              <label class="flex items-center space-x-2">
                <input type="checkbox" id="editTaxAcknowledgment" class="rounded">
                <span class="text-sm">Tax Acknowledgment</span>
              </label>
              <label class="flex items-center space-x-2">
                <input type="checkbox" id="editAgreed1099" class="rounded">
                <span class="text-sm">Agreed to 1099</span>
              </label>
              <label class="flex items-center space-x-2">
                <input type="checkbox" id="editAgreedTaxes" class="rounded">
                <span class="text-sm">Agreed to Taxes</span>
              </label>
              <label class="flex items-center space-x-2">
                <input type="checkbox" id="editAgreedBankInfo" class="rounded">
                <span class="text-sm">Agreed to Bank Info</span>
              </label>
            </div>
          </div>
        </div>

        <!-- Agreements Tab -->
        <div id="edit-tab-agreements" class="edit-tab-content hidden">
          <h4 class="text-lg font-semibold mb-4">Agreements & Compliance</h4>

          <div class="space-y-6">
            <div>
              <h5 class="font-medium mb-2">Service Agreements</h5>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <label class="flex items-center space-x-2">
                  <input type="checkbox" id="editAgreedToServiceTerms" class="rounded">
                  <span class="text-sm">Agreed to Service Terms</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" id="editServiceAgreementSigned" class="rounded">
                  <span class="text-sm">Service Agreement Signed</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" id="editComplianceAcknowledged" class="rounded">
                  <span class="text-sm">Compliance Acknowledged</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" id="editWorkflowReviewed" class="rounded">
                  <span class="text-sm">Workflow Reviewed</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" id="editReadyToStart" class="rounded">
                  <span class="text-sm">Ready to Start</span>
                </label>
              </div>
            </div>

            <div>
              <h5 class="font-medium mb-2">Code of Conduct</h5>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <label class="flex items-center space-x-2">
                  <input type="checkbox" id="editCodeOfConductAgreed" class="rounded">
                  <span class="text-sm">Code of Conduct</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" id="editDressCodeAgreed" class="rounded">
                  <span class="text-sm">Dress Code</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" id="editCommunicationStandardsAgreed" class="rounded">
                  <span class="text-sm">Communication Standards</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" id="editPhotoDocumentationAgreed" class="rounded">
                  <span class="text-sm">Photo Documentation</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" id="editNoUpsellAgreed" class="rounded">
                  <span class="text-sm">No Upselling</span>
                </label>
              </div>
            </div>

            <div>
              <h5 class="font-medium mb-2">Safety & Training</h5>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <label class="flex items-center space-x-2">
                  <input type="checkbox" id="editSafetyTrainingCompleted" class="rounded">
                  <span class="text-sm">Safety Training Completed</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" id="editHazardReportingAcknowledged" class="rounded">
                  <span class="text-sm">Hazard Reporting</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" id="editRefuseUnsafeWorkAcknowledged" class="rounded">
                  <span class="text-sm">Refuse Unsafe Work</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" id="editAgreedSafetyPolicy" class="rounded">
                  <span class="text-sm">Agreed Safety Policy</span>
                </label>
              </div>
            </div>

            <div>
              <h5 class="font-medium mb-2">Quality & Reviews</h5>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <label class="flex items-center space-x-2">
                  <input type="checkbox" id="editReviewImpactUnderstood" class="rounded">
                  <span class="text-sm">Review Impact Understood</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" id="editQualityCommitmentAgreed" class="rounded">
                  <span class="text-sm">Quality Commitment</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" id="editCommunityRespectAgreed" class="rounded">
                  <span class="text-sm">Community Respect</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" id="editAgreedReviewPolicy" class="rounded">
                  <span class="text-sm">Agreed Review Policy</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" id="editAgreedQualityStandards" class="rounded">
                  <span class="text-sm">Agreed Quality Standards</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" id="editAgreedReputation" class="rounded">
                  <span class="text-sm">Agreed Reputation</span>
                </label>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
              <div>
                <label for="editWelcomeCallScheduled" class="block text-sm font-medium mb-1">Welcome Call Date</label>
                <input type="date" id="editWelcomeCallScheduled" class="w-full border rounded-lg px-3 py-2">
              </div>
              <div>
                <label for="editWelcomeCallTime" class="block text-sm font-medium mb-1">Welcome Call Time</label>
                <input type="text" id="editWelcomeCallTime" class="w-full border rounded-lg px-3 py-2">
              </div>
              <div>
                <label for="editServiceAgreementDate" class="block text-sm font-medium mb-1">Service Agreement Date</label>
                <input type="datetime-local" id="editServiceAgreementDate" class="w-full border rounded-lg px-3 py-2">
              </div>
              <div>
                <label for="editAverageRating" class="block text-sm font-medium mb-1">Average Rating</label>
                <input type="number" id="editAverageRating" class="w-full border rounded-lg px-3 py-2" step="0.01" min="0" max="5">
              </div>
              <div>
                <label for="editTotalReviews" class="block text-sm font-medium mb-1">Total Reviews</label>
                <input type="number" id="editTotalReviews" class="w-full border rounded-lg px-3 py-2" min="0">
              </div>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="flex gap-3 pt-6 border-t">
          <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium">
            Save All Changes
          </button>
          <button type="button" id="cancelEditHandyman" class="bg-slate-300 text-slate-700 px-6 py-2 rounded-lg hover:bg-slate-400 transition-colors font-medium">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Handyman Details Modal -->
<div id="handymanDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-6xl w-full max-h-[90vh] overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold">Handyman Details</h3>
        <button id="closeHandymanDetailsModal" class="text-slate-500 hover:text-slate-700 text-2xl">&times;</button>
      </div>

      <!-- Loading State -->
      <div id="handymanDetailsLoading" class="text-center py-8">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        <p class="mt-2 text-slate-600">Loading handyman details...</p>
      </div>

      <!-- Details Content -->
      <div id="handymanDetailsContent" class="hidden">
        <!-- Basic Information Section -->
        <div class="mb-8">
          <h4 class="text-xl font-semibold mb-4 text-slate-800 border-b border-slate-200 pb-2">Basic Information</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="basicInfoSection">
            <!-- Populated by JavaScript -->
          </div>
        </div>

        <!-- Performance Metrics Section -->
        <div class="mb-8">
          <h4 class="text-xl font-semibold mb-4 text-slate-800 border-b border-slate-200 pb-2">Performance Metrics</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="metricsSection">
            <!-- Populated by JavaScript -->
          </div>
        </div>

        <!-- Onboarding Information Section -->
        <div class="mb-8">
          <h4 class="text-xl font-semibold mb-4 text-slate-800 border-b border-slate-200 pb-2">Onboarding Information</h4>
          <div id="onboardingSection">
            <!-- Populated by JavaScript -->
          </div>
        </div>

        <!-- Uploaded Files Section -->
        <div class="mb-8">
          <h4 class="text-xl font-semibold mb-4 text-slate-800 border-b border-slate-200 pb-2">Uploaded Files & Documents</h4>
          <div id="filesSection">
            <!-- Populated by JavaScript -->
          </div>
        </div>

        <!-- Recent Tasks Section -->
        <div class="mb-8">
          <h4 class="text-xl font-semibold mb-4 text-slate-800 border-b border-slate-200 pb-2">Recent Tasks</h4>
          <div id="recentTasksSection">
            <!-- Populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Photo Modal -->
<div id="photoModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4">
  <div class="max-w-4xl w-full h-full flex flex-col">
    <div class="flex justify-between items-center mb-4">
      <h3 id="photoModalTitle" class="text-xl font-bold text-white">Photo</h3>
      <button onclick="closePhotoModal()" class="text-white hover:text-gray-300 text-2xl">&times;</button>
    </div>
    <div class="flex-1 flex items-center justify-center">
      <img id="photoModalImage" src="" alt="Task Photo" class="max-w-full max-h-full object-contain rounded-lg">
    </div>
  </div>
</div>

<!-- Bulk Assignment Modal -->
<div id="bulkAssignModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-3xl w-full max-h-96 overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold">Bulk Assign Tasks</h3>
        <button id="closeBulkAssignModal" class="text-slate-500 hover:text-slate-700">‚úï</button>
      </div>

      <div class="mb-4">
        <p class="text-sm text-slate-600">
          <span id="selectedTasksCount">0</span> tasks selected for assignment
        </p>
      </div>

      <form id="bulkAssignForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1">Assign to Handyman *</label>
            <select id="bulkHandymanSelect" required class="w-full border border-slate-200 rounded-lg px-3 py-2">
              <option value="">Choose handyman...</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Priority</label>
            <select id="bulkPriority" class="w-full border border-slate-200 rounded-lg px-3 py-2">
              <option value="normal">Normal</option>
              <option value="high">High</option>
              <option value="urgent">Urgent</option>
            </select>
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Assignment Strategy</label>
          <select id="assignmentStrategy" class="w-full border border-slate-200 rounded-lg px-3 py-2">
            <option value="immediate">Assign All Immediately</option>
            <option value="distributed">Distribute Over Multiple Days</option>
            <option value="workload_based">Based on Current Workload</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">General Notes</label>
          <textarea id="bulkAssignmentNotes" rows="2" class="w-full border border-slate-200 rounded-lg px-3 py-2" placeholder="Notes that will be added to all selected tasks..."></textarea>
        </div>

        <div class="flex gap-3 pt-4">
          <button type="button" id="cancelBulkAssignment" class="flex-1 border border-slate-200 text-slate-600 py-2 px-4 rounded-lg hover:bg-slate-50">
            Cancel
          </button>
          <button type="submit" class="flex-1 bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700">
            Assign Selected Tasks
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Handyman Modal -->
<div id="addHandymanModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-xl">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-bold">Add New Handyman</h3>
      <button onclick="closeAddHandymanModal()" class="text-slate-400 hover:text-slate-600">
        <span class="text-xl">√ó</span>
      </button>
    </div>

    <form id="addHandymanForm">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-semibold mb-1">Full Name *</label>
          <input type="text" id="handymanFullName" required class="w-full border border-slate-200 rounded-lg px-3 py-2">
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Email *</label>
          <input type="email" id="handymanEmail" required class="w-full border border-slate-200 rounded-lg px-3 py-2" placeholder="user@example.com">
          <div class="text-xs text-slate-500 mt-1">Must be a valid email format (e.g., name@domain.com)</div>
        </div>

        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
          <div class="flex items-center gap-2 text-blue-800">
            <span>üîê</span>
            <span class="text-sm font-medium">Secure Password Auto-Generated</span>
          </div>
          <p class="text-xs text-blue-600 mt-1">A secure temporary password will be automatically created and shown after account creation.</p>
        </div>

        <div class="bg-orange-50 border border-orange-200 rounded-lg p-3">
          <label class="flex items-center gap-2">
            <input type="checkbox" id="skipEmailConfirmation" class="w-4 h-4 text-blue-600" checked>
            <span class="text-sm font-medium text-orange-800">Skip Email Confirmation</span>
          </label>
          <p class="text-xs text-orange-600 mt-1">‚ö†Ô∏è User will need manual email confirmation in Supabase Dashboard if unchecked</p>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Phone</label>
          <input type="tel" id="handymanPhone" class="w-full border border-slate-200 rounded-lg px-3 py-2">
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">City</label>
          <input type="text" id="handymanCity" class="w-full border border-slate-200 rounded-lg px-3 py-2">
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Skills (comma separated)</label>
          <input type="text" id="handymanSkills" placeholder="plumbing, electrical, carpentry" class="w-full border border-slate-200 rounded-lg px-3 py-2">
        </div>

        <div class="flex gap-3 pt-4">
          <button type="button" onclick="closeAddHandymanModal()" class="flex-1 border border-slate-200 text-slate-600 py-2 px-4 rounded-lg hover:bg-slate-50">
            Cancel
          </button>
          <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">
            Add Handyman
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Task Details Modal -->
<div id="taskDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-4xl w-full max-h-96 overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold">Task Details</h3>
        <button onclick="closeTaskDetailsModal()" class="text-slate-500 hover:text-slate-700">‚úï</button>
      </div>

      <div id="taskDetailContent" class="space-y-4">
        <!-- Task details will be populated here -->
        <div class="text-center py-8 text-slate-500">Loading task details...</div>
      </div>
    </div>
  </div>
</div>

<script>
// Initialize Supabase
const supabaseUrl = 'https://ynbhskdiplwabsksamxa.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InluYmhza2RpcGx3YWJza3NhbXhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2OTYwMjAsImV4cCI6MjA3NTI3MjAyMH0.PedsTR4JQOioRWD28mVafR4I6wmHApUG5q2-Y7G7ljw';
const supabaseAdmin = window.supabase.createClient(supabaseUrl, supabaseKey);

let currentAdminUser = null;
let handymenData = [];
let quotesData = [];

// Admin authentication check
document.addEventListener('DOMContentLoaded', async () => {
  console.log('üîê Admin portal initialized');

  // Check if user is already authenticated and has admin access
  await checkExistingAuth();
});

// Admin login
document.getElementById('adminLoginForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const email = document.getElementById('adminEmail').value.toLowerCase();
  const password = document.getElementById('adminPassword').value;

  try {
    console.log('üîê Attempting admin login for:', email);

    // First authenticate with Supabase
    const { data: authData, error: authError } = await supabaseAdmin.auth.signInWithPassword({
      email: email,
      password: password
    });

    if (authError) {
      console.error('‚ùå Authentication failed:', authError);
      alert('Invalid credentials. Please check your email and password.');
      return;
    }

    // Now check if user exists in admin_users table using the auth UUID
    const authUserId = authData.user.id;

    let { data: adminUser, error } = await supabaseAdmin
      .from('admin_users')
      .select('id, email, full_name, role, is_active')
      .eq('id', authUserId)  // Match by UUID instead of email
      .eq('is_active', true)
      .single();

    // If admin record doesn't exist but auth succeeded, check by email as fallback
    if (error && error.code === 'PGRST116') {
      const { data: adminByEmail, error: emailError } = await supabaseAdmin
        .from('admin_users')
        .select('id, email, full_name, role, is_active')
        .eq('email', email)
        .eq('is_active', true)
        .single();

      if (!emailError && adminByEmail) {
        // Update the admin record to use the correct auth UUID
        const { data: updatedAdmin, error: updateError } = await supabaseAdmin
          .from('admin_users')
          .update({ id: authUserId })
          .eq('email', email)
          .select()
          .single();

        if (!updateError) {
          adminUser = updatedAdmin;
          console.log('‚úÖ Admin record updated with auth UUID');
        }
      }
    }

    if (error || !adminUser) {
      console.error('‚ùå Admin user not found or inactive:', error);
      alert('Access denied: You are not authorized to access the admin portal.');
      return;
    }

    // Successful authentication
    currentAdminUser = {
      id: adminUser.id,
      email: adminUser.email,
      name: adminUser.full_name,
      role: adminUser.role
    };

    console.log('‚úÖ Admin login successful:', adminUser.role);

    // Update last login time
    await supabaseAdmin
      .from('admin_users')
      .update({ last_login_at: new Date().toISOString() })
      .eq('id', adminUser.id);

    // Show dashboard
    document.getElementById('adminLoginPage').classList.add('hidden');
    document.getElementById('adminDashboard').classList.remove('hidden');
    document.getElementById('adminUserName').textContent = `${currentAdminUser.name} (${currentAdminUser.role})`;

    // Load dashboard data
    loadDashboardData();

  } catch (error) {
    console.error('‚ùå Login error:', error);
    alert('Login failed: ' + error.message);
  }
});

// Check if user is already authenticated
async function checkExistingAuth() {
  try {
    console.log('üîç Checking existing authentication...');

    const { data: { user } } = await supabaseAdmin.auth.getUser();

    if (user) {
      console.log('‚úÖ User already authenticated:', user.email);

      // Check if user has admin access
      const { data: adminUser, error } = await supabaseAdmin
        .from('admin_users')
        .select('id, email, full_name, role, is_active')
        .eq('id', user.id)
        .eq('is_active', true)
        .single();

      if (!error && adminUser) {
        console.log('‚úÖ Admin access confirmed:', adminUser.role);
        await setupAdminUser(adminUser);
        return;
      }

      // Fallback: check by email for existing records
      console.log('üîÑ Trying email-based lookup as fallback...');
      const { data: adminUserByEmail, error: emailError } = await supabaseAdmin
        .from('admin_users')
        .select('id, email, full_name, role, is_active')
        .eq('email', user.email.toLowerCase())
        .eq('is_active', true)
        .single();

      if (!emailError && adminUserByEmail) {
        console.log('‚úÖ Admin access confirmed by email:', adminUserByEmail.role);
        await setupAdminUser(adminUserByEmail);
        return;
      }

      console.log('‚ùå User authenticated but no admin access');
      showAccessDeniedMessage();
      return;
    }

    console.log('‚ÑπÔ∏è No existing authentication found');
    // Show login form
    document.getElementById('adminLoginPage').classList.remove('hidden');

  } catch (error) {
    console.error('‚ùå Error checking existing auth:', error);
    document.getElementById('adminLoginPage').classList.remove('hidden');
  }
}

// Helper function to setup admin user and show dashboard
async function setupAdminUser(adminUser) {
  // Set current admin user
  currentAdminUser = {
    id: adminUser.id,
    email: adminUser.email,
    name: adminUser.full_name,
    role: adminUser.role
  };

  // Update last login time
  await supabaseAdmin
    .from('admin_users')
    .update({ last_login_at: new Date().toISOString() })
    .eq('id', adminUser.id);

  // Show dashboard directly
  document.getElementById('adminLoginPage').classList.add('hidden');
  document.getElementById('adminDashboard').classList.remove('hidden');
  document.getElementById('adminUserName').textContent = `${currentAdminUser.name} (${currentAdminUser.role})`;

  // Load dashboard data
  loadDashboardData();
}

// Show access denied message instead of login form
function showAccessDeniedMessage() {
  const loginPage = document.getElementById('adminLoginPage');
  loginPage.innerHTML = `
    <div class="bg-white rounded-2xl p-8 shadow-soft border border-slate-100 w-full max-w-md">
      <div class="text-center mb-6">
        <img src="images/helpinghands_logo.png" alt="SendAHandyman" class="h-16 w-auto mx-auto mb-4" />
        <h1 class="text-2xl font-bold mb-2 text-red-600">Access Denied</h1>
        <p class="text-slate-600">You don't have admin permissions</p>
      </div>
      <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
        <p class="text-sm text-red-700">
          Your account doesn't have administrative privileges. Contact your system administrator to request access.
        </p>
      </div>
      <button onclick="window.close()" class="w-full bg-slate-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-slate-700 transition-colors">
        Close Window
      </button>
    </div>
  `;
  loginPage.classList.remove('hidden');
}

// Admin logout
document.getElementById('adminLogoutBtn').addEventListener('click', async () => {
  try {
    // Don't sign out from Supabase completely - just close admin portal
    // This preserves the handyman dashboard session

    currentAdminUser = null;

    // Close the admin window if opened from dashboard
    if (window.opener) {
      window.close();
    } else {
      // If accessed directly, show login page
      document.getElementById('adminDashboard').classList.add('hidden');
      document.getElementById('adminLoginPage').classList.remove('hidden');
      document.getElementById('adminEmail').value = '';
      document.getElementById('adminPassword').value = '';
    }

    console.log('üîê Admin portal closed');
  } catch (error) {
    console.error('‚ùå Logout error:', error);
  }
});

// Navigation
document.querySelectorAll('.admin-nav-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    const sectionId = e.target.id.replace('nav-', 'section-');

    // Update nav buttons
    document.querySelectorAll('.admin-nav-btn').forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');

    // Update sections
    document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
    document.getElementById(sectionId).classList.add('active');

    // Track section view
    AdminAnalytics.trackSectionView(sectionId.replace('section-', ''));

    // Load section-specific data
    loadSectionData(sectionId);
  });
});

// Load dashboard data
async function loadDashboardData() {
  console.log('üìä Loading dashboard data...');

  try {
    // Load metrics
    await loadMetrics();
    await loadRecentActivity();

    // Load initial section data
    loadSectionData('section-overview');

  } catch (error) {
    console.error('Error loading dashboard data:', error);
  }
}

// Load metrics
async function loadMetrics() {
  try {
    // Count active handymen based on onboarding and skills
    const { data: handymen, error: handymenError } = await supabaseAdmin
      .from('handymen')
      .select('id, onboarding_completed, skills');

    if (!handymenError) {
      const completedHandymen = handymen?.filter(h => h.onboarding_completed) || [];
      document.getElementById('activeHandymenCount').textContent = completedHandymen.length;
    }

    // Count active tasks
    const { data: tasks, error: tasksError } = await supabaseAdmin
      .from('tasks')
      .select('id, status')
      .in('status', ['pending', 'in_progress']);

    if (!tasksError) {
      document.getElementById('activeTasksCount').textContent = tasks?.length || 0;
    }

    // Count pending quotes from quotes table
    const { data: quotes, error: quotesError } = await supabaseAdmin
      .from('quotes')
      .select('id, status')
      .eq('status', 'pending');

    if (!quotesError) {
      document.getElementById('pendingQuotesCount').textContent = quotes?.length || 0;
    } else {
      console.warn('Quotes table may not exist:', quotesError);
      document.getElementById('pendingQuotesCount').textContent = '0';
    }

    // Calculate today's revenue from multiple sources
    const today = new Date();
    const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const todayEnd = new Date(todayStart);
    todayEnd.setDate(todayEnd.getDate() + 1);

    let todayRevenue = 0;

    // Method 1: Check completed tasks
    const { data: completedTasks, error: revenueError } = await supabaseAdmin
      .from('tasks')
      .select('total_amount, amount, price, final_amount')
      .eq('status', 'completed')
      .gte('updated_at', todayStart.toISOString())
      .lt('updated_at', todayEnd.toISOString());

    if (!revenueError && completedTasks) {
      todayRevenue += completedTasks.reduce((sum, task) => {
        const amount = task.total_amount || task.amount || task.price || task.final_amount || 0;
        return sum + parseFloat(amount);
      }, 0);
    }

    // Method 2: Check paid quotes as backup revenue source
    try {
      const { data: paidQuotes, error: quotesError } = await supabaseAdmin
        .from('quotes')
        .select('custom_amount')
        .eq('status', 'paid')
        .gte('updated_at', todayStart.toISOString())
        .lt('updated_at', todayEnd.toISOString());

      if (!quotesError && paidQuotes) {
        todayRevenue += paidQuotes.reduce((sum, quote) => sum + (parseFloat(quote.custom_amount) || 0), 0);
      }
    } catch (quotesErr) {
      console.warn('Quotes table not accessible for revenue calculation');
    }

    // Method 3: Check any tasks with payment_intent_id (indicating payment was made)
    const { data: paidTasks, error: paidError } = await supabaseAdmin
      .from('tasks')
      .select('total_amount, amount, price')
      .not('payment_intent_id', 'is', null)
      .gte('created_at', todayStart.toISOString())
      .lt('created_at', todayEnd.toISOString());

    if (!paidError && paidTasks) {
      const paidTasksRevenue = paidTasks.reduce((sum, task) => {
        const amount = task.total_amount || task.amount || task.price || 0;
        return sum + parseFloat(amount);
      }, 0);

      // Only add if we haven't already counted these tasks
      if (completedTasks?.length === 0) {
        todayRevenue += paidTasksRevenue;
      }
    }

    document.getElementById('todayRevenue').textContent = `$${todayRevenue.toFixed(2)}`;
    console.log(`üìä Today's Revenue: $${todayRevenue.toFixed(2)} from ${completedTasks?.length || 0} completed tasks and ${paidQuotes?.length || 0} paid quotes`);

  } catch (error) {
    console.error('Error loading metrics:', error);
  }
}

// Load recent activity
async function loadRecentActivity() {
  const activityContainer = document.getElementById('recentActivity');

  try {
    const activities = [];

    // Get recent completed tasks (with error handling)
    let recentTasks = [];
    try {
      const { data: tasks, error: tasksError } = await supabaseAdmin
        .from('tasks')
        .select('id, task_category, status, total_amount, updated_at, handyman_id')
        .eq('status', 'completed')
        .order('updated_at', { ascending: false })
        .limit(3);

      if (!tasksError && tasks) {
        // Get handyman names for the tasks that have assignments
        const handymanIds = [...new Set(tasks.filter(t => t.handyman_id).map(t => t.handyman_id))];
        let handymenMap = {};

        if (handymanIds.length > 0) {
          const { data: handymen } = await supabaseAdmin
            .from('handymen')
            .select('id, full_name')
            .in('id', handymanIds);

          if (handymen) {
            handymenMap = Object.fromEntries(handymen.map(h => [h.id, h.full_name]));
          }
        }

        // Add handyman names to tasks
        recentTasks = tasks.map(task => ({
          ...task,
          handyman_name: task.handyman_id ? handymenMap[task.handyman_id] : null
        }));
      } else {
        console.warn('Tasks query failed, trying fallback:', tasksError);
        // Fallback: get tasks with minimal columns (no service_type)
        const { data: simpleTasks, error: simpleError } = await supabaseAdmin
          .from('tasks')
          .select('id, status, total_amount, updated_at')
          .eq('status', 'completed')
          .order('updated_at', { ascending: false })
          .limit(3);

        if (!simpleError && simpleTasks) {
          recentTasks = simpleTasks.map(task => ({
            ...task,
            task_category: 'Task', // Default task category
            handyman_name: 'Unknown'
          }));
        }
      }
    } catch (err) {
      console.error('Error in tasks query:', err);
      recentTasks = [];
    }

    if (recentTasks && recentTasks.length > 0) {
      recentTasks.forEach(task => {
        const handymanName = task.handyman_name || 'Unknown';
        activities.push({
          type: 'task_completed',
          message: `${task.task_category || 'Task'} completed by ${handymanName} - $${task.total_amount || 0}`,
          time: formatTimeAgo(task.updated_at),
          timestamp: task.updated_at
        });
      });
    }

    // Get recent quotes
    const { data: recentQuotes, error: quotesError } = await supabaseAdmin
      .from('quotes')
      .select('quote_id, service_type, custom_amount, created_at')
      .order('created_at', { ascending: false })
      .limit(2);

    if (!quotesError && recentQuotes) {
      recentQuotes.forEach(quote => {
        activities.push({
          type: 'quote_created',
          message: `New quote created for ${quote.service_type} - $${quote.custom_amount}`,
          time: formatTimeAgo(quote.created_at),
          timestamp: quote.created_at
        });
      });
    }

    // Get recent handymen who joined
    const { data: recentHandymen, error: handymenError } = await supabaseAdmin
      .from('handymen')
      .select('full_name, created_at')
      .order('created_at', { ascending: false })
      .limit(2);

    if (!handymenError && recentHandymen) {
      recentHandymen.forEach(handyman => {
        activities.push({
          type: 'handyman_joined',
          message: `${handyman.full_name} joined as handyman`,
          time: formatTimeAgo(handyman.created_at),
          timestamp: handyman.created_at
        });
      });
    }

    // Sort all activities by time (newest first) and limit to 5
    activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    const displayActivities = activities.slice(0, 5);

    // If no real activities, show a placeholder
    if (displayActivities.length === 0) {
      activityContainer.innerHTML = `
        <div class="flex items-center justify-center p-8 text-gray-500">
          <div class="text-center">
            <p class="text-sm">No recent activity</p>
            <p class="text-xs mt-1">Activity will appear here as tasks are completed</p>
          </div>
        </div>
      `;
      return;
    }

    activityContainer.innerHTML = displayActivities.map(activity => `
      <div class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg">
        <div class="text-lg">
          ${activity.type === 'task_completed' ? '‚úÖ' :
            activity.type === 'quote_created' ? 'üí∞' :
            activity.type === 'handyman_joined' ? 'üë∑' : 'üí≥'}
        </div>
        <div class="flex-1">
          <p class="text-sm font-medium">${activity.message}</p>
          <p class="text-xs text-slate-500">${activity.time}</p>
        </div>
      </div>
    `).join('');

  } catch (error) {
    console.error('Error loading recent activity:', error);
    activityContainer.innerHTML = `
      <div class="flex items-center justify-center p-8 text-red-500">
        <p class="text-sm">Error loading activity data</p>
      </div>
    `;
  }
}

// Helper function to format time ago
function formatTimeAgo(timestamp) {
  const now = new Date();
  const time = new Date(timestamp);
  const diffMs = now - time;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins} minute${diffMins === 1 ? '' : 's'} ago`;
  if (diffHours < 24) return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
  if (diffDays < 7) return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
  return time.toLocaleDateString();
}

// Load section-specific data
function loadSectionData(sectionId) {
  switch (sectionId) {
    case 'section-handymen':
      loadHandymenData();
      break;
    case 'section-quotes':
      loadQuotesData();
      break;
    case 'section-tasks':
      loadTasksData();
      break;
    case 'section-analytics':
      loadAnalyticsData();
      break;
  }
}

// Load handymen data
async function loadHandymenData() {
  console.log('üë• Loading handymen data...');

  try {
    console.log('üîç Running handymen query...');

    // First, try to get a count to see if RLS is blocking
    const { count, error: countError } = await supabaseAdmin
      .from('handymen')
      .select('*', { count: 'exact', head: true });

    console.log('üìä Total handymen count (with RLS):', count);
    if (countError) console.error('Count error:', countError);

    const { data: handymen, error } = await supabaseAdmin
      .from('handymen')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) {
      console.error('‚ùå Handymen query error:', error);
      throw error;
    }

    handymenData = handymen || [];
    window.currentHandymenData = handymenData; // Make available for duplicate checking
    console.log('üìä Loaded handymen:', handymenData.length, 'records');

    // Log status breakdown
    const completedCount = handymenData.filter(h => h.onboarding_completed).length;
    const pendingCount = handymenData.filter(h => !h.onboarding_completed).length;
    console.log(`üìä Onboarding status: ${completedCount} completed, ${pendingCount} pending`);

    handymenData.forEach(h => {
      const hasSkills = h.skills &&
        ((Array.isArray(h.skills) && h.skills.length > 0) ||
         (typeof h.skills === 'string' && h.skills.trim().length > 0));
      console.log(`üë§ ${h.full_name}: onboarding=${h.onboarding_completed ? 'COMPLETED' : 'PENDING'}, skills=${hasSkills ? 'SET' : 'NEEDS SKILLS'} (${Array.isArray(h.skills) ? h.skills.length + ' items' : typeof h.skills})`);
    });

    renderHandymenTable();

  } catch (error) {
    console.error('Error loading handymen:', error);
    document.getElementById('handymenTableBody').innerHTML = `
      <tr><td colspan="6" class="text-center py-8 text-red-500">Error loading handymen data</td></tr>
    `;
  }
}

// Render handymen table
function renderHandymenTable() {
  const tbody = document.getElementById('handymenTableBody');

  if (handymenData.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-500">No handymen found</td></tr>';
    return;
  }

  tbody.innerHTML = handymenData.map(handyman => `
    <tr class="border-b border-slate-200 hover:bg-slate-50">
      <td class="py-3 px-4">
        <div class="font-semibold">${handyman.full_name || 'N/A'}</div>
        <div class="text-sm text-slate-500">${handyman.email || 'N/A'}</div>
      </td>
      <td class="py-3 px-4">
        <div class="text-sm">${handyman.phone || 'N/A'}</div>
        <div class="text-xs text-slate-500">${handyman.city || 'N/A'}</div>
      </td>
      <td class="py-3 px-4">
        ${getHandymanStatusBadge(handyman)}
      </td>
      <td class="py-3 px-4">
        <div class="text-sm">${formatSkills(handyman.skills)}</div>
        <div class="text-xs text-slate-500">${handyman.specialties || ''}</div>
      </td>
      <td class="py-3 px-4">
        <div class="text-sm">${handyman.created_at ? new Date(handyman.created_at).toLocaleDateString() : 'N/A'}</div>
      </td>
      <td class="py-3 px-4">
        <div class="flex flex-wrap gap-1">
          <button onclick="viewHandymanDetails('${handyman.id}')" class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs hover:bg-green-200 transition-colors">
            View Details
          </button>
          <button class="edit-handyman-btn bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs hover:bg-blue-200 transition-colors" data-handyman-id="${handyman.id}">
            Edit
          </button>
          <button onclick="toggleHandymanStatus('${handyman.id}')" class="bg-orange-100 text-orange-800 px-2 py-1 rounded text-xs hover:bg-orange-200 transition-colors">
            ${handyman.is_active ? 'Suspend' : 'Activate'}
          </button>
        </div>
      </td>
    </tr>
  `).join('');
}

// Load quotes data
async function loadQuotesData() {
  console.log('üí∞ Loading quotes data...');

  try {
    // Load actual quotes from database
    const { data: quotes, error: quotesError } = await supabaseAdmin
      .from('quotes')
      .select('*')
      .order('created_at', { ascending: false });

    if (quotesError) {
      console.error('‚ùå Error loading quotes:', quotesError);
      // Fallback to empty array instead of mock data
      quotesData = [];
    } else {
      console.log(`üìä Loaded ${quotes.length} quotes from database`);
      quotesData = quotes || [];
    }

    renderQuotesTable();

  } catch (error) {
    console.error('‚ùå Failed to load quotes:', error);
    quotesData = [];
    renderQuotesTable();
  }
}

// Render quotes table
function renderQuotesTable() {
  const tbody = document.getElementById('quotesTableBody');

  if (quotesData.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-slate-500">No quotes found</td></tr>';
    return;
  }

  tbody.innerHTML = quotesData.map(quote => `
    <tr class="border-b border-slate-200 hover:bg-slate-50">
      <td class="py-3 px-4">
        <div class="font-mono text-sm">${quote.quote_id || quote.id}</div>
      </td>
      <td class="py-3 px-4">
        <div class="font-semibold">${quote.customer_name}</div>
        <div class="text-sm text-slate-500">${quote.customer_phone}</div>
      </td>
      <td class="py-3 px-4">${quote.service_type}</td>
      <td class="py-3 px-4 font-semibold">$${quote.custom_amount || quote.amount}</td>
      <td class="py-3 px-4">
        <span class="status-badge status-${quote.status}">
          ${quote.status.toUpperCase()}
        </span>
      </td>
      <td class="py-3 px-4">
        <div class="text-sm">${new Date(quote.created_at).toLocaleDateString()}</div>
      </td>
      <td class="py-3 px-4">
        <div class="flex items-center gap-2">
          <input type="text" value="${window.location.origin}/quote.html?token=${quote.quote_token}" readonly class="flex-1 text-xs font-mono bg-slate-50 border border-slate-200 rounded px-2 py-1 max-w-48">
          <button onclick="copyQuoteLink('${quote.quote_token}')" class="text-blue-600 hover:text-blue-800 text-xs px-2 py-1 border border-blue-200 rounded hover:bg-blue-50" title="Copy link">
            üìã
          </button>
        </div>
      </td>
      <td class="py-3 px-4">
        <div class="flex gap-2">
          <button onclick="resendQuote('${quote.id}')" class="text-green-600 hover:text-green-800 text-sm">Resend</button>
          ${quote.status === 'pending' ?
            `<button onclick="changeQuoteStatus('${quote.id}', 'closed')" class="text-red-600 hover:text-red-800 text-sm font-medium">Mark Closed</button>
             <button onclick="changeQuoteStatus('${quote.id}', 'expired')" class="text-orange-600 hover:text-orange-800 text-sm">Mark Expired</button>` :
            ''
          }
        </div>
      </td>
    </tr>
  `).join('');
}

// Global chart instances for cleanup
let revenueChart = null;
let conversionChart = null;

// Load analytics data
async function loadAnalyticsData() {
  console.log('üìà Loading analytics data...');

  try {
    // Destroy existing charts before creating new ones
    if (revenueChart) {
      revenueChart.destroy();
      revenueChart = null;
    }
    if (conversionChart) {
      conversionChart.destroy();
      conversionChart = null;
    }
    // Get real revenue data from multiple sources
    let allRevenueTasks = [];

    // Method 1: Completed tasks
    const { data: completedTasks, error: completedError } = await supabaseAdmin
      .from('tasks')
      .select('total_amount, amount, price, completed_at, created_at, updated_at')
      .eq('status', 'completed')
      .order('updated_at', { ascending: false });

    if (!completedError && completedTasks) {
      allRevenueTasks = allRevenueTasks.concat(
        completedTasks.map(task => ({
          amount: task.total_amount || task.amount || task.price || 0,
          date: task.completed_at || task.updated_at || task.created_at
        })).filter(task => task.amount > 0)
      );
    }

    // Method 2: Paid quotes
    try {
      const { data: paidQuotes, error: quotesError } = await supabaseAdmin
        .from('quotes')
        .select('custom_amount, updated_at, created_at')
        .eq('status', 'paid')
        .order('updated_at', { ascending: false });

      if (!quotesError && paidQuotes) {
        allRevenueTasks = allRevenueTasks.concat(
          paidQuotes.map(quote => ({
            amount: parseFloat(quote.custom_amount) || 0,
            date: quote.updated_at || quote.created_at
          })).filter(quote => quote.amount > 0)
        );
      }
    } catch (quotesErr) {
      console.warn('Quotes not accessible for analytics');
    }

    // Method 3: Tasks with payment data
    const { data: paidTasks, error: paidError } = await supabaseAdmin
      .from('tasks')
      .select('total_amount, amount, price, created_at, updated_at')
      .not('payment_intent_id', 'is', null)
      .order('created_at', { ascending: false });

    if (!paidError && paidTasks) {
      // Only add if we don't already have completed task data
      if (completedTasks?.length === 0) {
        allRevenueTasks = allRevenueTasks.concat(
          paidTasks.map(task => ({
            amount: task.total_amount || task.amount || task.price || 0,
            date: task.updated_at || task.created_at
          })).filter(task => task.amount > 0)
        );
      }
    }

    const error = completedError;

    if (error) {
      console.error('Error loading analytics data:', error);
      // Create charts with empty data if real data fails
      createChartsWithData([]);
      return;
    }

    // Process real data for charts
    console.log(`üìä Analytics found ${allRevenueTasks.length} revenue transactions`);
    createChartsWithData(allRevenueTasks || []);

  } catch (error) {
    console.error('Error in loadAnalyticsData:', error);
    // Create charts with empty data
    createChartsWithData([]);
  }
}

// Create charts with provided data
function createChartsWithData(revenueTransactions) {
  // Process revenue data by week
  const weeks = [];
  const revenueData = [];

  if (revenueTransactions.length > 0) {
    // Group by week and calculate revenue
    const now = new Date();

    for (let i = 3; i >= 0; i--) {
      const weekStart = new Date(now);
      weekStart.setDate(now.getDate() - (i + 1) * 7);
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekStart.getDate() + 7);

      const weekLabel = `Week ${4 - i}`;
      weeks.push(weekLabel);

      const weekRevenue = revenueTransactions
        .filter(transaction => {
          const transactionDate = new Date(transaction.date);
          return transactionDate >= weekStart && transactionDate < weekEnd;
        })
        .reduce((sum, transaction) => sum + (parseFloat(transaction.amount) || 0), 0);

      revenueData.push(weekRevenue);
      console.log(`üìÖ ${weekLabel}: $${weekRevenue.toFixed(2)} from ${revenueTransactions.filter(t => {
        const d = new Date(t.date);
        return d >= weekStart && d < weekEnd;
      }).length} transactions`);
    }
  } else {
    // No data available - show empty chart
    weeks.push('Week 1', 'Week 2', 'Week 3', 'Week 4');
    revenueData.push(0, 0, 0, 0);
  }

  // Revenue chart
  const revenueCtx = document.getElementById('revenueChart').getContext('2d');
  revenueChart = new Chart(revenueCtx, {
    type: 'line',
    data: {
      labels: weeks,
      datasets: [{
        label: 'Revenue ($)',
        data: revenueData,
        borderColor: '#10b981',
        backgroundColor: 'rgba(16, 185, 129, 0.1)',
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: false
        }
      }
    }
  });

  // Conversion chart
  const conversionCtx = document.getElementById('conversionChart').getContext('2d');
  conversionChart = new Chart(conversionCtx, {
    type: 'doughnut',
    data: {
      labels: ['Converted', 'Pending', 'Expired'],
      datasets: [{
        data: [65, 25, 10],
        backgroundColor: ['#10b981', '#f59e0b', '#ef4444']
      }]
    },
    options: {
      responsive: true
    }
  });
}

// Quote management functions
document.getElementById('createNewQuote').addEventListener('click', () => {
  document.getElementById('createQuoteModal').classList.remove('hidden');
});

document.getElementById('quickCreateQuote').addEventListener('click', () => {
  document.getElementById('createQuoteModal').classList.remove('hidden');
});

document.getElementById('closeQuoteModal').addEventListener('click', () => {
  document.getElementById('createQuoteModal').classList.add('hidden');
});

document.getElementById('cancelQuoteCreation').addEventListener('click', () => {
  document.getElementById('createQuoteModal').classList.add('hidden');
});

// Quote success modal event listeners
document.getElementById('closeQuoteSuccessModal').addEventListener('click', () => {
  document.getElementById('quoteSuccessModal').classList.add('hidden');
});

document.getElementById('copyQuoteSuccessLink').addEventListener('click', () => {
  copyQuoteSuccessLink();
});

// Create quote form
document.getElementById('createQuoteForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const quoteData = {
    customer_name: document.getElementById('quoteCustomerName').value,
    customer_phone: document.getElementById('quoteCustomerPhone').value,
    customer_email: document.getElementById('quoteCustomerEmail').value,
    service_type: document.getElementById('quoteServiceType').value,
    amount: parseFloat(document.getElementById('quoteAmount').value),
    description: document.getElementById('quoteDescription').value,
    expiry_days: parseInt(document.getElementById('quoteExpiry').value)
  };

  try {
    // Call the create quote function
    const response = await fetch('/.netlify/functions/admin-create-quote', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(quoteData)
    });

    if (response.ok) {
      const result = await response.json();
      const quoteLink = `${window.location.origin}/quote.html?token=${result.quote_token}`;

      // Show success modal with copy functionality
      showQuoteSuccessModal(quoteLink, result);

      // Reset form and close create modal
      document.getElementById('createQuoteForm').reset();
      document.getElementById('createQuoteModal').classList.add('hidden');

      // Reload quotes data
      loadQuotesData();
    } else {
      throw new Error('Failed to create quote');
    }

  } catch (error) {
    console.error('Error creating quote:', error);
    alert('Failed to create quote: ' + error.message);
  }
});

// Initialize charts with fallback data (only used if analytics data fails)
function initializeCharts() {
  // Only initialize if charts don't already exist
  if (revenueChart || conversionChart) {
    console.log('Charts already initialized, skipping...');
    return;
  }

  // Revenue chart with fallback data
  const revenueCtx = document.getElementById('revenueChart').getContext('2d');
  revenueChart = new Chart(revenueCtx, {
    type: 'line',
    data: {
      labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
      datasets: [{
        label: 'Revenue ($)',
        data: [0, 0, 0, 0], // Show zeros instead of fake data
        borderColor: '#10b981',
        backgroundColor: 'rgba(16, 185, 129, 0.1)',
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return '$' + value;
            }
          }
        }
      }
    }
  });
}

// Get handyman status badge based on ONBOARDING completion only
function getHandymanStatusBadge(handyman) {
  let statusClass, statusText;

  if (handyman.onboarding_completed) {
    statusClass = 'bg-green-100 text-green-800';
    statusText = 'COMPLETED';
  } else {
    statusClass = 'bg-red-100 text-red-800';
    statusText = 'PENDING';
  }

  return `<span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">${statusText}</span>`;
}

// Format skills for display
function formatSkills(skills) {
  if (!skills) return '<span class="text-red-600 font-medium">NEEDS SKILLS</span>';

  if (Array.isArray(skills)) {
    if (skills.length === 0) return '<span class="text-red-600 font-medium">NEEDS SKILLS</span>';
    return skills.join(', ').replace(/-/g, ' ');
  }

  if (typeof skills === 'string') {
    const trimmed = skills.trim();
    return trimmed || '<span class="text-red-600 font-medium">NEEDS SKILLS</span>';
  }

  return '<span class="text-red-600 font-medium">NEEDS SKILLS</span>';
}

// Helper functions
function updateServicePricing() {
  const serviceSelect = document.getElementById('quoteServiceType');
  const amountInput = document.getElementById('quoteAmount');
  const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];

  if (selectedOption && selectedOption.dataset.price) {
    amountInput.value = selectedOption.dataset.price;
  } else {
    amountInput.value = '';
  }
}

function showNotification(message, type = 'info') {
  // Create notification element
  const notification = document.createElement('div');
  notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-semibold ${
    type === 'success' ? 'bg-green-600' :
    type === 'error' ? 'bg-red-600' :
    'bg-blue-600'
  } transform translate-x-full opacity-0 transition-all duration-300`;
  notification.textContent = message;

  document.body.appendChild(notification);

  // Show notification
  setTimeout(() => {
    notification.classList.remove('translate-x-full', 'opacity-0');
  }, 100);

  // Hide notification after 3 seconds
  setTimeout(() => {
    notification.classList.add('translate-x-full', 'opacity-0');
    setTimeout(() => {
      document.body.removeChild(notification);
    }, 300);
  }, 3000);
}

function showQuoteSuccessModal(quoteLink, quoteData) {
  const modal = document.getElementById('quoteSuccessModal');
  const linkInput = document.getElementById('quoteSuccessLink');

  linkInput.value = quoteLink;
  modal.classList.remove('hidden');
}

function copyQuoteSuccessLink() {
  const linkInput = document.getElementById('quoteSuccessLink');
  linkInput.select();
  navigator.clipboard.writeText(linkInput.value).then(() => {
    showNotification('Quote link copied to clipboard!', 'success');
  }).catch(() => {
    // Fallback for older browsers
    document.execCommand('copy');
    showNotification('Quote link copied to clipboard!', 'success');
  });
}

function copyQuoteLink(quoteToken) {
  const link = `${window.location.origin}/quote.html?token=${quoteToken}`;
  navigator.clipboard.writeText(link).then(() => {
    showNotification('Quote link copied to clipboard!', 'success');
  }).catch(() => {
    // Fallback for older browsers
    const textArea = document.createElement('textarea');
    textArea.value = link;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    showNotification('Quote link copied to clipboard!', 'success');
  });
}

function resendQuote(quoteId) {
  alert('Resend functionality would be implemented here');
}

// Change quote status (mark as closed, expired, etc.)
async function changeQuoteStatus(quoteId, newStatus) {
  try {
    // Confirm with user before changing status
    const statusText = newStatus === 'closed' ? 'closed (client declined)' : newStatus;
    if (!confirm(`Are you sure you want to mark this quote as ${statusText}? This action cannot be undone.`)) {
      return;
    }

    console.log(`üí∞ Changing quote ${quoteId} status to ${newStatus}...`);

    // Update quote status in database
    const { data, error } = await supabaseAdmin
      .from('quotes')
      .update({
        status: newStatus,
        updated_at: new Date().toISOString()
      })
      .eq('id', quoteId)
      .select()
      .single();

    if (error) {
      console.error('Error changing quote status:', error);
      alert(`Failed to change quote status: ${error.message}`);
      return;
    }

    console.log('‚úÖ Quote status changed successfully:', data);

    // Track admin action
    AdminAnalytics.trackQuoteAction(`mark_${newStatus}`, quoteId);

    // Show success message
    const successMessage = newStatus === 'closed'
      ? 'Quote has been marked as closed (client declined)'
      : `Quote has been marked as ${newStatus}`;
    alert(`${successMessage} successfully!`);

    // Refresh the quotes table to reflect the change
    await loadQuotesData();

  } catch (error) {
    console.error('Error changing quote status:', error);
    alert('An unexpected error occurred while changing the quote status. Please try again.');
  }
}

async function editHandyman(handymanId) {
  try {
    console.log(`üîß EDIT HANDYMAN FUNCTION CALLED for handyman: ${handymanId}`);
    console.log('üîß Function triggered successfully');

    // Load handyman data
    const { data: handyman, error } = await supabaseAdmin
      .from('handymen')
      .select('*')
      .eq('id', handymanId)
      .single();

    if (error) throw error;
    if (!handyman) {
      alert('Handyman not found');
      return;
    }

    console.log('üìã Handyman data loaded:', handyman);

    // Initialize tab switching
    initializeEditModalTabs();

    // Populate all form fields with handyman data
    populateEditForm(handyman);

    // Show modal and reset to first tab
    const modal = document.getElementById('editHandymanModal');
    if (!modal) {
      console.error('‚ùå Edit modal not found!');
      alert('Error: Edit modal not found in DOM');
      return;
    }

    // Reset to first tab
    switchEditTab('basic');

    modal.classList.remove('hidden');
    console.log('‚úÖ Edit modal opened');

  } catch (error) {
    console.error('‚ùå Error loading handyman:', error);
    alert('Error loading handyman data: ' + error.message);
  }
}

// Initialize tab switching functionality for edit modal
function initializeEditModalTabs() {
  // Add event listeners to tab buttons if not already added
  const tabButtons = document.querySelectorAll('.edit-tab');

  tabButtons.forEach(button => {
    // Remove existing listeners to avoid duplicates
    button.removeEventListener('click', handleTabClick);
    button.addEventListener('click', handleTabClick);
  });
}

function handleTabClick(e) {
  const tabName = e.target.getAttribute('data-tab');
  switchEditTab(tabName);
}

// Switch between tabs in edit modal
function switchEditTab(tabName) {
  // Hide all tab contents
  const tabContents = document.querySelectorAll('.edit-tab-content');
  tabContents.forEach(content => {
    content.classList.add('hidden');
  });

  // Remove active class from all tabs
  const tabButtons = document.querySelectorAll('.edit-tab');
  tabButtons.forEach(tab => {
    tab.classList.remove('active');
    tab.classList.remove('border-blue-600', 'text-blue-600');
    tab.classList.add('border-transparent', 'text-slate-500');
  });

  // Show selected tab content
  const selectedContent = document.getElementById(`edit-tab-${tabName}`);
  if (selectedContent) {
    selectedContent.classList.remove('hidden');
  }

  // Activate selected tab button
  const selectedTab = document.querySelector(`.edit-tab[data-tab="${tabName}"]`);
  if (selectedTab) {
    selectedTab.classList.add('active');
    selectedTab.classList.add('border-blue-600', 'text-blue-600');
    selectedTab.classList.remove('border-transparent', 'text-slate-500');
  }
}

// Populate all edit form fields
function populateEditForm(handyman) {
  // Helper function to safely set value
  function setValue(elementId, value) {
    const element = document.getElementById(elementId);
    if (element) {
      if (element.type === 'checkbox') {
        element.checked = Boolean(value);
      } else {
        element.value = value || '';
      }
    }
  }

  // Helper function to set date values
  function setDateValue(elementId, dateValue) {
    const element = document.getElementById(elementId);
    if (element && dateValue) {
      try {
        const date = new Date(dateValue);
        if (element.type === 'date') {
          element.value = date.toISOString().split('T')[0];
        } else if (element.type === 'datetime-local') {
          element.value = date.toISOString().slice(0, 16);
        } else {
          element.value = dateValue;
        }
      } catch (e) {
        element.value = '';
      }
    }
  }

  // Basic Info Tab
  setValue('editHandymanId', handyman.id);
  setValue('editFullName', handyman.full_name);
  setValue('editEmail', handyman.email);
  setValue('editPhone', handyman.phone);
  setValue('editHourlyRate', handyman.hourly_rate);
  setValue('editOnboardingStatus', handyman.onboarding_completed ? 'true' : 'false');
  setValue('editActiveStatus', handyman.is_active ? 'true' : 'false');

  // Handle skills (could be array or string)
  let skillsValue = '';
  if (handyman.skills) {
    if (Array.isArray(handyman.skills)) {
      skillsValue = handyman.skills.join(', ');
    } else if (typeof handyman.skills === 'string') {
      skillsValue = handyman.skills;
    }
  }
  setValue('editSkills', skillsValue);

  // Personal Details Tab
  setValue('editFirstName', handyman.first_name);
  setValue('editLastName', handyman.last_name);
  setValue('editMiddleName', handyman.middle_name);
  setValue('editPreferredName', handyman.preferred_name);
  setValue('editGender', handyman.gender);
  setValue('editLanguages', Array.isArray(handyman.languages) ? handyman.languages.join(', ') : handyman.languages);
  setValue('editEmergencyContact', handyman.emergency_contact_name);
  setValue('editEmergencyPhone', handyman.emergency_contact_phone);
  setValue('editEmergencyRelation', handyman.emergency_contact_relationship);
  setDateValue('editDateOfBirth', handyman.date_of_birth);

  // Address fields
  setValue('editStreetAddress', handyman.street_address);
  setValue('editCity', handyman.city);
  setValue('editState', handyman.state);
  setValue('editZipCode', handyman.zip_code);
  setValue('editCountry', handyman.country);

  // Work & Skills Tab
  setValue('editSpecialties', Array.isArray(handyman.specialties) ? handyman.specialties.join(', ') : handyman.specialties);
  setValue('editCertifications', Array.isArray(handyman.certifications) ? handyman.certifications.join(', ') : handyman.certifications);
  setValue('editYearsExperience', handyman.years_of_experience);
  setValue('editAvailability', handyman.availability_schedule);
  setValue('editServiceRadius', handyman.service_radius_miles);
  setValue('editVehicleInfo', handyman.vehicle_info);
  setValue('editToolsOwned', handyman.tools_owned);
  setValue('editLicenseNumber', handyman.license_number);
  setValue('editLicenseState', handyman.license_state);
  setValue('editBondedStatus', handyman.is_bonded);
  setValue('editInsuredStatus', handyman.is_insured);

  // Documents & Files Tab
  setValue('editProfilePhoto', handyman.profile_photo_url);
  setValue('editDriversLicense', handyman.drivers_license_url);
  setValue('editInsuranceCert', handyman.insurance_certificate_url);
  setValue('editBackgroundCheck', handyman.background_check_url);
  setValue('editReferences', handyman.references_json);
  setValue('editPortfolio', handyman.portfolio_json);
  setValue('editResume', handyman.resume_url);
  setValue('editOtherDocs', handyman.other_documents_json);

  // Financial & Tax Tab
  setValue('editSsn', handyman.ssn_last_four);
  setValue('editTaxId', handyman.tax_id_number);
  setValue('editTaxIdType', handyman.tax_id_type);
  setValue('editW9Status', handyman.w9_completed);
  setValue('editPaymentMethod', handyman.preferred_payment_method);
  setValue('editBankName', handyman.bank_name);
  setValue('editAccountType', handyman.account_type);
  setValue('editRoutingNumber', handyman.routing_number);
  setValue('editAccountNumber', handyman.account_number);
  setValue('editPaypalEmail', handyman.paypal_email);
  setValue('editVenmoUsername', handyman.venmo_username);
  setValue('editTaxRate', handyman.default_tax_rate);

  // Agreements Tab
  setValue('editServiceAgreement', handyman.service_agreement_signed);
  setValue('editNda', handyman.nda_signed);
  setValue('editInsuranceWaiver', handyman.insurance_waiver_signed);
  setValue('editDataPrivacy', handyman.data_privacy_consent);
  setValue('editMarketingConsent', handyman.marketing_consent);
  setDateValue('editAgreementDate', handyman.service_agreement_date);
  setDateValue('editNdaDate', handyman.nda_date);
  setDateValue('editInsuranceWaiverDate', handyman.insurance_waiver_date);

  // Additional fields
  setValue('editRating', handyman.rating);
  setValue('editNotes', handyman.admin_notes);
  setValue('editProfileComplete', handyman.profile_completion_percentage);
  setDateValue('editCreatedAt', handyman.created_at);
  setDateValue('editUpdatedAt', handyman.updated_at);

  console.log('‚úÖ All form fields populated with data');
}

async function saveHandymanEdits() {
  try {
    // Helper function to get form value
    function getValue(elementId) {
      const element = document.getElementById(elementId);
      if (!element) return null;

      if (element.type === 'checkbox') {
        return element.checked;
      } else if (element.value === '') {
        return null;
      } else if (element.type === 'number') {
        const num = parseFloat(element.value);
        return isNaN(num) ? null : num;
      }
      return element.value.trim();
    }

    // Helper function to process comma-separated arrays
    function processArrayField(value) {
      if (!value) return null;
      const array = value.split(',').map(s => s.trim()).filter(s => s.length > 0);
      return array.length > 0 ? array : null;
    }

    const handymanId = getValue('editHandymanId');

    // Validate required fields
    const fullName = getValue('editFullName');
    const email = getValue('editEmail');

    if (!fullName || !email) {
      alert('Full name and email are required');
      return;
    }

    if (!handymanId) {
      alert('Handyman ID is missing');
      return;
    }

    console.log('üíæ Collecting comprehensive handyman data for save...');

    // Build comprehensive update object
    const updateData = {
      // Basic Info
      full_name: fullName,
      email: email.toLowerCase(),
      phone: getValue('editPhone'),
      hourly_rate: getValue('editHourlyRate'),
      skills: processArrayField(getValue('editSkills')),
      onboarding_completed: getValue('editOnboardingStatus') === 'true',
      is_active: getValue('editActiveStatus') === 'true',

      // Personal Details
      first_name: getValue('editFirstName'),
      last_name: getValue('editLastName'),
      middle_name: getValue('editMiddleName'),
      preferred_name: getValue('editPreferredName'),
      gender: getValue('editGender'),
      date_of_birth: getValue('editDateOfBirth'),
      languages: processArrayField(getValue('editLanguages')),
      emergency_contact_name: getValue('editEmergencyContact'),
      emergency_contact_phone: getValue('editEmergencyPhone'),
      emergency_contact_relationship: getValue('editEmergencyRelation'),

      // Address
      street_address: getValue('editStreetAddress'),
      city: getValue('editCity'),
      state: getValue('editState'),
      zip_code: getValue('editZipCode'),
      country: getValue('editCountry'),

      // Work & Skills
      specialties: processArrayField(getValue('editSpecialties')),
      certifications: processArrayField(getValue('editCertifications')),
      years_of_experience: getValue('editYearsExperience'),
      availability_schedule: getValue('editAvailability'),
      service_radius_miles: getValue('editServiceRadius'),
      vehicle_info: getValue('editVehicleInfo'),
      tools_owned: getValue('editToolsOwned'),
      license_number: getValue('editLicenseNumber'),
      license_state: getValue('editLicenseState'),
      is_bonded: getValue('editBondedStatus'),
      is_insured: getValue('editInsuredStatus'),

      // Documents & Files
      profile_photo_url: getValue('editProfilePhoto'),
      drivers_license_url: getValue('editDriversLicense'),
      insurance_certificate_url: getValue('editInsuranceCert'),
      background_check_url: getValue('editBackgroundCheck'),
      references_json: getValue('editReferences'),
      portfolio_json: getValue('editPortfolio'),
      resume_url: getValue('editResume'),
      other_documents_json: getValue('editOtherDocs'),

      // Financial & Tax
      ssn_last_four: getValue('editSsn'),
      tax_id_number: getValue('editTaxId'),
      tax_id_type: getValue('editTaxIdType'),
      w9_completed: getValue('editW9Status'),
      preferred_payment_method: getValue('editPaymentMethod'),
      bank_name: getValue('editBankName'),
      account_type: getValue('editAccountType'),
      routing_number: getValue('editRoutingNumber'),
      account_number: getValue('editAccountNumber'),
      paypal_email: getValue('editPaypalEmail'),
      venmo_username: getValue('editVenmoUsername'),
      default_tax_rate: getValue('editTaxRate'),

      // Agreements
      service_agreement_signed: getValue('editServiceAgreement'),
      nda_signed: getValue('editNda'),
      insurance_waiver_signed: getValue('editInsuranceWaiver'),
      data_privacy_consent: getValue('editDataPrivacy'),
      marketing_consent: getValue('editMarketingConsent'),
      service_agreement_date: getValue('editAgreementDate'),
      nda_date: getValue('editNdaDate'),
      insurance_waiver_date: getValue('editInsuranceWaiverDate'),

      // Additional fields
      rating: getValue('editRating'),
      admin_notes: getValue('editNotes'),
      profile_completion_percentage: getValue('editProfileComplete')
    };

    // Remove null/undefined values to avoid overwriting existing data with nulls
    Object.keys(updateData).forEach(key => {
      if (updateData[key] === null || updateData[key] === undefined) {
        delete updateData[key];
      }
    });

    console.log('üíæ Comprehensive update payload prepared:', updateData);

    // Check current user session
    const { data: session } = await supabaseAdmin.auth.getSession();
    console.log('üîê Current session:', {
      user: session.session?.user?.id,
      email: session.session?.user?.email
    });

    // Verify existing record
    const { data: existingRecord, error: readError } = await supabaseAdmin
      .from('handymen')
      .select('*')
      .eq('id', handymanId);

    console.log('üîç Record check before update:', {
      found: existingRecord?.length > 0,
      readError
    });

    if (!existingRecord || existingRecord.length === 0) {
      throw new Error('Handyman record not found or not accessible for updates');
    }

    console.log('üöÄ Using Edge Function for comprehensive admin update...');

    const response = await fetch('/.netlify/functions/admin-update-handyman', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${(await supabaseAdmin.auth.getSession()).data.session?.access_token}`
      },
      body: JSON.stringify({
        handyman_id: handymanId,
        updates: updateData
      })
    });

    if (!response.ok) {
      const errorData = await response.json();
      console.error('‚ùå Edge Function error:', errorData);
      throw new Error(`Update failed: ${errorData.error || response.statusText}`);
    }

    const edgeResult = await response.json();
    console.log('‚úÖ Edge Function update successful:', edgeResult);

    if (!edgeResult.success) {
      throw new Error(edgeResult.error || 'Update failed');
    }

    console.log('‚úÖ Comprehensive handyman update completed successfully');

    // Close modal and refresh data
    closeEditHandymanModal();
    loadHandymenData();
    showNotification('Handyman updated successfully!', 'success');

  } catch (error) {
    console.error('‚ùå Error updating handyman:', error);
    alert('Error updating handyman: ' + error.message);
  }
}

function closeEditHandymanModal() {
  document.getElementById('editHandymanModal').classList.add('hidden');
  document.getElementById('editHandymanForm').reset();
}

// Comprehensive handyman details view
async function viewHandymanDetails(handymanId) {
  try {
    console.log('üìã Loading detailed view for handyman:', handymanId);

    // Show modal and loading state
    document.getElementById('handymanDetailsModal').classList.remove('hidden');
    document.getElementById('handymanDetailsLoading').classList.remove('hidden');
    document.getElementById('handymanDetailsContent').classList.add('hidden');

    // Fetch comprehensive handyman data
    const { data: handyman, error: handymanError } = await supabaseAdmin
      .from('handymen')
      .select('*')
      .eq('id', handymanId)
      .single();

    if (handymanError || !handyman) {
      throw new Error('Failed to fetch handyman data');
    }

    // Fetch task metrics - try multiple possible column names
    console.log('üîç Fetching tasks for handyman:', handymanId);

    // First discover what columns actually exist in tasks table
    console.log('üîç Discovering tasks table structure...');
    let { data: sampleTasks, error: sampleError } = await supabaseAdmin
      .from('tasks')
      .select('*')
      .limit(1);

    console.log('üìä Tasks table columns available:', sampleTasks?.[0] ? Object.keys(sampleTasks[0]) : 'No tasks found');

    // Try basic columns that should exist
    let { data: tasks, error: tasksError } = await supabaseAdmin
      .from('tasks')
      .select('*')
      .eq('handyman_id', handymanId)
      .order('created_at', { ascending: false });

    console.log('üîç Tasks with handyman_id:', tasks?.length || 0, tasks);
    if (tasksError) console.error('‚ùå Task query error:', tasksError);

    // If no tasks found or error, try assigned_handyman_id
    if ((!tasks || tasks.length === 0) && !tasksError) {
      console.log('üîç Trying assigned_handyman_id column...');
      const { data: tasks2, error: tasksError2 } = await supabaseAdmin
        .from('tasks')
        .select('*')
        .eq('assigned_handyman_id', handymanId)
        .order('created_at', { ascending: false });

      console.log('üîç Tasks with assigned_handyman_id:', tasks2?.length || 0, tasks2);
      if (tasksError2) console.error('‚ùå Task query error 2:', tasksError2);
      if (tasks2) {
        tasks = tasks2;
        tasksError = tasksError2;
      }
    }

    // If still no success, try other possible column names
    if ((!tasks || tasks.length === 0) && !tasksError) {
      console.log('üîç Trying other possible column names...');
      for (const columnName of ['handyman', 'worker_id', 'assigned_to', 'technician_id']) {
        try {
          const { data: tasks3, error: tasksError3 } = await supabaseAdmin
            .from('tasks')
            .select('*')
            .eq(columnName, handymanId)
            .order('created_at', { ascending: false });

          if (tasks3 && tasks3.length > 0) {
            console.log(`‚úÖ Found tasks using column: ${columnName}`, tasks3);
            tasks = tasks3;
            break;
          }
        } catch (e) {
          console.log(`‚ùå Column ${columnName} doesn't exist`);
        }
      }
    }

    console.log('üîç Final tasks result:', tasks?.length || 0, 'tasks found');

    // Calculate metrics
    const totalTasks = tasks?.length || 0;
    const completedTasks = tasks?.filter(t => t.status === 'completed').length || 0;
    const totalEarnings = tasks?.filter(t => t.status === 'completed')
      .reduce((sum, t) => sum + (parseFloat(t.total_amount) || 0), 0) || 0;
    const averageRating = 4.2; // Placeholder - would come from reviews table

    // Fetch onboarding data from storage if available - try comprehensive bucket discovery
    let onboardingFiles = [];
    console.log('üîç Fetching files for handyman:', handymanId);
    console.log('üîç Handyman user_id:', handyman.user_id);
    console.log('üîç Handyman email:', handyman.email);

    // First, let's discover what buckets exist
    try {
      const { data: buckets, error: bucketsError } = await supabaseAdmin.storage.listBuckets();
      console.log('üì¶ Available storage buckets:', buckets?.map(b => b.name) || 'None found');
    } catch (e) {
      console.log('‚ùå Could not list buckets:', e.message);
    }

    // Try comprehensive combinations - based on you saying files are organized by user_id
    const possiblePaths = [
      // Primary suspects based on your description
      { bucket: 'handyman-documents', path: `${handyman.user_id}/` },
      { bucket: 'handyman-documents', path: `${handyman.user_id}` }, // without trailing slash
      { bucket: 'handyman-documents', path: '' }, // root level

      // Try with handyman table ID as backup
      { bucket: 'handyman-documents', path: `${handymanId}/` },
      { bucket: 'handyman-documents', path: `${handymanId}` },

      // Other possible bucket names
      { bucket: 'handyman-docs', path: `${handyman.user_id}/` },
      { bucket: 'handymen-documents', path: `${handyman.user_id}/` },
      { bucket: 'documents', path: `${handyman.user_id}/` },
      { bucket: 'documents', path: `handymen/${handyman.user_id}/` },
      { bucket: 'uploads', path: `${handyman.user_id}/` },
      { bucket: 'uploads', path: `handymen/${handyman.user_id}/` },
      { bucket: 'files', path: `${handyman.user_id}/` },

      // Try email-based paths
      { bucket: 'handyman-documents', path: `${handyman.email}/` },
      { bucket: 'uploads', path: `${handyman.email}/` }
    ];

    for (const { bucket, path } of possiblePaths) {
      try {
        console.log(`üîç Trying bucket: ${bucket}, path: ${path}`);
        const { data: storageFiles, error: storageError } = await supabaseAdmin.storage
          .from(bucket)
          .list(path, { limit: 100, sortBy: { column: 'name', order: 'asc' } });

        if (storageFiles && storageFiles.length > 0) {
          console.log(`‚úÖ Found ${storageFiles.length} files in ${bucket}/${path}:`, storageFiles);
          console.log('üîç File details:', storageFiles.map(f => ({
            name: f.name,
            id: f.id,
            updated_at: f.updated_at,
            created_at: f.created_at,
            last_accessed_at: f.last_accessed_at,
            metadata: f.metadata
          })));

          onboardingFiles = storageFiles.map(file => {
            // Enhanced corruption detection
            const isCorrupted = checkFileCorruption(file);
            const fileType = getFileType(file.name);

            return {
              ...file,
              bucket,
              fullPath: path + file.name,
              displayPath: path + file.name,
              originalFile: file,
              isCorrupted: isCorrupted,
              fileType: fileType,
              corruptionReasons: isCorrupted ? getCorruptionReasons(file) : null
            };
          });
          break;
        } else {
          console.log(`üìÅ No files in ${bucket}/${path}`);
        }
      } catch (storageError) {
        console.log(`‚ùå Failed to access ${bucket}/${path}:`, storageError.message);
      }
    }

    console.log('üîç Final files result:', onboardingFiles.length, 'files found');

    // Build and populate the details modal
    populateHandymanDetails(handyman, {
      totalTasks,
      completedTasks,
      totalEarnings,
      averageRating,
      recentTasks: tasks?.slice(0, 5) || [],
      onboardingFiles
    });

  } catch (error) {
    console.error('‚ùå Error loading handyman details:', error);
    alert('Failed to load handyman details. Please try again.');
    closeHandymanDetailsModal();
  }
}

function populateHandymanDetails(handyman, metrics) {
  // Basic Information Section
  const basicInfoSection = document.getElementById('basicInfoSection');
  basicInfoSection.innerHTML = `
    <div class="bg-slate-50 p-4 rounded-lg">
      <h5 class="font-semibold text-slate-700 mb-2">Personal Info</h5>
      <p><strong>Name:</strong> ${handyman.full_name || 'N/A'}</p>
      <p><strong>Email:</strong> ${handyman.email || 'N/A'}</p>
      <p><strong>Phone:</strong> ${handyman.phone || 'N/A'}</p>
      <p><strong>City:</strong> ${handyman.city || 'N/A'}</p>
    </div>
    <div class="bg-blue-50 p-4 rounded-lg">
      <h5 class="font-semibold text-blue-700 mb-2">Work Details</h5>
      <p><strong>Hourly Rate:</strong> $${handyman.hourly_rate || 'N/A'}</p>
      <p><strong>Status:</strong> <span class="px-2 py-1 rounded text-xs ${handyman.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${handyman.is_active ? 'Active' : 'Inactive'}</span></p>
      <p><strong>Onboarding:</strong> <span class="px-2 py-1 rounded text-xs ${handyman.onboarding_completed ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${handyman.onboarding_completed ? 'Completed' : 'Pending'}</span></p>
    </div>
    <div class="bg-purple-50 p-4 rounded-lg">
      <h5 class="font-semibold text-purple-700 mb-2">Skills & Specialties</h5>
      <p><strong>Skills:</strong> ${formatSkills(handyman.skills)}</p>
      <p><strong>Specialties:</strong> ${handyman.specialties || 'None specified'}</p>
      <p><strong>Experience:</strong> ${handyman.experience_years || 'N/A'} years</p>
    </div>
  `;

  // Performance Metrics Section
  const metricsSection = document.getElementById('metricsSection');
  metricsSection.innerHTML = `
    <div class="bg-green-50 border border-green-200 p-4 rounded-lg text-center">
      <div class="text-2xl font-bold text-green-600">${metrics.totalTasks}</div>
      <div class="text-sm text-green-700">Total Tasks</div>
    </div>
    <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg text-center">
      <div class="text-2xl font-bold text-blue-600">${metrics.completedTasks}</div>
      <div class="text-sm text-blue-700">Completed</div>
    </div>
    <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg text-center">
      <div class="text-2xl font-bold text-yellow-600">$${metrics.totalEarnings.toFixed(2)}</div>
      <div class="text-sm text-yellow-700">Total Earnings</div>
    </div>
    <div class="bg-orange-50 border border-orange-200 p-4 rounded-lg text-center">
      <div class="text-2xl font-bold text-orange-600">${metrics.averageRating}/5</div>
      <div class="text-sm text-orange-700">Avg. Rating</div>
    </div>
  `;

  // Onboarding Section
  const onboardingSection = document.getElementById('onboardingSection');
  onboardingSection.innerHTML = `
    <div class="bg-slate-50 p-4 rounded-lg">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <p><strong>Onboarding Status:</strong> <span class="px-2 py-1 rounded text-xs ${handyman.onboarding_completed ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${handyman.onboarding_completed ? 'Completed' : 'Pending'}</span></p>
          <p><strong>Date Joined:</strong> ${handyman.created_at ? new Date(handyman.created_at).toLocaleDateString() : 'N/A'}</p>
          <p><strong>Background Check:</strong> ${handyman.background_check_status || 'Pending'}</p>
        </div>
        <div>
          <p><strong>Insurance:</strong> ${handyman.insurance_verified ? 'Verified' : 'Not Verified'}</p>
          <p><strong>License:</strong> ${handyman.license_verified ? 'Verified' : 'Not Verified'}</p>
          <p><strong>Training:</strong> ${handyman.training_completed ? 'Completed' : 'Pending'}</p>
        </div>
      </div>
    </div>
  `;

  // Files Section with Enhanced Viewing
  const filesSection = document.getElementById('filesSection');
  if (metrics.onboardingFiles.length > 0) {
    filesSection.innerHTML = `
      <div class="space-y-4">
        <!-- File Categories -->
        <div class="flex flex-wrap gap-2 mb-4">
          <button onclick="filterFilesByCategory('all')" class="file-filter-btn active px-3 py-1 text-sm rounded-full bg-blue-100 text-blue-800">
            All (${metrics.onboardingFiles.length})
          </button>
          <button onclick="filterFilesByCategory('image')" class="file-filter-btn px-3 py-1 text-sm rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200">
            Images (${metrics.onboardingFiles.filter(f => getFileType(f.name) === 'image').length})
          </button>
          <button onclick="filterFilesByCategory('document')" class="file-filter-btn px-3 py-1 text-sm rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200">
            Documents (${metrics.onboardingFiles.filter(f => getFileType(f.name) === 'document').length})
          </button>
          <button onclick="filterFilesByCategory('pdf')" class="file-filter-btn px-3 py-1 text-sm rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200">
            PDFs (${metrics.onboardingFiles.filter(f => getFileType(f.name) === 'pdf').length})
          </button>
          <button onclick="filterFilesByCategory('corrupted')" class="file-filter-btn px-3 py-1 text-sm rounded-full bg-red-100 text-red-600 hover:bg-red-200">
            Corrupted (${metrics.onboardingFiles.filter(f => f.isCorrupted).length})
          </button>
        </div>

        <!-- File Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="fileGrid">
          ${metrics.onboardingFiles.map(file => createFileCard(file)).join('')}
        </div>
      </div>
    `;
  } else {
    filesSection.innerHTML = `
      <div class="text-center py-8 text-slate-500 bg-slate-50 rounded-lg border-2 border-dashed border-slate-300">
        <div class="text-4xl mb-2">üìÅ</div>
        <p class="font-medium">No files uploaded yet</p>
        <p class="text-sm">Documents and files will appear here once uploaded</p>
      </div>
    `;
  }

  // Recent Tasks Section
  const recentTasksSection = document.getElementById('recentTasksSection');
  if (metrics.recentTasks.length > 0) {
    recentTasksSection.innerHTML = `
      <div class="overflow-x-auto">
        <table class="w-full border border-slate-200 rounded-lg">
          <thead class="bg-slate-50">
            <tr>
              <th class="px-4 py-2 text-left text-sm font-semibold">Customer</th>
              <th class="px-4 py-2 text-left text-sm font-semibold">Service</th>
              <th class="px-4 py-2 text-left text-sm font-semibold">Amount</th>
              <th class="px-4 py-2 text-left text-sm font-semibold">Status</th>
              <th class="px-4 py-2 text-left text-sm font-semibold">Date</th>
            </tr>
          </thead>
          <tbody>
            ${metrics.recentTasks.map(task => `
              <tr class="border-b border-slate-100">
                <td class="px-4 py-2 text-sm">${task.name || task.customer_name || task.client_name || 'N/A'}</td>
                <td class="px-4 py-2 text-sm">${task.category || task.service_type || task.type || 'N/A'}</td>
                <td class="px-4 py-2 text-sm">$${parseFloat(task.total_amount || task.amount || task.cost || 0).toFixed(2)}</td>
                <td class="px-4 py-2 text-sm">
                  <span class="px-2 py-1 rounded text-xs ${getStatusColor(task.status)}">
                    ${task.status || 'N/A'}
                  </span>
                </td>
                <td class="px-4 py-2 text-sm">${new Date(task.created_at).toLocaleDateString()}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
  } else {
    recentTasksSection.innerHTML = `
      <div class="text-center py-8 text-slate-500">
        <p>No tasks assigned yet</p>
      </div>
    `;
  }

  // Show content and hide loading
  document.getElementById('handymanDetailsLoading').classList.add('hidden');
  document.getElementById('handymanDetailsContent').classList.remove('hidden');
}

function closeHandymanDetailsModal() {
  document.getElementById('handymanDetailsModal').classList.add('hidden');
}

function getStatusColor(status) {
  switch(status) {
    case 'completed': return 'bg-green-100 text-green-800';
    case 'in_progress': return 'bg-blue-100 text-blue-800';
    case 'pending': return 'bg-yellow-100 text-yellow-800';
    case 'cancelled': return 'bg-red-100 text-red-800';
    default: return 'bg-slate-100 text-slate-800';
  }
}

async function downloadFile(bucket, filePath) {
  try {
    console.log('üîó Downloading file from bucket:', bucket);
    console.log('üîó File path:', filePath);
    console.log('üîó Full download URL would be:', `${bucket}/${filePath}`);

    // First, let's verify the file actually exists and get its info
    console.log('üîç Verifying file exists...');
    try {
      const { data: fileList, error: listError } = await supabaseAdmin.storage
        .from(bucket)
        .list('', { search: filePath });

      console.log('üîç File search result:', fileList);

      if (!fileList || fileList.length === 0) {
        console.log('‚ùå File not found in search');
        throw new Error(`File ${filePath} not found in bucket ${bucket}`);
      } else {
        console.log('‚úÖ File found in verification:', fileList[0]);
      }
    } catch (verifyError) {
      console.error('‚ùå File verification failed:', verifyError);
    }

    // Clean up the file path - remove double slashes and fix path issues
    let cleanPath = filePath;
    if (cleanPath.startsWith('/')) {
      cleanPath = cleanPath.substring(1);
    }

    console.log('üîó Clean path:', cleanPath);

    // Try direct download first
    console.log('üîó Attempting direct download...');
    let { data, error } = await supabaseAdmin.storage
      .from(bucket)
      .download(cleanPath);

    // If direct download fails, try alternative approaches
    if (error) {
      console.log('üîó Direct download failed, trying alternative approaches...');
      console.error('‚ùå First download attempt error:', error);

      // Try getting public URL instead
      try {
        console.log('üîó Trying to get public URL...');
        const { data: urlData } = supabaseAdmin.storage
          .from(bucket)
          .getPublicUrl(cleanPath);

        if (urlData && urlData.publicUrl) {
          console.log('üîó Public URL:', urlData.publicUrl);

          // Try to fetch the file directly
          const response = await fetch(urlData.publicUrl);
          if (response.ok) {
            const blob = await response.blob();
            const fileName = cleanPath.split('/').pop() || 'download';

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            console.log('‚úÖ File downloaded via public URL:', fileName);
            return;
          }
        }
      } catch (publicUrlError) {
        console.error('‚ùå Public URL approach failed:', publicUrlError);
      }

      // Try creating signed URL
      try {
        console.log('üîó Trying to create signed URL...');
        const { data: signedUrlData, error: signedError } = await supabaseAdmin.storage
          .from(bucket)
          .createSignedUrl(cleanPath, 60); // 60 seconds expiry

        if (signedUrlData && signedUrlData.signedUrl) {
          console.log('üîó Signed URL:', signedUrlData.signedUrl);

          const response = await fetch(signedUrlData.signedUrl);
          if (response.ok) {
            const blob = await response.blob();
            const fileName = cleanPath.split('/').pop() || 'download';

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            console.log('‚úÖ File downloaded via signed URL:', fileName);
            return;
          }
        } else if (signedError) {
          console.error('‚ùå Signed URL error:', signedError);
        }
      } catch (signedUrlError) {
        console.error('‚ùå Signed URL approach failed:', signedUrlError);
      }

      throw error; // Re-throw original error if all approaches fail
    }

    // Original direct download succeeded
    const fileName = cleanPath.split('/').pop() || 'download';
    console.log('üîó Extracted filename:', fileName);

    const url = URL.createObjectURL(data);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    console.log('‚úÖ File downloaded successfully:', fileName);
  } catch (error) {
    console.error('‚ùå All download methods failed:', error);
    console.error('‚ùå Error details:', {
      name: error.name,
      message: error.message,
      stack: error.stack
    });

    // Provide more helpful error message
    let errorMessage = 'Download failed. ';
    if (error.message === '{}' || error.message === '') {
      errorMessage += 'This might be a permissions issue or the file may not exist.';
    } else {
      errorMessage += error.message;
    }

    alert(errorMessage + '\n\nPlease check the console for detailed error information.');
  }
}

// Enhanced file corruption detection
function checkFileCorruption(file) {
  if (!file) return true;

  // Check for essential metadata
  const hasId = file.id && file.id !== '';
  const hasValidDates = file.created_at && file.updated_at;
  const hasValidName = file.name && file.name !== '';

  // Check for incomplete uploads (size issues)
  const hasValidSize = file.metadata?.size !== undefined && file.metadata?.size !== null;

  // Check for minimum file size (corrupted files often have 0 bytes or very small sizes)
  const hasReasonableSize = !hasValidSize || file.metadata.size > 0;

  // File is corrupted if any essential data is missing
  return !hasId || !hasValidDates || !hasValidName || !hasReasonableSize;
}

// Get specific corruption reasons for debugging
function getCorruptionReasons(file) {
  const reasons = [];

  if (!file.id || file.id === '') {
    reasons.push('Missing or empty file ID');
  }

  if (!file.created_at) {
    reasons.push('Missing creation date');
  }

  if (!file.updated_at) {
    reasons.push('Missing update date');
  }

  if (!file.name || file.name === '') {
    reasons.push('Missing or empty filename');
  }

  if (file.metadata?.size === undefined || file.metadata?.size === null) {
    reasons.push('Missing size information');
  } else if (file.metadata.size === 0) {
    reasons.push('Zero-byte file (empty)');
  }

  return reasons;
}

// Enhanced file type detection
function getFileType(fileName) {
  if (!fileName) return 'unknown';

  const extension = fileName.toLowerCase().split('.').pop();

  const imageTypes = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg', 'tiff', 'ico'];
  const documentTypes = ['doc', 'docx', 'txt', 'rtf', 'odt'];
  const pdfTypes = ['pdf'];
  const videoTypes = ['mp4', 'avi', 'mov', 'mkv', 'wmv', 'flv', 'webm'];
  const audioTypes = ['mp3', 'wav', 'flac', 'aac', 'ogg', 'm4a'];
  const archiveTypes = ['zip', 'rar', '7z', 'tar', 'gz'];
  const spreadsheetTypes = ['xls', 'xlsx', 'csv', 'ods'];
  const presentationTypes = ['ppt', 'pptx', 'odp'];

  if (imageTypes.includes(extension)) return 'image';
  if (documentTypes.includes(extension)) return 'document';
  if (pdfTypes.includes(extension)) return 'pdf';
  if (videoTypes.includes(extension)) return 'video';
  if (audioTypes.includes(extension)) return 'audio';
  if (archiveTypes.includes(extension)) return 'archive';
  if (spreadsheetTypes.includes(extension)) return 'spreadsheet';
  if (presentationTypes.includes(extension)) return 'presentation';

  return 'unknown';
}

// Get file icon based on type
function getFileIcon(fileName, fileType = null) {
  const type = fileType || getFileType(fileName);

  const icons = {
    image: 'üñºÔ∏è',
    document: 'üìÑ',
    pdf: 'üìï',
    video: 'üé•',
    audio: 'üéµ',
    archive: 'üóúÔ∏è',
    spreadsheet: 'üìä',
    presentation: 'üìΩÔ∏è',
    unknown: 'üìã'
  };

  return icons[type] || icons.unknown;
}

// Format file size
function formatFileSize(bytes) {
  if (!bytes || bytes === 0) return 'Unknown size';

  const sizes = ['B', 'KB', 'MB', 'GB'];
  let i = 0;
  let size = bytes;

  while (size >= 1024 && i < sizes.length - 1) {
    size /= 1024;
    i++;
  }

  return `${size.toFixed(1)} ${sizes[i]}`;
}

// Create enhanced file card
function createFileCard(file) {
  const fileType = getFileType(file.name);
  const icon = getFileIcon(file.name, fileType);
  const size = formatFileSize(file.metadata?.size);
  const isImage = fileType === 'image';
  const isPdf = fileType === 'pdf';
  const isCorrupted = file.isCorrupted;

  return `
    <div class="file-card border border-slate-200 rounded-lg hover:shadow-md transition-shadow ${isCorrupted ? 'bg-red-50 border-red-200' : 'bg-white'}" data-file-type="${fileType}" data-corrupted="${isCorrupted}">
      <div class="p-4">
        <!-- File Header -->
        <div class="flex items-start justify-between mb-3">
          <div class="flex items-center space-x-2">
            <div class="text-2xl">${icon}</div>
            <div>
              <p class="font-medium text-sm truncate max-w-[150px]" title="${file.name}">
                ${file.name}
                ${isCorrupted ? ' ‚ö†Ô∏è' : ''}
              </p>
              <p class="text-xs text-slate-500">${size}</p>
            </div>
          </div>
          <div class="text-xs text-slate-400 uppercase font-medium">${fileType}</div>
        </div>

        <!-- File Preview/Thumbnail -->
        ${isImage && !isCorrupted ? `
          <div class="mb-3">
            <div class="bg-slate-100 rounded-lg p-2 text-center text-xs text-slate-500 min-h-[80px] flex items-center justify-center cursor-pointer hover:bg-slate-200 transition-colors" onclick="previewFile('${file.bucket}', '${file.fullPath}', '${file.name}', 'image')">
              <div>
                <div class="text-lg mb-1">${icon}</div>
                Click to preview
              </div>
            </div>
          </div>
        ` : ''}

        <!-- File Details -->
        <div class="text-xs text-slate-500 space-y-1 mb-3">
          <p><strong>Date:</strong> ${file.updated_at ? new Date(file.updated_at).toLocaleDateString() : 'Invalid date'}</p>
          <p><strong>Path:</strong> <code class="bg-slate-100 px-1 rounded text-xs">${file.bucket}/${file.displayPath}</code></p>
          ${isCorrupted ? `
            <div class="bg-red-50 border border-red-200 rounded p-2 mt-2">
              <p class="text-red-600 font-medium text-xs">‚ö†Ô∏è File Corruption Detected</p>
              ${file.corruptionReasons ? `
                <ul class="text-red-500 text-xs mt-1 list-disc list-inside">
                  ${file.corruptionReasons.map(reason => `<li>${reason}</li>`).join('')}
                </ul>
              ` : ''}
            </div>
          ` : ''}
        </div>

        <!-- Actions -->
        <div class="flex gap-2 text-xs">
          ${!isCorrupted ? `
            <button onclick="downloadFile('${file.bucket}', '${file.fullPath}')" class="flex-1 bg-blue-100 text-blue-700 hover:bg-blue-200 px-2 py-1 rounded transition-colors">
              Download
            </button>
          ` : `
            <button class="flex-1 bg-gray-100 text-gray-400 px-2 py-1 rounded cursor-not-allowed" disabled>
              Corrupted
            </button>
          `}

          ${isImage && !isCorrupted ? `
            <button onclick="previewFile('${file.bucket}', '${file.fullPath}', '${file.name}', 'image')" class="bg-green-100 text-green-700 hover:bg-green-200 px-2 py-1 rounded transition-colors">
              Preview
            </button>
          ` : ''}

          ${isPdf && !isCorrupted ? `
            <button onclick="previewFile('${file.bucket}', '${file.fullPath}', '${file.name}', 'pdf')" class="bg-purple-100 text-purple-700 hover:bg-purple-200 px-2 py-1 rounded transition-colors">
              View PDF
            </button>
          ` : ''}

          <button onclick="showFileInfo('${file.bucket}', '${file.name}', ${JSON.stringify(file.originalFile).replace(/"/g, '&quot;')})" class="bg-slate-100 text-slate-600 hover:bg-slate-200 px-2 py-1 rounded transition-colors">
            Info
          </button>
        </div>
      </div>
    </div>
  `;
}

// Filter files by category
function filterFilesByCategory(category) {
  const fileCards = document.querySelectorAll('.file-card');
  const filterBtns = document.querySelectorAll('.file-filter-btn');

  // Update button states
  filterBtns.forEach(btn => {
    btn.classList.remove('active', 'bg-blue-100', 'text-blue-800');
    btn.classList.add('bg-slate-100', 'text-slate-600');
  });

  event.target.classList.add('active', 'bg-blue-100', 'text-blue-800');
  event.target.classList.remove('bg-slate-100', 'text-slate-600');

  // Filter files
  fileCards.forEach(card => {
    const fileType = card.dataset.fileType;
    const isCorrupted = card.dataset.corrupted === 'true';

    let show = false;

    if (category === 'all') {
      show = true;
    } else if (category === 'corrupted') {
      show = isCorrupted;
    } else {
      show = fileType === category && !isCorrupted;
    }

    if (show) {
      card.style.display = 'block';
    } else {
      card.style.display = 'none';
    }
  });
}

// Preview file (images and PDFs)
async function previewFile(bucket, filePath, fileName, fileType) {
  try {
    console.log('üîç Previewing file:', fileName, 'Type:', fileType);

    // Clean up the file path
    let cleanPath = filePath;
    if (cleanPath.startsWith('/')) {
      cleanPath = cleanPath.substring(1);
    }

    // Get signed URL for preview
    const { data: signedUrlData, error: signedError } = await supabaseAdmin.storage
      .from(bucket)
      .createSignedUrl(cleanPath, 60); // 60 seconds expiry

    if (signedError || !signedUrlData?.signedUrl) {
      throw new Error('Failed to create preview URL: ' + (signedError?.message || 'Unknown error'));
    }

    const previewUrl = signedUrlData.signedUrl;
    console.log('üîó Preview URL created:', previewUrl);

    if (fileType === 'image') {
      // Show image in modal
      const modal = document.getElementById('photoModal');
      const modalTitle = document.getElementById('photoModalTitle');
      const modalImage = document.getElementById('photoModalImage');

      modalTitle.textContent = fileName;
      modalImage.src = previewUrl;
      modalImage.onload = () => {
        modal.classList.remove('hidden');
      };
      modalImage.onerror = () => {
        alert('Failed to load image preview. The file may be corrupted.');
      };

    } else if (fileType === 'pdf') {
      // Open PDF in new window
      window.open(previewUrl, '_blank');

    } else {
      alert('Preview not supported for this file type');
    }

  } catch (error) {
    console.error('‚ùå Preview failed:', error);
    alert('Failed to preview file: ' + error.message);
  }
}

function showFileInfo(bucket, fileName, fileData) {
  console.log('üìã File Information:');
  console.log('Bucket:', bucket);
  console.log('File name:', fileName);
  console.log('Full file data:', fileData);

  const fileType = getFileType(fileName);
  const icon = getFileIcon(fileName);
  const size = formatFileSize(fileData.metadata?.size);

  // Recheck corruption status with current data
  const isCorrupted = checkFileCorruption(fileData);
  const corruptionReasons = isCorrupted ? getCorruptionReasons(fileData) : null;

  let corruptionInfo = '';
  if (isCorrupted && corruptionReasons?.length > 0) {
    corruptionInfo = `
‚ö†Ô∏è CORRUPTION DETAILS:
${corruptionReasons.map(reason => `   ‚Ä¢ ${reason}`).join('\n')}

üîß SUGGESTED ACTIONS:
   ‚Ä¢ Re-upload the file if possible
   ‚Ä¢ Check original source file integrity
   ‚Ä¢ Contact support if issue persists
`;
  }

  const info = `
File Information
================
üìÑ Name: ${fileName}
${icon} Type: ${fileType.charAt(0).toUpperCase() + fileType.slice(1)}
üìä Size: ${size}
üóÇÔ∏è Bucket: ${bucket}
üÜî ID: ${fileData.id || 'N/A'}
üìÖ Created: ${fileData.created_at || 'N/A'}
üîÑ Updated: ${fileData.updated_at || 'N/A'}
üëÅÔ∏è Last Accessed: ${fileData.last_accessed_at || 'N/A'}
üè∑Ô∏è MIME Type: ${fileData.metadata?.mimetype || 'Unknown'}

${isCorrupted ? '‚ö†Ô∏è WARNING: This file appears to be corrupted or incomplete' : '‚úÖ File appears to be healthy'}
${corruptionInfo}
Full technical details:
${JSON.stringify(fileData, null, 2)}
  `;

  // Create a more user-friendly modal instead of alert for better readability
  showFileInfoModal(info, fileName, isCorrupted);
}

// Create a dedicated modal for file information
function showFileInfoModal(info, fileName, isCorrupted) {
  // Remove existing modal if any
  const existingModal = document.getElementById('fileInfoModal');
  if (existingModal) {
    existingModal.remove();
  }

  const modal = document.createElement('div');
  modal.id = 'fileInfoModal';
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';

  modal.innerHTML = `
    <div class="bg-white rounded-lg max-w-4xl w-full max-h-[80vh] overflow-hidden flex flex-col">
      <div class="p-4 border-b border-slate-200 flex justify-between items-center">
        <h3 class="text-lg font-semibold ${isCorrupted ? 'text-red-600' : 'text-slate-800'}">
          ${isCorrupted ? '‚ö†Ô∏è' : 'üìÑ'} File Information: ${fileName}
        </h3>
        <button onclick="closeFileInfoModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
      </div>
      <div class="p-4 overflow-y-auto">
        <pre class="whitespace-pre-wrap text-sm ${isCorrupted ? 'text-red-900' : 'text-slate-700'} font-mono bg-slate-50 p-4 rounded-lg">${info}</pre>
      </div>
      <div class="p-4 border-t border-slate-200 flex justify-end gap-2">
        ${isCorrupted ? `
          <button onclick="alert('Contact your system administrator to resolve file corruption issues.')" class="bg-yellow-100 text-yellow-800 px-4 py-2 rounded hover:bg-yellow-200 transition-colors">
            Get Help
          </button>
        ` : ''}
        <button onclick="closeFileInfoModal()" class="bg-slate-100 text-slate-700 px-4 py-2 rounded hover:bg-slate-200 transition-colors">
          Close
        </button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  // Close modal when clicking outside
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      closeFileInfoModal();
    }
  });
}

function closeFileInfoModal() {
  const modal = document.getElementById('fileInfoModal');
  if (modal) {
    modal.remove();
  }
}

async function toggleHandymanStatus(handymanId) {
  try {
    // Get current handyman data
    const { data: handyman, error: fetchError } = await supabaseAdmin
      .from('handymen')
      .select('full_name, is_active')
      .eq('id', handymanId)
      .single();

    if (fetchError) throw fetchError;
    if (!handyman) {
      alert('Handyman not found');
      return;
    }

    const currentStatus = handyman.is_active;
    const newStatus = !currentStatus;
    const action = newStatus ? 'activate' : 'suspend';
    const actionPast = newStatus ? 'activated' : 'suspended';

    // Confirm the action
    const confirmMessage = `Are you sure you want to ${action} ${handyman.full_name}?\n\n` +
      (newStatus
        ? 'They will be able to receive new task assignments.'
        : 'They will stop receiving new task assignments (existing tasks will remain assigned).');

    if (!confirm(confirmMessage)) {
      return;
    }

    // Update the status
    const { error: updateError } = await supabaseAdmin
      .from('handymen')
      .update({ is_active: newStatus })
      .eq('id', handymanId);

    if (updateError) throw updateError;

    // Refresh the handyman list and show success message
    loadHandymenData();
    showNotification(`${handyman.full_name} has been ${actionPast}!`, 'success');

  } catch (error) {
    console.error('Error toggling handyman status:', error);
    alert('Error updating handyman status: ' + error.message);
  }
}

// Task Management Functions
let tasksData = [];
let selectedTasks = [];

// Load tasks data
async function loadTasksData() {
  console.log('üìã Loading tasks data...');

  try {
    const { data: tasks, error } = await supabaseAdmin
      .from('tasks')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) throw error;

    // Get handyman names for all assigned tasks
    const handymanIds = [...new Set(tasks.filter(t => t.handyman_id).map(t => t.handyman_id))];
    let handymenMap = {};

    if (handymanIds.length > 0) {
      const { data: handymen } = await supabaseAdmin
        .from('handymen')
        .select('id, full_name')
        .in('id', handymanIds);

      if (handymen) {
        handymenMap = Object.fromEntries(handymen.map(h => [h.id, h.full_name]));
      }
    }

    // Add handyman names to tasks
    tasksData = (tasks || []).map(task => ({
      ...task,
      handyman_name: task.handyman_id ? handymenMap[task.handyman_id] : null
    }));
    renderTasksTable();
    updateTaskSummary();

  } catch (error) {
    console.error('Error loading tasks:', error);
    document.getElementById('tasksTableBody').innerHTML = `
      <tr><td colspan="8" class="text-center py-8 text-red-500">Error loading tasks data</td></tr>
    `;
  }
}

// Render tasks table
function renderTasksTable() {
  const tbody = document.getElementById('tasksTableBody');

  if (!tasksData.length) {
    tbody.innerHTML = `
      <tr><td colspan="8" class="text-center py-8 text-slate-500">No tasks found</td></tr>
    `;
    return;
  }

  tbody.innerHTML = tasksData.map(task => `
    <tr class="border-b border-slate-100 hover:bg-slate-50">
      <td class="px-4 py-3">
        <input type="checkbox" class="task-checkbox" value="${task.id}"
               onchange="handleTaskSelection(this)">
      </td>
      <td class="px-4 py-3 font-medium">#${task.id.slice(0, 8)}</td>
      <td class="px-4 py-3">${task.customer_name}</td>
      <td class="px-4 py-3">${task.task_category || 'N/A'}</td>
      <td class="px-4 py-3 font-semibold">$${task.total_amount || task.estimated_cost || 'N/A'}</td>
      <td class="px-4 py-3">
        ${task.handyman_name ?
          `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">${task.handyman_name}</span>` :
          `<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs">Unassigned</span>`
        }
      </td>
      <td class="px-4 py-3">
        <span class="px-2 py-1 rounded-full text-xs ${getStatusColor(task.status)}">${task.status}</span>
      </td>
      <td class="px-4 py-3">
        <div class="flex gap-2">
          ${!task.handyman_id ?
            `<button onclick="openAssignModal('${task.id}')" class="text-blue-600 hover:text-blue-800 text-sm">Assign</button>` :
            `<button onclick="reassignTask('${task.id}')" class="text-orange-600 hover:text-orange-800 text-sm">Reassign</button>`
          }
          <button onclick="viewTaskDetails('${task.id}')" class="text-slate-600 hover:text-slate-800 text-sm">View</button>
          ${task.status !== 'completed' && task.status !== 'cancelled' ?
            `<button onclick="closeTask('${task.id}')" class="text-green-600 hover:text-green-800 text-sm font-medium">Close</button>` :
            ''
          }
        </div>
      </td>
    </tr>
  `).join('');
}

// Update task summary cards
function updateTaskSummary() {
  const unassignedTasks = tasksData.filter(task => !task.handyman_id).length;
  const assignedTasks = tasksData.filter(task => task.handyman_id && task.status === 'assigned').length;
  const inProgressTasks = tasksData.filter(task => task.status === 'in_progress').length;
  const completedTasks = tasksData.filter(task => task.status === 'completed').length;

  document.getElementById('unassignedTasksCount').textContent = unassignedTasks;
  document.getElementById('assignedTasksCount').textContent = assignedTasks;
  document.getElementById('inProgressTasksCount').textContent = inProgressTasks;
  document.getElementById('completedTasksCount').textContent = completedTasks;
}

// Handle task selection for bulk operations
function handleTaskSelection(checkbox) {
  const taskId = checkbox.value;

  if (checkbox.checked) {
    selectedTasks.push(taskId);
  } else {
    selectedTasks = selectedTasks.filter(id => id !== taskId);
  }

  // Update bulk actions visibility
  const bulkActions = document.getElementById('bulkActions');
  const selectedCount = document.getElementById('selectedCount');

  if (selectedTasks.length > 0) {
    if (bulkActions) bulkActions.style.display = 'block';
    if (selectedCount) selectedCount.textContent = selectedTasks.length;
  } else {
    if (bulkActions) bulkActions.style.display = 'none';
  }
}

// Filter tasks
function filterTasks() {
  const statusFilter = document.getElementById('statusFilter').value;
  const assignmentFilter = document.getElementById('assignmentFilter').value;

  let filteredTasks = [...tasksData];

  if (statusFilter && statusFilter !== 'all') {
    filteredTasks = filteredTasks.filter(task => task.status === statusFilter);
  }

  if (assignmentFilter && assignmentFilter !== 'all') {
    if (assignmentFilter === 'assigned') {
      filteredTasks = filteredTasks.filter(task => task.handyman_id);
    } else if (assignmentFilter === 'unassigned') {
      filteredTasks = filteredTasks.filter(task => !task.handyman_id);
    }
  }

  // Update display with filtered tasks
  const originalTasksData = tasksData;
  tasksData = filteredTasks;
  renderTasksTable();
  tasksData = originalTasksData; // Restore original data
}

// Open assignment modal
async function openAssignModal(taskId = null) {
  try {
    // Load available handymen
    const { data: handymen, error } = await supabaseAdmin
      .from('handymen')
      .select('id, full_name, email, skills')
      .eq('is_active', true)
      .order('full_name');

    if (error) throw error;

    const handymenSelect = document.getElementById('assignHandymanSelect');
    handymenSelect.innerHTML = '<option value="">Select a handyman...</option>' +
      handymen.map(handyman => {
        const skillsText = handyman.skills && Array.isArray(handyman.skills) && handyman.skills.length > 0
          ? handyman.skills.slice(0, 2).join(', ') + (handyman.skills.length > 2 ? '...' : '')
          : 'General';
        return `<option value="${handyman.id}">${handyman.full_name} - ${skillsText}</option>`;
      }).join('');

    // Set modal title and behavior based on single vs bulk assignment
    const modal = document.getElementById('assignTaskModal');
    const title = document.getElementById('assignModalTitle');

    if (taskId) {
      // Single task assignment
      title.textContent = 'Assign Task';
      modal.dataset.taskId = taskId;
      modal.dataset.mode = 'single';

      // Populate task details in the assignment form
      const task = tasksData.find(t => t.id === taskId);
      if (task) {
        document.getElementById('assignTaskId').value = taskId;
        document.getElementById('displayTaskId').textContent = `#${taskId.slice(0, 8)}`;
        document.getElementById('displayCustomer').textContent = task.customer_name || 'N/A';
        document.getElementById('displayService').textContent = task.task_category || 'N/A';
        document.getElementById('displayAmount').textContent = `$${task.total_amount || 0}`;
      }
    } else {
      // Bulk assignment
      title.textContent = `Assign ${selectedTasks.length} Tasks`;
      modal.dataset.mode = 'bulk';

      // Clear task details for bulk assignment
      document.getElementById('displayTaskId').textContent = `${selectedTasks.length} tasks selected`;
      document.getElementById('displayCustomer').textContent = 'Multiple customers';
      document.getElementById('displayService').textContent = 'Multiple services';
      document.getElementById('displayAmount').textContent = 'Various amounts';
    }

    modal.classList.remove('hidden');

  } catch (error) {
    console.error('Error loading handymen for assignment:', error);
    alert('Failed to load handymen list');
  }
}

// Handle task assignment
async function handleTaskAssignment() {
  const modal = document.getElementById('assignTaskModal');
  const handymanId = document.getElementById('assignHandymanSelect').value;
  const notes = document.getElementById('assignmentNotes').value;

  if (!handymanId) {
    alert('Please select a handyman');
    return;
  }

  try {
    const mode = modal.dataset.mode;
    let taskIds = [];

    if (mode === 'single') {
      taskIds = [modal.dataset.taskId];
    } else {
      taskIds = selectedTasks;
    }

    // Log assignment notes (admin_notes column doesn't exist in current schema)
    if (notes) {
      console.log(`Assignment notes for task(s): ${notes}`);
    }

    // Update tasks with assignment
    for (const taskId of taskIds) {
      const { error } = await supabaseAdmin
        .from('tasks')
        .update({
          handyman_id: handymanId,
          status: 'assigned'
        })
        .eq('id', taskId);

      if (error) throw error;
    }

    alert(`Successfully assigned ${taskIds.length} task(s)`);

    // Reset form and close modal
    document.getElementById('assignTaskForm').reset();
    modal.classList.add('hidden');

    // Clear selections
    selectedTasks = [];
    const bulkActionsEl = document.getElementById('bulkActions');
    if (bulkActionsEl) {
      bulkActionsEl.style.display = 'none';
    }

    // Reload tasks
    loadTasksData();

  } catch (error) {
    console.error('Error assigning tasks:', error);
    alert('Failed to assign tasks: ' + error.message);
  }
}

// Quick assign selected tasks
function quickAssignSelected() {
  if (selectedTasks.length === 0) {
    alert('Please select tasks to assign');
    return;
  }
  openAssignModal();
}

// Reassign task
async function reassignTask(taskId) {
  openAssignModal(taskId);
}

// Close task manually (mark as completed)
async function closeTask(taskId) {
  try {
    // Confirm with user before closing
    if (!confirm('Are you sure you want to mark this task as completed? This action cannot be undone.')) {
      return;
    }

    console.log(`üîí Attempting to close task ${taskId}...`);

    // Update task status to completed
    const { data, error } = await supabaseAdmin
      .from('tasks')
      .update({
        status: 'completed',
        completed_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      })
      .eq('id', taskId)
      .select()
      .single();

    if (error) {
      console.error('Error closing task:', error);
      alert(`Failed to close task: ${error.message}`);
      return;
    }

    console.log('‚úÖ Task closed successfully:', data);

    // Track admin action
    AdminAnalytics.trackTaskAction('close', taskId);

    // Show success message
    alert('Task has been marked as completed successfully!');

    // Refresh the tasks table to reflect the change
    await loadTasksData();

  } catch (error) {
    console.error('Error closing task:', error);
    alert('An unexpected error occurred while closing the task. Please try again.');
  }
}

// View task details
async function viewTaskDetails(taskId) {
  try {
    const { data: task, error } = await supabaseAdmin
      .from('tasks')
      .select('*')
      .eq('id', taskId)
      .single();

    if (error) throw error;

    // Get handyman details separately if assigned
    let handyman = null;
    if (task.handyman_id) {
      const { data: handymanData, error: handymanError } = await supabaseAdmin
        .from('handymen')
        .select('id, full_name, email, phone')
        .eq('id', task.handyman_id)
        .single();

      if (!handymanError) {
        handyman = handymanData;
      }
    }

    // Get completion details if task is completed
    let completionDetails = '';
    if (task.status === 'completed' && task.handyman_id) {
      completionDetails = `
        <div class="border-t pt-4">
          <h4 class="text-lg font-semibold mb-3 text-green-700">Job Completion Details</h4>
          <div class="space-y-3">`;

      if (task.completed_at) {
        completionDetails += `
            <div>
              <label class="block text-sm font-medium text-slate-700">Completion Date</label>
              <p class="text-sm text-slate-900">${new Date(task.completed_at).toLocaleString()}</p>
            </div>`;
      }

      if (task.completion_notes) {
        completionDetails += `
            <div>
              <label class="block text-sm font-medium text-slate-700">Handyman Completion Notes</label>
              <p class="text-sm text-slate-900 bg-green-50 p-3 rounded-lg">${task.completion_notes}</p>
            </div>`;
      }

      if (task.time_spent) {
        completionDetails += `
            <div>
              <label class="block text-sm font-medium text-slate-700">Time Spent</label>
              <p class="text-sm text-slate-900">${task.time_spent} hours</p>
            </div>`;
      }

      completionDetails += `
          </div>
        </div>`;

      // Handle completion photos
      if (task.completion_photo_urls && task.completion_photo_urls.length > 0) {
        completionDetails += `
        <div class="border-t pt-4">
          <h4 class="text-lg font-semibold mb-3 text-green-700">Completion Photos</h4>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
            ${task.completion_photo_urls.map((photoUrl, index) => `
              <div class="relative">
                <img src="${photoUrl}" alt="Completion Photo ${index + 1}"
                     class="w-full h-32 object-cover rounded-lg cursor-pointer hover:opacity-75 transition-opacity border border-green-200"
                     onclick="openPhotoModal('${photoUrl}', 'Completion Photo ${index + 1}')">
                <div class="absolute top-1 right-1 bg-green-600 text-white text-xs px-1 rounded">
                  ${index + 1}
                </div>
              </div>
            `).join('')}
          </div>
        </div>`;
      }
    }

    // Populate task details modal
    const modal = document.getElementById('taskDetailsModal');
    document.getElementById('taskDetailContent').innerHTML = `
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700">Task ID</label>
            <p class="text-sm text-slate-900">#${task.id.slice(0, 8)}</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700">Status</label>
            <span class="px-2 py-1 rounded-full text-xs ${getStatusColor(task.status)}">${task.status}</span>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700">Customer</label>
            <p class="text-sm text-slate-900">${task.customer_name || 'N/A'}</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700">Service Type</label>
            <p class="text-sm text-slate-900">${task.task_category || 'N/A'}</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700">Amount</label>
            <p class="text-sm text-slate-900 font-semibold">$${task.total_amount || task.estimated_cost || 'N/A'}</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700">Assigned To</label>
            <p class="text-sm text-slate-900">${handyman ? handyman.full_name : 'Unassigned'}</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700">Created</label>
            <p class="text-sm text-slate-900">${new Date(task.created_at).toLocaleDateString()}</p>
          </div>
          ${task.scheduled_date ? `
          <div>
            <label class="block text-sm font-medium text-slate-700">Scheduled Date</label>
            <p class="text-sm text-slate-900">${new Date(task.scheduled_date).toLocaleDateString()}</p>
          </div>
          ` : ''}
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700">Description</label>
          <p class="text-sm text-slate-900">${task.description || 'No description provided'}</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700">Customer Address</label>
          <p class="text-sm text-slate-900">${task.customer_address || 'No address provided'}</p>
        </div>
        ${task.customer_phone ? `
        <div>
          <label class="block text-sm font-medium text-slate-700">Customer Phone</label>
          <p class="text-sm text-slate-900">${task.customer_phone}</p>
        </div>
        ` : ''}
        ${task.admin_notes ? `
        <div>
          <label class="block text-sm font-medium text-slate-700">Admin Notes</label>
          <p class="text-sm text-slate-900">${task.admin_notes}</p>
        </div>
        ` : ''}
        ${completionDetails}
      </div>
    `;

    modal.classList.remove('hidden');

  } catch (error) {
    console.error('Error loading task details:', error);
    alert('Failed to load task details');
  }
}

// Helper function for status colors
function getStatusColor(status) {
  const colors = {
    'pending': 'bg-yellow-100 text-yellow-800',
    'assigned': 'bg-blue-100 text-blue-800',
    'in_progress': 'bg-purple-100 text-purple-800',
    'completed': 'bg-green-100 text-green-800',
    'cancelled': 'bg-red-100 text-red-800'
  };
  return colors[status] || 'bg-slate-100 text-slate-800';
}

// Close modals
function closeAssignModal() {
  document.getElementById('assignTaskModal').classList.add('hidden');
  document.getElementById('assignTaskForm').reset();
}

function closeTaskDetailsModal() {
  document.getElementById('taskDetailsModal').classList.add('hidden');
}

function openPhotoModal(photoUrl, description) {
  const modal = document.getElementById('photoModal');
  const image = document.getElementById('photoModalImage');
  const title = document.getElementById('photoModalTitle');

  image.src = photoUrl;
  title.textContent = description || 'Task Photo';
  modal.classList.remove('hidden');
}

function closePhotoModal() {
  document.getElementById('photoModal').classList.add('hidden');
}

// Event listeners for task assignment form
document.getElementById('assignTaskForm').addEventListener('submit', (e) => {
  e.preventDefault();
  handleTaskAssignment();
});

// Event listeners for assignment modal close buttons
document.getElementById('closeAssignModal').addEventListener('click', () => {
  closeAssignModal();
});

document.getElementById('cancelAssignment').addEventListener('click', () => {
  closeAssignModal();
});

// Event listeners for handyman management
document.getElementById('quickAddHandyman').addEventListener('click', () => {
  document.getElementById('addHandymanModal').classList.remove('hidden');
});

// Add event listener for the "Add New Handyman" button in Handyman Management tab
document.getElementById('addNewHandyman').addEventListener('click', () => {
  document.getElementById('addHandymanModal').classList.remove('hidden');
});

// Event listeners for bulk task assignment
document.getElementById('assignBulkTasks').addEventListener('click', () => {
  quickAssignSelected();
});

// Event listener for select all tasks checkbox
document.getElementById('selectAllTasks').addEventListener('change', (e) => {
  const checkboxes = document.querySelectorAll('.task-checkbox');
  checkboxes.forEach(checkbox => {
    checkbox.checked = e.target.checked;
    handleTaskSelection(checkbox);
  });
});

// Add Handyman modal functions
function closeAddHandymanModal() {
  document.getElementById('addHandymanModal').classList.add('hidden');
  document.getElementById('addHandymanForm').reset();
  // Reset checkbox to default (checked) state
  document.getElementById('skipEmailConfirmation').checked = true;
}

// Generate a secure temporary password (same as PostMyStyle approach)
function generateSecurePassword() {
  const adjectives = ['Quick', 'Smart', 'Brave', 'Swift', 'Bright', 'Strong', 'Fast', 'Bold'];
  const nouns = ['Tiger', 'Eagle', 'Wolf', 'Lion', 'Bear', 'Hawk', 'Fox', 'Shark'];
  const numbers = Math.floor(100 + Math.random() * 900); // 3-digit number

  const adjective = adjectives[Math.floor(Math.random() * adjectives.length)];
  const noun = nouns[Math.floor(Math.random() * nouns.length)];

  return `${adjective}${noun}${numbers}`;
}

// Real-time email validation
document.getElementById('handymanEmail')?.addEventListener('input', (e) => {
  const email = e.target.value.trim().toLowerCase();
  const existingHandymen = window.currentHandymenData || [];
  const duplicateEmail = existingHandymen.find(h => h.email?.toLowerCase() === email);

  // Clear any existing validation messages
  let validationMessage = e.target.parentElement.querySelector('.validation-message');
  if (validationMessage) {
    validationMessage.remove();
  }

  if (email && duplicateEmail) {
    // Show inline warning
    validationMessage = document.createElement('div');
    validationMessage.className = 'validation-message text-red-500 text-sm mt-1';
    validationMessage.textContent = `‚ö†Ô∏è This email is already used by ${duplicateEmail.full_name}`;
    e.target.parentElement.appendChild(validationMessage);
    e.target.style.borderColor = '#ef4444';
  } else {
    e.target.style.borderColor = '';
  }
});

// Add Handyman form handler
document.getElementById('addHandymanForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  // FORCE DEBUG OUTPUT
  console.log('üö® HANDYMAN FORM SUBMITTED - DEBUG START üö®');

  const email = document.getElementById('handymanEmail').value.trim().toLowerCase();

  console.log('üîç Raw email input:', document.getElementById('handymanEmail').value);
  console.log('üîç Processed email:', email);
  const fullName = document.getElementById('handymanFullName').value.trim();
  const phone = document.getElementById('handymanPhone').value.trim();
  const city = document.getElementById('handymanCity').value.trim();
  const skills = document.getElementById('handymanSkills').value.trim();
  const skipEmailConfirmation = document.getElementById('skipEmailConfirmation').checked;

  console.log('üîß Email confirmation settings:', {
    skipEmailConfirmation: skipEmailConfirmation,
    willRequireConfirmation: !skipEmailConfirmation
  });

  // Validate required fields
  if (!fullName) {
    alert('Please enter the handyman\'s full name');
    document.getElementById('handymanFullName').focus();
    return;
  }

  if (!email) {
    alert('Please enter an email address');
    document.getElementById('handymanEmail').focus();
    return;
  }

  // Validate email format
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    alert('Please enter a valid email address (e.g., name@domain.com)');
    document.getElementById('handymanEmail').focus();
    return;
  }

  // Check if email already exists in current handymen list
  const existingHandymen = window.currentHandymenData || [];

  // Debug: Log all existing emails
  console.log('üîç Checking against existing emails in handymen table:');
  existingHandymen.forEach((h, index) => {
    console.log(`  ${index + 1}. ${h.full_name}: ${h.email} (ID: ${h.id})`);
  });
  console.log(`üîç New email to check: "${email}"`);

  // ADDITIONAL DEBUG: Check database directly for this specific email
  console.log('üîç Checking database directly for email conflicts...');
  try {
    const { data: directCheck, error: directError } = await supabaseAdmin
      .from('handymen')
      .select('id, email, full_name, is_active, created_at')
      .ilike('email', email);

    console.log('üîç Direct database check result:', directCheck);
    if (directError) {
      console.log('üîç Direct database check error:', directError);
    }

    if (directCheck && directCheck.length > 0) {
      console.log('üö® FOUND CONFLICTING EMAILS IN DATABASE:');
      directCheck.forEach((conflict, idx) => {
        console.log(`  Conflict ${idx + 1}: ${conflict.full_name} - ${conflict.email} (ID: ${conflict.id}, Active: ${conflict.is_active})`);
      });
    }
  } catch (dbError) {
    console.log('üîç Database check failed:', dbError);
  }

  const duplicateEmail = existingHandymen.find(h => h.email?.toLowerCase() === email);
  if (duplicateEmail) {
    alert(`This email is already used by ${duplicateEmail.full_name || 'an existing handyman'}.\n\nPlease use a different email address.`);
    document.getElementById('handymanEmail').focus();
    document.getElementById('handymanEmail').select();
    return;
  }

  try {
    console.log('üîê Creating handyman via Supabase Edge Function...');

    // Get current user session for authentication
    const { data: { session }, error: sessionError } = await supabaseAdmin.auth.getSession();

    if (sessionError || !session) {
      throw new Error('You must be logged in to create handymen. Please refresh and log in again.');
    }

    console.log('User session verified, calling Edge Function...');
    console.log('üîç Attempting to create handyman with email:', email);
    console.log('üîç Full payload:', {
      name: fullName,
      email: email,
      phone: phone || null
    });

    // Use EXACT PostMyStyle approach - Supabase Edge Function
    console.log('üîÑ Using PostMyStyle method - Supabase Edge Function...');

    try {
      console.log('Creating new handyman via Edge Function:', { name: fullName, email });

      // Get current user session for authentication (exact PostMyStyle method)
      const { data: { session }, error: sessionError } = await supabaseAdmin.auth.getSession();

      if (sessionError || !session) {
        throw new Error('You must be logged in to create handymen. Please refresh and log in again.');
      }

      console.log('User session verified, calling Edge Function...');

      // Call the Edge Function (EXACT PostMyStyle approach)
      console.log('üöÄ CALLING EDGE FUNCTION with payload:', {
        name: fullName,
        email: email,
        phone: phone || null
      });

      const { data, error } = await supabaseAdmin.functions.invoke('create-handyman', {
        body: {
          name: fullName,
          email: email,
          phone: phone || null
        },
        headers: {
          Authorization: `Bearer ${session.access_token}`,
        },
      });

      console.log('üì• EDGE FUNCTION RESPONSE DATA:', data);
      console.log('üì• EDGE FUNCTION RESPONSE ERROR:', error);
      console.log('üì• EDGE FUNCTION FULL RESPONSE:', { data, error });

      if (error) {
        console.error('Edge Function error details:', error);
        console.error('Error message:', error.message);
        console.error('Error details:', error.details);
        console.error('Full error object:', JSON.stringify(error, null, 2));

        // Try to get more specific error from Edge Function response
        if (error.context && error.context.body) {
          console.error('Edge Function response body:', error.context.body);
        }

        throw new Error(`Function call failed: ${error.message || 'Edge Function returned a non-2xx status code'}`);
      }

      if (!data.success) {
        throw new Error(data.error || 'Unknown error occurred');
      }

      console.log('‚úÖ Handyman created successfully:', data.handyman);
      console.log('üîë PASSWORD FORMAT CHECK:', {
        password: data.credentials.password,
        length: data.credentials.password?.length,
        type: typeof data.credentials.password,
        hasSpecialChar: /[!@#$]/.test(data.credentials.password || ''),
        hasNumbers: /\d/.test(data.credentials.password || ''),
        hasUppercase: /[A-Z]/.test(data.credentials.password || ''),
        hasLowercase: /[a-z]/.test(data.credentials.password || '')
      });

      // SUCCESS - Show password and close modal
      const handyman = data.handyman;
      const credentials = data.credentials;

      // Show success modal with copy buttons instead of basic alert
      console.log('üéØ CALLING showHandymanCreatedModal with:', {
        name: handyman.full_name || handyman.name,
        email: handyman.email,
        password: credentials.password,
        authId: data.auth_user_id || handyman.auth_user_id,
        handymanId: handyman.id
      });

      try {
        showHandymanCreatedModal(
          handyman.full_name || handyman.name,
          handyman.email,
          credentials.password,
          data.auth_user_id || handyman.auth_user_id,
          handyman.id
        );
        console.log('‚úÖ Modal function called successfully');
      } catch (modalError) {
        console.error('‚ùå Error calling modal function:', modalError);
        // Fallback to basic alert if modal fails
        alert(`‚úÖ Handyman Created Successfully!

Name: ${handyman.full_name || handyman.name}
Email: ${handyman.email}
Password: ${credentials.password}

Copy these credentials manually.`);
      }

      // Reset form and close modal
      const form = document.getElementById('addHandymanForm');
      if (form) form.reset();

      // Close the modal
      document.getElementById('addHandymanModal').classList.add('hidden');

      // Refresh the handymen list
      loadHandymenData();
      return; // Exit here on success

    } catch (fetchError) {
      console.error('üîÑ Edge Function error:', fetchError);
      console.log('üîÑ Trying direct database approach as fallback...');

      // FALLBACK: Direct database approach
      try {
        const tempPassword = generateSecurePassword();
        console.log('üîÑ Creating auth user directly...');

        // Create auth user directly with email confirmation disabled for admin users
        const { data: authData, error: authError } = await supabaseAdmin.auth.signUp({
          email: email,
          password: tempPassword,
          options: {
            emailRedirectTo: `${window.location.origin}/login.html`,
            data: {
              full_name: fullName,
              user_type: 'handyman',
              created_by_admin: true // Mark as admin-created
            },
            shouldCreateUser: true
          }
        });

        if (authError) {
          console.error('‚ùå Direct auth creation failed:', authError);
          throw new Error(`Direct auth creation failed: ${authError.message}`);
        }

        console.log('‚úÖ Auth user created directly:', authData.user?.id);
        console.log('üîç User confirmation status:', {
          email_confirmed_at: authData.user?.email_confirmed_at,
          confirmation_sent_at: authData.user?.confirmation_sent_at,
          confirmed: !!authData.user?.email_confirmed_at
        });

        // Provide appropriate instructions based on checkbox setting
        if (!authData.user?.email_confirmed_at) {
          if (skipEmailConfirmation) {
            console.log('üîß MANUAL ACTION REQUIRED: Email confirmation bypassed per admin setting');
            console.log('üìã TO COMPLETE SETUP:');
            console.log('   1. Go to Supabase Dashboard > SQL Editor');
            console.log('   2. Run these queries to confirm email and fix full_name:');
            console.log(`   UPDATE auth.users SET email_confirmed_at = NOW() WHERE email = '${email}';`);
            console.log(`   UPDATE handymen SET full_name = '${fullName}' WHERE email = '${email}';`);
            console.log('   3. User can then log in immediately');
          } else {
            console.log('‚úâÔ∏è Email confirmation required - user must confirm via email before login');
          }
        }

        // Create handyman record directly (this might still fail due to RLS, but let's try)
        console.log('üîç Inserting handyman record with data:', {
          user_id: authData.user?.id,
          email: email.toLowerCase(),
          full_name: fullName,
          phone: phone || null,
          hourly_rate: 64.00,
          onboarding_completed: false,
          is_active: true
        });

        const { data: handyman, error: handymanError } = await supabaseAdmin
          .from('handymen')
          .insert({
            user_id: authData.user?.id,
            email: email.toLowerCase(),
            full_name: fullName,
            phone: phone || null,
            hourly_rate: 64.00,
            onboarding_completed: false,
            is_active: true
          })
          .select()
          .single();

        if (handymanError) {
          console.error('‚ùå Direct handyman creation failed:', handymanError);

          // Check if the error is due to the record already existing
          if (handymanError.message?.includes('duplicate key value violates unique constraint')) {
            console.log('üîç Checking if handyman was created despite error...');
            const { data: existingRecord, error: checkError } = await supabaseAdmin
              .from('handymen')
              .select('*')
              .eq('email', email.toLowerCase())
              .single();

            if (existingRecord && !checkError) {
              console.log('‚úÖ Handyman record found despite error:', existingRecord);

              // Fix null full_name if needed
              if (!existingRecord.full_name || existingRecord.full_name === null) {
                console.log('üîß Fixing null full_name for existing record...');
                console.log('üîç Full name to update:', {
                  fullName: fullName,
                  type: typeof fullName,
                  length: fullName?.length,
                  existingRecordId: existingRecord.id
                });
                const { error: updateError } = await supabaseAdmin
                  .from('handymen')
                  .update({ full_name: fullName })
                  .eq('id', existingRecord.id);

                if (updateError) {
                  console.warn('‚ö†Ô∏è Could not update full_name:', updateError);
                } else {
                  existingRecord.full_name = fullName;
                  console.log('‚úÖ Fixed null full_name');
                }
              }

              // The record was actually created successfully
              const response = {
                ok: true,
                json: async () => ({
                  success: true,
                  handyman: {
                    id: existingRecord.id,
                    name: existingRecord.full_name,
                    email: existingRecord.email,
                    auth_user_id: authData.user?.id
                  },
                  credentials: {
                    email: email,
                    password: tempPassword
                  }
                })
              };

              // Continue with success flow
              const data = await response.json();
              console.log('‚úÖ Using existing handyman record:', data);

              const handymanInfo = data.handyman || data;
              const credentials = data.credentials || {
                email: email,
                password: 'Contact admin for password'
              };

              showHandymanCreatedModal(
                handymanInfo.name || handymanInfo.full_name || fullName,
                credentials.email,
                credentials.password,
                handymanInfo.auth_user_id || authData.user?.id,
                handymanInfo.id
              );

              document.getElementById('addHandymanForm').reset();
              document.getElementById('addHandymanModal').classList.add('hidden');
              loadHandymenData();
              return;
            }
          }

          throw new Error(`Direct handyman creation failed: ${handymanError.message}`);
        }

        console.log('‚úÖ Handyman created directly:', handyman);

        // Create response object for success handling
        const response = {
          ok: true,
          json: async () => ({
            success: true,
            handyman: {
              id: handyman.id,
              name: handyman.full_name,
              email: handyman.email,
              auth_user_id: authData.user?.id
            },
            credentials: {
              email: email,
              password: tempPassword
            }
          })
        };

        // Continue with success flow
        const data = await response.json();
        console.log('‚úÖ Direct creation successful:', data);

        // Continue to success handling
        const handymanInfo = data.handyman || data;
        const credentials = data.credentials || {
          email: email,
          password: 'Contact admin for password'
        };

        // Show success modal
        showHandymanCreatedModal(
          handymanInfo.name || handymanInfo.full_name || fullName,
          credentials.email,
          credentials.password,
          handymanInfo.auth_user_id || data.auth_user_id,
          handymanInfo.id || data.handyman_id
        );

        // Clear form and refresh
        document.getElementById('addHandymanForm').reset();
        closeAddHandymanModal();
        loadHandymenData();

        return; // Success! Exit the function

      } catch (directError) {
        console.error('‚ùå Direct approach also failed:', directError);
        throw new Error(`All creation methods failed. Last error: ${directError.message}`);
      }
    }

  } catch (error) {
    console.error('‚ùå Error creating handyman:', error);

    let errorMessage = error.message;

    // Provide more specific error messages
    if (errorMessage.includes('duplicate key value violates unique constraint "handymen_email_key"')) {
      errorMessage = `This email address is already in use by another handyman.\n\nPlease use a different email address.`;
      document.getElementById('handymanEmail').focus();
      document.getElementById('handymanEmail').select();
    } else if (errorMessage.includes('Email already exists') || errorMessage.includes('is registered to')) {
      errorMessage = `This email address is already registered in the system.\n\nPlease use a different email address or check the existing handyman in the list below.`;
      document.getElementById('handymanEmail').focus();
      document.getElementById('handymanEmail').select();

      // Highlight existing handyman with this email if visible
      highlightExistingHandyman(email);
    } else if (errorMessage.includes('Invalid email format')) {
      errorMessage = 'Please enter a valid email address (e.g., name@domain.com)';
      document.getElementById('handymanEmail').focus();
    } else if (errorMessage.includes('Name and email required')) {
      errorMessage = 'Please fill in both the name and email fields';
    }

    alert(`Failed to create handyman:\n\n${errorMessage}`);
  }
});

// Function to highlight existing handyman with duplicate email
function highlightExistingHandyman(email) {
  // Find all handyman rows and check for matching email
  const handymanRows = document.querySelectorAll('#handymanTableBody tr');

  handymanRows.forEach(row => {
    const emailCell = row.querySelector('td:nth-child(3)'); // Email is usually 3rd column
    if (emailCell && emailCell.textContent.toLowerCase().trim() === email.toLowerCase()) {
      // Add highlighting
      row.style.backgroundColor = '#fef2f2'; // Light red background
      row.style.border = '2px solid #fca5a5'; // Red border

      // Scroll to the row if it's not visible
      row.scrollIntoView({ behavior: 'smooth', block: 'center' });

      // Remove highlighting after 5 seconds
      setTimeout(() => {
        row.style.backgroundColor = '';
        row.style.border = '';
      }, 5000);
    }
  });
}

// PostMyStyle-style success modal for handyman creation
function showHandymanCreatedModal(fullName, email, password, authUserId, handymanId) {
  console.log('üéØ showHandymanCreatedModal function called with:', {
    fullName, email, password, authUserId, handymanId
  });

  // Create modal HTML dynamically
  const modalHtml = `
    <div id="handymanCreatedModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
      <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
        <div class="text-center">
          <!-- Success Icon -->
          <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
            <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>

          <!-- Title -->
          <h3 class="text-lg font-medium text-gray-900 mb-2">Handyman Created Successfully!</h3>
          <p class="text-sm text-gray-500 mb-6">${fullName} has been added to the system</p>

          <!-- Credentials Section -->
          <div class="bg-gray-50 rounded-lg p-4 mb-4">
            <h4 class="text-sm font-medium text-gray-900 mb-3">Account Credentials</h4>

            <!-- Email Row -->
            <div class="flex items-center justify-between mb-3">
              <span class="text-sm text-gray-600">Email:</span>
              <div class="flex items-center gap-2">
                <span class="text-sm font-mono bg-white px-3 py-2 rounded border flex-1">${email}</span>
                <button onclick="copyToClipboard('${email}')"
                        title="Copy email to clipboard"
                        class="bg-blue-100 text-blue-600 hover:bg-blue-200 hover:text-blue-800 px-3 py-2 rounded transition-colors">
                  üìß Copy
                </button>
              </div>
            </div>

            <!-- Password Row -->
            <div class="flex items-center justify-between mb-3">
              <span class="text-sm text-gray-600">Password:</span>
              <div class="flex items-center gap-2">
                <span class="text-sm font-mono bg-white px-3 py-2 rounded border flex-1">${password}</span>
                <button onclick="copyToClipboard('${password}')"
                        title="Copy password to clipboard"
                        class="bg-blue-100 text-blue-600 hover:bg-blue-200 hover:text-blue-800 px-3 py-2 rounded transition-colors">
                  üîë Copy
                </button>
              </div>
            </div>

            <!-- Dashboard URL Row -->
            <div class="flex items-center justify-between mb-3">
              <span class="text-sm text-gray-600">Dashboard:</span>
              <div class="flex items-center gap-2">
                <span class="text-sm font-mono bg-white px-3 py-2 rounded border flex-1">sendahandyman.com/dashboard</span>
                <button onclick="copyToClipboard('https://sendahandyman.com/dashboard')"
                        title="Copy dashboard URL to clipboard"
                        class="bg-blue-100 text-blue-600 hover:bg-blue-200 hover:text-blue-800 px-3 py-2 rounded transition-colors">
                  üîó Copy
                </button>
              </div>
            </div>

            <!-- IDs for reference -->
            <div class="mt-3 pt-3 border-t border-gray-200">
              <div class="text-xs text-gray-500">
                <div>Auth ID: ${authUserId}</div>
                <div>Handyman ID: ${handymanId}</div>
              </div>
            </div>
          </div>

          <!-- Next Steps -->
          <div class="bg-blue-50 rounded-lg p-4 mb-4">
            <h4 class="text-sm font-medium text-blue-900 mb-2">Next Steps</h4>
            <ul class="text-sm text-blue-800 space-y-1 text-left">
              <li>‚Ä¢ Share credentials with ${fullName}</li>
              <li>‚Ä¢ Direct them to <span class="font-mono">sendahandyman.com/dashboard</span></li>
              <li>‚Ä¢ They need to complete onboarding process</li>
              <li>‚Ä¢ Skills and profile setup required</li>
            </ul>
          </div>

          <!-- Copy All Button -->
          <button onclick="copyAllCredentials('${email}', '${password}')"
                  class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition duration-200 mb-3 font-medium text-lg">
            üìã Copy All Credentials
          </button>

          <!-- Individual Copy Buttons Row -->
          <div class="grid grid-cols-3 gap-2 mb-4">
            <button onclick="copyToClipboard('${email}')"
                    class="bg-blue-100 text-blue-700 py-2 px-3 rounded text-sm hover:bg-blue-200 transition-colors">
              üìß Email
            </button>
            <button onclick="copyToClipboard('${password}')"
                    class="bg-purple-100 text-purple-700 py-2 px-3 rounded text-sm hover:bg-purple-200 transition-colors">
              üîë Password
            </button>
            <button onclick="copyToClipboard('https://sendahandyman.com/dashboard')"
                    class="bg-orange-100 text-orange-700 py-2 px-3 rounded text-sm hover:bg-orange-200 transition-colors">
              üîó Link
            </button>
          </div>

          <!-- Close Button -->
          <button onclick="closeHandymanCreatedModal()"
                  class="w-full bg-gray-100 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-200 transition duration-200">
            Close
          </button>
        </div>
      </div>
    </div>
  `;

  // Remove existing modal if present
  const existingModal = document.getElementById('handymanCreatedModal');
  if (existingModal) {
    existingModal.remove();
  }

  // Add modal to DOM
  console.log('üìù Adding modal to DOM...');
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  console.log('‚úÖ Modal added to DOM successfully');

  // Force browser to refresh/reflow
  setTimeout(() => {
    const modal = document.getElementById('handymanCreatedModal');
    if (modal) {
      console.log('‚úÖ Modal element found in DOM:', modal);
    } else {
      console.error('‚ùå Modal element not found in DOM after insertion');
    }
  }, 100);
}

// Copy functions for the success modal
function copyToClipboard(text) {
  console.log('üìã Attempting to copy:', text);

  // Modern clipboard API (requires HTTPS)
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(text).then(() => {
      console.log('‚úÖ Successfully copied to clipboard');
      showCopyFeedback('Copied to clipboard!');
    }).catch(err => {
      console.error('‚ùå Clipboard API failed:', err);
      fallbackCopy(text);
    });
  } else {
    console.warn('‚ö†Ô∏è Clipboard API not available, using fallback');
    fallbackCopy(text);
  }
}

// Fallback copy method for non-HTTPS or unsupported browsers
function fallbackCopy(text) {
  try {
    // Create temporary textarea element
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.left = '-999999px';
    textarea.style.top = '-999999px';
    document.body.appendChild(textarea);
    textarea.focus();
    textarea.select();

    // Use document.execCommand as fallback
    const successful = document.execCommand('copy');
    document.body.removeChild(textarea);

    if (successful) {
      console.log('‚úÖ Fallback copy successful');
      showCopyFeedback('Copied to clipboard!');
    } else {
      console.error('‚ùå Fallback copy failed');
      showCopyFeedback('Copy failed - please select and copy manually', 'error');
    }
  } catch (err) {
    console.error('‚ùå All copy methods failed:', err);
    // Final fallback - show the text for manual copying
    prompt('Copy this text manually (Ctrl+C):', text);
  }
}

// Show copy feedback to user
function showCopyFeedback(message, type = 'success') {
  // Create temporary visual feedback
  const feedback = document.createElement('div');
  feedback.textContent = message;
  feedback.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${type === 'success' ? '#10b981' : '#ef4444'};
    color: white;
    padding: 12px 20px;
    border-radius: 6px;
    z-index: 9999;
    font-size: 14px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  `;
  document.body.appendChild(feedback);

  // Remove after 3 seconds
  setTimeout(() => {
    if (feedback.parentNode) {
      feedback.parentNode.removeChild(feedback);
    }
  }, 3000);
}

function copyAllCredentials(email, password) {
  const credentials = `Handyman Account Credentials:
Email: ${email}
Password: ${password}
Dashboard: sendahandyman.com/dashboard

Please complete your onboarding process after logging in.`;

  console.log('üìã Attempting to copy all credentials');

  // Use the same robust copy function
  copyToClipboard(credentials);
}

function closeHandymanCreatedModal() {
  const modal = document.getElementById('handymanCreatedModal');
  if (modal) {
    modal.remove();
  }
}

// Simple toast notification system for copy feedback
window.addEventListener('showToast', (e) => {
  const { message, type } = e.detail;

  // Remove existing toast
  const existingToast = document.getElementById('copyToast');
  if (existingToast) {
    existingToast.remove();
  }

  // Create toast
  const toast = document.createElement('div');
  toast.id = 'copyToast';
  toast.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white text-sm font-medium ${
    type === 'success' ? 'bg-green-500' : 'bg-red-500'
  } transform transition-all duration-300`;
  toast.textContent = message;

  document.body.appendChild(toast);

  // Auto remove after 2 seconds
  setTimeout(() => {
    if (toast) {
      toast.remove();
    }
  }, 2000);
});

// Initialize event listeners when DOM is ready
function initializeEventListeners() {
  console.log('üîß Initializing event listeners...');

  // Edit handyman modal event listeners
  const editForm = document.getElementById('editHandymanForm');
  const closeEditModal = document.getElementById('closeEditHandymanModal');
  const cancelEditButton = document.getElementById('cancelEditHandyman');

  if (editForm) {
    editForm.addEventListener('submit', (e) => {
      e.preventDefault();
      saveHandymanEdits();
    });
    console.log('‚úÖ Edit form submit listener attached');
  } else {
    console.error('‚ùå Edit form not found');
  }

  if (closeEditModal) {
    closeEditModal.addEventListener('click', () => {
      closeEditHandymanModal();
    });
    console.log('‚úÖ Close edit modal listener attached');
  } else {
    console.error('‚ùå Close edit modal button not found');
  }

  // Details modal event listeners
  const closeDetailsModal = document.getElementById('closeHandymanDetailsModal');
  if (closeDetailsModal) {
    closeDetailsModal.addEventListener('click', () => {
      closeHandymanDetailsModal();
    });
    console.log('‚úÖ Close details modal listener attached');
  } else {
    console.error('‚ùå Close details modal button not found');
  }

  if (cancelEditButton) {
    cancelEditButton.addEventListener('click', () => {
      closeEditHandymanModal();
    });
    console.log('‚úÖ Cancel edit button listener attached');
  } else {
    console.error('‚ùå Cancel edit button not found');
  }

  console.log('‚úÖ All event listeners initialized');

  // Add event delegation for edit handyman buttons
  document.addEventListener('click', function(e) {
    console.log('üëÜ Click detected on element:', e.target.tagName, e.target.className);

    if (e.target && e.target.classList.contains('edit-handyman-btn')) {
      const handymanId = e.target.getAttribute('data-handyman-id');
      console.log(`üéØ Edit button clicked for handyman: ${handymanId}`);
      if (handymanId) {
        try {
          console.log('üîÑ Calling editHandyman function...');
          editHandyman(handymanId);
        } catch (error) {
          console.error('‚ùå Error calling editHandyman:', error);
        }
      } else {
        console.error('‚ùå No handyman ID found on edit button');
      }
    }
  });
  console.log('‚úÖ Event delegation for edit buttons added');

  // Test if editHandyman function is available
  if (typeof editHandyman === 'function') {
    console.log('‚úÖ editHandyman function is available');
  } else {
    console.error('‚ùå editHandyman function is not available');
  }

  // Ensure function is globally accessible
  if (typeof window.editHandyman !== 'function') {
    window.editHandyman = editHandyman;
    console.log('üìå editHandyman attached to window object');
  }

  // Test window function
  if (typeof window.editHandyman === 'function') {
    console.log('‚úÖ window.editHandyman is available');
  } else {
    console.error('‚ùå window.editHandyman is not available');
  }

  // Add refresh button event listeners
  const refreshHandymen = document.getElementById('refreshHandymen');
  const refreshQuotes = document.getElementById('refreshQuotes');
  const refreshTasks = document.getElementById('refreshTasks');

  if (refreshHandymen) {
    refreshHandymen.addEventListener('click', () => {
      console.log('üîÑ Refreshing handymen data...');
      loadHandymenData();
    });
    console.log('‚úÖ Refresh handymen button listener attached');
  }

  if (refreshQuotes) {
    refreshQuotes.addEventListener('click', () => {
      console.log('üîÑ Refreshing quotes data...');
      loadQuotesData();
    });
    console.log('‚úÖ Refresh quotes button listener attached');
  }

  if (refreshTasks) {
    refreshTasks.addEventListener('click', () => {
      console.log('üîÑ Refreshing tasks data...');
      loadTasksData();
    });
    console.log('‚úÖ Refresh tasks button listener attached');
  }

  // Auto-refresh task manager every 30 seconds when on tasks tab
  setInterval(() => {
    const activeTab = document.querySelector('.admin-nav-btn.active');
    if (activeTab && activeTab.textContent.includes('Task Manager')) {
      console.log('üîÑ Auto-refreshing tasks data...');
      loadTasksData();
    }
  }, 30000); // 30 seconds

  console.log('‚úÖ Auto-refresh for tasks enabled (30s interval)');
}

// Initialize when DOM is fully loaded
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeEventListeners);
} else {
  initializeEventListeners();
}

console.log('üîê Admin dashboard loaded');
</script>

</body>
</html>