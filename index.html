<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>SendAHandyman ‚Äî Fix anything with SendAHandyman</title>
    <meta name="description" content="Book a vetted handyman today or tomorrow. Upload photos, get an instant AI estimate, and reserve with your card. Serving Palm Beach, Broward & Miami-Dade." />

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
    <link rel="apple-touch-icon" href="/images/favicon.png">

    <!-- Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17598022946"></script>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-PW9HC7HL');</script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'AW-17598022946');
    </script>

    <!-- Styles -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet CSS and JS for interactive maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

    <style>
        /* Uber-inspired Design System */
        :root {
            --uber-black: #000000;
            --uber-white: #ffffff;
            --uber-gray-50: #f7f7f7;
            --uber-gray-100: #eeeeee;
            --uber-gray-200: #e5e5e5;
            --uber-gray-300: #d1d1d1;
            --uber-gray-400: #9e9e9e;
            --uber-gray-500: #757575;
            --uber-gray-600: #616161;
            --uber-gray-700: #424242;
            --uber-gray-800: #212121;
            --uber-green: #00b341;
            --uber-green-dark: #009639;
            --uber-blue: #276ef1;
            --uber-orange: #ff6b00;
            --uber-red: #e53935;
        }

        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
        }

        .uber-container {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--uber-gray-50) 0%, var(--uber-white) 100%);
        }

        .main-search-container {
            background: var(--uber-white);
            border-radius: 16px;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--uber-gray-200);
        }

        .search-input {
            border: none;
            outline: none;
            font-size: 16px;
            color: var(--uber-black);
            background: transparent;
            width: 100%;
        }

        .search-input::placeholder {
            color: var(--uber-gray-500);
        }

        .service-card {
            background: var(--uber-white);
            border: 2px solid var(--uber-gray-200);
            border-radius: 16px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .service-card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            border-color: var(--uber-black);
            transform: translateY(-2px);
        }

        .service-card:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--uber-black);
            color: var(--uber-white);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary:hover {
            background: var(--uber-gray-800);
        }

        .btn-primary:disabled {
            background: var(--uber-gray-300);
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--uber-gray-100);
            color: var(--uber-black);
            border: 1px solid var(--uber-gray-200);
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: var(--uber-gray-200);
        }

        /* Enhanced Mobile Touch Targets */
        .btn-primary, .btn-secondary {
            min-height: 44px;
            min-width: 44px;
            padding: 12px 24px;
            font-size: 16px;
        }

        .service-card {
            min-height: 80px;
            padding: 20px;
            margin-bottom: 16px;
        }

        /* Enhanced service cards with better spacing and shadows */
        .service-card {
            background: var(--uber-white);
            border: 1px solid var(--uber-gray-200);
            border-radius: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .service-card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            border-color: var(--uber-blue);
            transform: translateY(-2px);
        }

        .service-card:active {
            transform: translateY(0);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        /* Focus states for accessibility */
        .service-card:focus,
        .btn-primary:focus,
        .btn-secondary:focus {
            outline: 2px solid var(--uber-blue);
            outline-offset: 2px;
        }

        /* Toast notification styles */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--uber-white);
            border-left: 4px solid var(--uber-green);
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            padding: 16px 20px;
            z-index: 1000;
            max-width: 400px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            border-left-color: var(--uber-red);
        }

        .toast.warning {
            border-left-color: var(--uber-orange);
        }

        /* Mobile-first sticky bottom bar */
        .sticky-bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--uber-white);
            border-top: 1px solid var(--uber-gray-200);
            padding: 16px 20px;
            box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.08);
            z-index: 50;
        }

        /* Loading states */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--uber-gray-200);
            border-top: 4px solid var(--uber-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 8px grid system spacing */
        .space-y-8 > * + * {
            margin-top: 32px;
        }

        .space-y-6 > * + * {
            margin-top: 24px;
        }

        .space-y-4 > * + * {
            margin-top: 16px;
        }

        .location-indicator {
            color: var(--uber-gray-600);
            font-size: 14px;
        }

        .progress-bar {
            height: 4px;
            background: var(--uber-gray-200);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--uber-black);
            transition: width 0.3s ease;
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: var(--uber-white);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        .photo-upload-area {
            border: 2px dashed var(--uber-gray-300);
            border-radius: 12px;
            background: var(--uber-gray-50);
            transition: all 0.2s ease;
        }

        .photo-upload-area:hover {
            border-color: var(--uber-blue);
            background: #f8f9ff;
        }

        .category-chip {
            background: var(--uber-gray-100);
            color: var(--uber-gray-700);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .category-chip:hover {
            background: var(--uber-gray-200);
        }

        .category-chip.active {
            background: var(--uber-black);
            color: var(--uber-white);
        }

        .floating-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--uber-gray-100);
        }

        @media (max-width: 768px) {
            .main-search-container {
                border-radius: 12px;
                margin: 16px;
            }
        }

        /* Custom animations */
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-up {
            animation: slideUp 0.3s ease;
        }

        .hide {
            display: none !important;
        }

        .show {
            display: block;
        }

        /* AI Analysis styles */
        .ai-badge {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .estimate-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            padding: 24px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--uber-gray-300);
            border-top: 2px solid var(--uber-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body class="uber-container">
    <!-- Floating Header -->
    <header class="floating-header fixed top-0 left-0 right-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img src="/images/helpinghands_logo.png" alt="SendAHandyman" class="h-9 w-auto">
                    <span class="font-bold text-xl">SendAHandyman</span>
                </div>

                <nav class="hidden md:flex items-center gap-6">
                    <a href="concierge.html" class="text-gray-600 hover:text-black transition-colors">Concierge</a>
                    <a href="join-team.html" class="text-gray-600 hover:text-black transition-colors">Join Our Team</a>
                    <button onclick="showLoginModal()" class="text-gray-600 hover:text-black transition-colors">Sign In</button>
                </nav>

                <button class="md:hidden p-2" onclick="toggleMobileMenu()">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pt-20">
        <!-- Landing Screen -->
        <div id="landingScreen" class="min-h-screen flex flex-col">
            <!-- Hero Section -->
            <div class="flex-1 flex flex-col justify-center px-4 py-12">
                <div class="max-w-2xl mx-auto text-center mb-8">
                    <h1 class="text-4xl md:text-6xl font-bold text-black mb-6 leading-tight">
                        What do you need help with?
                    </h1>
                    <p class="text-xl md:text-2xl text-gray-600 mb-12 font-medium">
                        Fix anything with SendAHandyman
                    </p>
                </div>

                <!-- Main Search Box -->
                <div class="max-w-2xl mx-auto w-full mb-8">
                    <div class="main-search-container p-4">
                        <div class="flex items-center gap-3">
                            <div class="w-6 h-6 bg-black rounded-full flex-shrink-0"></div>
                            <input
                                type="text"
                                class="search-input"
                                placeholder="Describe your repair or project..."
                                id="mainSearchInput"
                                onkeypress="handleSearchKeyPress(event)"
                            />
                            <button onclick="startServiceFlow()" class="btn-primary px-6 py-2">
                                Search
                            </button>
                        </div>
                        <div class="mt-3 flex items-center gap-2 px-9">
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            <span class="location-indicator" id="locationIndicator">Detecting location...</span>
                        </div>
                    </div>
                </div>

                <!-- Service Categories -->
                <div class="max-w-5xl mx-auto mb-8">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
                        <div class="service-card p-6 text-center" onclick="selectService('light-plumbing')">
                            <div class="text-4xl mb-3">üöø</div>
                            <div class="font-semibold text-base">Light Plumbing</div>
                        </div>
                        <div class="service-card p-6 text-center" onclick="selectService('electrical')">
                            <div class="text-4xl mb-3">‚ö°</div>
                            <div class="font-semibold text-base">Electrical</div>
                        </div>
                        <div class="service-card p-6 text-center" onclick="selectService('mounting')">
                            <div class="text-4xl mb-3">üì∫</div>
                            <div class="font-semibold text-base">TV Mounting</div>
                        </div>
                        <div class="service-card p-6 text-center" onclick="selectService('furniture')">
                            <div class="text-4xl mb-3">ü™ë</div>
                            <div class="font-semibold text-base">Furniture</div>
                        </div>
                        <div class="service-card p-6 text-center" onclick="selectService('painting')">
                            <div class="text-4xl mb-3">üé®</div>
                            <div class="font-semibold text-base">Painting</div>
                        </div>
                        <div class="service-card p-6 text-center" onclick="selectService('appliances')">
                            <div class="text-4xl mb-3">üîå</div>
                            <div class="font-semibold text-base">Appliances</div>
                        </div>
                        <div class="service-card p-6 text-center" onclick="selectService('repair')">
                            <div class="text-4xl mb-3">üî®</div>
                            <div class="font-semibold text-base">General Repair</div>
                        </div>
                        <div class="service-card p-6 text-center"
                             onclick="showAllServices()"
                             tabindex="0"
                             role="button"
                             aria-label="View more services"
                             onkeypress="handleEnterKey(event, showAllServices)">
                            <div class="text-4xl mb-3">‚ûï</div>
                            <div class="font-semibold text-base">More...</div>
                        </div>
                    </div>
                </div>

                <!-- Availability Indicator -->
                <div class="max-w-2xl mx-auto text-center mb-8">
                    <div class="inline-flex items-center gap-2 bg-green-100 text-green-800 px-4 py-2 rounded-full">
                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                        <span class="font-semibold text-sm" id="availabilityText">Available tomorrow onwards</span>
                    </div>
                </div>

                <!-- Map and Handyman List Section -->
                <div class="max-w-7xl mx-auto mb-12">
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <!-- Map Section -->
                        <div class="lg:col-span-3">
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                                <h3 class="font-semibold mb-4 text-gray-800">Available Handymen in Your Area</h3>

                                <!-- Map Container -->
                                <div class="relative">
                                    <div id="mainHandymanMap" class="w-full h-80 rounded-lg border border-gray-300 mb-4" style="display: none;">
                                        <!-- Leaflet map will be initialized here -->
                                    </div>
                                    <!-- Recenter Button -->
                                    <button id="recenterButton"
                                            onclick="recenterMainPageMap()"
                                            class="absolute top-3 right-3 bg-white shadow-lg hover:bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 text-sm font-medium text-gray-700 z-[1000] transition-colors"
                                            style="display: none;"
                                            title="Recenter map to your location">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                            <circle cx="12" cy="12" r="2"/>
                                        </svg>
                                    </button>
                                </div>

                                <!-- Map Loading State -->
                                <div id="mapLoadingState" class="w-full h-80 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center mb-4">
                                    <div class="text-center text-gray-500">
                                        <div class="text-4xl mb-2">üìç</div>
                                        <div class="text-sm">Detecting location...</div>
                                    </div>
                                </div>

                                <!-- Selected Handyman Details (Full Width) -->
                                <div id="compactHandymanDetails" class="bg-blue-50 border border-blue-200 rounded-lg p-4" style="display: none;">
                                    <!-- Handyman details will appear here -->
                                </div>
                            </div>
                        </div>

                        <!-- Handyman List (Right Side) -->
                        <div class="lg:col-span-1">
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 h-fit">
                                <h3 class="font-semibold mb-4 text-gray-800">Available Now</h3>

                                <!-- Handymen List -->
                                <div id="compactHandymanList" class="space-y-3" style="display: none;">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Service Selection Flow -->
        <div id="serviceFlow" class="hide min-h-screen">
            <!-- Enhanced Progress Indicator -->
            <div class="bg-white border-b border-gray-100 py-4 px-4 mb-6">
                <div class="max-w-2xl mx-auto">
                    <div id="progressStepper" class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div id="step1" class="flex items-center">
                                <div class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-sm font-semibold">1</div>
                                <span class="ml-2 text-sm font-medium text-gray-900 hidden sm:inline">Service</span>
                            </div>
                            <div class="w-8 h-0.5 bg-gray-200 mx-2 sm:mx-4" id="connector1"></div>
                        </div>
                        <div class="flex items-center">
                            <div id="step2" class="flex items-center">
                                <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center text-sm font-semibold">2</div>
                                <span class="ml-2 text-sm font-medium text-gray-500 hidden sm:inline">Time</span>
                            </div>
                            <div class="w-8 h-0.5 bg-gray-200 mx-2 sm:mx-4" id="connector2"></div>
                        </div>
                        <div class="flex items-center">
                            <div id="step3" class="flex items-center">
                                <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center text-sm font-semibold">3</div>
                                <span class="ml-2 text-sm font-medium text-gray-500 hidden sm:inline">Details</span>
                            </div>
                            <div class="w-8 h-0.5 bg-gray-200 mx-2 sm:mx-4" id="connector3"></div>
                        </div>
                        <div class="flex items-center">
                            <div id="step4" class="flex items-center">
                                <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center text-sm font-semibold">4</div>
                                <span class="ml-2 text-sm font-medium text-gray-500 hidden sm:inline">Book</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Service Details -->
            <div id="serviceDetails" class="max-w-2xl mx-auto px-4">
                <!-- Back Button -->
                <button onclick="goBack()" class="flex items-center gap-2 mb-6 text-gray-600 hover:text-black">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                    Back
                </button>

                <div id="serviceContent">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="py-10 border-t border-gray-100 text-sm text-gray-600">
        <div class="max-w-6xl mx-auto px-4 flex flex-col md:flex-row items-center justify-between gap-3">
            <div class="flex items-center gap-2">
                <img src="/images/favicon.png" alt="SendAHandyman Logo" class="h-8 w-auto">
                <span>¬© <span id="year"></span> SendAHandyman v <span id="version">3.0.0</span></span>
            </div>
            <div class="flex items-center gap-4">
                <a href="privacy.html" class="hover:text-gray-900">Privacy</a>
                <a href="terms.html" class="hover:text-gray-900">Terms</a>
                <a href="mailto:info@sendahandyman.com" class="hover:text-gray-900">Contact</a>
                <a href="faq.html" class="hover:text-gray-900">FAQ</a>
                <button onclick="window.location.href='index-original.html'" class="hover:text-gray-900">Classic View</button>
            </div>
        </div>
    </footer>

    <!-- AI Photo Analysis Modal -->
    <div id="photoModal" class="hide fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4" onclick="closePhotoModalIfClickedOutside(event)">
        <div class="modal-content max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold">AI Photo Analysis</h3>
                    <button onclick="closePhotoModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <!-- Photo Upload Area -->
                <div id="photoUploadArea" class="photo-upload-area p-8 text-center mb-4">
                    <div id="uploadPrompt">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 16m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <h4 class="text-lg font-semibold mb-2">Upload a photo of the issue</h4>
                        <p class="text-gray-600 mb-4">Get an instant AI analysis and cost estimate</p>

                        <div class="space-y-3">
                            <button onclick="triggerCamera()" class="btn-primary w-full py-3">
                                üì∑ Take Photo
                            </button>
                            <button onclick="triggerGallery()" class="btn-secondary w-full py-3">
                                üñºÔ∏è Choose from Gallery
                            </button>
                        </div>

                        <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden" onchange="handlePhotoUpload(event)" />
                        <input type="file" id="galleryInput" accept="image/jpeg,image/jpg,image/png,image/webp,image/gif" class="hidden" onchange="handlePhotoUpload(event)" />
                        <p class="text-sm text-gray-500 mt-4">JPG, PNG, WebP, GIF ‚Ä¢ Max 3.7MB</p>
                    </div>

                    <!-- Photo Preview -->
                    <div id="photoPreview" class="hide">
                        <img id="previewImage" class="max-w-full max-h-64 mx-auto rounded-lg mb-4 object-contain" />
                        <div class="space-y-3">
                            <button id="analyzeBtn" onclick="analyzePhoto()" class="btn-primary w-full py-3">
                                <span class="ai-badge mr-2">AI</span>
                                Analyze with AI
                            </button>
                            <button onclick="retakePhoto()" class="btn-secondary w-full py-3">
                                üì∑ Take Different Photo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- AI Analysis Loading -->
                <div id="analysisLoading" class="hide text-center py-8">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="text-lg font-semibold">AI is analyzing your photo...</p>
                    <p class="text-sm text-gray-500">This may take 10-45 seconds</p>
                </div>

                <!-- AI Results -->
                <div id="analysisResults" class="hide">
                    <!-- Results will be populated here -->
                </div>

                <!-- Error Display -->
                <div id="photoError" class="hide bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-red-600 mr-3 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div>
                            <h4 class="font-semibold text-red-800">Upload Error</h4>
                            <p id="photoErrorMessage" class="text-red-700 text-sm mt-1"></p>
                        </div>
                    </div>
                    <button onclick="dismissPhotoError()" class="btn-secondary mt-3 px-4 py-2">Dismiss</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Handyman Distribution Map Modal -->
    <div id="handymanMapModal" class="hide fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4" onclick="closeHandymanMapIfClickedOutside(event)">
        <div class="modal-content max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold">Available Handymen in Your Area</h3>
                    <button onclick="closeHandymanMap()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <!-- Interactive Map Container -->
                <div class="bg-white rounded-lg border border-gray-300 mb-6">
                    <div id="handymanMapContainer" class="w-full h-96 rounded-lg overflow-hidden">
                        <!-- Leaflet map will be initialized here -->
                    </div>
                </div>

                <!-- Selected Handyman Details -->
                <div id="selectedHandymanDetails" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4" style="display: none;">
                    <!-- Handyman details will appear here when clicked -->
                </div>

                <!-- Available Handymen List -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="font-semibold mb-3">Available Handymen in Your Area</h4>
                    <div id="handymanList" class="space-y-3">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <div class="mt-6 text-center">
                    <button onclick="closeHandymanMap()" class="btn-secondary px-6 py-2">
                        Close Map
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Global variables
        let currentStep = 'landing';
        let serviceData = {};
        let currentPhoto = null;
        let supabaseClient = null;
        let isAnalyzing = false; // Prevent concurrent analysis attempts

        // Initialize Supabase
        const SUPABASE_URL = 'https://bhjcryqcegrlglbfmxvx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJoamNyeXFjZWdybGdsYmZteHZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzEwNTU2ODcsImV4cCI6MjA0NjYzMTY4N30.BKfSkI98W7TmMgF88J5vCy8CHg4XvH3CGc2DGC8XGVw';
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Pricing constants (from original site)
        const RATE = 80;
        const PREMIUM_CURRENT_BLOCK = 0.30;
        const PREMIUM_NEXT_BLOCK = 0.20;
        const PREMIUM_EVENING_BLOCK = 0.35;
        const PREMIUM_SATURDAY = 0.30;
        const DISCOUNT_FUTURE = 0.10;

        // Service types with proper pricing
        const TASKS = {
            'ceiling-fan': {
                hours: 2.0,
                label: "Ceiling Fan Install/Replace",
                basePrice: 160,
                questions: [
                    {
                        id: 'replacing',
                        label: 'Replacing existing fan or light?',
                        options: [
                            { value: 'fan', label: 'Yes, existing fan', addon: 0 },
                            { value: 'light', label: 'Yes, existing light fixture', addon: 0 },
                            { value: 'new', label: 'New installation', addon: 0 }
                        ]
                    },
                    {
                        id: 'fan_box',
                        label: 'Is ceiling box fan-rated?',
                        options: [
                            { value: 'yes', label: 'Yes/Don\'t know', addon: 0 },
                            { value: 'no', label: 'No, needs replacement', addon: 50 }
                        ]
                    },
                    {
                        id: 'ceiling_height',
                        label: 'Ceiling height?',
                        options: [
                            { value: 'standard', label: 'Under 10 feet', addon: 0 },
                            { value: 'high', label: 'Over 10 feet', addon: 40 }
                        ]
                    }
                ]
            },
            'light-plumbing': {
                hours: 1.5,
                label: "Light Plumbing (Faucet/Toilet)",
                basePrice: 120,
                questions: []
            },
            'electrical': {
                hours: 1.5,
                label: "Light Electrical (Outlets/Switches)",
                basePrice: 120,
                questions: []
            },
            'tv-mounting': {
                hours: 2.0,
                label: "TV Wall Mount (32‚Äì65\")",
                basePrice: 160,
                questions: []
            },
            'furniture-assembly': {
                hours: 2.0,
                label: "Furniture Assembly (S‚ÄìM)",
                basePrice: 160,
                questions: []
            },
            'painting': {
                hours: 2.5,
                label: "Small Painting Project",
                basePrice: 200,
                questions: []
            },
            'general-repair': {
                hours: 1.5,
                label: "General Repair",
                basePrice: 120,
                questions: []
            },
            'blinds': {
                hours: 1.5,
                label: "Curtain Rod/Blinds Mount",
                basePrice: 120,
                questions: []
            }
        };

        // Pricing calculation function (matching original site logic)
        function calculatePricing(hours, window = 'tomorrow_am', rush = false, addons = 0, selectedDate = null) {
            const base = hours * RATE;
            let premiums = [];
            let total = base + addons;
            const isToday = window.startsWith('today');
            const isTomorrow = window.startsWith('tomorrow');
            const isMonday = window.startsWith('monday');
            const isFuture = selectedDate !== null;
            const isEveningBlock = window.includes('eve');
            const now = new Date();
            let bookingDate;

            if (isFuture && selectedDate) {
                bookingDate = new Date(selectedDate + 'T00:00:00');
            } else if (isToday) {
                bookingDate = now;
            } else if (isTomorrow) {
                bookingDate = new Date(now);
                bookingDate.setDate(bookingDate.getDate() + 1);
            } else if (isMonday) {
                bookingDate = new Date(now);
                bookingDate.setDate(bookingDate.getDate() + 2); // Skip Sunday
            }

            // Evening block premium
            if (isEveningBlock) {
                total *= (1 + PREMIUM_EVENING_BLOCK);
                premiums.push({ label: 'Evening', amount: Math.round(base * PREMIUM_EVENING_BLOCK) });
            }

            // Next-day premium for tomorrow
            if (isTomorrow) {
                total *= (1 + PREMIUM_NEXT_BLOCK);
                premiums.push({ label: 'Next Day', amount: Math.round(base * PREMIUM_NEXT_BLOCK) });
            }

            // Saturday premium
            if (bookingDate && isSaturday(bookingDate)) {
                total *= (1 + PREMIUM_SATURDAY);
                premiums.push({ label: 'Saturday', amount: Math.round(base * PREMIUM_SATURDAY) });
            }

            // Future booking discount (3+ days out)
            if (isFuture && selectedDate) {
                const daysDiff = Math.floor((bookingDate - now) / (1000 * 60 * 60 * 24));
                if (daysDiff >= 3) {
                    total *= (1 - DISCOUNT_FUTURE);
                    premiums.push({ label: 'Future Discount', amount: -Math.round(base * DISCOUNT_FUTURE) });
                }
            }

            return {
                base: base,
                total: Math.round(total),
                premiums: premiums,
                hours: hours
            };
        }

        function updatePricingDisplay(taskKey) {
            if (!taskKey || !TASKS[taskKey]) return;

            const task = TASKS[taskKey];
            const basePricing = calculatePricing(task.hours, 'tomorrow_am');
            const eveningPricing = calculatePricing(task.hours, 'tomorrow_eve');

            // Update main price display
            const priceDisplay = document.getElementById('servicePriceDisplay');
            if (priceDisplay) {
                priceDisplay.textContent = `$${task.basePrice}`;
            }

            // Update tomorrow pricing
            const tomorrowDisplay = document.getElementById('tomorrowPricing');
            if (tomorrowDisplay) {
                tomorrowDisplay.textContent = `$${basePricing.total}`;
            }

            // Update premium pricing (evening)
            const premiumDisplay = document.getElementById('premiumPricing');
            if (premiumDisplay) {
                premiumDisplay.textContent = `$${eveningPricing.total}`;
            }
        }

        // Availability text update function
        function updateAvailabilityText() {
            console.log('üìÖ updateAvailabilityText called');
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const availabilityElement = document.getElementById('availabilityText');
            const scheduleElement = document.getElementById('scheduleEarliestDay');

            console.log('üìÖ Elements found:', {
                availability: !!availabilityElement,
                schedule: !!scheduleElement,
                isTomorrowSunday: isSunday(tomorrow)
            });

            if (isSunday(tomorrow)) {
                // If tomorrow is Sunday, show Monday
                console.log('üìÖ Tomorrow is Sunday, updating to Monday');
                if (availabilityElement) {
                    availabilityElement.textContent = 'Available Monday onwards';
                }
                if (scheduleElement) {
                    scheduleElement.textContent = 'Monday';
                }
            } else {
                // Normal case
                console.log('üìÖ Tomorrow is not Sunday, keeping Tomorrow');
                if (availabilityElement) {
                    availabilityElement.textContent = 'Available tomorrow onwards';
                }
                if (scheduleElement) {
                    scheduleElement.textContent = 'Tomorrow';
                }
            }
        }

        // Navigation functions
        function handleSearchKeyPress(event) {
            if (event.key === 'Enter') {
                startServiceFlow();
            }
        }

        function startServiceFlow() {
            const searchInput = document.getElementById('mainSearchInput').value;
            if (searchInput.trim()) {
                serviceData.description = searchInput.trim();
                showServiceDetails();
            }
        }

        function selectService(category) {
            serviceData.category = category;
            serviceData.categoryDisplay = getCategoryDisplay(category);

            // Update pricing displays based on selected service
            updatePricingDisplay(category);

            showServiceDetails();

            // Update textarea placeholder if it exists
            const textarea = document.getElementById('detailDescription');
            if (textarea) {
                textarea.placeholder = getDescriptionPlaceholder(category);
            }
        }

        function getCategoryDisplay(category) {
            const categories = {
                'light-plumbing': 'üöø Light Plumbing',
                'electrical': '‚ö° Electrical',
                'mounting': 'üì∫ TV Mounting',
                'furniture': 'ü™ë Furniture Assembly',
                'painting': 'üé® Painting',
                'appliances': 'üîå Appliances',
                'repair': 'üî® General Repair',
                'ceiling-fan': '<img src="/images/fan.png" alt="Ceiling Fan" class="inline w-6 h-6"> Ceiling Fan',
                'curtains-blinds': 'ü™ü Curtain Rods / Blinds',
                'installation': 'üõ†Ô∏è Installations',
                'outdoor': 'üè° Outdoor',
                'other': '‚ùì Other'
            };
            return categories[category] || category;
        }

        function getDescriptionPlaceholder(category) {
            const placeholders = {
                'light-plumbing': 'Kitchen sink is dripping under the counter...',
                'electrical': 'Need to install a new outlet in the bedroom wall...',
                'mounting': 'Want to mount 55" TV above the fireplace...',
                'furniture': 'IKEA dresser needs assembly, have all parts...',
                'painting': 'Touch up paint needed on bedroom walls...',
                'appliances': 'Dishwasher not draining properly...',
                'repair': 'Squeaky door hinge needs fixing...',
                'ceiling-fan': 'Install new ceiling fan in living room, existing wiring available...',
                'curtains-blinds': 'Mount curtain rods above bedroom windows...',
                'installation': 'Need help installing bathroom towel rack...',
                'outdoor': 'Patio fence post is loose and wobbly...',
                'other': 'Describe your repair or project...'
            };
            return placeholders[category] || 'Describe your repair or project...';
        }

        function showServiceDetails() {
            document.getElementById('landingScreen').classList.add('hide');
            document.getElementById('serviceFlow').classList.remove('hide');
            currentStep = 'details';
            renderServiceDetails();
        }

        function renderServiceDetails() {
            const content = document.getElementById('serviceContent');
            content.innerHTML = `
                <div class="slide-up">
                    <h2 class="text-2xl font-bold mb-2">${serviceData.categoryDisplay || 'Service Request'}</h2>
                    <p class="text-gray-600 mb-6">Tell us more about what you need help with</p>

                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Describe the issue or project</label>
                            <textarea
                                id="detailDescription"
                                class="w-full border border-gray-300 rounded-lg p-3 h-24"
                                placeholder="${getDescriptionPlaceholder(serviceData.category)}"
                                onchange="updateServiceData('detailedDescription', this.value)"
                            >${serviceData.description || ''}</textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2">Add photos for better estimates</label>
                            <button onclick="showPhotoModal()" class="w-full btn-secondary py-4 border-2 border-dashed">
                                <div class="flex items-center justify-center gap-2">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                    <span class="ai-badge mr-2">AI</span>
                                    Add Photos for AI Analysis
                                </div>
                            </button>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2">Service location</label>
                            <input
                                type="text"
                                class="w-full border border-gray-300 rounded-lg p-3"
                                placeholder="123 Main St, Palm Beach, FL"
                                onchange="updateServiceData('location', this.value)"
                            />
                        </div>

                        <div class="pt-4">
                            <button onclick="proceedToScheduling()" class="btn-primary w-full py-4 text-lg">
                                Continue to Scheduling
                            </button>
                        </div>
                    </div>
                </div>
            `;
            updateProgress(50);
        }

        function updateServiceData(key, value) {
            serviceData[key] = value;
        }

        function proceedToScheduling() {
            updateProgress(75);
            const content = document.getElementById('serviceContent');
            content.innerHTML = `
                <div class="slide-up">
                    <h2 class="text-2xl font-bold mb-2">When do you need this fixed?</h2>
                    <p class="text-gray-600 mb-6">Choose your preferred time slot</p>

                    <div class="space-y-4">
                        <div class="service-card p-4" onclick="selectSchedule('tomorrow')">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-semibold" id="scheduleEarliestDay">Tomorrow</div>
                                    <div class="text-sm text-gray-600">Earliest available</div>
                                    <div class="text-xs text-green-600 mt-1">üéØ Most handymen available</div>
                                </div>
                                <div class="text-green-600">‚≠ê</div>
                            </div>
                        </div>

                        <div class="service-card p-4" onclick="selectSchedule('choose')">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-semibold">Choose Date</div>
                                    <div class="text-sm text-gray-600">Pick from calendar</div>
                                </div>
                                <div>üìÖ</div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 p-4 bg-blue-50 rounded-lg">
                        <div class="text-sm">
                            <div class="font-semibold mb-1">Available today:</div>
                            <div class="flex gap-2 flex-wrap">
                                <span class="bg-white px-2 py-1 rounded text-xs">9-11 AM</span>
                                <span class="bg-white px-2 py-1 rounded text-xs">11-1 PM</span>
                                <span class="bg-white px-2 py-1 rounded text-xs">1-3 PM</span>
                                <span class="bg-white px-2 py-1 rounded text-xs">3-5 PM</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Update availability text after DOM is updated
            setTimeout(() => {
                updateAvailabilityText();
            }, 0);
        }

        function selectSchedule(schedule) {
            serviceData.schedule = schedule;
            showEstimate();
        }

        function showEstimate() {
            updateProgress(100);
            const content = document.getElementById('serviceContent');
            content.innerHTML = `
                <div class="slide-up">
                    <h2 class="text-2xl font-bold mb-6">AI Instant Estimate</h2>

                    <div class="estimate-card mb-6">
                        <div class="flex items-center gap-2 mb-4">
                            <span class="ai-badge">AI</span>
                            <span class="font-semibold">${serviceData.categoryDisplay || 'Service Request'}</span>
                        </div>
                        <div class="text-3xl font-bold mb-2" id="servicePriceDisplay">$160</div>
                        <div class="text-lg opacity-90 mb-4">Estimated cost range</div>
                        <div class="text-sm opacity-80">
                            ‚Ä¢ 1-2 hours estimated duration<br>
                            ‚Ä¢ Final price confirmed after handyman inspection<br>
                            ‚Ä¢ No hidden fees or surprises
                        </div>
                    </div>

                    <div class="space-y-4 mb-6">
                        <div class="service-card p-4 border-2" onclick="selectServiceLevel('standard')">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-semibold">Standard Service</div>
                                    <div class="text-sm text-gray-600">Basic repair ‚Ä¢ ‚≠ê‚≠ê‚≠ê‚≠ê 4.8 avg rating</div>
                                </div>
                                <div class="text-xl font-bold" id="tomorrowPricing">$144</div>
                            </div>
                        </div>

                        <div class="service-card p-4" onclick="selectServiceLevel('premium')">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-semibold">Premium Service</div>
                                    <div class="text-sm text-gray-600">Expert + warranty ‚Ä¢ ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 4.9 avg rating</div>
                                    <div class="text-xs text-green-600 mt-1">‚úÖ 90-day guarantee</div>
                                </div>
                                <div class="text-xl font-bold" id="premiumPricing">$216</div>
                            </div>
                        </div>
                    </div>

                    <button onclick="proceedToBooking()" class="btn-primary w-full py-4 text-lg" style="display: none; opacity: 0; transition: opacity 0.3s ease;">
                        Continue to Booking
                    </button>
                </div>
            `;
        }

        function selectServiceLevel(level) {
            serviceData.serviceLevel = level;

            // Update visual selection state
            document.querySelectorAll('.service-card').forEach(card => {
                card.classList.remove('selected', 'bg-blue-50', 'border-blue-300');
            });

            // Add selected state to clicked card
            event.target.closest('.service-card').classList.add('selected', 'bg-blue-50', 'border-blue-300');

            // Show the Continue to Booking button
            const bookingBtn = document.querySelector('button[onclick="proceedToBooking()"]');
            if (bookingBtn) {
                bookingBtn.style.display = 'block';
                bookingBtn.style.opacity = '1';
            }
        }

        function proceedToBooking() {
            // Show the full booking flow with time slots and pricing
            showBookingFlow();
        }

        // Global variables
        let availableTimeSlots = [];
        let currentBookingStep = 1;

        function showBookingFlow() {
            const content = document.getElementById('serviceContent');
            document.getElementById('landingScreen').classList.add('hide');
            document.getElementById('serviceFlow').classList.remove('hide');
            currentStep = 'booking';

            // Update progress to step 2 (Time Selection)
            updateProgress(2);

            // Show loading while generating time slots
            showLoading('Finding available time slots...');

            setTimeout(() => {
                const timeSlots = generateTimeSlots();
                availableTimeSlots = timeSlots;
                hideLoading();

                // Build the template with actual timeSlots data
                content.innerHTML = `
                    <div class="slide-up">
                        <h2 class="text-2xl font-bold mb-2">Choose Time & Date</h2>
                        <p class="text-gray-600 mb-6">Select when you'd like your ${serviceData.categoryDisplay} service</p>

                        <div class="space-y-4 mb-8">
                            ${timeSlots.map((slot, index) => `
                                <div class="service-card p-4 cursor-pointer" onclick="selectTimeSlotByIndex(${index})">
                                    <div class="flex justify-between items-center">
                                    <div>
                                        <div class="font-semibold">${slot.windowLabel}</div>
                                        <div class="text-sm text-gray-600">${slot.badge || ''}</div>
                                        ${slot.premiums && slot.premiums.length > 0 ? `
                                            <div class="text-xs text-gray-500 mt-1">
                                                ${slot.premiums.map(p => p.amount > 0 ? `+${p.label}` : p.label).join(' ‚Ä¢ ')}
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xl font-bold">$${slot.pricing.total}</div>
                                        ${slot.pricing.base !== slot.pricing.total ? `
                                            <div class="text-sm text-gray-500 line-through">$${slot.pricing.base}</div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <button onclick="goBack()" class="btn-secondary w-full py-3">
                        Back to Service Details
                    </button>
                </div>
                `;

                // Show sticky bottom bar on mobile
                showStickyBottomBar('Select Time Slot', 'selectFirstAvailableSlot()');
            }, 800);
        }

        function selectTimeSlotByIndex(index) {
            const selectedSlot = availableTimeSlots[index];
            if (!selectedSlot) return;

            serviceData.selectedWindow = selectedSlot.window;
            serviceData.selectedWindowLabel = selectedSlot.windowLabel;
            serviceData.pricing = selectedSlot.pricing;

            // Show success toast
            showToast(`Time slot selected: ${selectedSlot.windowLabel}`, 'success');

            // Update progress to step 3 (Details)
            updateProgress(3);

            // Hide mobile sticky bar
            hideStickyBottomBar();

            // Proceed to final booking confirmation
            setTimeout(showBookingConfirmation, 500);
        }

        function selectFirstAvailableSlot() {
            if (availableTimeSlots.length > 0) {
                selectTimeSlotByIndex(0);
            }
        }

        function selectTimeSlot(window, pricing) {
            serviceData.selectedWindow = window;
            serviceData.pricing = pricing;

            // Proceed to final booking confirmation
            showBookingConfirmation();
        }

        function showBookingConfirmation() {
            const content = document.getElementById('serviceContent');

            // Update progress to step 4 (Final Booking)
            updateProgress(4);

            // Show mobile sticky bar with final price
            showStickyBottomBar('Complete Booking', 'completeBooking()', `$${serviceData.pricing.total}`);

            content.innerHTML = `
                <div class="slide-up">
                    <h2 class="text-2xl font-bold mb-2">Booking Summary</h2>
                    <p class="text-gray-600 mb-6">Review your booking details</p>

                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="font-semibold">Service:</span>
                                <span>${serviceData.categoryDisplay}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-semibold">Time:</span>
                                <span>${serviceData.selectedWindowLabel || serviceData.selectedWindow}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-semibold">Base Price:</span>
                                <span>$${serviceData.pricing.base}</span>
                            </div>
                            ${serviceData.pricing.premiums.map(premium => `
                                <div class="flex justify-between text-sm ${premium.amount > 0 ? 'text-red-600' : 'text-green-600'}">
                                    <span>${premium.label}:</span>
                                    <span>${premium.amount > 0 ? '+' : ''}$${Math.abs(premium.amount)}</span>
                                </div>
                            `).join('')}
                            <hr class="border-gray-300">
                            <div class="flex justify-between font-bold text-lg">
                                <span>Total:</span>
                                <span>$${serviceData.pricing.total}</span>
                            </div>
                        </div>
                    </div>

                    <button onclick="completeBooking()" class="btn-primary w-full py-4 mb-3">
                        Complete Booking - $${serviceData.pricing.total}
                    </button>

                    <button onclick="showBookingFlow()" class="btn-secondary w-full py-3">
                        Change Time
                    </button>
                </div>
            `;
        }

        function completeBooking() {
            // Show loading
            showLoading('Finalizing your booking...');

            // Show success toast
            setTimeout(() => {
                hideLoading();
                showToast('Booking confirmed! Redirecting to complete your request...', 'success');

                // Hide sticky bar
                hideStickyBottomBar();

                // Redirect after a brief delay
                setTimeout(() => {
                    sessionStorage.setItem('prefilledService', JSON.stringify(serviceData));
                    window.location.href = '#tasks';
                }, 1500);
            }, 2000);
        }

        // Original pricing logic from the main site
        const RATE = 80;
        const PREMIUM_CURRENT_BLOCK = 0.30;
        const PREMIUM_NEXT_BLOCK = 0.20;
        const PREMIUM_EVENING_BLOCK = 0.35;
        const PREMIUM_SATURDAY = 0.30;
        const DISCOUNT_FUTURE = 0.10;

        function getCurrentBlock() {
            const now = new Date();
            const hour = now.getHours();
            if (hour >= 8 && hour < 12) return 'today_am';
            if (hour >= 12 && hour < 16) return 'today_pm';
            if (hour >= 16 && hour < 20) return 'today_eve';
            return null;
        }

        function isBlockInPast(blockKey) {
            const now = new Date();
            const hour = now.getHours();
            if (blockKey === 'today_am' && hour >= 12) return true;
            if (blockKey === 'today_pm' && hour >= 16) return true;
            if (blockKey === 'today_eve' && hour >= 20) return true;
            return false;
        }

        function isSaturday(date) {
            return date.getDay() === 6;
        }

        function isSunday(date) {
            return date.getDay() === 0;
        }

        function calculatePricing(hours, window, rush = false, addons = 0, selectedDate = null) {
            const base = hours * RATE;
            let premiums = [];
            let total = base + addons;
            const currentBlock = getCurrentBlock();
            const isToday = window.startsWith('today');
            const isTomorrow = window.startsWith('tomorrow');
            const isMonday = window.startsWith('monday');
            const isFuture = selectedDate !== null;
            const isEveningBlock = window.includes('eve');
            const now = new Date();
            let bookingDate;

            if (isFuture && selectedDate) {
                bookingDate = new Date(selectedDate + 'T00:00:00');
            } else if (isToday) {
                bookingDate = now;
            } else if (isTomorrow) {
                bookingDate = new Date(now);
                bookingDate.setDate(bookingDate.getDate() + 1);
            } else if (isMonday) {
                bookingDate = new Date(now);
                const daysUntilMonday = (8 - now.getDay()) % 7;
                bookingDate.setDate(bookingDate.getDate() + (daysUntilMonday === 0 ? 7 : daysUntilMonday));
            }

            const isBookingSaturday = bookingDate && isSaturday(bookingDate);

            if (isFuture) {
                if (isEveningBlock) {
                    const premium = base * PREMIUM_EVENING_BLOCK;
                    premiums.push({ label: 'Evening block premium (4-8PM, +35%)', amount: premium });
                    total += premium;
                }
                else if (isBookingSaturday) {
                    const satPremium = base * PREMIUM_SATURDAY;
                    premiums.push({ label: 'Saturday service premium (+30%)', amount: satPremium });
                    total += satPremium;
                } else {
                    const discount = base * DISCOUNT_FUTURE;
                    premiums.push({ label: 'Future booking discount (-10%)', amount: -discount });
                    total -= discount;
                }
            } else if (isToday) {
                if (isBookingSaturday) {
                    const satPremium = base * PREMIUM_SATURDAY;
                    premiums.push({ label: 'Saturday service premium (+30%)', amount: satPremium });
                    total += satPremium;
                }
                if (isEveningBlock) {
                    const premium = base * PREMIUM_EVENING_BLOCK;
                    premiums.push({ label: 'Evening block premium (4-8PM, +35%)', amount: premium });
                    total += premium;
                } else if (window === currentBlock) {
                    const premium = base * PREMIUM_CURRENT_BLOCK;
                    premiums.push({ label: 'Current time block premium (+30%)', amount: premium });
                    total += premium;
                } else {
                    const premium = base * PREMIUM_NEXT_BLOCK;
                    premiums.push({ label: 'Next available block premium (+20%)', amount: premium });
                    total += premium;
                }
            } else if (isTomorrow) {
                if (isBookingSaturday) {
                    const satPremium = base * PREMIUM_SATURDAY;
                    premiums.push({ label: 'Saturday service premium (+30%)', amount: satPremium });
                    total += satPremium;
                }
                if (isEveningBlock) {
                    const premium = base * PREMIUM_EVENING_BLOCK;
                    premiums.push({ label: 'Evening block premium (4-8PM, +35%)', amount: premium });
                    total += premium;
                }
            }

            if (addons > 0) {
                premiums.push({ label: 'Task-specific add-ons', amount: addons });
            }

            return { base: Math.round(base), premiums, total: Math.round(total), addons };
        }

        function generateTimeSlots() {
            const now = new Date();
            const timeSlots = [];
            const hours = 2; // Default service duration

            // Define time blocks
            const timeBlocks = [
                { key: 'am', label: '8AM-12PM' },
                { key: 'pm', label: '12PM-4PM' },
                { key: 'eve', label: '4PM-8PM' }
            ];

            // NEVER offer same-day service - always start with tomorrow
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);

            if (!isSunday(tomorrow)) {
                timeBlocks.forEach(block => {
                    const tomorrowWindow = `tomorrow_${block.key}`;
                    const pricing = calculatePricing(hours, tomorrowWindow);
                    timeSlots.push({
                        window: tomorrowWindow,
                        windowLabel: `Tomorrow (${block.label})`,
                        pricing: pricing,
                        badge: isSaturday(tomorrow) ? 'Saturday Premium' : 'Next Day',
                        premiums: pricing.premiums
                    });
                });
            }

            // Add Monday slots if tomorrow is Sunday (skip Sunday)
            if (isSunday(tomorrow)) {
                const monday = new Date(tomorrow);
                monday.setDate(monday.getDate() + 1);

                timeBlocks.forEach(block => {
                    const mondayWindow = `monday_${block.key}`;
                    const pricing = calculatePricing(hours, mondayWindow);
                    timeSlots.push({
                        window: mondayWindow,
                        windowLabel: `Monday (${block.label})`,
                        pricing: pricing,
                        badge: 'Future Booking',
                        premiums: pricing.premiums
                    });
                });
            }

            // Add day after Monday if needed (Tuesday onwards)
            const dayAfterTomorrow = new Date(tomorrow);
            dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 1);

            if (!isSunday(dayAfterTomorrow)) {
                const dayName = dayAfterTomorrow.toLocaleDateString('en-US', { weekday: 'long' });
                timeBlocks.forEach(block => {
                    const futureWindow = `future_${block.key}`;
                    const pricing = calculatePricing(hours, futureWindow, false, 0, dayAfterTomorrow.toISOString().split('T')[0]);
                    timeSlots.push({
                        window: futureWindow,
                        windowLabel: `${dayName} (${block.label})`,
                        pricing: pricing,
                        badge: 'Future Booking - Best Value',
                        premiums: pricing.premiums
                    });
                });
            }

            return timeSlots;
        }

        function goBack() {
            if (currentStep === 'details') {
                document.getElementById('serviceFlow').classList.add('hide');
                document.getElementById('landingScreen').classList.remove('hide');
                currentStep = 'landing';
            } else if (currentStep === 'services') {
                // Going back from "All Services" screen to landing page
                document.getElementById('serviceFlow').classList.add('hide');
                document.getElementById('landingScreen').classList.remove('hide');
                currentStep = 'landing';
            } else if (currentStep === 'booking') {
                // Going back from booking to service details
                showServiceDetails();
            }
        }

        function updateProgress(percent) {
            document.getElementById('progressFill').style.width = percent + '%';
        }

        // Photo Modal Functions
        function showPhotoModal() {
            console.log('üì∑ Opening photo modal...');
            const modal = document.getElementById('photoModal');
            if (modal) {
                modal.classList.remove('hide');
                modal.style.display = 'flex'; // Force display
                resetPhotoModal(); // Reset to upload prompt
                console.log('‚úÖ Photo modal opened');
            } else {
                console.error('‚ùå Photo modal not found');
            }
        }

        function closePhotoModal() {
            console.log('üîÑ Closing photo modal...');
            const modal = document.getElementById('photoModal');
            if (modal) {
                modal.classList.add('hide');
                modal.style.display = 'none'; // Force hide with inline style
                resetPhotoModal();
                console.log('‚úÖ Photo modal closed');
            }
        }

        function resetPhotoModal() {
            document.getElementById('uploadPrompt').classList.remove('hide');
            document.getElementById('photoPreview').classList.add('hide');
            document.getElementById('analysisLoading').classList.add('hide');
            document.getElementById('analysisResults').classList.add('hide');
            document.getElementById('photoError').classList.add('hide');

            // Clear file inputs
            const cameraInput = document.getElementById('cameraInput');
            const galleryInput = document.getElementById('galleryInput');
            if (cameraInput) cameraInput.value = '';
            if (galleryInput) galleryInput.value = '';

            // Reset image source
            const previewImage = document.getElementById('previewImage');
            if (previewImage) {
                previewImage.src = '';
            }

            // Clear current photo
            currentPhoto = null;
        }

        function triggerCamera() {
            document.getElementById('cameraInput').click();
        }

        function triggerGallery() {
            document.getElementById('galleryInput').click();
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file
            if (!file.type.startsWith('image/')) {
                showPhotoError('Please select a valid image file.');
                return;
            }

            // Check file size - account for base64 encoding expansion (~33% increase)
            // API limit is 5MB after base64, so we need to limit uploads to ~3.7MB before encoding
            const maxSizeBeforeEncoding = 3.7 * 1024 * 1024; // ~3.7MB raw = ~5MB after base64

            if (file.size > maxSizeBeforeEncoding) {
                const sizeMB = (file.size / (1024 * 1024)).toFixed(1);
                const estimatedEncodedSizeMB = (file.size * 1.33 / (1024 * 1024)).toFixed(1);
                showPhotoErrorWithCompression(
                    `Photo is ${sizeMB}MB (${estimatedEncodedSizeMB}MB after processing). Our AI requires photos under 3.7MB for analysis. Would you like us to compress it automatically?`,
                    file
                );
                return;
            }

            // Auto-compress images larger than 500KB for better reliability
            if (file.size > 500 * 1024) {
                console.log(`üì¶ Auto-compressing image from ${(file.size / 1024).toFixed(1)}KB`);
                showToast('Optimizing image for faster upload...', 'info', 2000);

                compressImage(file, 0.7, 1920).then(compressedFile => {
                    console.log(`üì¶ Compressed to ${(compressedFile.size / 1024).toFixed(1)}KB`);
                    displayImagePreview(compressedFile);
                    currentPhoto = compressedFile;
                }).catch(error => {
                    console.warn('Compression failed, using original:', error);
                    displayImagePreview(file);
                    currentPhoto = file;
                });
            } else {
                displayImagePreview(file);
                currentPhoto = file;
            }
        }

        function displayImagePreview(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('uploadPrompt').classList.add('hide');
                document.getElementById('photoPreview').classList.remove('hide');
            };
            reader.readAsDataURL(file);
        }

        function compressImage(file, quality = 0.7, maxWidth = 1920) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();

                img.onload = function() {
                    // Calculate new dimensions
                    const ratio = Math.min(maxWidth / img.width, maxWidth / img.height);
                    const newWidth = img.width * ratio;
                    const newHeight = img.height * ratio;

                    canvas.width = newWidth;
                    canvas.height = newHeight;

                    // Draw and compress
                    ctx.drawImage(img, 0, 0, newWidth, newHeight);

                    canvas.toBlob(function(blob) {
                        const compressedFile = new File([blob], file.name, {
                            type: 'image/jpeg',
                            lastModified: Date.now()
                        });
                        resolve(compressedFile);
                    }, 'image/jpeg', quality);
                };

                img.src = URL.createObjectURL(file);
            });
        }

        function showPhotoErrorWithCompression(message, originalFile) {
            const errorMessage = document.getElementById('photoErrorMessage');

            errorMessage.innerHTML = `
                <div class="mb-4">${message}</div>
                <div class="flex gap-3 justify-center flex-wrap">
                    <button onclick="compressLargeFile('${originalFile.name}')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                        üóúÔ∏è Compress Photo
                    </button>
                    <button onclick="retakePhoto()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors text-sm">
                        üì∑ Choose Different Photo
                    </button>
                    <button onclick="dismissPhotoError()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm">
                        ‚úï Cancel
                    </button>
                </div>
            `;
            document.getElementById('photoError').classList.remove('hide');

            // Store the file for compression
            window.pendingCompressionFile = originalFile;
        }

        async function compressLargeFile() {
            if (!window.pendingCompressionFile) {
                showToast('No file available for compression', 'error');
                return;
            }

            const file = window.pendingCompressionFile;
            dismissPhotoError();
            showToast('Compressing large image...', 'info', 3000);

            try {
                // First compression attempt
                console.log(`üóúÔ∏è Compressing ${(file.size / (1024 * 1024)).toFixed(1)}MB file...`);
                const compressedFile = await compressImage(file, 0.7, 1920);
                const compressedSizeMB = (compressedFile.size / (1024 * 1024)).toFixed(1);
                console.log(`üì¶ First compression: ${compressedSizeMB}MB`);

                // Check if still too large after first compression
                const estimatedEncodedSize = compressedFile.size * 1.33;

                if (estimatedEncodedSize > 5 * 1024 * 1024) {
                    // Still too large, try more aggressive compression
                    console.log(`First compression: ${compressedSizeMB}MB still too large, trying more aggressive compression...`);
                    showToast('Applying stronger compression...', 'info', 3000);

                    const veryCompressedFile = await compressImage(file, 0.3, 960); // Very aggressive
                    const finalSizeMB = (veryCompressedFile.size / (1024 * 1024)).toFixed(1);
                    const finalEncodedSize = veryCompressedFile.size * 1.33;

                    if (finalEncodedSize > 5 * 1024 * 1024) {
                        showPhotoError(`Even after compression, the image (${finalSizeMB}MB) is too large for AI analysis. Please try a smaller image or take a new photo.`);
                        return;
                    }

                    displayImagePreview(veryCompressedFile);
                    currentPhoto = veryCompressedFile;
                    showToast(`Photo compressed from ${(file.size / (1024 * 1024)).toFixed(1)}MB to ${finalSizeMB}MB`, 'success');
                } else {
                    displayImagePreview(compressedFile);
                    currentPhoto = compressedFile;
                    showToast(`Photo compressed from ${(file.size / (1024 * 1024)).toFixed(1)}MB to ${compressedSizeMB}MB`, 'success');
                }

            } catch (error) {
                console.error('Compression failed:', error);
                showPhotoError('Compression failed. Please try a different photo or reduce the file size manually.');
            } finally {
                window.pendingCompressionFile = null;
            }
        }

        function retakePhoto() {
            resetPhotoModal();
        }

        async function analyzePhoto() {
            if (!currentPhoto) {
                showToast('Please select a photo first', 'warning');
                return;
            }

            // Prevent concurrent analysis attempts
            if (isAnalyzing) {
                console.log('üö´ Analysis already in progress, skipping duplicate request');
                showToast('Analysis already in progress...', 'info');
                return;
            }

            try {
                isAnalyzing = true;
                // Show enhanced loading
                document.getElementById('photoPreview').classList.add('hide');
                document.getElementById('analysisLoading').classList.remove('hide');

                // Show toast notification
                showToast('Analyzing your photo with AI...', 'info', 6000);

                // Convert file to base64
                const base64 = await fileToBase64(currentPhoto);

                // Quick connectivity check with more reliable timeout
                try {
                    const healthController = new AbortController();
                    const healthTimeout = setTimeout(() => healthController.abort(), 5000);

                    const healthCheck = await fetch('/.netlify/functions/ai-photo-analysis', {
                        method: 'OPTIONS',
                        signal: healthController.signal
                    });
                    clearTimeout(healthTimeout);
                    console.log('Connectivity check passed');
                } catch (healthError) {
                    console.warn('Connectivity check failed, but proceeding anyway:', healthError.name);
                }

                // Call AI analysis function with longer timeout for better reliability
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    console.log('üïê Analysis timeout triggered after 45 seconds');
                    controller.abort();
                }, 45000); // Increased to 45 seconds for better reliability

                const response = await fetch('/.netlify/functions/ai-photo-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: base64,
                        filename: currentPhoto.name || 'photo.jpg'
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error:', response.status, errorText);
                    throw new Error(`Analysis failed: ${response.statusText}`);
                }

                const result = await response.json();

                // Check if this is an unsupported format error (like original)
                if (result.error_type === 'unsupported_format') {
                    showPhotoError(result.urgency_notes || 'Unsupported image format. Please use JPG, PNG, WebP, or GIF.');
                    return;
                }

                showAnalysisResults(result);

            } catch (error) {
                // Reset analysis flag
                isAnalyzing = false;
                console.error('AI analysis error:', error.name, error.message);
                console.error('Full error object:', error);
                document.getElementById('analysisLoading').classList.add('hide');

                // Clear any remaining timeouts
                clearTimeout(timeoutId);

                // Reset photo preview to allow retry
                document.getElementById('photoPreview').classList.remove('hide');

                // Enhanced error handling with specific timeout handling
                let userMessage = 'Analysis temporarily unavailable. Please try again.';

                if (error.name === 'AbortError' || error.message.includes('aborted')) {
                    userMessage = 'Analysis timed out after 45 seconds. You can try again with the same photo or upload a smaller image.';
                    showToast('Analysis timed out - you can retry with the same photo', 'warning', 6000);
                } else if (error.message.includes('Failed to fetch') || error.message.includes('ERR_TIMED_OUT') || error.message.includes('TypeError: Failed to fetch')) {
                    userMessage = 'Network connection issue detected. Please check your internet connection and try again.';
                    showToast('Connection timeout - please check your internet and retry', 'error', 6000);
                } else if (error.message.includes('413') || error.message.includes('too large')) {
                    userMessage = 'Photo is too large for analysis. Please try a smaller image.';
                    showToast('Image too large - please use a smaller photo', 'warning');
                } else if (error.message.includes('timeout') || error.message.includes('network')) {
                    userMessage = 'Connection timeout. Please check your internet and try again.';
                    showToast('Network timeout - retrying might help', 'warning');
                } else if (error.message.includes('429')) {
                    userMessage = 'Service temporarily busy. Please wait a moment and try again.';
                    showToast('Service busy - please wait a moment before retrying', 'warning');
                } else if (error.message.includes('media type') || error.message.includes('does not match')) {
                    userMessage = 'Image format not supported. Please upload a JPG, PNG, WebP, or GIF image.';
                } else if (error.message.includes('invalid_request_error')) {
                    userMessage = 'Invalid image format. Please ensure your image is JPG, PNG, WebP, or GIF.';
                }

                // Show enhanced error with retry option
                showPhotoErrorWithRetry(userMessage);
            }
        }

        function showAnalysisResults(result) {
            // Reset analysis flag on success
            isAnalyzing = false;
            document.getElementById('analysisLoading').classList.add('hide');

            const resultsDiv = document.getElementById('analysisResults');

            // Check if this is a fallback/error response
            const isFallbackResponse = result.confidence_level === 'low' &&
                                       (result.problem_description.includes('temporarily unavailable') ||
                                        result.problem_description.includes('Claude API error'));

            // Enhanced verbose AI analysis display
            resultsDiv.innerHTML = `
                <div class="space-y-4">
                    <!-- Problem Description -->
                    <div class="${isFallbackResponse ? 'bg-orange-50 border border-orange-200' : 'bg-blue-50 border border-blue-200'} rounded-lg p-4">
                        <h4 class="font-semibold ${isFallbackResponse ? 'text-orange-900' : 'text-blue-900'} mb-2">
                            ${isFallbackResponse ? '‚ö†Ô∏è Service Update' : 'üîç Problem Identified'}
                        </h4>
                        <p class="${isFallbackResponse ? 'text-orange-800' : 'text-blue-800'}">
                            ${isFallbackResponse
                                ? 'Our AI analysis service is temporarily experiencing high demand. We\'ve provided a standard estimate below, but for the most accurate assessment, please call us directly.'
                                : (result.problem_description || 'Analysis completed successfully')
                            }
                        </p>
                    </div>

                    <!-- Recommended Task -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h4 class="font-semibold text-green-900 mb-2">‚úÖ Recommended Service</h4>
                        <p class="text-green-800 font-medium">${result.recommended_task || 'General Handyman Service'}</p>
                    </div>

                    <!-- Cost & Risk Assessment -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <h5 class="font-semibold text-gray-900 mb-2">üí∞ Cost Estimate</h5>
                            <p class="text-lg font-bold text-gray-800">${result.cost_estimate || '$160'}</p>
                        </div>
                        <div class="bg-${result.risk_level === 'high' || result.risk_level === 'urgent' ? 'red' : result.risk_level === 'moderate' ? 'yellow' : 'green'}-50 border border-${result.risk_level === 'high' || result.risk_level === 'urgent' ? 'red' : result.risk_level === 'moderate' ? 'yellow' : 'green'}-200 rounded-lg p-4">
                            <h5 class="font-semibold text-${result.risk_level === 'high' || result.risk_level === 'urgent' ? 'red' : result.risk_level === 'moderate' ? 'yellow' : 'green'}-900 mb-2">‚ö†Ô∏è Risk Level</h5>
                            <p class="font-bold capitalize text-${result.risk_level === 'high' || result.risk_level === 'urgent' ? 'red' : result.risk_level === 'moderate' ? 'yellow' : 'green'}-800">${result.risk_level || 'moderate'}</p>
                        </div>
                    </div>

                    <!-- Urgency Notes -->
                    ${result.urgency_notes ? `
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                            <h5 class="font-semibold text-orange-900 mb-2">‚è∞ Timing Recommendations</h5>
                            <p class="text-orange-800">${result.urgency_notes}</p>
                        </div>
                    ` : ''}

                    <!-- Confidence Level -->
                    <div class="text-center">
                        <div class="text-sm text-gray-600">
                            AI Confidence: <span class="font-semibold capitalize">${result.confidence_level || 'medium'}</span>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="space-y-3 mt-6">
                        ${isFallbackResponse ? `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <button onclick="useAnalysisResults()" class="btn-primary py-3">
                                    üìû Call for Accurate Quote
                                </button>
                                <button onclick="useAnalysisResults()" class="btn-secondary py-3">
                                    Book Standard Service - ${result.cost_estimate || '$240'}
                                </button>
                            </div>
                            <button onclick="retakePhoto()" class="btn-secondary w-full py-2">
                                üîÑ Try AI Analysis Again
                            </button>
                        ` : `
                            <button onclick="useAnalysisResults()" class="btn-primary w-full py-3">
                                Book ${result.recommended_task || 'Service'} - ${result.cost_estimate || '$160'}
                            </button>
                            <button onclick="retakePhoto()" class="btn-secondary w-full py-2">
                                üì∑ Take Different Photo
                            </button>
                        `}
                    </div>
                </div>
            `;

            resultsDiv.classList.remove('hide');
        }

        function useAnalysisResults() {
            // Update service data with AI results
            serviceData.aiAnalysis = true;
            closePhotoModal();

            // Update the main form to show AI analysis was completed
            const photoButton = document.querySelector('[onclick="showPhotoModal()"]');
            if (photoButton) {
                photoButton.innerHTML = `
                    <div class="flex items-center justify-center gap-2">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        <span class="ai-badge mr-2">AI</span>
                        Photo Analyzed ‚úì
                    </div>
                `;
                photoButton.classList.remove('border-dashed');
                photoButton.classList.add('bg-green-50', 'border-green-200');
            }
        }

        function showPhotoError(message) {
            document.getElementById('photoErrorMessage').textContent = message;
            document.getElementById('photoError').classList.remove('hide');
        }

        function showPhotoErrorWithRetry(message) {
            const errorMessage = document.getElementById('photoErrorMessage');

            errorMessage.innerHTML = `
                <div class="mb-4">${message}</div>
                <div class="flex gap-3 justify-center flex-wrap">
                    <button onclick="retryAnalysis()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                        üîÑ Try Again
                    </button>
                    <button onclick="retakePhoto()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors text-sm">
                        üì∑ New Photo
                    </button>
                    <button onclick="dismissPhotoError()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm">
                        ‚úï Close
                    </button>
                </div>
            `;
            document.getElementById('photoError').classList.remove('hide');
        }

        function retryAnalysis() {
            if (currentPhoto) {
                dismissPhotoError();
                // Reset analysis flag before retrying
                isAnalyzing = false;
                showToast('Retrying AI analysis...', 'info');
                setTimeout(() => analyzePhoto(), 1000);
            } else {
                showToast('No photo available to retry. Please upload a new photo.', 'warning');
                dismissPhotoError();
            }
        }

        function dismissPhotoError() {
            document.getElementById('photoError').classList.add('hide');
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result); // Return full data URI with format prefix
                reader.onerror = error => reject(error);
            });
        }

        // Location detection functions
        async function detectUserLocation() {
            console.log('üìç detectUserLocation called');
            const locationElement = document.getElementById('locationIndicator');
            console.log('üìç Location element found:', !!locationElement);

            try {
                // Check if geolocation is supported
                if (!navigator.geolocation) {
                    console.log('üìç Geolocation not supported');
                    setFallbackLocation(locationElement);
                    return;
                }

                // Check for HTTPS requirement
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    console.log('üìç HTTPS required for geolocation');
                    setFallbackLocation(locationElement);
                    return;
                }

                console.log('üìç Requesting location permission...');

                // Request user's location with timeout
                const position = await getCurrentPosition();
                const { latitude, longitude } = position.coords;

                console.log('üìç Location detected:', latitude, longitude);

                // Get address from coordinates
                const address = await reverseGeocode(latitude, longitude);
                updateLocationDisplay(locationElement, address);

            } catch (error) {
                console.log('üìç Location detection failed:', error.message);
                console.log('üìç Error details:', error);

                // Specific error messages for debugging
                if (error.code === 1) {
                    console.log('üìç User denied location permission');
                } else if (error.code === 2) {
                    console.log('üìç Location unavailable');
                } else if (error.code === 3) {
                    console.log('üìç Location timeout');
                }

                setFallbackLocation(locationElement);
            }
        }

        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                const options = {
                    enableHighAccuracy: false, // Faster response
                    timeout: 8000, // 8 second timeout
                    maximumAge: 300000 // Accept cached location up to 5 minutes old
                };

                navigator.geolocation.getCurrentPosition(resolve, reject, options);
            });
        }

        async function reverseGeocode(lat, lon) {
            try {
                // Using OpenStreetMap Nominatim (free, no API key required)
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`);

                if (!response.ok) {
                    throw new Error('Geocoding service unavailable');
                }

                const data = await response.json();

                // Extract city and county/state info
                const address = data.address || {};
                const city = address.city || address.town || address.village || address.hamlet;
                const county = address.county;
                const state = address.state;

                // Format location string
                let location = '';
                if (city && county) {
                    location = `${city}, ${county}`;
                } else if (city && state) {
                    location = `${city}, ${state}`;
                } else if (county && state) {
                    location = `${county}, ${state}`;
                } else if (city) {
                    location = city;
                } else if (county) {
                    location = county;
                } else {
                    throw new Error('Unable to determine location');
                }

                return location;

            } catch (error) {
                console.log('Reverse geocoding failed:', error);
                throw error;
            }
        }

        function updateLocationDisplay(element, address) {
            if (element) {
                // Check if location is in service area
                const isInServiceArea = checkServiceArea(address);

                if (isInServiceArea) {
                    element.textContent = address;
                    element.style.color = '#22c55e';
                    console.log('üìç Location updated:', address);
                    showToast(`Location detected: ${address}`, 'success');

                    // Initialize main page map
                    initializeMainPageMap();
                } else {
                    element.textContent = `${address} (Outside service area)`;
                    element.style.color = '#f59e0b';
                    console.log('üìç Location outside service area:', address);
                    showToast(`Location detected outside service area: ${address}`, 'warning');
                }
            }
        }

        function checkServiceArea(address) {
            const lowerAddress = address.toLowerCase();
            const serviceAreas = [
                'palm beach', 'broward', 'miami-dade', 'miami dade',
                'west palm beach', 'boca raton', 'delray beach', 'boynton beach',
                'fort lauderdale', 'hollywood', 'pembroke pines', 'coral springs',
                'miami', 'aventura', 'coral gables', 'homestead', 'hialeah',
                'deerfield beach', 'pompano beach', 'plantation', 'sunrise',
                'davie', 'weston', 'miramar', 'cooper city'
            ];

            return serviceAreas.some(area => lowerAddress.includes(area));
        }

        function showServiceAreaNotice() {
            // Add a subtle notice about service area
            setTimeout(() => {
                const notice = document.createElement('div');
                notice.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-orange-100 border border-orange-300 text-orange-800 px-4 py-2 rounded-lg shadow-lg z-50 text-sm';
                notice.innerHTML = `
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span>We primarily serve Palm Beach, Broward & Miami-Dade counties</span>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-2 hover:text-orange-900">‚úï</button>
                    </div>
                `;
                document.body.appendChild(notice);

                // Auto-remove after 8 seconds
                setTimeout(() => {
                    if (notice.parentElement) {
                        notice.remove();
                    }
                }, 8000);
            }, 2000);
        }

        function setFallbackLocation(element) {
            if (element) {
                element.textContent = 'Palm Beach, Broward & Miami-Dade';
                element.style.color = ''; // Default color
                console.log('üìç Using fallback location');

                // Initialize main page map
                initializeMainPageMap();
            }
        }

        // Toast Notification System
        function showToast(message, type = 'success', duration = 4000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';

            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="text-lg">${icon}</span>
                    <div class="flex-1">
                        <p class="font-medium text-gray-900">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            `;

            document.body.appendChild(toast);

            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 100);

            // Auto remove
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Progress Management
        function updateProgress(step) {
            currentBookingStep = step;

            // Reset all steps
            for (let i = 1; i <= 4; i++) {
                const stepElement = document.getElementById(`step${i}`);
                const connector = document.getElementById(`connector${i}`);

                if (stepElement) {
                    const circle = stepElement.querySelector('div');
                    const label = stepElement.querySelector('span');

                    if (i < step) {
                        // Completed step
                        circle.className = 'w-8 h-8 rounded-full bg-green-600 text-white flex items-center justify-center text-sm font-semibold';
                        circle.innerHTML = '‚úì';
                        if (label) label.className = 'ml-2 text-sm font-medium text-green-700 hidden sm:inline';
                        if (connector) connector.className = 'w-8 h-0.5 bg-green-600 mx-2 sm:mx-4';
                    } else if (i === step) {
                        // Current step
                        circle.className = 'w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-sm font-semibold';
                        circle.innerHTML = i;
                        if (label) label.className = 'ml-2 text-sm font-medium text-gray-900 hidden sm:inline';
                        if (connector) connector.className = 'w-8 h-0.5 bg-gray-200 mx-2 sm:mx-4';
                    } else {
                        // Future step
                        circle.className = 'w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center text-sm font-semibold';
                        circle.innerHTML = i;
                        if (label) label.className = 'ml-2 text-sm font-medium text-gray-500 hidden sm:inline';
                        if (connector) connector.className = 'w-8 h-0.5 bg-gray-200 mx-2 sm:mx-4';
                    }
                }
            }
        }

        // Loading States
        function showLoading(message = 'Loading...') {
            const overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.className = 'loading-overlay';
            overlay.innerHTML = `
                <div class="text-center">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-gray-600 font-medium">${message}</p>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // Accessibility helpers
        function handleEnterKey(event, callback) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                callback();
            }
        }

        // Mobile-first sticky bottom bar for booking
        function showStickyBottomBar(text, action, price = null) {
            // Remove existing bottom bar
            const existing = document.getElementById('stickyBottomBar');
            if (existing) existing.remove();

            const bottomBar = document.createElement('div');
            bottomBar.id = 'stickyBottomBar';
            bottomBar.className = 'sticky-bottom-bar md:hidden';

            const priceText = price ? ` - ${price}` : '';
            bottomBar.innerHTML = `
                <button onclick="${action}" class="btn-primary w-full py-4 text-lg font-semibold">
                    ${text}${priceText}
                </button>
            `;

            document.body.appendChild(bottomBar);
        }

        function hideStickyBottomBar() {
            const bottomBar = document.getElementById('stickyBottomBar');
            if (bottomBar) bottomBar.remove();
        }

        // Utility functions
        function toggleMobileMenu() {
            // Mobile menu toggle logic
        }

        function showLoginModal() {
            // Redirect to admin dashboard
            window.location.href = 'admin.html';
        }

        function showAllServices() {
            const content = document.getElementById('serviceContent');
            document.getElementById('landingScreen').classList.add('hide');
            document.getElementById('serviceFlow').classList.remove('hide');
            currentStep = 'services';

            content.innerHTML = `
                <div class="slide-up">
                    <h2 class="text-2xl font-bold mb-2">All Services</h2>
                    <p class="text-gray-600 mb-6">Choose the service you need help with</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                        <div class="service-card p-4" onclick="selectService('light-plumbing')">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl">üöø</div>
                                <div>
                                    <div class="font-semibold">Light Plumbing</div>
                                    <div class="text-sm text-gray-600">Faucets, toilets, minor leaks</div>
                                </div>
                            </div>
                        </div>

                        <div class="service-card p-4" onclick="selectService('electrical')">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl">‚ö°</div>
                                <div>
                                    <div class="font-semibold">Electrical</div>
                                    <div class="text-sm text-gray-600">Outlets, switches, light fixtures</div>
                                </div>
                            </div>
                        </div>

                        <div class="service-card p-4" onclick="selectService('mounting')">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl">üì∫</div>
                                <div>
                                    <div class="font-semibold">TV Mounting</div>
                                    <div class="text-sm text-gray-600">Wall mounting, cable management</div>
                                </div>
                            </div>
                        </div>

                        <div class="service-card p-4" onclick="selectService('furniture')">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl">ü™ë</div>
                                <div>
                                    <div class="font-semibold">Furniture Assembly</div>
                                    <div class="text-sm text-gray-600">IKEA, office furniture, beds</div>
                                </div>
                            </div>
                        </div>

                        <div class="service-card p-4" onclick="selectService('painting')">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl">üé®</div>
                                <div>
                                    <div class="font-semibold">Painting</div>
                                    <div class="text-sm text-gray-600">Touch-ups, small rooms, trim</div>
                                </div>
                            </div>
                        </div>

                        <div class="service-card p-4" onclick="selectService('appliances')">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl">üîå</div>
                                <div>
                                    <div class="font-semibold">Appliances</div>
                                    <div class="text-sm text-gray-600">Installation, basic repairs</div>
                                </div>
                            </div>
                        </div>

                        <div class="service-card p-4" onclick="selectService('repair')">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl">üî®</div>
                                <div>
                                    <div class="font-semibold">General Repair</div>
                                    <div class="text-sm text-gray-600">Doors, windows, drywall</div>
                                </div>
                            </div>
                        </div>

                        <div class="service-card p-4" onclick="selectService('ceiling-fan')">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex items-center justify-center">
                                    <img src="/images/fan.png" alt="Ceiling Fan" class="w-6 h-6">
                                </div>
                                <div>
                                    <div class="font-semibold">Ceiling Fan</div>
                                    <div class="text-sm text-gray-600">Install/replace ceiling fans</div>
                                </div>
                            </div>
                        </div>

                        <div class="service-card p-4" onclick="selectService('curtains-blinds')">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl">ü™ü</div>
                                <div>
                                    <div class="font-semibold">Curtain Rods / Blinds</div>
                                    <div class="text-sm text-gray-600">Mount curtain rods, install blinds</div>
                                </div>
                            </div>
                        </div>

                        <div class="service-card p-4" onclick="selectService('installation')">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl">üõ†Ô∏è</div>
                                <div>
                                    <div class="font-semibold">Installations</div>
                                    <div class="text-sm text-gray-600">Shelves, hardware, fixtures</div>
                                </div>
                            </div>
                        </div>

                        <div class="service-card p-4" onclick="selectService('outdoor')">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl">üè°</div>
                                <div>
                                    <div class="font-semibold">Outdoor</div>
                                    <div class="text-sm text-gray-600">Deck repairs, outdoor fixtures</div>
                                </div>
                            </div>
                        </div>

                        <div class="service-card p-4" onclick="selectService('other')">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl">‚ùì</div>
                                <div>
                                    <div class="font-semibold">Other</div>
                                    <div class="text-sm text-gray-600">Describe your specific need</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            updateProgress(25);
        }

        // Handle click outside modal to close
        function closePhotoModalIfClickedOutside(event) {
            if (event.target === event.currentTarget) {
                console.log('üñ±Ô∏è Clicked outside modal, closing...');
                closePhotoModal();
            }
        }

        // Main Page Map Functions
        let mainPageMap = null;
        let mainPageMarkers = [];
        let selectedMainPageMarker = null;

        async function initializeMainPageMap() {
            try {
                console.log('üó∫Ô∏è Initializing main page map...');

                // Get user location
                const userLocation = await getUserLocationForMap();

                // Hide loading state and show map
                document.getElementById('mapLoadingState').style.display = 'none';
                document.getElementById('mainHandymanMap').style.display = 'block';
                document.getElementById('recenterButton').style.display = 'block';

                // Initialize map
                if (mainPageMap) {
                    mainPageMap.remove();
                }

                mainPageMap = L.map('mainHandymanMap', {
                    zoomControl: true,
                    scrollWheelZoom: true
                }).setView(userLocation, 11);

                // Add map tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap'
                }).addTo(mainPageMap);

                // Add user location marker
                const userIcon = L.divIcon({
                    className: 'user-location-marker',
                    html: `<div style="background: #3b82f6; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });

                L.marker(userLocation, { icon: userIcon })
                    .addTo(mainPageMap)
                    .bindPopup('üìç Your Location');

                // Generate and add handyman markers
                const handymenData = generateAnonymousHandymanLocations(userLocation);
                addMainPageHandymanMarkers(handymenData);

                // Show compact list
                updateCompactHandymanList(handymenData);
                document.getElementById('compactHandymanList').style.display = 'block';

                console.log('‚úÖ Main page map initialized');

            } catch (error) {
                console.error('‚ùå Error initializing main page map:', error);
                document.getElementById('mapLoadingState').innerHTML = `
                    <div class="text-center text-red-500">
                        <div class="text-2xl mb-1">‚ùå</div>
                        <div class="text-xs">Map unavailable</div>
                    </div>
                `;
            }
        }

        function generateAnonymousHandymanLocations(userLocation) {
            const [userLat, userLng] = userLocation;

            // Anonymous handyman data with just city and skills
            const handymenData = [
                // Miami-Dade handymen
                { id: "h1", city: "Miami", lat: 25.7617, lng: -80.1918, status: "available", rating: 4.8, experience: 5, specialties: ["Plumbing", "Electrical"] },
                { id: "h2", city: "Coral Gables", lat: 25.7214, lng: -80.2683, status: "available", rating: 4.9, experience: 8, specialties: ["Painting", "General Repair"] },
                { id: "h3", city: "Aventura", lat: 25.9565, lng: -80.1389, status: "busy", rating: 4.7, experience: 3, specialties: ["TV Mounting", "Furniture Assembly"] },
                { id: "h4", city: "Homestead", lat: 25.4687, lng: -80.4776, status: "available", rating: 4.6, experience: 6, specialties: ["Ceiling Fan", "Electrical"] },

                // Broward handymen
                { id: "h5", city: "Fort Lauderdale", lat: 26.1224, lng: -80.1373, status: "available", rating: 4.8, experience: 7, specialties: ["Plumbing", "General Repair"] },
                { id: "h6", city: "Hollywood", lat: 26.0112, lng: -80.1495, status: "available", rating: 4.5, experience: 4, specialties: ["Painting", "Appliances"] },
                { id: "h7", city: "Coral Springs", lat: 26.2712, lng: -80.2706, status: "busy", rating: 4.7, experience: 5, specialties: ["Furniture Assembly", "Mounting"] },
                { id: "h8", city: "Plantation", lat: 26.1267, lng: -80.2331, status: "available", rating: 4.9, experience: 9, specialties: ["Electrical", "Ceiling Fan"] },

                // Palm Beach handymen
                { id: "h9", city: "West Palm Beach", lat: 26.7153, lng: -80.0534, status: "available", rating: 4.8, experience: 6, specialties: ["General Repair", "Painting"] },
                { id: "h10", city: "Boca Raton", lat: 26.3683, lng: -80.1289, status: "available", rating: 4.9, experience: 10, specialties: ["Plumbing", "Electrical"] },
                { id: "h11", city: "Wellington", lat: 26.6584, lng: -80.2417, status: "busy", rating: 4.6, experience: 4, specialties: ["Furniture Assembly", "Mounting"] },
                { id: "h12", city: "Jupiter", lat: 26.9342, lng: -80.0942, status: "available", rating: 4.7, experience: 7, specialties: ["Appliances", "General Repair"] }
            ];

            // Add slight location variance and calculate distances
            return handymenData.map(handyman => {
                const adjustedLat = handyman.lat + (Math.random() - 0.5) * 0.02;
                const adjustedLng = handyman.lng + (Math.random() - 0.5) * 0.02;
                const distance = calculateDistance(userLat, userLng, adjustedLat, adjustedLng);

                return {
                    ...handyman,
                    lat: adjustedLat,
                    lng: adjustedLng,
                    distance: distance
                };
            });
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 3959; // Earth's radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function addMainPageHandymanMarkers(handymenData) {
            // Clear existing markers
            mainPageMarkers.forEach(marker => mainPageMap.removeLayer(marker));
            mainPageMarkers = [];

            handymenData.forEach(handyman => {
                const isAvailable = handyman.status === 'available';

                const markerIcon = L.divIcon({
                    className: 'handyman-marker',
                    html: `
                        <div style="
                            background: ${isAvailable ? '#10b981' : '#6b7280'};
                            width: 18px;
                            height: 18px;
                            border-radius: 50%;
                            border: 2px solid white;
                            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 8px;
                            font-weight: bold;
                        ">
                            üî®
                        </div>
                    `,
                    iconSize: [18, 18],
                    iconAnchor: [9, 9]
                });

                const marker = L.marker([handyman.lat, handyman.lng], {
                    icon: markerIcon,
                    handymanData: handyman
                }).addTo(mainPageMap);

                // Click handler
                marker.on('click', () => {
                    selectMainPageHandyman(handyman, marker);
                });

                mainPageMarkers.push(marker);
            });
        }

        function selectMainPageHandyman(handyman, marker) {
            console.log('üéØ Main page handyman selected:', handyman.city);

            // Reset previous selection
            if (selectedMainPageMarker) {
                selectedMainPageMarker.setIcon(createCompactHandymanIcon(selectedMainPageMarker.options.handymanData.status, false));
            }

            // Highlight selected marker
            selectedMainPageMarker = marker;
            marker.setIcon(createCompactHandymanIcon(handyman.status, true));

            // Show compact details
            const detailsContainer = document.getElementById('compactHandymanDetails');
            detailsContainer.style.display = 'block';
            detailsContainer.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-medium text-sm">${handyman.city}</span>
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${
                                handyman.status === 'available'
                                    ? 'bg-green-100 text-green-700'
                                    : 'bg-gray-100 text-gray-600'
                            }">
                                ${handyman.status === 'available' ? '‚úÖ Available' : 'üîí Busy'}
                            </span>
                        </div>
                        <div class="text-xs text-gray-600 mb-2">
                            ‚≠ê ${handyman.rating} ‚Ä¢ ${handyman.experience}y exp ‚Ä¢ ~${Math.round(Math.random() * 5 + 1)} mi
                        </div>
                        <div class="flex flex-wrap gap-1">
                            ${handyman.specialties.slice(0, 2).map(specialty =>
                                `<span class="bg-blue-100 text-blue-700 px-1 py-0.5 rounded text-xs">${specialty}</span>`
                            ).join('')}
                            ${handyman.specialties.length > 2 ? `<span class="text-gray-500 text-xs">+${handyman.specialties.length - 2}</span>` : ''}
                        </div>
                    </div>
                    <button onclick="clearMainPageHandymanSelection()" class="text-gray-400 hover:text-gray-600 ml-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="mt-2">
                    <button onclick="bookMainPageHandyman('${handyman.id}')"
                            class="w-full ${handyman.status === 'available'
                                ? 'bg-blue-600 hover:bg-blue-700 text-white'
                                : 'bg-gray-300 text-gray-500 cursor-not-allowed'} py-1.5 px-3 rounded transition-colors text-sm"
                            ${handyman.status !== 'available' ? 'disabled' : ''}>
                        ${handyman.status === 'available' ? 'Select & Continue' : 'Currently Unavailable'}
                    </button>
                </div>
            `;
        }

        function createCompactHandymanIcon(status, isSelected = false) {
            const isAvailable = status === 'available';
            const size = isSelected ? 24 : 18;
            const borderWidth = isSelected ? 3 : 2;

            return L.divIcon({
                className: 'handyman-marker',
                html: `
                    <div style="
                        background: ${isAvailable ? '#10b981' : '#6b7280'};
                        width: ${size}px;
                        height: ${size}px;
                        border-radius: 50%;
                        border: ${borderWidth}px solid ${isSelected ? '#3b82f6' : 'white'};
                        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-size: ${size > 18 ? '10px' : '8px'};
                        font-weight: bold;
                        cursor: pointer;
                    ">
                        üî®
                    </div>
                `,
                iconSize: [size, size],
                iconAnchor: [size/2, size/2]
            });
        }

        function updateCompactHandymanList(handymenData) {
            const list = document.getElementById('compactHandymanList');
            const availableHandymen = handymenData
                .filter(h => h.status === 'available')
                .sort((a, b) => a.distance - b.distance)
                .slice(0, 3); // Show only closest 3 available handymen
            const busyHandymen = handymenData.filter(h => h.status === 'busy');

            list.innerHTML = `
                <div class="space-y-3">
                    <!-- Available Handymen -->
                    <div>
                        <div class="text-sm font-semibold text-green-700 mb-2 flex items-center">
                            <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                            ${availableHandymen.length} Closest Available
                        </div>
                        ${availableHandymen.map(handyman => `
                            <div class="bg-green-50 border border-green-200 p-3 rounded-lg mb-2 cursor-pointer hover:bg-green-100 transition-colors"
                                 onclick="selectMainPageHandymanFromList('${handyman.id}')">
                                <div class="space-y-1">
                                    <div class="font-medium text-sm text-gray-800">${handyman.city}</div>
                                    <div class="text-xs text-gray-600">‚≠ê ${handyman.rating} ‚Ä¢ ${handyman.experience}y</div>
                                    <div class="text-xs text-gray-600">${Math.round(handyman.distance)} mi away</div>
                                    <div class="flex flex-wrap gap-1 mt-1">
                                        ${handyman.specialties.slice(0, 2).map(specialty =>
                                            `<span class="bg-blue-100 text-blue-700 px-1 py-0.5 rounded text-xs">${specialty}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    ${busyHandymen.length > 0 ? `
                        <!-- Busy Handymen -->
                        <div>
                            <div class="text-sm font-semibold text-gray-600 mb-2 flex items-center">
                                <div class="w-2 h-2 bg-gray-500 rounded-full mr-2"></div>
                                ${busyHandymen.length} Busy
                            </div>
                            ${busyHandymen.slice(0, 2).map(handyman => `
                                <div class="bg-gray-50 border border-gray-200 p-3 rounded-lg mb-2 cursor-pointer"
                                     onclick="selectMainPageHandymanFromList('${handyman.id}')">
                                    <div class="space-y-1">
                                        <div class="font-medium text-sm text-gray-600">${handyman.city}</div>
                                        <div class="text-xs text-gray-500">‚≠ê ${handyman.rating} ‚Ä¢ ${handyman.experience}y</div>
                                        <div class="text-xs text-gray-500">~${Math.round(Math.random() * 5 + 1)} mi away</div>
                                        <div class="text-xs text-orange-600 font-medium">Available later</div>
                                    </div>
                                </div>
                            `).join('')}
                            ${busyHandymen.length > 2 ? `
                                <div class="text-xs text-gray-400 text-center">
                                    +${busyHandymen.length - 2} more later
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function selectMainPageHandymanFromList(handymanId) {
            const marker = mainPageMarkers.find(m => m.options.handymanData.id === handymanId);
            if (marker) {
                selectMainPageHandyman(marker.options.handymanData, marker);
            }
        }

        function clearMainPageHandymanSelection() {
            if (selectedMainPageMarker) {
                selectedMainPageMarker.setIcon(createCompactHandymanIcon(selectedMainPageMarker.options.handymanData.status, false));
                selectedMainPageMarker = null;
            }
            document.getElementById('compactHandymanDetails').style.display = 'none';
        }

        async function recenterMainPageMap() {
            if (!mainPageMap) return;

            try {
                // Get fresh user location
                const userLocation = await getUserLocationForMap();
                const [lat, lng] = userLocation;

                // Animate to user location
                mainPageMap.setView([lat, lng], 11, {
                    animate: true,
                    duration: 1.0
                });

                console.log('üéØ Map recentered to user location:', lat, lng);
            } catch (error) {
                console.error('Failed to recenter map:', error);
                // Fallback to default South Florida location
                mainPageMap.setView([26.1224, -80.1373], 10, {
                    animate: true,
                    duration: 1.0
                });
            }
        }

        function bookMainPageHandyman(handymanId) {
            const handymanData = mainPageMarkers.find(m => m.options.handymanData.id === handymanId)?.options.handymanData;
            if (handymanData && handymanData.status === 'available') {
                console.log('üìÖ Booking from main page map:', handymanData.city);

                // Store selected handyman data
                serviceData.selectedHandyman = handymanData;
                serviceData.preferredArea = handymanData.city;

                showToast(`Handyman selected in ${handymanData.city}! Let's get started.`, 'success');

                // Proceed to service selection
                setTimeout(() => {
                    startServiceFlow();
                }, 1000);
            }
        }

        // Legacy modal functions (keep for compatibility)
        function showHandymanMapButton() {
            // No longer needed - map is directly embedded
        }

        function showHandymanDistribution() {
            console.log('üó∫Ô∏è Opening handyman distribution map...');
            const modal = document.getElementById('handymanMapModal');
            if (modal) {
                modal.classList.remove('hide');
                modal.style.display = 'flex';
                loadHandymanDistribution();
                console.log('‚úÖ Handyman map modal opened');
            }
        }

        function closeHandymanMap() {
            console.log('üîÑ Closing handyman map...');
            const modal = document.getElementById('handymanMapModal');
            if (modal) {
                modal.classList.add('hide');
                modal.style.display = 'none';
                console.log('‚úÖ Handyman map closed');
            }
        }

        function closeHandymanMapIfClickedOutside(event) {
            if (event.target === event.currentTarget) {
                console.log('üñ±Ô∏è Clicked outside handyman map, closing...');
                closeHandymanMap();
            }
        }

        let handymanMap = null;
        let handymanMarkers = [];
        let selectedHandymanMarker = null;

        async function loadHandymanDistribution() {
            try {
                console.log('üó∫Ô∏è Loading Uber-style handyman map...');

                // Get user's detected location for map center
                const userLocation = await getUserLocationForMap();

                // Initialize Leaflet map
                if (handymanMap) {
                    handymanMap.remove(); // Clean up existing map
                }

                handymanMap = L.map('handymanMapContainer').setView(userLocation, 11);

                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(handymanMap);

                // Add user location marker
                const userIcon = L.divIcon({
                    className: 'user-location-marker',
                    html: `<div style="background: #3b82f6; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });

                L.marker(userLocation, { icon: userIcon })
                    .addTo(handymanMap)
                    .bindPopup('üìç Your Location')
                    .openPopup();

                // Generate realistic handyman locations around South Florida
                const handymenData = generateHandymanLocations(userLocation);

                // Clear existing markers
                handymanMarkers.forEach(marker => handymanMap.removeLayer(marker));
                handymanMarkers = [];

                // Add handyman markers
                handymenData.forEach((handyman, index) => {
                    const isAvailable = handyman.status === 'available';

                    const markerIcon = L.divIcon({
                        className: 'handyman-marker',
                        html: `
                            <div style="
                                background: ${isAvailable ? '#10b981' : '#6b7280'};
                                width: 24px;
                                height: 24px;
                                border-radius: 50%;
                                border: 2px solid white;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-size: 12px;
                                font-weight: bold;
                            ">
                                üî®
                            </div>
                        `,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });

                    const marker = L.marker([handyman.lat, handyman.lng], {
                        icon: markerIcon,
                        handymanData: handyman
                    }).addTo(handymanMap);

                    // Click handler for handyman markers
                    marker.on('click', () => {
                        selectHandyman(handyman, marker);
                    });

                    handymanMarkers.push(marker);
                });

                // Populate handyman list
                updateHandymanList(handymenData);

                console.log('‚úÖ Uber-style handyman map loaded successfully');

            } catch (error) {
                console.error('‚ùå Error loading handyman map:', error);
                const mapContainer = document.getElementById('handymanMapContainer');
                mapContainer.innerHTML = `
                    <div class="flex items-center justify-center h-full text-center text-red-600">
                        <div>
                            <div class="text-4xl mb-2">‚ùå</div>
                            <div>Error loading map</div>
                            <div class="text-sm mt-2">Please try again later</div>
                        </div>
                    </div>
                `;
            }
        }

        async function getUserLocationForMap() {
            try {
                const position = await getCurrentPosition();
                return [position.coords.latitude, position.coords.longitude];
            } catch (error) {
                console.log('Using default South Florida location for map');
                return [26.1224, -80.1373]; // Fort Lauderdale center
            }
        }

        function generateHandymanLocations(userLocation) {
            const [userLat, userLng] = userLocation;

            const handymenData = [
                // Miami-Dade handymen
                { id: "m1", city: "Miami", lat: 25.7617, lng: -80.1918, status: "available", rating: 4.8, experience: 5, specialties: ["Plumbing", "Electrical"] },
                { id: "m2", city: "Coral Gables", lat: 25.7214, lng: -80.2683, status: "available", rating: 4.9, experience: 8, specialties: ["Painting", "General Repair"] },
                { id: "m3", city: "Aventura", lat: 25.9565, lng: -80.1389, status: "busy", rating: 4.7, experience: 3, specialties: ["TV Mounting", "Furniture Assembly"] },
                { id: "m4", city: "Homestead", lat: 25.4687, lng: -80.4776, status: "available", rating: 4.6, experience: 6, specialties: ["Ceiling Fan", "Electrical"] },

                // Broward handymen
                { id: "m5", city: "Fort Lauderdale", lat: 26.1224, lng: -80.1373, status: "available", rating: 4.8, experience: 7, specialties: ["Plumbing", "General Repair"] },
                { id: "m6", city: "Hollywood", lat: 26.0112, lng: -80.1495, status: "available", rating: 4.5, experience: 4, specialties: ["Painting", "Appliances"] },
                { id: "m7", city: "Coral Springs", lat: 26.2712, lng: -80.2706, status: "busy", rating: 4.7, experience: 5, specialties: ["Furniture Assembly", "Mounting"] },
                { id: "m8", city: "Plantation", lat: 26.1267, lng: -80.2331, status: "available", rating: 4.9, experience: 9, specialties: ["Electrical", "Ceiling Fan"] },

                // Palm Beach handymen
                { id: "m9", city: "West Palm Beach", lat: 26.7153, lng: -80.0534, status: "available", rating: 4.8, experience: 6, specialties: ["General Repair", "Painting"] },
                { id: "m10", city: "Boca Raton", lat: 26.3683, lng: -80.1289, status: "available", rating: 4.9, experience: 10, specialties: ["Plumbing", "Electrical"] },
                { id: "m11", city: "Wellington", lat: 26.6584, lng: -80.2417, status: "busy", rating: 4.6, experience: 4, specialties: ["Furniture Assembly", "Mounting"] },
                { id: "m12", city: "Jupiter", lat: 26.9342, lng: -80.0942, status: "available", rating: 4.7, experience: 7, specialties: ["Appliances", "General Repair"] }
            ];

            // Add slight location variance for realism
            return handymenData.map(handyman => ({
                ...handyman,
                lat: handyman.lat + (Math.random() - 0.5) * 0.02, // ¬±0.01 degree variance
                lng: handyman.lng + (Math.random() - 0.5) * 0.02,
                id: Math.random().toString(36).substr(2, 9)
            }));
        }

        function selectHandyman(handyman, marker) {
            console.log('üéØ Handyman selected:', handyman.city);

            // Reset previous selection
            if (selectedHandymanMarker) {
                selectedHandymanMarker.setIcon(createHandymanIcon(selectedHandymanMarker.options.handymanData.status, false));
            }

            // Highlight selected marker
            selectedHandymanMarker = marker;
            marker.setIcon(createHandymanIcon(handyman.status, true));

            // Show handyman details
            const detailsContainer = document.getElementById('selectedHandymanDetails');
            detailsContainer.style.display = 'block';
            detailsContainer.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <h4 class="font-semibold text-lg">${handyman.city} Handyman</h4>
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${
                                handyman.status === 'available'
                                    ? 'bg-green-100 text-green-800'
                                    : 'bg-gray-100 text-gray-600'
                            }">
                                ${handyman.status === 'available' ? '‚úÖ Available' : 'üîí Busy'}
                            </span>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm mb-3">
                            <div><span class="text-gray-600">Location:</span> ${handyman.city}</div>
                            <div><span class="text-gray-600">Rating:</span> <span class="text-yellow-600">‚≠ê ${handyman.rating}</span></div>
                            <div><span class="text-gray-600">Experience:</span> ${handyman.experience} years</div>
                            <div><span class="text-gray-600">Distance:</span> ~${Math.round(Math.random() * 5 + 1)} miles</div>
                        </div>
                        <div class="mb-3">
                            <span class="text-gray-600 text-sm">Specialties: </span>
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${handyman.specialties.map(specialty =>
                                    `<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs">${specialty}</span>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                    <button onclick="clearHandymanSelection()" class="text-gray-400 hover:text-gray-600 ml-4">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="flex gap-3 mt-4">
                    <button onclick="bookHandyman('${handyman.id}')"
                            class="flex-1 ${handyman.status === 'available'
                                ? 'bg-blue-600 hover:bg-blue-700 text-white'
                                : 'bg-gray-300 text-gray-500 cursor-not-allowed'} py-2 px-4 rounded transition-colors"
                            ${handyman.status !== 'available' ? 'disabled' : ''}>
                        ${handyman.status === 'available' ? 'Book This Handyman' : 'Currently Unavailable'}
                    </button>
                    <button onclick="showHandymanProfile('${handyman.id}')" class="bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-4 rounded transition-colors">
                        View Profile
                    </button>
                </div>
            `;

            // Center map on selected handyman
            handymanMap.setView([handyman.lat, handyman.lng], 13);
        }

        function createHandymanIcon(status, isSelected = false) {
            const isAvailable = status === 'available';
            const size = isSelected ? 32 : 24;
            const borderWidth = isSelected ? 3 : 2;

            return L.divIcon({
                className: 'handyman-marker',
                html: `
                    <div style="
                        background: ${isAvailable ? '#10b981' : '#6b7280'};
                        width: ${size}px;
                        height: ${size}px;
                        border-radius: 50%;
                        border: ${borderWidth}px solid ${isSelected ? '#3b82f6' : 'white'};
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-size: ${size > 24 ? '14px' : '12px'};
                        font-weight: bold;
                        cursor: pointer;
                    ">
                        üî®
                    </div>
                `,
                iconSize: [size, size],
                iconAnchor: [size/2, size/2]
            });
        }

        function updateHandymanList(handymenData) {
            const handymanList = document.getElementById('handymanList');
            const availableHandymen = handymenData.filter(h => h.status === 'available');
            const busyHandymen = handymenData.filter(h => h.status === 'busy');

            handymanList.innerHTML = `
                ${availableHandymen.length > 0 ? `
                    <div class="mb-4">
                        <h5 class="text-sm font-medium text-green-700 mb-2">‚úÖ Available Now (${availableHandymen.length})</h5>
                        ${availableHandymen.map(handyman => createHandymanListItem(handyman)).join('')}
                    </div>
                ` : ''}

                ${busyHandymen.length > 0 ? `
                    <div>
                        <h5 class="text-sm font-medium text-gray-600 mb-2">üîí Currently Busy (${busyHandymen.length})</h5>
                        ${busyHandymen.map(handyman => createHandymanListItem(handyman)).join('')}
                    </div>
                ` : ''}
            `;
        }

        function createHandymanListItem(handyman) {
            return `
                <div class="bg-white p-3 rounded-lg border border-gray-200 hover:border-blue-300 transition-colors cursor-pointer"
                     onclick="selectHandymanFromList('${handyman.id}')">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-medium">${handyman.city} Handyman</div>
                            <div class="text-sm text-gray-600">‚≠ê ${handyman.rating} ‚Ä¢ ${handyman.experience}y exp ‚Ä¢ ${handyman.specialties[0]}</div>
                        </div>
                        <div class="text-sm ${handyman.status === 'available' ? 'text-green-600' : 'text-gray-500'}">
                            ~${Math.round(Math.random() * 5 + 1)} mi
                        </div>
                    </div>
                </div>
            `;
        }

        function selectHandymanFromList(handymanId) {
            const marker = handymanMarkers.find(m => m.options.handymanData.id === handymanId);
            if (marker) {
                selectHandyman(marker.options.handymanData, marker);
            }
        }

        function clearHandymanSelection() {
            if (selectedHandymanMarker) {
                selectedHandymanMarker.setIcon(createHandymanIcon(selectedHandymanMarker.options.handymanData.status, false));
                selectedHandymanMarker = null;
            }
            document.getElementById('selectedHandymanDetails').style.display = 'none';
        }

        function bookHandyman(handymanId) {
            const handyman = handymanMarkers.find(m => m.options.handymanData.id === handymanId)?.options.handymanData;
            if (handyman && handyman.status === 'available') {
                console.log('üìÖ Booking handyman:', handyman.name);
                closeHandymanMap();

                // Store selected handyman data
                serviceData.selectedHandyman = handyman;

                showToast(`Great! Starting booking process with ${handyman.city} handyman`, 'success');

                // Proceed to service flow with handyman selected
                setTimeout(() => {
                    startServiceFlow();
                }, 1000);
            }
        }

        function showHandymanProfile(handymanId) {
            const handyman = handymanMarkers.find(m => m.options.handymanData.id === handymanId)?.options.handymanData;
            if (handyman) {
                showToast(`Handyman profile coming soon!`, 'info');
            }
        }

        function selectAreaAndBook(city) {
            console.log(`üéØ User selected ${city} for booking`);
            closeHandymanMap();

            // Update service data with selected area
            serviceData.preferredArea = city;

            // Show toast and proceed to service selection
            showToast(`Great! We'll prioritize handymen in ${city} for your booking`, 'success');

            // Trigger service selection flow
            setTimeout(() => {
                startServiceFlow();
            }, 1000);
        }

        // Handle escape key to close modals
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const photoModal = document.getElementById('photoModal');
                const handymanModal = document.getElementById('handymanMapModal');

                if (handymanModal && !handymanModal.classList.contains('hide')) {
                    console.log('‚å®Ô∏è Escape key pressed, closing handyman map...');
                    closeHandymanMap();
                } else if (photoModal && !photoModal.classList.contains('hide')) {
                    console.log('‚å®Ô∏è Escape key pressed, closing photo modal...');
                    closePhotoModal();
                }
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('SendAHandyman Uber-style interface loaded');

            // Set current year in footer
            const yearElement = document.getElementById('year');
            if (yearElement) {
                yearElement.textContent = new Date().getFullYear();
            }

            // Initialize location detection
            detectUserLocation();

            // Update availability text based on day of week
            updateAvailabilityText();

            // Debug: Test Sunday logic with actual date
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            console.log('üóìÔ∏è Debug info:', {
                today: now.toDateString(),
                tomorrow: tomorrow.toDateString(),
                tomorrowDay: tomorrow.getDay(),
                isTomorrowSunday: tomorrow.getDay() === 0
            });

            // Ensure landing screen is visible and other screens are hidden
            document.getElementById('landingScreen').classList.remove('hide');
            document.getElementById('serviceFlow').classList.add('hide');

            // Force hide photo modal with multiple methods
            const photoModal = document.getElementById('photoModal');
            if (photoModal) {
                photoModal.classList.add('hide');
                photoModal.style.display = 'none'; // Force hide with inline style
                console.log('üîí Photo modal force hidden');
            }

            // Reset current step
            currentStep = 'landing';

            console.log('‚úÖ Landing page initialized correctly');
        });
    </script>
</body>
</html>