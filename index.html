<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SendAHandyman — Same-Day / Next-Day Handyman Dispatch</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
    <style>
        body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
        .shadow-soft{box-shadow:0 10px 30px rgba(0,0,0,.06)}
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

<!-- Header -->
<header class="bg-white/80 backdrop-blur sticky top-0 z-40 border-b border-slate-100">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-2">
            <img src="/images/helpinghands_logo.png" alt="Logo" class="h-9 w-auto">
            <span class="font-semibold">SendAHandyman</span>
        </div>
        <a href="#book" class="bg-indigo-600 px-4 py-2 text-white text-sm font-semibold rounded-xl">Book same-day</a>
    </div>
</header>

<!-- Hero -->
<section class="bg-gradient-to-b from-white to-slate-50">
    <div class="max-w-6xl mx-auto px-4 py-16 grid md:grid-cols-2 gap-10 items-center">
        <div>
            <h1 class="text-5xl font-extrabold leading-tight">Local handyman help — <span class="text-indigo-600">today or tomorrow</span>.</h1>
            <p class="mt-4 text-slate-600 text-lg">Upload photos, get an instant AI estimate, and reserve with your card.</p>
        </div>
        <div class="bg-white rounded-2xl p-5 shadow-soft border">
            <div class="aspect-video rounded-xl bg-gray-200"></div>
        </div>
    </div>
</section>

<!-- STEP 2: Start Your Request Form -->
<section id="book" class="py-12">
    <div class="max-w-6xl mx-auto px-4 grid md:grid-cols-2 gap-10 items-start">
        <div class="bg-white rounded-2xl p-6 shadow-soft border">
            <h3 class="text-xl font-bold">Start your request</h3>

            <div class="mt-4 grid md:grid-cols-2 gap-4">
                <div>
                    <label class="text-sm font-semibold">Full name</label>
                    <input id="customerName" required class="mt-1 w-full rounded-lg border px-3 py-2">
                </div>
                <div>
                    <label class="text-sm font-semibold">Mobile phone</label>
                    <input id="customerPhone" required class="mt-1 w-full rounded-lg border px-3 py-2">
                </div>
                <div>
                    <label class="text-sm font-semibold">Email</label>
                    <input type="email" id="customerEmail" required class="mt-1 w-full rounded-lg border px-3 py-2">
                </div>
                <div>
                    <label class="text-sm font-semibold">ZIP code</label>
                    <input id="customerZip" required class="mt-1 w-full rounded-lg border px-3 py-2">
                </div>
            </div>

            <div class="mt-4 grid md:grid-cols-2 gap-4">
                <div>
                    <label class="text-sm font-semibold">Task</label>
                    <select id="taskCategory" required class="mt-1 w-full rounded-lg border px-3 py-2">
                        <option value="">Select a task</option>
                        <option value="tv_mount">TV mounting</option>
                        <option value="ceiling_fan">Ceiling fan install</option>
                        <option value="light_fixture">Light fixture swap</option>
                        <option value="faucet_showerhead">Faucet/showerhead replace</option>
                        <option value="smart_doorbell">Smart doorbell install</option>
                        <option value="curtains_blinds">Curtain rods/blinds</option>
                        <option value="floating_shelf">Floating shelf install</option>
                        <option value="appliance_hookup">Appliance hookup</option>
                        <option value="furniture_assembly">Furniture assembly</option>
                        <option value="minor_repairs">Minor repairs</option>
                    </select>
                </div>
                <div>
                    <label class="text-sm font-semibold">When?</label>
                    <select id="taskWindow" required class="mt-1 w-full rounded-lg border px-3 py-2">
                        <option value="today_am">Today (8-12)</option>
                        <option value="today_pm">Today (12-4)</option>
                        <option value="today_eve">Today (4-8)</option>
                        <option value="tomorrow_am">Tomorrow (8-12)</option>
                        <option value="tomorrow_pm">Tomorrow (12-4)</option>
                    </select>
                </div>
            </div>

            <div class="mt-4">
                <label class="text-sm font-semibold">Describe the job</label>
                <textarea id="taskDescription" rows="3" placeholder="Product link, wall type, special notes..." class="mt-1 w-full rounded-lg border px-3 py-2"></textarea>
            </div>

            <div class="mt-4">
                <label class="text-sm font-semibold">Upload photos</label>
                <input id="taskPhotos" type="file" accept="image/*" multiple class="mt-1 w-full rounded-lg border px-3 py-2">
                <div id="photoThumbs" class="mt-2 flex flex-wrap gap-2"></div>
            </div>

            <div class="mt-6 flex items-center gap-2">
                <input id="rushOption" type="checkbox" class="h-4 w-4">
                <label class="text-sm">Optional rush (+10%)</label>
            </div>

            <!-- STEP 3: Get Instant Estimate Button -->
            <div class="mt-6">
                <button type="button" id="getEstimateBtn" class="w-full rounded-xl bg-slate-900 text-white px-5 py-3 font-semibold">
                    Get instant estimate
                </button>

                <!-- Progress Bar -->
                <div id="progressContainer" class="mt-3 hidden">
                    <div class="w-full bg-slate-200 rounded-full h-2">
                        <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <div id="progressMessage" class="text-sm text-slate-600 mt-1 text-center">Starting analysis...</div>
                </div>
            </div>
        </div>

        <!-- AI Estimate Panel -->
        <div id="estimatePanel" class="bg-white rounded-2xl p-6 shadow-soft border hidden">
            <h3 class="text-xl font-bold">AI Estimate</h3>
            <div class="mt-4 grid gap-3">
                <div class="flex items-baseline justify-between">
                    <span class="text-slate-600">Duration</span>
                    <strong id="estimatedHours">—</strong>
                </div>
                <div class="flex items-baseline justify-between">
                    <span class="text-slate-600">Price</span>
                    <strong id="estimatedPrice" class="text-2xl">—</strong>
                </div>
                <div class="rounded-lg bg-slate-50 border p-3 text-sm">
                    <div class="font-semibold mb-1">Fare breakdown</div>
                    <div id="fareBreakdown" class="space-y-1"></div>
                </div>
            </div>
            <div class="mt-4">
                <h4 class="font-semibold">What we'll do</h4>
                <ul id="estimateScope" class="list-disc pl-5 text-sm text-slate-700 space-y-1"></ul>
            </div>
            <div class="mt-4">
                <h4 class="font-semibold">Things to note</h4>
                <ul id="estimateRisks" class="list-disc pl-5 text-sm text-slate-700 space-y-1"></ul>
            </div>
            <div class="mt-6">
                <button id="reserveBtn" class="w-full rounded-xl bg-indigo-600 text-white px-5 py-3 font-semibold">Reserve with card</button>
            </div>
        </div>
    </div>
</section>

<!-- STEP 4: Payment Modal -->
<div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl p-6 max-w-md w-full shadow-2xl">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold">Complete Payment</h3>
            <button id="closePayment" class="text-slate-400 hover:text-slate-600 text-2xl">×</button>
        </div>

        <div class="mb-4 p-3 bg-slate-50 rounded-lg">
            <div class="text-sm text-slate-600">Total amount</div>
            <div id="paymentAmount" class="text-2xl font-bold">$0</div>
        </div>

        <form id="paymentForm">
            <div id="stripe-payment-element" class="mb-4"></div>
            <button id="submitPayment" type="submit" class="w-full rounded-xl bg-indigo-600 text-white px-5 py-3 font-semibold">
                Complete Payment
            </button>
            <div id="paymentMessage" class="mt-4 text-sm hidden"></div>
        </form>
    </div>
</div>

<!-- STEP 5: Task Information Modal -->
<div id="taskInfoModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl p-6 max-w-lg w-full shadow-2xl">
        <div class="text-center mb-6">
            <div class="text-6xl mb-2">✅</div>
            <h3 class="text-xl font-bold mb-2 text-green-600">Payment Approved!</h3>
            <p class="text-sm text-green-700">Please provide additional details below.</p>
        </div>

        <form id="taskInfoForm">
            <div class="bg-slate-50 rounded-lg p-4 mb-6">
                <h4 class="font-semibold mb-3">Job Summary</h4>
                <div class="text-sm space-y-1">
                    <div><strong>Customer:</strong> <span id="summaryName">—</span></div>
                    <div><strong>Phone:</strong> <span id="summaryPhone">—</span></div>
                    <div><strong>Email:</strong> <span id="summaryEmail">—</span></div>
                    <div><strong>Task:</strong> <span id="summaryTask">—</span></div>
                    <div><strong>Window:</strong> <span id="summaryWindow">—</span></div>
                </div>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-sm font-semibold">Property Address</label>
                    <textarea id="propertyAddress" rows="3" required class="mt-1 w-full rounded-lg border px-3 py-2"></textarea>
                </div>

                <div>
                    <label class="text-sm font-semibold">Contact Phone</label>
                    <input type="tel" id="contactPhone" required class="mt-1 w-full rounded-lg border px-3 py-2">
                </div>

                <div>
                    <label class="text-sm font-semibold">Property Access Details</label>
                    <textarea id="accessDetails" rows="2" class="mt-1 w-full rounded-lg border px-3 py-2"></textarea>
                </div>

                <div>
                    <label class="text-sm font-semibold">Additional Details</label>
                    <textarea id="additionalDetails" rows="3" class="mt-1 w-full rounded-lg border px-3 py-2"></textarea>
                </div>
            </div>

            <div class="mt-6">
                <button type="submit" class="w-full rounded-xl bg-indigo-600 text-white px-5 py-3 font-semibold">
                    Dispatch Handyman
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Final Success Modal -->
<div id="finalSuccessModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl p-6 max-w-md w-full shadow-2xl text-center">
        <div class="text-6xl mb-4">🚀</div>
        <h3 class="text-xl font-bold mb-2 text-green-600">Handyman Dispatched!</h3>
        <p class="text-sm text-slate-600 mb-4">Your job details have been sent to our team.</p>
        <button id="closeFinalSuccess" class="rounded-xl bg-indigo-600 text-white px-5 py-3 font-semibold">Perfect!</button>
    </div>
</div>

<script>
    console.log('JavaScript started loading...');

    // GLOBAL STATE
    let formData = {};
    let estimateData = {};
    let paymentIntentId = null;

    // Stripe Configuration
    const STRIPE_PUBLISHABLE_KEY = 'pk_test_51Rz41zHQ4TkcNcqvEebLo8rN5MmgInckOQSG6tuZa4XoN6czEXbxK8FtXcJqEu9RbkHclHxRhXRHVRAxDJ2q6PtD00KbGASb91';
    let stripe, elements, paymentElement;

    const RATE = 80;
    const PREMIUM_SAMEDAY = 0.15;
    const PREMIUM_EVENING = 0.10;
    const PREMIUM_RUSH = 0.10;

    const TASKS = {
        tv_mount: { hours: 1.5, label: 'TV Wall Mount' },
        ceiling_fan: { hours: 2.0, label: 'Ceiling Fan Install' },
        light_fixture: { hours: 1.0, label: 'Light Fixture Swap' },
        faucet_showerhead: { hours: 1.0, label: 'Faucet/Showerhead Replace' },
        smart_doorbell: { hours: 0.75, label: 'Smart Doorbell Install' },
        curtains_blinds: { hours: 1.0, label: 'Curtain Rods/Blinds' },
        floating_shelf: { hours: 1.0, label: 'Floating Shelf Install' },
        appliance_hookup: { hours: 1.5, label: 'Appliance Hookup' },
        furniture_assembly: { hours: 1.5, label: 'Furniture Assembly' },
        minor_repairs: { hours: 1.5, label: 'Minor Repairs' }
    };

    // Initialize Stripe
    function initializeStripe() {
        if (typeof Stripe !== 'undefined') {
            if (!STRIPE_PUBLISHABLE_KEY.includes('YOUR_ACTUAL_STRIPE_KEY_HERE')) {
                try {
                    stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
                    console.log('Stripe initialized successfully');
                } catch (error) {
                    console.error('Stripe initialization failed:', error);
                }
            } else {
                console.error('Please set your actual Stripe publishable key!');
            }
        } else {
            console.log('Stripe not loaded yet, retrying...');
            setTimeout(initializeStripe, 1000);
        }
    }

    // Save form data
    function saveFormData() {
        console.log('Saving form data...');

        formData = {
            name: document.getElementById('customerName').value,
            phone: document.getElementById('customerPhone').value,
            email: document.getElementById('customerEmail').value,
            zip: document.getElementById('customerZip').value,
            category: document.getElementById('taskCategory').value,
            window: document.getElementById('taskWindow').value,
            description: document.getElementById('taskDescription').value,
            rush: document.getElementById('rushOption').checked
        };

        console.log('Form data saved:', formData);
        return formData;
    }

    // Show progress
    function showEstimateProgress() {
        const container = document.getElementById('progressContainer');
        const bar = document.getElementById('progressBar');
        const message = document.getElementById('progressMessage');
        const btn = document.getElementById('getEstimateBtn');

        btn.disabled = true;
        container.classList.remove('hidden');

        // Progress stages
        setTimeout(() => {
            bar.style.width = '25%';
            message.textContent = 'Analyzing photos...';
        }, 500);

        setTimeout(() => {
            bar.style.width = '60%';
            message.textContent = 'AI processing...';
        }, 2000);

        setTimeout(() => {
            bar.style.width = '90%';
            message.textContent = 'Generating estimate...';
        }, 3500);

        setTimeout(() => {
            bar.style.width = '100%';
            message.textContent = 'Complete!';
        }, 4500);
    }

    function resetEstimateProgress() {
        setTimeout(() => {
            const btn = document.getElementById('getEstimateBtn');
            const container = document.getElementById('progressContainer');
            const bar = document.getElementById('progressBar');

            btn.disabled = false;
            container.classList.add('hidden');
            bar.style.width = '0%';
        }, 1000);
    }

    // Calculate pricing
    function calculatePricing(hours, window, rush) {
        const base = hours * RATE;
        let premiums = [];
        let total = base;

        const sameDay = window.startsWith('today');
        const evening = window.includes('eve');

        if (sameDay) {
            const premium = base * PREMIUM_SAMEDAY;
            premiums.push({ label: 'Same-day premium (15%)', amount: premium });
            total += premium;
        }

        if (evening) {
            const premium = base * PREMIUM_EVENING;
            premiums.push({ label: 'Evening premium (10%)', amount: premium });
            total += premium;
        }

        if (rush) {
            const premium = base * PREMIUM_RUSH;
            premiums.push({ label: 'Rush service (10%)', amount: premium });
            total += premium;
        }

        return { base, premiums, total };
    }

    // Generate estimate
    async function generateEstimate() {
        console.log('Generate estimate clicked!');

        const data = saveFormData();

        if (!data.name || !data.phone || !data.email || !data.category) {
            alert('Please fill out all required fields');
            return;
        }

        console.log('Starting estimate generation...');
        showEstimateProgress();

        try {
            const hours = TASKS[data.category]?.hours || 1.5;

            // Call AI function
            const response = await fetch('/.netlify/functions/scope', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    category: data.category,
                    description: data.description,
                    base_rate_hr: RATE,
                    hours_base: hours,
                    window: data.window,
                    rush: data.rush,
                    name: data.name,
                    phone: data.phone,
                    email: data.email
                })
            });

            if (!response.ok) {
                throw new Error('AI estimate failed');
            }

            const aiResult = await response.json();
            const pricing = calculatePricing(hours, data.window, data.rush);

            estimateData = {
                ...aiResult,
                hours,
                pricing
            };

            // Show estimate after progress completes
            setTimeout(() => {
                showEstimatePanel(estimateData);
                resetEstimateProgress();
            }, 5000);

        } catch (error) {
            console.error('Estimate generation failed:', error);
            alert('Failed to generate estimate. Please try again.');
            resetEstimateProgress();
        }
    }

    // Show estimate panel
    function showEstimatePanel(estimate) {
        document.getElementById('estimatedHours').textContent = estimate.hours.toFixed(1) + ' hrs';
        document.getElementById('estimatedPrice').textContent = '$' + estimate.pricing.total.toFixed(0);

        // Fare breakdown
        let breakdownHtml = `<div class="flex justify-between"><span>Base ($${RATE}/hr)</span><span>$${estimate.pricing.base.toFixed(0)}</span></div>`;
        estimate.pricing.premiums.forEach(p => {
            breakdownHtml += `<div class="flex justify-between"><span>${p.label}</span><span>$${p.amount.toFixed(0)}</span></div>`;
        });
        breakdownHtml += `<hr class="my-2"><div class="flex justify-between font-semibold"><span>Total</span><span>$${estimate.pricing.total.toFixed(0)}</span></div>`;
        document.getElementById('fareBreakdown').innerHTML = breakdownHtml;

        // Scope and risks
        document.getElementById('estimateScope').innerHTML = (estimate.step_scope || []).map(s => `<li>${s}</li>`).join('');
        document.getElementById('estimateRisks').innerHTML = (estimate.risk_flags || []).map(r => `<li>${r}</li>`).join('');

        document.getElementById('estimatePanel').classList.remove('hidden');
    }

    // Show payment modal
    async function showPaymentModal() {
        if (!stripe) {
            alert('Payment system is still loading. Please try again.');
            return;
        }

        document.getElementById('paymentAmount').textContent = '$' + estimateData.pricing.total.toFixed(0);
        document.getElementById('paymentModal').classList.remove('hidden');

        try {
            const response = await fetch('/.netlify/functions/create-payment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    amount: estimateData.pricing.total,
                    customer_info: formData,
                    job_details: {
                        category: formData.category,
                        window: formData.window,
                        hours: estimateData.hours
                    }
                })
            });

            if (!response.ok) {
                throw new Error('Payment setup failed');
            }

            const result = await response.json();
            paymentIntentId = result.payment_intent_id;

            elements = stripe.elements({ clientSecret: result.client_secret });
            paymentElement = elements.create('payment');
            paymentElement.mount('#stripe-payment-element');

        } catch (error) {
            console.error('Payment setup error:', error);
            document.getElementById('paymentMessage').textContent = 'Payment setup failed. Please try again.';
            document.getElementById('paymentMessage').classList.remove('hidden');
        }
    }

    // Process payment
    async function processPayment(event) {
        event.preventDefault();

        const submitBtn = document.getElementById('submitPayment');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Processing...';

        try {
            const result = await stripe.confirmPayment({
                elements,
                redirect: 'if_required'
            });

            if (result.error) {
                throw new Error(result.error.message);
            }

            console.log('Payment successful:', result.paymentIntent.id);
            paymentIntentId = result.paymentIntent.id;

            document.getElementById('paymentModal').classList.add('hidden');
            showTaskInfoModal();

        } catch (error) {
            console.error('Payment failed:', error);
            document.getElementById('paymentMessage').textContent = error.message;
            document.getElementById('paymentMessage').classList.remove('hidden');

            submitBtn.disabled = false;
            submitBtn.textContent = 'Complete Payment';
        }
    }

    // Show task info modal
    function showTaskInfoModal() {
        document.getElementById('summaryName').textContent = formData.name;
        document.getElementById('summaryPhone').textContent = formData.phone;
        document.getElementById('summaryEmail').textContent = formData.email;
        document.getElementById('summaryTask').textContent = TASKS[formData.category]?.label || formData.category;
        document.getElementById('summaryWindow').textContent = formData.window;

        document.getElementById('contactPhone').value = formData.phone;
        document.getElementById('taskInfoModal').classList.remove('hidden');
    }

    // Submit task info
    async function submitTaskInfo(event) {
        event.preventDefault();

        const submitBtn = event.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Sending notification...';

        const completeJobData = {
            payment_intent_id: paymentIntentId,
            customer: formData,
            task_info: {
                property_address: document.getElementById('propertyAddress').value,
                contact_phone: document.getElementById('contactPhone').value,
                access_details: document.getElementById('accessDetails').value,
                additional_details: document.getElementById('additionalDetails').value
            },
            estimate: estimateData,
            amount: estimateData.pricing.total
        };

        console.log('Sending job data:', completeJobData);

        try {
            const response = await fetch('/.netlify/functions/send-notification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(completeJobData)
            });

            if (response.ok) {
                console.log('Notification sent successfully');
            } else {
                console.error('Notification failed');
            }
        } catch (error) {
            console.error('Notification error:', error);
        }

        document.getElementById('taskInfoModal').classList.add('hidden');
        document.getElementById('finalSuccessModal').classList.remove('hidden');
    }

    // Initialize everything
    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM loaded, initializing...');

        initializeStripe();

        // Photo upload preview
        document.getElementById('taskPhotos').addEventListener('change', (e) => {
            const thumbs = document.getElementById('photoThumbs');
            thumbs.innerHTML = '';
            [...e.target.files].slice(0, 5).forEach(file => {
                const url = URL.createObjectURL(file);
                const img = document.createElement('img');
                img.src = url;
                img.className = 'h-16 w-16 object-cover rounded-lg border';
                thumbs.appendChild(img);
            });
        });

        // Event listeners
        document.getElementById('getEstimateBtn').addEventListener('click', generateEstimate);
        document.getElementById('reserveBtn').addEventListener('click', showPaymentModal);
        document.getElementById('paymentForm').addEventListener('submit', processPayment);
        document.getElementById('closePayment').addEventListener('click', () => {
            document.getElementById('paymentModal').classList.add('hidden');
        });
        document.getElementById('taskInfoForm').addEventListener('submit', submitTaskInfo);
        document.getElementById('closeFinalSuccess').addEventListener('click', () => {
            document.getElementById('finalSuccessModal').classList.add('hidden');
            location.reload();
        });

        console.log('All initialized successfully');
    });

    console.log('JavaScript finished loading');
</script>

</body>
</html>