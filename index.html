<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>SendAHandyman ‚Äî Fix anything with SendAHandyman</title>
    <meta name="description" content="Book a vetted handyman today or tomorrow. Upload photos, get an instant AI estimate, and reserve with your card. Serving Palm Beach, Broward & Miami-Dade." />

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
    <link rel="apple-touch-icon" href="/images/favicon.png">

    <!-- Analytics -->
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-PW9HC7HL');</script>

    <!-- Google Analytics 4 + Google Ads -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JY95GYSE90"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        // Google Analytics 4
        gtag('config', 'G-JY95GYSE90', {
            page_title: 'SendAHandyman - Book Handyman Services',
            page_location: window.location.href
        });

        // Google Ads Conversion Tracking
        gtag('config', 'AW-17598022946');
    </script>

    <!-- Custom Analytics System -->
    <script>
        // Enhanced Analytics System for SendAHandyman
        const HandymanAnalytics = {
            sessionId: null,

            init() {
                this.sessionId = this.getOrCreateSessionId();
                this.trackPageView();
                console.log('üìä Analytics initialized for session:', this.sessionId);
            },

            getOrCreateSessionId() {
                let sessionId = sessionStorage.getItem('handyman_session_id');
                if (!sessionId) {
                    sessionId = 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    sessionStorage.setItem('handyman_session_id', sessionId);
                }
                return sessionId;
            },

            trackPageView() {
                this.trackEvent('page_view', {
                    page_title: document.title,
                    page_url: window.location.href,
                    referrer: document.referrer,
                    user_agent: navigator.userAgent,
                    screen_resolution: `${screen.width}x${screen.height}`,
                    is_mobile: window.innerWidth <= 768
                });
            },

            trackEvent(eventName, eventData = {}) {
                const eventPayload = {
                    event_name: eventName,
                    session_id: this.sessionId,
                    timestamp: new Date().toISOString(),
                    page_url: window.location.href,
                    ...eventData
                };

                // Send to custom analytics (Supabase)
                this.sendToCustomAnalytics(eventPayload);

                // Send to Google Analytics if available
                if (typeof gtag !== 'undefined') {
                    gtag('event', eventName, eventData);
                }

                console.log('üìä Event tracked:', eventName, eventData);
            },

            async sendToCustomAnalytics(payload) {
                try {
                    // Store analytics in Supabase for detailed analysis
                    // Use supabaseClient (the actual client instance, not the library)
                    if (typeof supabaseClient !== 'undefined' && supabaseClient) {
                        const { error } = await supabaseClient
                            .from('analytics_events')
                            .insert(payload);

                        if (error) {
                            console.error('Analytics insert error:', error);
                        }
                    }
                } catch (error) {
                    console.error('Analytics storage error:', error);
                }
            },

            // Booking funnel tracking methods
            trackSearchStarted(query) {
                this.trackEvent('search_started', {
                    search_query: query,
                    funnel_step: 1
                });
            },

            trackServiceSelected(service) {
                this.trackEvent('service_selected', {
                    service_type: service,
                    service_display: serviceData.categoryDisplay,
                    funnel_step: 2
                });
            },

            trackDetailsEntered(hasDescription, hasPhotos, hasLocation) {
                this.trackEvent('details_entered', {
                    has_description: hasDescription,
                    has_photos: hasPhotos,
                    has_location: hasLocation,
                    description_length: hasDescription ? serviceData.detailedDescription.length : 0,
                    funnel_step: 3
                });
            },

            trackPhotoUploaded(analysisResult) {
                this.trackEvent('photo_uploaded', {
                    ai_analysis_success: !!analysisResult,
                    analysis_category: analysisResult?.category,
                    analysis_confidence: analysisResult?.confidence
                });
            },

            trackSchedulingViewed(timeSlots) {
                this.trackEvent('scheduling_viewed', {
                    available_slots: timeSlots.length,
                    funnel_step: 4
                });
            },

            trackTimeSlotSelected(timeSlot) {
                this.trackEvent('time_slot_selected', {
                    selected_time: timeSlot.windowLabel,
                    pricing: serviceData.pricing?.total,
                    funnel_step: 5
                });
            },

            trackPaymentStarted(amount) {
                this.trackEvent('payment_started', {
                    amount: amount,
                    service: serviceData.categoryDisplay,
                    funnel_step: 6
                });
            },

            trackBookingCompleted(bookingData) {
                this.trackEvent('booking_completed', {
                    amount: bookingData.total_amount,
                    service: bookingData.service_category,
                    payment_intent: bookingData.payment_intent_id,
                    time_slot: bookingData.time_slot,
                    funnel_step: 7,
                    conversion: true
                });

                // Also track as conversion for Google Ads
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'conversion', {
                        'send_to': 'AW-17598022946/booking_conversion',
                        'value': bookingData.total_amount,
                        'currency': 'USD'
                    });
                }
            },

            trackError(errorType, errorMessage) {
                this.trackEvent('error_occurred', {
                    error_type: errorType,
                    error_message: errorMessage,
                    page_url: window.location.href
                });
            }
        };

        // Initialize analytics when page loads
        document.addEventListener('DOMContentLoaded', () => {
            HandymanAnalytics.init();

            // Initialize mobile menu functionality
            initializeMobileMenu();
        });

        // Mobile menu initialization
        function initializeMobileMenu() {
            // Close mobile menu when clicking outside
            document.addEventListener('click', (event) => {
                const mobileMenu = document.getElementById('mobileMenu');
                const hamburgerButton = document.querySelector('button[onclick="toggleMobileMenu()"]');

                if (!mobileMenu.classList.contains('hidden') &&
                    !mobileMenu.contains(event.target) &&
                    !hamburgerButton.contains(event.target)) {
                    toggleMobileMenu();
                }
            });

            // Close mobile menu when clicking on menu links
            const mobileMenuLinks = document.querySelectorAll('#mobileMenu a, #mobileMenu button');
            mobileMenuLinks.forEach(link => {
                link.addEventListener('click', () => {
                    const mobileMenu = document.getElementById('mobileMenu');
                    if (!mobileMenu.classList.contains('hidden')) {
                        toggleMobileMenu();
                    }
                });
            });
        }
    </script>

    <!-- Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style id="tailwind-textarea-override">
        /* Textarea styling with !important to override Tailwind */
        textarea#detailDescription,
        .mobile-textarea-force {
            min-height: 280px !important;
            height: 280px !important;
            font-size: 16px !important;
            padding: 16px !important;
            line-height: 1.6 !important;
            border: 1px solid #d1d5db !important;
            background: #ffffff !important;
            width: 100% !important;
            box-sizing: border-box !important;
            resize: vertical !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            border-radius: 12px !important;
        }

        textarea#detailDescription:focus,
        .mobile-textarea-force:focus {
            outline: none !important;
            border-color: #000000 !important;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1) !important;
        }

        /* Mobile - even larger textarea */
        @media screen and (max-width: 768px) {
            textarea#detailDescription,
            .mobile-textarea-force {
                min-height: 320px !important;
                height: 320px !important;
                font-size: 16px !important;
                padding: 16px !important;
            }
        }
    </style>

    <!-- Leaflet CSS and JS for interactive maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

    <style>
        /* Uber-inspired Design System */
        :root {
            --uber-black: #000000;
            --uber-white: #ffffff;
            --uber-gray-50: #f7f7f7;
            --uber-gray-100: #eeeeee;
            --uber-gray-200: #e5e5e5;
            --uber-gray-300: #d1d1d1;
            --uber-gray-400: #9e9e9e;
            --uber-gray-500: #757575;
            --uber-gray-600: #616161;
            --uber-gray-700: #424242;
            --uber-gray-800: #212121;
            --uber-green: #00b341;
            --uber-green-dark: #009639;
            --uber-blue: #276ef1;
            --uber-orange: #ff6b00;
            --uber-red: #e53935;
        }

        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
        }

        .uber-container {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--uber-gray-50) 0%, var(--uber-white) 100%);
        }

        .main-search-container {
            background: var(--uber-white);
            border-radius: 16px;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--uber-gray-200);
        }

        .search-input {
            border: none;
            outline: none;
            font-size: 16px;
            color: var(--uber-black);
            background: transparent;
            width: 100%;
        }

        .search-input::placeholder {
            color: var(--uber-gray-500);
        }

        .search-textarea {
            border: 1px solid var(--uber-gray-200);
            border-radius: 12px;
            outline: none;
            font-size: 16px;
            color: var(--uber-black);
            background: var(--uber-white);
            width: 100%;
            min-height: 160px;
            padding: 16px;
            resize: vertical;
            line-height: 1.6;
            box-sizing: border-box;
        }

        .search-textarea::placeholder {
            color: var(--uber-gray-500);
        }

        .search-textarea:focus {
            border-color: var(--uber-black);
            box-shadow: 0 0 0 1px var(--uber-black);
        }

        @media (max-width: 768px) {
            .search-textarea {
                min-height: 200px;
                font-size: 16px;
                padding: 16px;
            }
        }

        .service-card {
            background: var(--uber-white);
            border: 2px solid var(--uber-gray-200);
            border-radius: 16px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .service-card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            border-color: var(--uber-black);
            transform: translateY(-2px);
        }

        .service-card:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--uber-black);
            color: var(--uber-white);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary:hover {
            background: var(--uber-gray-800);
        }

        .btn-primary:disabled {
            background: var(--uber-gray-300);
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--uber-gray-100);
            color: var(--uber-black);
            border: 1px solid var(--uber-gray-200);
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: var(--uber-gray-200);
        }

        /* Enhanced Mobile Touch Targets */
        .btn-primary, .btn-secondary {
            min-height: 44px;
            min-width: 44px;
            padding: 12px 24px;
            font-size: 16px;
        }

        .service-card {
            min-height: 80px;
            padding: 20px;
            margin-bottom: 16px;
        }

        /* Enhanced service cards with better spacing and shadows */
        .service-card {
            background: var(--uber-white);
            border: 1px solid var(--uber-gray-200);
            border-radius: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .service-card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            border-color: var(--uber-blue);
            transform: translateY(-2px);
        }

        .service-card:active {
            transform: translateY(0);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        /* Focus states for accessibility */
        .service-card:focus,
        .btn-primary:focus,
        .btn-secondary:focus {
            outline: 2px solid var(--uber-blue);
            outline-offset: 2px;
        }

        /* Toast notification styles */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--uber-white);
            border-left: 4px solid var(--uber-green);
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            padding: 16px 20px;
            z-index: 1000;
            max-width: 400px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            border-left-color: var(--uber-red);
        }

        .toast.warning {
            border-left-color: var(--uber-orange);
        }

        /* Mobile-first sticky bottom bar */
        .sticky-bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--uber-white);
            border-top: 1px solid var(--uber-gray-200);
            padding: 16px 20px;
            box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.08);
            z-index: 50;
        }

        /* Loading states */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--uber-gray-200);
            border-top: 4px solid var(--uber-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 8px grid system spacing */
        .space-y-8 > * + * {
            margin-top: 32px;
        }

        .space-y-6 > * + * {
            margin-top: 24px;
        }

        .space-y-4 > * + * {
            margin-top: 16px;
        }

        .location-indicator {
            color: var(--uber-gray-600);
            font-size: 14px;
        }

        .progress-bar {
            height: 4px;
            background: var(--uber-gray-200);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--uber-black);
            transition: width 0.3s ease;
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: var(--uber-white);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        .photo-upload-area {
            border: 2px dashed var(--uber-gray-300);
            border-radius: 12px;
            background: var(--uber-gray-50);
            transition: all 0.2s ease;
        }

        .photo-upload-area:hover {
            border-color: var(--uber-blue);
            background: #f8f9ff;
        }

        .category-chip {
            background: var(--uber-gray-100);
            color: var(--uber-gray-700);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .category-chip:hover {
            background: var(--uber-gray-200);
        }

        .category-chip.active {
            background: var(--uber-black);
            color: var(--uber-white);
        }

        .floating-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--uber-gray-100);
        }

        @media (max-width: 768px) {
            .main-search-container {
                border-radius: 12px;
                margin: 16px;
            }
        }

        /* Custom animations */
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-up {
            animation: slideUp 0.3s ease;
        }

        .hide {
            display: none !important;
        }

        .show {
            display: block;
        }

        /* AI Analysis styles */
        .ai-badge {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .estimate-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            padding: 24px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--uber-gray-300);
            border-top: 2px solid var(--uber-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom Task Icon Optimization */
        .service-card img {
            object-fit: contain;
            image-rendering: auto;
            image-rendering: crisp-edges;
            image-rendering: -webkit-optimize-contrast;
        }

        /* Responsive icon sizing */
        @media (max-width: 640px) {
            .service-card .w-12 {
                width: 2.5rem !important;
                height: 2.5rem !important;
            }
            .service-card .w-6 {
                width: 1.25rem !important;
                height: 1.25rem !important;
            }
        }

        /* Smooth hover effects for icons */
        .service-card:hover img {
            transform: scale(1.05);
            transition: transform 0.2s ease-in-out;
        }

        /* Ensure icons maintain aspect ratio */
        .service-card img {
            transition: transform 0.2s ease-in-out;
        }

        /* =================================== */
        /* UBER-STYLE VISUAL IMPROVEMENTS v3.1 */
        /* =================================== */

        /* 1. Enhanced Service Cards */
        .service-card {
            border-radius: 12px !important;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
            border: 1px solid #e5e5e5;
            padding: 16px !important;
        }

        .service-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
            border-color: #000;
        }

        /* 2. Typography Hierarchy */
        h1 {
            font-weight: 800 !important;
            letter-spacing: -0.02em !important;
        }

        h2 {
            font-weight: 700 !important;
            letter-spacing: -0.01em !important;
        }

        h3 {
            font-weight: 600 !important;
        }

        button, .btn {
            font-weight: 600 !important;
            letter-spacing: 0.01em !important;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        /* 3. Color & Contrast Refinements */
        .text-gray-900 {
            color: #000 !important;
        }

        body {
            background-color: #f7f7f7 !important;
        }

        .bg-blue-600 {
            background-color: #276EF1 !important;
        }

        .bg-indigo-600 {
            background-color: #276EF1 !important;
        }

        /* 4. Enhanced Buttons */
        .btn-primary,
        .bg-blue-600,
        .bg-indigo-600,
        button[class*="bg-blue"],
        button[class*="bg-indigo"] {
            min-height: 48px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            border-radius: 8px !important;
        }

        .btn-primary:hover,
        .bg-blue-600:hover,
        .bg-indigo-600:hover,
        button[class*="bg-blue"]:hover,
        button[class*="bg-indigo"]:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.18);
        }

        /* 5. Grid Improvements */
        .grid {
            gap: 12px !important;
        }

        .grid.gap-4 {
            gap: 12px !important;
        }

        .grid.gap-6 {
            gap: 16px !important;
        }

        /* 6. Loading States */
        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }

        .loading, .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200px 100%;
            animation: shimmer 1.5s infinite;
        }

        /* 7. Enhanced Available Status */
        .text-green-700 {
            color: #15803d !important;
            font-weight: 600 !important;
        }

        /* 8. Improved Input Fields */
        input, textarea, select {
            border-radius: 8px !important;
            border: 1px solid #d1d5db !important;
            transition: all 0.2s ease !important;
        }

        input:focus, textarea:focus, select:focus {
            border-color: #276EF1 !important;
            box-shadow: 0 0 0 3px rgba(39, 110, 241, 0.1) !important;
            outline: none !important;
        }

        /* 9. Modal Improvements */
        .modal, [class*="modal"] {
            border-radius: 12px !important;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25) !important;
        }
        /* 10. Mobile Input & Textarea Optimization */
        @media (max-width: 640px) {
            /* Main search input optimization */
            #mainSearchInput {
                font-size: 16px !important; /* Prevents zoom on iOS */
                padding: 12px 16px !important;
                min-height: 48px !important; /* Touch-friendly height */
                border-radius: 8px !important;
            }

            /* All text inputs optimization - 16px prevents iOS zoom */
            input[type="text"], input[type="email"], input[type="tel"] {
                font-size: 16px !important;
                padding: 12px 16px !important;
                min-height: 48px !important;
                border-radius: 8px !important;
                box-sizing: border-box !important;
            }

            /* Service location input specific styling */
            input[placeholder*="Palm Beach"] {
                font-size: 16px !important;
                padding: 16px !important;
                min-height: 52px !important;
            }

            /* Optimize service flow for mobile */
            #serviceFlow {
                padding-bottom: 120px !important; /* Space for mobile keyboards */
            }
            #serviceDetails {
                padding-left: 16px !important;
                padding-right: 16px !important;
            }

            /* Search container mobile optimization */
            .main-search-container {
                padding: 16px !important;
            }

            .search-input {
                font-size: 16px !important;
                padding: 12px 16px !important;
                min-height: 48px !important;
            }
        }
        /* 11. iOS-specific fixes */
        @supports (-webkit-touch-callout: none) {
            #detailDescription, #mainSearchInput, input[type="text"], input[type="email"], input[type="tel"], textarea {
                transform: translateZ(0); /* Force hardware acceleration */
                -webkit-appearance: none;
                -webkit-border-radius: 8px; /* Override iOS default radius */
            }
            /* Fix iOS input field shadows */
            input, textarea {
                -webkit-box-shadow: none !important;
                box-shadow: none !important;
            }
        }

        /* 10. Floating Header Enhancement */
        .floating-header {
            backdrop-filter: blur(10px) !important;
            background-color: rgba(255, 255, 255, 0.95) !important;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05) !important;
        }

        /* 11. Mobile Optimizations */
        @media (max-width: 640px) {
            .service-card {
                padding: 12px !important;
            }

            h1 {
                font-size: 1.875rem !important;
            }

            .grid {
                gap: 8px !important;
            }
        }

        /* 12. Smooth Page Transitions */
        * {
            scroll-behavior: smooth;
        }

        .page-transition {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>

<body class="uber-container">
    <!-- Floating Header -->
    <header class="floating-header fixed top-0 left-0 right-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img src="/images/helpinghands_logo.png" alt="SendAHandyman" class="h-9 w-auto">
                    <span class="font-bold text-xl">SendAHandyman</span>
                </div>

                <nav class="hidden md:flex items-center gap-6">
                    <a href="concierge.html" class="text-gray-600 hover:text-black transition-colors">Concierge</a>
                    <a href="join-team.html" class="text-gray-600 hover:text-black transition-colors">Join Our Team</a>
                    <button onclick="showLoginModal()" class="text-gray-600 hover:text-black transition-colors">Sign In</button>
                </nav>

                <button class="md:hidden p-2" onclick="toggleMobileMenu()">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Mobile Menu -->
        <div id="mobileMenu" class="hidden md:hidden bg-white border-t border-gray-200 shadow-lg">
            <div class="px-4 py-2">
                <a href="concierge.html" class="block py-3 text-gray-600 hover:text-black transition-colors border-b border-gray-100">Concierge</a>
                <a href="join-team.html" class="block py-3 text-gray-600 hover:text-black transition-colors border-b border-gray-100">Join Our Team</a>
                <button onclick="showLoginModal()" class="block w-full text-left py-3 text-gray-600 hover:text-black transition-colors">Sign In</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pt-20">
        <!-- Landing Screen -->
        <div id="landingScreen" class="min-h-screen flex flex-col">
            <!-- Hero Section -->
            <div class="flex-1 flex flex-col justify-center px-4 py-12">
                <div class="max-w-2xl mx-auto text-center mb-8">
                    <h1 class="text-4xl md:text-6xl font-bold text-black mb-6 leading-tight">
                        What do you need help with?
                    </h1>
                    <p class="text-xl md:text-2xl text-gray-600 mb-12 font-medium">
                        Fix anything with SendAHandyman
                    </p>
                </div>

                <!-- Main Search Box -->
                <div class="max-w-2xl mx-auto w-full mb-8">
                    <div class="main-search-container p-4">
                        <div class="flex flex-col gap-3">
                            <textarea
                                class="search-textarea"
                                placeholder="Describe your repair or project..."
                                id="mainSearchInput"
                                rows="6"
                            ></textarea>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    </svg>
                                    <span class="location-indicator" id="locationIndicator">Detecting location...</span>
                                </div>
                                <button onclick="startServiceFlow()" class="btn-primary px-6 py-2">
                                    Search
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Service Categories -->
                <div class="max-w-5xl mx-auto mb-8">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
                        <div class="service-card p-6 text-center" onclick="selectService('light-plumbing')">
                            <div class="flex justify-center mb-3">
                                <img src="/images/faucet.png" alt="Light Plumbing" class="w-12 h-12">
                            </div>
                            <div class="font-semibold text-base">Light Plumbing</div>
                        </div>
                        <div class="service-card p-6 text-center" onclick="selectService('electrical')">
                            <div class="flex justify-center mb-3">
                                <img src="/images/ceiling_mounted_light_fixture.png" alt="Electrical" class="w-12 h-12">
                            </div>
                            <div class="font-semibold text-base">Electrical</div>
                        </div>
                        <div class="service-card p-6 text-center" onclick="selectService('mounting')">
                            <div class="flex justify-center mb-3">
                                <img src="/images/tv.png" alt="TV Mounting" class="w-12 h-12">
                            </div>
                            <div class="font-semibold text-base">TV Mounting</div>
                        </div>
                        <div class="service-card p-6 text-center" onclick="selectService('furniture')">
                            <div class="flex justify-center mb-3">
                                <img src="/images/furniture.png" alt="Furniture Assembly" class="w-12 h-12">
                            </div>
                            <div class="font-semibold text-base">Furniture</div>
                        </div>
                        <div class="service-card p-6 text-center" onclick="selectService('painting')">
                            <div class="flex justify-center mb-3">
                                <img src="/images/painting.png" alt="Painting" class="w-12 h-12">
                            </div>
                            <div class="font-semibold text-base">Painting</div>
                        </div>
                        <div class="service-card p-6 text-center" onclick="selectService('appliances')">
                            <div class="flex justify-center mb-3">
                                <img src="/images/appliance.png" alt="Appliances" class="w-12 h-12">
                            </div>
                            <div class="font-semibold text-base">Appliances</div>
                        </div>
                        <div class="service-card p-6 text-center" onclick="selectService('repair')">
                            <div class="flex justify-center mb-3">
                                <img src="/images/small_hole_wall.png" alt="General Repair" class="w-12 h-12">
                            </div>
                            <div class="font-semibold text-base">General Repair</div>
                        </div>
                        <div class="service-card p-6 text-center"
                             onclick="showAllServices()"
                             tabindex="0"
                             role="button"
                             aria-label="View more services"
                             onkeypress="handleEnterKey(event, showAllServices)">
                            <div class="text-4xl mb-3">‚ûï</div>
                            <div class="font-semibold text-base">More...</div>
                        </div>
                    </div>
                </div>

                <!-- Availability Indicator -->
                <div class="max-w-2xl mx-auto text-center mb-8">
                    <div class="inline-flex items-center gap-2 bg-green-100 text-green-800 px-4 py-2 rounded-full">
                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                        <span class="font-semibold text-sm" id="availabilityText">Available tomorrow onwards</span>
                    </div>
                </div>

                <!-- Map and Handyman List Section -->
                <div class="max-w-7xl mx-auto mb-12">
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <!-- Map Section -->
                        <div class="lg:col-span-3">
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                                <h3 class="font-semibold mb-4 text-gray-800">Available Handymen in Your Area</h3>

                                <!-- Map Container -->
                                <div class="relative">
                                    <div id="mainHandymanMap" class="w-full h-80 rounded-lg border border-gray-300 mb-4" style="display: none;">
                                        <!-- Leaflet map will be initialized here -->
                                    </div>
                                    <!-- Recenter Button -->
                                    <button id="recenterButton"
                                            onclick="recenterMainPageMap()"
                                            class="absolute top-3 right-3 bg-white shadow-lg hover:bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 text-sm font-medium text-gray-700 z-[1000] transition-colors"
                                            style="display: none;"
                                            title="Recenter map to your location">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                            <circle cx="12" cy="12" r="2"/>
                                        </svg>
                                    </button>
                                </div>

                                <!-- Map Loading State -->
                                <div id="mapLoadingState" class="w-full h-80 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center mb-4">
                                    <div class="text-center text-gray-500">
                                        <div class="text-4xl mb-2">üìç</div>
                                        <div class="text-sm">Detecting location...</div>
                                    </div>
                                </div>

                                <!-- Selected Handyman Details (Full Width) -->
                                <div id="compactHandymanDetails" class="bg-blue-50 border border-blue-200 rounded-lg p-4" style="display: none;">
                                    <!-- Handyman details will appear here -->
                                </div>
                            </div>
                        </div>

                        <!-- Handyman List (Right Side) -->
                        <div class="lg:col-span-1">
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 h-fit">
                                <h3 class="font-semibold mb-4 text-gray-800">Available Now</h3>

                                <!-- Handymen List -->
                                <div id="compactHandymanList" class="space-y-3" style="display: none;">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Service Selection Flow -->
        <div id="serviceFlow" class="hide min-h-screen">
            <!-- Enhanced Progress Indicator -->
            <div class="bg-white border-b border-gray-100 py-4 px-4 mb-6">
                <div class="max-w-2xl mx-auto">
                    <div id="progressStepper" class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div id="step1" class="flex items-center">
                                <div class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-sm font-semibold">1</div>
                                <span class="ml-2 text-sm font-medium text-gray-900 hidden sm:inline">Service</span>
                            </div>
                            <div class="w-8 h-0.5 bg-gray-200 mx-2 sm:mx-4" id="connector1"></div>
                        </div>
                        <div class="flex items-center">
                            <div id="step2" class="flex items-center">
                                <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center text-sm font-semibold">2</div>
                                <span class="ml-2 text-sm font-medium text-gray-500 hidden sm:inline">Time</span>
                            </div>
                            <div class="w-8 h-0.5 bg-gray-200 mx-2 sm:mx-4" id="connector2"></div>
                        </div>
                        <div class="flex items-center">
                            <div id="step3" class="flex items-center">
                                <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center text-sm font-semibold">3</div>
                                <span class="ml-2 text-sm font-medium text-gray-500 hidden sm:inline">Details</span>
                            </div>
                            <div class="w-8 h-0.5 bg-gray-200 mx-2 sm:mx-4" id="connector3"></div>
                        </div>
                        <div class="flex items-center">
                            <div id="step4" class="flex items-center">
                                <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center text-sm font-semibold">4</div>
                                <span class="ml-2 text-sm font-medium text-gray-500 hidden sm:inline">Book</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Service Details -->
            <div id="serviceDetails" class="max-w-2xl mx-auto px-4 pb-8">
                <!-- Back Button -->
                <button onclick="goBack()" class="flex items-center gap-2 mb-6 text-gray-600 hover:text-black">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                    Back
                </button>

                <div id="serviceContent">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="py-10 border-t border-gray-100 text-sm text-gray-600">
        <div class="max-w-6xl mx-auto px-4 flex flex-col md:flex-row items-center justify-between gap-3">
            <div class="flex items-center gap-2">
                <img src="/images/favicon.png" alt="SendAHandyman Logo" class="h-8 w-auto">
                <span>¬© <span id="year"></span> SendAHandyman v <span id="version">3.1.0</span></span>
            </div>
            <div class="flex items-center gap-4">
                <a href="privacy.html" class="hover:text-gray-900">Privacy</a>
                <a href="terms.html" class="hover:text-gray-900">Terms</a>
                <a href="mailto:info@sendahandyman.com" class="hover:text-gray-900">Contact</a>
                <a href="faq.html" class="hover:text-gray-900">FAQ</a>
                <button onclick="window.location.href='index-original.html'" class="hover:text-gray-900">Classic View</button>
            </div>
        </div>
    </footer>

    <!-- AI Photo Analysis Modal -->
    <div id="photoModal" class="hide fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4" onclick="closePhotoModalIfClickedOutside(event)">
        <div class="modal-content max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold">AI Photo Analysis</h3>
                    <button onclick="closePhotoModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <!-- Photo Upload Area -->
                <div id="photoUploadArea" class="photo-upload-area p-8 text-center mb-4">
                    <div id="uploadPrompt">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 16m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <h4 class="text-lg font-semibold mb-2">Upload a photo of the issue</h4>
                        <p class="text-gray-600 mb-4">Get an instant AI analysis and cost estimate</p>

                        <div class="space-y-3">
                            <button onclick="triggerCamera()" class="btn-primary w-full py-3">
                                üì∑ Take Photo
                            </button>
                            <button onclick="triggerGallery()" class="btn-secondary w-full py-3">
                                üñºÔ∏è Choose from Gallery
                            </button>
                        </div>

                        <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden" onchange="handlePhotoUpload(event)" />
                        <input type="file" id="galleryInput" accept="image/jpeg,image/jpg,image/png,image/webp,image/gif" class="hidden" onchange="handlePhotoUpload(event)" />
                        <p class="text-sm text-gray-500 mt-4">JPG, PNG, WebP, GIF ‚Ä¢ Max 3.7MB</p>
                    </div>

                    <!-- Photo Preview -->
                    <div id="photoPreview" class="hide">
                        <img id="previewImage" class="max-w-full max-h-64 mx-auto rounded-lg mb-4 object-contain" />
                        <div class="space-y-3">
                            <button id="analyzeBtn" onclick="analyzePhoto()" class="btn-primary w-full py-3">
                                <span class="ai-badge mr-2">AI</span>
                                Analyze with AI
                            </button>
                            <button onclick="retakePhoto()" class="btn-secondary w-full py-3">
                                üì∑ Take Different Photo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- AI Analysis Loading -->
                <div id="analysisLoading" class="hide text-center py-8">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="text-lg font-semibold">AI is analyzing your photo...</p>
                    <p class="text-sm text-gray-500">This may take 10-45 seconds</p>
                </div>

                <!-- AI Results -->
                <div id="analysisResults" class="hide">
                    <!-- Results will be populated here -->
                </div>

                <!-- Error Display -->
                <div id="photoError" class="hide bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-red-600 mr-3 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div>
                            <h4 class="font-semibold text-red-800">Upload Error</h4>
                            <p id="photoErrorMessage" class="text-red-700 text-sm mt-1"></p>
                        </div>
                    </div>
                    <button onclick="dismissPhotoError()" class="btn-secondary mt-3 px-4 py-2">Dismiss</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Handyman Distribution Map Modal -->
    <div id="handymanMapModal" class="hide fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4" onclick="closeHandymanMapIfClickedOutside(event)">
        <div class="modal-content max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold">Available Handymen in Your Area</h3>
                    <button onclick="closeHandymanMap()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <!-- Interactive Map Container -->
                <div class="bg-white rounded-lg border border-gray-300 mb-6">
                    <div id="handymanMapContainer" class="w-full h-96 rounded-lg overflow-hidden">
                        <!-- Leaflet map will be initialized here -->
                    </div>
                </div>

                <!-- Selected Handyman Details -->
                <div id="selectedHandymanDetails" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4" style="display: none;">
                    <!-- Handyman details will appear here when clicked -->
                </div>

                <!-- Available Handymen List -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="font-semibold mb-3">Available Handymen in Your Area</h4>
                    <div id="handymanList" class="space-y-3">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <div class="mt-6 text-center">
                    <button onclick="closeHandymanMap()" class="btn-secondary px-6 py-2">
                        Close Map
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Global variables
        let currentStep = 'landing';
        let serviceData = {};
        let currentPhoto = null;
        let supabaseClient = null;
        let isAnalyzing = false; // Prevent concurrent analysis attempts

        // Initialize Supabase - Updated to match admin/handyman database
        const SUPABASE_URL = 'https://ynbhskdiplwabsksamxa.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InluYmhza2RpcGx3YWJza3NhbXhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2OTYwMjAsImV4cCI6MjA3NTI3MjAyMH0.PedsTR4JQOioRWD28mVafR4I6wmHApUG5q2-Y7G7ljw';
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Environment validation
        console.log('üîß System Configuration:');
        console.log('üìç Database:', SUPABASE_URL.includes('ynbhskdiplwabsksamxa') ? '‚úÖ Correct (Admin DB)' : '‚ùå Wrong Database');
        console.log('üîë Supabase Key:', SUPABASE_ANON_KEY ? '‚úÖ Present' : '‚ùå Missing');
        console.log('üí≥ Stripe Key: Will be validated when payment modal loads');

        // Pricing constants (from original site)
        const RATE = 80;
        const PREMIUM_CURRENT_BLOCK = 0.30;
        const PREMIUM_NEXT_BLOCK = 0.20;
        const PREMIUM_EVENING_BLOCK = 0.35;
        const PREMIUM_SATURDAY = 0.30;
        const DISCOUNT_FUTURE = 0.10;

        // Service types with proper pricing and upcharge questions
        const TASKS = {
            'ceiling-fan': {
                hours: 2.0,
                label: "Ceiling Fan Install/Replace",
                basePrice: 160,
                questions: [
                    {
                        id: 'replacing',
                        label: 'Replacing existing fan or light?',
                        options: [
                            { value: 'fan', label: 'Yes, existing fan', addon: 0 },
                            { value: 'light', label: 'Yes, existing light fixture', addon: 0 },
                            { value: 'new', label: 'New installation', addon: 0 }
                        ]
                    },
                    {
                        id: 'fan_box',
                        label: 'Is ceiling box fan-rated?',
                        options: [
                            { value: 'yes', label: 'Yes/Don\'t know', addon: 0 },
                            { value: 'no', label: 'No, needs replacement', addon: 50 }
                        ]
                    },
                    {
                        id: 'ceiling_height',
                        label: 'Ceiling height?',
                        options: [
                            { value: 'standard', label: 'Under 10 feet', addon: 0 },
                            { value: 'high', label: 'Over 10 feet', addon: 40 }
                        ]
                    }
                ]
            },
            'light-plumbing': {
                hours: 1.5,
                label: "Light Plumbing (Faucet/Toilet)",
                basePrice: 120,
                questions: [
                    {
                        id: 'fixture_type',
                        label: 'What are you replacing?',
                        options: [
                            { value: 'faucet', label: 'Kitchen/bathroom faucet', addon: 0 },
                            { value: 'showerhead', label: 'Showerhead', addon: 0 },
                            { value: 'both', label: 'Both faucet and showerhead', addon: 0 }
                        ]
                    },
                    {
                        id: 'plumbing_issues',
                        label: 'Any plumbing issues?',
                        options: [
                            { value: 'none', label: 'No issues', addon: 0 },
                            { value: 'corrosion', label: 'Some corrosion/leaks', addon: 40 },
                            { value: 'access', label: 'Need sink removal', addon: 30 }
                        ]
                    }
                ]
            },
            'electrical': {
                hours: 1.5,
                label: "Light Electrical (Fixtures/Outlets)",
                basePrice: 120,
                questions: [
                    {
                        id: 'fixture_type',
                        label: 'Type of fixture?',
                        options: [
                            { value: 'standard', label: 'Standard light fixture', addon: 0 },
                            { value: 'small_chandelier', label: 'Chandelier (under 25 lbs)', addon: 100 },
                            { value: 'heavy_chandelier', label: 'Heavy chandelier (over 25 lbs)', addon: 200 }
                        ]
                    },
                    {
                        id: 'ceiling_height',
                        label: 'Ceiling height?',
                        options: [
                            { value: 'standard', label: 'Under 10 feet', addon: 0 },
                            { value: 'high', label: 'Over 10 feet', addon: 30 }
                        ]
                    }
                ]
            },
            'tv-mounting': {
                hours: 2.0,
                label: "TV Wall Mount (32‚Äì65\")",
                basePrice: 160,
                questions: [
                    {
                        id: 'tv_size',
                        label: 'What size is your TV?',
                        options: [
                            { value: 'standard', label: '32-65 inches', addon: 0 },
                            { value: 'large', label: 'Larger than 65 inches', addon: 50 }
                        ]
                    },
                    {
                        id: 'wall_type',
                        label: 'What type of wall?',
                        options: [
                            { value: 'drywall', label: 'Drywall with studs', addon: 0 },
                            { value: 'brick', label: 'Brick/concrete', addon: 40 },
                            { value: 'fireplace', label: 'Above fireplace', addon: 40 }
                        ]
                    },
                    {
                        id: 'mount_owned',
                        label: 'Do you have the wall mount?',
                        options: [
                            { value: 'yes', label: 'Yes, I have it', addon: 0 },
                            { value: 'no', label: 'No, need to purchase', addon: 0 }
                        ]
                    }
                ]
            },
            'furniture-assembly': {
                hours: 2.0,
                label: "Furniture Assembly (S‚ÄìM)",
                basePrice: 160,
                questions: [
                    {
                        id: 'furniture_type',
                        label: 'What type of furniture?',
                        options: [
                            { value: 'standard', label: 'Dresser/desk/table', addon: 0 },
                            { value: 'bed', label: 'Bed frame', addon: 30 },
                            { value: 'wardrobe', label: 'Large wardrobe', addon: 30 },
                            { value: 'multiple', label: 'Multiple small items', addon: 0 }
                        ]
                    },
                    {
                        id: 'quantity',
                        label: 'How many items?',
                        options: [
                            { value: 'single', label: '1 major item', addon: 0 },
                            { value: 'few', label: '2-3 small items', addon: 0 },
                            { value: 'many', label: '4+ items', addon: 40 }
                        ]
                    }
                ]
            },
            'painting': {
                hours: 2.5,
                label: "Small Painting Project",
                basePrice: 200,
                questions: []
            },
            'general-repair': {
                hours: 3.0,
                label: "General Handyman (3+ hours)",
                basePrice: 240,
                questions: [
                    {
                        id: 'task_complexity',
                        label: 'What type of tasks do you need done?',
                        options: [
                            { value: 'basic', label: 'Basic repairs, adjustments, or maintenance', addon: 0 },
                            { value: 'multiple', label: 'Multiple small tasks or repairs', addon: 0 },
                            { value: 'complex', label: 'More complex projects requiring planning', addon: 0 }
                        ]
                    },
                    {
                        id: 'additional_time',
                        label: 'Do you need additional time beyond 3 hours?',
                        options: [
                            { value: 'none', label: 'No, 3 hours should be sufficient', addon: 0 },
                            { value: 'one_block', label: 'Yes, add 3 more hours', addon: 180 },
                            { value: 'two_blocks', label: 'Yes, add 6 more hours', addon: 360 }
                        ]
                    },
                    {
                        id: 'materials_needed',
                        label: 'Will materials or parts be needed?',
                        options: [
                            { value: 'customer_supplies', label: 'I will provide all materials', addon: 0 },
                            { value: 'basic_supplies', label: 'May need basic supplies (screws, caulk, etc.)', addon: 0 },
                            { value: 'unsure', label: 'Not sure what will be needed', addon: 0 }
                        ]
                    }
                ]
            },
            'blinds': {
                hours: 1.5,
                label: "Curtain Rod/Blinds Mount",
                basePrice: 120,
                questions: [
                    {
                        id: 'item_count',
                        label: 'How many rods/blinds?',
                        type: 'quantity',
                        options: [
                            { value: '1', label: '1 item', price: 80, hours: 1.0 },
                            { value: '2', label: '2 items', price: 120, hours: 1.5 },
                            { value: '3', label: '3 items', price: 160, hours: 2.0 },
                            { value: '4+', label: '4+ items', price: 200, hours: 2.5 }
                        ]
                    },
                    {
                        id: 'wall_type',
                        label: 'What type of wall?',
                        options: [
                            { value: 'drywall', label: 'Drywall', addon: 0 },
                            { value: 'masonry', label: 'Brick/tile/concrete', addon: 40 }
                        ]
                    }
                ]
            },
            'smart-doorbell': {
                hours: 1.25,
                label: "Smart Doorbell Install",
                basePrice: 100,
                questions: [
                    {
                        id: 'install_type',
                        label: 'Installation type?',
                        options: [
                            { value: 'replace', label: 'Replacing existing doorbell', addon: 0 },
                            { value: 'wireless', label: 'New wireless install', addon: 30 }
                        ]
                    },
                    {
                        id: 'chime_status',
                        label: 'Current doorbell chime working?',
                        options: [
                            { value: 'working', label: 'Yes, works fine', addon: 0 },
                            { value: 'broken', label: 'No/needs replacement', addon: 40 },
                            { value: 'no_chime', label: 'Don\'t want chime connected', addon: 0 }
                        ]
                    }
                ]
            },
            'floating-shelf': {
                hours: 1.0,
                label: "Floating Shelf Install",
                basePrice: 80,
                questions: [
                    {
                        id: 'shelf_count',
                        label: 'How many shelves?',
                        type: 'quantity',
                        options: [
                            { value: '1', label: '1 shelf', price: 80, hours: 1.0 },
                            { value: '2', label: '2 shelves', price: 120, hours: 1.5 },
                            { value: '3', label: '3 shelves', price: 160, hours: 2.0 },
                            { value: '4+', label: '4+ shelves', price: 200, hours: 2.5 }
                        ]
                    },
                    {
                        id: 'weight',
                        label: 'Shelf weight/size?',
                        options: [
                            { value: 'standard', label: 'Standard (under 25 lbs)', addon: 0 },
                            { value: 'heavy', label: 'Heavy-duty (over 25 lbs)', addon: 30 }
                        ]
                    }
                ]
            },
            'appliance-hookup': {
                hours: 2.0,
                label: "Appliance Hookup (W/D/DW)",
                basePrice: 160,
                questions: [
                    {
                        id: 'appliance_type',
                        label: 'What appliance?',
                        options: [
                            { value: 'washer', label: 'Washer', addon: 0 },
                            { value: 'dryer', label: 'Dryer', addon: 0 },
                            { value: 'dishwasher', label: 'Dishwasher', addon: 0 },
                            { value: 'multiple', label: 'Multiple appliances', addon: 0 }
                        ]
                    },
                    {
                        id: 'old_removal',
                        label: 'Replacing an old unit?',
                        options: [
                            { value: 'remove', label: 'Yes, remove old', addon: 40 },
                            { value: 'new', label: 'No, new installation', addon: 0 },
                            { value: 'disconnect', label: 'Just disconnecting old', addon: 0 }
                        ]
                    },
                    {
                        id: 'hookups_ready',
                        label: 'Are hookups ready?',
                        options: [
                            { value: 'ready', label: 'Yes, all connections ready', addon: 0 },
                            { value: 'new_line', label: 'Need new vent/line', addon: 30 },
                            { value: 'unsure', label: 'Not sure', addon: 0 }
                        ]
                    }
                ]
            },
            'closet-organizer': {
                hours: 2.5,
                label: "Closet Organizer Install",
                basePrice: 200,
                questions: [
                    {
                        id: 'organizer_type',
                        label: 'Type of organizer?',
                        options: [
                            { value: 'standard', label: 'Shelves and rods', addon: 0 },
                            { value: 'modular', label: 'Modular cube system', addon: 0 },
                            { value: 'wire', label: 'Wire rack system', addon: 0 },
                            { value: 'custom', label: 'Custom wood system', addon: 0 }
                        ]
                    },
                    {
                        id: 'custom_fitting',
                        label: 'Need custom cutting?',
                        options: [
                            { value: 'no', label: 'No, standard sizes', addon: 0 },
                            { value: 'yes', label: 'Yes, custom fitting', addon: 50 },
                            { value: 'unsure', label: 'Not sure', addon: 0 }
                        ]
                    },
                    {
                        id: 'wall_type',
                        label: 'What type of wall?',
                        options: [
                            { value: 'drywall', label: 'Standard drywall', addon: 0 },
                            { value: 'masonry', label: 'Concrete/masonry', addon: 40 },
                            { value: 'unsure', label: 'Not sure', addon: 0 }
                        ]
                    }
                ]
            },
            'premium-moveout': {
                hours: 3.0,
                label: "Premium Move-out Repairs",
                basePrice: 240,
                questions: [
                    {
                        id: 'property_size',
                        label: 'What size is the property?',
                        options: [
                            { value: 'studio', label: 'Studio/1 Bedroom', addon: 0 },
                            { value: '2br', label: '2 Bedroom', addon: 80 },
                            { value: '3br', label: '3 Bedroom', addon: 160 },
                            { value: '4br', label: '4+ Bedroom', addon: 240 }
                        ]
                    },
                    {
                        id: 'damage_level',
                        label: 'How much damage needs repair?',
                        options: [
                            { value: 'light', label: 'Light (few nail holes, minor touch-ups)', addon: 0 },
                            { value: 'moderate', label: 'Moderate (multiple holes, some paint)', addon: 50 },
                            { value: 'heavy', label: 'Heavy (major repairs, extensive work)', addon: 120 }
                        ]
                    },
                    {
                        id: 'additional_services',
                        label: 'Any additional services needed?',
                        options: [
                            { value: 'none', label: 'None needed', addon: 0 },
                            { value: 'carpet_clean', label: 'Carpet cleaning and deodorizing', addon: 50 },
                            { value: 'full_paint', label: 'Full room repainting', addon: 75 },
                            { value: 'kitchen_deep', label: 'Kitchen appliance deep clean', addon: 40 },
                            { value: 'bathroom_restore', label: 'Bathroom tile & grout restoration', addon: 35 },
                            { value: 'floor_refinish', label: 'Hardwood floor refinishing', addon: 60 },
                            { value: 'window_clean', label: 'Window cleaning (interior/exterior)', addon: 25 }
                        ]
                    },
                    {
                        id: 'timeline',
                        label: 'When do you need this completed?',
                        options: [
                            { value: 'flexible', label: 'Flexible timing', addon: 0 },
                            { value: 'soon', label: 'Within 1-2 weeks', addon: 0 },
                            { value: 'urgent', label: 'ASAP (rush job)', addon: 50 }
                        ]
                    }
                ]
            }
        };

        // Detection patterns for auto-detecting answers from description text
        const DETECTION_PATTERNS = {
            'tv-mounting': {
                'tv_size': [
                    { value: 'large', patterns: [/\b(6[6-9]|[7-9]\d|\d{3})\s*(inch|in|"|\'\')/i, /\blarge\s*tv/i, /\bhuge\s*tv/i, /\bbig\s*tv/i] }
                ],
                'wall_type': [
                    { value: 'brick', patterns: [/\bbrick/i, /\bconcrete/i, /\bmasonry/i, /\bstone\s*wall/i] },
                    { value: 'fireplace', patterns: [/\bfireplace/i, /\babove\s*(the\s*)?fire/i, /\bover\s*(the\s*)?fireplace/i, /\bmantle/i] }
                ],
                'mount_owned': [
                    { value: 'yes', patterns: [/\bhave\s*(a\s*|the\s*)?mount/i, /\bown\s*mount/i, /\bmount\s*already/i, /\bgot\s*(a\s*)?mount/i] },
                    { value: 'no', patterns: [/\bneed\s*(a\s*|to\s*buy\s*)?mount/i, /\bno\s*mount/i, /\bdon'?t\s*have\s*(a\s*)?mount/i] }
                ]
            },
            'electrical': {
                'fixture_type': [
                    { value: 'heavy_chandelier', patterns: [/\bheavy\s*chandelier/i, /\blarge\s*chandelier/i, /\bbig\s*chandelier/i] },
                    { value: 'small_chandelier', patterns: [/\bchandelier/i, /\bpendant\s*light/i] }
                ],
                'ceiling_height': [
                    { value: 'high', patterns: [/\bhigh\s*ceiling/i, /\btall\s*ceiling/i, /\bvaulted/i, /\b(1[0-9]|2\d)\s*(ft|feet|foot|')/i, /\btwo\s*stor(y|ies)/i] }
                ]
            },
            'light-plumbing': {
                'fixture_type': [
                    { value: 'faucet', patterns: [/\bfaucet/i, /\bsink\s*tap/i, /\bkitchen\s*sink/i, /\bbathroom\s*sink/i] },
                    { value: 'showerhead', patterns: [/\bshower\s*head/i, /\bshowerhead/i] },
                    { value: 'both', patterns: [/\bfaucet.*shower/i, /\bshower.*faucet/i, /\bboth/i] }
                ],
                'plumbing_issues': [
                    { value: 'corrosion', patterns: [/\bcorrod/i, /\bcorrosion/i, /\brust/i, /\brusty/i, /\bleak/i, /\bleaking/i, /\bold\s*pipes/i] },
                    { value: 'access', patterns: [/\bremove\s*(the\s*)?sink/i, /\bsink\s*removal/i, /\bhard\s*to\s*(access|reach)/i] }
                ]
            },
            'ceiling-fan': {
                'replacing': [
                    { value: 'fan', patterns: [/\breplace.*fan/i, /\bexisting\s*fan/i, /\bold\s*fan/i, /\bremove.*fan/i] },
                    { value: 'light', patterns: [/\breplace.*light/i, /\bexisting\s*light/i, /\bconvert.*light/i] },
                    { value: 'new', patterns: [/\bnew\s*install/i, /\bfirst\s*time/i, /\bno\s*existing/i] }
                ],
                'ceiling_height': [
                    { value: 'high', patterns: [/\bhigh\s*ceiling/i, /\btall\s*ceiling/i, /\bvaulted/i, /\b(1[0-9]|2\d)\s*(ft|feet|foot|')/i] }
                ]
            },
            'furniture-assembly': {
                'furniture_type': [
                    { value: 'bed', patterns: [/\bbed\s*frame/i, /\bbed\b/i, /\bheadboard/i, /\bfootboard/i] },
                    { value: 'wardrobe', patterns: [/\bwardrobe/i, /\barmoire/i, /\blarge\s*closet/i, /\bpax/i] },
                    { value: 'multiple', patterns: [/\bmultiple/i, /\bseveral/i, /\bfew\s*items/i] }
                ],
                'quantity': [
                    { value: 'many', patterns: [/\b([4-9]|\d{2,})\s*(item|piece|thing)/i, /\bmany\s*items/i, /\bmultiple\s*items/i, /\bseveral\s*items/i] },
                    { value: 'few', patterns: [/\b[2-3]\s*(item|piece|thing)/i, /\bcouple/i, /\bfew/i] }
                ]
            },
            'general-repair': {
                'additional_time': [
                    { value: 'two_blocks', patterns: [/\bfull\s*day/i, /\ball\s*day/i, /\b([6-9]|\d{2,})\s*hour/i] },
                    { value: 'one_block', patterns: [/\bhalf\s*day/i, /\b[4-6]\s*hour/i, /\bextra\s*time/i] }
                ],
                'task_complexity': [
                    { value: 'multiple', patterns: [/\bmultiple\s*(repair|task|thing|job)/i, /\bseveral\s*(repair|task|thing|job)/i, /\blist\s*of/i] },
                    { value: 'complex', patterns: [/\bcomplex/i, /\bcomplicated/i, /\bdifficult/i, /\bmajor/i] }
                ]
            },
            'blinds': {
                'item_count': [
                    { value: '4+', patterns: [/\b([4-9]|\d{2,})\s*(blind|curtain|rod|window)/i, /\bmany\s*(blind|window)/i, /\ball\s*(the\s*)?(blind|window)/i] },
                    { value: '3', patterns: [/\b3\s*(blind|curtain|rod|window)/i, /\bthree\s*(blind|curtain|rod|window)/i] },
                    { value: '2', patterns: [/\b2\s*(blind|curtain|rod|window)/i, /\btwo\s*(blind|curtain|rod|window)/i, /\bcouple/i] }
                ],
                'wall_type': [
                    { value: 'masonry', patterns: [/\bbrick/i, /\bconcrete/i, /\btile/i, /\bmasonry/i, /\bstone/i] }
                ]
            },
            'smart-doorbell': {
                'install_type': [
                    { value: 'replace', patterns: [/\breplace/i, /\bexisting\s*doorbell/i, /\bupgrade/i, /\bold\s*doorbell/i] },
                    { value: 'wireless', patterns: [/\bnew\s*install/i, /\bno\s*doorbell/i, /\bfirst\s*time/i, /\bwireless/i, /\bbattery/i] }
                ],
                'chime_status': [
                    { value: 'broken', patterns: [/\bchime.*broken/i, /\bchime.*not\s*work/i, /\bno\s*chime/i, /\bbroken\s*chime/i, /\bneed.*chime/i] }
                ]
            },
            'floating-shelf': {
                'shelf_count': [
                    { value: '4+', patterns: [/\b([4-9]|\d{2,})\s*shel(f|ves)/i, /\bmany\s*shel(f|ves)/i, /\bmultiple\s*shel(f|ves)/i] },
                    { value: '3', patterns: [/\b3\s*shel(f|ves)/i, /\bthree\s*shel(f|ves)/i] },
                    { value: '2', patterns: [/\b2\s*shel(f|ves)/i, /\btwo\s*shel(f|ves)/i] }
                ],
                'weight': [
                    { value: 'heavy', patterns: [/\bheavy/i, /\bbooks/i, /\blarge\s*items/i, /\bbig\s*items/i, /\bsturdy/i] }
                ]
            },
            'appliance-hookup': {
                'appliance_type': [
                    { value: 'washer', patterns: [/\bwash(er|ing)\s*machine/i, /\bwasher\b/i] },
                    { value: 'dryer', patterns: [/\bdryer/i, /\bdrying\s*machine/i] },
                    { value: 'dishwasher', patterns: [/\bdishwasher/i, /\bdish\s*washer/i] },
                    { value: 'multiple', patterns: [/\bwasher.*dryer/i, /\bdryer.*washer/i, /\bboth/i, /\bmultiple/i] }
                ],
                'old_removal': [
                    { value: 'remove', patterns: [/\bremove\s*(old|existing)/i, /\breplace/i, /\bhaul\s*away/i, /\btake\s*away/i, /\bdispose/i] }
                ],
                'hookups_ready': [
                    { value: 'new_line', patterns: [/\bneed.*hookup/i, /\bno\s*hookup/i, /\bnew\s*connection/i, /\bnew\s*line/i, /\bno\s*vent/i] }
                ]
            },
            'closet-organizer': {
                'organizer_type': [
                    { value: 'wire', patterns: [/\bwire\s*(rack|system|organizer)/i, /\bmetal\s*rack/i] },
                    { value: 'custom', patterns: [/\bcustom/i, /\bwood/i, /\bwooden/i, /\bbuilt-?in/i] },
                    { value: 'modular', patterns: [/\bmodular/i, /\bcube/i, /\bikea/i] }
                ],
                'custom_fitting': [
                    { value: 'yes', patterns: [/\bcustom\s*(cut|fit|size)/i, /\bodd\s*size/i, /\birregular/i, /\bnot\s*standard/i] }
                ],
                'wall_type': [
                    { value: 'masonry', patterns: [/\bbrick/i, /\bconcrete/i, /\bmasonry/i, /\bstone/i] }
                ]
            },
            'premium-moveout': {
                'property_size': [
                    { value: '4br', patterns: [/\b(4|5|6)\s*(br|bed|bedroom)/i, /\bfour\s*bed/i, /\blarge\s*(house|home|property)/i] },
                    { value: '3br', patterns: [/\b3\s*(br|bed|bedroom)/i, /\bthree\s*bed/i] },
                    { value: '2br', patterns: [/\b2\s*(br|bed|bedroom)/i, /\btwo\s*bed/i] },
                    { value: 'studio', patterns: [/\bstudio/i, /\b1\s*(br|bed|bedroom)/i, /\bone\s*bed/i] }
                ],
                'damage_level': [
                    { value: 'heavy', patterns: [/\bheavy\s*damage/i, /\blots?\s*of\s*(damage|holes|repairs)/i, /\bmajor\s*damage/i, /\bextensive/i, /\bsevere/i] },
                    { value: 'moderate', patterns: [/\bmoderate/i, /\bsome\s*damage/i, /\bseveral\s*holes/i, /\bmultiple\s*holes/i] }
                ],
                'timeline': [
                    { value: 'urgent', patterns: [/\burgent/i, /\brush/i, /\basap/i, /\bimmediately/i, /\btomorrow/i, /\bthis\s*week/i, /\bquick(ly)?/i] }
                ]
            }
        };

        // Auto-detect answers from description text
        function autoDetectAnswers(taskKey, description) {
            if (!description || !DETECTION_PATTERNS[taskKey]) return {};

            const detected = {};
            const patterns = DETECTION_PATTERNS[taskKey];
            const text = description.toLowerCase();

            for (const [questionId, options] of Object.entries(patterns)) {
                for (const option of options) {
                    for (const pattern of option.patterns) {
                        if (pattern.test(description)) {
                            detected[questionId] = option.value;
                            console.log(`üîç Auto-detected: ${questionId} = ${option.value} (matched: ${pattern})`);
                            break;
                        }
                    }
                    if (detected[questionId]) break; // Stop checking other options for this question
                }
            }

            return detected;
        }

        // Pricing calculation function (matching original site logic)
        function calculatePricing(hours, window = 'tomorrow_am', rush = false, addons = 0, selectedDate = null) {
            console.log('üí∞ calculatePricing called:', { hours, window, rush, addons, selectedDate });
            const base = hours * RATE;
            let premiums = [];
            let total = base + addons;
            const isToday = window.startsWith('today');
            const isTomorrow = window.startsWith('tomorrow');
            const isMonday = window.startsWith('monday');
            const isFuture = selectedDate !== null;
            const isEveningBlock = window.includes('eve');
            const now = new Date();
            let bookingDate;

            if (isFuture && selectedDate) {
                bookingDate = new Date(selectedDate + 'T00:00:00');
            } else if (isToday) {
                bookingDate = now;
            } else if (isTomorrow) {
                bookingDate = new Date(now);
                bookingDate.setDate(bookingDate.getDate() + 1);
            } else if (isMonday) {
                bookingDate = new Date(now);
                bookingDate.setDate(bookingDate.getDate() + 2); // Skip Sunday
            }

            // Evening block premium
            if (isEveningBlock) {
                total *= (1 + PREMIUM_EVENING_BLOCK);
                premiums.push({ label: 'Evening', amount: Math.round(base * PREMIUM_EVENING_BLOCK) });
            }

            // Next-day premium for tomorrow
            if (isTomorrow || window.includes('day1_') || window.includes('day2_')) {
                total *= (1 + PREMIUM_NEXT_BLOCK);
                premiums.push({ label: 'Next Day', amount: Math.round(base * PREMIUM_NEXT_BLOCK) });
            }

            // Saturday premium
            if (bookingDate && isSaturday(bookingDate)) {
                total *= (1 + PREMIUM_SATURDAY);
                premiums.push({ label: 'Saturday', amount: Math.round(base * PREMIUM_SATURDAY) });
            }

            // Future booking discount (3+ days out)
            if (isFuture && selectedDate) {
                const daysDiff = Math.floor((bookingDate - now) / (1000 * 60 * 60 * 24));
                if (daysDiff >= 3) {
                    total *= (1 - DISCOUNT_FUTURE);
                    premiums.push({ label: 'Future Discount', amount: -Math.round(base * DISCOUNT_FUTURE) });
                }
            }

            console.log('üí∞ Pricing result:', {
                base: base,
                total: Math.round(total),
                premiums: premiums,
                finalCalculation: `${base} base + premiums = ${Math.round(total)}`
            });

            return {
                base: base,
                total: Math.round(total),
                premiums: premiums,
                hours: hours
            };
        }

        function updatePricingDisplay(category) {
            const mappedKey = getCategoryTaskKey(category);
            if (!mappedKey || !TASKS[mappedKey]) return;

            const task = TASKS[mappedKey];
            const basePricing = calculatePricing(task.hours, 'tomorrow_am');
            const eveningPricing = calculatePricing(task.hours, 'tomorrow_eve');

            // Update main price display
            const priceDisplay = document.getElementById('servicePriceDisplay');
            if (priceDisplay) {
                priceDisplay.textContent = `$${task.basePrice}`;
            }

            // Update tomorrow pricing (Standard Service should show base price, not premium price)
            const tomorrowDisplay = document.getElementById('tomorrowPricing');
            if (tomorrowDisplay) {
                tomorrowDisplay.textContent = `$${task.basePrice}`;
            }

            // Update premium pricing (evening)
            const premiumDisplay = document.getElementById('premiumPricing');
            if (premiumDisplay) {
                premiumDisplay.textContent = `$${eveningPricing.total}`;
            }
        }

        // Availability text update function
        function updateAvailabilityText() {
            console.log('üìÖ updateAvailabilityText called');
            const now = new Date();
            const today = now.getDay(); // 0=Sunday, 6=Saturday

            const availabilityElement = document.getElementById('availabilityText');
            const scheduleElement = document.getElementById('scheduleEarliestDay');

            console.log('üìÖ Elements found:', {
                availability: !!availabilityElement,
                schedule: !!scheduleElement,
                todayIs: today === 0 ? 'Sunday' : today === 6 ? 'Saturday' : 'Weekday'
            });

            if (today === 0) {
                // If today is Sunday, earliest available is Tuesday (skip Monday business day rule)
                console.log('üìÖ Today is Sunday, earliest available is Tuesday');
                if (availabilityElement) {
                    availabilityElement.textContent = 'Available Tuesday onwards';
                }
                if (scheduleElement) {
                    scheduleElement.textContent = 'Tuesday';
                }
            } else if (today === 6) {
                // If today is Saturday, earliest available is Monday (skip Sunday)
                console.log('üìÖ Today is Saturday, earliest available is Monday');
                if (availabilityElement) {
                    availabilityElement.textContent = 'Available Monday onwards';
                }
                if (scheduleElement) {
                    scheduleElement.textContent = 'Monday';
                }
            } else {
                // Normal weekday case
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);

                if (isSunday(tomorrow)) {
                    console.log('üìÖ Tomorrow is Sunday, earliest available is Monday');
                    if (availabilityElement) {
                        availabilityElement.textContent = 'Available Monday onwards';
                    }
                    if (scheduleElement) {
                        scheduleElement.textContent = 'Monday';
                    }
                } else {
                    console.log('üìÖ Normal case, earliest available is tomorrow');
                    if (availabilityElement) {
                        availabilityElement.textContent = 'Available tomorrow onwards';
                    }
                    if (scheduleElement) {
                        scheduleElement.textContent = 'Tomorrow';
                    }
                }
            }
        }

        // Navigation functions
        function handleSearchKeyPress(event) {
            if (event.key === 'Enter') {
                startServiceFlow();
            }
        }

        function startServiceFlow() {
            const searchInput = document.getElementById('mainSearchInput').value;
            if (searchInput.trim()) {
                serviceData.description = searchInput.trim();

                // Auto-detect category from description if not already set
                if (!serviceData.category) {
                    const detectedCategory = detectCategoryFromDescription(searchInput);
                    if (detectedCategory) {
                        serviceData.category = detectedCategory;
                        serviceData.taskKey = getCategoryTaskKey(detectedCategory);
                        serviceData.categoryDisplay = getCategoryDisplay(detectedCategory);
                        console.log('üéØ Auto-detected category from description:', detectedCategory, '‚Üí taskKey:', serviceData.taskKey);
                    }
                }

                // Track search started
                HandymanAnalytics.trackSearchStarted(searchInput.trim());

                showServiceDetails();
            }
        }

        // Detect service category from description text
        function detectCategoryFromDescription(description) {
            const text = description.toLowerCase();

            const categoryPatterns = [
                // TV Mounting - check first since it's specific
                { category: 'mounting', patterns: [/\btv\b/, /\btelevision/, /\bmount.*tv/i, /\btv.*mount/i, /\bwall\s*hang.*tv/i, /\bflat\s*screen/, /\binch.*tv/i, /\btv.*inch/i] },
                // Ceiling Fan - check before electrical
                { category: 'ceiling-fan', patterns: [/\bceiling\s*fan/, /\bfan\s*install/, /\binstall.*fan/] },
                // Electrical
                { category: 'electrical', patterns: [/\belectric/, /\boutlet/, /\bswitch/, /\blight\s*fixture/, /\bchandelier/, /\bwiring/, /\bceiling\s*light/] },
                // Plumbing
                { category: 'light-plumbing', patterns: [/\bplumb/, /\bfaucet/, /\btoilet/, /\bsink/, /\bleak/, /\bdrain/, /\bshower\s*head/, /\bgarbage\s*disposal/] },
                // Furniture Assembly
                { category: 'furniture', patterns: [/\bfurniture/, /\bassembl/, /\bikea/, /\bbed\s*frame/, /\bdresser/, /\bwardrobe/, /\bdesk\b/, /\bbookshelf/, /\btable\b/] },
                // Painting
                { category: 'painting', patterns: [/\bpaint/, /\btouch\s*up/, /\bwall\s*color/] },
                // Appliances
                { category: 'appliances', patterns: [/\bwasher/, /\bdryer/, /\bdishwasher/, /\bappliance/, /\brefrigerator/, /\bfridge/, /\boven\b/, /\bstove/] },
                // Smart Doorbell
                { category: 'smart-doorbell', patterns: [/\bdoorbell/, /\bring\b/, /\bnest\b.*door/] },
                // Blinds/Curtains
                { category: 'curtains-blinds', patterns: [/\bblind/, /\bcurtain/, /\bshade/, /\bdrape/, /\bwindow\s*(cover|treat)/] },
                // Floating Shelf / Installation
                { category: 'installation', patterns: [/\bshelf/, /\bshelves/, /\bfloating/, /\bwall\s*mount(?!.*tv)/] },
                // Closet
                { category: 'closet-organizer', patterns: [/\bcloset/, /\borganizer/, /\bstorage\s*system/] },
                // Move-out
                { category: 'premium-moveout', patterns: [/\bmove\s*out/, /\bmoveout/, /\bmove-out/, /\bsecurity\s*deposit/, /\bapartment\s*repair/] },
                // General Repair (catch-all for repair-related terms)
                { category: 'repair', patterns: [/\brepair/, /\bfix\b/, /\bbroken/, /\bdamage/, /\bdoor\b/, /\bwindow\b/, /\bdrywall/, /\bhole/, /\bpatch/] }
            ];

            for (const { category, patterns } of categoryPatterns) {
                for (const pattern of patterns) {
                    if (pattern.test(text)) {
                        console.log(`üîç Category "${category}" detected by pattern: ${pattern}`);
                        return category;
                    }
                }
            }

            // Default to general repair if no specific match
            console.log('üîç No specific category detected, defaulting to repair');
            return 'repair';
        }

        // Map UI category names to TASKS object keys
        function getCategoryTaskKey(category) {
            const mapping = {
                'mounting': 'tv-mounting',
                'furniture': 'furniture-assembly',
                'repair': 'general-repair',
                'appliances': 'appliance-hookup',
                'curtains-blinds': 'blinds',
                'installation': 'floating-shelf',
                'outdoor': 'general-repair',
                'other': 'general-repair',
                // Direct matches (no mapping needed)
                'light-plumbing': 'light-plumbing',
                'electrical': 'electrical',
                'painting': 'painting',
                'ceiling-fan': 'ceiling-fan',
                'tv-mounting': 'tv-mounting',
                'furniture-assembly': 'furniture-assembly',
                'general-repair': 'general-repair',
                'blinds': 'blinds',
                'smart-doorbell': 'smart-doorbell',
                'floating-shelf': 'floating-shelf',
                'appliance-hookup': 'appliance-hookup',
                'closet-organizer': 'closet-organizer',
                'premium-moveout': 'premium-moveout'
            };
            return mapping[category] || category;
        }

        function selectService(category) {
            serviceData.category = category;
            serviceData.taskKey = getCategoryTaskKey(category); // Store mapped task key
            serviceData.categoryDisplay = getCategoryDisplay(category);

            // Track service selection
            HandymanAnalytics.trackServiceSelected(category);

            // Update pricing displays based on selected service
            updatePricingDisplay(category);

            showServiceDetails();

            // Update textarea placeholder if it exists
            const textarea = document.getElementById('detailDescription');
            if (textarea) {
                textarea.placeholder = getDescriptionPlaceholder(category);
            }
        }

        function getCategoryDisplay(category) {
            const categories = {
                'light-plumbing': '<img src="/images/faucet.png" alt="Light Plumbing" class="inline w-6 h-6"> Light Plumbing',
                'electrical': '<img src="/images/ceiling_mounted_light_fixture.png" alt="Electrical" class="inline w-6 h-6"> Electrical',
                'mounting': '<img src="/images/tv.png" alt="TV Mounting" class="inline w-6 h-6"> TV Mounting',
                'furniture': '<img src="/images/furniture.png" alt="Furniture Assembly" class="inline w-6 h-6"> Furniture Assembly',
                'painting': '<img src="/images/painting.png" alt="Painting" class="inline w-6 h-6"> Painting',
                'appliances': '<img src="/images/appliance.png" alt="Appliances" class="inline w-6 h-6"> Appliances',
                'repair': '<img src="/images/small_hole_wall.png" alt="General Repair" class="inline w-6 h-6"> General Repair',
                'ceiling-fan': '<img src="/images/ceiling_fan.png" alt="Ceiling Fan" class="inline w-6 h-6"> Ceiling Fan',
                'curtains-blinds': '<img src="/images/window_blinds.png" alt="Curtain Rods / Blinds" class="inline w-6 h-6"> Curtain Rods / Blinds',
                'installation': '<img src="/images/wall_shelf.png" alt="Installations" class="inline w-6 h-6"> Installations',
                'outdoor': '<img src="/images/outdoor.png" alt="Outdoor" class="inline w-6 h-6"> Outdoor',
                'other': '<img src="/images/question_mark.png" alt="Other" class="inline w-6 h-6"> Other'
            };
            return categories[category] || category;
        }

        function getDescriptionPlaceholder(category) {
            const placeholders = {
                'light-plumbing': 'Kitchen sink is dripping under the counter...',
                'electrical': 'Need to install a new outlet in the bedroom wall...',
                'mounting': 'Want to mount 55" TV above the fireplace...',
                'furniture': 'IKEA dresser needs assembly, have all parts...',
                'painting': 'Touch up paint needed on bedroom walls...',
                'appliances': 'Dishwasher not draining properly...',
                'repair': 'Squeaky door hinge needs fixing...',
                'ceiling-fan': 'Install new ceiling fan in living room, existing wiring available...',
                'curtains-blinds': 'Mount curtain rods above bedroom windows...',
                'installation': 'Need help installing bathroom towel rack...',
                'outdoor': 'Patio fence post is loose and wobbly...',
                'other': 'Describe your repair or project...'
            };
            return placeholders[category] || 'Describe your repair or project...';
        }

        function showServiceDetails() {
            document.getElementById('landingScreen').classList.add('hide');
            document.getElementById('serviceFlow').classList.remove('hide');
            currentStep = 'details';
            renderServiceDetails();
        }

        function renderServiceDetails() {
            const content = document.getElementById('serviceContent');
            content.innerHTML = `
                <div class="slide-up">
                    <h2 class="text-2xl font-bold mb-2">${serviceData.categoryDisplay || 'Service Request'}</h2>
                    <p class="text-gray-600 mb-6">Tell us more about what you need help with</p>

                    <div class="space-y-6">
                        <!-- Service-specific questions (upcharges) -->
                        <div id="taskQuestions" class="hidden">
                            <div id="questionsContainer" class="space-y-4"></div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2">Describe the issue or project</label>
                            <div class="relative">
                                <textarea
                                    id="detailDescription"
                                    class="w-full border border-gray-300 rounded-lg resize-none mobile-textarea-force"
                                    placeholder="${getDescriptionPlaceholder(serviceData.category)}"
                                    onchange="updateServiceData('detailedDescription', this.value)"
                                    oninput="autoResizeTextarea(); updateServiceData('detailedDescription', this.value); updateCharacterCount(); debounceAutoDetect()"
                                >${serviceData.description || ''}</textarea>
                                <div id="characterCount" class="absolute bottom-2 right-2 text-xs text-gray-500 bg-white px-2 py-1 rounded hidden md:block">
                                    <span id="charCount">0</span> characters
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2">Add photos for better estimates</label>
                            <button onclick="showPhotoModal()" class="w-full btn-secondary py-4 border-2 border-dashed">
                                <div class="flex items-center justify-center gap-2">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                    <span class="ai-badge mr-2">AI</span>
                                    Add Photos for AI Analysis
                                </div>
                            </button>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2">Service location</label>
                            <input
                                type="text"
                                class="w-full border border-gray-300 rounded-lg p-3"
                                placeholder="123 Main St, Palm Beach, FL"
                                onchange="updateServiceData('location', this.value)"
                            />
                        </div>

                        <div class="pt-4">
                            <button onclick="proceedToScheduling()" class="btn-primary w-full py-4 text-lg">
                                Continue to Scheduling
                            </button>
                        </div>
                    </div>
                </div>
            `;
            updateProgress(2); // Step 2: Details

            // Initialize textarea after DOM update
            setTimeout(() => {
                autoResizeTextarea();
                updateCharacterCount();

                // Show task-specific questions if available
                if (serviceData.category) {
                    const taskKey = serviceData.taskKey || getCategoryTaskKey(serviceData.category);
                    showTaskQuestions(taskKey);
                }

                const textarea = document.getElementById('detailDescription');
                if (textarea && window.innerWidth > 480) {
                    textarea.focus();
                }
            }, 100);
        }

        // Show service-specific questions with upcharge options
        function showTaskQuestions(taskKey) {
            const task = TASKS[taskKey];
            const questionsSection = document.getElementById('taskQuestions');
            const questionsContainer = document.getElementById('questionsContainer');

            if (!task || !task.questions || task.questions.length === 0) {
                if (questionsSection) questionsSection.classList.add('hidden');
                return;
            }

            // Get description for auto-detection
            const description = serviceData.description || serviceData.detailedDescription || '';
            const detectedAnswers = autoDetectAnswers(taskKey, description);
            const hasDetections = Object.keys(detectedAnswers).length > 0;

            questionsContainer.innerHTML = '';

            // Add header if we have auto-detected answers
            if (hasDetections) {
                const headerDiv = document.createElement('div');
                headerDiv.className = 'bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4';
                headerDiv.innerHTML = `
                    <div class="flex items-center gap-2 text-blue-700 text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span>Options pre-selected based on your description. Please verify.</span>
                    </div>
                `;
                questionsContainer.appendChild(headerDiv);
            }

            task.questions.forEach(question => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'space-y-2';

                const label = document.createElement('label');
                label.className = 'block text-sm font-semibold text-gray-700';
                label.textContent = question.label;

                // Add auto-detected badge if applicable
                if (detectedAnswers[question.id]) {
                    const badge = document.createElement('span');
                    badge.className = 'ml-2 text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full';
                    badge.textContent = 'Auto-detected';
                    label.appendChild(badge);
                }

                const select = document.createElement('select');
                select.className = 'w-full rounded-lg border border-gray-300 px-3 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500';
                select.id = `question_${question.id}`;
                select.addEventListener('change', function() {
                    // Remove auto-detected badge when user manually changes
                    const badge = this.parentElement.querySelector('.bg-blue-100');
                    if (badge) badge.remove();
                    updateEstimateWithAddons();
                });

                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select an option';
                select.appendChild(defaultOption);

                question.options.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;

                    // Handle quantity pricing differently
                    if (question.type === 'quantity' && option.price) {
                        optionElement.textContent = `${option.label} - $${option.price}`;
                        optionElement.dataset.price = option.price;
                        optionElement.dataset.hours = option.hours;
                    } else {
                        optionElement.textContent = option.label + (option.addon > 0 ? ` (+$${option.addon})` : '');
                        optionElement.dataset.addon = option.addon;
                    }

                    // Pre-select if auto-detected
                    if (detectedAnswers[question.id] === option.value) {
                        optionElement.selected = true;
                    }

                    select.appendChild(optionElement);
                });

                questionDiv.appendChild(label);
                questionDiv.appendChild(select);
                questionsContainer.appendChild(questionDiv);
            });

            questionsSection.classList.remove('hidden');

            // Trigger initial addon calculation if we have detections
            if (hasDetections) {
                updateEstimateWithAddons();
            }
        }

        // Debounce timer for auto-detection
        let autoDetectTimer = null;

        // Debounced auto-detection - runs 500ms after user stops typing
        function debounceAutoDetect() {
            if (autoDetectTimer) clearTimeout(autoDetectTimer);
            autoDetectTimer = setTimeout(() => {
                if (serviceData.category) {
                    const taskKey = serviceData.taskKey || getCategoryTaskKey(serviceData.category);
                    const description = document.getElementById('detailDescription')?.value || '';

                    // Only re-run if we have a description
                    if (description.length > 10) {
                        // Store current values before refresh
                        const currentValues = {};
                        const task = TASKS[taskKey];
                        if (task && task.questions) {
                            task.questions.forEach(q => {
                                const select = document.getElementById(`question_${q.id}`);
                                if (select && select.value) {
                                    currentValues[q.id] = select.value;
                                }
                            });
                        }

                        // Update serviceData with new description
                        serviceData.detailedDescription = description;

                        // Re-run detection
                        const detected = autoDetectAnswers(taskKey, description);

                        // Only refresh if we found new detections
                        const newDetections = Object.keys(detected).filter(k => !currentValues[k]);
                        if (newDetections.length > 0) {
                            console.log('üîÑ New detections found, refreshing questions:', newDetections);
                            showTaskQuestions(taskKey);

                            // Restore user's manual selections that weren't just detected
                            Object.entries(currentValues).forEach(([qId, val]) => {
                                if (!detected[qId]) {
                                    const select = document.getElementById(`question_${qId}`);
                                    if (select) select.value = val;
                                }
                            });
                        }
                    }
                }
            }, 500);
        }

        // Calculate total addons from question selections
        function calculateAddons(taskKey) {
            const task = TASKS[taskKey];
            if (!task || !task.questions) return 0;

            let totalAddons = 0;
            console.log('üîç Calculating addons for task:', taskKey);

            task.questions.forEach(question => {
                const select = document.getElementById(`question_${question.id}`);
                if (select && select.value) {
                    const selectedOption = select.options[select.selectedIndex];

                    // Handle quantity pricing (replaces base price) vs regular addons
                    if (question.type === 'quantity' && selectedOption.dataset.price) {
                        console.log(`üìä Question ${question.id}: quantity pricing "${select.value}" with base price ${selectedOption.dataset.price}`);
                    } else {
                        const addon = parseInt(selectedOption.dataset.addon) || 0;
                        console.log(`üìä Question ${question.id}: selected "${select.value}" with addon ${addon}`);
                        totalAddons += addon;
                    }
                }
            });

            console.log('üí∞ Total addons calculated:', totalAddons);
            serviceData.addons = totalAddons;
            return totalAddons;
        }

        // Get quantity-based pricing for per-item services
        function getQuantityPricing(taskKey) {
            const task = TASKS[taskKey];
            if (!task || !task.questions) return null;

            const quantityQuestion = task.questions.find(q => q.type === 'quantity');
            if (!quantityQuestion) return null;

            const select = document.getElementById(`question_${quantityQuestion.id}`);
            if (!select || !select.value) return null;

            const selectedOption = select.options[select.selectedIndex];
            return {
                price: parseInt(selectedOption.dataset.price) || 0,
                hours: parseFloat(selectedOption.dataset.hours) || task.hours
            };
        }

        // Update estimate when question selections change
        function updateEstimateWithAddons() {
            if (!serviceData.category) return;

            const taskKey = serviceData.taskKey || getCategoryTaskKey(serviceData.category);
            const addons = calculateAddons(taskKey);
            console.log('Current add-ons total:', addons);

            // Update price display if visible
            const task = TASKS[taskKey];
            if (task) {
                const quantityPricing = getQuantityPricing(taskKey);
                let displayPrice = task.basePrice;

                if (quantityPricing && quantityPricing.price > 0) {
                    displayPrice = quantityPricing.price;
                }

                displayPrice += addons;

                const priceDisplay = document.getElementById('servicePriceDisplay');
                if (priceDisplay) {
                    priceDisplay.textContent = `$${displayPrice}`;
                }
            }
        }

        function updateServiceData(key, value) {
            serviceData[key] = value;
            // Auto-resize textarea on mobile
            if (key === 'detailedDescription') {
                autoResizeTextarea();
            }
        }

        function autoResizeTextarea() {
            const textarea = document.getElementById('detailDescription');
            if (textarea) {
                // Match CSS: 320px mobile, 280px desktop
                const minHeight = window.innerWidth <= 768 ? 320 : 280;
                const maxHeight = 600;

                // Let CSS handle initial size, only grow for content
                const contentHeight = textarea.scrollHeight;
                if (contentHeight > minHeight) {
                    textarea.style.height = Math.min(contentHeight, maxHeight) + 'px';
                }
            }
        }

        function updateCharacterCount() {
            const textarea = document.getElementById('detailDescription');
            const charCountSpan = document.getElementById('charCount');
            const charCountDiv = document.getElementById('characterCount');

            if (textarea && charCountSpan) {
                const count = textarea.value.length;
                charCountSpan.textContent = count;

                // Show helpful color coding for character count
                if (count >= 144) {
                    charCountSpan.parentElement.className = 'absolute bottom-2 right-2 text-xs text-green-600 bg-green-50 px-2 py-1 rounded hidden md:block';
                } else if (count >= 100) {
                    charCountSpan.parentElement.className = 'absolute bottom-2 right-2 text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded hidden md:block';
                } else {
                    charCountSpan.parentElement.className = 'absolute bottom-2 right-2 text-xs text-gray-500 bg-white px-2 py-1 rounded hidden md:block';
                }
            }
        }

        function proceedToScheduling() {
            // IMPORTANT: Calculate and store addons BEFORE replacing DOM content
            // The select elements will be destroyed when we update innerHTML
            const taskKey = serviceData.taskKey || getCategoryTaskKey(serviceData.category);
            const addons = calculateAddons(taskKey);
            const quantityPricing = getQuantityPricing(taskKey);

            // Store values for later use in showEstimate()
            serviceData.addons = addons;
            serviceData.quantityPricing = quantityPricing;
            console.log('üíæ Stored addons before navigation:', addons, 'quantityPricing:', quantityPricing);

            // Track details entry
            HandymanAnalytics.trackDetailsEntered(
                !!serviceData.detailedDescription,
                !!serviceData.uploadedPhotos?.length,
                !!serviceData.location
            );

            updateProgress(3); // Step 3: Time Selection
            const content = document.getElementById('serviceContent');
            content.innerHTML = `
                <div class="slide-up">
                    <h2 class="text-2xl font-bold mb-2">When do you need this fixed?</h2>
                    <p class="text-gray-600 mb-6">Choose your preferred time slot</p>

                    <div class="space-y-4">
                        <div class="service-card p-4" onclick="selectSchedule('tomorrow')">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-semibold" id="scheduleEarliestDay">Tomorrow</div>
                                    <div class="text-sm text-gray-600">Earliest available</div>
                                    <div class="text-xs text-green-600 mt-1">üéØ Most handymen available</div>
                                </div>
                                <div class="text-green-600">‚≠ê</div>
                            </div>
                        </div>

                        <div class="service-card p-4" onclick="selectSchedule('choose')">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-semibold">Choose Date</div>
                                    <div class="text-sm text-gray-600">Pick from calendar</div>
                                </div>
                                <div>üìÖ</div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 p-4 bg-blue-50 rounded-lg">
                        <div class="text-sm">
                            <div class="font-semibold mb-1">Available time slots:</div>
                            <div class="flex gap-2 flex-wrap">
                                <span class="bg-white px-2 py-1 rounded text-xs">8AM-12PM</span>
                                <span class="bg-white px-2 py-1 rounded text-xs">12PM-4PM</span>
                                <span class="bg-white px-2 py-1 rounded text-xs">4PM-8PM</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Update availability text after DOM is updated
            setTimeout(() => {
                updateAvailabilityText();
            }, 0);
        }

        function selectSchedule(schedule) {
            serviceData.schedule = schedule;

            // Track time slot selection
            HandymanAnalytics.trackTimeSlotSelected({
                windowLabel: schedule,
                pricing: serviceData.pricing
            });

            if (schedule === 'choose') {
                showDatePicker();
            } else {
                showEstimate();
            }
        }

        function showDatePicker() {
            const content = document.getElementById('serviceContent');

            // Calculate min date (2 days from now) and max date (14 days from now)
            const today = new Date();
            const minDate = new Date(today);
            minDate.setDate(minDate.getDate() + 2);
            const maxDate = new Date(today);
            maxDate.setDate(maxDate.getDate() + 14);

            const minDateStr = minDate.toISOString().split('T')[0];
            const maxDateStr = maxDate.toISOString().split('T')[0];

            content.innerHTML = `
                <div class="slide-up">
                    <h2 class="text-2xl font-bold mb-2">Choose Your Date</h2>
                    <p class="text-gray-600 mb-6">Select a date for your service (2-14 days out)</p>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Select Date</label>
                            <input
                                type="date"
                                id="selectedFutureDate"
                                min="${minDateStr}"
                                max="${maxDateStr}"
                                class="w-full border border-gray-300 rounded-lg p-3 text-lg"
                                onchange="validateSelectedDate(this)"
                            />
                        </div>

                        <div id="dateWarning" class="hidden p-3 rounded-lg text-sm"></div>

                        <div class="p-4 bg-blue-50 rounded-lg">
                            <div class="text-sm">
                                <div class="font-semibold mb-2">üìÖ Booking Rules:</div>
                                <div class="space-y-1">
                                    <div>‚úÖ <strong>Mon-Fri:</strong> All time slots available</div>
                                    <div>üéâ <strong>Advance booking:</strong> <span class="text-green-600 font-semibold">10% discount</span> for dates 3+ days out</div>
                                    <div>‚ö†Ô∏è <strong>Saturday:</strong> 8AM-12PM only ‚Ä¢ 30% premium</div>
                                    <div>üö´ <strong>Sunday:</strong> Not available</div>
                                </div>
                            </div>
                        </div>

                        <div class="pt-4">
                            <button onclick="confirmDateSelection()" id="confirmDateBtn" class="btn-primary w-full py-4 text-lg" disabled>
                                Continue with Selected Date
                            </button>
                        </div>

                        <div class="text-center">
                            <button onclick="proceedToScheduling()" class="text-gray-500 underline text-sm">
                                ‚Üê Go back
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function validateSelectedDate(input) {
            const warningDiv = document.getElementById('dateWarning');
            const confirmBtn = document.getElementById('confirmDateBtn');

            if (!input.value) {
                warningDiv.classList.add('hidden');
                confirmBtn.disabled = true;
                return;
            }

            const selectedDate = new Date(input.value + 'T00:00:00');
            const dayOfWeek = selectedDate.getDay();

            // Sunday check (day 0)
            if (dayOfWeek === 0) {
                warningDiv.textContent = 'üö´ Sundays are not available. Please select Monday-Saturday.';
                warningDiv.className = 'p-3 rounded-lg text-sm bg-red-50 border border-red-200 text-red-700';
                warningDiv.classList.remove('hidden');
                confirmBtn.disabled = true;
                input.value = '';
                return;
            }

            // Saturday check (day 6)
            if (dayOfWeek === 6) {
                warningDiv.textContent = 'üìÖ Saturday selected: Only 8AM-12PM available ‚Ä¢ 30% premium applies';
                warningDiv.className = 'p-3 rounded-lg text-sm bg-orange-50 border border-orange-200 text-orange-700';
                warningDiv.classList.remove('hidden');
            } else {
                // Check if this date qualifies for advance booking discount (beyond standard 2-day window)
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                let standardWindowEnd = new Date(today);
                let availableDaysCount = 0;
                while (availableDaysCount < 2) {
                    standardWindowEnd.setDate(standardWindowEnd.getDate() + 1);
                    if (standardWindowEnd.getDay() !== 0) {
                        availableDaysCount++;
                    }
                }

                if (selectedDate > standardWindowEnd) {
                    warningDiv.textContent = 'üéâ Advance booking! All time slots available + 10% discount applied!';
                    warningDiv.className = 'p-3 rounded-lg text-sm bg-green-50 border border-green-200 text-green-700';
                } else {
                    warningDiv.textContent = '‚úÖ Standard booking window. All time slots available.';
                    warningDiv.className = 'p-3 rounded-lg text-sm bg-blue-50 border border-blue-200 text-blue-700';
                }
                warningDiv.classList.remove('hidden');
            }

            confirmBtn.disabled = false;
        }

        function confirmDateSelection() {
            const dateInput = document.getElementById('selectedFutureDate');
            if (dateInput && dateInput.value) {
                serviceData.selectedDate = dateInput.value;
                serviceData.schedule = 'future';
                console.log('üìÖ Date selected:', serviceData.selectedDate);
                showEstimate();
            }
        }

        function showEstimate() {
            updateProgress(4); // Step 4: Final Booking

            // Use stored values from proceedToScheduling() - DOM elements no longer exist
            const taskKey = serviceData.taskKey || getCategoryTaskKey(serviceData.category);
            const task = TASKS[taskKey];

            // Use stored addons (calculated before DOM was replaced)
            const addons = serviceData.addons || 0;
            const quantityPricing = serviceData.quantityPricing || null;

            console.log('üìä showEstimate using stored addons:', addons, 'quantityPricing:', quantityPricing);

            let basePrice = task ? task.basePrice : 160;
            if (quantityPricing && quantityPricing.price > 0) {
                basePrice = quantityPricing.price;
            }

            let standardPrice = basePrice + addons;
            const hours = quantityPricing?.hours || (task ? task.hours : 2);

            // Apply date-based pricing adjustments
            // Discount only applies to dates BEYOND the standard window (first 2-3 available days)
            let dateAdjustmentLabel = '';
            let dateAdjustmentClass = '';

            if (serviceData.selectedDate) {
                const selectedDate = new Date(serviceData.selectedDate + 'T00:00:00');
                const dayOfWeek = selectedDate.getDay();

                // Calculate the standard window end date (first 2 available weekdays from today)
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Find the end of the "standard window" - first 2 available days (skipping Sundays)
                let standardWindowEnd = new Date(today);
                let availableDaysCount = 0;

                while (availableDaysCount < 2) {
                    standardWindowEnd.setDate(standardWindowEnd.getDate() + 1);
                    // Skip Sundays (day 0)
                    if (standardWindowEnd.getDay() !== 0) {
                        availableDaysCount++;
                    }
                }

                console.log('üìÖ Standard window ends:', standardWindowEnd.toDateString());
                console.log('üìÖ Selected date:', selectedDate.toDateString());

                // Check if selected date is beyond the standard window
                const isBeyondStandardWindow = selectedDate > standardWindowEnd;

                if (dayOfWeek === 6) {
                    // Saturday: 30% premium (always, regardless of window)
                    standardPrice = Math.round(standardPrice * 1.30);
                    dateAdjustmentLabel = 'üìÖ Saturday +30% premium';
                    dateAdjustmentClass = 'text-orange-600';
                    console.log('üìÖ Saturday premium applied: +30%');
                } else if (dayOfWeek >= 1 && dayOfWeek <= 5 && isBeyondStandardWindow) {
                    // Weekday AND beyond standard window: 10% discount
                    standardPrice = Math.round(standardPrice * 0.90);
                    dateAdjustmentLabel = 'üéâ Advance booking -10% discount!';
                    dateAdjustmentClass = 'text-green-600';
                    console.log('üìÖ Advance booking discount applied: -10%');
                } else if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    // Weekday but within standard window: no adjustment
                    dateAdjustmentLabel = 'üìÖ Standard booking window';
                    dateAdjustmentClass = 'text-blue-600';
                    console.log('üìÖ Standard window date - no discount');
                }
            }

            const premiumPrice = Math.round(standardPrice * 1.35); // 35% premium markup on adjusted price

            // Store final calculated prices
            serviceData.taskKey = taskKey;
            serviceData.calculatedPrice = standardPrice;
            serviceData.premiumPrice = premiumPrice;
            serviceData.dateAdjustmentLabel = dateAdjustmentLabel;
            serviceData.dateAdjustmentClass = dateAdjustmentClass;

            // Format selected date for display
            let selectedDateDisplay = '';
            if (serviceData.selectedDate) {
                const dateObj = new Date(serviceData.selectedDate + 'T00:00:00');
                selectedDateDisplay = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            }

            const content = document.getElementById('serviceContent');
            content.innerHTML = `
                <div class="slide-up">
                    <h2 class="text-2xl font-bold mb-6">AI Instant Estimate</h2>

                    ${serviceData.selectedDate ? `
                    <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div class="text-sm">
                                <span class="font-semibold">üìÖ Scheduled for:</span> ${selectedDateDisplay}
                            </div>
                            ${dateAdjustmentLabel ? `<div class="text-sm font-semibold ${dateAdjustmentClass}">${dateAdjustmentLabel}</div>` : ''}
                        </div>
                    </div>
                    ` : ''}

                    <div class="estimate-card mb-6">
                        <div class="flex items-center gap-2 mb-4">
                            <span class="ai-badge">AI</span>
                            <span class="font-semibold">${serviceData.categoryDisplay || 'Service Request'}</span>
                        </div>
                        <div class="text-3xl font-bold mb-2" id="servicePriceDisplay">$${standardPrice}</div>
                        <div class="text-lg opacity-90 mb-4">Estimated cost range</div>
                        <div class="text-sm opacity-80">
                            ‚Ä¢ ${hours}-${hours + 1} hours estimated duration<br>
                            ‚Ä¢ Final price confirmed after handyman inspection<br>
                            ‚Ä¢ No hidden fees or surprises
                        </div>
                    </div>

                    <div class="space-y-4 mb-6">
                        <div class="service-card p-4 border-2" onclick="selectServiceLevel('standard')">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-semibold">Standard Service</div>
                                    <div class="text-sm text-gray-600">Basic repair ‚Ä¢ ‚≠ê‚≠ê‚≠ê‚≠ê 4.8 avg rating</div>
                                </div>
                                <div class="text-xl font-bold" id="tomorrowPricing">$${standardPrice}</div>
                            </div>
                        </div>

                        <div class="service-card p-4" onclick="selectServiceLevel('premium')">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-semibold">Premium Service</div>
                                    <div class="text-sm text-gray-600">Expert + warranty ‚Ä¢ ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 4.9 avg rating</div>
                                    <div class="text-xs text-green-600 mt-1">‚úÖ 90-day guarantee</div>
                                </div>
                                <div class="text-xl font-bold" id="premiumPricing">$${premiumPrice}</div>
                            </div>
                        </div>
                    </div>

                    <button onclick="proceedToBooking()" class="btn-primary w-full py-4 text-lg" style="display: none; opacity: 0; transition: opacity 0.3s ease;">
                        Continue to Booking
                    </button>
                </div>
            `;
        }

        function selectServiceLevel(level) {
            serviceData.serviceLevel = level;

            // Update visual selection state
            document.querySelectorAll('.service-card').forEach(card => {
                card.classList.remove('selected', 'bg-blue-50', 'border-blue-300');
            });

            // Add selected state to clicked card
            event.target.closest('.service-card').classList.add('selected', 'bg-blue-50', 'border-blue-300');

            // Show the Continue to Booking button
            const bookingBtn = document.querySelector('button[onclick="proceedToBooking()"]');
            if (bookingBtn) {
                bookingBtn.style.display = 'block';
                bookingBtn.style.opacity = '1';
            }
        }

        function proceedToBooking() {
            // Show the full booking flow with time slots and pricing
            showBookingFlow();
        }

        // Global variables
        let availableTimeSlots = [];
        let currentBookingStep = 1;

        function showBookingFlow() {
            console.log('üöÄ showBookingFlow called - this should generate proper time slots');
            console.log('üìÖ Current date and context:', {
                now: new Date().toString(),
                dayOfWeek: new Date().getDay(), // 0=Sunday, 6=Saturday
                serviceData: serviceData
            });

            const content = document.getElementById('serviceContent');
            document.getElementById('landingScreen').classList.add('hide');
            document.getElementById('serviceFlow').classList.remove('hide');
            currentStep = 'booking';

            // Update progress to step 2 (Time Selection)
            updateProgress(2);

            // Show loading while generating time slots
            showLoading('Finding available time slots...');

            setTimeout(() => {
                const timeSlots = generateTimeSlots();
                availableTimeSlots = timeSlots;
                console.log('üïí ACTUAL TIME SLOTS GENERATED:', timeSlots.map(slot => ({
                    label: slot.windowLabel,
                    price: slot.pricing.total,
                    badge: slot.badge
                })));
                hideLoading();

                // Build the template with actual timeSlots data
                content.innerHTML = `
                    <div class="slide-up">
                        <h2 class="text-2xl font-bold mb-2">Choose Time & Date</h2>
                        <p class="text-gray-600 mb-6">Select when you'd like your ${serviceData.categoryDisplay} service</p>

                        <div class="space-y-4 mb-8">
                            ${timeSlots.map((slot, index) => `
                                <div class="service-card p-4 cursor-pointer" onclick="selectTimeSlotByIndex(${index})">
                                    <div class="flex justify-between items-center">
                                    <div>
                                        <div class="font-semibold">${slot.windowLabel}</div>
                                        <div class="text-sm text-gray-600">${slot.badge || ''}</div>
                                        ${slot.premiums && slot.premiums.length > 0 ? `
                                            <div class="text-xs text-gray-500 mt-1">
                                                ${slot.premiums.map(p => p.amount > 0 ? `+${p.label}` : p.label).join(' ‚Ä¢ ')}
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xl font-bold">$${slot.pricing.total}</div>
                                        ${slot.pricing.base !== slot.pricing.total ? `
                                            <div class="text-sm text-gray-500 line-through">$${slot.pricing.base}</div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <button onclick="goBack()" class="btn-secondary w-full py-3">
                        Back to Service Details
                    </button>
                </div>
                `;

                // Show sticky bottom bar on mobile
                showStickyBottomBar('Select Time Slot', 'selectFirstAvailableSlot()');
            }, 800);
        }

        function selectTimeSlotByIndex(index) {
            console.log('üéØ selectTimeSlotByIndex called with index:', index);
            const selectedSlot = availableTimeSlots[index];
            console.log('üéØ Selected slot:', selectedSlot);
            if (!selectedSlot) {
                console.log('üéØ No slot found for index:', index);
                return;
            }

            serviceData.selectedWindow = selectedSlot.window;
            serviceData.selectedWindowLabel = selectedSlot.windowLabel;
            serviceData.selectedTimeSlot = selectedSlot; // Store the full slot object
            serviceData.pricing = selectedSlot.pricing;

            // Show success toast
            showToast(`Time slot selected: ${selectedSlot.windowLabel}`, 'success');

            // Update progress to step 3 (Details)
            updateProgress(3);

            // Hide mobile sticky bar
            hideStickyBottomBar();

            // Proceed to final booking confirmation
            setTimeout(showBookingConfirmation, 500);
        }

        function selectFirstAvailableSlot() {
            if (availableTimeSlots.length > 0) {
                selectTimeSlotByIndex(0);
            }
        }

        function selectTimeSlot(window, pricing) {
            serviceData.selectedWindow = window;
            serviceData.pricing = pricing;

            // Proceed to final booking confirmation
            showBookingConfirmation();
        }

        function showBookingConfirmation() {
            const content = document.getElementById('serviceContent');

            // Update progress to step 4 (Final Booking)
            updateProgress(4);

            // Show mobile sticky bar with final price
            showStickyBottomBar('Complete Booking', 'completeBooking()', `$${serviceData.pricing.total}`);

            content.innerHTML = `
                <div class="slide-up">
                    <h2 class="text-2xl font-bold mb-2">Booking Summary</h2>
                    <p class="text-gray-600 mb-6">Review your booking details</p>

                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="font-semibold">Service:</span>
                                <span>${serviceData.categoryDisplay}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-semibold">Time:</span>
                                <span>${serviceData.selectedWindowLabel || serviceData.selectedWindow}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-semibold">Base Price:</span>
                                <span>$${serviceData.pricing.base}</span>
                            </div>
                            ${serviceData.pricing.premiums.map(premium => `
                                <div class="flex justify-between text-sm ${premium.amount > 0 ? 'text-red-600' : 'text-green-600'}">
                                    <span>${premium.label}:</span>
                                    <span>${premium.amount > 0 ? '+' : ''}$${Math.abs(premium.amount)}</span>
                                </div>
                            `).join('')}
                            <hr class="border-gray-300">
                            <div class="flex justify-between font-bold text-lg">
                                <span>Total:</span>
                                <span>$${serviceData.pricing.total}</span>
                            </div>
                        </div>
                    </div>

                    <button onclick="completeBooking()" class="btn-primary w-full py-4 mb-3">
                        Complete Booking - $${serviceData.pricing.total}
                    </button>

                    <button onclick="showBookingFlow()" class="btn-secondary w-full py-3">
                        Change Time
                    </button>
                </div>
            `;
        }

        function completeBooking() {
            console.log('üéØ completeBooking function called!');
            console.log('üéØ Service data:', serviceData);

            // Validate required booking data
            console.log('üîç Validating serviceData:', {
                category: serviceData.category,
                selectedTimeSlot: serviceData.selectedTimeSlot,
                pricing: serviceData.pricing,
                location: serviceData.location
            });

            const missingFields = [];
            if (!serviceData.category) missingFields.push('service category');
            if (!serviceData.selectedTimeSlot) missingFields.push('time slot');
            if (!serviceData.pricing) missingFields.push('pricing');

            if (missingFields.length > 0) {
                const message = `Missing required data: ${missingFields.join(', ')}. Please restart the booking process.`;
                console.error('‚ùå Booking validation failed:', message);
                showToast(message, 'error');
                return;
            }

            console.log('üí≥ Opening payment modal for:', {
                service: serviceData.categoryDisplay,
                timeSlot: serviceData.selectedTimeSlot.windowLabel,
                total: serviceData.pricing.total
            });

            // Hide sticky bar and show payment modal
            hideStickyBottomBar();
            showPaymentModal();
        }

        function getCurrentBlock() {
            const now = new Date();
            const hour = now.getHours();
            if (hour >= 8 && hour < 12) return 'today_am';
            if (hour >= 12 && hour < 16) return 'today_pm';
            if (hour >= 16 && hour < 20) return 'today_eve';
            return null;
        }

        function isBlockInPast(blockKey) {
            const now = new Date();
            const hour = now.getHours();
            if (blockKey === 'today_am' && hour >= 12) return true;
            if (blockKey === 'today_pm' && hour >= 16) return true;
            if (blockKey === 'today_eve' && hour >= 20) return true;
            return false;
        }

        function isSaturday(date) {
            return date.getDay() === 6;
        }

        function isSunday(date) {
            return date.getDay() === 0;
        }

        function calculatePricing(hours, window, rush = false, addons = 0, selectedDate = null) {
            const base = hours * RATE;
            let premiums = [];
            let total = base + addons;
            const currentBlock = getCurrentBlock();
            const isToday = window.startsWith('today');
            const isTomorrow = window.startsWith('tomorrow');
            const isMonday = window.startsWith('monday');
            const isFuture = selectedDate !== null;
            const isEveningBlock = window.includes('eve');
            const now = new Date();
            let bookingDate;

            if (isFuture && selectedDate) {
                bookingDate = new Date(selectedDate + 'T00:00:00');
            } else if (isToday) {
                bookingDate = now;
            } else if (isTomorrow) {
                bookingDate = new Date(now);
                bookingDate.setDate(bookingDate.getDate() + 1);
            } else if (isMonday) {
                bookingDate = new Date(now);
                const daysUntilMonday = (8 - now.getDay()) % 7;
                bookingDate.setDate(bookingDate.getDate() + (daysUntilMonday === 0 ? 7 : daysUntilMonday));
            }

            const isBookingSaturday = bookingDate && isSaturday(bookingDate);

            if (isFuture) {
                if (isEveningBlock) {
                    const premium = base * PREMIUM_EVENING_BLOCK;
                    premiums.push({ label: 'Evening block premium (4-8PM, +35%)', amount: premium });
                    total += premium;
                }
                else if (isBookingSaturday) {
                    const satPremium = base * PREMIUM_SATURDAY;
                    premiums.push({ label: 'Saturday service premium (+30%)', amount: satPremium });
                    total += satPremium;
                } else {
                    const discount = base * DISCOUNT_FUTURE;
                    premiums.push({ label: 'Future booking discount (-10%)', amount: -discount });
                    total -= discount;
                }
            } else if (isToday) {
                if (isBookingSaturday) {
                    const satPremium = base * PREMIUM_SATURDAY;
                    premiums.push({ label: 'Saturday service premium (+30%)', amount: satPremium });
                    total += satPremium;
                }
                if (isEveningBlock) {
                    const premium = base * PREMIUM_EVENING_BLOCK;
                    premiums.push({ label: 'Evening block premium (4-8PM, +35%)', amount: premium });
                    total += premium;
                } else if (window === currentBlock) {
                    const premium = base * PREMIUM_CURRENT_BLOCK;
                    premiums.push({ label: 'Current time block premium (+30%)', amount: premium });
                    total += premium;
                } else {
                    const premium = base * PREMIUM_NEXT_BLOCK;
                    premiums.push({ label: 'Next available block premium (+20%)', amount: premium });
                    total += premium;
                }
            } else if (isTomorrow) {
                if (isBookingSaturday) {
                    const satPremium = base * PREMIUM_SATURDAY;
                    premiums.push({ label: 'Saturday service premium (+30%)', amount: satPremium });
                    total += satPremium;
                }
                if (isEveningBlock) {
                    const premium = base * PREMIUM_EVENING_BLOCK;
                    premiums.push({ label: 'Evening block premium (4-8PM, +35%)', amount: premium });
                    total += premium;
                }
            }

            if (addons > 0) {
                premiums.push({ label: 'Task-specific add-ons', amount: addons });
            }

            return { base: Math.round(base), premiums, total: Math.round(total), addons };
        }

        function generateTimeSlots() {
            console.log('üïí generateTimeSlots called');
            const now = new Date();
            const timeSlots = [];

            // Use mapped taskKey and stored addons
            const taskKey = serviceData.taskKey || getCategoryTaskKey(serviceData.category);
            const task = TASKS[taskKey];
            const hours = task ? task.hours : 2;
            const addons = serviceData.addons || 0;

            console.log('üïí Task details:', { taskKey, category: serviceData.category, hours, addons });

            // Define time blocks: 8AM-12PM, 12PM-4PM, 4PM-8PM (premium)
            const timeBlocks = [
                { key: 'am', label: '8AM-12PM', start: 8, end: 12, premium: false },
                { key: 'pm', label: '12PM-4PM', start: 12, end: 16, premium: false },
                { key: 'eve', label: '4PM-8PM', start: 16, end: 20, premium: true }
            ];

            // Get next business day (skip Sunday, ensure at least 1 business day gap)
            function getNextBusinessDay(fromDate, daysToAdd = 1) {
                const nextDate = new Date(fromDate);
                nextDate.setDate(nextDate.getDate() + daysToAdd);

                // If it lands on Sunday, move to Monday
                if (isSunday(nextDate)) {
                    nextDate.setDate(nextDate.getDate() + 1);
                }

                return nextDate;
            }

            // Business day rules:
            // Sunday ‚Üí Tuesday (skip Monday, need 1 business day gap)
            // Saturday ‚Üí Monday (skip Sunday)
            // Weekdays ‚Üí Tomorrow (unless Sunday, then Monday)
            const today = now.getDay();
            let firstAvailableDay, secondAvailableDay;

            if (today === 0) {
                // Sunday: earliest is Tuesday
                firstAvailableDay = getNextBusinessDay(now, 2); // Skip Monday
                secondAvailableDay = getNextBusinessDay(firstAvailableDay, 1);
            } else if (today === 6) {
                // Saturday: earliest is Monday (skip Sunday)
                firstAvailableDay = getNextBusinessDay(now, 2); // Skip Sunday, land on Monday
                secondAvailableDay = getNextBusinessDay(firstAvailableDay, 1);
            } else {
                // Weekday: earliest is tomorrow (unless tomorrow is Sunday)
                firstAvailableDay = getNextBusinessDay(now, 1);
                secondAvailableDay = getNextBusinessDay(firstAvailableDay, 1);
            }

            console.log('üïí Available days:', {
                today: now.toDateString(),
                todayIsWeekday: now.getDay(),
                firstAvailable: firstAvailableDay.toDateString(),
                secondAvailable: secondAvailableDay.toDateString()
            });

            // Add first available day slots (no future discount, but include addons)
            timeBlocks.forEach(block => {
                const window = `day1_${block.key}`;
                // Use tomorrow_ window for next-day premium, include addons, no selectedDate to avoid future discount
                const pricing = calculatePricing(hours, `tomorrow_${block.key}`, false, addons, null);
                const dayName = firstAvailableDay.toLocaleDateString('en-US', { weekday: 'long' });

                timeSlots.push({
                    window: window,
                    windowLabel: `${dayName} (${block.label})`,
                    pricing: pricing,
                    badge: isSaturday(firstAvailableDay) ? 'Saturday Premium' : 'Next Available',
                    premiums: pricing.premiums,
                    date: firstAvailableDay.toISOString().split('T')[0]
                });
            });

            // Add second available day slots (no future discount, but include addons)
            timeBlocks.forEach(block => {
                const window = `day2_${block.key}`;
                // Use tomorrow_ window for next-day premium, include addons, no selectedDate to avoid future discount
                const pricing = calculatePricing(hours, `tomorrow_${block.key}`, false, addons, null);
                const dayName = secondAvailableDay.toLocaleDateString('en-US', { weekday: 'long' });

                timeSlots.push({
                    window: window,
                    windowLabel: `${dayName} (${block.label})`,
                    pricing: pricing,
                    badge: isSaturday(secondAvailableDay) ? 'Saturday Premium' : 'Standard',
                    premiums: pricing.premiums,
                    date: secondAvailableDay.toISOString().split('T')[0]
                });
            });

            console.log('üïí Generated time slots:', timeSlots.length);
            return timeSlots;
        }

        function goBack() {
            if (currentStep === 'details') {
                document.getElementById('serviceFlow').classList.add('hide');
                document.getElementById('landingScreen').classList.remove('hide');
                currentStep = 'landing';
            } else if (currentStep === 'services') {
                // Going back from "All Services" screen to landing page
                document.getElementById('serviceFlow').classList.add('hide');
                document.getElementById('landingScreen').classList.remove('hide');
                currentStep = 'landing';
            } else if (currentStep === 'booking') {
                // Going back from booking to service details
                showServiceDetails();
            }
        }

        // Legacy progress function removed - using step-based progress now

        // Photo Modal Functions
        function showPhotoModal() {
            console.log('üì∑ Opening photo modal...');
            const modal = document.getElementById('photoModal');
            if (modal) {
                modal.classList.remove('hide');
                modal.style.display = 'flex'; // Force display
                resetPhotoModal(); // Reset to upload prompt
                console.log('‚úÖ Photo modal opened');
            } else {
                console.error('‚ùå Photo modal not found');
            }
        }

        function closePhotoModal() {
            console.log('üîÑ Closing photo modal...');
            const modal = document.getElementById('photoModal');
            if (modal) {
                modal.classList.add('hide');
                modal.style.display = 'none'; // Force hide with inline style
                resetPhotoModal();
                console.log('‚úÖ Photo modal closed');
            }
        }

        function resetPhotoModal() {
            document.getElementById('uploadPrompt').classList.remove('hide');
            document.getElementById('photoPreview').classList.add('hide');
            document.getElementById('analysisLoading').classList.add('hide');
            document.getElementById('analysisResults').classList.add('hide');
            document.getElementById('photoError').classList.add('hide');

            // Clear file inputs
            const cameraInput = document.getElementById('cameraInput');
            const galleryInput = document.getElementById('galleryInput');
            if (cameraInput) cameraInput.value = '';
            if (galleryInput) galleryInput.value = '';

            // Reset image source
            const previewImage = document.getElementById('previewImage');
            if (previewImage) {
                previewImage.src = '';
            }

            // Clear current photo
            currentPhoto = null;
        }

        function triggerCamera() {
            document.getElementById('cameraInput').click();
        }

        function triggerGallery() {
            document.getElementById('galleryInput').click();
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file
            if (!file.type.startsWith('image/')) {
                showPhotoError('Please select a valid image file.');
                return;
            }

            // Check file size - account for base64 encoding expansion (~33% increase)
            // API limit is 5MB after base64, so we need to limit uploads to ~3.7MB before encoding
            const maxSizeBeforeEncoding = 3.7 * 1024 * 1024; // ~3.7MB raw = ~5MB after base64

            if (file.size > maxSizeBeforeEncoding) {
                const sizeMB = (file.size / (1024 * 1024)).toFixed(1);
                const estimatedEncodedSizeMB = (file.size * 1.33 / (1024 * 1024)).toFixed(1);
                showPhotoErrorWithCompression(
                    `Photo is ${sizeMB}MB (${estimatedEncodedSizeMB}MB after processing). Our AI requires photos under 3.7MB for analysis. Would you like us to compress it automatically?`,
                    file
                );
                return;
            }

            // Auto-compress images larger than 500KB for better reliability
            if (file.size > 500 * 1024) {
                console.log(`üì¶ Auto-compressing image from ${(file.size / 1024).toFixed(1)}KB`);
                showToast('Optimizing image for faster upload...', 'info', 2000);

                compressImage(file, 0.7, 1920).then(compressedFile => {
                    console.log(`üì¶ Compressed to ${(compressedFile.size / 1024).toFixed(1)}KB`);
                    displayImagePreview(compressedFile);
                    currentPhoto = compressedFile;
                }).catch(error => {
                    console.warn('Compression failed, using original:', error);
                    displayImagePreview(file);
                    currentPhoto = file;
                });
            } else {
                displayImagePreview(file);
                currentPhoto = file;
            }
        }

        function displayImagePreview(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('uploadPrompt').classList.add('hide');
                document.getElementById('photoPreview').classList.remove('hide');
            };
            reader.readAsDataURL(file);
        }

        function compressImage(file, quality = 0.7, maxWidth = 1920) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();

                img.onload = function() {
                    // Calculate new dimensions
                    const ratio = Math.min(maxWidth / img.width, maxWidth / img.height);
                    const newWidth = img.width * ratio;
                    const newHeight = img.height * ratio;

                    canvas.width = newWidth;
                    canvas.height = newHeight;

                    // Draw and compress
                    ctx.drawImage(img, 0, 0, newWidth, newHeight);

                    canvas.toBlob(function(blob) {
                        const compressedFile = new File([blob], file.name, {
                            type: 'image/jpeg',
                            lastModified: Date.now()
                        });
                        resolve(compressedFile);
                    }, 'image/jpeg', quality);
                };

                img.src = URL.createObjectURL(file);
            });
        }

        function showPhotoErrorWithCompression(message, originalFile) {
            const errorMessage = document.getElementById('photoErrorMessage');

            errorMessage.innerHTML = `
                <div class="mb-4">${message}</div>
                <div class="flex gap-3 justify-center flex-wrap">
                    <button onclick="compressLargeFile('${originalFile.name}')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                        üóúÔ∏è Compress Photo
                    </button>
                    <button onclick="retakePhoto()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors text-sm">
                        üì∑ Choose Different Photo
                    </button>
                    <button onclick="dismissPhotoError()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm">
                        ‚úï Cancel
                    </button>
                </div>
            `;
            document.getElementById('photoError').classList.remove('hide');

            // Store the file for compression
            window.pendingCompressionFile = originalFile;
        }

        async function compressLargeFile() {
            if (!window.pendingCompressionFile) {
                showToast('No file available for compression', 'error');
                return;
            }

            const file = window.pendingCompressionFile;
            dismissPhotoError();
            showToast('Compressing large image...', 'info', 3000);

            try {
                // First compression attempt
                console.log(`üóúÔ∏è Compressing ${(file.size / (1024 * 1024)).toFixed(1)}MB file...`);
                const compressedFile = await compressImage(file, 0.7, 1920);
                const compressedSizeMB = (compressedFile.size / (1024 * 1024)).toFixed(1);
                console.log(`üì¶ First compression: ${compressedSizeMB}MB`);

                // Check if still too large after first compression
                const estimatedEncodedSize = compressedFile.size * 1.33;

                if (estimatedEncodedSize > 5 * 1024 * 1024) {
                    // Still too large, try more aggressive compression
                    console.log(`First compression: ${compressedSizeMB}MB still too large, trying more aggressive compression...`);
                    showToast('Applying stronger compression...', 'info', 3000);

                    const veryCompressedFile = await compressImage(file, 0.3, 960); // Very aggressive
                    const finalSizeMB = (veryCompressedFile.size / (1024 * 1024)).toFixed(1);
                    const finalEncodedSize = veryCompressedFile.size * 1.33;

                    if (finalEncodedSize > 5 * 1024 * 1024) {
                        showPhotoError(`Even after compression, the image (${finalSizeMB}MB) is too large for AI analysis. Please try a smaller image or take a new photo.`);
                        return;
                    }

                    displayImagePreview(veryCompressedFile);
                    currentPhoto = veryCompressedFile;
                    showToast(`Photo compressed from ${(file.size / (1024 * 1024)).toFixed(1)}MB to ${finalSizeMB}MB`, 'success');
                } else {
                    displayImagePreview(compressedFile);
                    currentPhoto = compressedFile;
                    showToast(`Photo compressed from ${(file.size / (1024 * 1024)).toFixed(1)}MB to ${compressedSizeMB}MB`, 'success');
                }

            } catch (error) {
                console.error('Compression failed:', error);
                showPhotoError('Compression failed. Please try a different photo or reduce the file size manually.');
            } finally {
                window.pendingCompressionFile = null;
            }
        }

        function retakePhoto() {
            resetPhotoModal();
        }

        async function analyzePhoto() {
            if (!currentPhoto) {
                showToast('Please select a photo first', 'warning');
                return;
            }

            // Prevent concurrent analysis attempts
            if (isAnalyzing) {
                console.log('üö´ Analysis already in progress, skipping duplicate request');
                showToast('Analysis already in progress...', 'info');
                return;
            }

            try {
                isAnalyzing = true;
                // Show enhanced loading
                document.getElementById('photoPreview').classList.add('hide');
                document.getElementById('analysisLoading').classList.remove('hide');

                // Show toast notification
                showToast('Analyzing your photo with AI...', 'info', 6000);

                // Convert file to base64
                const base64 = await fileToBase64(currentPhoto);

                // Quick connectivity check with more reliable timeout
                try {
                    const healthController = new AbortController();
                    const healthTimeout = setTimeout(() => healthController.abort(), 5000);

                    const healthCheck = await fetch('/.netlify/functions/ai-photo-analysis', {
                        method: 'OPTIONS',
                        signal: healthController.signal
                    });
                    clearTimeout(healthTimeout);
                    console.log('Connectivity check passed');
                } catch (healthError) {
                    console.warn('Connectivity check failed, but proceeding anyway:', healthError.name);
                }

                // Call AI analysis function with longer timeout for better reliability
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    console.log('üïê Analysis timeout triggered after 45 seconds');
                    controller.abort();
                }, 45000); // Increased to 45 seconds for better reliability

                const response = await fetch('/.netlify/functions/ai-photo-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: base64,
                        filename: currentPhoto.name || 'photo.jpg'
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error:', response.status, errorText);
                    throw new Error(`Analysis failed: ${response.statusText}`);
                }

                const result = await response.json();

                // Check if this is an unsupported format error (like original)
                if (result.error_type === 'unsupported_format') {
                    showPhotoError(result.urgency_notes || 'Unsupported image format. Please use JPG, PNG, WebP, or GIF.');
                    return;
                }

                showAnalysisResults(result);

            } catch (error) {
                // Reset analysis flag
                isAnalyzing = false;
                console.error('AI analysis error:', error.name, error.message);
                console.error('Full error object:', error);
                document.getElementById('analysisLoading').classList.add('hide');

                // Clear any remaining timeouts
                clearTimeout(timeoutId);

                // Reset photo preview to allow retry
                document.getElementById('photoPreview').classList.remove('hide');

                // Enhanced error handling with specific timeout handling
                let userMessage = 'Analysis temporarily unavailable. Please try again.';

                if (error.name === 'AbortError' || error.message.includes('aborted')) {
                    userMessage = 'Analysis timed out after 45 seconds. You can try again with the same photo or upload a smaller image.';
                    showToast('Analysis timed out - you can retry with the same photo', 'warning', 6000);
                } else if (error.message.includes('Failed to fetch') || error.message.includes('ERR_TIMED_OUT') || error.message.includes('TypeError: Failed to fetch')) {
                    userMessage = 'Network connection issue detected. Please check your internet connection and try again.';
                    showToast('Connection timeout - please check your internet and retry', 'error', 6000);
                } else if (error.message.includes('413') || error.message.includes('too large')) {
                    userMessage = 'Photo is too large for analysis. Please try a smaller image.';
                    showToast('Image too large - please use a smaller photo', 'warning');
                } else if (error.message.includes('timeout') || error.message.includes('network')) {
                    userMessage = 'Connection timeout. Please check your internet and try again.';
                    showToast('Network timeout - retrying might help', 'warning');
                } else if (error.message.includes('429')) {
                    userMessage = 'Service temporarily busy. Please wait a moment and try again.';
                    showToast('Service busy - please wait a moment before retrying', 'warning');
                } else if (error.message.includes('media type') || error.message.includes('does not match')) {
                    userMessage = 'Image format not supported. Please upload a JPG, PNG, WebP, or GIF image.';
                } else if (error.message.includes('invalid_request_error')) {
                    userMessage = 'Invalid image format. Please ensure your image is JPG, PNG, WebP, or GIF.';
                }

                // Show enhanced error with retry option
                showPhotoErrorWithRetry(userMessage);
            }
        }

        function showAnalysisResults(result) {
            // Reset analysis flag on success
            isAnalyzing = false;
            document.getElementById('analysisLoading').classList.add('hide');

            // Store the result for later use
            window.lastAnalysisResult = result;
            console.log('üìä Stored analysis result:', result);

            const resultsDiv = document.getElementById('analysisResults');

            // Check if this is a fallback/error response
            const isFallbackResponse = result.confidence_level === 'low' &&
                                       (result.problem_description.includes('temporarily unavailable') ||
                                        result.problem_description.includes('Claude API error'));

            // Enhanced verbose AI analysis display
            resultsDiv.innerHTML = `
                <div class="space-y-4">
                    <!-- Problem Description -->
                    <div class="${isFallbackResponse ? 'bg-orange-50 border border-orange-200' : 'bg-blue-50 border border-blue-200'} rounded-lg p-4">
                        <h4 class="font-semibold ${isFallbackResponse ? 'text-orange-900' : 'text-blue-900'} mb-2">
                            ${isFallbackResponse ? '‚ö†Ô∏è Service Update' : 'üîç Problem Identified'}
                        </h4>
                        <p class="${isFallbackResponse ? 'text-orange-800' : 'text-blue-800'}">
                            ${isFallbackResponse
                                ? 'Our AI analysis service is temporarily experiencing high demand. We\'ve provided a standard estimate below, but for the most accurate assessment, please call us directly.'
                                : (result.problem_description || 'Analysis completed successfully')
                            }
                        </p>
                    </div>

                    <!-- Recommended Task -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h4 class="font-semibold text-green-900 mb-2">‚úÖ Recommended Service</h4>
                        <p class="text-green-800 font-medium">${result.recommended_task || 'General Handyman Service'}</p>
                    </div>

                    <!-- Cost & Risk Assessment -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <h5 class="font-semibold text-gray-900 mb-2">üí∞ Cost Estimate</h5>
                            <p class="text-lg font-bold text-gray-800">${result.cost_estimate || '$160'}</p>
                        </div>
                        <div class="bg-${result.risk_level === 'high' || result.risk_level === 'urgent' ? 'red' : result.risk_level === 'moderate' ? 'yellow' : 'green'}-50 border border-${result.risk_level === 'high' || result.risk_level === 'urgent' ? 'red' : result.risk_level === 'moderate' ? 'yellow' : 'green'}-200 rounded-lg p-4">
                            <h5 class="font-semibold text-${result.risk_level === 'high' || result.risk_level === 'urgent' ? 'red' : result.risk_level === 'moderate' ? 'yellow' : 'green'}-900 mb-2">‚ö†Ô∏è Risk Level</h5>
                            <p class="font-bold capitalize text-${result.risk_level === 'high' || result.risk_level === 'urgent' ? 'red' : result.risk_level === 'moderate' ? 'yellow' : 'green'}-800">${result.risk_level || 'moderate'}</p>
                        </div>
                    </div>

                    <!-- Urgency Notes -->
                    ${result.urgency_notes ? `
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                            <h5 class="font-semibold text-orange-900 mb-2">‚è∞ Timing Recommendations</h5>
                            <p class="text-orange-800">${result.urgency_notes}</p>
                        </div>
                    ` : ''}

                    <!-- Confidence Level -->
                    <div class="text-center">
                        <div class="text-sm text-gray-600">
                            AI Confidence: <span class="font-semibold capitalize">${result.confidence_level || 'medium'}</span>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="space-y-3 mt-6">
                        ${isFallbackResponse ? `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <button onclick="useAnalysisResults()" class="btn-primary py-3">
                                    üìû Call for Accurate Quote
                                </button>
                                <button onclick="useAnalysisResults()" class="btn-secondary py-3">
                                    Book Standard Service - ${result.cost_estimate || '$240'}
                                </button>
                            </div>
                            <button onclick="retakePhoto()" class="btn-secondary w-full py-2">
                                üîÑ Try AI Analysis Again
                            </button>
                        ` : `
                            <button onclick="useAnalysisResults()" class="btn-primary w-full py-3">
                                Book ${result.recommended_task || 'Service'} - ${result.cost_estimate || '$160'}
                            </button>
                            <button onclick="retakePhoto()" class="btn-secondary w-full py-2">
                                üì∑ Take Different Photo
                            </button>
                        `}
                    </div>
                </div>
            `;

            resultsDiv.classList.remove('hide');
        }

        function useAnalysisResults() {
            const result = window.lastAnalysisResult;
            console.log('üîç useAnalysisResults called with result:', result);

            if (result && result.recommended_task) {
                // Enhanced mapping logic for AI recommended task to service categories
                let mappedCategory = 'repair'; // default
                const task = result.recommended_task.toLowerCase();
                const taskCategory = result.task_category; // Direct category from AI

                console.log('üìã AI Analysis Result:', {
                    task: result.recommended_task,
                    task_category: result.task_category,
                    cost_estimate: result.cost_estimate
                });

                // First check if AI provided a direct task_category mapping
                if (taskCategory === 'ceiling_fan') {
                    mappedCategory = 'ceiling-fan';
                    console.log('‚úÖ Direct mapping: ceiling_fan ‚Üí ceiling-fan');
                } else if (taskCategory === 'tv_mount') {
                    mappedCategory = 'tv-mounting';
                    console.log('‚úÖ Direct mapping: tv_mount ‚Üí tv-mounting');
                } else if (taskCategory === 'light_fixture') {
                    mappedCategory = 'electrical';
                    console.log('‚úÖ Direct mapping: light_fixture ‚Üí electrical');
                } else if (taskCategory === 'faucet_showerhead') {
                    mappedCategory = 'plumbing';
                    console.log('‚úÖ Direct mapping: faucet_showerhead ‚Üí plumbing');
                } else if (taskCategory === 'furniture_assembly') {
                    mappedCategory = 'furniture-assembly';
                    console.log('‚úÖ Direct mapping: furniture_assembly ‚Üí furniture-assembly');
                } else if (taskCategory === 'curtains_blinds') {
                    mappedCategory = 'curtains-blinds';
                    console.log('‚úÖ Direct mapping: curtains_blinds ‚Üí curtains-blinds');
                } else {
                    // Fallback to text-based mapping
                    console.log('üîÑ Using text-based mapping for:', task);

                    if (task.includes('ceiling') && (task.includes('fan') || task.includes('install') || task.includes('replace'))) {
                        mappedCategory = 'ceiling-fan';
                        console.log('‚úÖ Text mapped to ceiling-fan');
                    } else if (task.includes('fan') && (task.includes('install') || task.includes('replace') || task.includes('ceiling'))) {
                        mappedCategory = 'ceiling-fan';
                        console.log('‚úÖ Text mapped to ceiling-fan (fan detected)');
                    } else if (task.includes('tv') || task.includes('mount') || task.includes('mounting')) {
                        mappedCategory = 'tv-mounting';
                    } else if (task.includes('plumb') || task.includes('faucet') || task.includes('toilet') || task.includes('leak')) {
                        mappedCategory = 'plumbing';
                    } else if (task.includes('electric') || task.includes('outlet') || task.includes('switch') || task.includes('wire')) {
                        mappedCategory = 'electrical';
                    } else if (task.includes('paint') || task.includes('wall') || task.includes('color')) {
                        mappedCategory = 'painting';
                    } else if (task.includes('furniture') || task.includes('assembly') || task.includes('ikea')) {
                        mappedCategory = 'furniture-assembly';
                    } else if (task.includes('curtain') || task.includes('blind') || task.includes('window')) {
                        mappedCategory = 'curtains-blinds';
                    } else if (task.includes('general') && task.includes('handyman')) {
                        // If AI says "General Handyman" but cost suggests specific task
                        const cost = result.cost_estimate;
                        if (cost && cost.includes('160')) {
                            // $160 suggests ceiling fan or TV mount
                            mappedCategory = 'ceiling-fan'; // Default to ceiling-fan for $160
                            console.log('‚úÖ Mapped General Handyman to ceiling-fan based on $160 cost');
                        }
                    }
                }

                console.log('üìç Final mapped category:', mappedCategory);
                selectService(mappedCategory);
            }

            // Update service data with AI results
            serviceData.aiAnalysis = true;
            closePhotoModal();

            // Update the main form to show AI analysis was completed
            const photoButton = document.querySelector('[onclick="showPhotoModal()"]');
            if (photoButton) {
                photoButton.innerHTML = `
                    <div class="flex items-center justify-center gap-2">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        <span class="ai-badge mr-2">AI</span>
                        Photo Analyzed ‚úì
                    </div>
                `;
                photoButton.classList.remove('border-dashed');
                photoButton.classList.add('bg-green-50', 'border-green-200');
            }
        }

        function showPhotoError(message) {
            document.getElementById('photoErrorMessage').textContent = message;
            document.getElementById('photoError').classList.remove('hide');
        }

        function showPhotoErrorWithRetry(message) {
            const errorMessage = document.getElementById('photoErrorMessage');

            errorMessage.innerHTML = `
                <div class="mb-4">${message}</div>
                <div class="flex gap-3 justify-center flex-wrap">
                    <button onclick="retryAnalysis()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                        üîÑ Try Again
                    </button>
                    <button onclick="retakePhoto()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors text-sm">
                        üì∑ New Photo
                    </button>
                    <button onclick="dismissPhotoError()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm">
                        ‚úï Close
                    </button>
                </div>
            `;
            document.getElementById('photoError').classList.remove('hide');
        }

        function retryAnalysis() {
            if (currentPhoto) {
                dismissPhotoError();
                // Reset analysis flag before retrying
                isAnalyzing = false;
                showToast('Retrying AI analysis...', 'info');
                setTimeout(() => analyzePhoto(), 1000);
            } else {
                showToast('No photo available to retry. Please upload a new photo.', 'warning');
                dismissPhotoError();
            }
        }

        function dismissPhotoError() {
            document.getElementById('photoError').classList.add('hide');
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result); // Return full data URI with format prefix
                reader.onerror = error => reject(error);
            });
        }

        // Location detection functions
        async function detectUserLocation() {
            console.log('üìç detectUserLocation called');
            const locationElement = document.getElementById('locationIndicator');
            console.log('üìç Location element found:', !!locationElement);

            try {
                // Check if geolocation is supported
                if (!navigator.geolocation) {
                    console.log('üìç Geolocation not supported');
                    setFallbackLocation(locationElement);
                    return;
                }

                // Check for HTTPS requirement
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    console.log('üìç HTTPS required for geolocation');
                    setFallbackLocation(locationElement);
                    return;
                }

                console.log('üìç Requesting location permission...');

                // Request user's location with timeout
                const position = await getCurrentPosition();
                const { latitude, longitude } = position.coords;

                console.log('üìç Location detected:', latitude, longitude);

                // Get address from coordinates
                const address = await reverseGeocode(latitude, longitude);
                updateLocationDisplay(locationElement, address);

            } catch (error) {
                console.log('üìç Location detection failed:', error.message);
                console.log('üìç Error details:', error);

                // Specific error messages for debugging
                if (error.code === 1) {
                    console.log('üìç User denied location permission');
                } else if (error.code === 2) {
                    console.log('üìç Location unavailable');
                } else if (error.code === 3) {
                    console.log('üìç Location timeout');
                }

                setFallbackLocation(locationElement);
            }
        }

        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                const options = {
                    enableHighAccuracy: false, // Faster response
                    timeout: 8000, // 8 second timeout
                    maximumAge: 300000 // Accept cached location up to 5 minutes old
                };

                navigator.geolocation.getCurrentPosition(resolve, reject, options);
            });
        }

        async function reverseGeocode(lat, lon) {
            try {
                // Using OpenStreetMap Nominatim (free, no API key required)
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`);

                if (!response.ok) {
                    throw new Error('Geocoding service unavailable');
                }

                const data = await response.json();

                // Extract city and county/state info
                const address = data.address || {};
                const city = address.city || address.town || address.village || address.hamlet;
                const county = address.county;
                const state = address.state;

                // Format location string
                let location = '';
                if (city && county) {
                    location = `${city}, ${county}`;
                } else if (city && state) {
                    location = `${city}, ${state}`;
                } else if (county && state) {
                    location = `${county}, ${state}`;
                } else if (city) {
                    location = city;
                } else if (county) {
                    location = county;
                } else {
                    throw new Error('Unable to determine location');
                }

                return location;

            } catch (error) {
                console.log('Reverse geocoding failed:', error);
                throw error;
            }
        }

        function updateLocationDisplay(element, address) {
            if (element) {
                // Check if location is in service area
                const isInServiceArea = checkServiceArea(address);

                if (isInServiceArea) {
                    element.textContent = address;
                    element.style.color = '#22c55e';
                    console.log('üìç Location updated:', address);
                    showToast(`Location detected: ${address}`, 'success');

                    // Initialize main page map
                    initializeMainPageMap();
                } else {
                    element.textContent = `${address} (Outside service area)`;
                    element.style.color = '#f59e0b';
                    console.log('üìç Location outside service area:', address);
                    showToast(`Location detected outside service area: ${address}`, 'warning');
                }
            }
        }

        function checkServiceArea(address) {
            const lowerAddress = address.toLowerCase();
            const serviceAreas = [
                'palm beach', 'broward', 'miami-dade', 'miami dade',
                'west palm beach', 'boca raton', 'delray beach', 'boynton beach',
                'fort lauderdale', 'hollywood', 'pembroke pines', 'coral springs',
                'miami', 'aventura', 'coral gables', 'homestead', 'hialeah',
                'deerfield beach', 'pompano beach', 'plantation', 'sunrise',
                'davie', 'weston', 'miramar', 'cooper city'
            ];

            return serviceAreas.some(area => lowerAddress.includes(area));
        }

        function showServiceAreaNotice() {
            // Add a subtle notice about service area
            setTimeout(() => {
                const notice = document.createElement('div');
                notice.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-orange-100 border border-orange-300 text-orange-800 px-4 py-2 rounded-lg shadow-lg z-50 text-sm';
                notice.innerHTML = `
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span>We primarily serve Palm Beach, Broward & Miami-Dade counties</span>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-2 hover:text-orange-900">‚úï</button>
                    </div>
                `;
                document.body.appendChild(notice);

                // Auto-remove after 8 seconds
                setTimeout(() => {
                    if (notice.parentElement) {
                        notice.remove();
                    }
                }, 8000);
            }, 2000);
        }

        function setFallbackLocation(element) {
            if (element) {
                element.textContent = 'Palm Beach, Broward & Miami-Dade';
                element.style.color = ''; // Default color
                console.log('üìç Using fallback location');

                // Initialize main page map
                initializeMainPageMap();
            }
        }

        // Toast Notification System
        function showToast(message, type = 'success', duration = 4000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';

            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="text-lg">${icon}</span>
                    <div class="flex-1">
                        <p class="font-medium text-gray-900">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            `;

            document.body.appendChild(toast);

            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 100);

            // Auto remove
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Progress Management
        function updateProgress(step) {
            currentBookingStep = step;

            // Reset all steps
            for (let i = 1; i <= 4; i++) {
                const stepElement = document.getElementById(`step${i}`);
                const connector = document.getElementById(`connector${i}`);

                if (stepElement) {
                    const circle = stepElement.querySelector('div');
                    const label = stepElement.querySelector('span');

                    if (i < step) {
                        // Completed step
                        circle.className = 'w-8 h-8 rounded-full bg-green-600 text-white flex items-center justify-center text-sm font-semibold';
                        circle.innerHTML = '‚úì';
                        if (label) label.className = 'ml-2 text-sm font-medium text-green-700 hidden sm:inline';
                        if (connector) connector.className = 'w-8 h-0.5 bg-green-600 mx-2 sm:mx-4';
                    } else if (i === step) {
                        // Current step
                        circle.className = 'w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-sm font-semibold';
                        circle.innerHTML = i;
                        if (label) label.className = 'ml-2 text-sm font-medium text-gray-900 hidden sm:inline';
                        if (connector) connector.className = 'w-8 h-0.5 bg-gray-200 mx-2 sm:mx-4';
                    } else {
                        // Future step
                        circle.className = 'w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center text-sm font-semibold';
                        circle.innerHTML = i;
                        if (label) label.className = 'ml-2 text-sm font-medium text-gray-500 hidden sm:inline';
                        if (connector) connector.className = 'w-8 h-0.5 bg-gray-200 mx-2 sm:mx-4';
                    }
                }
            }
        }

        // Loading States
        function showLoading(message = 'Loading...') {
            const overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.className = 'loading-overlay';
            overlay.innerHTML = `
                <div class="text-center">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-gray-600 font-medium">${message}</p>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // Accessibility helpers
        function handleEnterKey(event, callback) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                callback();
            }
        }

        // Mobile-first sticky bottom bar for booking
        function showStickyBottomBar(text, action, price = null) {
            // Remove existing bottom bar
            const existing = document.getElementById('stickyBottomBar');
            if (existing) existing.remove();

            const bottomBar = document.createElement('div');
            bottomBar.id = 'stickyBottomBar';
            bottomBar.className = 'sticky-bottom-bar md:hidden';

            const priceText = price ? ` - ${price}` : '';
            bottomBar.innerHTML = `
                <button onclick="${action}" class="btn-primary w-full py-4 text-lg font-semibold">
                    ${text}${priceText}
                </button>
            `;

            document.body.appendChild(bottomBar);
        }

        function hideStickyBottomBar() {
            const bottomBar = document.getElementById('stickyBottomBar');
            if (bottomBar) bottomBar.remove();
        }

        // Utility functions
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const hamburgerIcon = document.querySelector('button[onclick="toggleMobileMenu()"] svg');

            if (mobileMenu.classList.contains('hidden')) {
                // Show mobile menu
                mobileMenu.classList.remove('hidden');
                // Transform hamburger to X
                if (hamburgerIcon) {
                    hamburgerIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>';
                }
            } else {
                // Hide mobile menu
                mobileMenu.classList.add('hidden');
                // Transform X back to hamburger
                if (hamburgerIcon) {
                    hamburgerIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>';
                }
            }
        }

        function showLoginModal() {
            // Redirect to admin dashboard
            window.location.href = 'admin.html';
        }

        function showAllServices() {
            const content = document.getElementById('serviceContent');
            document.getElementById('landingScreen').classList.add('hide');
            document.getElementById('serviceFlow').classList.remove('hide');
            currentStep = 'services';
            updateProgress(1); // Step 1: Service Selection

            content.innerHTML = `
                <div class="slide-up">
                    <h2 class="text-2xl font-bold mb-2">All Services</h2>
                    <p class="text-gray-600 mb-6">Choose the service you need help with</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                        <div class="service-card p-4" onclick="selectService('light-plumbing')">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex items-center justify-center">
                                    <img src="/images/faucet.png" alt="Light Plumbing" class="w-6 h-6">
                                </div>
                                <div>
                                    <div class="font-semibold">Light Plumbing</div>
                                    <div class="text-sm text-gray-600">Faucets, toilets, minor leaks</div>
                                </div>
                            </div>
                        </div>

                        <div class="service-card p-4" onclick="selectService('electrical')">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex items-center justify-center">
                                    <img src="/images/ceiling_mounted_light_fixture.png" alt="Electrical" class="w-6 h-6">
                                </div>
                                <div>
                                    <div class="font-semibold">Electrical</div>
                                    <div class="text-sm text-gray-600">Outlets, switches, light fixtures</div>
                                </div>
                            </div>
                        </div>

                        <div class="service-card p-4" onclick="selectService('mounting')">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex items-center justify-center">
                                    <img src="/images/tv.png" alt="TV Mounting" class="w-6 h-6">
                                </div>
                                <div>
                                    <div class="font-semibold">TV Mounting</div>
                                    <div class="text-sm text-gray-600">Wall mounting, cable management</div>
                                </div>
                            </div>
                        </div>

                        <div class="service-card p-4" onclick="selectService('furniture')">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex items-center justify-center">
                                    <img src="/images/furniture.png" alt="Furniture Assembly" class="w-6 h-6">
                                </div>
                                <div>
                                    <div class="font-semibold">Furniture Assembly</div>
                                    <div class="text-sm text-gray-600">IKEA, office furniture, beds</div>
                                </div>
                            </div>
                        </div>

                        <div class="service-card p-4" onclick="selectService('painting')">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex items-center justify-center">
                                    <img src="/images/painting.png" alt="Painting" class="w-6 h-6">
                                </div>
                                <div>
                                    <div class="font-semibold">Painting</div>
                                    <div class="text-sm text-gray-600">Touch-ups, small rooms, trim</div>
                                </div>
                            </div>
                        </div>

                        <div class="service-card p-4" onclick="selectService('appliances')">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex items-center justify-center">
                                    <img src="/images/appliance.png" alt="Appliances" class="w-6 h-6">
                                </div>
                                <div>
                                    <div class="font-semibold">Appliances</div>
                                    <div class="text-sm text-gray-600">Installation, basic repairs</div>
                                </div>
                            </div>
                        </div>

                        <div class="service-card p-4" onclick="selectService('repair')">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex items-center justify-center">
                                    <img src="/images/small_hole_wall.png" alt="General Repair" class="w-6 h-6">
                                </div>
                                <div>
                                    <div class="font-semibold">General Repair</div>
                                    <div class="text-sm text-gray-600">Doors, windows, drywall</div>
                                </div>
                            </div>
                        </div>

                        <div class="service-card p-4" onclick="selectService('ceiling-fan')">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex items-center justify-center">
                                    <img src="/images/ceiling_fan.png" alt="Ceiling Fan" class="w-6 h-6">
                                </div>
                                <div>
                                    <div class="font-semibold">Ceiling Fan</div>
                                    <div class="text-sm text-gray-600">Install/replace ceiling fans</div>
                                </div>
                            </div>
                        </div>

                        <div class="service-card p-4" onclick="selectService('curtains-blinds')">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex items-center justify-center">
                                    <img src="/images/window_blinds.png" alt="Curtain Rods / Blinds" class="w-6 h-6">
                                </div>
                                <div>
                                    <div class="font-semibold">Curtain Rods / Blinds</div>
                                    <div class="text-sm text-gray-600">Mount curtain rods, install blinds</div>
                                </div>
                            </div>
                        </div>

                        <div class="service-card p-4" onclick="selectService('installation')">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex items-center justify-center">
                                    <img src="/images/wall_shelf.png" alt="Installations" class="w-6 h-6">
                                </div>
                                <div>
                                    <div class="font-semibold">Installations</div>
                                    <div class="text-sm text-gray-600">Shelves, hardware, fixtures</div>
                                </div>
                            </div>
                        </div>

                        <div class="service-card p-4" onclick="selectService('outdoor')">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex items-center justify-center">
                                    <img src="/images/outdoor.png" alt="Outdoor" class="w-6 h-6">
                                </div>
                                <div>
                                    <div class="font-semibold">Outdoor</div>
                                    <div class="text-sm text-gray-600">Deck repairs, outdoor fixtures</div>
                                </div>
                            </div>
                        </div>

                        <div class="service-card p-4" onclick="selectService('other')">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex items-center justify-center">
                                    <img src="/images/question_mark.png" alt="Other" class="w-6 h-6">
                                </div>
                                <div>
                                    <div class="font-semibold">Other</div>
                                    <div class="text-sm text-gray-600">Describe your specific need</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            updateProgress(1); // Step 1: Service Selection
        }

        // Handle click outside modal to close
        function closePhotoModalIfClickedOutside(event) {
            if (event.target === event.currentTarget) {
                console.log('üñ±Ô∏è Clicked outside modal, closing...');
                closePhotoModal();
            }
        }

        // Main Page Map Functions
        let mainPageMap = null;
        let mainPageMarkers = [];
        let selectedMainPageMarker = null;

        async function initializeMainPageMap() {
            try {
                console.log('üó∫Ô∏è Initializing main page map...');

                // Get user location
                const userLocation = await getUserLocationForMap();

                // Hide loading state and show map
                document.getElementById('mapLoadingState').style.display = 'none';
                document.getElementById('mainHandymanMap').style.display = 'block';
                document.getElementById('recenterButton').style.display = 'block';

                // Initialize map
                if (mainPageMap) {
                    mainPageMap.remove();
                }

                mainPageMap = L.map('mainHandymanMap', {
                    zoomControl: true,
                    scrollWheelZoom: true
                }).setView(userLocation, 11);

                // Add map tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap'
                }).addTo(mainPageMap);

                // Add user location marker
                const userIcon = L.divIcon({
                    className: 'user-location-marker',
                    html: `<div style="background: #3b82f6; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });

                L.marker(userLocation, { icon: userIcon })
                    .addTo(mainPageMap)
                    .bindPopup('üìç Your Location');

                // Generate and add handyman markers
                const handymenData = generateAnonymousHandymanLocations(userLocation);
                addMainPageHandymanMarkers(handymenData);

                // Show compact list
                updateCompactHandymanList(handymenData);
                document.getElementById('compactHandymanList').style.display = 'block';

                console.log('‚úÖ Main page map initialized');

            } catch (error) {
                console.error('‚ùå Error initializing main page map:', error);
                document.getElementById('mapLoadingState').innerHTML = `
                    <div class="text-center text-red-500">
                        <div class="text-2xl mb-1">‚ùå</div>
                        <div class="text-xs">Map unavailable</div>
                    </div>
                `;
            }
        }

        function generateAnonymousHandymanLocations(userLocation) {
            const [userLat, userLng] = userLocation;

            // Anonymous handyman data with just city and skills
            const handymenData = [
                // Miami-Dade handymen
                { id: "h1", city: "Miami", lat: 25.7617, lng: -80.1918, status: "available", rating: 4.8, experience: 5, specialties: ["Plumbing", "Electrical"] },
                { id: "h2", city: "Coral Gables", lat: 25.7214, lng: -80.2683, status: "available", rating: 4.9, experience: 8, specialties: ["Painting", "General Repair"] },
                { id: "h4", city: "Homestead", lat: 25.4687, lng: -80.4776, status: "available", rating: 4.6, experience: 6, specialties: ["Ceiling Fan", "Electrical"] },

                // Broward handymen
                { id: "h5", city: "Fort Lauderdale", lat: 26.1224, lng: -80.1373, status: "available", rating: 4.8, experience: 7, specialties: ["Plumbing", "General Repair"] },
                { id: "h6", city: "Hollywood", lat: 26.0112, lng: -80.1495, status: "available", rating: 4.5, experience: 4, specialties: ["Painting", "Appliances"] },
                { id: "h8", city: "Plantation", lat: 26.1267, lng: -80.2331, status: "available", rating: 4.9, experience: 9, specialties: ["Electrical", "Ceiling Fan"] },

                // Palm Beach handymen
                { id: "h9", city: "West Palm Beach", lat: 26.7153, lng: -80.0534, status: "available", rating: 4.8, experience: 6, specialties: ["General Repair", "Painting"] },
                { id: "h10", city: "Boca Raton", lat: 26.3683, lng: -80.1289, status: "available", rating: 4.9, experience: 10, specialties: ["Plumbing", "Electrical"] },
                { id: "h12", city: "Jupiter", lat: 26.9342, lng: -80.0942, status: "available", rating: 4.7, experience: 7, specialties: ["Appliances", "General Repair"] }
            ];

            // Add slight location variance and calculate distances
            return handymenData.map(handyman => {
                const adjustedLat = handyman.lat + (Math.random() - 0.5) * 0.02;
                const adjustedLng = handyman.lng + (Math.random() - 0.5) * 0.02;
                const distance = calculateDistance(userLat, userLng, adjustedLat, adjustedLng);

                return {
                    ...handyman,
                    lat: adjustedLat,
                    lng: adjustedLng,
                    distance: distance
                };
            });
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 3959; // Earth's radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function addMainPageHandymanMarkers(handymenData) {
            // Clear existing markers
            mainPageMarkers.forEach(marker => mainPageMap.removeLayer(marker));
            mainPageMarkers = [];

            handymenData.forEach(handyman => {
                const isAvailable = handyman.status === 'available';

                const markerIcon = L.divIcon({
                    className: 'handyman-marker',
                    html: `
                        <div style="
                            background: ${isAvailable ? '#10b981' : '#6b7280'};
                            width: 18px;
                            height: 18px;
                            border-radius: 50%;
                            border: 2px solid white;
                            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 8px;
                            font-weight: bold;
                        ">
                            üî®
                        </div>
                    `,
                    iconSize: [18, 18],
                    iconAnchor: [9, 9]
                });

                const marker = L.marker([handyman.lat, handyman.lng], {
                    icon: markerIcon,
                    handymanData: handyman
                }).addTo(mainPageMap);

                // Click handler
                marker.on('click', () => {
                    selectMainPageHandyman(handyman, marker);
                });

                mainPageMarkers.push(marker);
            });
        }

        function selectMainPageHandyman(handyman, marker) {
            console.log('üéØ Main page handyman selected:', handyman.city);

            // Reset previous selection
            if (selectedMainPageMarker) {
                selectedMainPageMarker.setIcon(createCompactHandymanIcon(selectedMainPageMarker.options.handymanData.status, false));
            }

            // Highlight selected marker
            selectedMainPageMarker = marker;
            marker.setIcon(createCompactHandymanIcon(handyman.status, true));

            // Show compact details
            const detailsContainer = document.getElementById('compactHandymanDetails');
            detailsContainer.style.display = 'block';
            detailsContainer.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-medium text-sm">${handyman.city}</span>
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${
                                handyman.status === 'available'
                                    ? 'bg-green-100 text-green-700'
                                    : 'bg-gray-100 text-gray-600'
                            }">
                                ${handyman.status === 'available' ? '‚úÖ Available' : 'üîí Busy'}
                            </span>
                        </div>
                        <div class="text-xs text-gray-600 mb-2">
                            ‚≠ê ${handyman.rating} ‚Ä¢ ${handyman.experience}y exp ‚Ä¢ ~${Math.round(Math.random() * 5 + 1)} mi
                        </div>
                        <div class="flex flex-wrap gap-1">
                            ${handyman.specialties.slice(0, 2).map(specialty =>
                                `<span class="bg-blue-100 text-blue-700 px-1 py-0.5 rounded text-xs">${specialty}</span>`
                            ).join('')}
                            ${handyman.specialties.length > 2 ? `<span class="text-gray-500 text-xs">+${handyman.specialties.length - 2}</span>` : ''}
                        </div>
                    </div>
                    <button onclick="clearMainPageHandymanSelection()" class="text-gray-400 hover:text-gray-600 ml-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="mt-2">
                    <button onclick="bookMainPageHandyman('${handyman.id}')"
                            class="w-full ${handyman.status === 'available'
                                ? 'bg-blue-600 hover:bg-blue-700 text-white'
                                : 'bg-gray-300 text-gray-500 cursor-not-allowed'} py-1.5 px-3 rounded transition-colors text-sm"
                            ${handyman.status !== 'available' ? 'disabled' : ''}>
                        ${handyman.status === 'available' ? 'Select & Continue' : 'Currently Unavailable'}
                    </button>
                </div>
            `;
        }

        function createCompactHandymanIcon(status, isSelected = false) {
            const isAvailable = status === 'available';
            const size = isSelected ? 24 : 18;
            const borderWidth = isSelected ? 3 : 2;

            return L.divIcon({
                className: 'handyman-marker',
                html: `
                    <div style="
                        background: ${isAvailable ? '#10b981' : '#6b7280'};
                        width: ${size}px;
                        height: ${size}px;
                        border-radius: 50%;
                        border: ${borderWidth}px solid ${isSelected ? '#3b82f6' : 'white'};
                        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-size: ${size > 18 ? '10px' : '8px'};
                        font-weight: bold;
                        cursor: pointer;
                    ">
                        üî®
                    </div>
                `,
                iconSize: [size, size],
                iconAnchor: [size/2, size/2]
            });
        }

        function updateCompactHandymanList(handymenData) {
            const list = document.getElementById('compactHandymanList');
            const availableHandymen = handymenData
                .filter(h => h.status === 'available')
                .sort((a, b) => a.distance - b.distance)
                .slice(0, 3); // Show only closest 3 available handymen

            list.innerHTML = `
                <div class="space-y-3">
                    <!-- Available Handymen -->
                    <div>
                        <div class="text-sm font-semibold text-green-700 mb-2 flex items-center">
                            <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                            ${availableHandymen.length} Closest Available
                        </div>
                        ${availableHandymen.map(handyman => `
                            <div class="bg-green-50 border border-green-200 p-3 rounded-lg mb-2 cursor-pointer hover:bg-green-100 transition-colors"
                                 onclick="selectMainPageHandymanFromList('${handyman.id}')">
                                <div class="space-y-1">
                                    <div class="font-medium text-sm text-gray-800">${handyman.city}</div>
                                    <div class="text-xs text-gray-600">‚≠ê ${handyman.rating} ‚Ä¢ ${handyman.experience}y</div>
                                    <div class="text-xs text-gray-600">${Math.round(handyman.distance)} mi away</div>
                                    <div class="flex flex-wrap gap-1 mt-1">
                                        ${handyman.specialties.slice(0, 2).map(specialty =>
                                            `<span class="bg-blue-100 text-blue-700 px-1 py-0.5 rounded text-xs">${specialty}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                </div>
            `;
        }

        function selectMainPageHandymanFromList(handymanId) {
            const marker = mainPageMarkers.find(m => m.options.handymanData.id === handymanId);
            if (marker) {
                selectMainPageHandyman(marker.options.handymanData, marker);
            }
        }

        function clearMainPageHandymanSelection() {
            if (selectedMainPageMarker) {
                selectedMainPageMarker.setIcon(createCompactHandymanIcon(selectedMainPageMarker.options.handymanData.status, false));
                selectedMainPageMarker = null;
            }
            document.getElementById('compactHandymanDetails').style.display = 'none';
        }

        async function recenterMainPageMap() {
            if (!mainPageMap) return;

            try {
                // Get fresh user location
                const userLocation = await getUserLocationForMap();
                const [lat, lng] = userLocation;

                // Animate to user location
                mainPageMap.setView([lat, lng], 11, {
                    animate: true,
                    duration: 1.0
                });

                console.log('üéØ Map recentered to user location:', lat, lng);
            } catch (error) {
                console.error('Failed to recenter map:', error);
                // Fallback to default South Florida location
                mainPageMap.setView([26.1224, -80.1373], 10, {
                    animate: true,
                    duration: 1.0
                });
            }
        }

        function bookMainPageHandyman(handymanId) {
            const handymanData = mainPageMarkers.find(m => m.options.handymanData.id === handymanId)?.options.handymanData;
            if (handymanData && handymanData.status === 'available') {
                console.log('üìÖ Booking from main page map:', handymanData.city);

                // Store selected handyman data
                serviceData.selectedHandyman = handymanData;
                serviceData.preferredArea = handymanData.city;

                showToast(`Handyman selected in ${handymanData.city}! Let's get started.`, 'success');

                // Proceed to service selection
                setTimeout(() => {
                    startServiceFlow();
                }, 1000);
            }
        }

        // Legacy modal functions (keep for compatibility)
        function showHandymanMapButton() {
            // No longer needed - map is directly embedded
        }

        function showHandymanDistribution() {
            console.log('üó∫Ô∏è Opening handyman distribution map...');
            const modal = document.getElementById('handymanMapModal');
            if (modal) {
                modal.classList.remove('hide');
                modal.style.display = 'flex';
                loadHandymanDistribution();
                console.log('‚úÖ Handyman map modal opened');
            }
        }

        function closeHandymanMap() {
            console.log('üîÑ Closing handyman map...');
            const modal = document.getElementById('handymanMapModal');
            if (modal) {
                modal.classList.add('hide');
                modal.style.display = 'none';
                console.log('‚úÖ Handyman map closed');
            }
        }

        function closeHandymanMapIfClickedOutside(event) {
            if (event.target === event.currentTarget) {
                console.log('üñ±Ô∏è Clicked outside handyman map, closing...');
                closeHandymanMap();
            }
        }

        let handymanMap = null;
        let handymanMarkers = [];
        let selectedHandymanMarker = null;

        async function loadHandymanDistribution() {
            try {
                console.log('üó∫Ô∏è Loading Uber-style handyman map...');

                // Get user's detected location for map center
                const userLocation = await getUserLocationForMap();

                // Initialize Leaflet map
                if (handymanMap) {
                    handymanMap.remove(); // Clean up existing map
                }

                handymanMap = L.map('handymanMapContainer').setView(userLocation, 11);

                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(handymanMap);

                // Add user location marker
                const userIcon = L.divIcon({
                    className: 'user-location-marker',
                    html: `<div style="background: #3b82f6; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });

                L.marker(userLocation, { icon: userIcon })
                    .addTo(handymanMap)
                    .bindPopup('üìç Your Location')
                    .openPopup();

                // Generate realistic handyman locations around South Florida
                const handymenData = generateHandymanLocations(userLocation);

                // Clear existing markers
                handymanMarkers.forEach(marker => handymanMap.removeLayer(marker));
                handymanMarkers = [];

                // Add handyman markers
                handymenData.forEach((handyman, index) => {
                    const isAvailable = handyman.status === 'available';

                    const markerIcon = L.divIcon({
                        className: 'handyman-marker',
                        html: `
                            <div style="
                                background: ${isAvailable ? '#10b981' : '#6b7280'};
                                width: 24px;
                                height: 24px;
                                border-radius: 50%;
                                border: 2px solid white;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-size: 12px;
                                font-weight: bold;
                            ">
                                üî®
                            </div>
                        `,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });

                    const marker = L.marker([handyman.lat, handyman.lng], {
                        icon: markerIcon,
                        handymanData: handyman
                    }).addTo(handymanMap);

                    // Click handler for handyman markers
                    marker.on('click', () => {
                        selectHandyman(handyman, marker);
                    });

                    handymanMarkers.push(marker);
                });

                // Populate handyman list
                updateHandymanList(handymenData);

                console.log('‚úÖ Uber-style handyman map loaded successfully');

            } catch (error) {
                console.error('‚ùå Error loading handyman map:', error);
                const mapContainer = document.getElementById('handymanMapContainer');
                mapContainer.innerHTML = `
                    <div class="flex items-center justify-center h-full text-center text-red-600">
                        <div>
                            <div class="text-4xl mb-2">‚ùå</div>
                            <div>Error loading map</div>
                            <div class="text-sm mt-2">Please try again later</div>
                        </div>
                    </div>
                `;
            }
        }

        async function getUserLocationForMap() {
            try {
                const position = await getCurrentPosition();
                return [position.coords.latitude, position.coords.longitude];
            } catch (error) {
                console.log('Using default South Florida location for map');
                return [26.1224, -80.1373]; // Fort Lauderdale center
            }
        }

        function generateHandymanLocations(userLocation) {
            const [userLat, userLng] = userLocation;

            const handymenData = [
                // Miami-Dade handymen
                { id: "m1", city: "Miami", lat: 25.7617, lng: -80.1918, status: "available", rating: 4.8, experience: 5, specialties: ["Plumbing", "Electrical"] },
                { id: "m2", city: "Coral Gables", lat: 25.7214, lng: -80.2683, status: "available", rating: 4.9, experience: 8, specialties: ["Painting", "General Repair"] },
                { id: "m4", city: "Homestead", lat: 25.4687, lng: -80.4776, status: "available", rating: 4.6, experience: 6, specialties: ["Ceiling Fan", "Electrical"] },

                // Broward handymen
                { id: "m5", city: "Fort Lauderdale", lat: 26.1224, lng: -80.1373, status: "available", rating: 4.8, experience: 7, specialties: ["Plumbing", "General Repair"] },
                { id: "m6", city: "Hollywood", lat: 26.0112, lng: -80.1495, status: "available", rating: 4.5, experience: 4, specialties: ["Painting", "Appliances"] },
                { id: "m8", city: "Plantation", lat: 26.1267, lng: -80.2331, status: "available", rating: 4.9, experience: 9, specialties: ["Electrical", "Ceiling Fan"] },

                // Palm Beach handymen
                { id: "m9", city: "West Palm Beach", lat: 26.7153, lng: -80.0534, status: "available", rating: 4.8, experience: 6, specialties: ["General Repair", "Painting"] },
                { id: "m10", city: "Boca Raton", lat: 26.3683, lng: -80.1289, status: "available", rating: 4.9, experience: 10, specialties: ["Plumbing", "Electrical"] },
                { id: "m12", city: "Jupiter", lat: 26.9342, lng: -80.0942, status: "available", rating: 4.7, experience: 7, specialties: ["Appliances", "General Repair"] }
            ];

            // Add slight location variance for realism
            return handymenData.map(handyman => ({
                ...handyman,
                lat: handyman.lat + (Math.random() - 0.5) * 0.02, // ¬±0.01 degree variance
                lng: handyman.lng + (Math.random() - 0.5) * 0.02,
                id: Math.random().toString(36).substr(2, 9)
            }));
        }

        function selectHandyman(handyman, marker) {
            console.log('üéØ Handyman selected:', handyman.city);

            // Reset previous selection
            if (selectedHandymanMarker) {
                selectedHandymanMarker.setIcon(createHandymanIcon(selectedHandymanMarker.options.handymanData.status, false));
            }

            // Highlight selected marker
            selectedHandymanMarker = marker;
            marker.setIcon(createHandymanIcon(handyman.status, true));

            // Show handyman details
            const detailsContainer = document.getElementById('selectedHandymanDetails');
            detailsContainer.style.display = 'block';
            detailsContainer.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <h4 class="font-semibold text-lg">${handyman.city} Handyman</h4>
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${
                                handyman.status === 'available'
                                    ? 'bg-green-100 text-green-800'
                                    : 'bg-gray-100 text-gray-600'
                            }">
                                ${handyman.status === 'available' ? '‚úÖ Available' : 'üîí Busy'}
                            </span>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm mb-3">
                            <div><span class="text-gray-600">Location:</span> ${handyman.city}</div>
                            <div><span class="text-gray-600">Rating:</span> <span class="text-yellow-600">‚≠ê ${handyman.rating}</span></div>
                            <div><span class="text-gray-600">Experience:</span> ${handyman.experience} years</div>
                            <div><span class="text-gray-600">Distance:</span> ~${Math.round(Math.random() * 5 + 1)} miles</div>
                        </div>
                        <div class="mb-3">
                            <span class="text-gray-600 text-sm">Specialties: </span>
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${handyman.specialties.map(specialty =>
                                    `<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs">${specialty}</span>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                    <button onclick="clearHandymanSelection()" class="text-gray-400 hover:text-gray-600 ml-4">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="flex gap-3 mt-4">
                    <button onclick="bookHandyman('${handyman.id}')"
                            class="flex-1 ${handyman.status === 'available'
                                ? 'bg-blue-600 hover:bg-blue-700 text-white'
                                : 'bg-gray-300 text-gray-500 cursor-not-allowed'} py-2 px-4 rounded transition-colors"
                            ${handyman.status !== 'available' ? 'disabled' : ''}>
                        ${handyman.status === 'available' ? 'Book This Handyman' : 'Currently Unavailable'}
                    </button>
                    <button onclick="showHandymanProfile('${handyman.id}')" class="bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-4 rounded transition-colors">
                        View Profile
                    </button>
                </div>
            `;

            // Center map on selected handyman
            handymanMap.setView([handyman.lat, handyman.lng], 13);
        }

        function createHandymanIcon(status, isSelected = false) {
            const isAvailable = status === 'available';
            const size = isSelected ? 32 : 24;
            const borderWidth = isSelected ? 3 : 2;

            return L.divIcon({
                className: 'handyman-marker',
                html: `
                    <div style="
                        background: ${isAvailable ? '#10b981' : '#6b7280'};
                        width: ${size}px;
                        height: ${size}px;
                        border-radius: 50%;
                        border: ${borderWidth}px solid ${isSelected ? '#3b82f6' : 'white'};
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-size: ${size > 24 ? '14px' : '12px'};
                        font-weight: bold;
                        cursor: pointer;
                    ">
                        üî®
                    </div>
                `,
                iconSize: [size, size],
                iconAnchor: [size/2, size/2]
            });
        }

        function updateHandymanList(handymenData) {
            const handymanList = document.getElementById('handymanList');
            const availableHandymen = handymenData.filter(h => h.status === 'available');

            handymanList.innerHTML = `
                ${availableHandymen.length > 0 ? `
                    <div class="mb-4">
                        <h5 class="text-sm font-medium text-green-700 mb-2">‚úÖ Available Now (${availableHandymen.length})</h5>
                        ${availableHandymen.map(handyman => createHandymanListItem(handyman)).join('')}
                    </div>
                ` : ''}

            `;
        }

        function createHandymanListItem(handyman) {
            return `
                <div class="bg-white p-3 rounded-lg border border-gray-200 hover:border-blue-300 transition-colors cursor-pointer"
                     onclick="selectHandymanFromList('${handyman.id}')">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-medium">${handyman.city} Handyman</div>
                            <div class="text-sm text-gray-600">‚≠ê ${handyman.rating} ‚Ä¢ ${handyman.experience}y exp ‚Ä¢ ${handyman.specialties[0]}</div>
                        </div>
                        <div class="text-sm ${handyman.status === 'available' ? 'text-green-600' : 'text-gray-500'}">
                            ~${Math.round(Math.random() * 5 + 1)} mi
                        </div>
                    </div>
                </div>
            `;
        }

        function selectHandymanFromList(handymanId) {
            const marker = handymanMarkers.find(m => m.options.handymanData.id === handymanId);
            if (marker) {
                selectHandyman(marker.options.handymanData, marker);
            }
        }

        function clearHandymanSelection() {
            if (selectedHandymanMarker) {
                selectedHandymanMarker.setIcon(createHandymanIcon(selectedHandymanMarker.options.handymanData.status, false));
                selectedHandymanMarker = null;
            }
            document.getElementById('selectedHandymanDetails').style.display = 'none';
        }

        function bookHandyman(handymanId) {
            const handyman = handymanMarkers.find(m => m.options.handymanData.id === handymanId)?.options.handymanData;
            if (handyman && handyman.status === 'available') {
                console.log('üìÖ Booking handyman:', handyman.name);
                closeHandymanMap();

                // Store selected handyman data
                serviceData.selectedHandyman = handyman;

                showToast(`Great! Starting booking process with ${handyman.city} handyman`, 'success');

                // Proceed to service flow with handyman selected
                setTimeout(() => {
                    startServiceFlow();
                }, 1000);
            }
        }

        function showHandymanProfile(handymanId) {
            const handyman = handymanMarkers.find(m => m.options.handymanData.id === handymanId)?.options.handymanData;
            if (handyman) {
                showToast(`Handyman profile coming soon!`, 'info');
            }
        }

        function selectAreaAndBook(city) {
            console.log(`üéØ User selected ${city} for booking`);
            closeHandymanMap();

            // Update service data with selected area
            serviceData.preferredArea = city;

            // Show toast and proceed to service selection
            showToast(`Great! We'll prioritize handymen in ${city} for your booking`, 'success');

            // Trigger service selection flow
            setTimeout(() => {
                startServiceFlow();
            }, 1000);
        }

        // Handle escape key to close modals
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const photoModal = document.getElementById('photoModal');
                const handymanModal = document.getElementById('handymanMapModal');

                if (handymanModal && !handymanModal.classList.contains('hide')) {
                    console.log('‚å®Ô∏è Escape key pressed, closing handyman map...');
                    closeHandymanMap();
                } else if (photoModal && !photoModal.classList.contains('hide')) {
                    console.log('‚å®Ô∏è Escape key pressed, closing photo modal...');
                    closePhotoModal();
                }
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('SendAHandyman Uber-style interface loaded');

            // Set current year in footer
            const yearElement = document.getElementById('year');
            if (yearElement) {
                yearElement.textContent = new Date().getFullYear();
            }

            // Initialize location detection
            detectUserLocation();

            // Update availability text based on day of week
            updateAvailabilityText();

            // Debug: Test Sunday logic with actual date
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            console.log('üóìÔ∏è Debug info:', {
                today: now.toDateString(),
                tomorrow: tomorrow.toDateString(),
                tomorrowDay: tomorrow.getDay(),
                isTomorrowSunday: tomorrow.getDay() === 0
            });

            // Ensure landing screen is visible and other screens are hidden
            document.getElementById('landingScreen').classList.remove('hide');
            document.getElementById('serviceFlow').classList.add('hide');

            // Force hide photo modal with multiple methods
            const photoModal = document.getElementById('photoModal');
            if (photoModal) {
                photoModal.classList.add('hide');
                photoModal.style.display = 'none'; // Force hide with inline style
                console.log('üîí Photo modal force hidden');
            }

            // Reset current step
            currentStep = 'landing';

            console.log('‚úÖ Landing page initialized correctly');
        });

        // Payment Modal Functions
        let stripe, elements, paymentElement;
        let paymentIntentId = null;
        let paymentElementReady = false;
        const STRIPE_PUBLISHABLE_KEY = 'pk_live_51Rz41zHQ4TkcNcqv0IXVWGjAjLo8EoSkGO2fbeINw6U23GsLSiaOsHYVSEPwlJbR2EZ515tqPDJcRPvDBYSdv2Wy00N7DPqhI3';

        // Initialize Stripe
        function initializeStripe() {
            console.log('üí≥ Stripe Configuration:', STRIPE_PUBLISHABLE_KEY ? '‚úÖ Key Present' : '‚ùå Key Missing');
            if (typeof Stripe !== 'undefined') {
                try {
                    stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
                    console.log('‚úÖ Stripe initialized successfully');
                } catch (error) {
                    console.error('‚ùå Stripe initialization failed:', error);
                }
            } else {
                setTimeout(initializeStripe, 1000);
            }
        }

        async function showPaymentModal() {
            if (!serviceData.selectedTimeSlot || !serviceData.pricing) {
                showToast('Please select a time slot first', 'error');
                return;
            }

            if (!stripe) {
                showToast('Payment system is loading. Please try again.', 'warning');
                initializeStripe();
                return;
            }

            const finalAmount = serviceData.pricing.total;

            // Track payment started
            HandymanAnalytics.trackPaymentStarted(finalAmount);

            document.getElementById('paymentAmount').textContent = '$' + finalAmount.toFixed(0);
            document.getElementById('paymentTiming').textContent = serviceData.selectedTimeSlot.windowLabel;
            document.getElementById('paymentModal').classList.remove('hidden');

            console.log('üí≥ Setting up payment intent for amount:', finalAmount);

            try {
                const response = await fetch('/.netlify/functions/create-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: finalAmount,
                        currency: 'usd',
                        capture_method: 'manual',
                        metadata: {
                            service_category: serviceData.category,
                            time_slot: serviceData.selectedTimeSlot.windowLabel,
                            location: serviceData.location || 'Not specified'
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`Payment setup failed: ${response.status}`);
                }

                const result = await response.json();
                paymentIntentId = result.payment_intent_id;

                elements = stripe.elements({
                    clientSecret: result.client_secret,
                    appearance: { theme: 'stripe' }
                });

                paymentElement = elements.create('payment', {
                    layout: { type: 'tabs' }
                });

                await paymentElement.mount('#stripe-payment-element');
                paymentElementReady = true;

                paymentElement.on('ready', () => {
                    console.log('‚úÖ Payment element ready');
                });

            } catch (error) {
                console.error('‚ùå Payment setup error:', error);
                showToast('Payment setup failed. Please try again.', 'error');
                closePaymentModal();
            }
        }

        async function processPayment(event) {
            event.preventDefault();

            if (!stripe || !elements || !paymentElementReady) {
                showToast('Payment system not ready. Please wait.', 'warning');
                return;
            }

            const submitBtn = document.getElementById('submitPayment');
            const btnText = document.getElementById('paymentButtonText');

            submitBtn.disabled = true;
            btnText.textContent = 'Processing...';

            try {
                const { error } = await stripe.confirmPayment({
                    elements,
                    confirmParams: {
                        return_url: window.location.href,
                    },
                    redirect: 'if_required'
                });

                if (error) {
                    console.error('‚ùå Payment failed:', error);
                    showToast(error.message, 'error');
                    submitBtn.disabled = false;
                    btnText.textContent = 'Complete Payment';
                } else {
                    console.log('‚úÖ Payment successful!');
                    await completeBookingProcess();
                }

            } catch (error) {
                console.error('‚ùå Payment error:', error);
                showToast('Payment failed. Please try again.', 'error');
                submitBtn.disabled = false;
                btnText.textContent = 'Complete Payment';
            }
        }

        async function completeBookingProcess() {
            try {
                // Generate task ID
                const taskId = 'TK-' + Math.random().toString(36).substr(2, 6).toUpperCase();

                // Prepare booking data for dispatch
                const bookingData = {
                    task_id: taskId,
                    service_category: serviceData.category,
                    service_display: serviceData.categoryDisplay.replace(/<[^>]*>/g, ''), // Remove HTML tags
                    description: serviceData.detailedDescription,
                    location: serviceData.location,
                    time_slot: serviceData.selectedTimeSlot.windowLabel,
                    payment_intent_id: paymentIntentId,
                    total_amount: serviceData.pricing.total,
                    customer_contact: 'TBD', // Will be collected in classic interface
                    timestamp: new Date().toISOString()
                };

                // Track successful booking completion
                HandymanAnalytics.trackBookingCompleted(bookingData);

                // Send booking data to backend
                console.log('üì§ Dispatching booking:', bookingData);

                // TODO: Implement dispatch-handyman function for automated task creation
                // For now, tasks will be created manually based on console logs
                try {
                    await fetch('/.netlify/functions/dispatch-handyman', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(bookingData)
                    });
                    console.log('‚úÖ Booking dispatched successfully');
                } catch (dispatchError) {
                    console.warn('‚ö†Ô∏è Dispatch function not implemented yet - handle manually:', dispatchError.message);
                    console.log('üìã MANUAL TASK CREATION NEEDED:', bookingData);
                    console.log('üî• =================================');
                    console.log('üî• URGENT: MANUAL TASK REQUIRED');
                    console.log('üî• Task ID:', bookingData.task_id);
                    console.log('üî• Service:', bookingData.service_display);
                    console.log('üî• Description:', bookingData.description);
                    console.log('üî• Location:', bookingData.location);
                    console.log('üî• Time Slot:', bookingData.time_slot);
                    console.log('üî• Amount:', `$${bookingData.total_amount}`);
                    console.log('üî• Payment ID:', bookingData.payment_intent_id);
                    console.log('üî• =================================');

                    // Also show an admin notification if possible
                    if (typeof showToast === 'function') {
                        showToast(`Task ${bookingData.task_id} needs manual creation - Check console for details`, 'warning', 10000);
                    }
                }

                // Show success modal
                closePaymentModal();
                showSuccessModal(taskId, serviceData.pricing.total, serviceData.categoryDisplay);

            } catch (error) {
                console.error('‚ùå Booking completion error:', error);
                showToast('Booking completed but dispatch failed. Please contact support.', 'warning');
            }
        }

        function showSuccessModal(taskId, amount, service) {
            document.getElementById('finalTaskId').textContent = taskId;
            document.getElementById('finalAmount').textContent = '$' + amount.toFixed(0);
            document.getElementById('finalService').textContent = service.replace(/<[^>]*>/g, '');
            document.getElementById('successModal').classList.remove('hidden');
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.add('hidden');
            if (paymentElement) {
                paymentElement.unmount();
                paymentElement = null;
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            initializeStripe();

            // Payment modal close button
            document.getElementById('closePayment')?.addEventListener('click', closePaymentModal);

            // Payment form submit
            document.getElementById('paymentForm')?.addEventListener('submit', processPayment);
        });
    </script>

    <!-- Payment Modal -->
    <div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold">Complete Payment</h3>
                <button id="closePayment" class="text-slate-400 hover:text-slate-600 text-2xl">√ó</button>
            </div>
            <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                <div class="text-sm text-slate-600">Total amount</div>
                <div id="paymentAmount" class="text-2xl font-bold">$0</div>
                <div class="text-sm text-slate-600 mt-1">
                    <span id="paymentTiming">Selected timing</span>
                </div>
            </div>
            <form id="paymentForm">
                <div id="stripe-payment-element" class="mb-4"></div>
                <button id="submitPayment" type="submit" class="w-full rounded-xl bg-blue-600 text-white px-5 py-3 font-semibold disabled:opacity-50 transition-all">
                    <span id="paymentButtonText">Complete Payment</span>
                </button>
                <div id="paymentMessage" class="mt-4 text-sm hidden"></div>
            </form>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full shadow-2xl text-center">
            <div class="text-6xl mb-4">üéâ</div>
            <h3 class="text-xl font-bold mb-2 text-green-600">Payment Confirmed!</h3>
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                <p class="text-sm text-green-700 mb-2">
                    <strong>‚úÖ Payment authorized</strong><br>
                    <strong>‚úÖ Handyman dispatched</strong><br>
                    <strong>‚úÖ You'll receive confirmation shortly</strong>
                </p>
                <div class="mt-3 p-2 bg-white rounded-lg border">
                    <div class="text-xs text-gray-500">Your Task ID</div>
                    <div id="finalTaskId" class="font-mono text-sm font-bold">TK-ABC123</div>
                </div>
            </div>
            <div class="text-sm text-gray-600 mb-4">
                <strong>Total paid:</strong> <span id="finalAmount">$0</span><br>
                <strong>Service:</strong> <span id="finalService">Service details</span>
            </div>
            <button onclick="window.location.reload()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                Book Another Service
            </button>
        </div>
    </div>
</body>
</html>