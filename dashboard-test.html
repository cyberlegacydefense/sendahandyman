<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="assets/images/favicon.png">
  <title>Dashboard - PostMyStyle.ai</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

  <!-- Enhanced Supabase Loading Strategy -->
  <script>
    console.log('üîß Loading Supabase library...');

    // Define fallback function first
    window.loadSupabaseFallback = function() {
      console.log('üîÑ Loading fallback Supabase CDN...');
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js';
      script.onload = () => {
        console.log('‚úÖ Fallback Supabase script loaded');
        window.supabaseLoadAttempted = true;
      };
      script.onerror = function() {
        console.error('‚ùå Fallback CDN also failed');
        // Try jsdelivr alternative
        const script2 = document.createElement('script');
        script2.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js';
        script2.onload = () => {
          console.log('‚úÖ Alternative CDN loaded');
          window.supabaseLoadAttempted = true;
        };
        script2.onerror = () => {
          console.error('‚ùå All CDNs failed');
          setTimeout(showCDNError, 1000);
        };
        document.head.appendChild(script2);
      };
      document.head.appendChild(script);
    };

    window.showCDNError = function() {
      if (document.body) {
        document.body.innerHTML = `
          <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; text-align: center; padding: 2rem; font-family: Inter, sans-serif; background: #f8f9fa;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">üåê</div>
            <div style="background: white; color: #721c24; padding: 2rem; border-radius: 15px; max-width: 600px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);">
              <h2 style="margin: 0 0 1rem 0; color: #dc3545;">Network Connection Issue</h2>
              <p style="margin: 0 0 1rem 0; color: #666;">Unable to load required database components. This might be due to:</p>
              <ul style="text-align: left; color: #666; margin: 1rem 0;">
                <li>Network connectivity issues</li>
                <li>Corporate firewall restrictions</li>
                <li>Ad-blocker blocking CDN resources</li>
                <li>DNS resolution problems</li>
              </ul>
              <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; margin: 1rem 0; color: #1565c0;">
                <strong>Troubleshooting:</strong><br>
                1. Check your internet connection<br>
                2. Disable ad-blockers temporarily<br>
                3. Try a different network<br>
                4. Contact your IT department if on corporate network
              </div>
              <button onclick="window.location.reload()" style="background: #dc3545; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; margin-top: 1rem; cursor: pointer; font-weight: 600;">
                üîÑ Try Again
              </button>
            </div>
          </div>
        `;
      }
    };
  </script>

  <!-- Try primary CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"
          onload="console.log('‚úÖ Primary Supabase CDN loaded successfully'); window.supabaseLoadAttempted = true;"
          onerror="console.warn('‚ùå Primary CDN failed, trying fallback...'); window.loadSupabaseFallback();"></script>
  <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: #f8f9fa;
        color: #333;
        line-height: 1.6;
        overflow-x: hidden;
    }

    .dashboard-container {
        display: grid;
        grid-template-columns: 280px 1fr;
        min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
        background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 1.5rem;
        box-shadow: 4px 0 12px rgba(0, 0, 0, 0.1);
        z-index: 100;
        position: relative;
        overflow: hidden;
    }

    .sidebar::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        opacity: 0.3;
    }

    .logo {
        text-align: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        position: relative;
        z-index: 1;
    }

    .logo img {
        max-width: 180px;
        height: auto;
        margin-bottom: 0.5rem;
    }

    .logo p {
        font-size: 0.9rem;
        opacity: 0.8;
        margin-bottom: 1rem;
    }

    .nav-menu {
        list-style: none;
        position: relative;
        z-index: 1;
    }

    .nav-item {
        margin-bottom: 0.5rem;
    }

    .nav-link {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.3s ease;
        opacity: 0.8;
    }

    .nav-link:hover, .nav-link.active {
        background: rgba(255, 255, 255, 0.15);
        opacity: 1;
        transform: translateX(4px);
    }

    .nav-icon {
        margin-right: 0.75rem;
        font-size: 1.1rem;
    }

    .logout-btn-sidebar {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 0.4rem 0.75rem;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.8rem;
        margin-top: 0.5rem;
    }

    .logout-btn-sidebar:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    /* Main Content */
    .main-content {
        padding: 2rem;
        overflow-y: auto;
        max-height: 100vh;
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e9ecef;
    }

    .header-info h1 {
        font-size: 2rem;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 0.25rem;
    }

    .header-info p {
        color: #666;
        font-size: 1rem;
    }

    .header-actions {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .time-range-selector {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 0.5rem;
        display: flex;
        gap: 0.25rem;
    }

    .time-btn {
        padding: 0.5rem 1rem;
        background: none;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .time-btn.active {
        background: #667eea;
        color: white;
    }

    .refresh-btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .refresh-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    /* NEW: Management sections */
    .management-section {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        border: 1px solid #f0f0f0;
        margin-bottom: 2rem;
        display: none;
    }

    .management-section.active {
        display: block;
    }

    .management-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f0f0f0;
    }

    .add-btn {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .add-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3);
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #333;
    }

    .form-group input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
    }

    .form-group input:focus {
        outline: none;
        border-color: #667eea;
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 2rem;
    }

    .btn-secondary {
        background: #f8f9fa;
        color: #666;
        border: 1px solid #e9ecef;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-secondary:hover {
        background: #e9ecef;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .team-list {
        display: grid;
        gap: 1rem;
    }

    .team-member-card {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 12px;
        border-left: 4px solid #667eea;
        transition: all 0.3s ease;
    }

    .team-member-card:hover {
        background: white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .team-member-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .team-member-info h4 {
        margin: 0;
        color: #333;
        font-size: 1.2rem;
    }

    .team-member-info p {
        margin: 0;
        color: #666;
        font-size: 0.9rem;
    }

    .team-member-actions {
        display: flex;
        gap: 0.5rem;
    }

    .btn-small {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-edit {
        background: #fbbf24;
        color: white;
        border: none;
    }

    .btn-delete {
        background: #ef4444;
        color: white;
        border: none;
    }

    .btn-small:hover {
        transform: translateY(-1px);
    }

    /* Product Management Styles */
    .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
        margin-top: 2rem;
        max-height: 600px;
        overflow-y: auto;
        padding: 1rem;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        background: #f8f9fa;
    }

    .product-management-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        transition: all 0.3s ease;
        position: relative;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        min-height: 80px;
    }

    .product-management-card:hover {
        border-color: #667eea;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
    }

    .product-management-card.selected {
        border-color: #22c55e;
        background: #f0f9ff;
        box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.1);
    }

    .product-image-container {
        width: 50px;
        height: 50px;
        border-radius: 6px;
        overflow: hidden;
        background: #f1f5f9;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        border: 1px solid #e2e8f0;
    }

    .product-image-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .product-image-placeholder {
        color: #94a3b8;
        font-size: 1.2rem;
        text-align: center;
    }

    .product-info-compact {
        flex: 1;
        min-width: 0;
    }

    .product-info-compact h4 {
        margin: 0 0 0.25rem 0;
        color: #1f2937;
        font-size: 0.9rem;
        font-weight: 600;
        line-height: 1.2;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .product-info-compact .product-meta {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8rem;
        color: #6b7280;
        margin-bottom: 0.25rem;
    }

    .product-info-compact .product-price {
        font-weight: 600;
        color: #059669;
        font-size: 0.85rem;
    }

    .product-toggle {
        position: static;
        width: 40px;
        height: 20px;
        background: #e5e7eb;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        flex-shrink: 0;
        margin-left: auto;
    }

    .product-toggle.active {
        background: #22c55e;
    }

    .product-toggle::before {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 16px;
        height: 16px;
        background: white;
        border-radius: 50%;
        transition: all 0.3s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .product-toggle.active::before {
        transform: translateX(20px);
    }

    .product-category-badge {
        background: #e0f2fe;
        color: #0369a1;
        padding: 0.125rem 0.5rem;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 500;
        white-space: nowrap;
    }

    .product-rating {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.75rem;
        color: #f59e0b;
    }

    .product-search {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 1rem;
        margin-bottom: 1rem;
        background: white;
    }

    .product-search:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .product-filters {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        padding: 1rem;
        background: white;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }

    .filter-btn {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        padding: 0.4rem 0.8rem;
        border-radius: 16px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.3s ease;
        white-space: nowrap;
    }

    .filter-btn.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
        transform: translateY(-1px);
    }

    .filter-btn:hover:not(.active) {
        background: #e9ecef;
        border-color: #dee2e6;
    }

    .product-stats-summary {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        margin-bottom: 1rem;
        font-size: 0.9rem;
    }

    .products-count {
        color: #6b7280;
    }

    .selected-count {
        color: #059669;
        font-weight: 600;
    }

    .selected-products-summary {
        background: #f0f9ff;
        border: 2px solid #0ea5e9;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .summary-title {
        font-weight: 700;
        color: #0369a1;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
    }

    .summary-stat {
        text-align: center;
        background: white;
        padding: 1rem;
        border-radius: 8px;
    }

    .summary-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: #0369a1;
    }

    .summary-label {
        font-size: 0.8rem;
        color: #666;
        margin-top: 0.25rem;
    }

    /* ENHANCED AI Business Advisor */
    .ai-advisor-section {
        background: linear-gradient(135deg, #FF6B35, #ff8660);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        position: relative;
        overflow: hidden;
        box-shadow: 0 12px 32px rgba(255, 107, 53, 0.2);
    }

    .ai-advisor-section::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200px;
        height: 200px;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        border-radius: 50%;
        animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
        0%, 100% { transform: translate(0, 0); }
        50% { transform: translate(10px, -10px); }
    }

    .ai-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.5rem;
        position: relative;
        z-index: 1;
    }

    .ai-title-section {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .ai-icon {
        width: 60px;
        height: 60px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        backdrop-filter: blur(10px);
        animation: glow 2s ease-in-out infinite alternate;
        position: relative;
        overflow: hidden;
    }

    .ai-icon::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
        transform: rotate(-45deg);
        animation: shine 3s ease-in-out infinite;
    }

    @keyframes shine {
        0% { transform: translateX(-100%) translateY(-100%) rotate(-45deg); }
        50% { transform: translateX(100%) translateY(100%) rotate(-45deg); }
        100% { transform: translateX(-100%) translateY(-100%) rotate(-45deg); }
    }

    @keyframes glow {
        from { box-shadow: 0 0 10px rgba(255, 255, 255, 0.5); }
        to { box-shadow: 0 0 20px rgba(255, 255, 255, 0.8); }
    }

    .ai-title {
        font-size: 1.8rem;
        font-weight: 700;
        margin: 0;
    }

    .ai-subtitle {
        font-size: 1rem;
        opacity: 0.9;
        margin: 0;
    }

    .ai-controls {
        display: flex;
        gap: 0.5rem;
        position: relative;
        z-index: 1;
    }

    .ai-control-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        padding: 0.75rem;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
    }

    .ai-control-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .ai-control-btn:hover::before {
        left: 100%;
    }

    .ai-control-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }

    .ai-control-btn.active {
        background: rgba(255, 255, 255, 0.3);
    }

    .ai-content {
        background: rgba(255, 255, 255, 0.15);
        padding: 1.5rem;
        border-radius: 12px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        position: relative;
        z-index: 1;
        margin-bottom: 1rem;
    }

    .ai-loading {
        display: flex;
        align-items: center;
        gap: 12px;
        color: white;
        font-style: italic;
    }

    .ai-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top: 2px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .ai-message {
        font-size: 1.1rem;
        line-height: 1.7;
        color: white;
        margin-bottom: 1rem;
    }

    .ai-message strong {
        font-weight: 600;
    }

    .ai-expand-btn {
        background: none;
        border: none;
        color: white;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 5px 0;
        transition: all 0.3s ease;
        opacity: 0.9;
    }

    .ai-expand-btn:hover {
        opacity: 1;
        transform: translateX(5px);
    }

    /* NEW: Quick Actions */
    .ai-quick-actions {
        background: rgba(255, 255, 255, 0.1);
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 1rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        position: relative;
        z-index: 1;
    }

    .quick-actions-title {
        font-size: 1rem;
        font-weight: 600;
        color: white;
        margin-bottom: 1rem;
    }

    .quick-actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .quick-action-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        padding: 1rem;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: left;
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
    }

    .quick-action-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .quick-action-btn:hover::before {
        left: 100%;
    }

    .quick-action-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }

    .quick-action-title {
        font-weight: 600;
        margin-bottom: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .quick-action-desc {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    /* NEW: Custom Question Section */
    .custom-question-section {
        background: rgba(255, 255, 255, 0.1);
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 1rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        position: relative;
        z-index: 1;
    }

    .custom-question-title {
        font-size: 1rem;
        font-weight: 600;
        color: white;
        margin-bottom: 1rem;
    }

    .question-input-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }

    .question-input {
        flex: 1;
        padding: 12px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        font-size: 0.9rem;
        resize: vertical;
        min-height: 80px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        backdrop-filter: blur(10px);
    }

    .question-input::placeholder {
        color: rgba(255, 255, 255, 0.7);
    }

    .question-input:focus {
        outline: none;
        border-color: rgba(255, 255, 255, 0.5);
        background: rgba(255, 255, 255, 0.25);
    }

    .question-send-btn {
        background: rgba(255, 255, 255, 0.3);
        border: none;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }

    .question-send-btn:hover {
        background: rgba(255, 255, 255, 0.4);
        transform: translateY(-2px);
    }

    .question-send-btn:disabled {
        background: rgba(255, 255, 255, 0.1);
        cursor: not-allowed;
        transform: none;
    }

    .question-hint {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.8);
        margin: 0;
    }

    .ai-stage-indicator {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        margin-top: 1rem;
        position: relative;
        z-index: 1;
    }

    .ai-stage-text {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.9);
        font-weight: 500;
    }

    .ai-last-updated {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.7);
        font-style: italic;
    }

    .ai-welcome {
        text-align: center;
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 1rem;
    }

    /* NEW: UGC Analytics Section */
    .ugc-analytics-section {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        border: 1px solid #f0f0f0;
        border-left: 4px solid #E91E63;
    }

    .ugc-section-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.5rem;
        font-weight: 700;
        color: #E91E63;
        margin-bottom: 1.5rem;
    }

    .ugc-hero-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .ugc-hero-metric {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 12px;
        text-align: center;
        transition: all 0.3s ease;
    }

    .ugc-hero-metric:hover {
        background: white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .ugc-metric-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .ugc-metric-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.25rem;
    }

    .ugc-metric-subtitle {
        font-size: 0.8rem;
        color: #666;
    }

    .ugc-insights-container {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .ugc-insights-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 1rem;
    }

    .ugc-insight-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .ugc-insight-item {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid #E91E63;
    }

    .ugc-insight-label {
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 0.25rem;
    }

    .ugc-insight-status {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .ugc-insight-detail {
        font-size: 0.8rem;
        color: #888;
    }

    .ugc-platform-container {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .ugc-platform-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 1rem;
    }

    .ugc-platform-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
    }

    .ugc-platform-item {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
        transition: all 0.3s ease;
    }

    .ugc-platform-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .ugc-platform-count {
        font-size: 1.5rem;
        font-weight: 700;
        color: #333;
        margin: 0.5rem 0;
    }

    .ugc-platform-name {
        font-size: 0.8rem;
        color: #666;
        text-transform: capitalize;
    }

    .ugc-services-container {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .ugc-services-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 1rem;
    }

    .ugc-service-item {
        display: flex;
        align-items: center;
        background: white;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }

    .ugc-service-item:hover {
        transform: translateX(4px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .ugc-service-rank {
        background: #E91E63;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: 600;
        margin-right: 1rem;
    }

    .ugc-service-name {
        flex: 1;
        font-weight: 500;
        color: #333;
    }

    .ugc-service-count {
        color: #666;
        font-size: 0.9rem;
    }

    .ugc-recommendations {
        background: #fff3e0;
        border: 2px solid #FFE0B2;
        border-radius: 12px;
        padding: 1.5rem;
    }

    .ugc-recommendations-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 1rem;
    }

    .ugc-recommendation-card {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        border-left: 4px solid #FF9800;
    }

    .ugc-recommendation-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .ugc-recommendation-title {
        font-weight: 600;
        color: #FF9800;
    }

    .ugc-recommendation-action {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 0.25rem;
        margin-left: 1rem;
    }

    .ugc-trend-container {
        display: flex;
        align-items: center;
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .ugc-trend-text {
        font-weight: 600;
        color: #333;
        margin-left: 0.5rem;
        flex: 1;
    }

    .ugc-trend-detail {
        font-size: 0.9rem;
        color: #666;
    }

    /* Enhanced Metrics Grid */
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .metric-card {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        border: 1px solid #f0f0f0;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        cursor: pointer;
    }

    .metric-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 16px 48px rgba(0, 0, 0, 0.12);
    }

    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #667eea, #764ba2);
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }

    .metric-card:hover::before {
        transform: scaleX(1);
    }

    .metric-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .metric-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
    }

    .metric-trend {
        background: #e8f5e8;
        color: #22c55e;
        padding: 0.25rem 0.5rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .metric-trend.metric-positive {
        background: #e8f5e8;
        color: #22c55e;
    }

    .metric-trend.metric-negative {
        background: #fef2f2;
        color: #ef4444;
    }

    .metric-trend.metric-neutral {
        background: #f3f4f6;
        color: #6b7280;
    }

    .metric-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }

    .metric-card:hover .metric-value {
        transform: scale(1.05);
    }

    .metric-label {
        color: #666;
        font-weight: 500;
    }

    .loading-stats {
        opacity: 0.6;
    }

    .loading-stats .metric-value {
        color: #ccc;
    }

    /* Advanced Charts Section */
    .charts-section {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .chart-container {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        border: 1px solid #f0f0f0;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .chart-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #1a1a1a;
    }

    .chart-controls {
        display: flex;
        gap: 0.5rem;
    }

    .chart-control {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 0.5rem 0.75rem;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .chart-control.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }

    .chart-canvas {
        position: relative;
        height: 300px;
        width: 100%;
    }

    /* Team Performance Table */
    .performance-table {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        border: 1px solid #f0f0f0;
        margin-bottom: 2rem;
    }

    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .performance-grid {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr;
        gap: 1rem;
        align-items: center;
        padding: 1rem 0;
        border-bottom: 1px solid #f0f0f0;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .performance-grid:hover {
        background: #f8f9fa;
        transform: scale(1.01);
    }

    .performance-grid:last-child {
        border-bottom: none;
    }

    .stylist-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .stylist-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
    }

    .performance-metric {
        text-align: center;
        font-weight: 600;
    }

    .performance-value {
        font-size: 1.1rem;
        color: #1a1a1a;
    }

    .performance-label {
        font-size: 0.8rem;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Insights Panel */
    .insights-panel {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        border: 1px solid #f0f0f0;
    }

    .insight-item {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border-left: 4px solid #667eea;
    }

    .insight-positive {
        background: #f0f9ff;
        border-left-color: #22c55e;
    }

    .insight-warning {
        background: #fef3c7;
        border-left-color: #f59e0b;
    }

    .insight-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .insight-desc {
        font-size: 0.9rem;
        color: #666;
    }

    /* Auto-refresh indicator */
    .refresh-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        opacity: 0;
        transform: translateY(-20px);
        transition: all 0.3s ease;
        z-index: 1001;
    }

    .refresh-indicator.show {
        opacity: 1;
        transform: translateY(0);
    }

    /* ENHANCED DRILL-DOWN MODAL STYLES */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
    }

    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .modal-content {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        max-width: 900px;
        max-height: 85vh;
        overflow-y: auto;
        margin: 1rem;
        position: relative;
        transform: scale(0.8);
        transition: transform 0.3s ease;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
    }

    .modal-overlay.active .modal-content {
        transform: scale(1);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f0f0f0;
    }

    .modal-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: #333;
    }

    .modal-close {
        background: #f8f9fa;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
        padding: 0.5rem;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .modal-close:hover {
        background: #e9ecef;
        color: #333;
        transform: rotate(90deg);
    }

    .stylist-card {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 15px;
        margin-bottom: 1rem;
        border-left: 4px solid #667eea;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .stylist-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
        transition: left 0.5s;
    }

    .stylist-card:hover::before {
        left: 100%;
    }

    .stylist-card:hover {
        background: white;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .stylist-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .stylist-avatar-large {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 24px;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .stylist-info h3 {
        margin: 0;
        color: #333;
        font-size: 1.3rem;
    }

    .stylist-info p {
        margin: 0;
        color: #666;
        font-size: 0.9rem;
    }

    .stylist-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
    }

    .stylist-stat {
        text-align: center;
        background: white;
        padding: 1rem;
        border-radius: 10px;
        transition: all 0.3s ease;
    }

    .stylist-stat:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .stylist-stat-number {
        font-size: 1.8rem;
        font-weight: 700;
        color: #667eea;
    }

    .stylist-stat-label {
        font-size: 0.8rem;
        color: #666;
        margin-top: 0.25rem;
    }

    .error-message {
        background: linear-gradient(135deg, #f8d7da, #f5c6cb);
        color: #721c24;
        padding: 1.5rem;
        border-radius: 15px;
        margin: 1rem 0;
        text-align: center;
        border-left: 4px solid #dc3545;
    }

    /* Product-specific styles */
    .product-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .product-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .product-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 0.5rem;
    }

    .product-image {
        width: 50px;
        height: 50px;
        border-radius: 8px;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }

    .product-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .product-stat {
        text-align: center;
        background: #f8f9fa;
        padding: 0.5rem;
        border-radius: 8px;
    }

    .product-stat-number {
        font-size: 1.2rem;
        font-weight: 700;
        color: #667eea;
    }

    .product-stat-label {
        font-size: 0.8rem;
        color: #666;
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .dashboard-container {
            grid-template-columns: 1fr;
        }

        .sidebar {
            display: none;
        }

        .charts-section {
            grid-template-columns: 1fr;
        }

        .metrics-grid {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
    }

    @media (max-width: 768px) {
        .main-content {
            padding: 1rem;
        }

        .ai-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }

        .ai-controls {
            order: -1;
            align-self: flex-end;
        }

        .quick-actions-grid {
            grid-template-columns: 1fr;
        }

        .question-input-row {
            flex-direction: column;
        }

        .modal-content {
            margin: 0.5rem;
            max-height: 90vh;
        }

        .product-grid {
            grid-template-columns: 1fr;
        }

        .product-filters {
            justify-content: center;
        }

        .ugc-hero-metrics {
            grid-template-columns: 1fr;
        }

        .ugc-insight-row {
            grid-template-columns: 1fr;
        }

        .ugc-platform-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
  </style>
</head>
<body>
<div class="dashboard-container">
  <!-- Sidebar Navigation -->
  <div class="sidebar">
    <div class="logo">
      <img src="https://res.cloudinary.com/dkstyvfzo/image/upload/v1750698482/postmystyletitle_tuls98.png" alt="PostMyStyle.ai">
      <p>PostMyStyle AI Analytics</p>

      <!-- User info moved here -->
      <div style="background: rgba(255, 255, 255, 0.15); padding: 0.75rem; border-radius: 8px; backdrop-filter: blur(10px); margin-top: 0.5rem;">
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
          <div style="width: 30px; height: 30px; border-radius: 50%; background: rgba(255, 255, 255, 0.2); display: flex; align-items: center; justify-content: center; font-size: 0.9rem;">üë§</div>
          <div style="font-weight: 600; font-size: 0.85rem;" id="userNameSidebar">Loading...</div>
        </div>
        <button class="logout-btn-sidebar" onclick="logout()" style="width: 100%; margin-top: 0;">Log Out</button>
      </div>
    </div>

    <ul class="nav-menu">
      <li class="nav-item">
        <a href="#" class="nav-link active" onclick="showDashboard()">
          <span class="nav-icon">üìä</span>
          <span>Dashboard</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" onclick="showTeamPerformance()">
          <span class="nav-icon">üë•</span>
          <span>Team Performance</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" onclick="showManageTeam()">
          <span class="nav-icon">üë§</span>
          <span>Manage Team</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" onclick="showManageProducts()">
          <span class="nav-icon">üõçÔ∏è</span>
          <span>Manage Products</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" onclick="showSocialAnalytics()">
          <span class="nav-icon">üì±</span>
          <span>Social Analytics</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" onclick="showRevenueTracking()">
          <span class="nav-icon">üí∞</span>
          <span>Revenue Tracking</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" onclick="showGoalsTargets()">
          <span class="nav-icon">üéØ</span>
          <span>Goals & Targets</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" onclick="showSettings()">
          <span class="nav-icon">‚öôÔ∏è</span>
          <span>Settings</span>
        </a>
      </li>
    </ul>
  </div>

  <!-- Auto-refresh indicator -->
  <div class="refresh-indicator" id="refreshIndicator">
    üîÑ Data refreshed automatically
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
      <div class="header-info">
        <h1 id="salonNameHeader">Loading...</h1>
        <p id="dashboardSubtitle">Team Analytics Dashboard ‚Ä¢ Auto-refresh enabled</p>
      </div>
      <div class="header-actions">
        <div class="time-range-selector">
          <button class="time-btn">24H</button>
          <button class="time-btn active">7D</button>
          <button class="time-btn">30D</button>
          <button class="time-btn">90D</button>
        </div>
        <button class="refresh-btn" onclick="refreshDashboard()">
          üîÑ Refresh
        </button>
      </div>
    </div>

    <!-- NEW: Team Management Section -->
    <div class="management-section" id="teamManagementSection">
      <div class="management-header">
        <h2 class="chart-title">Team Management</h2>
        <button class="add-btn" onclick="showAddStylistForm()">
          <span>‚ûï</span>
          <span>Add New Stylist</span>
        </button>
      </div>

      <!-- Add Stylist Form -->
      <div id="addStylistForm" style="display: none; background: #f8f9fa; padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
        <h3 style="margin: 0 0 1.5rem 0; color: #333;">Add New Stylist</h3>
        <div class="form-group">
          <label for="stylistName">Stylist Name *</label>
          <input type="text" id="stylistName" placeholder="Enter stylist's full name" required>
        </div>
        <div class="form-group">
          <label for="stylistEmail">Email Address *</label>
          <input type="email" id="stylistEmail" placeholder="Enter email for app login" required>
        </div>
        <div class="form-group">
          <label for="stylistPhone">Phone Number</label>
          <input type="tel" id="stylistPhone" placeholder="Optional - for contact purposes">
        </div>
        <div class="form-actions">
          <button class="btn-secondary" onclick="hideAddStylistForm()">Cancel</button>
          <button class="btn-primary" onclick="createNewStylist()">Create Stylist</button>
        </div>
      </div>

      <!-- Current Team List -->
      <div id="teamList" class="team-list">
        <div style="text-align: center; padding: 3rem; color: #666;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üë•</div>
          <p>Loading team members...</p>
        </div>
      </div>
    </div>

    <!-- NEW: Product Management Section -->
    <div class="management-section" id="productManagementSection">
      <div class="management-header">
        <h2 class="chart-title">Product Management</h2>
        <div style="display: flex; gap: 1rem; align-items: center;">
          <span style="color: #666; font-size: 0.9rem;">Manage products available to your clients</span>
        </div>
      </div>

      <!-- Selected Products Summary -->
      <div class="selected-products-summary" id="selectedProductsSummary" style="display: none;">
        <div class="summary-title">
          <span>üõçÔ∏è</span>
          <span>Your Selected Products</span>
        </div>
        <div class="summary-grid" id="summaryGrid">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>

      <!-- Product Search and Filters -->
      <input type="text" class="product-search" id="productSearch" placeholder="Search products by name or brand...">

      <div class="product-filters" id="productFilters">
        <button class="filter-btn active" data-category="all">All Categories</button>
        <button class="filter-btn" data-category="Hair Care">Hair Care</button>
        <button class="filter-btn" data-category="Styling">Styling</button>
        <button class="filter-btn" data-category="Color">Color</button>
        <button class="filter-btn" data-category="Treatment">Treatment</button>
      </div>

      <!-- Products Grid -->
      <div id="productsGrid" class="product-grid">
        <div style="text-align: center; padding: 3rem; color: #666; grid-column: 1 / -1;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üõçÔ∏è</div>
          <p>Loading available products...</p>
        </div>
      </div>
    </div>

    <!-- ENHANCED AI Business Advisor Section -->
    <div class="ai-advisor-section" id="dashboardSection">
      <div class="ai-header">
        <div class="ai-title-section">
          <div class="ai-icon">‚ú®</div>
          <div>
            <h2 class="ai-title">AI Business Advisor</h2>
            <p class="ai-subtitle">Personalized insights for your salon team</p>
          </div>
        </div>
        <div class="ai-controls">
          <button class="ai-control-btn" id="quickActionsBtn" onclick="toggleQuickActions()" title="Quick Questions">üí¨</button>
          <button class="ai-control-btn" id="customQuestionBtn" onclick="toggleCustomQuestion()" title="Ask Question">‚úèÔ∏è</button>
          <button class="ai-control-btn" onclick="generateAIInsights(true)" title="Generate New Insights">üîÑ</button>
        </div>
      </div>

      <div class="ai-content" id="aiContent">
        <div class="ai-loading" id="aiLoading" style="display: none;">
          <div class="ai-spinner"></div>
          <span>Generating personalized business insights...</span>
        </div>
        <div id="aiMessage" style="display: none;">
          <div class="ai-message" id="aiMessageText"></div>
          <button class="ai-expand-btn" id="aiExpandBtn" style="display: none;" onclick="toggleAIMessage()">
            <span id="expandText">Read More</span> <span id="expandIcon">‚ñº</span>
          </button>
        </div>
        <div id="aiWelcome" class="ai-welcome">
          <p style="margin-bottom: 1rem;">
            üëã Welcome! Click the refresh button above to get personalized business insights based on your salon's performance data.
          </p>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="ai-quick-actions" id="quickActionsSection" style="display: none;">
        <div class="quick-actions-title">Get instant advice about:</div>
        <div class="quick-actions-grid">
          <button class="quick-action-btn" onclick="askQuickQuestion('increase-bookings')">
            <div class="quick-action-title">üí∞ Increasing Revenue</div>
            <div class="quick-action-desc">Optimize team productivity</div>
          </button>
          <button class="quick-action-btn" onclick="askQuickQuestion('client-retention')">
            <div class="quick-action-title">üë• Client Retention</div>
            <div class="quick-action-desc">Keep clients coming back</div>
          </button>
          <button class="quick-action-btn" onclick="askQuickQuestion('service-optimization')">
            <div class="quick-action-title">‚≠ê Service Performance</div>
            <div class="quick-action-desc">Boost popular services</div>
          </button>
          <button class="quick-action-btn" onclick="askQuickQuestion('content-strategy')">
            <div class="quick-action-title">üì± Content Strategy</div>
            <div class="quick-action-desc">Improve social engagement</div>
          </button>
          <button class="quick-action-btn" onclick="askQuickQuestion('pricing-strategy')">
            <div class="quick-action-title">üí∏ Pricing Strategy</div>
            <div class="quick-action-desc">Optimize service pricing</div>
          </button>
        </div>
      </div>

      <!-- Custom Question -->
      <div class="custom-question-section" id="customQuestionSection" style="display: none;">
        <div class="custom-question-title">Ask your business question:</div>
        <div class="question-input-row">
          <textarea class="question-input" id="customQuestionInput" placeholder="e.g., How can we improve our Instagram engagement?" maxlength="300"></textarea>
          <button class="question-send-btn" id="questionSendBtn" onclick="askCustomQuestion()">Send</button>
        </div>
        <p class="question-hint">üí° I'll analyze your salon's data to provide personalized advice</p>
      </div>

      <!-- AI Stage Indicator -->
      <div class="ai-stage-indicator">
        <span class="ai-stage-text" id="aiStageText">Business Stage: Growing Salon</span>
        <span class="ai-last-updated" id="aiLastUpdated"></span>
      </div>
    </div>

    <!-- NEW: UGC Analytics Section -->
    <div class="ugc-analytics-section" id="ugcAnalyticsSection">
      <h3 class="ugc-section-title">
        <span>üìà</span>
        <span>User-Generated Content Analytics</span>
      </h3>

      <!-- Hero Metrics -->
      <div class="ugc-hero-metrics" id="ugcHeroMetrics">
        <div class="ugc-hero-metric">
          <div class="ugc-metric-value" style="color: #E91E63;" id="ugcGenerationRate">0%</div>
          <div class="ugc-metric-label">Generation Rate</div>
          <div class="ugc-metric-subtitle">of sessions create posts</div>
        </div>
        <div class="ugc-hero-metric">
          <div class="ugc-metric-value" style="color: #2196F3;" id="ugcTotalDiscovered">0</div>
          <div class="ugc-metric-label">Posts Discovered</div>
          <div class="ugc-metric-subtitle">client-generated content</div>
        </div>
        <div class="ugc-hero-metric">
          <div class="ugc-metric-value" style="color: #FF9800;" id="ugcEngagement">0</div>
          <div class="ugc-metric-label">Avg Engagement</div>
          <div class="ugc-metric-subtitle">per client post</div>
        </div>
      </div>

      <!-- Performance Insights -->
      <div class="ugc-insights-container">
        <div class="ugc-insights-title">üìä Performance Insights</div>
        <div class="ugc-insight-row" id="ugcInsightRows">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>

      <!-- Platform Distribution -->
      <div class="ugc-platform-container" id="ugcPlatformContainer" style="display: none;">
        <div class="ugc-platform-title">üåê Platform Distribution</div>
        <div class="ugc-platform-grid" id="ugcPlatformGrid">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>

      <!-- Top Services -->
      <div class="ugc-services-container" id="ugcServicesContainer" style="display: none;">
        <div class="ugc-services-title">‚úÇÔ∏è Top UGC-Generating Services</div>
        <div id="ugcServicesList">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>

      <!-- Trend Indicator -->
      <div class="ugc-trend-container" id="ugcTrendContainer">
        <span id="ugcTrendIcon">üìä</span>
        <span class="ugc-trend-text" id="ugcTrendText">Building momentum</span>
        <span class="ugc-trend-detail" id="ugcTrendDetail">Start posting to track trends</span>
      </div>

      <!-- Recommendations -->
      <div class="ugc-recommendations" id="ugcRecommendations" style="display: none;">
        <div class="ugc-recommendations-title">üí° Recommendations</div>
        <div id="ugcRecommendationsList">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>
    </div>

    <!-- Key Metrics Grid -->
    <div class="metrics-grid" id="metricsSection">
      <div class="metric-card loading-stats" onclick="openDrillDown('stylists')">
        <div class="metric-header">
          <div class="metric-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">üë•</div>
          <div class="metric-trend" id="stylistsChange">Loading...</div>
        </div>
        <div class="metric-value" id="totalStylists">-</div>
        <div class="metric-label">Active Stylists</div>
      </div>

      <div class="metric-card loading-stats" onclick="openDrillDown('posts')">
        <div class="metric-header">
          <div class="metric-icon" style="background: linear-gradient(135deg, #4CAF50, #66BB6A);">üì±</div>
          <div class="metric-trend" id="sharesChange">Loading...</div>
        </div>
        <div class="metric-value" id="totalShares">-</div>
        <div class="metric-label">Posts Created</div>
      </div>

      <div class="metric-card loading-stats" onclick="openDrillDown('views')">
        <div class="metric-header">
          <div class="metric-icon" style="background: linear-gradient(135deg, #FF9800, #FFB74D);">üëÅÔ∏è</div>
          <div class="metric-trend" id="viewsChange">Loading...</div>
        </div>
        <div class="metric-value" id="totalViews">-</div>
        <div class="metric-label">Total Views</div>
      </div>

      <div class="metric-card loading-stats" onclick="openDrillDown('clients')">
        <div class="metric-header">
          <div class="metric-icon" style="background: linear-gradient(135deg, #9C27B0, #BA68C8);">üíù</div>
          <div class="metric-trend" id="clientsChange">Loading...</div>
        </div>
        <div class="metric-value" id="totalClients">-</div>
        <div class="metric-label">Total Clients</div>
      </div>

      <div class="metric-card loading-stats" onclick="openDrillDown('engagement')">
        <div class="metric-header">
          <div class="metric-icon" style="background: linear-gradient(135deg, #E91E63, #F06292);">‚ù§Ô∏è</div>
          <div class="metric-trend" id="engagementChange">Loading...</div>
        </div>
        <div class="metric-value" id="engagementRate">-</div>
        <div class="metric-label">Avg Engagement</div>
      </div>

      <div class="metric-card loading-stats" onclick="openDrillDown('products')">
        <div class="metric-header">
          <div class="metric-icon" style="background: linear-gradient(135deg, #FF5722, #FF8A65);">üõçÔ∏è</div>
          <div class="metric-trend" id="productChange">Loading...</div>
        </div>
        <div class="metric-value" id="productClicks">-</div>
        <div class="metric-label">Product Clicks</div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section" id="chartsSection">
      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">Team Activity Trends</h3>
          <div class="chart-controls">
            <button class="chart-control active">Posts</button>
            <button class="chart-control">Views</button>
            <button class="chart-control">Engagement</button>
            <button onclick="forceChartRefresh()" style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; padding: 0.5rem 0.75rem; font-size: 0.8rem; cursor: pointer; margin-left: 0.5rem;" title="Refresh Chart">üîÑ</button>
          </div>
        </div>
        <div class="chart-canvas">
          <canvas id="activityChart"></canvas>
        </div>
      </div>

      <div class="insights-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
          <h3 class="chart-title">AI Performance Insights</h3>
          <button onclick="generatePerformanceInsights()" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">üîÑ Refresh</button>
        </div>

        <div id="performanceInsightsContent">
          <div style="text-align: center; padding: 2rem; color: #666;">
            <div style="font-size: 2rem; margin-bottom: 1rem;">üß†</div>
            <p>Click refresh to generate AI-powered insights based on your team's performance data.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Team Performance Table -->
    <div class="performance-table" id="performanceSection">
      <div class="table-header">
        <h3 class="chart-title">Team Performance Leaderboard</h3>
        <div class="chart-controls">
          <button class="chart-control active">This Week</button>
          <button class="chart-control">This Month</button>
          <button class="chart-control">This Quarter</button>
        </div>
      </div>

      <div class="performance-grid" style="font-weight: 600; color: #666; border-bottom: 2px solid #e9ecef;">
        <div>Stylist</div>
        <div class="performance-label">Posts</div>
        <div class="performance-label">Views</div>
        <div class="performance-label">Clients</div>
        <div class="performance-label">Engagement</div>
        <div class="performance-label">Score</div>
      </div>

      <div id="performanceTableBody">
        <!-- Will be populated by JavaScript -->
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Drill-Down Modal -->
<div class="modal-overlay" id="drillDownModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="modalTitle">Stylist Details</h2>
      <button class="modal-close" onclick="closeDrillDown()">√ó</button>
    </div>
    <div id="modalContent">
      <!-- Content will be populated by JavaScript -->
    </div>
  </div>
</div>

<script>
  // Wait for Supabase to be available before running any code
  function waitForSupabaseLibrary() {
    return new Promise((resolve, reject) => {
      let attempts = 0;
      const maxAttempts = 30; // Increased attempts

      const checkLibrary = () => {
        attempts++;

        // Check multiple possible locations for Supabase
        const hasWindow = typeof window !== 'undefined';
        const hasSupabase = typeof window.supabase !== 'undefined';
        const hasCreateClient = hasSupabase && typeof window.supabase.createClient === 'function';
        const hasGlobalSupabase = typeof window.Supabase !== 'undefined';
        const hasGlobalCreateClient = hasGlobalSupabase && typeof window.Supabase.createClient === 'function';

        console.log(`üîç Library check ${attempts}/${maxAttempts}:`, {
          hasWindow,
          hasSupabase,
          hasCreateClient,
          hasGlobalSupabase,
          hasGlobalCreateClient,
          windowSupabase: typeof window.supabase,
          windowSupabaseGlobal: typeof window.Supabase,
          loadAttempted: window.supabaseLoadAttempted
        });

        // Try different ways Supabase might be exposed
        if (hasCreateClient) {
          console.log('‚úÖ Supabase found at window.supabase');
          resolve();
        } else if (hasGlobalCreateClient) {
          console.log('‚úÖ Supabase found at window.Supabase, mapping to window.supabase');
          window.supabase = window.Supabase;
          resolve();
        } else if (attempts >= maxAttempts) {
          console.error('‚ùå Supabase library failed to load after all attempts');
          console.error('Final state:', {
            windowKeys: Object.keys(window).filter(k => k.toLowerCase().includes('supabase')),
            scripts: Array.from(document.scripts).map(s => s.src).filter(src => src.includes('supabase')),
            loadAttempted: window.supabaseLoadAttempted
          });
          reject(new Error('Supabase library not available'));
        } else {
          setTimeout(checkLibrary, 300); // Check every 300ms
        }
      };

      // Start checking immediately
      checkLibrary();
    });
  }

  // Supabase Configuration with Error Handling
  const supabaseUrl = 'https://mffqaqvjylkotkgvytro.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1mZnFhcXZqeWxrb3RrZ3Z5dHJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYxMTI5MzYsImV4cCI6MjA2MTY4ODkzNn0.oUlS-JS1G9OHjwv89xZY_QRqwsoI-GE8c-ZE_U2TjDc';

// CLAUDE API CONFIGURATION - Unified secure proxy implementation
const CLAUDE_API_URL = '/.netlify/functions/anthropic-proxy';

/**
 * Unified Claude API call function
 * @param {string|Array} input - Either a simple prompt string OR array of message objects
 * @param {string} model - Claude model to use
 * @param {number} maxTokens - Maximum tokens to generate
 * @returns {Promise} - Claude API response
 */
async function callClaude(input, model = "claude-3-haiku-20240307", maxTokens = 400) {
    try {
        console.log('ü§ñ Calling Claude API via secure proxy...');

        // Handle both prompt string and messages array
        let messages;
        if (typeof input === 'string') {
            // Simple prompt string
            messages = [{
                role: 'user',
                content: input
            }];
        } else if (Array.isArray(input)) {
            // Already formatted messages array
            messages = input;
        } else {
            throw new Error('Input must be either a string prompt or messages array');
        }

        const response = await fetch(CLAUDE_API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
                // No API key needed - the proxy handles it securely!
            },
            body: JSON.stringify({
                model: model,
                max_tokens: maxTokens,
                messages: messages
            })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(`Claude API error: ${error.error || response.statusText}`);
        }

        const result = await response.json();
        console.log('‚úÖ Claude API call successful');
        return result;

    } catch (error) {
        console.error('‚ùå Claude API call failed:', error);
        throw error;
    }
}

  let supabase = null;

  // Global variables
  let currentUser = null;
  let salonData = null;
  let aiMessageFull = '';
  let aiMessageTruncated = '';
  let isAIExpanded = false;
  let stylistsData = [];

  // ENHANCED AI-related variables
  let lastAIGeneration = 0;
  let isGeneratingAI = false;

  // NEW: Global AI cache for conversation memory
  let GLOBAL_AI_CACHE = {
    lastStylistName: null,
    lastGeneratedTime: null,
    hasGenerated: false,
    cachedMessage: null,
    conversationHistory: []
  };

  // Chart instances
  let activityChart = null;

  // Auto-refresh variables
  let autoRefreshInterval = null;
  const AUTO_REFRESH_MINUTES = 5;
  let isDashboardLoaded = false;

  // Store analytics data globally for AI context
  let currentAnalyticsData = null;

  // Management state variables
  let allProducts = [];
  let selectedProducts = new Set();
  let currentTeamMembers = [];

  // Initialize Supabase after library loads
  async function initializeSupabase() {
    try {
      await waitForSupabaseLibrary();
      supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
      console.log('‚úÖ Supabase client initialized successfully');
      return true;
    } catch (error) {
      console.error('‚ùå Failed to initialize Supabase:', error);
      return false;
    }
  }

  // ===== ENHANCED AI BUSINESS ADVISOR FUNCTIONS (FROM MOBILE APP) =====

  // Helper function to extract first name only
  const getFirstName = (fullName) => {
    if (!fullName) return '';
    const nameParts = fullName.trim().split(' ');
    return nameParts[0];
  };

  // Stage-based user intelligence
  const getUserStage = (analyticsData) => {
    const {
      totalStylists = 0,
      totalClients = 0,
      totalShares = 0,
      totalClicks = 0
    } = analyticsData || {};

    if (totalStylists <= 1 && totalClients < 10 && totalShares < 5) return 'first-time';
    if (totalShares < 50 && totalClicks < 200 && totalClients < 50) return 'early';
    if (totalShares < 200 || totalClients < 100 || totalClicks < 1000) return 'growing';
    return 'power-user';
  };

  // Enhanced prompts with industry expertise and UGC insights
  const getPromptForStage = (stage, salonOwnerName, analyticsData) => {
    const firstName = getFirstName(salonOwnerName);
    const ugcInsights = analyticsData.ugcAnalytics ? `
UGC PERFORMANCE DATA:
- ${analyticsData.ugcAnalytics.total_ugc_discovered} client posts discovered
- ${analyticsData.ugcAnalytics.ugc_generation_rate}% UGC generation rate
- ${analyticsData.ugcAnalytics.avg_ugc_engagement} avg engagement per client post
- Top UGC services: ${Object.keys(analyticsData.ugcAnalytics.ugc_by_service || {}).slice(0, 2).join(', ')}
- Platform performance: ${Object.entries(analyticsData.ugcAnalytics.ugc_by_platform || {}).map(([platform, count]) => `${platform}: ${count}`).join(', ')}` : '';

    const basePrompt = `You are an expert hair salon business consultant and data analyst with 15+ years of experience helping salon owners grow their clientele and revenue. You specialize in cuts, color services, styling, and various beauty treatments. Always start your response with "${firstName}," to personalize the message. Keep responses conversational, encouraging, and under 150 words. Do not mention your years of experience in your response.

IMPORTANT: You are analyzing ${firstName}'s actual PostMyStyle analytics data. This is REAL data from their salon business - not industry benchmarks. Only reference the specific data points provided about their performance.

${ugcInsights}`;

    switch(stage) {
      case 'first-time':
        return `${basePrompt} This is their first time seeing this analytics dashboard. Welcome them warmly, explain that this AI advisor will provide personalized business insights as they use the tool more, and encourage them to start having their team upload styled photos with clients to build valuable data insights. Mention specific benefits like tracking which services get the most engagement and optimal posting times. Make it exciting and explain the potential for growing their salon business in the beauty and wellness industry.`;

      case 'early':
        return `${basePrompt} They're just getting started with ${analyticsData.totalShares || 0} shares, ${analyticsData.totalClicks || 0} views, and ${analyticsData.totalClients || 0} clients. Encourage them to keep having their team upload photos and add client sessions. Provide specific advice about building their clientele, optimal posting times, and how more data leads to better business insights. Be motivational and specific about next steps like posting before/after photos and tracking client service cycles.`;

      case 'growing':
        return `${basePrompt} They have ${analyticsData.totalShares || 0} shares, ${analyticsData.totalClicks || 0} views, and ${analyticsData.totalClients || 0} clients. Their best day is ${analyticsData.bestDay} and peak hours are ${analyticsData.peakHours?.join(', ') || 'not yet determined'}. ${analyticsData.ugcAnalytics?.total_ugc_discovered > 0 ? `Their clients are generating ${analyticsData.ugcAnalytics.total_ugc_discovered} social posts with ${analyticsData.ugcAnalytics.ugc_generation_rate}% UGC rate. ` : ''}Provide 2-3 specific, actionable business insights from their data. Focus on: client retention patterns, popular services, best engagement times for before/after content, and growth opportunities. Include one specific next action they should take this week.`;

      case 'power-user':
        return `${basePrompt} They're a power user with ${analyticsData.totalShares || 0} shares, ${analyticsData.totalClicks || 0} views, ${analyticsData.totalClients || 0} clients, and ${analyticsData.clickThroughRate || 0}% click rate. Their data shows ${analyticsData.bestDay} is their best day and ${analyticsData.peakHours?.[0] || 'evening'} is peak engagement time. ${analyticsData.ugcAnalytics?.ugc_generation_rate > 0 ? `Excellent UGC performance: ${analyticsData.ugcAnalytics.ugc_generation_rate}% of services generate client posts. ` : ''}Provide detailed business recommendations including: service monetization strategies, client acquisition tactics for high-value services, premium service opportunities, and data-driven insights for growing their salon business with specific revenue targets.`;

      default:
        return `${basePrompt} Provide encouraging insights about their salon business and suggestions for growth.`;
    }
  };

  // Industry-specific prompt generation
  const getIndustrySpecificPrompts = (questionType, salonOwnerName, analyticsData) => {
    const firstName = getFirstName(salonOwnerName);
    const basePrompt = `You are an expert hair salon business consultant with 15+ years experience. Provide specific, actionable advice for ${firstName} based on their analytics. Always start with "${firstName}," and keep under 200 words. Do not mention your years of experience in your response.`;

    const businessMetrics = `
${firstName.toUpperCase()}'S ACTUAL PERFORMANCE:
- ${analyticsData.totalShares} content posts
- ${analyticsData.totalClicks} total views
- ${analyticsData.clickThroughRate || 0}% engagement rate
- ${analyticsData.totalClients} active clients
- Best day: ${analyticsData.bestDay}
- Peak hours: ${analyticsData.peakHours?.join(', ') || 'TBD'}
- Product clicks: ${analyticsData.total_product_clicks || 0}
- UGC discovered: ${analyticsData.ugcAnalytics?.total_ugc_discovered || 0} client posts
- UGC rate: ${analyticsData.ugcAnalytics?.ugc_generation_rate || 0}%`;

    const industryContext = `
INDUSTRY BENCHMARKS FOR COMPARISON (NOT ${firstName.toUpperCase()}'S ACTUAL DATA):
- Industry average engagement rate: 2-5%
- Cut and color services: $150-400 per appointment
- Service cycles: 8-12 weeks
- Industry average client retention: 75-85%
- Industry average referral rates: 40-60% for satisfied clients
- Before/after content drives 3x more engagement than text-only posts
- Top salons achieve 15-25% UGC generation rates`;

    const prompts = {
      'increase-bookings': `${basePrompt} ${businessMetrics} ${industryContext}

They want more bookings. Analyze their performance and provide specific booking conversion tactics:
1) Optimize posting schedule using their ${analyticsData.peakHours?.join(' and ') || 'peak engagement'} data
2) Conversion strategies for their ${analyticsData.totalClicks} views
3) Follow-up sequences for consultations
4) Rebooking automation for their ${analyticsData.totalClients} clients
5) Leverage their ${analyticsData.ugcAnalytics?.total_ugc_discovered || 0} client posts for social proof`,

      'client-retention': `${basePrompt} ${businessMetrics} ${industryContext}

They want better client retention. With ${analyticsData.totalClients} current clients, suggest:
1) 8-12 week rebooking strategies for cut and color services
2) How to leverage their ${analyticsData.total_product_clicks || 0} product engagement for upsells
3) Specific follow-up sequences and timing
4) Referral systems targeting 40-60% referral rate goal
5) Use their ${analyticsData.ugcAnalytics?.ugc_generation_rate || 0}% UGC rate to identify happy clients for retention campaigns`,

      'pricing-strategy': `${basePrompt} ${businessMetrics} ${industryContext}

They need pricing optimization. Based on their ${analyticsData.clickThroughRate || 0}% engagement and client data:
1) Cut and color service packaging ($150-400 range positioning)
2) Upsell opportunities during appointments
3) Premium service positioning strategy
4) How to test price increases without losing clients
5) Services generating most UGC often justify premium pricing`,

      'content-strategy': `${basePrompt} ${businessMetrics} ${industryContext}

They want to improve their content strategy. With ${analyticsData.totalShares} posts and ${analyticsData.avgEngagementRate || 0}% avg engagement:
1) Leverage their ${analyticsData.bestDay} peak day performance
2) Before/after content calendar for transformations
3) Educational content that drives ${analyticsData.peakHours?.[0] || 'peak hour'} engagement
4) Client feature strategies that increase bookings
5) Encourage more UGC - currently ${analyticsData.ugcAnalytics?.ugc_generation_rate || 0}% rate vs 15-25% industry leaders`,

      'service-optimization': `${basePrompt} ${businessMetrics} ${industryContext}

They want to optimize their service offerings. Based on their current performance:
1) Identify highest-engagement services from their ${analyticsData.totalShares} posts
2) Package complementary services for higher value
3) Seasonal service strategies based on ${analyticsData.bestDay} performance
4) Premium service development opportunities
5) Services with highest UGC rates: ${Object.keys(analyticsData.ugcAnalytics?.ugc_by_service || {}).slice(0, 2).join(', ') || 'Track more data'}`
    };

    return prompts[questionType] || `${basePrompt} ${businessMetrics} Provide specific, actionable advice for their salon business growth.`;
  };



  // Enhanced fallback messages
  const getFallbackMessage = (stage, salonOwnerName, analyticsData) => {
    const firstName = getFirstName(salonOwnerName);
    const {
      totalShares = 0,
      totalClicks = 0,
      totalClients = 0,
      clickThroughRate = 0,
      avgEngagementRate = 0,
      bestDay = 'N/A',
      peakHours = [],
      platformPerformance = {},
      ugcAnalytics = {}
    } = analyticsData || {};

    const ugcText = ugcAnalytics.total_ugc_discovered > 0
      ? ` Your clients have generated ${ugcAnalytics.total_ugc_discovered} social posts (${ugcAnalytics.ugc_generation_rate}% UGC rate)!`
      : '';

    switch(stage) {
      case 'first-time':
        return `${firstName}, welcome to PostMyStyle.AI! üéâ This AI advisor will provide personalized business insights as your team starts uploading photos and building your client database. Focus on before/after transformation photos and track which services get the most engagement. Start having your stylists share their amazing work to unlock powerful analytics that'll help you grow your salon and attract high-value clients in the beauty and wellness industry!`;

      case 'early':
        return `${firstName}, excellent progress! Your team is building momentum with ${totalShares} shares and ${totalClients} clients.${ugcText} For business growth, focus on posting before/after content and tracking client service cycles. Keep encouraging your stylists to upload photos of their work to unlock deeper business insights and engagement analytics that will help you identify your most profitable services and optimal posting times!`;

      case 'growing':
        const instagramShares = platformPerformance?.instagram?.shares || 0;
        const insights = [];

        if (clickThroughRate > 5) insights.push(`Your ${clickThroughRate}% engagement rate is above industry average!`);
        if (bestDay && bestDay !== 'N/A') insights.push(`${bestDay} posts perform best for transformations`);
        if (instagramShares > 50) insights.push(`Instagram is driving your growth`);
        if (peakHours?.length > 0) insights.push(`${peakHours[0]} is your golden hour`);
        if (ugcAnalytics.ugc_generation_rate > 10) insights.push(`Excellent ${ugcAnalytics.ugc_generation_rate}% client UGC rate`);

        const insightText = insights.length > 0 ? ` ${insights.slice(0, 2).join('. ')}.` : '';

        return `${firstName}, you're building an impressive salon business! With ${totalShares} shares, ${totalClicks} views, and ${totalClients} clients, your team is on track for growth.${ugcText}${insightText} Focus on your most popular services and consider posting more before/after transformations on ${bestDay} to boost engagement. Your data shows great potential for premium service positioning!`;

      case 'power-user':
        return `${firstName}, your salon is absolutely crushing it! Your team's data is impressive: ${totalShares} shares, ${totalClicks} views, and a strong ${clickThroughRate}% engagement rate.${ugcText} Your ${bestDay} posts and ${peakHours[0] || 'peak hour'} timing strategy are working perfectly. Consider leveraging your client data for targeted marketing, premium service packages, and referral programs to maximize your already strong revenue potential!`;

      default:
        return `${firstName}, keep up the fantastic work! Every photo your team shares and client session you track builds valuable insights for growing your business. Your dedication to your craft shows in your results! Focus on transformation services and before/after content to attract high-value clients. üí™`;
    }
  };

  // Main AI insights generation function
  async function generateAIInsights(isManualRefresh = false) {
    const now = Date.now();
    if (GLOBAL_AI_CACHE.lastGeneratedTime && !isManualRefresh && (now - GLOBAL_AI_CACHE.lastGeneratedTime) < 30000) {
      console.log('‚è±Ô∏è AI generation skipped - too soon since last call');
      return;
    }

    const salonOwnerName = salonData?.salon_name || 'Your Salon';

    if (GLOBAL_AI_CACHE.hasGenerated && GLOBAL_AI_CACHE.lastStylistName === salonOwnerName && !isManualRefresh) {
      console.log('‚úÖ AI generation skipped - using cached message for', salonOwnerName);
      if (!aiMessageFull && GLOBAL_AI_CACHE.cachedMessage) {
        displayAIMessage(GLOBAL_AI_CACHE.cachedMessage);
      }
      return;
    }

    console.log('üöÄ Enhanced AI generation starting...', {
      isManualRefresh,
      salonOwnerName,
      hasGenerated: GLOBAL_AI_CACHE.hasGenerated,
      lastStylist: GLOBAL_AI_CACHE.lastStylistName
    });

    setAILoadingState(true);
    GLOBAL_AI_CACHE.lastGeneratedTime = now;
    GLOBAL_AI_CACHE.lastStylistName = salonOwnerName;

    try {
      const stage = getUserStage(currentAnalyticsData);
      console.log('üéØ AI stage:', stage);

      const prompt = getPromptForStage(stage, salonOwnerName, currentAnalyticsData);
      const message = await callClaude(prompt);

      displayAIMessage(message);
      updateAIStage(stage);

      GLOBAL_AI_CACHE.hasGenerated = true;
      GLOBAL_AI_CACHE.cachedMessage = message;

      console.log('‚úÖ Enhanced AI message generated and cached successfully');
    } catch (error) {
      console.error('‚ùå Enhanced AI generation failed:', error.message);

      const stage = getUserStage(currentAnalyticsData);
      const fallbackMessage = getFallbackMessage(stage, salonOwnerName, currentAnalyticsData);

      displayAIMessage(fallbackMessage);
      updateAIStage(stage);

      GLOBAL_AI_CACHE.hasGenerated = true;
      GLOBAL_AI_CACHE.cachedMessage = fallbackMessage;
    } finally {
      setAILoadingState(false);
    }
  }

  // Quick action handlers
  const handleQuickAction = async (actionType) => {
    setAILoadingState(true);
    hideAISections();

    const salonOwnerName = salonData?.salon_name || 'Your Salon';

    try {
      const prompt = getIndustrySpecificPrompts(actionType, salonOwnerName, currentAnalyticsData);
      const response = await callClaude(prompt);

      displayAIMessage(response);
      GLOBAL_AI_CACHE.cachedMessage = response;

      // Store in conversation history
      GLOBAL_AI_CACHE.conversationHistory.push({
        type: 'quick_action',
        action: actionType,
        response: response,
        timestamp: Date.now()
      });
    } catch (error) {
      console.error('Quick action failed:', error);
      const firstName = getFirstName(salonOwnerName);
      const fallback = getFallbackMessage('growing', salonOwnerName, currentAnalyticsData);
      displayAIMessage(fallback);
      GLOBAL_AI_CACHE.cachedMessage = fallback;
    }

    setAILoadingState(false);
  };

  // Custom question handler
  const handleCustomQuestion = async () => {
    const question = document.getElementById('customQuestionInput').value.trim();
    if (!question) {
      alert('Please enter a question first.');
      return;
    }

    // Check if question is too vague and needs clarification
    const isVague = question.length < 20 ||
      !(['how', 'what', 'when', 'where', 'why', 'which'].some(word =>
        question.toLowerCase().includes(word)));

    setAILoadingState(true);
    hideAISections();

    const salonOwnerName = salonData?.salon_name || 'Your Salon';
    const firstName = getFirstName(salonOwnerName);

    // Enhanced context prompt with industry expertise and systematic analysis
    const contextPrompt = `You are an expert hair salon business consultant and data analyst with 15+ years of experience helping salon owners grow their clientele and revenue. You specialize in cuts, color services, styling, and various beauty treatments.

CRITICAL: You are analyzing ${firstName}'s actual PostMyStyle analytics data - this is REAL performance data from their salon business, not industry benchmarks. Only reference the specific data points provided.

${firstName.toUpperCase()}'S ACTUAL POSTMYSTYLE ANALYTICS DATA:
- ${currentAnalyticsData.totalShares} content shares posted
- ${currentAnalyticsData.totalClicks} total client/prospect views
- ${currentAnalyticsData.clickThroughRate || 0}% engagement rate on their posts
- ${currentAnalyticsData.totalClients} active clients tracked in PostMyStyle
- Best performing day: ${currentAnalyticsData.bestDay}
- ${currentAnalyticsData.total_product_clicks || 0} product link clicks from their posts
- Peak engagement: ${currentAnalyticsData.peakHours?.join(', ') || 'No data yet'}
- Average engagement rate: ${currentAnalyticsData.avgEngagementRate || 0}%
- UGC discovered: ${currentAnalyticsData.ugcAnalytics?.total_ugc_discovered || 0} client posts
- UGC generation rate: ${currentAnalyticsData.ugcAnalytics?.ugc_generation_rate || 0}%
- Top UGC services: ${Object.keys(currentAnalyticsData.ugcAnalytics?.ugc_by_service || {}).slice(0, 2).join(', ') || 'None yet'}

ANALYSIS FRAMEWORK:
When providing advice, systematically consider:
1. CLIENT ACQUISITION: Based on their engagement and view data
2. DATA INSIGHTS: What their PostMyStyle analytics reveal about performance
3. OPERATIONAL TACTICS: Specific daily/weekly actions to implement
4. CONTENT OPTIMIZATION: Using their actual peak times and best performing days
5. CLIENT ENGAGEMENT: Strategies based on their tracked client interactions
6. UGC LEVERAGE: How to use client-generated content for growth

RESPONSE REQUIREMENTS:
- Start with "${firstName},"
- Provide 3-4 SPECIFIC, ACTIONABLE tactics based on their actual data
- Reference only the PostMyStyle data points provided above
- Include at least one immediate action they can take this week
- Suggest one metric to track progress using PostMyStyle
- Keep under 200 words but be substantive
- Do not mention your years of experience in your response
- NEVER reference retention rates, referral rates, or other data you don't have access to
- Focus only on content performance, engagement, client tracking, and UGC data available in PostMyStyle

${isVague ? `NOTE: The question "${question}" seems general. Provide specific actionable advice based on their PostMyStyle data anyway, but also suggest 2-3 clarifying questions they could ask for even more targeted help.` : ''}

QUESTION TO ANALYZE: "${question}"

Based on ${firstName}'s actual PostMyStyle analytics data shown above, provide expert-level, actionable business advice that addresses their question directly.`;

    try {
      const response = await callClaude(contextPrompt);
      displayAIMessage(response);
      GLOBAL_AI_CACHE.cachedMessage = response;

      // Store in conversation history
      GLOBAL_AI_CACHE.conversationHistory.push({
        type: 'custom_question',
        question: question,
        response: response,
        timestamp: Date.now()
      });
    } catch (error) {
      // Enhanced fallback that's also more specific
      const fallback = `${firstName}, I'd love to help you with "${question}". Based on your PostMyStyle analytics showing ${currentAnalyticsData.totalShares} shares and ${currentAnalyticsData.clickThroughRate || 0}% engagement rate, you're building good momentum. ${currentAnalyticsData.ugcAnalytics?.total_ugc_discovered > 0 ? `Your ${currentAnalyticsData.ugcAnalytics.total_ugc_discovered} client posts show great UGC performance! ` : ''}Focus on posting content on ${currentAnalyticsData.bestDay}s when your engagement peaks, and track which content types generate the most views from your current ${currentAnalyticsData.totalClicks} total views. Your ${currentAnalyticsData.peakHours?.[0] || 'evening'} posting time is working well - continue leveraging that for maximum visibility!`;
      displayAIMessage(fallback);
      GLOBAL_AI_CACHE.cachedMessage = fallback;
    }

    document.getElementById('customQuestionInput').value = '';
    setAILoadingState(false);
  };

  // AI UI helper functions
  function setAILoadingState(loading) {
    isGeneratingAI = loading;
    document.getElementById('aiLoading').style.display = loading ? 'flex' : 'none';
    document.getElementById('aiMessage').style.display = loading ? 'none' : 'block';
    document.getElementById('aiWelcome').style.display = loading ? 'none' : 'none';
  }

  function hideAISections() {
    document.getElementById('quickActionsSection').style.display = 'none';
    document.getElementById('customQuestionSection').style.display = 'none';
    document.getElementById('quickActionsBtn').classList.remove('active');
    document.getElementById('customQuestionBtn').classList.remove('active');
  }

  function displayAIMessage(message) {
    // Clean the message first
    const cleanedMessage = cleanAIResponse(message);
    aiMessageFull = cleanedMessage;

    // Truncate message if too long
    if (cleanedMessage.length > 200) {
      aiMessageTruncated = cleanedMessage.substring(0, 200) + '...';
      document.getElementById('aiExpandBtn').style.display = 'flex';
    } else {
      aiMessageTruncated = cleanedMessage;
      document.getElementById('aiExpandBtn').style.display = 'none';
    }

    // Format the message for display
    const formattedMessage = formatAIInsight(isAIExpanded ? aiMessageFull : aiMessageTruncated);
    document.getElementById('aiMessageText').innerHTML = formattedMessage;
    document.getElementById('aiMessage').style.display = 'block';
    document.getElementById('aiWelcome').style.display = 'none';

    // Update last updated time
    const now = new Date();
    document.getElementById('aiLastUpdated').textContent = `Updated: ${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
  }

  function updateAIStage(stage) {
    const stageLabels = {
      'first-time': 'Startup Salon',
      early: 'Growing Business',
      growing: 'Established Salon',
      'power-user': 'Enterprise Operation'
    };

    document.getElementById('aiStageText').textContent = `Business Stage: ${stageLabels[stage] || 'Growing Salon'}`;
  }

  function toggleAIMessage() {
    isAIExpanded = !isAIExpanded;
    const formattedMessage = formatAIInsight(isAIExpanded ? aiMessageFull : aiMessageTruncated);
    document.getElementById('aiMessageText').innerHTML = formattedMessage;
    document.getElementById('expandText').textContent = isAIExpanded ? 'Show Less' : 'Read More';
    document.getElementById('expandIcon').textContent = isAIExpanded ? '‚ñ≤' : '‚ñº';
  }

  function toggleQuickActions() {
    const section = document.getElementById('quickActionsSection');
    const btn = document.getElementById('quickActionsBtn');
    const customSection = document.getElementById('customQuestionSection');
    const customBtn = document.getElementById('customQuestionBtn');

    if (section.style.display === 'none' || section.style.display === '') {
      section.style.display = 'block';
      btn.classList.add('active');
      // Hide custom question section
      customSection.style.display = 'none';
      customBtn.classList.remove('active');
    } else {
      section.style.display = 'none';
      btn.classList.remove('active');
    }
  }

  function toggleCustomQuestion() {
    const section = document.getElementById('customQuestionSection');
    const btn = document.getElementById('customQuestionBtn');
    const quickSection = document.getElementById('quickActionsSection');
    const quickBtn = document.getElementById('quickActionsBtn');

    if (section.style.display === 'none' || section.style.display === '') {
      section.style.display = 'block';
      btn.classList.add('active');
      // Hide quick actions section
      quickSection.style.display = 'none';
      quickBtn.classList.remove('active');
      // Focus on input
      document.getElementById('customQuestionInput').focus();
    } else {
      section.style.display = 'none';
      btn.classList.remove('active');
    }
  }

  // Quick action event handlers
  async function askQuickQuestion(topic) {
    await handleQuickAction(topic);
  }

  async function askCustomQuestion() {
    await handleCustomQuestion();
  }

  // Clean AI response from meta-text and formatting instructions
  function cleanAIResponse(response) {
    if (!response) return '';

    // Remove common meta-text patterns
    let cleaned = response
      .replace(/\*\*Key Insight \([^)]+\):\*\*/g, '')
      .replace(/\*\*Specific Advice \([^)]+\):\*\*/g, '')
      .replace(/\(?\d+\s*words?\)?/gi, '')
      .replace(/Under \d+ words/gi, '')
      .replace(/In \d+ words/gi, '')
      .replace(/Key Insight:/gi, '')
      .replace(/Specific Advice:/gi, '')
      .replace(/^\*\*|\*\*$/g, '')
      .trim();

    return cleaned;
  }

  // Format AI insight for better UX
  function formatAIInsight(insight) {
    if (!insight) return '';

    // Split into paragraphs and format numbered lists
    let formatted = insight
      .split('\n')
      .map(line => line.trim())
      .filter(line => line.length > 0)
      .map(line => {
        // Format numbered points
        if (/^\d+\./.test(line)) {
          return `<strong style="color: #0ea5e9;">‚Ä¢ ${line.replace(/^\d+\.\s*/, '')}</strong>`;
        }
        // Format bold sections
        line = line.replace(/\*\*(.*?)\*\*/g, '<strong style="color: #1f2937;">$1</strong>');
        return line;
      })
      .join('<br><br>');

    return formatted;
  }

  // ===== UGC ANALYTICS FUNCTIONS (FROM MOBILE APP) =====

  // Calculate UGC analytics from data
  async function calculateUGCAnalytics(salonId) {
    try {
      console.log('üìä Calculating UGC analytics for salon:', salonId);

      // Call the UGC analytics RPC function
      const { data: ugcData, error: ugcError } = await supabase
        .rpc('calculate_ugc_analytics', {
          target_stylist_id: null, // For salon-wide analytics
          days: 30
        });

      if (ugcError) {
        console.error('UGC calculation error:', ugcError);
        return getDefaultUGCAnalytics();
      }

      console.log('‚úÖ UGC analytics calculated:', ugcData);
      return ugcData || getDefaultUGCAnalytics();

    } catch (error) {
      console.error('‚ùå UGC analytics calculation failed:', error);
      return getDefaultUGCAnalytics();
    }
  }

  // Default UGC analytics structure
  function getDefaultUGCAnalytics() {
    return {
      total_ugc_discovered: 0,
      ugc_generation_rate: 0,
      discovery_success_rate: 0,
      avg_discovery_time_hours: 0,
      avg_salon_engagement: 0,
      total_salon_shares: 0,
      ugc_velocity: 0,
      recent_vs_historical_rate: 100,
      ugc_by_service: {},
      ugc_by_platform: {}
    };
  }

  // Get platform icon for UGC display
  function getPlatformIcon(platform) {
    switch (platform?.toLowerCase()) {
      case 'instagram': return 'üì∑';
      case 'facebook': return 'üìò';
      case 'tiktok': return 'üéµ';
      default: return 'üì±';
    }
  }

  // Get platform color for UGC display
  function getPlatformColor(platform) {
    switch (platform?.toLowerCase()) {
      case 'instagram': return '#E1306C';
      case 'facebook': return '#4267B2';
      case 'tiktok': return '#000000';
      default: return '#757575';
    }
  }

  // Render UGC analytics section
  function renderUGCAnalytics(analytics) {
    if (!analytics.ugcAnalytics) {
      console.log('No UGC analytics data available');
      return;
    }

    const {
      total_ugc_discovered = 0,
      ugc_generation_rate = 0,
      discovery_success_rate = 0,
      avg_discovery_time_hours = 0,
      avg_salon_engagement = 0,
      total_salon_shares = 0,
      ugc_velocity = 0,
      recent_vs_historical_rate = 100,
      ugc_by_platform = {},
      ugc_by_service = {}
    } = analytics.ugcAnalytics;

    // Update hero metrics
    document.getElementById('ugcGenerationRate').textContent = `${ugc_generation_rate.toFixed(1)}%`;
    document.getElementById('ugcTotalDiscovered').textContent = total_ugc_discovered;
    document.getElementById('ugcEngagement').textContent = Math.round(avg_salon_engagement);

    // Update hero metric colors based on performance
    const generationElement = document.getElementById('ugcGenerationRate');
    if (ugc_generation_rate > 25) {
      generationElement.style.color = '#4CAF50';
    } else if (ugc_generation_rate > 15) {
      generationElement.style.color = '#2196F3';
    } else {
      generationElement.style.color = '#FF9800';
    }

    // Render insights
    renderUGCInsights(analytics.ugcAnalytics);

    // Render platform distribution
    if (Object.keys(ugc_by_platform).length > 0) {
      renderUGCPlatforms(ugc_by_platform);
    }

    // Render top services
    if (Object.keys(ugc_by_service).length > 0) {
      renderUGCServices(ugc_by_service);
    }

    // Update trend indicator
    updateUGCTrend(recent_vs_historical_rate, ugc_velocity);

    // Generate recommendations
    generateUGCRecommendations(analytics.ugcAnalytics);
  }

  // Render UGC insights
  function renderUGCInsights(ugcData) {
    const {
      ugc_generation_rate = 0,
      avg_discovery_time_hours = 0,
      ugc_velocity = 0
    } = ugcData;

    const getGenerationStatus = (rate) => {
      if (rate > 25) return { status: "ü•á Excellent", color: "#4CAF50" };
      if (rate > 15) return { status: "‚úÖ Good", color: "#2196F3" };
      return { status: "‚ö†Ô∏è Needs Improvement", color: "#FF9800" };
    };

    const getTimingStatus = (hours) => {
      if (hours < 24) return { status: "‚ö° Immediate", color: "#4CAF50" };
      if (hours < 72) return { status: "‚úÖ Normal", color: "#2196F3" };
      return { status: "‚è∞ Delayed", color: "#FF9800" };
    };

    const getVelocityStatus = (velocity) => {
      if (velocity > 3) return { status: "üöÄ High Volume", color: "#4CAF50" };
      if (velocity > 1) return { status: "üìà Steady Growth", color: "#2196F3" };
      return { status: "üå± Building", color: "#FF9800" };
    };

    const generationStatus = getGenerationStatus(ugc_generation_rate);
    const timingStatus = getTimingStatus(avg_discovery_time_hours);
    const velocityStatus = getVelocityStatus(ugc_velocity);

    const insightRowsHtml = `
      <div class="ugc-insight-item">
        <div class="ugc-insight-label">Content Inspiration:</div>
        <div class="ugc-insight-status" style="color: ${generationStatus.color}">
          ${generationStatus.status}
        </div>
        <div class="ugc-insight-detail">
          ${ugc_generation_rate > 0 ? `${Math.round(100/ugc_generation_rate)} sessions per UGC` : 'No data'}
        </div>
      </div>
      <div class="ugc-insight-item">
        <div class="ugc-insight-label">Client Response Time:</div>
        <div class="ugc-insight-status" style="color: ${timingStatus.color}">
          ${timingStatus.status}
        </div>
        <div class="ugc-insight-detail">
          ${avg_discovery_time_hours > 0 ? `${avg_discovery_time_hours.toFixed(1)} hours average` : 'No timing data'}
        </div>
      </div>
      <div class="ugc-insight-item">
        <div class="ugc-insight-label">UGC Momentum:</div>
        <div class="ugc-insight-status" style="color: ${velocityStatus.color}">
          ${velocityStatus.status}
        </div>
        <div class="ugc-insight-detail">
          ${ugc_velocity.toFixed(1)} posts per day
        </div>
      </div>
    `;

    document.getElementById('ugcInsightRows').innerHTML = insightRowsHtml;
  }

  // Render UGC platform distribution
  function renderUGCPlatforms(ugc_by_platform) {
    const platformContainer = document.getElementById('ugcPlatformContainer');
    const platformGrid = document.getElementById('ugcPlatformGrid');

    if (Object.keys(ugc_by_platform).length === 0) {
      platformContainer.style.display = 'none';
      return;
    }

    platformContainer.style.display = 'block';

    const platformsHtml = Object.entries(ugc_by_platform).map(([platform, count]) => `
      <div class="ugc-platform-item">
        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">${getPlatformIcon(platform)}</div>
        <div class="ugc-platform-count">${count}</div>
        <div class="ugc-platform-name">${platform}</div>
      </div>
    `).join('');

    platformGrid.innerHTML = platformsHtml;
  }

  // Render UGC top services
  function renderUGCServices(ugc_by_service) {
    const servicesContainer = document.getElementById('ugcServicesContainer');
    const servicesList = document.getElementById('ugcServicesList');

    if (Object.keys(ugc_by_service).length === 0) {
      servicesContainer.style.display = 'none';
      return;
    }

    servicesContainer.style.display = 'block';

    const sortedServices = Object.entries(ugc_by_service)
      .sort(([,a], [,b]) => b - a)
      .slice(0, 3);

    const servicesHtml = sortedServices.map(([service, count], index) => `
      <div class="ugc-service-item">
        <div class="ugc-service-rank">${index + 1}</div>
        <div class="ugc-service-name">${service}</div>
        <div class="ugc-service-count">${count} posts</div>
      </div>
    `).join('');

    servicesList.innerHTML = servicesHtml;
  }

  // Update UGC trend indicator
  function updateUGCTrend(recent_vs_historical_rate, ugc_velocity) {
    const trendIcon = document.getElementById('ugcTrendIcon');
    const trendText = document.getElementById('ugcTrendText');
    const trendDetail = document.getElementById('ugcTrendDetail');

    if (recent_vs_historical_rate > 110) {
      trendIcon.textContent = 'üìà';
      trendText.textContent = 'Growing momentum';
      trendDetail.textContent = `${recent_vs_historical_rate.toFixed(0)}% vs previous period`;
    } else if (recent_vs_historical_rate < 90) {
      trendIcon.textContent = 'üìâ';
      trendText.textContent = 'Declining trend';
      trendDetail.textContent = `${recent_vs_historical_rate.toFixed(0)}% vs previous period`;
    } else {
      trendIcon.textContent = 'üìä';
      trendText.textContent = 'Stable performance';
      trendDetail.textContent = `${recent_vs_historical_rate.toFixed(0)}% vs previous period`;
    }
  }

  // Generate UGC recommendations
  function generateUGCRecommendations(ugcData) {
    const {
      ugc_generation_rate = 0,
      avg_discovery_time_hours = 0
    } = ugcData;

    const recommendations = [];

    // Low generation rate
    if (ugc_generation_rate < 15) {
      recommendations.push({
        icon: "üí°",
        title: "Boost UGC Generation",
        color: "#FF9800",
        actions: [
          "Add sharing CTAs to appointment reminders",
          "Create Instagram-worthy photo setups",
          "Offer small incentives for social sharing"
        ]
      });
    }

    // Slow response time
    if (avg_discovery_time_hours > 72) {
      recommendations.push({
        icon: "‚è∞",
        title: "Improve Response Timing",
        color: "#2196F3",
        actions: [
          "Send sharing reminders 24h after visit",
          "Create immediate wow moments during service",
          "Follow up personally with clients"
        ]
      });
    }

    const recommendationsContainer = document.getElementById('ugcRecommendations');
    const recommendationsList = document.getElementById('ugcRecommendationsList');

    if (recommendations.length === 0) {
      recommendationsContainer.style.display = 'none';
      return;
    }

    recommendationsContainer.style.display = 'block';

    const recommendationsHtml = recommendations.map(rec => `
      <div class="ugc-recommendation-card">
        <div class="ugc-recommendation-header">
          <span style="font-size: 1.2rem;">${rec.icon}</span>
          <span class="ugc-recommendation-title" style="color: ${rec.color};">
            ${rec.title}
          </span>
        </div>
        ${rec.actions.map(action => `
          <div class="ugc-recommendation-action">‚Ä¢ ${action}</div>
        `).join('')}
      </div>
    `).join('');

    recommendationsList.innerHTML = recommendationsHtml;
  }

  // ===== EXISTING FUNCTIONALITY (PRESERVED) =====

  // UPDATED: Enhanced analytics calculation with UGC integration
  async function calculateRealTimeAnalytics(salonId) {
    try {
      console.log('üìä Calculating analytics with enhanced UGC integration...');

      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

      // Get stylists count
      const { data: stylists } = await supabase
        .from('stylists')
        .select('id, created_at')
        .eq('salon_id', salonId);

      // Get media_send data
      const { data: currentPosts } = await supabase
        .from('media_send')
        .select('*, stylists!inner(salon_id)')
        .eq('stylists.salon_id', salonId)
        .gte('send_timestamp', thirtyDaysAgo.toISOString());

      console.log(`üìä Found ${currentPosts?.length || 0} media_send records for analysis`);

      if (!currentPosts) {
        console.warn('No media_send data available');
        return {
          total_stylists: stylists?.length || 0,
          total_clients: 0,
          total_media_sends: 0,
          total_clicks: 0,
          total_instagram_shares: 0,
          total_facebook_shares: 0,
          total_tiktok_shares: 0,
          total_product_clicks: 0,
          salon_products: [],
          growth_data: { shares_growth: 0, views_growth: 0, engagement_growth: 0 },
          ugcAnalytics: getDefaultUGCAnalytics()
        };
      }

      // Basic aggregations from media_send data
      const totalStylists = stylists?.length || 0;

      // Count unique clients from media_send.client_id
      const uniqueClientIds = new Set();
      currentPosts.forEach(post => {
        if (post.client_id) {
          uniqueClientIds.add(post.client_id);
        }
      });
      const totalClients = uniqueClientIds.size;

      const totalShares = currentPosts.length;
      const totalViews = currentPosts.reduce((sum, ms) => sum + (ms.click_count || 0), 0);

      // Get product clicks from media_send summary field
      const totalProductClicksFromSummary = currentPosts.reduce((sum, ms) => sum + (ms.product_clicks || 0), 0);

      // Get detailed product interactions from the proper table
      const { data: productInteractions } = await supabase
        .from('product_interactions')
        .select(`
          *,
          media_send!inner(
            stylist_id,
            stylists!inner(salon_id)
          )
        `)
        .eq('media_send.stylists.salon_id', salonId)
        .gte('click_timestamp', thirtyDaysAgo.toISOString());

      const totalProductClicksFromInteractions = productInteractions?.length || 0;

      // Get salon's active products for better reporting
      const { data: salonProducts } = await supabase
        .from('salon_products')
        .select(`
          *,
          products(*)
        `)
        .eq('salon_id', salonId)
        .eq('is_active', true);

      // Social shares
      const totalInstagram = currentPosts.reduce((sum, ms) => sum + (ms.share_instagram || 0), 0);
      const totalFacebook = currentPosts.reduce((sum, ms) => sum + (ms.share_facebook || 0), 0);
      const totalTikTok = currentPosts.reduce((sum, ms) => sum + (ms.share_tiktok || 0), 0);

      // Use the more accurate count between summary and detailed tracking
      const totalProductClicks = Math.max(totalProductClicksFromSummary, totalProductClicksFromInteractions);

      // ENHANCED: Calculate UGC analytics
      const ugcAnalytics = await calculateUGCAnalytics(salonId);

      const result = {
        total_stylists: totalStylists,
        total_clients: totalClients,
        total_media_sends: totalShares,
        total_clicks: totalViews,
        total_instagram_shares: totalInstagram,
        total_facebook_shares: totalFacebook,
        total_tiktok_shares: totalTikTok,
        total_product_clicks: totalProductClicks,
        salon_products: salonProducts || [],
        product_interactions: productInteractions || [],
        growth_data: {
          shares_growth: 0,
          views_growth: 0,
          engagement_growth: 0,
          current_posts: currentPosts
        },
        ugcAnalytics: ugcAnalytics
      };

      console.log('‚úÖ ENHANCED ANALYTICS SUCCESS with UGC:', {
        stylists: totalStylists,
        clients: totalClients,
        posts: totalShares,
        views: totalViews,
        productClicks: totalProductClicks,
        salonProducts: salonProducts?.length || 0,
        ugcDiscovered: ugcAnalytics.total_ugc_discovered
      });

      return result;

    } catch (error) {
      console.error('‚ùå Enhanced analytics calculation failed:', error);
      return null;
    }
  }

  // UPDATED: Load stylists data with enhanced analytics
  async function loadStylistsData(salonId) {
    try {
      const { data: stylists, error } = await supabase
        .from('stylists')
        .select('*')
        .eq('salon_id', salonId);

      if (error) throw error;

      console.log('üë• Loading stylist data with enhanced tracking...');

      // Get media_send data for all stylists
      const { data: mediaSends, error: mediaError } = await supabase
        .from('media_send')
        .select('*')
        .in('stylist_id', stylists.map(s => s.id));

      if (mediaError) {
        console.error('Media sends error:', mediaError);
      }

      // Get product interactions by stylist for more detailed analysis
      const { data: productInteractionsByStylist } = await supabase
        .from('product_interactions')
        .select(`
          *,
          media_send!inner(stylist_id)
        `)
        .in('media_send.stylist_id', stylists.map(s => s.id));

      // Process each stylist with enhanced data
      stylistsData = stylists.map(stylist => {
        const stylistPosts = mediaSends?.filter(ms => ms.stylist_id === stylist.id) || [];
        const stylistProductInteractions = productInteractionsByStylist?.filter(pi =>
          pi.media_send?.stylist_id === stylist.id) || [];

        // Count unique clients for this stylist
        const uniqueClientIds = new Set();
        stylistPosts.forEach(post => {
          if (post.client_id) {
            uniqueClientIds.add(post.client_id);
          }
        });

        const totalPosts = stylistPosts.length;
        const totalViews = stylistPosts.reduce((sum, ms) => sum + (ms.click_count || 0), 0);
        const totalClients = uniqueClientIds.size;
        const totalSocialShares = stylistPosts.reduce((sum, ms) =>
          sum + (ms.share_instagram || 0) + (ms.share_facebook || 0) + (ms.share_tiktok || 0), 0);
        const engagementRate = totalPosts > 0 ? Math.round((totalSocialShares / totalPosts) * 100) : 0;

        // Enhanced product metrics per stylist
        const productClicksFromSummary = stylistPosts.reduce((sum, ms) => sum + (ms.product_clicks || 0), 0);
        const productClicksFromInteractions = stylistProductInteractions.length;
        const totalProductClicks = Math.max(productClicksFromSummary, productClicksFromInteractions);

        console.log(`‚úÖ ${stylist.stylist_name}: ${totalPosts} posts, ${totalViews} views, ${totalClients} clients, ${engagementRate}% engagement, ${totalProductClicks} product clicks`);

        return {
          ...stylist,
          totalPosts,
          totalViews,
          totalClients,
          engagementRate,
          totalProductClicks,
          productInteractions: stylistProductInteractions
        };
      });

      // Store team data for management section
      currentTeamMembers = stylistsData;

      const summary = {
        totalStylists: stylistsData.length,
        totalClients: stylistsData.reduce((sum, s) => sum + s.totalClients, 0),
        totalPosts: stylistsData.reduce((sum, s) => sum + s.totalPosts, 0),
        totalViews: stylistsData.reduce((sum, s) => sum + s.totalViews, 0),
        totalProductClicks: stylistsData.reduce((sum, s) => sum + s.totalProductClicks, 0)
      };

      console.log('üìä ENHANCED STYLIST SUMMARY:', summary);

      // Update UI
      updateTeamPerformanceTable();
      updateTeamManagementList();
      if (currentAnalyticsData) {
        displayAnalytics(currentAnalyticsData);
      }
      setTimeout(() => {
        if (activityChart) {
          updateChartsSimplified(currentAnalyticsData);
        }
      }, 100);
      generatePerformanceInsights();

    } catch (error) {
      console.error('‚ùå Enhanced stylist loading failed:', error);
    }
  }

  // NEW: Team Management Functions
  function showAddStylistForm() {
    document.getElementById('addStylistForm').style.display = 'block';
    document.getElementById('stylistName').focus();
  }

  function hideAddStylistForm() {
    document.getElementById('addStylistForm').style.display = 'none';
    // Clear form
    document.getElementById('stylistName').value = '';
    document.getElementById('stylistEmail').value = '';
    document.getElementById('stylistPhone').value = '';
  }

  async function createNewStylist() {
    const name = document.getElementById('stylistName').value.trim();
    const email = document.getElementById('stylistEmail').value.trim();
    const phone = document.getElementById('stylistPhone').value.trim();

    if (!name || !email) {
      alert('Please fill in the required fields (Name and Email).');
      return;
    }

    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      alert('Please enter a valid email address.');
      return;
    }

    // Check if Supabase is available
    if (!supabase) {
      alert('Database connection not available. Please refresh the page and try again.');
      return;
    }

    try {
      console.log('Creating new stylist via Edge Function:', { name, email });

      // Get current user session for authentication
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();

      if (sessionError || !session) {
        throw new Error('You must be logged in to create stylists. Please refresh and log in again.');
      }

      console.log('User session verified, calling Edge Function...');

      // Call the Edge Function
      const { data, error } = await supabase.functions.invoke('create-stylist', {
        body: {
          name: name,
          email: email,
          phone: phone || null,
          salonId: salonData.salon_id
        },
        headers: {
          Authorization: `Bearer ${session.access_token}`,
        },
      });

      if (error) {
        console.error('Edge Function error:', error);
        throw new Error(`Function call failed: ${error.message}`);
      }

      if (!data.success) {
        throw new Error(data.error || 'Unknown error occurred');
      }

      console.log('Stylist created successfully:', data.stylist);

      // Show success modal with credentials
      showStylistCreatedModal(name, email, data.credentials.password);

      // Hide form and refresh data
      hideAddStylistForm();
      await loadStylistsData(salonData.salon_id);

    } catch (error) {
      console.error('Error creating stylist:', error);
      alert(`‚ùå Error creating stylist: ${error.message}`);
    }
  }

  function showStylistCreatedModal(name, email, password) {
    const modal = document.getElementById('drillDownModal');
    const title = document.getElementById('modalTitle');
    const content = document.getElementById('modalContent');

    title.textContent = '‚úÖ Stylist Created Successfully';
    content.innerHTML = `
      <div style="text-align: center; padding: 2rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üë§</div>

        <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
          <h3 style="margin: 0 0 1rem 0; color: #0369a1;">New Stylist Account Created</h3>
          <div style="text-align: left; background: white; padding: 1.5rem; border-radius: 8px; margin: 1rem 0;">
            <div style="margin-bottom: 1rem;">
              <strong style="color: #374151;">Name:</strong>
              <span style="color: #059669; font-weight: 600;">${name}</span>
            </div>
            <div style="margin-bottom: 1rem;">
              <strong style="color: #374151;">Email:</strong>
              <span style="color: #059669; font-weight: 600;">${email}</span>
            </div>
            <div style="margin-bottom: 1rem;">
              <strong style="color: #374151;">Temporary Password:</strong>
              <div style="background: #fef3c7; border: 2px solid #f59e0b; padding: 1rem; border-radius: 8px; margin-top: 0.5rem;">
                <code style="font-size: 1.2rem; font-weight: bold; color: #92400e; letter-spacing: 1px;">${password}</code>
                <button onclick="copyToClipboard('${password}')" style="background: #f59e0b; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; margin-left: 1rem; cursor: pointer; font-size: 0.8rem;">
                  üìã Copy
                </button>
              </div>
            </div>
          </div>
        </div>

        <div style="background: #e0f2fe; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem; text-align: left;">
          <h4 style="margin: 0 0 1rem 0; color: #0369a1;">üì± Next Steps:</h4>
          <ol style="margin: 0; color: #374151; line-height: 1.6;">
            <li><strong>Share credentials</strong> with ${name} (email/text/in-person)</li>
            <li><strong>Download PostMyStyle app</strong> from App Store/Google Play</li>
            <li><strong>Log in</strong> using the email and temporary password above</li>
            <li><strong>Change password</strong> on first login (recommended)</li>
            <li><strong>Start creating posts</strong> for clients!</li>
          </ol>
        </div>

        <div style="display: flex; gap: 1rem; justify-content: center;">
          <button onclick="copyCredentials('${name}', '${email}', '${password}')" style="background: #0ea5e9; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
            üìã Copy All Info
          </button>
          <button onclick="closeDrillDown()" style="background: #22c55e; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
            ‚úÖ Done
          </button>
        </div>
      </div>
    `;

    modal.classList.add('active');
  }

  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
      // Show brief success feedback
      const buttons = document.querySelectorAll('button');
      const button = Array.from(buttons).find(btn => btn.textContent.includes('Copy'));
      if (button) {
        const originalText = button.textContent;
        button.textContent = '‚úÖ Copied!';
        button.style.background = '#22c55e';
        setTimeout(() => {
          button.textContent = originalText;
          button.style.background = '#f59e0b';
        }, 2000);
      } else {
        alert('‚úÖ Password copied to clipboard!');
      }
    }).catch(err => {
      console.error('Copy failed:', err);
      alert('Copy failed. Please manually copy the password: ' + text);
    });
  }

  function copyCredentials(name, email, password) {
    const text = `PostMyStyle App Login Credentials

Name: ${name}
Email: ${email}
Temporary Password: ${password}

Instructions:
1. Download PostMyStyle app from App Store/Google Play
2. Log in with the email and password above
3. Change password on first login (recommended)
4. Start creating posts for your clients!

Welcome to the team! üéâ`;

    navigator.clipboard.writeText(text).then(() => {
      alert('‚úÖ All credentials copied to clipboard!\n\nYou can now paste this into an email, text message, or share however you prefer.');
    }).catch(err => {
      console.error('Copy failed:', err);
      alert('Copy failed. Please manually copy the credentials shown above.');
    });
  }

  function updateTeamManagementList() {
    const teamList = document.getElementById('teamList');

    if (!currentTeamMembers || currentTeamMembers.length === 0) {
      teamList.innerHTML = `
        <div style="text-align: center; padding: 3rem; color: #666;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üë•</div>
          <p>No team members found. Add your first stylist to get started!</p>
        </div>
      `;
      return;
    }

    teamList.innerHTML = currentTeamMembers.map(member => `
      <div class="team-member-card">
        <div class="team-member-header">
          <div class="team-member-info">
            <h4>${member.stylist_name}</h4>
            <p>${member.email || 'No email'} ${member.phone ? `‚Ä¢ ${member.phone}` : ''}</p>
            <p style="color: #22c55e; font-size: 0.8rem; margin-top: 0.5rem;">
              ${member.totalPosts} posts ‚Ä¢ ${member.totalViews} views ‚Ä¢ ${member.totalClients} clients
            </p>
          </div>
          <div class="team-member-actions">
            <button class="btn-small btn-edit" onclick="editStylist('${member.id}')">Edit</button>
            <button class="btn-small btn-delete" onclick="deleteStylist('${member.id}', '${member.stylist_name}')">Delete</button>
          </div>
        </div>
      </div>
    `).join('');
  }

  function editStylist(stylistId) {
    // Find the stylist
    const stylist = currentTeamMembers.find(s => s.id === stylistId);
    if (!stylist) return;

    // For now, show basic edit options
    const newName = prompt('Edit stylist name:', stylist.stylist_name);
    const newPhone = prompt('Edit phone number:', stylist.phone || '');

    if (newName && newName !== stylist.stylist_name) {
      updateStylist(stylistId, { stylist_name: newName, phone: newPhone });
    }
  }

  async function updateStylist(stylistId, updates) {
    try {
      const { error } = await supabase
        .from('stylists')
        .update(updates)
        .eq('id', stylistId);

      if (error) throw error;

      alert('Stylist updated successfully!');
      await loadStylistsData(salonData.salon_id);
    } catch (error) {
      console.error('Error updating stylist:', error);
      alert(`Error updating stylist: ${error.message}`);
    }
  }

  async function deleteStylist(stylistId, stylistName) {
    const confirmed = confirm(`Are you sure you want to delete ${stylistName}?\n\nThis will:\n- Remove them from your team\n- Disable their app access\n- Keep their historical data for analytics\n\nThis action cannot be undone.`);

    if (!confirmed) return;

    try {
      // Note: We should soft delete to preserve analytics data
      const { error } = await supabase
        .from('stylists')
        .update({ status: 'inactive' })
        .eq('id', stylistId);

      if (error) throw error;

      alert('Stylist removed successfully!');
      await loadStylistsData(salonData.salon_id);
    } catch (error) {
      console.error('Error deleting stylist:', error);
      alert(`Error removing stylist: ${error.message}`);
    }
  }

  // NEW: Product Management Functions
  async function loadAllProducts() {
    try {
      console.log('Loading all products...');

      const { data: products, error } = await supabase
        .from('products')
        .select('*')
        .eq('is_available', true)
        .order('brand', { ascending: true });

      if (error) throw error;

      allProducts = products || [];
      console.log(`Loaded ${allProducts.length} products`);

      // Load salon's current products
      await loadSalonProducts();

      // Render products
      renderProductsGrid();
      setupProductFilters();

    } catch (error) {
      console.error('Error loading products:', error);
      document.getElementById('productsGrid').innerHTML = `
        <div style="text-align: center; padding: 3rem; color: #ef4444; grid-column: 1 / -1;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
          <p>Error loading products. Please try again.</p>
        </div>
      `;
    }
  }

  async function loadSalonProducts() {
    try {
      const { data: salonProducts, error } = await supabase
        .from('salon_products')
        .select('product_id')
        .eq('salon_id', salonData.salon_id)
        .eq('is_active', true);

      if (error) throw error;

      selectedProducts = new Set(salonProducts?.map(sp => sp.product_id) || []);
      console.log(`Salon has ${selectedProducts.size} selected products`);

      updateSelectedProductsSummary();

    } catch (error) {
      console.error('Error loading salon products:', error);
    }
  }

  function renderProductsGrid() {
    const grid = document.getElementById('productsGrid');

    if (allProducts.length === 0) {
      grid.innerHTML = `
        <div style="text-align: center; padding: 3rem; color: #666; grid-column: 1 / -1;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üì¶</div>
          <p>No products available at this time.</p>
        </div>
      `;
      return;
    }

    // Add products count summary
    const selectedCount = selectedProducts.size;
    const totalCount = allProducts.length;

    grid.innerHTML = `
      <div class="product-stats-summary" style="grid-column: 1 / -1;">
        <span class="products-count">Showing ${totalCount} products</span>
        <span class="selected-count">${selectedCount} selected for your salon</span>
      </div>
    ` + allProducts.map(product => {
      const isSelected = selectedProducts.has(product.id);
      const productImage = product.product_image;

      return `
        <div class="product-management-card ${isSelected ? 'selected' : ''}" data-product-id="${product.id}">
          <div class="product-image-container">
            ${productImage ?
              `<img src="${productImage}" alt="${product.product_name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
               <div class="product-image-placeholder" style="display: none;">üì¶</div>` :
              `<div class="product-image-placeholder">üì¶</div>`
            }
          </div>

          <div class="product-info-compact">
            <h4>${product.brand} ${product.product_name}</h4>
            <div class="product-meta">
              <span class="product-category-badge">${product.category}</span>
              ${product.amazon_rating ? `
                <span class="product-rating">‚≠ê ${product.amazon_rating}</span>
              ` : ''}
            </div>
            ${product.amazon_price ? `<div class="product-price">${product.amazon_price}</div>` : ''}
          </div>

          <div class="product-toggle ${isSelected ? 'active' : ''}" onclick="toggleProduct('${product.id}')" title="${isSelected ? 'Remove from salon' : 'Add to salon'}"></div>
        </div>
      `;
    }).join('');
  }

  async function toggleProduct(productId) {
    try {
      const isCurrentlySelected = selectedProducts.has(productId);

      if (isCurrentlySelected) {
        // Remove product
        const { error } = await supabase
          .from('salon_products')
          .delete()
          .eq('salon_id', salonData.salon_id)
          .eq('product_id', productId);

        if (error) throw error;

        selectedProducts.delete(productId);
        console.log('Product removed from salon');
      } else {
        // Add product
        const { error } = await supabase
          .from('salon_products')
          .insert({
            salon_id: salonData.salon_id,
            product_id: productId,
            is_active: true
          });

        if (error) throw error;

        selectedProducts.add(productId);
        console.log('Product added to salon');
      }

      // Update UI
      const card = document.querySelector(`[data-product-id="${productId}"]`);
      const toggle = card.querySelector('.product-toggle');

      if (isCurrentlySelected) {
        card.classList.remove('selected');
        toggle.classList.remove('active');
      } else {
        card.classList.add('selected');
        toggle.classList.add('active');
      }

      updateSelectedProductsSummary();

      // Refresh analytics to show updated product data
      if (currentAnalyticsData) {
        await loadSalonAnalytics(salonData.salon_id);
      }

    } catch (error) {
      console.error('Error toggling product:', error);
      alert(`Error updating product: ${error.message}`);
    }
  }

  function updateSelectedProductsSummary() {
    const summary = document.getElementById('selectedProductsSummary');
    const grid = document.getElementById('summaryGrid');

    if (selectedProducts.size === 0) {
      summary.style.display = 'none';
      return;
    }

    summary.style.display = 'block';

    const selectedProductsList = allProducts.filter(p => selectedProducts.has(p.id));
    const categories = [...new Set(selectedProductsList.map(p => p.category))];
    const avgPrice = selectedProductsList.filter(p => p.amazon_price).reduce((sum, p) => sum + parseFloat(p.amazon_price), 0) / selectedProductsList.filter(p => p.amazon_price).length || 0;

    grid.innerHTML = `
      <div class="summary-stat">
        <div class="summary-number">${selectedProducts.size}</div>
        <div class="summary-label">Products Selected</div>
      </div>
      <div class="summary-stat">
        <div class="summary-number">${categories.length}</div>
        <div class="summary-label">Categories</div>
      </div>
      <div class="summary-stat">
        <div class="summary-number">${avgPrice > 0 ? avgPrice.toFixed(0) : '‚Äî'}</div>
        <div class="summary-label">Avg Price</div>
      </div>
      <div class="summary-stat">
        <div class="summary-number">${currentAnalyticsData?.total_product_clicks || 0}</div>
        <div class="summary-label">Total Clicks</div>
      </div>
    `;
  }

  function setupProductFilters() {
    // Setup category filters
    const categories = [...new Set(allProducts.map(p => p.category))];
    const filtersContainer = document.getElementById('productFilters');

    filtersContainer.innerHTML = `
      <button class="filter-btn active" data-category="all">All Categories</button>
      ${categories.map(category =>
        `<button class="filter-btn" data-category="${category}">${category}</button>`
      ).join('')}
    `;

    // Add filter event listeners
    filtersContainer.addEventListener('click', (e) => {
      if (e.target.classList.contains('filter-btn')) {
        // Update active filter
        filtersContainer.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');

        // Filter products
        filterProducts(e.target.dataset.category);
      }
    });

    // Setup search
    document.getElementById('productSearch').addEventListener('input', (e) => {
      searchProducts(e.target.value);
    });
  }

  function filterProducts(category) {
    const cards = document.querySelectorAll('.product-management-card');
    const statsRow = document.querySelector('.product-stats-summary');
    let visibleCount = 0;

    cards.forEach(card => {
      // Skip the stats summary row
      if (card.classList.contains('product-stats-summary')) return;

      const productId = card.dataset.productId;
      const product = allProducts.find(p => p.id === productId);

      if (category === 'all' || product.category === category) {
        card.style.display = 'flex';
        visibleCount++;
      } else {
        card.style.display = 'none';
      }
    });

    // Update stats
    if (statsRow) {
      const selectedCount = selectedProducts.size;
      statsRow.innerHTML = `
        <span class="products-count">Showing ${visibleCount} products${category !== 'all' ? ` in ${category}` : ''}</span>
        <span class="selected-count">${selectedCount} selected for your salon</span>
      `;
    }
  }

  function searchProducts(searchTerm) {
    const cards = document.querySelectorAll('.product-management-card');
    const statsRow = document.querySelector('.product-stats-summary');
    const term = searchTerm.toLowerCase();
    let visibleCount = 0;

    cards.forEach(card => {
      // Skip the stats summary row
      if (card.classList.contains('product-stats-summary')) return;

      const productId = card.dataset.productId;
      const product = allProducts.find(p => p.id === productId);
      const searchText = `${product.brand} ${product.product_name} ${product.category}`.toLowerCase();

      if (!term || searchText.includes(term)) {
        card.style.display = 'flex';
        visibleCount++;
      } else {
        card.style.display = 'none';
      }
    });

    // Update stats
    if (statsRow) {
      const selectedCount = selectedProducts.size;
      const searchInfo = term ? ` matching "${searchTerm}"` : '';
      statsRow.innerHTML = `
        <span class="products-count">Showing ${visibleCount} products${searchInfo}</span>
        <span class="selected-count">${selectedCount} selected for your salon</span>
      `;
    }
  }

  // Navigation functions for management sections
  function showManageTeam() {
    hideAllSections();
    setActiveNavItem('Manage Team');
    document.getElementById('teamManagementSection').classList.add('active');
    updateTeamManagementList();
  }

  function showManageProducts() {
    hideAllSections();
    setActiveNavItem('Manage Products');
    document.getElementById('productManagementSection').classList.add('active');
    if (allProducts.length === 0) {
      loadAllProducts();
    }
  }

  function hideAllSections() {
    // Hide all main sections
    const sections = [
      'dashboardSection',
      'ugcAnalyticsSection',
      'metricsSection',
      'chartsSection',
      'performanceSection',
      'teamManagementSection',
      'productManagementSection'
    ];

    sections.forEach(sectionId => {
      const section = document.getElementById(sectionId);
      if (section) {
        if (section.classList.contains('management-section')) {
          section.classList.remove('active');
        } else {
          section.style.display = 'none';
        }
      }
    });
  }

  function showDashboardSections() {
    const sections = [
      'dashboardSection',
      'ugcAnalyticsSection',
      'metricsSection',
      'chartsSection',
      'performanceSection'
    ];

    sections.forEach(sectionId => {
      const section = document.getElementById(sectionId);
      if (section) {
        section.style.display = 'block';
        // Restore any grid properties that might have been lost
        if (sectionId === 'metricsSection') {
          section.style.display = 'grid'; // metrics-grid uses CSS grid
        }
        if (sectionId === 'chartsSection') {
          section.style.display = 'grid'; // charts-section uses CSS grid
        }
      }
    });
  }

  // Load user info and salon analytics
  async function loadDashboard() {
    // Prevent multiple initializations
    if (isDashboardLoaded) {
      console.log('Dashboard already loaded, skipping...');
      return;
    }

    try {
      console.log('üöÄ Initializing enhanced dashboard...');

      // Initialize Supabase
      const supabaseReady = await initializeSupabase();
      if (!supabaseReady) {
        showErrorState('Database connection failed. Please check your internet connection and refresh the page.');
        return;
      }

      // Get current user
      const { data: { user }, error: userError } = await supabase.auth.getUser();

      if (userError || !user) {
        console.log('No authenticated user, redirecting to login');
        window.location.href = 'login.html';
        return;
      }

      currentUser = user;
      console.log('Current user:', user.id);

      // Update user name in header and sidebar
      const userName = `${user.user_metadata?.first_name || 'User'} ${user.user_metadata?.last_name || ''}`.trim();
      document.getElementById('userNameSidebar').textContent = userName;

      // Get user's salon information
      const { data: userSalon, error: salonError } = await supabase
        .from('user_salon_view')
        .select('*')
        .eq('user_id', user.id)
        .single();

      if (salonError || !userSalon) {
        console.log('No salon found for user, they may need to complete onboarding');
        showErrorState('No salon profile found. Please complete your salon setup.');
        return;
      }

      salonData = userSalon;
      console.log('Salon data:', salonData);

      // Update header sections
      document.getElementById('salonNameHeader').textContent = salonData.salon_name;
      updateLastRefreshedTime();

      // Load and display analytics using ENHANCED calculation with UGC
      await loadSalonAnalytics(salonData.salon_id);

      // Load stylists data using ENHANCED approach
      await loadStylistsData(salonData.salon_id);

      // Initialize charts only if not already initialized
      if (!activityChart) {
        initializeCharts();
        // Show loading state immediately
        showChartLoading();

        // Set up backup chart loading after 5 seconds
        setTimeout(() => {
          if (activityChart && (!stylistsData || stylistsData.length === 0)) {
            console.log('Backup chart loading triggered');
            showChartPlaceholder();
          }
        }, 5000);
      }

      // Start auto-refresh
      startAutoRefresh();

      // Mark dashboard as loaded
      isDashboardLoaded = true;
      console.log('‚úÖ Enhanced dashboard initialization complete with UGC analytics');

    } catch (error) {
      console.error('Error loading dashboard:', error);
      showErrorState('Failed to load dashboard data. Please refresh the page.');
    }
  }

  // Load salon analytics data using ENHANCED calculation with UGC
  async function loadSalonAnalytics(salonId) {
    try {
      console.log('üìä Loading salon analytics with enhanced UGC integration...');

      // Use the ENHANCED calculateRealTimeAnalytics function with UGC
      const analyticsData = await calculateRealTimeAnalytics(salonId);

      if (!analyticsData) {
        throw new Error('Failed to calculate analytics');
      }

      console.log('‚úÖ Enhanced analytics successful with UGC:', analyticsData);
      displayAnalytics(analyticsData);

      // NEW: Render UGC analytics
      renderUGCAnalytics(analyticsData);

    } catch (error) {
      console.error('‚ùå Error loading salon analytics:', error);
      showErrorState('Unable to load analytics data with enhanced integration.');
    }
  }

  // Display analytics data in the UI
  function displayAnalytics(data) {
    // Store for AI context
    currentAnalyticsData = data;

    // Remove loading states
    document.querySelectorAll('.metric-card').forEach(card => {
      card.classList.remove('loading-stats');
    });

    // Update stat numbers
    document.getElementById('totalStylists').textContent = data.total_stylists || 0;
    document.getElementById('totalClients').textContent = data.total_clients || 0;
    document.getElementById('totalShares').textContent = data.total_media_sends || 0;
    document.getElementById('totalViews').textContent = data.total_clicks || 0;
    document.getElementById('productClicks').textContent = data.total_product_clicks || 0;

    // Calculate engagement rate - Social shares are INTEGER counters, not booleans
    const totalSocialShares = (data.total_instagram_shares || 0) + (data.total_facebook_shares || 0) + (data.total_tiktok_shares || 0);
    const totalPosts = data.total_media_sends || 0;

    // Engagement rate = (Total social shares / Total posts) * 100
    // This shows how many times posts get shared on average
    const engagementRate = totalPosts > 0 ? Math.round((totalSocialShares / totalPosts) * 100) : 0;
    document.getElementById('engagementRate').textContent = `${engagementRate}%`;

    // Add calculated fields for AI context
    data.totalStylists = data.total_stylists;
    data.totalClients = data.total_clients;
    data.totalShares = data.total_media_sends;
    data.totalClicks = data.total_clicks;
    data.clickThroughRate = totalPosts > 0 ? Math.round((data.total_clicks / totalPosts) * 100) : 0;
    data.avgEngagementRate = engagementRate;
    data.bestDay = calculateBestDay(data.growth_data?.current_posts || []);
    data.peakHours = calculatePeakHours(data.growth_data?.current_posts || []);

    // Update change indicators
    updateChangeIndicators(data);

    // Update charts with real data (will be called again when stylist data loads)
    if (stylistsData && stylistsData.length > 0) {
      updateCharts(data);
    }

    console.log('‚úÖ Analytics displayed successfully with enhanced UGC integration');
  }

  // Calculate best performing day
  function calculateBestDay(posts) {
    if (!posts || posts.length === 0) return 'No data';

    const dayOfWeekCounts = Array(7).fill(0);
    posts.forEach(post => {
      const date = new Date(post.send_timestamp);
      if (!isNaN(date)) {
        dayOfWeekCounts[date.getDay()]++;
      }
    });

    const bestDayIndex = dayOfWeekCounts.indexOf(Math.max(...dayOfWeekCounts));
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    return dayNames[bestDayIndex] || 'No data';
  }

  // Calculate peak hours
  function calculatePeakHours(posts) {
    if (!posts || posts.length === 0) return [];

    const hourCounts = Array(24).fill(0);
    posts.forEach(post => {
      const date = new Date(post.send_timestamp);
      if (!isNaN(date)) {
        hourCounts[date.getHours()]++;
      }
    });

    return hourCounts
      .map((count, hour) => ({ hour, count }))
      .sort((a, b) => b.count - a.count)
      .slice(0, 3)
      .filter(item => item.count > 0)
      .map(item => {
        const hour = item.hour;
        const period = hour >= 12 ? 'PM' : 'AM';
        const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
        return `${displayHour}${period}`;
      });
  }

  // Update change indicators with real growth metrics
  function updateChangeIndicators(data) {
    // Use real growth data if available, otherwise show encouraging startup messages
    const growth = data.growth_data || {};

    const changes = {
      stylistsChange: data.total_stylists > 0 ?
        (data.total_stylists >= 5 ? `‚Üó Growing team (${data.total_stylists})` : `‚Üó Building team (${data.total_stylists})`) :
        'Add First Stylist',

      clientsChange: data.total_clients > 0 ?
        (data.total_clients >= 50 ? `‚Üó Strong base (${data.total_clients})` : `‚Üó Growing (${data.total_clients} clients)`) :
        'Start Building',

      sharesChange: growth.shares_growth !== undefined ?
        (growth.shares_growth > 0 ? `‚Üó +${growth.shares_growth}% (30 days)` :
         growth.shares_growth < 0 ? `‚Üì ${growth.shares_growth}% (30 days)` :
         '‚Üí Steady posting') :
        (data.total_media_sends > 0 ? 'Active posting' : 'Ready to Post'),

      viewsChange: growth.views_growth !== undefined ?
        (growth.views_growth > 0 ? `‚Üó +${growth.views_growth}% reach` :
         growth.views_growth < 0 ? `‚Üì ${growth.views_growth}% reach` :
         '‚Üí Stable reach') :
        (data.total_clicks > 0 ? 'Audience engaged' : 'Audience Ready'),

      engagementChange: growth.engagement_growth !== undefined ?
        (growth.engagement_growth > 0 ? `‚Üó +${growth.engagement_growth}% sharing` :
         growth.engagement_growth < 0 ? `‚Üì ${growth.engagement_growth}% sharing` :
         '‚Üí Consistent sharing') :
        (data.total_instagram_shares + data.total_facebook_shares + data.total_tiktok_shares > 0 ? 'Social active' : 'Ready to Share'),

      productChange: data.total_product_clicks > 0 ?
        `‚Üó ${data.total_product_clicks} clicks (30d)` :
        (data.salon_products && data.salon_products.length > 0 ? 'Products Ready' : 'Add Products')
    };

    Object.entries(changes).forEach(([id, text]) => {
      const element = document.getElementById(id);
      if (element) {
        element.textContent = text;

        // Apply appropriate styling based on growth
        if (growth.shares_growth !== undefined || growth.views_growth !== undefined) {
          const isPositive = text.includes('‚Üó') || text.includes('Growing') || text.includes('Strong');
          const isNegative = text.includes('‚Üì');

          element.className = isPositive ? 'metric-trend metric-positive' :
                             isNegative ? 'metric-trend metric-negative' :
                             'metric-trend';
        } else {
          element.className = 'metric-trend';
        }
      }
    });
  }

  // Initialize Chart.js charts
  function initializeCharts() {
    // Destroy existing chart if it exists
    if (activityChart) {
      activityChart.destroy();
      activityChart = null;
    }

    // Activity Trends Chart - Start with empty data, will be populated when stylist data loads
    const activityCtx = document.getElementById('activityChart').getContext('2d');

    activityChart = new Chart(activityCtx, {
      type: 'line',
      data: {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        datasets: [] // Start empty, will be populated with real data
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              usePointStyle: true,
              padding: 20
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: '#f0f0f0'
            }
          },
          x: {
            grid: {
              display: false
            }
          }
        },
        elements: {
          point: {
            radius: 6,
            hoverRadius: 8
          }
        }
      }
    });
  }

  // SIMPLIFIED CHART UPDATE - NO MORE ASYNC ISSUES
  function updateChartsSimplified(data) {
    console.log('updateChartsSimplified called with data:', !!data, 'stylistsData length:', stylistsData?.length);

    // Wait for both chart and stylist data to be ready
    if (!activityChart) {
      console.log('Chart not initialized yet, skipping update');
      return;
    }

    if (!stylistsData || stylistsData.length === 0) {
      console.log('No stylist data available, showing placeholder');
      showChartPlaceholder();
      return;
    }

    console.log('Updating chart with simplified approach');

    // Get top 4 stylists by activity
    const topStylists = stylistsData
      .sort((a, b) => b.totalPosts - a.totalPosts)
      .slice(0, 4);

    // Color palette for datasets
    const colors = [
      { border: '#667eea', background: '#667eea20' },
      { border: '#4CAF50', background: '#4CAF5020' },
      { border: '#FF9800', background: '#FF980020' },
      { border: '#E91E63', background: '#E91E6320' }
    ];

    // Clear existing datasets
    activityChart.data.datasets = [];

    // Add dataset for each stylist with SIMPLIFIED realistic data
    topStylists.forEach((stylist, index) => {
      const color = colors[index] || colors[0];

      // Generate realistic weekly data based on their total activity (synchronous)
      const weeklyData = generateRealisticWeeklyDataSync(stylist);

      activityChart.data.datasets.push({
        label: stylist.stylist_name,
        data: weeklyData,
        borderColor: color.border,
        backgroundColor: color.background,
        tension: 0.4,
        fill: true
      });
    });

    // Single synchronous update
    activityChart.update('active');
    console.log('Chart updated successfully with', topStylists.length, 'stylists (simplified approach)');
  }

  // Generate realistic weekly data distribution SYNCHRONOUSLY
  function generateRealisticWeeklyDataSync(stylist) {
    // Base weekly patterns (salon industry typical patterns)
    // Tuesday-Saturday are peak days, Sunday/Monday slower
    const weeklyPattern = [0.6, 1.2, 1.0, 1.1, 1.3, 1.4, 0.4]; // Mon-Sun multipliers

    // Scale based on stylist's actual activity level
    const activityLevel = Math.max(1, stylist.totalPosts / 7); // Average posts per week

    // Apply pattern with realistic variation
    return weeklyPattern.map((multiplier, dayIndex) => {
      const baseValue = activityLevel * multiplier;
      const variation = (Math.random() - 0.5) * 0.3; // ¬±15% variation
      const finalValue = Math.max(0, Math.round(baseValue * (1 + variation)));
      return finalValue;
    });
  }

  // Show placeholder when no data is available
  function showChartPlaceholder() {
    if (!activityChart) return;

    activityChart.data.datasets = [{
      label: 'Add stylists to see activity trends',
      data: [0, 0, 0, 0, 0, 0, 0],
      borderColor: '#e2e8f0',
      backgroundColor: '#f8fafc',
      tension: 0.4,
      fill: true,
      pointRadius: 0
    }];

    activityChart.update('none');
  }

  // Show loading state for chart - WITH RETRY MECHANISM
  function showChartLoading() {
    if (!activityChart) {
      console.log('Chart not ready for loading state');
      return;
    }

    activityChart.data.datasets = [{
      label: 'Loading team data...',
      data: [1, 2, 1, 3, 2, 4, 2],
      borderColor: '#cbd5e1',
      backgroundColor: '#f1f5f9',
      tension: 0.4,
      fill: true,
      pointRadius: 0
    }];

    activityChart.update('none');

    // Auto-retry after 3 seconds if still loading
    setTimeout(() => {
      if (activityChart && activityChart.data.datasets.length === 1 &&
          activityChart.data.datasets[0].label === 'Loading team data...') {
        console.log('Chart still loading after 3 seconds, attempting retry...');
        if (stylistsData && stylistsData.length > 0) {
          updateChartsSimplified(currentAnalyticsData);
        } else {
          showChartPlaceholder();
        }
      }
    }, 3000);
  }

  // Update team performance table
  function updateTeamPerformanceTable() {
    const tableBody = document.getElementById('performanceTableBody');
    if (!tableBody || !stylistsData || stylistsData.length === 0) return;

    // Sort stylists by performance score
    const sortedStylists = [...stylistsData].sort((a, b) => {
      const scoreA = (a.totalPosts * 0.3) + (a.totalViews * 0.4) + (a.engagementRate * 0.3);
      const scoreB = (b.totalPosts * 0.3) + (b.totalViews * 0.4) + (b.engagementRate * 0.3);
      return scoreB - scoreA;
    });

    tableBody.innerHTML = sortedStylists.map((stylist, index) => {
      const performanceScore = Math.round((stylist.totalPosts * 0.3) + (stylist.totalViews * 0.4) + (stylist.engagementRate * 0.3));
      const scoreColor = performanceScore >= 80 ? '#22c55e' :
                         performanceScore >= 60 ? '#667eea' : '#f59e0b';

      return `
        <div class="performance-grid" onclick="openStylistDetail('${stylist.id}')">
          <div class="stylist-info">
            <div class="stylist-avatar">${stylist.stylist_name.charAt(0).toUpperCase()}</div>
            <div>
              <div style="font-weight: 600;">${stylist.stylist_name}</div>
              <div style="font-size: 0.8rem; color: #666;">${stylist.email || 'No email'}</div>
            </div>
          </div>
          <div class="performance-metric">
            <div class="performance-value">${stylist.totalPosts}</div>
          </div>
          <div class="performance-metric">
            <div class="performance-value">${stylist.totalViews.toLocaleString()}</div>
          </div>
          <div class="performance-metric">
            <div class="performance-value">${stylist.totalClients}</div>
          </div>
          <div class="performance-metric">
            <div class="performance-value">${stylist.engagementRate}%</div>
          </div>
          <div class="performance-metric">
            <div class="performance-value" style="color: ${scoreColor};">${performanceScore}</div>
          </div>
        </div>
      `;
    }).join('');
  }

  // Auto-refresh functionality
  function startAutoRefresh() {
    // Clear any existing interval
    if (autoRefreshInterval) {
      clearInterval(autoRefreshInterval);
    }

    // Set up auto-refresh every 5 minutes
    autoRefreshInterval = setInterval(async () => {
      console.log('Auto-refreshing dashboard data...');

      // Show refresh indicator
      showRefreshIndicator();

      if (salonData) {
        // Only refresh data, don't reinitialize charts
        await loadSalonAnalytics(salonData.salon_id);
        await loadStylistsData(salonData.salon_id);
        updateLastRefreshedTime();
      }
    }, AUTO_REFRESH_MINUTES * 60 * 1000);

    console.log(`Auto-refresh started: every ${AUTO_REFRESH_MINUTES} minutes`);
  }

  function showRefreshIndicator() {
    const indicator = document.getElementById('refreshIndicator');
    indicator.classList.add('show');

    setTimeout(() => {
      indicator.classList.remove('show');
    }, 3000);
  }

  function updateLastRefreshedTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

    // Calculate data freshness
    let freshnessText = '';
    if (currentAnalyticsData?.growth_data?.current_posts?.length > 0) {
      const latestPost = currentAnalyticsData.growth_data.current_posts
        .sort((a, b) => new Date(b.send_timestamp) - new Date(a.send_timestamp))[0];

      if (latestPost) {
        const timeSinceLastPost = Math.floor((now - new Date(latestPost.send_timestamp)) / (1000 * 60 * 60));

        if (timeSinceLastPost < 1) {
          freshnessText = ' ‚Ä¢ Last post: <1hr ago üî•';
        } else if (timeSinceLastPost < 24) {
          freshnessText = ` ‚Ä¢ Last post: ${timeSinceLastPost}hr ago`;
        } else {
          const daysSince = Math.floor(timeSinceLastPost / 24);
          freshnessText = ` ‚Ä¢ Last post: ${daysSince}d ago`;
        }
      }
    }

    document.getElementById('dashboardSubtitle').innerHTML =
      `Team Analytics Dashboard ‚Ä¢ Updated: ${timeString}${freshnessText} ‚Ä¢ Auto-refresh: ${AUTO_REFRESH_MINUTES}min`;
  }

  // Enhanced performance table functionality
  function openStylistDetail(stylistId) {
    const stylist = stylistsData.find(s => s.id === stylistId);
    if (!stylist) return;

    const modal = document.getElementById('drillDownModal');
    const title = document.getElementById('modalTitle');
    const content = document.getElementById('modalContent');

    title.textContent = `${stylist.stylist_name} - Detailed Performance`;
    content.innerHTML = `
      <div class="stylist-card">
        <div class="stylist-header">
          <div class="stylist-avatar-large">${stylist.stylist_name.charAt(0).toUpperCase()}</div>
          <div class="stylist-info">
            <h3>${stylist.stylist_name}</h3>
            <p>${stylist.email || 'No email provided'}</p>
            <p style="color: #667eea; font-weight: 600;">Performance Score: ${Math.round((stylist.totalPosts * 0.3) + (stylist.totalViews * 0.4) + (stylist.engagementRate * 0.3))}/100</p>
          </div>
        </div>
        <div class="stylist-stats">
          <div class="stylist-stat">
            <div class="stylist-stat-number">${stylist.totalPosts}</div>
            <div class="stylist-stat-label">Total Posts</div>
          </div>
          <div class="stylist-stat">
            <div class="stylist-stat-number">${stylist.totalViews}</div>
            <div class="stylist-stat-label">Total Views</div>
          </div>
          <div class="stylist-stat">
            <div class="stylist-stat-number">${stylist.totalClients}</div>
            <div class="stylist-stat-label">Total Clients</div>
          </div>
          <div class="stylist-stat">
            <div class="stylist-stat-number">${stylist.engagementRate}%</div>
            <div class="stylist-stat-label">Engagement Rate</div>
          </div>
          <div class="stylist-stat">
            <div class="stylist-stat-number">${stylist.totalPosts > 0 ? Math.round(stylist.totalViews / stylist.totalPosts) : 0}</div>
            <div class="stylist-stat-label">Avg Views/Post</div>
          </div>
          <div class="stylist-stat">
            <div class="stylist-stat-number">${stylist.totalProductClicks || 0}</div>
            <div class="stylist-stat-label">Product Clicks</div>
          </div>
        </div>
      </div>

      <div style="margin-top: 2rem;">
        <h4 style="color: #333; margin-bottom: 1rem;">üí° Performance Insights</h4>
        <div class="insight-item ${stylist.totalPosts >= 20 ? 'insight-positive' : 'insight-warning'}">
          <div class="insight-title">üì± Content Creation</div>
          <div class="insight-desc">${stylist.totalPosts >= 20 ?
            `Excellent content creation with ${stylist.totalPosts} posts! Keep up the consistent posting.` :
            `Room for improvement - aim for 20+ posts. Currently at ${stylist.totalPosts} posts.`}</div>
        </div>
        <div class="insight-item ${stylist.engagementRate >= 50 ? 'insight-positive' : 'insight-warning'}">
          <div class="insight-title">‚ù§Ô∏è Engagement Performance</div>
          <div class="insight-desc">${stylist.engagementRate >= 50 ?
            `Strong engagement at ${stylist.engagementRate}%! Your content resonates well with audiences.` :
            `Focus on engagement - currently at ${stylist.engagementRate}%. Try more interactive content.`}</div>
        </div>
        <div class="insight-item ${stylist.totalClients >= 15 ? 'insight-positive' : ''}">
          <div class="insight-title">üë• Client Base</div>
          <div class="insight-desc">${stylist.totalClients >= 15 ?
            `Great client base with ${stylist.totalClients} clients! Focus on retention and referrals.` :
            `Building client base - currently ${stylist.totalClients} clients. Increase social media visibility.`}</div>
        </div>
        ${(stylist.totalProductClicks || 0) > 0 ? `
        <div class="insight-item insight-positive">
          <div class="insight-title">üõçÔ∏è Product Engagement</div>
          <div class="insight-desc">Excellent product promotion with ${stylist.totalProductClicks} clicks! Your product recommendations are resonating with clients.</div>
        </div>
        ` : `
        <div class="insight-item">
          <div class="insight-title">üì¶ Product Opportunity</div>
          <div class="insight-desc">Feature products in your posts to drive additional engagement and potential revenue through affiliate links.</div>
        </div>
        `}
      </div>
    `;

    modal.classList.add('active');
  }

  // Enhanced performance insights generation
  async function generatePerformanceInsights() {
    const insightsContent = document.getElementById('performanceInsightsContent');

    // Show loading state
    insightsContent.innerHTML = `
      <div style="text-align: center; padding: 2rem;">
        <div class="ai-spinner" style="margin: 0 auto 1rem;"></div>
        <p style="color: #666;">Analyzing team performance data...</p>
      </div>
    `;

    try {
      if (!stylistsData || stylistsData.length === 0) {
        insightsContent.innerHTML = `
          <div class="insight-item">
            <div class="insight-title">üìä Getting Started</div>
            <div class="insight-desc">Add stylists to your team to unlock AI-powered performance insights and recommendations.</div>
          </div>
        `;
        return;
      }

      // Analyze real data with enhanced business intelligence
      const insights = await analyzeTeamPerformanceAdvanced();

      // Try to get AI insights if available
      let aiInsight = null;
      try {
        const prompt = `Salon Business Analysis: ${insights.summary}. Based on this data, provide one key strategic recommendation for improving team performance and business growth.`;
        const rawInsight = await callClaude(prompt);
        aiInsight = cleanAIResponse(rawInsight);
      } catch (error) {
        console.log('AI insight generation failed, using enhanced data analysis');

        // Create enhanced AI-style insight from data analysis
        if (insights.items.length > 0) {
          const topInsight = insights.items[0];
          aiInsight = `**Strategic Focus:** ${topInsight.description} Consider implementing this as your top priority to drive business growth and team performance improvement.`;
        }
      }

      // Display insights
      let insightsHTML = '';

      if (aiInsight) {
        insightsHTML += `
          <div class="insight-item" style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-left-color: #0ea5e9;">
            <div class="insight-title">üß† AI Strategic Recommendation</div>
            <div class="insight-desc" style="line-height: 1.6;">${formatAIInsight(aiInsight)}</div>
          </div>
        `;
      }

      // Add enhanced data-driven insights
      insights.items.forEach(insight => {
        insightsHTML += `
          <div class="insight-item ${insight.type}">
            <div class="insight-title">${insight.title}</div>
            <div class="insight-desc">${insight.description}</div>
          </div>
        `;
      });

      insightsContent.innerHTML = insightsHTML;

    } catch (error) {
      console.error('Error generating performance insights:', error);
      insightsContent.innerHTML = `
        <div class="insight-item insight-warning">
          <div class="insight-title">‚ö†Ô∏è Analysis Error</div>
          <div class="insight-desc">Unable to generate insights at this time. Please try again later.</div>
        </div>
      `;
    }
  }

  // Enhanced team performance analysis with advanced business intelligence
  async function analyzeTeamPerformanceAdvanced() {
    if (!stylistsData || stylistsData.length === 0) {
      return { items: [], summary: 'No team data available' };
    }

    const insights = [];
    let summary = '';

    // Advanced performance scoring
    const stylistPerformanceScores = stylistsData.map(stylist => ({
      ...stylist,
      performanceScore: calculateAdvancedPerformanceScore(stylist)
    }));

    // Identify top and bottom performers
    const topPerformer = stylistPerformanceScores.reduce((prev, current) =>
      prev.performanceScore > current.performanceScore ? prev : current
    );

    const bottomPerformer = stylistPerformanceScores.reduce((prev, current) =>
      prev.performanceScore < current.performanceScore ? prev : current
    );

    // Performance gap analysis
    if (stylistsData.length > 1) {
      const performanceGap = topPerformer.performanceScore - bottomPerformer.performanceScore;
      if (performanceGap > 50) {
        insights.push({
          type: 'insight-warning',
          title: '‚öñÔ∏è Performance Gap Alert',
          description: `Large performance gap detected (${Math.round(performanceGap)} points). ${topPerformer.stylist_name} (${Math.round(topPerformer.performanceScore)}) significantly outperforms ${bottomPerformer.stylist_name} (${Math.round(bottomPerformer.performanceScore)}). Consider mentoring or training programs.`
        });
      }
    }

    // Client-to-engagement ratio analysis
    const totalClients = stylistsData.reduce((sum, s) => sum + s.totalClients, 0);
    const totalPosts = stylistsData.reduce((sum, s) => sum + s.totalPosts, 0);
    const clientPostRatio = totalClients / Math.max(totalPosts, 1);

    if (clientPostRatio > 1.5) {
      insights.push({
        type: 'insight-positive',
        title: 'üíù Excellent Client Conversion',
        description: `Outstanding client-to-post ratio of ${clientPostRatio.toFixed(1)}:1. Your content effectively converts to real business relationships. Focus on retention strategies.`
      });
    } else if (clientPostRatio < 0.5) {
      insights.push({
        type: 'insight-warning',
        title: 'üì± Content Strategy Optimization',
        description: `Client-to-post ratio is ${clientPostRatio.toFixed(1)}:1. Consider posting more client-focused content, before/after photos, and client testimonials to improve conversion.`
      });
    }

    // Product engagement analysis
    const totalProductClicks = stylistsData.reduce((sum, s) => sum + (s.totalProductClicks || 0), 0);
    if (totalProductClicks > 0) {
      insights.push({
        type: 'insight-positive',
        title: 'üõçÔ∏è Product Engagement Success',
        description: `Great product engagement with ${totalProductClicks} total clicks! Your team is effectively showcasing products. Consider expanding product recommendations and affiliate partnerships.`
      });
    } else if (currentAnalyticsData?.salon_products?.length > 0) {
      insights.push({
        type: 'insight-warning',
        title: 'üì¶ Product Opportunity',
        description: `You have ${currentAnalyticsData.salon_products.length} products configured but no clicks yet. Encourage stylists to feature products in their posts to drive engagement and revenue.`
      });
    }

    // UGC performance analysis
    if (currentAnalyticsData?.ugcAnalytics) {
      const ugcRate = currentAnalyticsData.ugcAnalytics.ugc_generation_rate || 0;
      const ugcDiscovered = currentAnalyticsData.ugcAnalytics.total_ugc_discovered || 0;

      if (ugcRate > 15) {
        insights.push({
          type: 'insight-positive',
          title: 'üéØ Excellent UGC Performance',
          description: `Outstanding ${ugcRate.toFixed(1)}% UGC generation rate with ${ugcDiscovered} client posts discovered! Your services inspire clients to share their results.`
        });
      } else if (ugcDiscovered > 0) {
        insights.push({
          type: 'insight-warning',
          title: 'üì∏ UGC Growth Opportunity',
          description: `You have ${ugcDiscovered} client posts but only ${ugcRate.toFixed(1)}% UGC rate. Encourage more sharing with photo incentives and social media CTAs.`
        });
      }
    }

    summary = `${stylistsData.length} stylists, avg performance: ${Math.round(stylistPerformanceScores.reduce((sum, s) => sum + s.performanceScore, 0) / stylistsData.length)}/100, client ratio: ${clientPostRatio.toFixed(1)}:1, range: ${Math.round(bottomPerformer.performanceScore)}-${Math.round(topPerformer.performanceScore)}, product clicks: ${totalProductClicks}`;

    return { items: insights, summary };
  }

  // Calculate advanced performance score with weighted factors
  function calculateAdvancedPerformanceScore(stylist) {
    // Weighted scoring system
    const postScore = Math.min((stylist.totalPosts / 20) * 30, 30); // Max 30 points
    const viewScore = Math.min((stylist.totalViews / 1000) * 25, 25); // Max 25 points
    const clientScore = Math.min((stylist.totalClients / 15) * 25, 25); // Max 25 points
    const engagementScore = Math.min((stylist.engagementRate / 100) * 20, 20); // Max 20 points

    return postScore + viewScore + clientScore + engagementScore;
  }

  // DRILL-DOWN FUNCTIONALITY

  function openDrillDown(type) {
    if (!stylistsData || stylistsData.length === 0) {
      alert('Stylist data is still loading. Please try again in a moment.');
      return;
    }

    console.log('Opening drill-down for:', type);

    const modal = document.getElementById('drillDownModal');
    const title = document.getElementById('modalTitle');
    const content = document.getElementById('modalContent');

    switch(type) {
      case 'stylists':
        title.textContent = 'Stylist Performance';
        content.innerHTML = generateStylistDrillDown();
        break;
      case 'clients':
        title.textContent = 'Client Breakdown by Stylist';
        content.innerHTML = generateClientDrillDown();
        break;
      case 'posts':
        title.textContent = 'Post Activity by Stylist';
        content.innerHTML = generatePostDrillDown();
        break;
      case 'views':
        title.textContent = 'View Performance by Stylist';
        content.innerHTML = generateViewDrillDown();
        break;
      case 'engagement':
        title.textContent = 'Engagement by Stylist';
        content.innerHTML = generateEngagementDrillDown();
        break;
      case 'products':
        title.textContent = 'Product Performance';
        content.innerHTML = generateProductDrillDown();
        break;
    }

    modal.classList.add('active');
  }

  function closeDrillDown() {
    document.getElementById('drillDownModal').classList.remove('active');
  }

  function generateStylistDrillDown() {
    if (!stylistsData || stylistsData.length === 0) {
      return `<div class="stylist-card"><p>No stylist data available. Please refresh the page.</p></div>`;
    }

    return stylistsData.map(stylist => {
      console.log(`Rendering stylist ${stylist.stylist_name}: ${stylist.totalClients} clients`);
      return `
        <div class="stylist-card">
          <div class="stylist-header">
            <div class="stylist-avatar-large">${stylist.stylist_name.charAt(0).toUpperCase()}</div>
            <div class="stylist-info">
              <h3>${stylist.stylist_name}</h3>
              <p>${stylist.email || 'No email provided'}</p>
            </div>
          </div>
          <div class="stylist-stats">
            <div class="stylist-stat">
              <div class="stylist-stat-number">${stylist.totalPosts || 0}</div>
              <div class="stylist-stat-label">Posts</div>
            </div>
            <div class="stylist-stat">
              <div class="stylist-stat-number">${stylist.totalViews || 0}</div>
              <div class="stylist-stat-label">Views</div>
            </div>
            <div class="stylist-stat">
              <div class="stylist-stat-number">${stylist.totalClients || 0}</div>
              <div class="stylist-stat-label">Clients</div>
            </div>
            <div class="stylist-stat">
              <div class="stylist-stat-number">${stylist.engagementRate || 0}%</div>
              <div class="stylist-stat-label">Engagement</div>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  function generateClientDrillDown() {
    if (!stylistsData || stylistsData.length === 0) {
      return `<div class="stylist-card"><p>No stylist data available. Please refresh the page.</p></div>`;
    }

    return stylistsData.map(stylist => {
      const clientsPerPost = stylist.totalPosts > 0 ? (stylist.totalClients / stylist.totalPosts).toFixed(1) : '0';
      console.log(`Client breakdown for ${stylist.stylist_name}: ${stylist.totalClients} clients, ${clientsPerPost} per post`);

      return `
        <div class="stylist-card">
          <div class="stylist-header">
            <div class="stylist-avatar-large">${stylist.stylist_name.charAt(0).toUpperCase()}</div>
            <div class="stylist-info">
              <h3>${stylist.stylist_name}</h3>
              <p>${stylist.totalClients || 0} clients served</p>
            </div>
          </div>
          <div class="stylist-stats">
            <div class="stylist-stat">
              <div class="stylist-stat-number">${stylist.totalClients || 0}</div>
              <div class="stylist-stat-label">Total Clients</div>
            </div>
            <div class="stylist-stat">
              <div class="stylist-stat-number">${clientsPerPost}</div>
              <div class="stylist-stat-label">Clients per Post</div>
            </div>
            <div class="stylist-stat">
              <div class="stylist-stat-number">${stylist.totalPosts || 0}</div>
              <div class="stylist-stat-label">Total Posts</div>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  function generatePostDrillDown() {
    return stylistsData.map(stylist => `
      <div class="stylist-card">
        <div class="stylist-header">
          <div class="stylist-avatar-large">${stylist.stylist_name.charAt(0).toUpperCase()}</div>
          <div class="stylist-info">
            <h3>${stylist.stylist_name}</h3>
            <p>${stylist.totalPosts} posts created</p>
          </div>
        </div>
        <div class="stylist-stats">
          <div class="stylist-stat">
            <div class="stylist-stat-number">${stylist.totalPosts}</div>
            <div class="stylist-stat-label">Total Posts</div>
          </div>
          <div class="stylist-stat">
            <div class="stylist-stat-number">${stylist.totalPosts > 0 ? Math.round(stylist.totalViews / stylist.totalPosts) : 0}</div>
            <div class="stylist-stat-label">Avg Views per Post</div>
          </div>
        </div>
      </div>
    `).join('');
  }

  function generateViewDrillDown() {
    return stylistsData.map(stylist => `
      <div class="stylist-card">
        <div class="stylist-header">
          <div class="stylist-avatar-large">${stylist.stylist_name.charAt(0).toUpperCase()}</div>
          <div class="stylist-info">
            <h3>${stylist.stylist_name}</h3>
            <p>${stylist.totalViews} total views</p>
          </div>
        </div>
        <div class="stylist-stats">
          <div class="stylist-stat">
            <div class="stylist-stat-number">${stylist.totalViews}</div>
            <div class="stylist-stat-label">Total Views</div>
          </div>
          <div class="stylist-stat">
            <div class="stylist-stat-number">${stylist.totalPosts > 0 ? Math.round(stylist.totalViews / stylist.totalPosts) : 0}</div>
            <div class="stylist-stat-label">Views per Post</div>
          </div>
        </div>
      </div>
    `).join('');
  }

  function generateEngagementDrillDown() {
    return stylistsData.map(stylist => `
      <div class="stylist-card">
        <div class="stylist-header">
          <div class="stylist-avatar-large">${stylist.stylist_name.charAt(0).toUpperCase()}</div>
          <div class="stylist-info">
            <h3>${stylist.stylist_name}</h3>
            <p>${stylist.engagementRate}% engagement rate</p>
          </div>
        </div>
        <div class="stylist-stats">
          <div class="stylist-stat">
            <div class="stylist-stat-number">${stylist.engagementRate}%</div>
            <div class="stylist-stat-label">Engagement Rate</div>
          </div>
          <div class="stylist-stat">
            <div class="stylist-stat-number">${stylist.totalPosts}</div>
            <div class="stylist-stat-label">Posts Created</div>
          </div>
        </div>
      </div>
    `).join('');
  }

  // UPDATED: Enhanced product drill-down with real salon products and UGC data
  function generateProductDrillDown() {
    if (!currentAnalyticsData || !currentAnalyticsData.salon_products) {
      return `
        <div class="stylist-card">
          <div class="stylist-header">
            <div class="stylist-avatar-large">üì¶</div>
            <div class="stylist-info">
              <h3>Product Analytics</h3>
              <p>Loading product data...</p>
            </div>
          </div>
        </div>
      `;
    }

    const salonProducts = currentAnalyticsData.salon_products || [];
    const productInteractions = currentAnalyticsData.product_interactions || [];
    const totalProductClicks = currentAnalyticsData.total_product_clicks || 0;

    if (salonProducts.length === 0) {
      return `
        <div class="stylist-card">
          <div class="stylist-header">
            <div class="stylist-avatar-large">üì¶</div>
            <div class="stylist-info">
              <h3>Product Setup</h3>
              <p>No products configured yet. Add products to your salon profile to start tracking product engagement.</p>
            </div>
          </div>
          <div class="stylist-stats">
            <div class="stylist-stat">
              <div class="stylist-stat-number">0</div>
              <div class="stylist-stat-label">Products</div>
            </div>
            <div class="stylist-stat">
              <div class="stylist-stat-number">Ready</div>
              <div class="stylist-stat-label">Status</div>
            </div>
          </div>
        </div>
        <div style="margin-top: 2rem;">
          <h4 style="color: #333; margin-bottom: 1rem;">üí° Getting Started with Products</h4>
          <div class="insight-item insight-positive">
            <div class="insight-title">üõçÔ∏è Add Your First Products</div>
            <div class="insight-desc">Go to your salon settings to add products your team uses. This will enable tracking when clients click on product recommendations in your posts.</div>
          </div>
        </div>
      `;
    }

    // Create product performance analysis
    const productPerformance = salonProducts.map(salonProduct => {
      const product = salonProduct.products;
      const productClicks = productInteractions.filter(interaction =>
        interaction.product_id === product.id).length;

      return {
        ...product,
        salon_product: salonProduct,
        clicks: productClicks,
        performance_score: productClicks * 10 // Simple scoring system
      };
    }).sort((a, b) => b.clicks - a.clicks);

    let productsHTML = productPerformance.map(product => `
      <div class="product-card">
        <div class="product-header">
          <div class="product-image">
            ${product.product_image ?
              `<img src="${product.product_image}" alt="${product.product_name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">` :
              'üõçÔ∏è'
            }
          </div>
          <div style="flex: 1;">
            <h4 style="margin: 0; font-size: 1.1rem; color: #333;">${product.brand} ${product.product_name}</h4>
            <p style="margin: 0; color: #666; font-size: 0.9rem;">${product.category}</p>
            ${product.amazon_price ? `<p style="margin: 0; color: #22c55e; font-weight: 600; font-size: 0.9rem;">${product.amazon_price}</p>` : ''}
          </div>
          <div style="text-align: right;">
            <div style="font-size: 1.5rem; font-weight: 700; color: #667eea;">${product.clicks}</div>
            <div style="font-size: 0.8rem; color: #666;">Clicks</div>
          </div>
        </div>
        <div class="product-stats">
          <div class="product-stat">
            <div class="product-stat-number">${product.clicks}</div>
            <div class="product-stat-label">Total Clicks</div>
          </div>
          <div class="product-stat">
            <div class="product-stat-number">${product.performance_score}</div>
            <div class="product-stat-label">Score</div>
          </div>
          ${product.amazon_rating ? `
          <div class="product-stat">
            <div class="product-stat-number">${product.amazon_rating}‚≠ê</div>
            <div class="product-stat-label">Rating</div>
          </div>
          ` : ''}
          <div class="product-stat">
            <div class="product-stat-number">${product.salon_product.is_active ? '‚úÖ' : '‚ùå'}</div>
            <div class="product-stat-label">Status</div>
          </div>
        </div>
      </div>
    `).join('');

    // Add summary insights
    const topProduct = productPerformance[0];
    const totalProducts = salonProducts.length;
    const activeProducts = salonProducts.filter(sp => sp.is_active).length;

    productsHTML += `
      <div style="margin-top: 2rem;">
        <h4 style="color: #333; margin-bottom: 1rem;">üìä Product Performance Insights</h4>
        <div class="insight-item insight-positive">
          <div class="insight-title">üèÜ Top Performer: ${topProduct ? `${topProduct.brand} ${topProduct.product_name}` : 'No clicks yet'}</div>
          <div class="insight-desc">${topProduct && topProduct.clicks > 0 ?
            `Leading with ${topProduct.clicks} clicks! This product resonates well with your clients.` :
            'Start featuring products in your posts to track which ones clients are most interested in.'
          }</div>
        </div>
        <div class="insight-item">
          <div class="insight-title">üìà Product Portfolio: ${activeProducts}/${totalProducts} Active</div>
          <div class="insight-desc">Total clicks across all products: ${totalProductClicks}. ${totalProductClicks > 50 ? 'Excellent engagement!' : totalProductClicks > 0 ? 'Good start - keep featuring products!' : 'Feature products in posts to drive engagement.'}</div>
        </div>
        ${totalProductClicks > 0 ? `
        <div class="insight-item insight-warning" style="background: #fef3c7; border-left-color: #f59e0b;">
          <div class="insight-title">üí∞ Revenue Opportunity</div>
          <div class="insight-desc">Each product click represents potential revenue. Consider creating dedicated product showcase posts and implementing affiliate partnerships for additional income streams.</div>
        </div>
        ` : ''}
      </div>
    `;

    return productsHTML;
  }

  // Force chart refresh function for manual refresh button
  function forceChartRefresh() {
    console.log('Force refreshing chart...');

    if (!activityChart) {
      console.log('Chart not initialized, initializing...');
      initializeCharts();
      showChartLoading();
      return;
    }

    if (stylistsData && stylistsData.length > 0) {
      console.log('Forcing chart update with current data');
      updateChartsSimplified(currentAnalyticsData);
    } else {
      console.log('No stylist data, showing placeholder');
      showChartPlaceholder();
    }
  }

  // Interactive Functions
  function refreshDashboard() {
    console.log('Refreshing dashboard...');
    showRefreshIndicator();

    if (salonData) {
      // Only refresh data, don't reinitialize charts
      loadSalonAnalytics(salonData.salon_id);
      loadStylistsData(salonData.salon_id);
      updateLastRefreshedTime();
    }
  }

  // Show error state with manual options
  function showErrorState(message) {
    const mainContent = document.querySelector('.main-content');
    if (mainContent) {
      mainContent.innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; text-align: center; padding: 2rem;">
          <div style="font-size: 4rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
          <div style="background: linear-gradient(135deg, #f8d7da, #f5c6cb); color: #721c24; padding: 2rem; border-radius: 15px; max-width: 600px; border-left: 4px solid #dc3545;">
            <h2 style="margin: 0 0 1rem 0; font-size: 1.5rem;">Dashboard Connection Error</h2>
            <p style="margin: 0 0 1rem 0; font-size: 1.1rem;"><strong>${message}</strong></p>
            <p style="margin: 0 0 1rem 0; font-size: 0.9rem;">The dashboard requires a connection to our database service.</p>

            <div style="background: rgba(255, 255, 255, 0.7); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
              <strong style="color: #1565c0;">Troubleshooting Steps:</strong>
              <ul style="text-align: left; margin: 0.5rem 0; color: #333;">
                <li>Check your internet connection</li>
                <li>Disable any ad-blockers temporarily</li>
                <li>If on a corporate network, contact IT support</li>
                <li>Try refreshing the page</li>
              </ul>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-top: 1.5rem;">
              <button onclick="window.location.reload()" style="background: #dc3545; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                üîÑ Reload Page
              </button>
              <button onclick="window.debugDashboard.retryInitialization()" style="background: #0369a1; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                üîÑ Retry Connection
              </button>
              <button onclick="showOfflineMode()" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                üì± Contact Support
              </button>
            </div>
          </div>
        </div>
      `;
    } else {
      // Fallback if main-content doesn't exist yet
      document.body.innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; text-align: center; padding: 2rem; font-family: Inter, sans-serif;">
          <div style="font-size: 4rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
          <div style="background: #f8d7da; color: #721c24; padding: 2rem; border-radius: 15px; max-width: 600px;">
            <h2 style="margin: 0 0 1rem 0;">Dashboard Initialization Failed</h2>
            <p style="margin: 0 0 1rem 0;"><strong>${message}</strong></p>
            <button onclick="window.location.reload()" style="background: #dc3545; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; margin-top: 1rem; cursor: pointer;">
              üîÑ Reload Page
            </button>
          </div>
        </div>
      `;
    }
  }

  function showOfflineMode() {
    alert('üì± For immediate support, please contact:\n\nEmail: support@postmystyle.ai\nPhone: [Your support number]\n\nInclude this error message: "Dashboard connection failed - Supabase library not loading"');
  }

  // Logout function
  async function logout() {
    console.log('Logging out...');

    // Clear auto-refresh interval
    if (autoRefreshInterval) {
      clearInterval(autoRefreshInterval);
    }

    try {
      // Check if Supabase is available
      if (supabase) {
        // Sign out from Supabase
        const { error } = await supabase.auth.signOut();

        if (error) {
          console.error('Logout error:', error);
        }
      }
    } catch (error) {
      console.error('Logout error:', error);
    }

    // Clear stored authentication data
    localStorage.removeItem('authToken');
    localStorage.removeItem('userInfo');
    localStorage.removeItem('salonInfo');

    // Clear session storage
    sessionStorage.clear();

    console.log('Logout complete, redirecting...');

    // Redirect to home page
    window.location.href = 'index.html';
  }

  // Sidebar navigation functions
  function showDashboard() {
    hideAllSections();
    showDashboardSections();
    setActiveNavItem('Dashboard');

    // FORCE LAYOUT RESTORATION
    const dashboardContainer = document.querySelector('.dashboard-container');
    if (dashboardContainer) {
      dashboardContainer.style.display = 'grid';
      dashboardContainer.style.gridTemplateColumns = '280px 1fr';
    }

    // Ensure main content has proper styling
    const mainContent = document.querySelector('.main-content');
    if (mainContent) {
      mainContent.style.display = 'block';
    }

    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function showTeamPerformance() {
    hideAllSections();
    showDashboardSections();
    setActiveNavItem('Team Performance');
    // Scroll to team performance table
    document.querySelector('.performance-table').scrollIntoView({ behavior: 'smooth' });
  }

  function showSocialAnalytics() {
    hideAllSections();
    showDashboardSections();
    setActiveNavItem('Social Analytics');
    // Scroll to UGC analytics section
    document.querySelector('.ugc-analytics-section').scrollIntoView({ behavior: 'smooth' });
  }

  function showRevenueTracking() {
    setActiveNavItem('Revenue Tracking');
    alert('Revenue Tracking feature coming soon! This will show detailed financial analytics and revenue trends.');
  }

  function showGoalsTargets() {
    setActiveNavItem('Goals & Targets');
    alert('Goals & Targets feature coming soon! This will help you set and track performance goals for your team.');
  }

  function showSettings() {
    setActiveNavItem('Settings');
    alert('Settings feature coming soon! This will allow you to configure salon preferences and user settings.');
  }

  function setActiveNavItem(itemName) {
    // Remove active class from all nav links
    document.querySelectorAll('.nav-link').forEach(link => {
      link.classList.remove('active');
    });

    // Add active class to clicked item
    document.querySelectorAll('.nav-link').forEach(link => {
      if (link.textContent.trim().includes(itemName)) {
        link.classList.add('active');
      }
    });
  }

  // Chart control functions - SIMPLIFIED
  function updateCharts(data) {
    updateChartsSimplified(data);
  }

  function updateChartToPosts() {
    updateChartToPostsSimplified();
  }

  function updateChartToViews() {
    updateChartToViewsSimplified();
  }

  function updateChartToEngagement() {
    updateChartToEngagementSimplified();
  }

  function updateChartToPostsSimplified() {
    console.log('Switching chart to Posts view (simplified)');
    if (!activityChart || !stylistsData?.length) {
      console.log('Chart or data not ready for Posts view');
      return;
    }

    const topStylists = stylistsData
      .sort((a, b) => b.totalPosts - a.totalPosts)
      .slice(0, 4);

    // Update datasets synchronously
    topStylists.forEach((stylist, index) => {
      if (activityChart.data.datasets[index]) {
        const weeklyData = generateRealisticWeeklyDataSync(stylist);
        activityChart.data.datasets[index].data = weeklyData;
        activityChart.data.datasets[index].label = stylist.stylist_name;
      }
    });

    activityChart.update('active');
    console.log('Chart updated to Posts view');
  }

  function updateChartToViewsSimplified() {
    console.log('Switching chart to Views view (simplified)');
    if (!activityChart || !stylistsData?.length) {
      console.log('Chart or data not ready for Views view');
      return;
    }

    const topStylists = stylistsData
      .sort((a, b) => b.totalViews - a.totalViews)
      .slice(0, 4);

    // Generate view-based data synchronously
    topStylists.forEach((stylist, index) => {
      if (activityChart.data.datasets[index]) {
        // Scale views data for chart readability
        const weeklyPattern = [0.6, 1.2, 1.0, 1.1, 1.3, 1.4, 0.4];
        const avgDailyViews = (stylist.totalViews / 30) / 5; // Scale down for readability
        const weeklyData = weeklyPattern.map(multiplier =>
          Math.max(0, Math.round(avgDailyViews * multiplier * 7))
        );
        activityChart.data.datasets[index].data = weeklyData;
        activityChart.data.datasets[index].label = stylist.stylist_name;
      }
    });

    activityChart.update('active');
    console.log('Chart updated to Views view');
  }

  function updateChartToEngagementSimplified() {
    console.log('Switching chart to Engagement view (simplified)');
    if (!activityChart || !stylistsData?.length) {
      console.log('Chart or data not ready for Engagement view');
      return;
    }

    const topStylists = stylistsData
      .sort((a, b) => b.engagementRate - a.engagementRate)
      .slice(0, 4);

    // Generate engagement-based data synchronously
    topStylists.forEach((stylist, index) => {
      if (activityChart.data.datasets[index]) {
        const weeklyPattern = [0.6, 1.2, 1.0, 1.1, 1.3, 1.4, 0.4];
        const baseEngagement = stylist.engagementRate / 10; // Scale for chart
        const weeklyData = weeklyPattern.map(multiplier =>
          Math.max(0, Math.round(baseEngagement * multiplier))
        );
        activityChart.data.datasets[index].data = weeklyData;
        activityChart.data.datasets[index].label = stylist.stylist_name;
      }
    });

    activityChart.update('active');
    console.log('Chart updated to Engagement view');
  }

  // Event Listeners

  // Close modal when clicking outside
  document.getElementById('drillDownModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeDrillDown();
    }
  });

  // Close modal with Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeDrillDown();
    }
  });

  // Allow Enter key to send custom question
  document.getElementById('customQuestionInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      askCustomQuestion();
    }
  });

  // Add interactivity for chart controls
  document.querySelectorAll('.chart-control').forEach(btn => {
    btn.addEventListener('click', function() {
      // Remove active class from siblings
      this.parentNode.querySelectorAll('.chart-control').forEach(sibling => {
        sibling.classList.remove('active');
      });
      // Add active class to clicked button
      this.classList.add('active');

      // Update chart based on selection
      const chartType = this.textContent;
      console.log('Switching to:', chartType);

      // Update chart data based on selection
      if (activityChart) {
        switch(chartType) {
          case 'Views':
            updateChartToViews();
            break;
          case 'Engagement':
            updateChartToEngagement();
            break;
          default:
            updateChartToPosts();
        }
      }
    });
  });

  // Add interactivity for time range selector
  document.querySelectorAll('.time-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      // Remove active class from siblings
      this.parentNode.querySelectorAll('.time-btn').forEach(sibling => {
        sibling.classList.remove('active');
      });
      // Add active class to clicked button
      this.classList.add('active');

      // Update data based on time range
      const timeRange = this.textContent;
      console.log('Time range changed to:', timeRange);

      // Refresh data with new time range
      if (salonData) {
        loadSalonAnalytics(salonData.salon_id);
        loadStylistsData(salonData.salon_id);
      }
    });
  });

  // Page visibility API for auto-refresh management
  document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
      // Page is hidden, pause auto-refresh
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        console.log('Auto-refresh paused - page hidden');
      }
    } else {
      // Page is visible, resume auto-refresh (but don't reinitialize charts)
      startAutoRefresh();
      console.log('Auto-refresh resumed - page visible');
    }
  });

  // Cleanup on page unload
  window.addEventListener('beforeunload', function() {
    if (autoRefreshInterval) {
      clearInterval(autoRefreshInterval);
    }
  });

  // Enhanced error handling
  window.addEventListener('error', function(e) {
    console.error('JavaScript error:', e.error);
    // Don't show error to user unless it's critical
  });

  // Network status monitoring
  window.addEventListener('online', function() {
    console.log('Network connection restored');
    if (salonData) {
      refreshDashboard();
    }
  });

  window.addEventListener('offline', function() {
    console.log('Network connection lost');
    // Pause auto-refresh when offline
    if (autoRefreshInterval) {
      clearInterval(autoRefreshInterval);
    }
  });

  // Initialize dashboard when page loads - single initialization
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('üöÄ PostMyStyle.ai Enhanced Dashboard initializing...');
      try {
        await loadDashboard();
      } catch (error) {
        console.error('‚ùå Dashboard initialization failed:', error);
        showErrorState('Failed to initialize dashboard. Please refresh the page.');
      }
    });
  } else {
    // DOM already loaded
    console.log('üöÄ PostMyStyle.ai Enhanced Dashboard initializing (DOM ready)...');
    (async () => {
      try {
        await loadDashboard();
      } catch (error) {
        console.error('‚ùå Dashboard initialization failed:', error);
        showErrorState('Failed to initialize dashboard. Please refresh the page.');
      }
    })();
  }

  // Debug helper - add to global scope for console testing
  window.debugDashboard = {
    testSupabaseConnection: async function() {
      console.log('üß™ Testing Supabase connection...');
      if (!supabase) {
        console.log('‚ùå Supabase not initialized');
        return false;
      }

      try {
        const { data, error } = await supabase.auth.getSession();
        console.log('‚úÖ Supabase connection successful', { hasData: !!data, error });
        return true;
      } catch (err) {
        console.error('‚ùå Supabase connection failed:', err);
        return false;
      }
    },

    testClaudeAPI: async function() {
      console.log('üß™ Testing Claude API...');
      try {
        const response = await callClaude('Hello, this is a test message.');
        console.log('‚úÖ Claude API test successful:', response);
        return true;
      } catch (error) {
        console.error('‚ùå Claude API test failed:', error);
        return false;
      }
    },

    testEnhancedAnalytics: async function() {
      if (!salonData) {
        console.log('No salon data available');
        return;
      }

      console.log('üß™ Testing enhanced analytics with UGC integration...');
      const result = await calculateRealTimeAnalytics(salonData.salon_id);
      console.log('Result:', result);
      return result;
    },

    testUGCAnalytics: async function() {
      if (!salonData) {
        console.log('No salon data available');
        return;
      }

      console.log('üß™ Testing UGC analytics calculation...');
      const result = await calculateUGCAnalytics(salonData.salon_id);
      console.log('UGC Result:', result);
      return result;
    },

    showCurrentData: function() {
      console.log('üìä Current enhanced dashboard state:', {
        supabaseReady: !!supabase,
        salonData: salonData,
        currentAnalyticsData: currentAnalyticsData,
        stylistsData: stylistsData?.length ? `${stylistsData.length} stylists loaded` : 'No stylists data',
        productData: currentAnalyticsData?.salon_products?.length ? `${currentAnalyticsData.salon_products.length} products` : 'No products',
        ugcData: currentAnalyticsData?.ugcAnalytics || 'No UGC data',
        aiCache: GLOBAL_AI_CACHE
      });
    },

    forceRefresh: function() {
      console.log('üîÑ Force refreshing enhanced dashboard...');
      if (salonData) {
        loadSalonAnalytics(salonData.salon_id);
        loadStylistsData(salonData.salon_id);
      }
    },

    retryInitialization: async function() {
      console.log('üîÑ Retrying enhanced dashboard initialization...');
      isDashboardLoaded = false;
      try {
        await loadDashboard();
        console.log('‚úÖ Enhanced retry successful!');
      } catch (error) {
        console.error('‚ùå Enhanced retry failed:', error);
      }
    },

    testAIStages: function() {
      const testData = [
        { total_stylists: 1, total_clients: 5, total_media_sends: 2, total_clicks: 20 },
        { total_stylists: 2, total_clients: 25, total_media_sends: 30, total_clicks: 150 },
        { total_stylists: 4, total_clients: 75, total_media_sends: 150, total_clicks: 800 },
        { total_stylists: 8, total_clients: 200, total_media_sends: 500, total_clicks: 2500 }
      ];

      testData.forEach((data, index) => {
        const stage = getUserStage(data);
        console.log(`Test ${index + 1}: Stage = ${stage}`, data);
      });
    }
  };

  console.log('‚úÖ ENHANCED DASHBOARD WITH ADVANCED AI & UGC ANALYTICS LOADED');
  console.log('üîç Checking library availability...');
  console.log('  ‚Ä¢ Chart.js:', typeof Chart !== 'undefined' ? '‚úÖ Ready' : '‚ùå Missing');
  console.log('  ‚Ä¢ Supabase (window.supabase):', typeof window.supabase !== 'undefined' ? '‚úÖ Ready' : '‚è≥ Loading...');
  console.log('  ‚Ä¢ Supabase (window.Supabase):', typeof window.Supabase !== 'undefined' ? '‚úÖ Available' : '‚ùå Not found');
  console.log('  ‚Ä¢ Claude API:', '‚úÖ Using secure proxy');

  console.log('üí° Available debug commands:');
  console.log('  ‚Ä¢ window.debugDashboard.testSupabaseConnection() - Test database connection');
  console.log('  ‚Ä¢ window.debugDashboard.testClaudeAPI() - Test AI API connection');
  console.log('  ‚Ä¢ window.debugDashboard.testEnhancedAnalytics() - Test analytics with UGC');
  console.log('  ‚Ä¢ window.debugDashboard.testUGCAnalytics() - Test UGC calculation');
  console.log('  ‚Ä¢ window.debugDashboard.testAIStages() - Test AI stage detection');
  console.log('  ‚Ä¢ window.debugDashboard.showCurrentData() - Show current state');
  console.log('  ‚Ä¢ window.debugDashboard.forceRefresh() - Force refresh data');
  console.log('  ‚Ä¢ window.debugDashboard.retryInitialization() - Retry dashboard init');

</script>
</body>
</html>