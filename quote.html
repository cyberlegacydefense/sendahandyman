<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Quote - SendAHandyman</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        .pricing-option {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .pricing-option:hover {
            transform: translateY(-2px);
        }
        .pricing-option.selected {
            border-color: #2563eb !important;
            background-color: #eff6ff !important;
        }
        .hidden { display: none; }

        /* Mobile optimization for separate Stripe elements */
        @media (max-width: 768px) {
            /* Card input field container adjustments for portrait mobile */
            #card-number-element {
                padding-right: 80px !important; /* Space for brand icons */
            }

            /* Reduce card brand icon size and ensure proper positioning */
            .absolute.right-4 {
                right: 8px !important;
                max-width: 70px !important;
                overflow: hidden;
            }

            /* Smaller card brand icons for mobile portrait */
            #card-brand-icon div,
            #accepted-cards div {
                width: 20px !important;
                height: 12px !important;
                font-size: 8px !important;
                line-height: 1 !important;
            }

            #accepted-cards {
                gap: 2px !important;
            }

            /* Security section mobile layout */
            .bg-gradient-to-r.from-blue-50 .flex.items-center.justify-between {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 0.75rem !important;
            }

            .bg-gradient-to-r.from-blue-50 .flex.items-center.space-x-3 {
                flex-wrap: wrap !important;
                gap: 0.5rem !important;
                margin: 0 !important;
            }

            /* Other elements stack on mobile */
            .grid.grid-cols-1.md\\:grid-cols-3 {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }

            /* Ensure proper container width */
            .max-w-4xl {
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }

            /* Payment form container adjustments */
            .bg-gradient-to-br.from-slate-50 {
                margin-left: -0.5rem !important;
                margin-right: -0.5rem !important;
                padding: 1rem !important;
            }
        }

        /* Portrait mobile specific optimizations */
        @media (max-width: 430px) {
            /* Even smaller card brand icons for small portrait screens */
            #card-brand-icon div,
            #accepted-cards div {
                width: 18px !important;
                height: 10px !important;
                font-size: 7px !important;
            }

            /* More padding for card input to avoid overlap */
            #card-number-element {
                padding-right: 65px !important;
            }

            .absolute.right-4 {
                right: 6px !important;
                max-width: 60px !important;
            }

            /* Stack security section items vertically */
            .bg-gradient-to-r.from-blue-50 .flex.items-center.space-x-3 {
                flex-direction: column !important;
                align-items: flex-start !important;
                space-x-0 !important;
                gap: 0.25rem !important;
            }
        }

        /* Very small screens - stack everything */
        @media (max-width: 375px) {
            .grid.grid-cols-1.md\\:grid-cols-3 {
                display: block !important;
            }

            .grid.grid-cols-1.md\\:grid-cols-3 > div {
                margin-bottom: 1rem !important;
            }

            /* Minimal brand icons for very small screens */
            #card-brand-icon div,
            #accepted-cards div {
                width: 16px !important;
                height: 9px !important;
                font-size: 6px !important;
            }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <!-- Loading State -->
    <div id="loadingState" class="flex items-center justify-center min-h-screen">
        <div class="text-center">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
                <svg class="w-8 h-8 text-blue-600 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
            </div>
            <p class="text-slate-600">Loading your quote...</p>
        </div>
    </div>

    <!-- Error State -->
    <div id="errorState" class="hidden min-h-screen flex items-center justify-center">
        <div class="max-w-md mx-auto text-center p-6">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mb-4">
                <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
            </div>
            <h1 class="text-2xl font-bold text-slate-800 mb-2">Quote Not Found</h1>
            <p id="errorMessage" class="text-slate-600 mb-4">This quote may have expired or the link is invalid.</p>
            <a href="/" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                Return to Homepage
            </a>
        </div>
    </div>

    <!-- Quote Content -->
    <div id="quoteContent" class="hidden">
        <!-- Header -->
        <div class="bg-white border-b border-slate-200">
            <div class="max-w-4xl mx-auto px-4 py-6">
                <div class="text-center">
                    <div class="flex items-center justify-center gap-3 mb-2">
                        <img src="/images/helpinghands_logo.png" alt="SendAHandyman Logo" class="h-12 w-auto">
                        <h1 class="text-3xl font-bold text-slate-800">SendAHandyman</h1>
                    </div>
                    <p class="text-slate-600">Your personalized service quote</p>
                    <p class="text-lg font-bold text-slate-800 mt-1">Uber Fast</p>
                </div>
            </div>
        </div>

        <div class="max-w-4xl mx-auto p-6">
            <!-- Quote Details Card -->
            <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6 mb-8">
                <h2 class="text-xl font-semibold text-slate-800 mb-4">Quote Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div class="bg-slate-50 rounded-lg p-4">
                        <span class="font-semibold text-slate-700 block">Quote ID:</span>
                        <span id="quoteId" class="text-slate-600 font-mono">-</span>
                    </div>
                    <div class="bg-slate-50 rounded-lg p-4">
                        <span class="font-semibold text-slate-700 block">Service:</span>
                        <span id="serviceType" class="text-slate-600">-</span>
                    </div>
                    <div class="bg-slate-50 rounded-lg p-4">
                        <span class="font-semibold text-slate-700 block">Expires:</span>
                        <span id="expiryDate" class="text-slate-600">-</span>
                    </div>
                </div>

                <div id="descriptionSection" class="mt-4 hidden bg-slate-50 rounded-lg p-4">
                    <span class="font-semibold text-slate-700 block mb-2">Service Description:</span>
                    <p id="serviceDescription" class="text-slate-600">-</p>
                </div>
            </div>

            <!-- Pricing Options -->
            <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6 mb-8">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">Choose Your Pricing & Timing</h2>
                    <p class="text-slate-600">Select the option that works best for your schedule</p>
                </div>

                <div id="pricingOptions" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Pricing options will be generated by JavaScript -->
                </div>

                <!-- Add-ons Section -->
                <div id="addonsSection" class="mt-8 pt-6 border-t border-slate-200">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Optional Add-ons</h3>
                    <div id="addonsContainer" class="space-y-3">
                        <!-- Add-ons will be populated by JavaScript based on service type -->
                    </div>
                </div>

                <!-- Total Display -->
                <div class="mt-8 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="text-lg font-semibold text-slate-800">Total Amount:</span>
                            <div class="text-sm text-slate-600">
                                <span id="selectedTimingText">Select timing option above</span>
                            </div>
                        </div>
                        <div class="text-3xl font-bold text-blue-600">
                            $<span id="totalAmount">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Booking Form -->
            <div id="bookingForm" class="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
                <h2 class="text-xl font-semibold text-slate-800 mb-6">Complete Your Booking</h2>

                <form id="paymentForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Full Name *</label>
                            <input type="text" id="customerNameInput" required class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Phone Number *</label>
                            <input type="tel" id="customerPhoneInput" required class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Email Address</label>
                        <input type="email" id="customerEmailInput" class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Service Address *</label>
                        <textarea id="customerAddressInput" required rows="3" class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter the full address where service will be performed"></textarea>
                    </div>

                    <!-- Payment Method -->
                    <div class="border-t border-slate-200 pt-8">
                        <!-- Professional Header -->
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h3 class="text-lg font-semibold text-slate-800">Payment Details</h3>
                                <p class="text-sm text-slate-500 mt-1">Your payment information is encrypted and secure</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                                <span class="text-xs font-medium text-green-600">SECURE</span>
                            </div>
                        </div>

                        <!-- Professional Card Form Container -->
                        <div class="bg-gradient-to-br from-slate-50 to-slate-100 rounded-xl p-6 border border-slate-200 shadow-sm mb-6">

                            <!-- Card Number - Professional Design -->
                            <div class="mb-6">
                                <label class="block text-sm font-semibold text-slate-700 mb-3">
                                    <div class="flex items-center">
                                        <svg class="w-4 h-4 mr-2 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                                        </svg>
                                        Card Number
                                    </div>
                                </label>
                                <div class="relative group">
                                    <div id="card-number-element" class="p-4 border-2 border-slate-200 rounded-lg bg-white shadow-sm focus-within:border-blue-500 focus-within:shadow-md transition-all duration-300 group-hover:border-slate-300">
                                        <!-- Card Number Element -->
                                    </div>
                                    <!-- Enhanced Card Brand Icons -->
                                    <div class="absolute right-4 top-1/2 transform -translate-y-1/2 flex space-x-2">
                                        <div id="card-brand-icon" class="hidden">
                                            <!-- Card brand icon will be inserted here -->
                                        </div>
                                        <!-- Professional Accepted Cards Display -->
                                        <div id="accepted-cards" class="flex items-center space-x-1 opacity-40">
                                            <div class="w-8 h-5 bg-blue-600 rounded shadow-sm text-white text-xs flex items-center justify-center font-bold">VISA</div>
                                            <div class="w-8 h-5 bg-red-600 rounded shadow-sm text-white text-xs flex items-center justify-center font-bold">MC</div>
                                            <div class="w-8 h-5 bg-green-600 rounded shadow-sm text-white text-xs flex items-center justify-center font-bold">AMEX</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Card Details Grid - Professional Layout -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <!-- Expiry Date -->
                                <div class="group">
                                    <label class="block text-sm font-semibold text-slate-700 mb-3">
                                        <div class="flex items-center">
                                            <svg class="w-4 h-4 mr-2 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 4v10a2 2 0 002 2h4a2 2 0 002-2V11m-6 0h8"></path>
                                            </svg>
                                            Expiry Date
                                        </div>
                                    </label>
                                    <div id="card-expiry-element" class="p-4 border-2 border-slate-200 rounded-lg bg-white shadow-sm focus-within:border-blue-500 focus-within:shadow-md transition-all duration-300 group-hover:border-slate-300">
                                        <!-- Card Expiry Element -->
                                    </div>
                                </div>

                                <!-- Security Code -->
                                <div class="group">
                                    <label class="block text-sm font-semibold text-slate-700 mb-3">
                                        <div class="flex items-center">
                                            <svg class="w-4 h-4 mr-2 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                            </svg>
                                            Security Code
                                        </div>
                                    </label>
                                    <div class="relative">
                                        <div id="card-cvc-element" class="p-4 border-2 border-slate-200 rounded-lg bg-white shadow-sm focus-within:border-blue-500 focus-within:shadow-md transition-all duration-300 group-hover:border-slate-300">
                                            <!-- Card CVC Element -->
                                        </div>
                                        <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
                                            <div class="w-7 h-5 border border-slate-300 rounded text-xs flex items-center justify-center text-slate-400 bg-slate-50 font-mono">CVC</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- ZIP Code -->
                                <div class="group">
                                    <label class="block text-sm font-semibold text-slate-700 mb-3">
                                        <div class="flex items-center">
                                            <svg class="w-4 h-4 mr-2 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            </svg>
                                            ZIP Code
                                        </div>
                                    </label>
                                    <div id="postal-code-element" class="p-4 border-2 border-slate-200 rounded-lg bg-white shadow-sm focus-within:border-blue-500 focus-within:shadow-md transition-all duration-300 group-hover:border-slate-300">
                                        <!-- Postal Code Element -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Security & Trust Section -->
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-5 mb-6 border border-blue-100">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full flex items-center justify-center mr-3 shadow-sm">
                                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="font-semibold text-slate-800 text-sm">Bank-Level Security</div>
                                        <div class="text-xs text-slate-600">Powered by Stripe ‚Ä¢ PCI DSS Compliant</div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3 text-xs text-slate-500">
                                    <div class="flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                        </svg>
                                        SSL Encrypted
                                    </div>
                                    <div class="w-1 h-1 bg-slate-300 rounded-full"></div>
                                    <div>Zero Data Stored</div>
                                </div>
                            </div>
                        </div>

                        <div id="payment-errors" class="text-red-600 text-sm mt-4 p-3 bg-red-50 border border-red-200 rounded-lg hidden"></div>
                    </div>

                    <!-- Submit Button -->
                    <div class="pt-4">
                        <button type="submit" id="submitButton" class="w-full bg-green-600 text-white py-4 px-6 rounded-lg font-semibold text-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" disabled>
                            <span id="buttonText">Select timing option to continue</span>
                            <span id="buttonSpinner" class="hidden">
                                <svg class="inline w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Processing...
                            </span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Trust Indicators -->
            <div class="text-center mt-8 text-sm text-slate-500">
                <p>üîí Secure payment powered by Stripe</p>
                <p class="mt-1">Your handyman will contact you within 24 hours to schedule your service.</p>
            </div>
        </div>
    </div>

    <script>
        let stripe = null;
        let elements = null;
        let paymentElement = null;
        let paymentElementReady = false;
        let quoteData = null;
        let quoteToken = null;
        let selectedPricingOption = null;
        let selectedAddons = {};

        // Service add-ons definitions (similar to index.html structure)
        const serviceAddons = {
            'tv_mount': [
                { id: 'extra_tv', label: 'Mount additional TV (+1 TV)', price: 120 },
                { id: 'cable_management', label: 'Advanced cable management', price: 40 },
                { id: 'sound_bar_mount', label: 'Sound bar mounting', price: 60 }
            ],
            'ceiling_fan': [
                { id: 'light_kit', label: 'Install light kit', price: 30 },
                { id: 'wall_switch', label: 'Install wall switch/dimmer', price: 45 },
                { id: 'remove_old_fixture', label: 'Remove existing fixture', price: 25 }
            ],
            'furniture_assembly': [
                { id: 'extra_item', label: 'Additional furniture piece', price: 80 },
                { id: 'mounting', label: 'Mount to wall (bookshelf/dresser)', price: 50 },
                { id: 'placement', label: 'Room placement & arrangement', price: 30 }
            ],
            'premium_moveout': [
                { id: 'full_room_paint', label: 'Full room repainting', price: 75 },
                { id: 'carpet_cleaning', label: 'Professional carpet cleaning', price: 50 },
                { id: 'appliance_cleaning', label: 'Deep appliance cleaning', price: 40 }
            ]
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            // Extract token from URL
            const urlParams = new URLSearchParams(window.location.search);
            quoteToken = urlParams.get('token');

            if (!quoteToken) {
                showError('No quote token provided in URL');
                return;
            }

            // Initialize Stripe (basic setup)
            try {
                stripe = Stripe('pk_live_51Rz41zHQ4TkcNcqv0IXVWGjAjLo8EoSkGO2fbeINw6U23GsLSiaOsHYVSEPwlJbR2EZ515tqPDJcRPvDBYSdv2Wy00N7DPqhI3');
                console.log('‚úÖ Stripe initialized successfully');
            } catch (error) {
                console.error('Stripe initialization failed:', error);
                showError('Payment system initialization failed');
                return;
            }

            // Payment Element will be initialized when pricing option is selected

            // Load quote data
            await loadQuote();
        });

        async function loadQuote() {
            try {
                const response = await fetch(`/.netlify/functions/get-quote/${quoteToken}`);
                const data = await response.json();

                if (!response.ok) {
                    if (data.expired) {
                        showError('This quote has expired. Please contact us for a new quote.');
                    } else if (data.already_paid) {
                        showError('This quote has already been used.');
                    } else {
                        showError(data.error || 'Quote not found');
                    }
                    return;
                }

                quoteData = data.quote;
                displayQuote();
                generatePricingOptions();
                generateAddons();

            } catch (error) {
                console.error('Failed to load quote:', error);
                showError('Failed to load quote. Please check your internet connection.');
            }
        }

        function displayQuote() {
            // Populate quote details
            document.getElementById('quoteId').textContent = quoteData.quote_id;
            document.getElementById('serviceType').textContent = quoteData.service_type;

            // Format expiry date
            const expiryDate = new Date(quoteData.expires_at);
            document.getElementById('expiryDate').textContent = expiryDate.toLocaleDateString() + ' (' + quoteData.days_until_expiry + ' days remaining)';

            // Show description if provided
            if (quoteData.description) {
                document.getElementById('serviceDescription').textContent = quoteData.description;
                document.getElementById('descriptionSection').classList.remove('hidden');
            }

            // Pre-fill customer information
            document.getElementById('customerNameInput').value = quoteData.customer_name || '';
            document.getElementById('customerPhoneInput').value = quoteData.customer_phone || '';
            document.getElementById('customerEmailInput').value = quoteData.customer_email || '';

            // Show content and hide loading
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('quoteContent').classList.remove('hidden');
        }

        function generatePricingOptions() {
            const baseAmount = parseFloat(quoteData.amount);
            const now = new Date();
            const optionsContainer = document.getElementById('pricingOptions');

            // Create 3 pricing tiers based on availability
            const pricingOptions = [
                {
                    id: 'flexible',
                    title: 'Flexible Timing',
                    subtitle: 'Best Value',
                    description: 'We\'ll schedule when it works best',
                    timing: 'Next available slot',
                    price: baseAmount,
                    badge: 'SAVE $20',
                    popular: false
                },
                {
                    id: 'this_week',
                    title: 'This Week',
                    subtitle: 'Standard Rate',
                    description: 'Schedule within this week',
                    timing: 'Within 7 days',
                    price: baseAmount + 20,
                    badge: 'STANDARD',
                    popular: true
                },
                {
                    id: 'asap',
                    title: 'ASAP Service',
                    subtitle: 'Rush Fee',
                    description: 'Priority scheduling',
                    timing: 'Within 24-48 hours',
                    price: baseAmount + 50,
                    badge: 'RUSH',
                    popular: false
                }
            ];

            optionsContainer.innerHTML = pricingOptions.map((option, index) => `
                <div class="pricing-option bg-white border-2 border-slate-200 rounded-lg p-6 relative ${option.popular ? 'border-blue-500' : ''}"
                     onclick="selectPricingOption('${option.id}', ${option.price}, '${option.title}', '${option.timing}')"
                     id="option-${option.id}">
                    ${option.popular ? '<div class="absolute -top-3 left-1/2 transform -translate-x-1/2"><span class="bg-blue-600 text-white px-3 py-1 rounded-full text-xs font-semibold">MOST POPULAR</span></div>' : ''}

                    <div class="text-center">
                        <div class="mb-4">
                            <h3 class="text-lg font-bold text-slate-800">${option.title}</h3>
                            <p class="text-sm text-slate-600">${option.subtitle}</p>
                        </div>

                        <div class="mb-4">
                            <div class="text-3xl font-bold text-blue-600">$${option.price}</div>
                            <div class="text-sm text-slate-500">${option.timing}</div>
                        </div>

                        <div class="mb-4 text-sm text-slate-600">
                            ${option.description}
                        </div>

                        <div class="text-xs font-semibold ${option.id === 'flexible' ? 'text-green-600' : option.id === 'asap' ? 'text-orange-600' : 'text-blue-600'}">
                            ${option.badge}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function generateAddons() {
            const serviceType = getServiceKey(quoteData.service_type);
            const addons = serviceAddons[serviceType] || [];
            const container = document.getElementById('addonsContainer');

            if (addons.length === 0) {
                document.getElementById('addonsSection').style.display = 'none';
                return;
            }

            container.innerHTML = addons.map(addon => `
                <label class="flex items-center justify-between p-3 border border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer">
                    <div class="flex items-center">
                        <input type="checkbox"
                               class="mr-3 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                               id="addon-${addon.id}"
                               onchange="toggleAddon('${addon.id}', ${addon.price}, this.checked)">
                        <div>
                            <span class="font-medium text-slate-800">${addon.label}</span>
                        </div>
                    </div>
                    <span class="font-semibold text-slate-600">+$${addon.price}</span>
                </label>
            `).join('');
        }

        function getServiceKey(serviceTypeName) {
            // Map service names back to keys for addon lookup
            const serviceMap = {
                'TV Wall Mount': 'tv_mount',
                'Ceiling Fan': 'ceiling_fan',
                'Furniture Assembly': 'furniture_assembly',
                'Premium Move-Out Removal': 'premium_moveout'
            };
            return serviceMap[serviceTypeName] || 'general';
        }

        function initializePaymentElement() {
            if (!selectedPricingOption) {
                console.log('‚è≥ No pricing option selected yet');
                return;
            }

            console.log('üîÑ Initializing modern payment form...');

            // For quotes, we'll use the traditional Card Element but with modern styling
            // This avoids the complexity of Payment Intents while still improving mobile experience
            if (paymentElement) {
                console.log('üßπ Cleaning up existing payment element');
                try {
                    paymentElement.unmount();
                } catch (e) {
                    console.log('Note: Payment element unmount not needed');
                }
                paymentElement = null;
                elements = null;
            }

            paymentElementReady = false;
            const errorElement = document.getElementById('payment-errors');
            errorElement.classList.add('hidden');
            errorElement.textContent = '';

            try {
                console.log('üîÑ Setting up enhanced Card Element with mobile optimization...');

                // Use Elements with modern styling (but Card element for simplicity)
                elements = stripe.elements({
                    fonts: [{
                        cssSrc: 'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap'
                    }]
                });

                // Create individual card elements for better mobile layout
                const cardStyle = {
                    base: {
                        fontSize: '16px', // Prevents iOS zoom
                        lineHeight: '1.5',
                        fontFamily: 'Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                        fontWeight: '400',
                        color: '#32325d',
                        backgroundColor: '#ffffff',
                        iconColor: '#4f46e5',
                        padding: '14px',
                        '::placeholder': {
                            color: '#a0aec0',
                            fontSize: '16px'
                        },
                        // Mobile-specific optimizations
                        '@media (max-width: 768px)': {
                            fontSize: '16px', // Critical for iOS
                            lineHeight: '1.6',
                            padding: '16px 14px',
                            letterSpacing: '0.5px'
                        }
                    },
                    focus: {
                        color: '#1a202c',
                        iconColor: '#4f46e5',
                        outline: 'none'
                    },
                    invalid: {
                        color: '#e53e3e',
                        iconColor: '#e53e3e'
                    }
                };

                // Create separate elements for better mobile control
                const cardNumber = elements.create('cardNumber', {
                    style: cardStyle,
                    placeholder: '1234 1234 1234 1234'
                });

                const cardExpiry = elements.create('cardExpiry', {
                    style: cardStyle,
                    placeholder: 'MM / YY'
                });

                const cardCvc = elements.create('cardCvc', {
                    style: cardStyle,
                    placeholder: 'CVC'
                });

                const postalCode = elements.create('postalCode', {
                    style: cardStyle,
                    placeholder: 'ZIP Code'
                });

                // Store references for later use
                paymentElement = {
                    cardNumber,
                    cardExpiry,
                    cardCvc,
                    postalCode
                };

                // Mount each element to its container
                const cardNumberElement = document.getElementById('card-number-element');
                const cardExpiryElement = document.getElementById('card-expiry-element');
                const cardCvcElement = document.getElementById('card-cvc-element');
                const postalCodeElement = document.getElementById('postal-code-element');

                if (!cardNumberElement || !cardExpiryElement || !cardCvcElement || !postalCodeElement) {
                    throw new Error('Payment element containers not found');
                }

                // Mount individual elements
                cardNumber.mount('#card-number-element');
                cardExpiry.mount('#card-expiry-element');
                cardCvc.mount('#card-cvc-element');
                postalCode.mount('#postal-code-element');

                // Set up event handlers for all elements
                let elementsReady = 0;
                const totalElements = 4;

                function checkAllReady() {
                    elementsReady++;
                    if (elementsReady === totalElements) {
                        console.log('‚úÖ All card elements mounted and ready');
                        paymentElementReady = true;
                    }
                }

                // Ready event handlers
                cardNumber.on('ready', checkAllReady);
                cardExpiry.on('ready', checkAllReady);
                cardCvc.on('ready', checkAllReady);
                postalCode.on('ready', checkAllReady);

                // Change event handlers for error display and card brand detection
                function handleElementChange(event) {
                    if (event.error) {
                        errorElement.textContent = event.error.message;
                        errorElement.classList.remove('hidden');
                    } else {
                        errorElement.classList.add('hidden');
                    }
                }

                // Card brand detection function
                function updateCardBrand(event) {
                    const cardBrandIcon = document.getElementById('card-brand-icon');
                    const acceptedCards = document.getElementById('accepted-cards');

                    if (event.brand && event.brand !== 'unknown') {
                        // Responsive card brand icons - CSS media queries handle sizing
                        const brandIcons = {
                            'visa': '<div class="w-12 h-7 md:w-12 md:h-7 bg-gradient-to-r from-blue-600 to-blue-700 rounded-md shadow-sm text-white text-xs flex items-center justify-center font-bold tracking-wide">VISA</div>',
                            'mastercard': '<div class="w-12 h-7 md:w-12 md:h-7 bg-gradient-to-r from-red-600 to-red-700 rounded-md shadow-sm text-white text-xs flex items-center justify-center font-bold">MC</div>',
                            'amex': '<div class="w-12 h-7 md:w-12 md:h-7 bg-gradient-to-r from-blue-800 to-blue-900 rounded-md shadow-sm text-white text-xs flex items-center justify-center font-bold">AMEX</div>',
                            'discover': '<div class="w-12 h-7 md:w-12 md:h-7 bg-gradient-to-r from-orange-600 to-orange-700 rounded-md shadow-sm text-white text-xs flex items-center justify-center font-bold">DISC</div>',
                            'diners': '<div class="w-12 h-7 md:w-12 md:h-7 bg-gradient-to-r from-gray-700 to-gray-800 rounded-md shadow-sm text-white text-xs flex items-center justify-center font-bold">DINERS</div>',
                            'jcb': '<div class="w-12 h-7 md:w-12 md:h-7 bg-gradient-to-r from-green-600 to-green-700 rounded-md shadow-sm text-white text-xs flex items-center justify-center font-bold">JCB</div>',
                            'unionpay': '<div class="w-12 h-7 md:w-12 md:h-7 bg-gradient-to-r from-purple-600 to-purple-700 rounded-md shadow-sm text-white text-xs flex items-center justify-center font-bold">UP</div>'
                        };

                        cardBrandIcon.innerHTML = brandIcons[event.brand] || '';
                        cardBrandIcon.classList.remove('hidden');
                        acceptedCards.classList.add('hidden');
                    } else {
                        cardBrandIcon.classList.add('hidden');
                        acceptedCards.classList.remove('hidden');
                    }

                    // Also handle errors
                    handleElementChange(event);
                }

                cardNumber.on('change', updateCardBrand);
                cardExpiry.on('change', handleElementChange);
                cardCvc.on('change', handleElementChange);
                postalCode.on('change', handleElementChange);

                console.log('‚úÖ Enhanced Card Element initialized with mobile optimization');

            } catch (error) {
                console.error('‚ùå Payment element setup error:', error);
                errorElement.textContent = 'Unable to load payment form. Please refresh the page.';
                errorElement.classList.remove('hidden');
            }
        }

        function selectPricingOption(optionId, price, title, timing) {
            // Remove selection from all options
            document.querySelectorAll('.pricing-option').forEach(option => {
                option.classList.remove('selected');
            });

            // Select this option
            document.getElementById(`option-${optionId}`).classList.add('selected');

            selectedPricingOption = {
                id: optionId,
                basePrice: price,
                title: title,
                timing: timing
            };

            updateTotalAmount();
            updateSubmitButton();

            // Initialize Payment Element when pricing is selected
            initializePaymentElement();
        }

        function toggleAddon(addonId, price, isChecked) {
            if (isChecked) {
                selectedAddons[addonId] = price;
            } else {
                delete selectedAddons[addonId];
            }

            updateTotalAmount();
        }

        function calculateTotalPrice() {
            if (!selectedPricingOption) return 0;
            const addonTotal = Object.values(selectedAddons).reduce((sum, price) => sum + price, 0);
            return selectedPricingOption.basePrice + addonTotal;
        }

        function updateTotalAmount() {
            if (!selectedPricingOption) return;

            const total = calculateTotalPrice();

            document.getElementById('totalAmount').textContent = total;
            document.getElementById('selectedTimingText').textContent = `${selectedPricingOption.title} - ${selectedPricingOption.timing}`;
        }

        function updateSubmitButton() {
            const submitButton = document.getElementById('submitButton');
            const buttonText = document.getElementById('buttonText');

            if (selectedPricingOption) {
                submitButton.disabled = false;
                const total = selectedPricingOption.basePrice + Object.values(selectedAddons).reduce((sum, price) => sum + price, 0);
                buttonText.textContent = `Pay $${total} & Book Service`;
            } else {
                submitButton.disabled = true;
                buttonText.textContent = 'Select timing option to continue';
            }
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
        }

        // Handle form submission
        document.getElementById('paymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!selectedPricingOption) {
                alert('Please select a timing option first.');
                return;
            }

            const submitButton = document.getElementById('submitButton');
            const buttonText = document.getElementById('buttonText');
            const buttonSpinner = document.getElementById('buttonSpinner');

            // Disable button and show spinner
            submitButton.disabled = true;
            buttonText.classList.add('hidden');
            buttonSpinner.classList.remove('hidden');

            try {
                // Check if enhanced Card Element is ready
                if (!stripe || !elements || !paymentElement || !paymentElementReady) {
                    throw new Error('Payment form not ready. Please select a pricing option and wait for the payment form to load.');
                }

                // Validate payment elements are in DOM
                const cardNumberInDom = document.querySelector('#card-number-element iframe');
                if (!cardNumberInDom) {
                    throw new Error('Payment form not properly loaded. Please refresh the page and try again.');
                }

                console.log('üîÑ Creating payment method with separate card elements...');

                // Create payment method using card number element (mobile-optimized, backend compatible)
                const { error, paymentMethod } = await stripe.createPaymentMethod({
                    type: 'card',
                    card: paymentElement.cardNumber, // Using the card number element
                    billing_details: {
                        name: document.getElementById('customerNameInput').value,
                        email: document.getElementById('customerEmailInput').value,
                        phone: document.getElementById('customerPhoneInput').value,
                        address: {
                            line1: document.getElementById('customerAddressInput').value
                        }
                    },
                });

                if (error) {
                    throw new Error(error.message);
                }

                console.log('‚úÖ Payment method created:', paymentMethod.id);

                // Calculate final amount for backend
                const finalAmount = calculateTotalPrice();

                // Use the payment method ID for backend
                const paymentMethodId = paymentMethod.id;

                // Send additional data to backend
                const response = await fetch('/.netlify/functions/process-quote-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        quote_token: quoteToken,
                        customer_name: document.getElementById('customerNameInput').value,
                        customer_phone: document.getElementById('customerPhoneInput').value,
                        customer_email: document.getElementById('customerEmailInput').value,
                        customer_address: document.getElementById('customerAddressInput').value,
                        timing_preference: selectedPricingOption.id,
                        selected_addons: selectedAddons,
                        final_amount: finalAmount,
                        payment_method_id: paymentMethodId // Modern Payment Element, backend compatible
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Payment processing failed');
                }

                // Success! Redirect to success page
                window.location.href = `/quote-payment-success.html?token=${quoteToken}&task_id=${result.task_id}`;

            } catch (error) {
                console.error('Payment error:', error);
                alert('Payment failed: ' + error.message);

                // Re-enable button
                submitButton.disabled = false;
                buttonText.classList.remove('hidden');
                buttonSpinner.classList.add('hidden');
            }
        });
    </script>
</body>
</html>