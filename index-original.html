<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>SendAHandyman ‚Äî Same-Day / Next-Day Handyman Dispatch</title>
    <meta name="description" content="Book a vetted handyman today or tomorrow. Upload photos, get an instant AI estimate, and reserve with your card. Serving Palm Beach, Broward & Miami-Dade." />
    <!-- SSL Certificate Status: DEVELOPMENT ONLY - Requires valid SSL certificate for full payment method support -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17598022946"></script>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-PW9HC7HL');</script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'AW-17598022946');
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* Warm Minimalism Design System */
        :root {
            --color-warm-50: #fef9f3;
            --color-warm-100: #fef0e5;
            --color-warm-200: #fcdecb;
            --color-warm-300: #f9c4a0;
            --color-warm-400: #f5a373;
            --color-warm-500: #f1834e;
            --color-warm-600: #e76932;
            --color-warm-700: #d14f20;
            --color-warm-800: #a8401a;
            --color-warm-900: #86371a;

            --color-neutral-0: #fefefe;
            --color-neutral-50: #f9f8f7;
            --color-neutral-100: #f1efed;
            --color-neutral-200: #e6e3e0;
            --color-neutral-300: #d5d1cc;
            --color-neutral-400: #b8b2ab;
            --color-neutral-500: #9c958d;
            --color-neutral-600: #7a736b;
            --color-neutral-700: #5e5751;
            --color-neutral-800: #473f3a;
            --color-neutral-900: #2d251f;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--color-neutral-50);
            color: var(--color-neutral-800);
            line-height: 1.6;
        }

        /* Typography - Warm & Friendly */
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Manrope', system-ui, sans-serif;
            color: var(--color-neutral-900);
            line-height: 1.2;
            letter-spacing: -0.02em;
        }

        /* Enhanced Typography Classes */
        .font-display {
            font-family: 'Manrope', system-ui, sans-serif;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .font-body {
            font-family: 'Inter', system-ui, sans-serif;
            line-height: 1.6;
        }

        .text-soft {
            color: var(--color-neutral-600);
        }

        .text-subtle {
            color: var(--color-neutral-500);
        }

        /* Custom Warm Color Classes */
        .bg-warm-50 { background-color: var(--color-warm-50); }
        .bg-warm-100 { background-color: var(--color-warm-100); }
        .bg-warm-200 { background-color: var(--color-warm-200); }
        .bg-warm-300 { background-color: var(--color-warm-300); }
        .bg-warm-400 { background-color: var(--color-warm-400); }
        .bg-warm-500 { background-color: var(--color-warm-500); }
        .bg-warm-600 { background-color: var(--color-warm-600); }
        .bg-warm-700 { background-color: var(--color-warm-700); }
        .bg-warm-800 { background-color: var(--color-warm-800); }

        .text-warm-50 { color: var(--color-warm-50); }
        .text-warm-100 { color: var(--color-warm-100); }
        .text-warm-200 { color: var(--color-warm-200); }
        .text-warm-300 { color: var(--color-warm-300); }
        .text-warm-400 { color: var(--color-warm-400); }
        .text-warm-500 { color: var(--color-warm-500); }
        .text-warm-600 { color: var(--color-warm-600); }
        .text-warm-700 { color: var(--color-warm-700); }
        .text-warm-800 { color: var(--color-warm-800); }

        .border-warm-50 { border-color: var(--color-warm-50); }
        .border-warm-100 { border-color: var(--color-warm-100); }
        .border-warm-200 { border-color: var(--color-warm-200); }
        .border-warm-300 { border-color: var(--color-warm-300); }
        .border-warm-400 { border-color: var(--color-warm-400); }
        .border-warm-500 { border-color: var(--color-warm-500); }
        .border-warm-600 { border-color: var(--color-warm-600); }
        .border-warm-700 { border-color: var(--color-warm-700); }
        .border-warm-800 { border-color: var(--color-warm-800); }

        /* Focus Ring Variants */
        .focus\:ring-warm-500:focus {
            --tw-ring-color: var(--color-warm-500);
            --tw-ring-opacity: 0.5;
        }

        .bg-neutral-soft {
            background-color: var(--color-neutral-0);
        }

        .bg-neutral-whisper {
            background-color: var(--color-neutral-100);
        }

        /* Soft Shadows & Rounded Design */
        .shadow-warm {
            box-shadow: 0 4px 20px rgba(241, 131, 78, 0.08), 0 1px 4px rgba(241, 131, 78, 0.04);
        }

        .shadow-warm-sm {
            box-shadow: 0 2px 8px rgba(241, 131, 78, 0.06), 0 1px 3px rgba(241, 131, 78, 0.03);
        }

        .shadow-warm-md {
            box-shadow: 0 4px 16px rgba(241, 131, 78, 0.08), 0 2px 6px rgba(241, 131, 78, 0.04);
        }

        .shadow-warm-lg {
            box-shadow: 0 8px 32px rgba(241, 131, 78, 0.1), 0 4px 12px rgba(241, 131, 78, 0.05);
        }

        .shadow-warm-xl {
            box-shadow: 0 12px 48px rgba(241, 131, 78, 0.12), 0 6px 16px rgba(241, 131, 78, 0.06);
        }

        .shadow-warm-2xl {
            box-shadow: 0 16px 64px rgba(241, 131, 78, 0.15), 0 8px 24px rgba(241, 131, 78, 0.08);
        }

        .shadow-soft-xl {
            box-shadow: 0 8px 32px rgba(45, 37, 31, 0.06), 0 1px 8px rgba(45, 37, 31, 0.04);
        }

        .shadow-gentle {
            box-shadow: 0 2px 12px rgba(45, 37, 31, 0.04), 0 1px 4px rgba(45, 37, 31, 0.02);
        }

        /* Soft Rounded Elements */
        .rounded-warm {
            border-radius: 16px;
        }

        .rounded-warm-lg {
            border-radius: 24px;
        }

        .rounded-warm-xl {
            border-radius: 32px;
        }

        /* Button Styles - Warm & Approachable */
        .btn-warm-primary {
            background: linear-gradient(135deg, var(--color-warm-500) 0%, var(--color-warm-600) 100%);
            color: white;
            border-radius: 16px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(241, 131, 78, 0.2);
        }

        .btn-warm-primary:hover {
            background: linear-gradient(135deg, var(--color-warm-600) 0%, var(--color-warm-700) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(241, 131, 78, 0.3);
        }

        .btn-warm-secondary {
            background-color: var(--color-neutral-0);
            color: var(--color-neutral-700);
            border: 1.5px solid var(--color-neutral-200);
            border-radius: 16px;
            transition: all 0.2s ease;
        }

        .btn-warm-secondary:hover {
            background-color: var(--color-warm-50);
            border-color: var(--color-warm-300);
            color: var(--color-neutral-800);
        }

        .btn-warm-accent {
            background: linear-gradient(135deg, var(--color-warm-600) 0%, var(--color-warm-700) 100%);
            color: white;
            border-radius: 16px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(241, 131, 78, 0.25);
        }

        .btn-warm-accent:hover {
            background: linear-gradient(135deg, var(--color-warm-700) 0%, var(--color-warm-800) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(241, 131, 78, 0.35);
        }

        /* Card Styles - Soft & Breathable */
        .card-warm {
            background-color: var(--color-neutral-0);
            border-radius: 24px;
            box-shadow: 0 4px 24px rgba(45, 37, 31, 0.04), 0 1px 8px rgba(45, 37, 31, 0.02);
            border: 1px solid var(--color-neutral-200);
            transition: all 0.3s ease;
        }

        .card-warm:hover {
            box-shadow: 0 8px 32px rgba(45, 37, 31, 0.08), 0 2px 12px rgba(45, 37, 31, 0.04);
            transform: translateY(-2px);
        }

        /* Override some default Tailwind styles for warmth */
        .bg-white {
            background-color: var(--color-neutral-0) !important;
        }

        .bg-gray-50, .bg-slate-50 {
            background-color: var(--color-neutral-50) !important;
        }

        .text-slate-900 {
            color: var(--color-neutral-900) !important;
        }

        .text-slate-700 {
            color: var(--color-neutral-700) !important;
        }

        .text-slate-600 {
            color: var(--color-neutral-600) !important;
        }

        /* Mobile-first breathing room */
        @media (max-width: 768px) {
            .mobile-breathe {
                padding: 1.5rem !important;
            }
        }
    </style>

    <script src="https://js.stripe.com/v3/"></script>
    <!-- Leaflet.js for interactive maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
    <style>
        body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
        .shadow-soft{box-shadow:0 10px 30px rgba(0,0,0,.06)}
        .coverage-tab { color: #64748b; background: transparent; }
        .coverage-tab.active { background: #4f46e5; color: white; }
        .coverage-tab:hover { background: #e2e8f0; }
        .coverage-tab.active:hover { background: #4338ca; }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .pricing-option {
            transition: all 0.2s ease;
            margin-bottom: 0.75rem;
        }
        .pricing-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,.1);
        }
        .pricing-option.selected {
            border-color: #4f46e5;
            background-color: #f8fafc;
        }
        .pricing-badge {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            background: #4f46e5;
            color: white;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
        }
        .pricing-badge.premium {
            background: #dc2626;
        }
        .pricing-badge.discount {
            background: #059669;
        }
        .booking-step {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .booking-step.hidden {
            opacity: 0;
            transform: translateX(20px);
            display: none;
        }
        .pricing-step {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .pricing-step.hidden {
            opacity: 0;
            transform: translateX(20px);
            display: none;
        }
        @media (max-width: 768px) {
            .service-card {
                margin-bottom: 1rem;
            }
            .service-details {
                padding: 1rem;
            }
            .service-details .grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            #book .grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            .select-service-btn {
                font-size: 1rem;
                padding: 0.875rem 1rem;
            }
            h1 {
                font-size: 2rem;
                line-height: 2.5rem;
            }
            h2 {
                font-size: 1.5rem;
                line-height: 2rem;
            }
            .hero-section {
                padding: 2rem 0;
            }
            .text-5xl {
                font-size: 2.25rem;
            }
            .text-6xl {
                font-size: 2.5rem;
            }
        }
        .chatbot-typing {
            display: inline-block;
        }
        .chatbot-typing::after {
            content: '';
            animation: chatbot-dots 1.5s infinite;
        }
        @keyframes chatbot-dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        .carousel-container {
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem;
        }
        .carousel-track {
            display: flex;
            animation: carousel-scroll 24s linear infinite;
        }
        .carousel-slide {
            min-width: 100%;
            aspect-ratio: 16/9;
            background-size: cover;
            background-position: center;
        }
        @keyframes carousel-scroll {
            0% { transform: translateX(0); }
            16.66% { transform: translateX(0); }
            20% { transform: translateX(-100%); }
            36.66% { transform: translateX(-100%); }
            40% { transform: translateX(-200%); }
            56.66% { transform: translateX(-200%); }
            60% { transform: translateX(-300%); }
            76.66% { transform: translateX(-300%); }
            80% { transform: translateX(-400%); }
            96.66% { transform: translateX(-400%); }
            100% { transform: translateX(-500%); }
        }
        .carousel-container:hover .carousel-track {
            animation-play-state: paused;
        }
        #chatbot-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        #chatbot-toggle {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 70px;
            height: 70px;
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        #chatbot-toggle:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(79, 70, 229, 0.6);
            background: linear-gradient(135deg, #3730a3 0%, #6d28d9 100%);
        }
        #chatbot-toggle:active {
            transform: translateY(-1px);
        }
        #chatbot-toggle::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            animation: chatbot-pulse 2s infinite;
        }
        @keyframes chatbot-pulse {
            0% {
                transform: scale(1);
                opacity: 0.7;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.3;
            }
            100% {
                transform: scale(1);
                opacity: 0.7;
            }
        }
        #chatbot-toggle svg {
            width: 32px;
            height: 32px;
            z-index: 2;
            position: relative;
        }
        #chatbot-toggle::after {
            content: 'Need help? Click to chat!';
            position: absolute;
            right: 85px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            pointer-events: none;
        }
        #chatbot-toggle:hover::after {
            opacity: 1;
            visibility: visible;
            right: 80px;
        }
        .chatbot-notification {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            animation: bounce 1s infinite;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-5px);
            }
            60% {
                transform: translateY(-3px);
            }
        }
        #chatbot-window {
            width: 380px;
            height: 500px;
            bottom: 100px;
            right: 0;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }
        .mobile-menu-btn {
            display: none;
        }
        .mobile-menu {
            display: none;
        }
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }
            .desktop-nav {
                display: none;
            }
            .mobile-menu.active {
                display: block;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: white;
                border-top: 1px solid #e2e8f0;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                z-index: 50;
            }
            .mobile-menu a {
                display: block;
                padding: 12px 16px;
                border-bottom: 1px solid #f1f5f9;
                color: #475569;
                text-decoration: none;
            }
            .mobile-menu a:hover {
                background: #f8fafc;
                color: #4f46e5;
            }
            .mobile-header-row-2 {
                margin-top: 0.5rem;
            }
            #chatbot-container {
                bottom: 15px;
                right: 15px;
            }
            #chatbot-toggle {
                width: 65px;
                height: 65px;
            }
            #chatbot-toggle svg {
                width: 28px;
                height: 28px;
            }
            #chatbot-toggle::after {
                display: none;
            }
            #chatbot-window {
                width: 95vw;
                height: 70vh;
                right: 2.5vw;
                bottom: 85px;
            }
        }
    </style>
</head>
<body class="bg-neutral-50 text-neutral-800">
<header class="bg-neutral-soft/90 backdrop-blur sticky top-0 z-40 border-b border-neutral-200 shadow-gentle">
    <div class="max-w-6xl mx-auto px-4 py-3 relative">
        <div class="hidden md:flex items-center justify-between">
            <a href="index.html" class="flex items-center gap-2 hover:opacity-80 transition-opacity">
                <img src="/images/helpinghands_logo.png" alt="Helping Hands Logo" class="h-9 w-auto">
                <span class="font-semibold">SendAHandyman</span>
            </a>
            <nav class="desktop-nav flex items-center gap-6 text-sm">
                <a href="#how" class="hover:text-indigo-600">How it works</a>
                <a href="#tasks" class="hover:text-indigo-600">Book now</a>
                <a href="concierge.html" class="hover:text-indigo-600">Concierge</a>
                <a href="#coverage" class="hover:text-indigo-600">Coverage</a>
                <a href="#faq" class="hover:text-indigo-600">FAQ</a>
                <a href="join-team.html" class="hover:text-green-600 font-semibold">üíº Join Our Team</a>
            </nav>
            <a href="#tasks" class="inline-flex items-center gap-2 rounded-xl bg-indigo-600 px-4 py-2 text-white text-sm font-semibold shadow-soft">Start your request</a>
        </div>
        <div class="md:hidden">
            <div class="flex items-center justify-between">
                <a href="index.html" class="flex items-center gap-2 hover:opacity-80 transition-opacity">
                    <img src="/images/helpinghands_logo.png" alt="Helping Hands Logo" class="h-9 w-auto">
                    <span class="font-semibold">SendAHandyman</span>
                </a>
                <button class="mobile-menu-btn p-2" id="mobile-menu-btn">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
            <div class="mobile-header-row-2 flex justify-center">
                <a href="#tasks" class="inline-flex items-center gap-2 rounded-xl bg-indigo-600 px-4 py-2 text-white text-sm font-semibold shadow-soft">Start your request</a>
            </div>
        </div>
        <div class="mobile-menu" id="mobile-menu">
            <a href="#how">How it works</a>
            <a href="#tasks">Book now</a>
            <a href="concierge.html">Concierge</a>
            <a href="#coverage">Coverage</a>
            <a href="#faq">FAQ</a>
            <a href="join-team.html">Join Our Team</a>
        </div>
    </div>
</header>

<section class="bg-gradient-to-b from-neutral-0 to-warm-50">
    <div class="max-w-6xl mx-auto px-6 py-12 md:py-20 grid md:grid-cols-2 gap-12 items-center">
        <div>
            <h1 class="text-4xl md:text-6xl font-extrabold leading-tight">Local handyman help ‚Äî <span class="text-warm-600">today or tomorrow</span>.</h1>
            <p class="mt-6 text-neutral-600 text-xl leading-relaxed">Skip the contractor shopping. Just pick your task and we dispatch the right pro. Upload photos, get an instant AI estimate, and reserve with your card. Get text updates throughout.</p>
        </div>
        <div class="card-warm p-8 shadow-warm-lg">
            <div class="carousel-container">
                <div class="carousel-track">
                    <div class="carousel-slide" style="background-image: url('/images/Ceiling_Fan_Installation.png')"></div>
                    <div class="carousel-slide" style="background-image: url('/images/Mounting_TV.png')"></div>
                    <div class="carousel-slide" style="background-image: url('/images/Assembling_Furniture.png')"></div>
                    <div class="carousel-slide" style="background-image: url('/images/Installing_Blinds.png')"></div>
                    <div class="carousel-slide" style="background-image: url('/images/Installing_Faucet.png')"></div>
                    <div class="carousel-slide" style="background-image: url('/images/Smart_Doorbell_Installation.png')"></div>
                    <div class="carousel-slide" style="background-image: url('/images/Closet_Organizer_Installation.png')"></div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- AI Photo Triage System -->
<section class="py-16 md:py-20 bg-gradient-to-br from-warm-50 to-warm-100 border-t border-warm-200" id="ai-triage">
    <div class="max-w-6xl mx-auto px-6">
        <div class="text-center mb-12">
            <h2 class="text-3xl md:text-4xl font-bold text-neutral-800 mb-4">
                ü§ñ AI Photo Diagnosis
            </h2>
            <p class="text-xl text-neutral-700 max-w-3xl mx-auto">
                Upload a photo of your home repair issue and get an instant AI analysis with cost estimates and task recommendations. Our expert system analyzes your problem in seconds!
            </p>
        </div>

        <div class="max-w-5xl mx-auto">
            <div class="card-warm shadow-warm-lg p-10 md:p-12">
                <!-- Photo Upload Area -->
                <div id="photoUploadArea" class="border-2 border-dashed border-warm-300 rounded-warm p-4 md:p-8 text-center transition-all hover:border-warm-400 hover:bg-warm-50 touch-manipulation">
                    <div id="uploadPrompt">
                        <div class="w-12 h-12 md:w-16 md:h-16 bg-warm-100 rounded-full flex items-center justify-center mx-auto mb-3 md:mb-4">
                            <svg class="w-6 h-6 md:w-8 md:h-8 text-warm-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 16m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <h3 class="text-base md:text-lg font-semibold text-neutral-800 mb-2">Upload Your Repair Photo</h3>
                        <p class="text-sm md:text-base text-neutral-600 mb-4 hidden md:block">Drag and drop your image here, or tap to capture/browse</p>
                        <p class="text-sm text-neutral-600 mb-4 md:hidden">Tap to take photo or browse your gallery</p>
                        <p class="text-xs text-neutral-500 mb-2">Note: AVIF/HEIC files need conversion to JPG/PNG first</p>

                        <!-- Mobile-optimized buttons -->
                        <div class="space-y-3 md:space-y-0 md:space-x-3 md:flex md:justify-center md:items-center">
                            <button type="button" class="btn-warm-primary w-full md:w-auto px-6 py-4 md:py-3 font-semibold text-base md:text-sm touch-manipulation active:scale-95 transition-all duration-200">
                                üì∑ Take Photo
                            </button>
                            <button type="button" id="browsePhotoBtn" class="btn-warm-secondary w-full md:w-auto px-6 py-4 md:py-3 font-semibold text-base md:text-sm touch-manipulation active:scale-95 transition-all duration-200">
                                üñºÔ∏è Browse Gallery
                            </button>
                        </div>

                        <input type="file" id="photoInput" accept="image/jpeg,image/jpg,image/png,image/webp,image/gif" capture="environment" class="hidden" />
                        <input type="file" id="browseInput" accept="image/jpeg,image/jpg,image/png,image/webp,image/gif" class="hidden" />
                        <p class="text-xs md:text-sm text-neutral-500 mt-3">Best results with good lighting ‚Ä¢ JPG, PNG, WebP, GIF ‚Ä¢ Max 3.7MB (auto-compression available)</p>
                    </div>

                    <!-- Photo Preview -->
                    <div id="photoPreview" class="hidden">
                        <img id="previewImage" class="max-w-full max-h-48 md:max-h-64 mx-auto rounded-warm shadow-warm-md mb-4 object-contain" />
                        <p class="text-xs text-neutral-500 mb-4 md:hidden">Photo looks good? Tap to analyze or retake</p>
                        <div class="space-y-3 md:space-y-0 md:flex md:justify-center md:gap-3">
                            <button id="analyzeBtn" class="btn-warm-primary w-full md:w-auto px-6 py-4 md:py-3 font-semibold text-base md:text-sm touch-manipulation active:scale-95 transition-all duration-200">
                                üîç Analyze with AI
                            </button>
                            <button id="retakeBtn" class="btn-warm-secondary w-full md:w-auto px-6 py-4 md:py-3 font-semibold text-base md:text-sm touch-manipulation active:scale-95 transition-all duration-200">
                                üì∑ Take Different Photo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- File Error Display -->
                <div id="fileError" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-warm">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-red-600 mr-3 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-semibold text-red-800 text-sm md:text-base">Upload Error</h4>
                            <p id="fileErrorMessage" class="text-red-700 text-sm mt-1 break-words"></p>
                        </div>
                    </div>
                    <div class="mt-4 space-y-2 md:space-y-0 md:flex md:gap-2">
                        <button id="compressPhotoBtn" class="hidden btn-warm-primary w-full md:w-auto px-4 py-3 md:py-2 text-sm font-semibold touch-manipulation active:scale-95 transition-all duration-200">
                            üóúÔ∏è Compress & Try Again
                        </button>
                        <button id="dismissErrorBtn" class="btn-warm-secondary w-full md:w-auto px-4 py-3 md:py-2 text-sm font-semibold touch-manipulation active:scale-95 transition-all duration-200">
                            Dismiss
                        </button>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="analysisLoading" class="hidden text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-warm-600 mb-4"></div>
                    <p class="text-lg text-neutral-700">AI is analyzing your photo...</p>
                    <p class="text-sm text-neutral-500">This may take 10-45 seconds depending on image size and network speed</p>
                </div>

                <!-- AI Analysis Results -->
                <div id="analysisResults" class="hidden mt-8">
                    <div class="bg-gradient-to-r from-warm-50 to-warm-100 rounded-warm p-6 border border-warm-200">
                        <h3 class="text-xl font-bold text-warm-700 mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            AI Analysis Complete
                        </h3>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                            <!-- Problem Description -->
                            <div class="bg-neutral-50 rounded-warm p-3 md:p-4 shadow-warm-sm md:col-span-2">
                                <h4 class="font-semibold text-neutral-800 mb-2 text-sm md:text-base">Problem Identified</h4>
                                <p id="problemDescription" class="text-neutral-700 text-sm md:text-base"></p>
                            </div>

                            <!-- Cost Estimate - Priority on mobile -->
                            <div class="bg-neutral-50 rounded-warm p-3 md:p-4 shadow-warm-sm order-1 md:order-3">
                                <h4 class="font-semibold text-neutral-800 mb-2 text-sm md:text-base">Estimated Cost</h4>
                                <p id="costEstimate" class="text-xl md:text-2xl font-bold text-warm-600"></p>
                            </div>

                            <!-- Risk Assessment -->
                            <div class="bg-neutral-50 rounded-warm p-3 md:p-4 shadow-warm-sm order-2">
                                <h4 class="font-semibold text-neutral-800 mb-2 text-sm md:text-base">Risk Level</h4>
                                <div id="riskLevel" class="flex items-center"></div>
                            </div>

                            <!-- Recommended Task -->
                            <div class="bg-neutral-50 rounded-warm p-3 md:p-4 shadow-warm-sm md:col-span-2 order-3 md:order-1">
                                <h4 class="font-semibold text-slate-900 mb-2 text-sm md:text-base">Recommended Service</h4>
                                <p id="recommendedTask" class="text-neutral-700 font-semibold text-sm md:text-base"></p>
                            </div>
                        </div>

                        <!-- Urgency and Action -->
                        <div id="urgencySection" class="mt-6 p-4 rounded-warm">
                            <h4 class="font-semibold mb-2">Urgency Assessment</h4>
                            <p id="urgencyText" class="text-neutral-700 mb-4"></p>
                            <div class="space-y-3 md:space-y-0 md:flex md:flex-wrap md:gap-3">
                                <button id="bookServiceBtn" class="btn-warm-primary w-full md:w-auto px-6 py-4 md:py-3 font-semibold text-base md:text-sm touch-manipulation active:scale-95 transition-all duration-200">
                                    üìû Book This Service Now
                                </button>
                                <button id="viewTasksBtn" class="btn-warm-secondary w-full md:w-auto px-6 py-4 md:py-3 font-semibold text-base md:text-sm touch-manipulation active:scale-95 transition-all duration-200">
                                    üìã View All Services
                                </button>
                                <div class="grid grid-cols-2 gap-2 md:contents">
                                    <button id="analyzeAgainBtn" class="btn-warm-primary px-4 py-3 md:px-6 font-semibold text-sm touch-manipulation active:scale-95 transition-all duration-200">
                                        üîÑ Analyze Again
                                    </button>
                                    <button id="uploadNewPhotoBtn" class="btn-warm-accent px-4 py-3 md:px-6 font-semibold text-sm touch-manipulation active:scale-95 transition-all duration-200">
                                        üì∑ New Photo
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error State -->
                <div id="analysisError" class="hidden mt-8 p-6 bg-red-50 border border-red-200 rounded-warm">
                    <h3 class="text-lg font-semibold text-red-800 mb-2">Analysis Failed</h3>
                    <p class="text-red-700 mb-4">We couldn't analyze your photo. Please try again with a clearer image or contact us for assistance.</p>
                    <button id="retryBtn" class="bg-red-600 text-white px-6 py-3 rounded-warm hover:bg-red-700 transition-colors font-semibold">
                        Try Again
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="py-16 md:py-20 border-t border-warm-200 bg-neutral-0" id="tasks">
    <div class="max-w-6xl mx-auto px-6">
        <h2 class="text-3xl md:text-4xl font-bold mb-3">Popular fixed-price tasks</h2>
        <p class="text-neutral-600 text-lg leading-relaxed">Click any service to see what's included, then proceed to booking.</p>
        <div class="mt-10 space-y-6">
            <div class="service-card card-warm cursor-pointer transition-all duration-200 hover:border-warm-300 hover:shadow-warm-lg" data-task="tv_mount">
                <div class="service-header p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-lg">üì∫ TV Wall Mount (32‚Äì65")</h3>
                            <p class="text-sm text-neutral-600">~2.0 hr base ‚Ä¢ Starting at $160</p>
                        </div>
                        <div class="expand-icon text-neutral-400 transform transition-transform duration-200">‚ñº</div>
                    </div>
                </div>
                <div class="service-details hidden border-t border-warm-200">
                    <div class="p-6">
                        <div class="grid md:grid-cols-2 gap-8">
                            <div>
                                <h4 class="font-semibold text-warm-600 mb-2">‚úÖ Included:</h4>
                                <ul class="text-sm space-y-1 text-neutral-700">
                                    <li>‚Ä¢ Mounting TV (32‚Äì65") on drywall with wood studs</li>
                                    <li>‚Ä¢ Using customer-supplied mount</li>
                                    <li>‚Ä¢ Cord cover (if provided)</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-warm-700 mb-2">‚ö†Ô∏è Potential Add-ons:</h4>
                                <ul class="text-sm space-y-1 text-neutral-700">
                                    <li>‚Ä¢ +$40: Mounting on brick, concrete, or over fireplace</li>
                                    <li>‚Ä¢ +$50: TVs larger than 65"</li>
                                    <li>‚Ä¢ New outlet/electrical work not included</li>
                                </ul>
                            </div>
                        </div>
                        <div class="mt-6">
                            <button class="select-service-btn btn-warm-primary w-full py-3 px-4 font-semibold transition-all duration-200" data-task="tv_mount">
                                Select TV Wall Mount Service
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="service-card card-warm cursor-pointer transition-all duration-200 hover:border-warm-300 hover:shadow-warm-lg" data-task="ceiling_fan">
                <div class="service-header p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-lg">üí° Ceiling Fan Install/Replace</h3>
                            <p class="text-sm text-neutral-600">~2.0 hr base ‚Ä¢ Starting at $160</p>
                        </div>
                        <div class="expand-icon text-neutral-400 transform transition-transform duration-200">‚ñº</div>
                    </div>
                </div>
                <div class="service-details hidden border-t border-warm-200">
                    <div class="p-6">
                        <div class="grid md:grid-cols-2 gap-8">
                            <div>
                                <h4 class="font-semibold text-warm-600 mb-2">‚úÖ Included:</h4>
                                <ul class="text-sm space-y-1 text-neutral-700">
                                    <li>‚Ä¢ Replacing existing fan or light fixture</li>
                                    <li>‚Ä¢ Using existing wiring and fan-rated box</li>
                                    <li>‚Ä¢ Assembling blades/light kit</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-warm-700 mb-2">‚ö†Ô∏è Potential Add-ons:</h4>
                                <ul class="text-sm space-y-1 text-neutral-700">
                                    <li>‚Ä¢ +$50: No fan-rated box (requires replacement)</li>
                                    <li>‚Ä¢ +$40: Ceilings higher than 10 ft</li>
                                    <li>‚Ä¢ New wiring or switches not included</li>
                                </ul>
                            </div>
                        </div>
                        <div class="mt-6">
                            <button class="select-service-btn btn-warm-primary w-full py-3 px-4 font-semibold transition-all duration-200" data-task="ceiling_fan">
                                Select Ceiling Fan Service
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="service-card card-warm cursor-pointer transition-all duration-200 hover:border-warm-300 hover:shadow-warm-lg" data-task="light_fixture">
                <div class="service-header p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-lg">‚ú® Light Fixture / Chandelier Swap</h3>
                            <p class="text-sm text-neutral-600">~1.5 hr base ‚Ä¢ Starting at $120</p>
                        </div>
                        <div class="expand-icon text-neutral-400 transform transition-transform duration-200">‚ñº</div>
                    </div>
                </div>
                <div class="service-details hidden border-t border-warm-200">
                    <div class="p-6">
                        <div class="grid md:grid-cols-2 gap-8">
                            <div>
                                <h4 class="font-semibold text-warm-600 mb-2">‚úÖ Included:</h4>
                                <ul class="text-sm space-y-1 text-neutral-700">
                                    <li>‚Ä¢ Remove old fixture, install new</li>
                                    <li>‚Ä¢ Connect to existing wiring</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-warm-700 mb-2">‚ö†Ô∏è Potential Add-ons:</h4>
                                <ul class="text-sm space-y-1 text-neutral-700">
                                    <li>‚Ä¢ +$200: Chandeliers over 25 lbs</li>
                                    <li>‚Ä¢ +$30: Ceiling over 10 ft</li>
                                    <li>‚Ä¢ Structural bracing or rewiring not included</li>
                                </ul>
                            </div>
                        </div>
                        <div class="mt-6">
                            <button class="select-service-btn btn-warm-primary w-full py-3 px-4 font-semibold transition-all duration-200" data-task="light_fixture">
                                Select Light Fixture Service
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="service-card card-warm cursor-pointer transition-all duration-200 hover:border-warm-300 hover:shadow-warm-lg" data-task="faucet_showerhead">
                <div class="service-header p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-lg">üö∞ Faucet / Showerhead Replace</h3>
                            <p class="text-sm text-neutral-600">~1.5 hr base ‚Ä¢ Starting at $120</p>
                        </div>
                        <div class="expand-icon text-neutral-400 transform transition-transform duration-200">‚ñº</div>
                    </div>
                </div>
                <div class="service-details hidden border-t border-warm-200">
                    <div class="p-6">
                        <div class="grid md:grid-cols-2 gap-8">
                            <div>
                                <h4 class="font-semibold text-warm-600 mb-2">‚úÖ Included:</h4>
                                <ul class="text-sm space-y-1 text-neutral-700">
                                    <li>‚Ä¢ Remove old fixture and install new</li>
                                    <li>‚Ä¢ Connect to existing plumbing</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-warm-700 mb-2">‚ö†Ô∏è Potential Add-ons:</h4>
                                <ul class="text-sm space-y-1 text-neutral-700">
                                    <li>‚Ä¢ +$40: Corroded plumbing requiring extra work</li>
                                    <li>‚Ä¢ +$30: Removing sink/vanity for access</li>
                                    <li>‚Ä¢ Leak repairs not included</li>
                                </ul>
                            </div>
                        </div>
                        <div class="mt-6">
                            <button class="select-service-btn btn-warm-primary w-full py-3 px-4 font-semibold transition-all duration-200" data-task="faucet_showerhead">
                                Select Faucet/Showerhead Service
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="service-card card-warm cursor-pointer transition-all duration-200 hover:border-warm-300 hover:shadow-warm-lg" data-task="smart_doorbell">
                <div class="service-header p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-lg">üîî Smart Doorbell Install</h3>
                            <p class="text-sm text-neutral-600">~1.25 hr base ‚Ä¢ Starting at $100</p>
                        </div>
                        <div class="expand-icon text-neutral-400 transform transition-transform duration-200">‚ñº</div>
                    </div>
                </div>
                <div class="service-details hidden border-t border-warm-200">
                    <div class="p-6">
                        <div class="grid md:grid-cols-2 gap-8">
                            <div>
                                <h4 class="font-semibold text-warm-600 mb-2">‚úÖ Included:</h4>
                                <ul class="text-sm space-y-1 text-neutral-700">
                                    <li>‚Ä¢ Replace old doorbell or install wireless unit</li>
                                    <li>‚Ä¢ Connect to existing wiring or Wi-Fi</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-warm-700 mb-2">‚ö†Ô∏è Potential Add-ons:</h4>
                                <ul class="text-sm space-y-1 text-neutral-700">
                                    <li>‚Ä¢ +$30: No wiring, drilling required</li>
                                    <li>‚Ä¢ +$40: Chime module/transformer replacement</li>
                                    <li>‚Ä¢ Complex rewiring not included</li>
                                </ul>
                            </div>
                        </div>
                        <div class="mt-6">
                            <button class="select-service-btn btn-warm-primary w-full py-3 px-4 font-semibold transition-all duration-200" data-task="smart_doorbell">
                                Select Smart Doorbell Service
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="service-card card-warm cursor-pointer transition-all duration-200 hover:border-warm-300 hover:shadow-warm-lg" data-task="curtains_blinds">
                <div class="service-header p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-lg">ü™ü Curtain Rods / Blinds</h3>
                            <p class="text-sm text-neutral-600">Per item pricing ‚Ä¢ Starting at $80</p>
                        </div>
                        <div class="expand-icon text-neutral-400 transform transition-transform duration-200">‚ñº</div>
                    </div>
                </div>
                <div class="service-details hidden border-t border-warm-200">
                    <div class="p-6">
                        <div class="grid md:grid-cols-2 gap-8">
                            <div>
                                <h4 class="font-semibold text-warm-600 mb-2">‚úÖ Included:</h4>
                                <ul class="text-sm space-y-1 text-neutral-700">
                                    <li>‚Ä¢ Per-item pricing: $80 for 1st, +$40 each additional</li>
                                    <li>‚Ä¢ Professional mounting with proper hardware</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-warm-700 mb-2">‚ö†Ô∏è Potential Add-ons:</h4>
                                <ul class="text-sm space-y-1 text-neutral-700">
                                    <li>‚Ä¢ +$20: Each extra rod/blind beyond 2</li>
                                    <li>‚Ä¢ +$40: Mounting on brick, tile, or concrete</li>
                                    <li>‚Ä¢ Custom carpentry not included</li>
                                </ul>
                            </div>
                        </div>
                        <div class="mt-6">
                            <button class="select-service-btn btn-warm-primary w-full py-3 px-4 font-semibold transition-all duration-200" data-task="curtains_blinds">
                                Select Curtains/Blinds Service
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="service-card card-warm cursor-pointer transition-all duration-200 hover:border-warm-300 hover:shadow-warm-lg" data-task="floating_shelf">
                <div class="service-header p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-lg">üìö Floating Shelf Install</h3>
                            <p class="text-sm text-neutral-600">Per item pricing ‚Ä¢ Starting at $80</p>
                        </div>
                        <div class="expand-icon text-neutral-400 transform transition-transform duration-200">‚ñº</div>
                    </div>
                </div>
                <div class="service-details hidden border-t border-warm-200">
                    <div class="p-6">
                        <div class="grid md:grid-cols-2 gap-8">
                            <div>
                                <h4 class="font-semibold text-warm-600 mb-2">‚úÖ Included:</h4>
                                <ul class="text-sm space-y-1 text-neutral-700">
                                    <li>‚Ä¢ Per-item pricing: $80 for 1st, +$40 each additional</li>
                                    <li>‚Ä¢ Professional mounting with proper hardware</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-warm-700 mb-2">‚ö†Ô∏è Potential Add-ons:</h4>
                                <ul class="text-sm space-y-1 text-neutral-700">
                                    <li>‚Ä¢ Quantity: 1 shelf $80, 2 shelves $120, 3+ shelves $40 each</li>
                                    <li>‚Ä¢ +$30: Heavy-duty mounting for shelves over 25 lbs</li>
                                    <li>‚Ä¢ Masonry/tile installs not included</li>
                                </ul>
                            </div>
                        </div>
                        <div class="mt-6">
                            <button class="select-service-btn btn-warm-primary w-full py-3 px-4 font-semibold transition-all duration-200" data-task="floating_shelf">
                                Select Floating Shelf Service
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="service-card card-warm cursor-pointer transition-all duration-200 hover:border-warm-300 hover:shadow-warm-lg" data-task="appliance_hookup">
                <div class="service-header p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-lg">‚ö° Appliance Hookup (W/D/DW)</h3>
                            <p class="text-sm text-neutral-600">~2.0 hr base ‚Ä¢ Starting at $160</p>
                        </div>
                        <div class="expand-icon text-neutral-400 transform transition-transform duration-200">‚ñº</div>
                    </div>
                </div>
                <div class="service-details hidden border-t border-warm-200">
                    <div class="p-6">
                        <div class="grid md:grid-cols-2 gap-8">
                            <div>
                                <h4 class="font-semibold text-warm-600 mb-2">‚úÖ Included:</h4>
                                <ul class="text-sm space-y-1 text-neutral-700">
                                    <li>‚Ä¢ Connect new appliance to existing hookups</li>
                                    <li>‚Ä¢ Level and test basic function</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-warm-700 mb-2">‚ö†Ô∏è Potential Add-ons:</h4>
                                <ul class="text-sm space-y-1 text-neutral-700">
                                    <li>‚Ä¢ +$40: Old appliance removal/disposal</li>
                                    <li>‚Ä¢ +$30: New vent or supply line required</li>
                                    <li>‚Ä¢ Plumbing/electrical modifications not included</li>
                                </ul>
                            </div>
                        </div>
                        <div class="mt-6">
                            <button class="select-service-btn btn-warm-primary w-full py-3 px-4 font-semibold transition-all duration-200" data-task="appliance_hookup">
                                Select Appliance Hookup Service
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="service-card card-warm cursor-pointer transition-all duration-200 hover:border-warm-300 hover:shadow-warm-lg" data-task="furniture_assembly">
                <div class="service-header p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-lg">ü™ë Furniture Assembly (S‚ÄìM)</h3>
                            <p class="text-sm text-neutral-600">~2.0 hr base ‚Ä¢ Starting at $160</p>
                        </div>
                        <div class="expand-icon text-neutral-400 transform transition-transform duration-200">‚ñº</div>
                    </div>
                </div>
                <div class="service-details hidden border-t border-warm-200">
                    <div class="p-6">
                        <div class="grid md:grid-cols-2 gap-8">
                            <div>
                                <h4 class="font-semibold text-warm-600 mb-2">‚úÖ Included:</h4>
                                <ul class="text-sm space-y-1 text-neutral-700">
                                    <li>‚Ä¢ Assembly of 1 major item or 2‚Äì3 small items</li>
                                    <li>‚Ä¢ Standard flat-pack furniture</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-warm-700 mb-2">‚ö†Ô∏è Potential Add-ons:</h4>
                                <ul class="text-sm space-y-1 text-neutral-700">
                                    <li>‚Ä¢ +$30: Large/complex pieces (beds, wardrobes, sectionals)</li>
                                    <li>‚Ä¢ +$20 per extra small item</li>
                                    <li>‚Ä¢ Wall anchoring not included unless specified</li>
                                </ul>
                            </div>
                        </div>
                        <div class="mt-6">
                            <button class="select-service-btn btn-warm-primary w-full py-3 px-4 font-semibold transition-all duration-200" data-task="furniture_assembly">
                                Select Furniture Assembly Service
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="service-card card-warm cursor-pointer transition-all duration-200 hover:border-warm-300 hover:shadow-warm-lg" data-task="closet_organizer">
                <div class="service-header p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-lg">üëï Closet Organizer Install</h3>
                            <p class="text-sm text-neutral-600">~2.5 hr base ‚Ä¢ Starting at $200</p>
                        </div>
                        <div class="expand-icon text-neutral-400 transform transition-transform duration-200">‚ñº</div>
                    </div>
                </div>
                <div class="service-details hidden border-t border-warm-200">
                    <div class="p-6">
                        <div class="grid md:grid-cols-2 gap-8">
                            <div>
                                <h4 class="font-semibold text-warm-600 mb-2">‚úÖ Included:</h4>
                                <ul class="text-sm space-y-1 text-neutral-700">
                                    <li>‚Ä¢ Install standard closet kit (customer-supplied)</li>
                                    <li>‚Ä¢ Mount to drywall with included hardware</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-warm-700 mb-2">‚ö†Ô∏è Potential Add-ons:</h4>
                                <ul class="text-sm space-y-1 text-neutral-700">
                                    <li>‚Ä¢ +$50: Cutting/custom fitting required</li>
                                    <li>‚Ä¢ +$40: Masonry or non-standard walls</li>
                                    <li>‚Ä¢ Electrical/lighting not included</li>
                                </ul>
                            </div>
                        </div>
                        <div class="mt-6">
                            <button class="select-service-btn btn-warm-primary w-full py-3 px-4 font-semibold transition-all duration-200" data-task="closet_organizer">
                                Select Closet Organizer Service
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Premium Move-Out Removal Service -->
            <div class="service-card card-warm cursor-pointer transition-all duration-200 hover:border-warm-300 hover:shadow-warm-lg" data-task="premium_moveout">
                <div class="service-header p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-lg">üè† Premium Move-Out Removal (Includes Patching & Cleanup)</h3>
                            <p class="text-sm text-neutral-600">~3.0 hr base ‚Ä¢ Starting at $300</p>
                        </div>
                        <div class="expand-icon text-neutral-400 transform transition-transform duration-200">‚ñº</div>
                    </div>
                </div>
                <div class="service-details hidden border-t border-warm-200">
                    <div class="p-4 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-semibold text-slate-800 mb-2">‚úÖ What's Included:</h4>
                                <ul class="text-sm text-slate-600 space-y-1">
                                    <li>‚Ä¢ Wall hole patching & repair</li>
                                    <li>‚Ä¢ Paint touch-ups & spot painting</li>
                                    <li>‚Ä¢ Fixture removal & restoration</li>
                                    <li>‚Ä¢ Deep cleaning & sanitization</li>
                                    <li>‚Ä¢ Deposit recovery optimization</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-slate-800 mb-2">‚è±Ô∏è Time Estimate:</h4>
                                <ul class="text-sm text-slate-600 space-y-1">
                                    <li>‚Ä¢ Studio/1BR: 3-4 hours</li>
                                    <li>‚Ä¢ 2BR: 4-5 hours</li>
                                    <li>‚Ä¢ 3BR+: 5-7 hours</li>
                                    <li>‚Ä¢ Additional rooms: +1-2 hrs each</li>
                                </ul>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <h4 class="font-semibold text-slate-800">üîß Add-On Services:</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                                <div class="flex justify-between items-center p-2 bg-slate-50 rounded">
                                    <span>Full room repainting (per room)</span>
                                    <span class="font-semibold text-green-600">+$75</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-slate-50 rounded">
                                    <span>Carpet cleaning and deodorizing</span>
                                    <span class="font-semibold text-green-600">+$50</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-slate-50 rounded">
                                    <span>Kitchen appliance deep clean</span>
                                    <span class="font-semibold text-green-600">+$40</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-slate-50 rounded">
                                    <span>Bathroom tile & grout restoration</span>
                                    <span class="font-semibold text-green-600">+$35</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-slate-50 rounded">
                                    <span>Hardwood floor refinishing (per room)</span>
                                    <span class="font-semibold text-green-600">+$60</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-slate-50 rounded">
                                    <span>Window cleaning (interior/exterior)</span>
                                    <span class="font-semibold text-green-600">+$25</span>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 p-3 bg-warm-50 border border-warm-200 rounded-warm">
                            <p class="text-sm text-green-700"><strong>Perfect for:</strong> Landlords preparing units for new tenants, renters maximizing security deposit returns, property managers handling turnovers, and anyone needing comprehensive move-out restoration.</p>
                        </div>
                        <div class="mt-6">
                            <button class="select-service-btn btn-warm-primary w-full py-3 px-4 font-semibold transition-all duration-200" data-task="premium_moveout">
                                Select Premium Move-Out Service
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="service-card card-warm cursor-pointer transition-all duration-200 hover:border-warm-300 hover:shadow-warm-lg" data-task="general_handyman">
                <div class="service-header p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-lg">üîß General Handyman (3+ hours)</h3>
                            <p class="text-sm text-neutral-600">~3 hr minimum ‚Ä¢ Starting at $240</p>
                        </div>
                        <div class="expand-icon text-neutral-400 transform transition-transform duration-200">‚ñº</div>
                    </div>
                </div>
                <div class="service-details hidden border-t border-warm-200">
                    <div class="p-6">
                        <div class="grid md:grid-cols-2 gap-8">
                            <div>
                                <h4 class="font-semibold text-warm-600 mb-2">‚úÖ Included:</h4>
                                <ul class="text-sm space-y-1 text-neutral-700">
                                    <li>‚Ä¢ 3-hour minimum for general repairs & tasks</li>
                                    <li>‚Ä¢ Basic tools and hardware</li>
                                    <li>‚Ä¢ Multiple small tasks or one larger project</li>
                                    <li>‚Ä¢ Troubleshooting and problem-solving</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-orange-600 mb-2">‚ö†Ô∏è Add-on Options:</h4>
                                <ul class="text-sm space-y-1 text-slate-700">
                                    <li>‚Ä¢ +$180: Additional 3-hour block (discounted rate)</li>
                                    <li>‚Ä¢ +$360: Two additional 3-hour blocks (6 hours total)</li>
                                    <li>‚Ä¢ Materials and parts charged separately</li>
                                    <li>‚Ä¢ Specialized trades (plumbing/electrical) not included</li>
                                </ul>
                            </div>
                        </div>
                        <div class="mt-4 p-3 bg-warm-50 border border-warm-200 rounded-warm">
                            <p class="text-sm text-amber-700"><strong>Perfect for:</strong> Touch-up painting, caulking, door adjustments, squeaky hinges, loose handles, weatherstripping, minor drywall repairs, picture hanging, shelf brackets, cabinet adjustments, and other miscellaneous tasks.</p>
                        </div>
                        <div class="mt-6">
                            <button class="select-service-btn btn-warm-primary w-full py-3 px-4 font-semibold transition-all duration-200" data-task="general_handyman">
                                Select General Handyman Service
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-8 bg-slate-50 border border-slate-200 rounded-xl p-6">
            <h3 class="font-semibold text-lg mb-3">üîë Standard Policy for All Tasks</h3>
            <div class="grid md:grid-cols-2 gap-4 text-sm text-slate-700">
                <ul class="space-y-2">
                    <li>‚Ä¢ Flat-rate pricing covers base scope</li>
                    <li>‚Ä¢ Add-ons are always quoted and approved before work begins</li>
                </ul>
                <ul class="space-y-2">
                    <li>‚Ä¢ Cancel anytime before work starts ‚Äî no charge</li>
                    <li>‚Ä¢ Customer must supply fixtures, furniture, appliances, and hardware</li>
                </ul>
            </div>
        </div>
    </div>
</section>

<section id="how" class="py-12">
    <div class="max-w-6xl mx-auto px-4">
        <h2 class="text-2xl md:text-3xl font-bold">How it works</h2>
        <div class="mt-6 grid md:grid-cols-4 gap-6">
            <div class="bg-white rounded-xl p-5 shadow-soft border border-slate-100"><div class="font-semibold">1) Tell us what you need</div><p class="text-sm text-slate-600 mt-1">Pick a task, add notes, and upload 2‚Äì5 photos.</p></div>
            <div class="bg-white rounded-xl p-5 shadow-soft border border-slate-100"><div class="font-semibold">2) Instant AI estimate</div><p class="text-sm text-slate-600 mt-1">We analyze your photos to estimate time, parts, and price.</p></div>
            <div class="bg-white rounded-xl p-5 shadow-soft border border-slate-100"><div class="font-semibold">3) Reserve with card</div><p class="text-sm text-slate-600 mt-1">Same-day & evening premiums shown upfront.</p></div>
            <div class="bg-white rounded-xl p-5 shadow-soft border border-slate-100"><div class="font-semibold">4) We dispatch a pro</div><p class="text-sm text-slate-600 mt-1">Nearest qualified tech with AI job sheet.</p></div>
        </div>

        <div class="mt-8 bg-white rounded-xl p-6 shadow-soft border border-slate-100">
            <h3 class="font-semibold text-lg mb-4">Why Choose SendAHandyman?</h3>
            <ul class="grid md:grid-cols-3 gap-3 text-slate-700">
                <li class="flex items-center gap-2">
                    <span class="text-green-600">‚úÖ</span>
                    <span>Vetted & background-checked pros</span>
                </li>
                <li class="flex items-center gap-2">
                    <span class="text-green-600">‚úÖ</span>
                    <span>Fixed pricing + transparent same-day premium</span>
                </li>
                <li class="flex items-center gap-2">
                    <span class="text-green-600">‚úÖ</span>
                    <span>Same-day / next-day time windows</span>
                </li>
            </ul>
        </div>
    </div>
</section>

<section id="book" class="py-12">
    <div class="max-w-6xl mx-auto px-4 grid md:grid-cols-2 gap-10 items-start">
        <div class="bg-white rounded-2xl p-4 md:p-6 shadow-soft border border-slate-100">
            <!-- Step 1: Task Selection -->
            <div id="step-task-selection" class="booking-step">
                <h3 class="text-xl md:text-2xl font-bold">Select Your Service</h3>
                <p class="text-sm text-slate-600 mt-1">Choose a service from above or browse all options below.</p>
                <div class="mt-6">
                    <label class="text-sm font-semibold">Selected Service</label>
                    <div id="selectedTaskDisplay" class="mt-2 p-4 bg-warm-50 border border-warm-200 rounded-warm hidden">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <div id="selectedTaskName" class="font-semibold text-indigo-900"></div>
                                <div id="selectedTaskPrice" class="text-sm text-indigo-700"></div>
                            </div>
                            <button id="changeTaskBtn" class="text-indigo-600 text-sm hover:text-indigo-800">Change</button>
                        </div>

                        <!-- Task Details -->
                        <div id="selectedTaskDetails" class="grid md:grid-cols-2 gap-4 pt-4 border-t border-indigo-200">
                            <div>
                                <h4 class="font-semibold text-green-600 mb-2 text-sm">‚úÖ What's Included:</h4>
                                <ul id="selectedTaskIncluded" class="text-xs space-y-1 text-slate-700"></ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-orange-600 mb-2 text-sm">‚ö†Ô∏è Potential Add-ons:</h4>
                                <ul id="selectedTaskAddons" class="text-xs space-y-1 text-slate-700"></ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-6">
                    <label class="text-sm font-semibold">Or select from all services</label>
                    <select id="taskCategory" class="mt-1 w-full rounded-warm border border-warm-200 px-3 py-2 text-base focus:ring-2 focus:ring-warm-500">
                        <option value="">Browse all services‚Ä¶</option>
                        <option value="tv_mount">TV mounting</option>
                        <option value="ceiling_fan">Ceiling fan install</option>
                        <option value="light_fixture">Light fixture / chandelier swap</option>
                        <option value="faucet_showerhead">Faucet / showerhead replace</option>
                        <option value="smart_doorbell">Smart doorbell install</option>
                        <option value="curtains_blinds">Curtain rods / blinds</option>
                        <option value="floating_shelf">Floating shelf install</option>
                        <option value="appliance_hookup">Appliance hookup (W/D/DW)</option>
                        <option value="furniture_assembly">Furniture assembly (small‚Äìmedium)</option>
                        <option value="closet_organizer">Closet organizer install</option>
                        <option value="premium_moveout">Premium move-out removal (includes patching & cleanup)</option>
                        <option value="general_handyman">General handyman (3+ hours)</option>
                    </select>
                </div>
                <div class="mt-6">
                    <button id="continueToTimingBtn" class="btn-warm-primary w-full py-3 px-4 font-semibold disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200" disabled>
                        Continue to Timing
                    </button>
                </div>
            </div>

            <!-- Step 2: Timing Selection -->
            <div id="step-timing" class="booking-step hidden">
                <h3 class="text-xl md:text-2xl font-bold">Choose Your Timing</h3>
                <p class="text-sm text-slate-600 mt-1">Select when you'd like the work done.</p>

                <div class="mt-6">
                    <label class="text-sm font-semibold">Preferred timing</label>
                    <select id="taskWindow" required class="mt-2 w-full rounded-warm border border-warm-200 px-3 py-2 text-base focus:ring-2 focus:ring-warm-500">
                        <option value="flexible">I'm flexible (best value)</option>
                    </select>
                </div>

                <div class="mt-4">
                    <label class="text-sm font-semibold">Or select a future date (up to 2 weeks) - 10% discount!</label>
                    <input type="date" id="futureDate" class="mt-2 w-full rounded-warm border border-warm-200 px-3 py-2 text-base focus:ring-2 focus:ring-warm-500" />
                    <div class="mt-3 p-3 bg-warm-50 border border-warm-200 rounded-warm text-sm text-warm-800">
                        <div class="font-semibold mb-2">üìÖ Booking Rules:</div>
                        <div class="space-y-1">
                            <div>‚úÖ <strong>Mon-Fri:</strong> All slots + 10% discount</div>
                            <div>‚ö†Ô∏è <strong>Saturday:</strong> 8AM-12PM only + 30% premium</div>
                            <div>üö´ <strong>Sunday:</strong> Not available</div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex gap-3">
                    <button id="backToTaskBtn" class="btn-warm-secondary flex-1 py-3 px-4 font-semibold transition-all duration-200">
                        ‚Üê Back
                    </button>
                    <button id="continueToQuestionsBtn" class="btn-warm-primary flex-1 py-3 px-4 font-semibold transition-all duration-200">
                        Continue
                    </button>
                </div>
            </div>

            <!-- Step 3: Task Questions -->
            <div id="step-questions" class="booking-step hidden">
                <h3 class="text-xl md:text-2xl font-bold">Task Details</h3>
                <p class="text-sm text-slate-600 mt-1">Help us understand your specific needs.</p>

                <div id="taskQuestions" class="mt-6">
                    <div class="p-4 bg-warm-50 border border-warm-200 rounded-warm">
                        <h4 class="font-semibold text-blue-800 mb-3">üìã Quick questions about your task</h4>
                        <div id="questionsContainer" class="space-y-4"></div>
                    </div>
                </div>

                <div class="mt-6">
                    <label class="text-sm font-semibold">Describe your job <span class="text-red-600">*</span></label>
                    <textarea id="taskDescription" rows="4" placeholder="Product link/model, wall/ceiling type, special requirements, access details..." class="mt-2 w-full rounded-warm border border-warm-200 px-3 py-2 text-base focus:ring-2 focus:ring-warm-500" required></textarea>
                    <p class="text-xs text-slate-600 mt-1">Required - Helps handyman bring the right tools and materials</p>
                </div>

                <div class="mt-6">
                    <label class="text-sm font-semibold">Upload photos (2‚Äì5 recommended)</label>
                    <input id="taskPhotos" type="file" accept="image/*" multiple class="mt-2 w-full rounded-warm border border-warm-200 px-3 py-2 text-base focus:ring-2 focus:ring-warm-500" />
                    <div id="photoThumbs" class="mt-3 flex flex-wrap gap-2"></div>
                    <p class="text-xs text-slate-500 mt-2">Photos help us provide accurate pricing and prepare your handyman</p>
                </div>

                <div class="mt-6 flex gap-3">
                    <button id="backToTimingBtn" class="btn-warm-secondary flex-1 py-3 px-4 font-semibold transition-all duration-200">
                        ‚Üê Back
                    </button>
                    <button id="getEstimateBtn" class="btn-warm-primary flex-1 relative overflow-hidden px-4 py-3 font-semibold transition-all duration-200 disabled:opacity-75">
                        <div id="progressBg" class="absolute inset-0 bg-gradient-to-r from-indigo-600 to-purple-600 transform -translate-x-full transition-transform duration-3000 ease-out"></div>
                        <span id="estimateText" class="relative z-10">üîß Get Pricing</span>
                    </button>
                </div>

                <div id="progressContainer" class="mt-4 hidden">
                    <div class="w-full bg-slate-200 rounded-full h-2">
                        <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-indigo-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <div id="progressMessage" class="text-sm text-slate-600 mt-2 text-center">Starting analysis...</div>
                </div>
            </div>
        </div>
        <aside id="estimatePanel" class="bg-white rounded-2xl p-4 md:p-6 shadow-soft border border-slate-100 hidden">
            <!-- Step 4: Price Selection -->
            <div id="step-pricing" class="pricing-step">
                <h3 class="text-xl md:text-2xl font-bold">Choose Your Price</h3>
                <p class="text-sm text-slate-600 mb-4">Select your preferred option. All prices include everything.</p>

                <div id="flexibleNotice" class="hidden mb-4 p-3 bg-warm-50 border border-warm-200 rounded-warm">
                    <p class="text-sm text-green-700">
                        üí° <strong>Great choice!</strong> You selected "I'm flexible" so we've found the best value timing.
                    </p>
                </div>
                <div id="futureDateNotice" class="hidden mb-4 p-3 bg-warm-50 border border-warm-200 rounded-warm">
                    <p class="text-sm text-blue-700">
                        üìÖ <strong>Future booking!</strong> Options for your selected date and nearby days.
                    </p>
                </div>

                <div id="pricingOptions" class="space-y-3 mb-6"></div>

                <div class="mt-4">
                    <h4 class="font-semibold text-sm md:text-base">What we'll do</h4>
                    <ul id="estimateScope" class="list-disc pl-5 text-sm text-slate-700 space-y-1 mt-2"></ul>
                </div>
                <div class="mt-4">
                    <h4 class="font-semibold text-sm md:text-base">Things to note</h4>
                    <ul id="estimateRisks" class="list-disc pl-5 text-sm text-slate-700 space-y-1 mt-2"></ul>
                </div>

                <div class="mt-6">
                    <button id="continueToInfoBtn" class="btn-warm-primary w-full px-4 py-3 font-semibold disabled:opacity-50 transition-all duration-200" disabled>
                        Continue to Details
                    </button>
                </div>
            </div>

            <!-- Step 5: Personal Information -->
            <div id="step-personal-info" class="pricing-step hidden">
                <h3 class="text-xl md:text-2xl font-bold">Your Information</h3>
                <p class="text-sm text-slate-600 mb-4">We need a few details to complete your booking.</p>

                <!-- Additional Costs Notice -->
                <div class="mb-6 p-4 bg-warm-50 border border-warm-200 rounded-warm">
                    <div class="flex items-start gap-3">
                        <div class="text-amber-600 text-lg">‚ö†Ô∏è</div>
                        <div>
                            <h4 class="font-semibold text-amber-800 mb-1">Additional Costs May Apply</h4>
                            <p class="text-sm text-amber-700">
                                If your handyman needs to purchase additional materials after arriving at your location,
                                you will be charged <strong>$80 travel fee + cost of materials</strong> via the same payment method used for booking.
                            </p>
                            <p class="text-xs text-amber-600 mt-2">
                                Your handyman will get your approval before purchasing any additional materials.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm font-semibold">Full name *</label>
                            <input id="customerName" required class="mt-1 w-full rounded-warm border border-warm-200 px-3 py-2.5 text-base focus:ring-2 focus:ring-warm-500" />
                        </div>
                        <div>
                            <label class="text-sm font-semibold">Mobile phone *</label>
                            <input id="customerPhone" required class="mt-1 w-full rounded-warm border border-warm-200 px-3 py-2.5 text-base focus:ring-2 focus:ring-warm-500" placeholder="(555) 123-4567" />
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm font-semibold">Email *</label>
                            <input type="email" id="customerEmail" required class="mt-1 w-full rounded-warm border border-warm-200 px-3 py-2.5 text-base focus:ring-2 focus:ring-warm-500" />
                        </div>
                        <div>
                            <label class="text-sm font-semibold">ZIP code *</label>
                            <input id="customerZip" required class="mt-1 w-full rounded-warm border border-warm-200 px-3 py-2.5 text-base focus:ring-2 focus:ring-warm-500" placeholder="33467" />
                        </div>
                    </div>

                    <div>
                        <label class="text-sm font-semibold">Service address</label>
                        <input id="customerAddress" class="mt-1 w-full rounded-warm border border-warm-200 px-3 py-2.5 text-base focus:ring-2 focus:ring-warm-500" placeholder="123 Main St, City, FL 33467" />
                        <p class="text-xs text-slate-500 mt-1">Where should the handyman go? (Optional if same as billing)</p>
                    </div>
                </div>

                <div class="mt-6 flex gap-3">
                    <button id="backToPricingBtn" class="btn-warm-secondary flex-1 py-3 px-4 font-semibold transition-all duration-200">
                        ‚Üê Back
                    </button>
                    <button id="reserveBtn" class="btn-warm-primary flex-1 px-4 py-3 font-semibold disabled:opacity-50 transition-all duration-200" disabled>
                        üí≥ Secure Payment
                    </button>
                </div>
            </div>
            <p class="mt-3 text-xs text-slate-500">If site conditions differ, your tech will confirm any changes before work begins.</p>
        </aside>
    </div>
</section>

<div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl p-6 max-w-md w-full shadow-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold">Complete Payment</h3>
            <button id="closePayment" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
        </div>
        <div class="mb-4 p-3 bg-warm-50 rounded-warm">
            <div class="text-sm text-slate-600">Total amount</div>
            <div id="paymentAmount" class="text-2xl font-bold">$0</div>
            <div class="text-sm text-slate-600 mt-1">
                <span id="paymentTiming">Selected timing</span>
            </div>
        </div>
        <form id="paymentForm">
            <div id="stripe-payment-element" class="mb-4"></div>
            <button id="submitPayment" type="submit" class="w-full rounded-xl bg-indigo-600 text-white px-5 py-3 font-semibold disabled:opacity-50 transition-all">
                <span id="paymentButtonText">Complete Payment</span>
            </button>
            <div id="paymentMessage" class="mt-4 text-sm hidden"></div>
        </form>
    </div>
</div>

<div id="taskInfoModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl p-6 max-w-lg w-full shadow-2xl max-h-[90vh] overflow-y-auto">
        <div class="text-center mb-6">
            <div class="text-6xl mb-2">‚úÖ</div>
            <h3 class="text-xl font-bold mb-2 text-blue-600">Payment Authorized!</h3>
            <div class="bg-warm-50 border border-warm-200 rounded-warm p-3 mb-4">
                <p class="text-sm text-blue-700">
                    <strong>‚úÖ Payment method authorized</strong> - Funds are held on your card but you will only be charged after your handyman completes the work.
                    Please provide additional details below to dispatch your handyman.
                </p>
            </div>
        </div>
        <form id="taskInfoForm">
            <div class="bg-warm-50 rounded-warm p-4 mb-6">
                <h4 class="font-semibold mb-3">Job Summary (from your request)</h4>
                <div class="text-sm space-y-1">
                    <div><strong>Task ID:</strong> <span id="summaryTaskId" class="font-mono text-indigo-600">‚Äî</span></div>
                    <div><strong>Customer:</strong> <span id="summaryName">‚Äî</span></div>
                    <div><strong>Phone:</strong> <span id="summaryPhone">‚Äî</span></div>
                    <div><strong>Email:</strong> <span id="summaryEmail">‚Äî</span></div>
                    <div><strong>Task:</strong> <span id="summaryTask">‚Äî</span></div>
                    <div><strong>Window:</strong> <span id="summaryWindow">‚Äî</span></div>
                    <div><strong>Description:</strong> <span id="summaryDescription">‚Äî</span></div>
                    <div class="pt-2 mt-2 border-t border-slate-200">
                        <strong>Amount Authorized (Hold):</strong> <span id="summaryAmount" class="text-blue-600 font-bold text-lg">‚Äî</span>
                    </div>
                </div>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-sm font-semibold text-gray-700">Complete Property Address *</label>
                    <textarea id="propertyAddress" rows="3" placeholder="123 Main St, Unit 2B, Boca Raton, FL 33432" required class="mt-1 w-full rounded-warm border border-warm-200 px-3 py-2 focus:ring-2 focus:ring-warm-500"></textarea>
                    <p class="text-xs text-slate-500 mt-1">Include street number, name, city, and ZIP code</p>
                </div>
                <div>
                    <label class="text-sm font-semibold text-gray-700">Best Contact Phone *</label>
                    <input type="tel" id="contactPhone" required class="mt-1 w-full rounded-warm border border-warm-200 px-3 py-2 focus:ring-2 focus:ring-warm-500" />
                </div>
                <div>
                    <label class="text-sm font-semibold text-gray-700">Property Access Details</label>
                    <textarea id="accessDetails" rows="3" placeholder="Gate code: 1234, Park in visitor spots, Ring doorbell..." class="mt-1 w-full rounded-warm border border-warm-200 px-3 py-2 focus:ring-2 focus:ring-warm-500"></textarea>
                </div>
                <div>
                    <label class="text-sm font-semibold text-gray-700">Pets & Special Considerations</label>
                    <textarea id="petsAndSpecial" rows="2" placeholder="2 friendly dogs, alarm system code needed, delicate antiques nearby..." class="mt-1 w-full rounded-warm border border-warm-200 px-3 py-2 focus:ring-2 focus:ring-warm-500"></textarea>
                </div>
                <div>
                    <label class="text-sm font-semibold text-gray-700">Additional Task Details</label>
                    <textarea id="additionalDetails" rows="3" placeholder="TV model: Samsung 65", wall type: drywall, tools available on site..." class="mt-1 w-full rounded-warm border border-warm-200 px-3 py-2 focus:ring-2 focus:ring-warm-500"></textarea>
                </div>
            </div>
            <div class="mt-6">
                <button type="submit" class="btn-warm-primary w-full px-5 py-3 font-semibold transition-all duration-200">
                    üöÄ Dispatch Handyman
                </button>
            </div>
        </form>
    </div>
</div>

<div id="finalSuccessModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="card-warm p-6 max-w-md w-full shadow-warm-xl text-center">
        <div class="text-6xl mb-4">üöÄ</div>
        <h3 class="text-xl font-bold mb-2 text-warm-600">Handyman Dispatched!</h3>
        <div class="bg-warm-50 border border-warm-200 rounded-warm p-4 mb-4">
            <p class="text-sm text-warm-700 mb-2">
                <strong>‚úÖ Payment authorized (hold placed)</strong><br>
                <strong>‚úÖ Job details sent to our team</strong><br>
                <strong>‚úÖ Notification sent to handyman dispatch</strong>
            </p>
            <div class="mt-3 p-2 bg-neutral-50 rounded-warm border border-warm-200">
                <div class="text-xs text-neutral-500">Your Task ID</div>
                <div id="finalTaskId" class="font-mono text-sm font-semibold text-warm-600">‚Äî</div>
            </div>
            <div class="mt-3 p-2 bg-neutral-50 rounded-warm border border-warm-200">
                <div class="text-xs text-neutral-500">Amount Authorized (Hold)</div>
                <div id="finalPaidAmount" class="text-lg font-bold text-warm-600">‚Äî</div>
            </div>
            <p class="text-sm text-neutral-600 mt-2">
                You'll receive a text message with your technician's details and estimated arrival time within the next 15 minutes.
            </p>
        </div>
        <button id="closeFinalSuccess" class="btn-warm-primary px-5 py-3 font-semibold transition-all duration-200">Perfect!</button>
    </div>
</div>

<section id="coverage" class="py-16 md:py-20 bg-neutral-50 border-t border-b border-warm-200">
    <div class="max-w-6xl mx-auto px-6">
        <h2 class="text-3xl md:text-4xl font-bold mb-3">Coverage areas</h2>
        <p class="text-neutral-600 text-lg leading-relaxed mb-12">We provide professional handyman services in two major metropolitan areas</p>

        <!-- Coverage Area Tabs -->
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Tab Navigation -->
            <div class="lg:w-1/3">
                <div class="flex lg:flex-col bg-warm-100 rounded-warm p-1">
                    <button id="florida-tab" class="coverage-tab active flex-1 lg:flex-none py-3 px-4 rounded-warm font-semibold text-left transition-colors">
                        üå¥ South Florida
                    </button>
                    <button id="austin-tab" class="coverage-tab flex-1 lg:flex-none py-3 px-4 rounded-warm font-semibold text-left transition-colors">
                        ü§† Austin & Central Texas
                    </button>
                </div>

                <!-- Area Details -->
                <div id="florida-details" class="coverage-details mt-6">
                    <h3 class="text-lg font-bold text-neutral-800 mb-3">South Florida Metropolitan</h3>
                    <div class="space-y-2 text-sm text-neutral-600">
                        <div>‚Ä¢ Palm Beach County: West Palm Beach, Boca Raton, Delray Beach, Boynton Beach</div>
                        <div>‚Ä¢ Broward County: Fort Lauderdale, Hollywood, Plantation, Aventura</div>
                        <div>‚Ä¢ Miami-Dade County: Miami, Coral Gables, Kendall, Aventura</div>
                    </div>
                    <div class="mt-4 p-3 bg-warm-50 rounded-warm border border-warm-200">
                        <p class="text-sm text-warm-700">‚úÖ <strong>Fully operational</strong> - Same-day and next-day service available</p>
                    </div>
                </div>

                <div id="austin-details" class="coverage-details mt-6 hidden">
                    <h3 class="text-lg font-bold text-neutral-800 mb-3">Austin & Central Texas</h3>
                    <div class="space-y-2 text-sm text-neutral-600">
                        <div>‚Ä¢ Austin Metro: Austin, Round Rock, Cedar Park, Pflugerville</div>
                        <div>‚Ä¢ Travis County: Austin, Lakeway, Bee Cave, West Lake Hills</div>
                        <div>‚Ä¢ Williamson County: Round Rock, Georgetown, Leander</div>
                    </div>
                    <div class="mt-4 p-3 bg-warm-50 rounded-warm border border-warm-200">
                        <p class="text-sm text-warm-700">üöÄ <strong>Now serving Austin!</strong> - Book your handyman service today</p>
                    </div>
                </div>
            </div>

            <!-- Map Container -->
            <div class="lg:w-2/3">
                <div id="coverage-map" class="h-80 bg-warm-100 rounded-warm border border-warm-200 relative overflow-hidden">
                    <div class="absolute inset-0 flex items-center justify-center text-neutral-500">
                        <div class="text-center">
                            <div class="text-2xl mb-2">üó∫Ô∏è</div>
                            <p class="text-sm">Interactive map loading...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<section id="faq" class="py-16 md:py-20">
    <div class="max-w-6xl mx-auto px-6 grid md:grid-cols-2 gap-12">
        <div><h3 class="text-xl font-bold text-neutral-800">Is this a marketplace?</h3><p class="text-neutral-600 mt-1">We're a vetted dispatch service. We send a qualified pro and back the work with standardized checklists and guidance.</p></div>
        <div><h3 class="text-xl font-bold text-neutral-800">How do premiums work?</h3><p class="text-neutral-600 mt-1">Like airline pricing, same-day and evening windows include a clear premium. It's shown before you pay.</p></div>
        <div><h3 class="text-xl font-bold">Do you charge before the job?</h3><p class="text-slate-600 mt-1">We place an authorization to secure your time. You're only charged after the tech confirms scope on site.</p></div>
        <div><h3 class="text-xl font-bold">Are pros background-checked?</h3><p class="text-slate-600 mt-1">Yes. We verify ID, experience, and insurance where applicable.</p></div>
    </div>
</section>

<div id="chatbot-container" class="fixed bottom-4 right-4 z-50">
    <button id="chatbot-toggle" class="relative">
        <div class="chatbot-notification">!</div>
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
        </svg>
    </button>
    <div id="chatbot-window" class="hidden absolute bottom-16 right-0 card-warm shadow-warm-2xl border border-warm-200 flex flex-col">
        <div class="bg-indigo-600 text-white p-4 rounded-t-lg flex items-center justify-between">
            <div>
                <h3 class="font-semibold">SendAHandyman Help</h3>
                <p class="text-sm text-indigo-100">Ask me about our services!</p>
            </div>
            <button id="chatbot-close" class="text-indigo-100 hover:text-white">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div id="chatbot-messages" class="flex-1 p-4 overflow-y-auto space-y-3">
            <div class="flex items-start space-x-2">
                <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                </div>
                <div class="bg-warm-100 rounded-warm p-3 max-w-xs">
                    <p class="text-sm text-slate-700">Hi! I'm here to help with questions about our handyman services. What can I help you with today?</p>
                </div>
            </div>
        </div>
        <div class="border-t border-slate-200 p-4">
            <div class="flex space-x-2">
                <input type="text" id="chatbot-input" placeholder="Type your question..." class="flex-1 border border-warm-200 rounded-warm px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-warm-500" maxlength="500" />
                <button id="chatbot-send" class="btn-warm-primary px-4 py-2 text-sm font-semibold disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200">Send</button>
            </div>
        </div>
    </div>
</div>

<footer class="py-10 border-t border-slate-100 text-sm text-slate-600">
    <div class="max-w-6xl mx-auto px-4 flex flex-col md:flex-row items-center justify-between gap-3">
        <div class="flex items-center gap-2">
            <img src="/images/helpinghands_logo.png" alt="Helping Hands Logo" class="h-8 w-auto">
            <span>¬© <span id="year"></span> SendAHandyman v <span id="version"></span></span>
        </div>
        <div class="flex items-center gap-4">
            <a href="privacy.html" class="hover:text-slate-900">Privacy</a>
            <a href="terms.html" class="hover:text-slate-900">Terms</a>
            <a href="mailto:info@sendahandyman.com" class="hover:text-slate-900">Contact</a>
        </div>
    </div>
</footer>

<script>
    console.log('üìú JavaScript started loading...');
    const ZAPIER_CONFIG = {
        WEBHOOK_URL: 'https://hooks.zapier.com/hooks/catch/24412806/uh8lvew/',
        ENABLED: true
    };
    let formData = {};
    let estimateData = {};
    let selectedPricingOption = null;
    let paymentIntentId = null;
    let paymentElementReady = false;
    const APP_VERSION = "2.0.8";
    const STRIPE_PUBLISHABLE_KEY = 'pk_live_51Rz41zHQ4TkcNcqv0IXVWGjAjLo8EoSkGO2fbeINw6U23GsLSiaOsHYVSEPwlJbR2EZ515tqPDJcRPvDBYSdv2Wy00N7DPqhI3';
    let stripe, elements, paymentElement;
    const RATE = 80;
    const PREMIUM_CURRENT_BLOCK = 0.30;
    const PREMIUM_NEXT_BLOCK = 0.20;
    const PREMIUM_EVENING_BLOCK = 0.35;
    const PREMIUM_SATURDAY = 0.30;
    const DISCOUNT_FUTURE = 0.10;
    const TIME_WINDOWS = {
        today_am: { label: "Today (8AM-12PM)", start: 8, end: 12 },
        today_pm: { label: "Today (12PM-4PM)", start: 12, end: 16 },
        today_eve: { label: "Today (4PM-8PM)", start: 16, end: 20 },
        tomorrow_am: { label: "Tomorrow (8AM-12PM)", start: 8, end: 12 },
        tomorrow_pm: { label: "Tomorrow (12PM-4PM)", start: 12, end: 16 },
        tomorrow_eve: { label: "Tomorrow (4PM-8PM)", start: 16, end: 20 },
        monday_am: { label: "Monday (8AM-12PM)", start: 8, end: 12 },
        monday_pm: { label: "Monday (12PM-4PM)", start: 12, end: 16 },
        monday_eve: { label: "Monday (4PM-8PM)", start: 16, end: 20 }
    };

    function isSunday(date) {
        return date.getDay() === 0;
    }

    function isSaturday(date) {
        return date.getDay() === 6;
    }

    function getNextAvailableDay(date) {
        const nextDay = new Date(date);
        nextDay.setDate(nextDay.getDate() + 1);
        if (isSunday(nextDay)) {
            nextDay.setDate(nextDay.getDate() + 1);
        }
        return nextDay;
    }

    function getCurrentBlock() {
        const now = new Date();
        const hour = now.getHours();
        if (hour >= 8 && hour < 12) return 'today_am';
        if (hour >= 12 && hour < 16) return 'today_pm';
        if (hour >= 16 && hour < 20) return 'today_eve';
        return null;
    }

    function isBlockInPast(blockKey) {
        const now = new Date();
        const hour = now.getHours();
        if (blockKey === 'today_am' && hour >= 12) return true;
        if (blockKey === 'today_pm' && hour >= 16) return true;
        if (blockKey === 'today_eve' && hour >= 20) return true;
        return false;
    }

    function isTimeWindowAvailable(windowKey) {
        return !isBlockInPast(windowKey);
    }

    function getAvailableTimeWindows() {
        const now = new Date();
        const today = new Date(now);
        const tomorrow = new Date(now);
        tomorrow.setDate(tomorrow.getDate() + 1);
        const isTodaySunday = isSunday(today);
        const isTomorrowSunday = isSunday(tomorrow);
        const isTodaySaturday = isSaturday(today);
        const isTomorrowSaturday = isSaturday(tomorrow);
        const currentHour = now.getHours();
        let available = [];
        if (!isTodaySunday) {
            if (isTodaySaturday) {
                if (currentHour < 12) {
                    available.push('today_am');
                }
            } else {
                if (currentHour < 12) available.push('today_am');
                if (currentHour < 16) available.push('today_pm');
                if (currentHour < 20) available.push('today_eve');
            }
        }
        if (!isTomorrowSunday) {
            if (isTomorrowSaturday) {
                available.push('tomorrow_am');
            } else {
                available.push('tomorrow_am');
                available.push('tomorrow_pm');
                available.push('tomorrow_eve');
            }
        }
        if (isTodaySaturday && currentHour >= 12 && isTomorrowSunday) {
            available.push('monday_am');
            available.push('monday_pm');
            available.push('monday_eve');
        }
        return available;
    }

    const TASKS = {
        tv_mount: {
            hours: 2.0,
            label: "TV Wall Mount (32‚Äì65\")",
            questions: [
                {
                    id: 'tv_size',
                    label: 'What size is your TV?',
                    options: [
                        { value: 'standard', label: '32-65 inches', addon: 0 },
                        { value: 'large', label: 'Larger than 65 inches', addon: 50 }
                    ]
                },
                {
                    id: 'wall_type',
                    label: 'What type of wall?',
                    options: [
                        { value: 'drywall', label: 'Drywall with studs', addon: 0 },
                        { value: 'brick', label: 'Brick/concrete', addon: 40 },
                        { value: 'fireplace', label: 'Above fireplace', addon: 40 }
                    ]
                },
                {
                    id: 'mount_owned',
                    label: 'Do you have the wall mount?',
                    options: [
                        { value: 'yes', label: 'Yes, I have it', addon: 0 },
                        { value: 'no', label: 'No, need to purchase', addon: 0 }
                    ]
                }
            ]
        },
        ceiling_fan: {
            hours: 2.0,
            label: "Ceiling Fan Install/Replace",
            questions: [
                {
                    id: 'replacing',
                    label: 'Replacing existing fan or light?',
                    options: [
                        { value: 'fan', label: 'Yes, existing fan', addon: 0 },
                        { value: 'light', label: 'Yes, existing light fixture', addon: 0 },
                        { value: 'new', label: 'New installation', addon: 0 }
                    ]
                },
                {
                    id: 'fan_box',
                    label: 'Is ceiling box fan-rated?',
                    options: [
                        { value: 'yes', label: 'Yes/Don\'t know', addon: 0 },
                        { value: 'no', label: 'No, needs replacement', addon: 50 }
                    ]
                },
                {
                    id: 'ceiling_height',
                    label: 'Ceiling height?',
                    options: [
                        { value: 'standard', label: 'Under 10 feet', addon: 0 },
                        { value: 'high', label: 'Over 10 feet', addon: 40 }
                    ]
                }
            ]
        },
        light_fixture: {
            hours: 1.5,
            label: "Light Fixture / Chandelier Swap",
            questions: [
                {
                    id: 'fixture_type',
                    label: 'Type of fixture?',
                    options: [
                        { value: 'standard', label: 'Standard light fixture', addon: 0 },
                        { value: 'small_chandelier', label: 'Chandelier (under 25 lbs)', addon: 100 },
                        { value: 'heavy_chandelier', label: 'Heavy chandelier (over 25 lbs)', addon: 200 }
                    ]
                },
                {
                    id: 'ceiling_height',
                    label: 'Ceiling height?',
                    options: [
                        { value: 'standard', label: 'Under 10 feet', addon: 0 },
                        { value: 'high', label: 'Over 10 feet', addon: 30 }
                    ]
                }
            ]
        },
        faucet_showerhead: {
            hours: 1.5,
            label: "Faucet / Showerhead Replace",
            questions: [
                {
                    id: 'fixture_type',
                    label: 'What are you replacing?',
                    options: [
                        { value: 'faucet', label: 'Kitchen/bathroom faucet', addon: 0 },
                        { value: 'showerhead', label: 'Showerhead', addon: 0 },
                        { value: 'both', label: 'Both faucet and showerhead', addon: 0 }
                    ]
                },
                {
                    id: 'plumbing_issues',
                    label: 'Any plumbing issues?',
                    options: [
                        { value: 'none', label: 'No issues', addon: 0 },
                        { value: 'corrosion', label: 'Some corrosion/leaks', addon: 40 },
                        { value: 'access', label: 'Need sink removal', addon: 30 }
                    ]
                }
            ]
        },
        smart_doorbell: {
            hours: 1.25,
            label: "Smart Doorbell Install",
            questions: [
                {
                    id: 'install_type',
                    label: 'Installation type?',
                    options: [
                        { value: 'replace', label: 'Replacing existing doorbell', addon: 0 },
                        { value: 'wireless', label: 'New wireless install', addon: 30 }
                    ]
                },
                {
                    id: 'chime_status',
                    label: 'Current doorbell chime working?',
                    options: [
                        { value: 'working', label: 'Yes, works fine', addon: 0 },
                        { value: 'broken', label: 'No/needs replacement', addon: 40 },
                        { value: 'no_chime', label: 'Don\'t want chime connected', addon: 0 }
                    ]
                }
            ]
        },
        curtains_blinds: {
            hours: 1,
            perItem: true,
            itemLabel: "blind/curtain rod",
            label: "Curtain Rods / Blinds",
            questions: [
                {
                    id: 'quantity',
                    label: 'How many blinds/curtain rods?',
                    type: 'quantity',
                    options: [
                        { value: '1', label: '1 blind/rod', hours: 1.0, price: 80 },
                        { value: '2', label: '2 blinds/rods', hours: 1.5, price: 120 },
                        { value: '3', label: '3 blinds/rods', hours: 2.0, price: 160 },
                        { value: '4', label: '4 blinds/rods', hours: 2.5, price: 200 },
                        { value: '5', label: '5 blinds/rods', hours: 3.0, price: 240 },
                        { value: '6', label: '6 blinds/rods', hours: 3.5, price: 280 }
                    ]
                },
                {
                    id: 'wall_type',
                    label: 'What type of wall?',
                    options: [
                        { value: 'drywall', label: 'Drywall', addon: 0 },
                        { value: 'masonry', label: 'Brick/tile/concrete', addon: 40 }
                    ]
                }
            ]
        },
        floating_shelf: {
            hours: 1,
            perItem: true,
            itemLabel: "floating shelf",
            label: "Floating Shelf Install",
            questions: [
                {
                    id: 'quantity',
                    label: 'How many floating shelves?',
                    type: 'quantity',
                    options: [
                        { value: '1', label: '1 shelf', hours: 1.0, price: 80 },
                        { value: '2', label: '2 shelves', hours: 1.5, price: 120 },
                        { value: '3', label: '3 shelves', hours: 2.0, price: 160 },
                        { value: '4', label: '4 shelves', hours: 2.5, price: 200 },
                        { value: '5', label: '5 shelves', hours: 3.0, price: 240 },
                        { value: '6', label: '6 shelves', hours: 3.5, price: 280 }
                    ]
                },
                {
                    id: 'weight',
                    label: 'Shelf weight/size?',
                    options: [
                        { value: 'standard', label: 'Standard (under 25 lbs)', addon: 0 },
                        { value: 'heavy', label: 'Heavy-duty (over 25 lbs)', addon: 30 }
                    ]
                }
            ]
        },
        appliance_hookup: {
            hours: 2.0,
            label: "Appliance Hookup (W/D/DW)",
            questions: [
                {
                    id: 'appliance_type',
                    label: 'What appliance?',
                    options: [
                        { value: 'washer', label: 'Washer', addon: 0 },
                        { value: 'dryer', label: 'Dryer', addon: 0 },
                        { value: 'dishwasher', label: 'Dishwasher', addon: 0 },
                        { value: 'multiple', label: 'Multiple appliances', addon: 0 }
                    ]
                },
                {
                    id: 'old_removal',
                    label: 'Replacing an old unit?',
                    options: [
                        { value: 'remove', label: 'Yes, remove old', addon: 40 },
                        { value: 'new', label: 'No, new installation', addon: 0 },
                        { value: 'disconnect', label: 'Just disconnecting old', addon: 0 }
                    ]
                },
                {
                    id: 'hookups_ready',
                    label: 'Are hookups ready?',
                    options: [
                        { value: 'ready', label: 'Yes, all connections ready', addon: 0 },
                        { value: 'new_line', label: 'Need new vent/line', addon: 30 },
                        { value: 'unsure', label: 'Not sure', addon: 0 }
                    ]
                }
            ]
        },
        furniture_assembly: {
            hours: 2.0,
            label: "Furniture Assembly (S‚ÄìM)",
            questions: [
                {
                    id: 'furniture_type',
                    label: 'What type of furniture?',
                    options: [
                        { value: 'standard', label: 'Dresser/desk/table', addon: 0 },
                        { value: 'bed', label: 'Bed frame', addon: 30 },
                        { value: 'wardrobe', label: 'Large wardrobe', addon: 30 },
                        { value: 'multiple', label: 'Multiple small items', addon: 0 }
                    ]
                },
                {
                    id: 'quantity',
                    label: 'How many items?',
                    options: [
                        { value: 'single', label: '1 major item', addon: 0 },
                        { value: 'few', label: '2-3 small items', addon: 0 },
                        { value: 'many', label: '4+ items', addon: 40 }
                    ]
                }
            ]
        },
        closet_organizer: {
            hours: 2.5,
            label: "Closet Organizer Install",
            questions: [
                {
                    id: 'organizer_type',
                    label: 'Type of organizer?',
                    options: [
                        { value: 'standard', label: 'Shelves and rods', addon: 0 },
                        { value: 'modular', label: 'Modular cube system', addon: 0 },
                        { value: 'wire', label: 'Wire rack system', addon: 0 },
                        { value: 'custom', label: 'Custom wood system', addon: 0 }
                    ]
                },
                {
                    id: 'custom_fitting',
                    label: 'Need custom cutting?',
                    options: [
                        { value: 'no', label: 'No, standard sizes', addon: 0 },
                        { value: 'yes', label: 'Yes, custom fitting', addon: 50 },
                        { value: 'unsure', label: 'Not sure', addon: 0 }
                    ]
                },
                {
                    id: 'wall_type',
                    label: 'What type of wall?',
                    options: [
                        { value: 'drywall', label: 'Standard drywall', addon: 0 },
                        { value: 'masonry', label: 'Concrete/masonry', addon: 40 },
                        { value: 'unsure', label: 'Not sure', addon: 0 }
                    ]
                }
            ]
        },
        premium_moveout: {
            hours: 3.0,
            label: "Premium Move-Out Removal (Includes Patching & Cleanup)",
            questions: [
                {
                    id: 'property_size',
                    label: 'What size is the property?',
                    options: [
                        { value: 'studio', label: 'Studio/1 Bedroom', addon: 0 },
                        { value: '2br', label: '2 Bedroom', addon: 80 },
                        { value: '3br', label: '3 Bedroom', addon: 160 },
                        { value: '4br', label: '4+ Bedroom', addon: 240 }
                    ]
                },
                {
                    id: 'damage_level',
                    label: 'How much damage needs repair?',
                    options: [
                        { value: 'light', label: 'Light (few nail holes, minor touch-ups)', addon: 0 },
                        { value: 'moderate', label: 'Moderate (multiple holes, some paint)', addon: 50 },
                        { value: 'heavy', label: 'Heavy (major repairs, extensive work)', addon: 120 }
                    ]
                },
                {
                    id: 'additional_services',
                    label: 'Any additional services needed?',
                    options: [
                        { value: 'carpet_clean', label: 'Carpet cleaning and deodorizing', addon: 50 },
                        { value: 'full_paint', label: 'Full room repainting', addon: 75 },
                        { value: 'kitchen_deep', label: 'Kitchen appliance deep clean', addon: 40 },
                        { value: 'bathroom_restore', label: 'Bathroom tile & grout restoration', addon: 35 },
                        { value: 'floor_refinish', label: 'Hardwood floor refinishing', addon: 60 },
                        { value: 'window_clean', label: 'Window cleaning (interior/exterior)', addon: 25 },
                        { value: 'none', label: 'None needed', addon: 0 }
                    ]
                },
                {
                    id: 'timeline',
                    label: 'When do you need this completed?',
                    options: [
                        { value: 'flexible', label: 'Flexible timing', addon: 0 },
                        { value: 'soon', label: 'Within 1-2 weeks', addon: 0 },
                        { value: 'urgent', label: 'ASAP (rush job)', addon: 50 }
                    ]
                }
            ]
        },
        general_handyman: {
            hours: 3,
            label: "General Handyman (3+ hours)",
            questions: [
                {
                    id: 'task_complexity',
                    label: 'What type of tasks do you need done?',
                    options: [
                        { value: 'basic', label: 'Basic repairs, adjustments, or maintenance', addon: 0 },
                        { value: 'multiple', label: 'Multiple small tasks or repairs', addon: 0 },
                        { value: 'complex', label: 'More complex projects requiring planning', addon: 0 }
                    ]
                },
                {
                    id: 'additional_time',
                    label: 'Do you need additional time beyond 3 hours?',
                    options: [
                        { value: 'none', label: 'No, 3 hours should be sufficient', addon: 0 },
                        { value: 'one_block', label: 'Yes, add 3 more hours', addon: 180 },
                        { value: 'two_blocks', label: 'Yes, add 6 more hours', addon: 360 }
                    ]
                },
                {
                    id: 'materials_needed',
                    label: 'Will materials or parts be needed?',
                    options: [
                        { value: 'customer_supplies', label: 'I will provide all materials', addon: 0 },
                        { value: 'basic_supplies', label: 'May need basic supplies (screws, caulk, etc.)', addon: 0 },
                        { value: 'unsure', label: 'Not sure what will be needed', addon: 0 }
                    ]
                }
            ]
        },
        minor_repairs: { hours: 2.0, label: "Minor repairs", questions: [] }
    };

    function validatePropertyAddress(address) {
        if (!address || address.trim().length < 10) {
            return {
                valid: false,
                message: 'Please enter a complete address (minimum 10 characters)'
            };
        }
        const addressLower = address.toLowerCase();
        const hasNumber = /\d+/.test(address);
        if (!hasNumber) {
            return {
                valid: false,
                message: 'Address must include a street number'
            };
        }
        const floridaCities = ['boca raton', 'delray beach', 'boynton beach', 'fort lauderdale',
                               'hollywood', 'aventura', 'miami', 'coral gables', 'kendall',
                               'palm beach', 'west palm beach', 'pompano'];
        const hasCity = floridaCities.some(city => addressLower.includes(city));
        const hasZip = /\b33\d{3}\b|\b34\d{3}\b/.test(address);
        if (!hasCity && !hasZip) {
            return {
                valid: false,
                message: 'Please include city name or ZIP code (we serve South Florida)'
            };
        }
        const hasStreetType = /(street|st|avenue|ave|road|rd|drive|dr|lane|ln|boulevard|blvd|way|court|ct|circle|cir|place|pl)/i.test(address);
        if (!hasStreetType) {
            return {
                valid: false,
                message: 'Please include street type (St, Ave, Rd, etc.)'
            };
        }
        return { valid: true };
    }

    function debugPricingFlow(step, data) {
        console.log(`üîç PRICING DEBUG [${step}]:`, {
            selectedOption: selectedPricingOption?.type,
            window: selectedPricingOption?.window,
            amount: selectedPricingOption?.pricing?.total,
            additionalData: data
        });
    }

    function initializeStripe() {
        if (typeof Stripe !== 'undefined') {
            if (!STRIPE_PUBLISHABLE_KEY.includes('YOUR_ACTUAL_STRIPE_KEY_HERE')) {
                try {
                    stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
                    console.log('‚úÖ Stripe initialized successfully');
                } catch (error) {
                    console.error('‚ùå Stripe initialization failed:', error);
                }
            } else {
                console.error('‚ùå Please set your actual Stripe publishable key!');
            }
        } else {
            console.log('‚è≥ Stripe not loaded yet, retrying...');
            setTimeout(initializeStripe, 1000);
        }
    }

    function generateTaskId() {
        const timestamp = Date.now().toString(36);
        const random = Math.random().toString(36).substring(2, 8);
        return `TASK-${timestamp}-${random}`.toUpperCase();
    }

    async function sendSMSNotification(type, data) {
        try {
            console.log(`üì± Sending ${type} SMS notification...`);
            const response = await fetch('/.netlify/functions/send-sms', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    type: type,
                    data: data
                })
            });
            if (response.ok) {
                const result = await response.json();
                console.log(`‚úÖ ${type} SMS sent successfully:`, result.messageSid);
                return { success: true, data: result };
            } else {
                const error = await response.json();
                console.log(`‚ö†Ô∏è SMS ${type} failed:`, error.error);
                return { success: false, error: error.error };
            }
        } catch (error) {
            console.error(`‚ùå SMS ${type} error:`, error);
            return { success: false, error: error.message };
        }
    }

    async function sendZapierNotification(jobData) {
        if (!ZAPIER_CONFIG.ENABLED || ZAPIER_CONFIG.WEBHOOK_URL.includes('YOUR_ZAPIER_WEBHOOK_ID')) {
            console.log('‚ö†Ô∏è Zapier webhook not configured - skipping notification');
            return { success: false, message: 'Webhook not configured' };
        }
        const zapierData = {
            task_id: jobData.task_id,
            timestamp: new Date().toISOString(),
            customer_name: jobData.name,
            customer_phone: jobData.phone,
            customer_email: jobData.email,
            customer_zip: jobData.zip,
            customer_address: jobData.address || '',
            task_category: jobData.category,
            task_category_label: TASKS[jobData.category]?.label || jobData.category,
            time_window: jobData.window,
            description: jobData.description || 'None provided',
            rush_service: jobData.rush,
            estimated_hours: jobData.estimated_hours,
            base_amount: jobData.base_amount,
            total_amount: jobData.total_amount,
            total_amount_formatted: '$' + jobData.total_amount.toFixed(2),
            premiums_applied: jobData.premiums?.map(p => p.label).join(', ') || 'None',
            property_address: jobData.property_address,
            contact_phone: jobData.contact_phone,
            access_details: jobData.access_details || 'None provided',
            pets_and_special: jobData.pets_and_special || 'None provided',
            additional_details: jobData.additional_details || 'None provided',
            payment_intent_id: jobData.payment_intent_id,
            step_scope: jobData.step_scope?.join(' ‚Ä¢ ') || 'Standard scope',
            risk_flags: jobData.risk_flags?.join(' ‚Ä¢ ') || 'No special risks noted',
            notification_email: 'info@sendahandyman.com'
        };
        try {
            console.log('üìß Sending notification via Zapier webhook...');
            const params = new URLSearchParams();
            Object.keys(zapierData).forEach(key => {
                params.append(key, zapierData[key]);
            });
            const response = await fetch(ZAPIER_CONFIG.WEBHOOK_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: params.toString()
            });
            if (response.ok) {
                const result = await response.json();
                console.log('‚úÖ Zapier notification sent successfully:', result);
                return { success: true, data: result };
            } else {
                throw new Error(`Zapier webhook failed: ${response.status} ${response.statusText}`);
            }
        } catch (error) {
            console.error('‚ùå Zapier notification failed:', error);
            return { success: false, error: error.message };
        }
    }

    function showTaskQuestions(taskKey) {
        const task = TASKS[taskKey];
        const questionsSection = document.getElementById('taskQuestions');
        const questionsContainer = document.getElementById('questionsContainer');
        if (!task || !task.questions || task.questions.length === 0) {
            questionsSection.classList.add('hidden');
            return;
        }
        questionsContainer.innerHTML = '';
        task.questions.forEach(question => {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'space-y-2';
            const label = document.createElement('label');
            label.className = 'block text-sm font-semibold text-slate-700';
            label.textContent = question.label;
            const select = document.createElement('select');
            select.className = 'w-full rounded-warm border border-warm-200 px-3 py-2 text-sm focus:ring-2 focus:ring-warm-500';
            select.id = `question_${question.id}`;
            select.addEventListener('change', updateEstimateWithAddons);
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Please select...';
            select.appendChild(defaultOption);
            question.options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option.value;

                // Handle quantity pricing differently
                if (question.type === 'quantity' && option.price) {
                    optionElement.textContent = `${option.label} - $${option.price}`;
                    optionElement.dataset.price = option.price;
                    optionElement.dataset.hours = option.hours;
                } else {
                    optionElement.textContent = option.label + (option.addon > 0 ? ` (+$${option.addon})` : '');
                    optionElement.dataset.addon = option.addon;
                }

                select.appendChild(optionElement);
            });
            questionDiv.appendChild(label);
            questionDiv.appendChild(select);
            questionsContainer.appendChild(questionDiv);
        });
        questionsSection.classList.remove('hidden');
    }

    function calculateAddons(taskKey) {
        const task = TASKS[taskKey];
        if (!task || !task.questions) return 0;
        let totalAddons = 0;
        console.log('üîç Calculating addons for task:', taskKey);
        task.questions.forEach(question => {
            const select = document.getElementById(`question_${question.id}`);
            if (select && select.value) {
                const selectedOption = select.options[select.selectedIndex];

                // Handle quantity pricing (replaces base price) vs regular addons
                if (question.type === 'quantity' && selectedOption.dataset.price) {
                    // Quantity pricing is handled in pricing calculation, not as addon
                    console.log(`üìä Question ${question.id}: quantity pricing "${select.value}" with base price ${selectedOption.dataset.price}`);
                } else {
                    const addon = parseInt(selectedOption.dataset.addon) || 0;
                    console.log(`üìä Question ${question.id}: selected "${select.value}" with addon ${addon}`);
                    totalAddons += addon;
                }
            }
        });
        console.log('üí∞ Total addons calculated:', totalAddons);
        return totalAddons;
    }

    // Get quantity-based pricing for per-item services
    function getQuantityPricing(taskKey) {
        const task = TASKS[taskKey];
        if (!task || !task.perItem) return null;

        const quantityQuestion = task.questions?.find(q => q.type === 'quantity');
        if (!quantityQuestion) return null;

        const select = document.getElementById(`question_${quantityQuestion.id}`);
        if (!select || !select.value) return null;

        const selectedOption = select.options[select.selectedIndex];
        return {
            price: parseInt(selectedOption.dataset.price) || 0,
            hours: parseFloat(selectedOption.dataset.hours) || task.hours
        };
    }

    function updateEstimateWithAddons() {
        const taskKey = document.getElementById('taskCategory').value;
        if (!taskKey) return;
        const addons = calculateAddons(taskKey);
        console.log('Current add-ons total:', addons);

        // Log quantity pricing if applicable
        const quantityPricing = getQuantityPricing(taskKey);
        if (quantityPricing) {
            console.log('Quantity pricing:', quantityPricing);
        }
    }

    function calculatePricing(hours, window, rush = false, addons = 0, selectedDate = null) {
        const base = hours * RATE;
        let premiums = [];
        let total = base + addons;
        const currentBlock = getCurrentBlock();
        const isToday = window.startsWith('today');
        const isTomorrow = window.startsWith('tomorrow');
        const isMonday = window.startsWith('monday');
        const isFuture = selectedDate !== null;
        const isEveningBlock = window.includes('eve');
        const now = new Date();
        let bookingDate;

        if (isFuture && selectedDate) {
            bookingDate = new Date(selectedDate + 'T00:00:00');
        } else if (isToday) {
            bookingDate = now;
        } else if (isTomorrow) {
            bookingDate = new Date(now);
            bookingDate.setDate(bookingDate.getDate() + 1);
        } else if (isMonday) {
            bookingDate = new Date(now);
            bookingDate.setDate(bookingDate.getDate() + 2);
        }

        const isBookingSaturday = bookingDate && isSaturday(bookingDate);

        if (isFuture) {
            console.log('üîç PRICING CALCULATION:', {
                selectedDate: selectedDate,
                bookingDate: bookingDate ? bookingDate.toDateString() : 'null',
                dayOfWeek: bookingDate ? bookingDate.getDay() : 'null',
                isBookingSaturday: isBookingSaturday,
                isEveningBlock: isEveningBlock,
                window: window,
                basePrice: base,
                hours: hours
            });
        }

        if (isFuture) {
            if (isEveningBlock) {
                const premium = base * PREMIUM_EVENING_BLOCK;
                premiums.push({ label: 'Evening block premium (4-8PM, +35%)', amount: premium });
                total += premium;
                console.log('üåô Evening block: base=' + base + ', premium=' + premium + ', total=' + total);
            }
            else if (isBookingSaturday) {
                const satPremium = base * PREMIUM_SATURDAY;
                premiums.push({ label: 'Saturday service premium (+30%)', amount: satPremium });
                total += satPremium;
                console.log('üìÖ Saturday detected: base=' + base + ', premium=' + satPremium + ', total=' + total);
            } else {
                const discount = base * DISCOUNT_FUTURE;
                premiums.push({ label: 'Future booking discount (-10%)', amount: -discount });
                total -= discount;
                console.log('üí∞ Future discount: base=' + base + ', discount=' + discount + ', total=' + total);
            }
        } else if (isToday) {
            if (isBookingSaturday) {
                const satPremium = base * PREMIUM_SATURDAY;
                premiums.push({ label: 'Saturday service premium (+30%)', amount: satPremium });
                total += satPremium;
            }
            if (isEveningBlock) {
                const premium = base * PREMIUM_EVENING_BLOCK;
                premiums.push({ label: 'Evening block premium (4-8PM, +35%)', amount: premium });
                total += premium;
            } else if (window === currentBlock) {
                const premium = base * PREMIUM_CURRENT_BLOCK;
                premiums.push({ label: 'Current time block premium (+30%)', amount: premium });
                total += premium;
            } else {
                const premium = base * PREMIUM_NEXT_BLOCK;
                premiums.push({ label: 'Next available block premium (+20%)', amount: premium });
                total += premium;
            }
        } else if (isTomorrow) {
            if (isBookingSaturday) {
                const satPremium = base * PREMIUM_SATURDAY;
                premiums.push({ label: 'Saturday service premium (+30%)', amount: satPremium });
                total += satPremium;
            }
            if (isEveningBlock) {
                const premium = base * PREMIUM_EVENING_BLOCK;
                premiums.push({ label: 'Evening block premium (4-8PM, +35%)', amount: premium });
                total += premium;
            }
        }

        if (addons > 0) {
            premiums.push({ label: 'Task-specific add-ons', amount: addons });
        }
        return { base, premiums, total, addons };
    }

    function saveFormData() {
        console.log('üíæ Saving form data...');
        const futureDateInput = document.getElementById('futureDate').value;
        formData = {
            name: document.getElementById('customerName').value,
            phone: document.getElementById('customerPhone').value,
            email: document.getElementById('customerEmail').value,
            zip: document.getElementById('customerZip').value,
            address: document.getElementById('customerAddress').value,
            category: document.getElementById('taskCategory').value,
            window: document.getElementById('taskWindow').value,
            futureDate: futureDateInput || null,
            description: document.getElementById('taskDescription').value,
            rush: false
        };
        console.log('‚úÖ Form data saved to memory:', formData);
        return formData;
    }

    function showEstimateProgress() {
        const btn = document.getElementById('getEstimateBtn');
        const progressBg = document.getElementById('progressBg');
        const text = document.getElementById('estimateText');
        const container = document.getElementById('progressContainer');
        const bar = document.getElementById('progressBar');
        const message = document.getElementById('progressMessage');
        btn.disabled = true;
        container.classList.remove('hidden');
        text.textContent = 'üì§ Uploading photos...';
        message.textContent = 'Uploading photos and analyzing task...';
        progressBg.style.transform = 'translateX(-75%)';
        bar.style.width = '25%';
        setTimeout(() => {
            text.textContent = 'ü§ñ AI analyzing...';
            message.textContent = 'AI is analyzing your photos and requirements...';
            progressBg.style.transform = 'translateX(-40%)';
            bar.style.width = '60%';
        }, 1500);
        setTimeout(() => {
            text.textContent = 'üí≠ Generating options...';
            message.textContent = 'Creating your pricing options...';
            progressBg.style.transform = 'translateX(-10%)';
            bar.style.width = '90%';
        }, 3000);
        setTimeout(() => {
            text.textContent = '‚úÖ Options ready!';
            message.textContent = 'Analysis complete! Options generated.';
            progressBg.style.transform = 'translateX(0%)';
            bar.style.width = '100%';
        }, 4000);
    }

    function resetEstimateProgress() {
        const btn = document.getElementById('getEstimateBtn');
        const progressBg = document.getElementById('progressBg');
        const text = document.getElementById('estimateText');
        const container = document.getElementById('progressContainer');
        const bar = document.getElementById('progressBar');
        setTimeout(() => {
            btn.disabled = false;
            text.textContent = 'üîß Get pricing options';
            container.classList.add('hidden');
            progressBg.style.transform = 'translateX(-100%)';
            bar.style.width = '0%';
        }, 1000);
    }

    async function generateEstimate() {
        console.log('üîÑ Generate estimate button clicked!');
        try {
            const data = saveFormData();
            console.log('üìã Form data collected:', data);
            if (!data.category) {
                console.error('‚ùå Missing required fields');
                alert('Please select a task category first');
                return;
            }

            if (!data.description || data.description.trim() === '') {
                console.error('‚ùå Missing job description');
                alert('Please describe your job. This helps our handyman bring the right tools and materials.');

                // Focus on the description field and highlight it
                const descriptionField = document.getElementById('taskDescription');
                if (descriptionField) {
                    descriptionField.focus();
                    descriptionField.style.borderColor = '#ef4444';
                    setTimeout(() => {
                        descriptionField.style.borderColor = '';
                    }, 3000);
                }
                return;
            }
            if (data.futureDate) {
                const selectedDate = new Date(data.futureDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const maxDate = new Date(today);
                maxDate.setDate(maxDate.getDate() + 14);
                const minDate = new Date(today);
                minDate.setDate(minDate.getDate() + 2);
                if (selectedDate < minDate || selectedDate > maxDate) {
                    alert('Please select a date between 2 and 14 days in the future');
                    return;
                }
            }
            console.log('‚úÖ Validation passed, starting progress animation...');
            showEstimateProgress();
            const hours = TASKS[data.category]?.hours || 1.5;
            const addons = calculateAddons(data.category);
            const aiPayload = {
                category: data.category,
                description: data.description,
                base_rate_hr: RATE,
                hours_base: hours,
                window: data.window,
                rush: data.rush,
                addons: addons,
                futureDate: data.futureDate,
                name: data.name || 'Customer', // Placeholder until personal info is provided
                phone: data.phone || '',
                email: data.email || '',
                address: data.address || ''
            };
            console.log('üì§ Calling AI scope function with payload:', aiPayload);
            const response = await fetch('/.netlify/functions/scope', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(aiPayload)
            });
            console.log('üì° AI scope response status:', response.status);
            if (!response.ok) {
                const errorText = await response.text();
                console.error('‚ùå AI scope failed:', response.status, errorText);
                throw new Error(`AI estimate failed: ${response.status}`);
            }
            const aiResult = await response.json();
            console.log('üìä AI scope result:', aiResult);
            const pricingOptions = generatePricingOptions(hours, data.window, data.rush, addons, data.futureDate);
            console.log('üí∞ Generated pricing options:', pricingOptions);
            console.log('üìä Future date selected:', data.futureDate);
            console.log('üî¢ Number of options:', pricingOptions.length);
            estimateData = {
                ...aiResult,
                hours,
                pricingOptions,
                futureDate: data.futureDate
            };
            console.log('‚úÖ Estimate data stored:', estimateData);
            setTimeout(() => {
                console.log('üéØ Showing estimate panel...');
                showEstimatePanel(estimateData);
                resetEstimateProgress();
            }, 4500);
        } catch (error) {
            console.error('‚ùå Generate estimate error:', error);
            alert('Failed to generate estimate: ' + error.message);
            resetEstimateProgress();
        }
    }

    function generatePricingOptions(hours, selectedWindow, rush, addons = 0, selectedDate = null) {
        const options = [];
        const availableWindows = getAvailableTimeWindows();

        if (selectedDate) {
            const dateObj = new Date(selectedDate + 'T00:00:00');

            if (isSunday(dateObj)) {
                alert('Sunday bookings are not available. Please select a different date.');
                return [];
            }

            const isSelectedSaturday = isSaturday(dateObj);

            const dayBefore = new Date(dateObj);
            dayBefore.setDate(dayBefore.getDate() - 1);

            if (isSunday(dayBefore)) {
                dayBefore.setDate(dayBefore.getDate() - 1);
            }

            let dayAfter = new Date(dateObj);
            dayAfter.setDate(dayAfter.getDate() + 1);

            if (isSunday(dayAfter)) {
                dayAfter.setDate(dayAfter.getDate() + 1);
            }

            const formattedDateBefore = dayBefore.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric'
            });

            const formattedDateSelected = dateObj.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric'
            });

            const formattedDateAfter = dayAfter.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric'
            });

            const isDayBeforeSaturday = isSaturday(dayBefore);
            const isDayAfterSaturday = isSaturday(dayAfter);

            const getTimeBlockLabel = (blockKey) => {
                if (blockKey === 'morning') return '8AM-12PM';
                if (blockKey === 'afternoon') return '12PM-4PM';
                if (blockKey === 'evening') return '4PM-8PM';
                return '';
            };

            const createOption = (date, block, dateLabel, sectionType, isSat) => {
                const dateString = date.toISOString().split('T')[0];
                let windowIdentifier;
                if (block.key === 'evening') {
                    windowIdentifier = 'tomorrow_eve';
                } else if (block.key === 'afternoon') {
                    windowIdentifier = 'tomorrow_pm';
                } else {
                    windowIdentifier = 'tomorrow_am';
                }

                const pricing = calculatePricing(hours, windowIdentifier, rush, addons, dateString);

                console.log('üí∞ Creating option:', {
                    date: dateString,
                    block: block.key,
                    isSaturday: isSat,
                    window: windowIdentifier,
                    basePrice: pricing.base,
                    totalPrice: pricing.total,
                    premiums: pricing.premiums
                });

                let badge, badgeClass;
                if (block.key === 'evening') {
                    badge = 'Evening +35%';
                    badgeClass = 'premium';
                } else if (isSat) {
                    badge = 'Saturday +30%';
                    badgeClass = 'premium';
                } else {
                    badge = 'Future -10%';
                    badgeClass = 'discount';
                }

                return {
                    type: 'future',
                    window: `future_${date.getTime()}_${block.key}`,
                    windowLabel: `${dateLabel} (${block.label})`,
                    pricing: pricing,
                    badge: badge,
                    badgeClass: badgeClass,
                    selectedDate: dateString,
                    timeBlock: block,
                    sectionType: sectionType
                };
            };

            const allTimeBlocks = [
                { key: 'morning', label: '8AM-12PM', start: 8, end: 12 },
                { key: 'afternoon', label: '12PM-4PM', start: 12, end: 16 },
                { key: 'evening', label: '4PM-8PM', start: 16, end: 20 }
            ];

            const dayBeforeBlocks = isDayBeforeSaturday ? [allTimeBlocks[0]] : allTimeBlocks;
            dayBeforeBlocks.forEach(block => {
                options.push(createOption(
                    dayBefore,
                    block,
                    formattedDateBefore,
                    'Day Before (Better Value)',
                    isDayBeforeSaturday
                ));
            });

            if (!isSelectedSaturday) {
                allTimeBlocks.forEach(block => {
                    options.push(createOption(
                        dateObj,
                        block,
                        formattedDateSelected,
                        'Your Selected Date',
                        false
                    ));
                });
            } else {
                options.push(createOption(
                    dateObj,
                    allTimeBlocks[0],
                    formattedDateSelected,
                    'Your Selected Date (Saturday)',
                    true
                ));
            }

            const dayAfterBlocks = isDayAfterSaturday ? [allTimeBlocks[0]] : allTimeBlocks;
            dayAfterBlocks.forEach(block => {
                options.push(createOption(
                    dayAfter,
                    block,
                    formattedDateAfter,
                    'Day After (Better Value)',
                    isDayAfterSaturday
                ));
            });

            return options;
        }

        if (selectedWindow === 'flexible') {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            let flexibleWindow;
            let flexibleDate;

            if (isSunday(tomorrow)) {
                flexibleWindow = 'monday_am';
                const daysUntilMonday = (8 - now.getDay()) % 7;
                flexibleDate = new Date(now);
                flexibleDate.setDate(flexibleDate.getDate() + (daysUntilMonday === 0 ? 7 : daysUntilMonday));
            }
            else if (isSaturday(tomorrow)) {
                flexibleWindow = 'monday_am';
                const daysUntilMonday = (8 - now.getDay()) % 7;
                flexibleDate = new Date(now);
                flexibleDate.setDate(flexibleDate.getDate() + (daysUntilMonday === 0 ? 7 : daysUntilMonday));
            }
            else {
                flexibleWindow = 'tomorrow_am';
                flexibleDate = tomorrow;
            }

            const formattedFlexDate = flexibleDate.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric'
            });

            const pricing = calculatePricing(hours, flexibleWindow, rush, addons);
            options.push({
                type: 'flexible',
                window: flexibleWindow,
                windowLabel: `${formattedFlexDate} (8AM-12PM) - Best Value`,
                pricing: pricing,
                badge: 'Best Value',
                badgeClass: 'discount',
                sortDate: flexibleDate.getTime()
            });

            availableWindows.forEach(window => {
                if (window !== flexibleWindow && !window.includes('today')) {
                    const altPricing = calculatePricing(hours, window, rush, addons);
                    const windowDate = new Date(now);
                    if (window.startsWith('tomorrow')) {
                        windowDate.setDate(windowDate.getDate() + 1);
                    } else if (window.startsWith('monday')) {
                        const daysUntilMonday = (8 - now.getDay()) % 7;
                        windowDate.setDate(windowDate.getDate() + (daysUntilMonday === 0 ? 7 : daysUntilMonday));
                    }

                    const formattedAltDate = windowDate.toLocaleDateString('en-US', {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric'
                    });

                    const timeOnly = TIME_WINDOWS[window].label.match(/\((.*)\)/)?.[1] || TIME_WINDOWS[window].label;
                    const isAltSaturday = isSaturday(windowDate);
                    options.push({
                        type: 'alternative',
                        window: window,
                        windowLabel: `${formattedAltDate} (${timeOnly})`,
                        pricing: altPricing,
                        badge: isAltSaturday ? 'Saturday' : 'Alternative',
                        badgeClass: isAltSaturday ? 'premium' : 'selected',
                        sortDate: windowDate.getTime()
                    });
                }
            });

            // Sort options chronologically
            options.sort((a, b) => a.sortDate - b.sortDate);
            return options;
        }

        availableWindows.forEach(window => {
            const pricing = calculatePricing(hours, window, rush, addons);
            const isSelected = window === selectedWindow;
            const now = new Date();
            let windowDate = new Date(now);
            if (window.startsWith('tomorrow')) {
                windowDate.setDate(windowDate.getDate() + 1);
            } else if (window.startsWith('monday')) {
                // Find next Monday
                const daysUntilMonday = (8 - now.getDay()) % 7;
                windowDate.setDate(windowDate.getDate() + (daysUntilMonday === 0 ? 7 : daysUntilMonday));
            }

            // Format date for display
            const formattedDate = windowDate.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric'
            });

            const isWindowSaturday = isSaturday(windowDate);
            let badge, badgeClass, type;
            if (window.startsWith('today')) {
                badge = isWindowSaturday ? 'Saturday' : 'Today';
                badgeClass = 'premium';
                type = 'today';
            } else if (window.includes('eve')) {
                badge = 'Evening';
                badgeClass = 'premium';
                type = 'evening';
            } else if (window.startsWith('monday')) {
                badge = 'Monday';
                badgeClass = 'selected';
                type = 'monday';
            } else {
                badge = isWindowSaturday ? 'Saturday' : 'Tomorrow';
                badgeClass = isWindowSaturday ? 'premium' : 'selected';
                type = 'tomorrow';
            }
            if (isSelected) {
                badge = 'Selected';
            }

            // Update label to include date
            const timeOnly = TIME_WINDOWS[window].label.match(/\((.*)\)/)?.[1] || TIME_WINDOWS[window].label;
            const updatedLabel = `${formattedDate} (${timeOnly})`;

            options.push({
                type: type,
                window: window,
                windowLabel: updatedLabel,
                pricing: pricing,
                badge: badge,
                badgeClass: badgeClass,
                sortDate: windowDate.getTime() // Add sort key
            });
        });

        if (options.length === 1 && options[0].window === 'tomorrow_am') {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);

            if (isSaturday(tomorrow)) {
                const mondayDate = new Date(now);
                const daysUntilMonday = (8 - now.getDay()) % 7;
                mondayDate.setDate(mondayDate.getDate() + (daysUntilMonday === 0 ? 7 : daysUntilMonday));

                const formattedMondayDate = mondayDate.toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                });

                ['monday_am', 'monday_pm', 'monday_eve'].forEach(mondayWindow => {
                    const mondayPricing = calculatePricing(hours, mondayWindow, rush, addons);
                    const timeOnly = TIME_WINDOWS[mondayWindow].label.match(/\((.*)\)/)?.[1] || TIME_WINDOWS[mondayWindow].label;
                    options.push({
                        type: 'monday',
                        window: mondayWindow,
                        windowLabel: `${formattedMondayDate} (${timeOnly})`,
                        pricing: mondayPricing,
                        badge: 'Alternative',
                        badgeClass: 'selected',
                        sortDate: mondayDate.getTime()
                    });
                });
            }
        }

        // Sort options chronologically
        options.sort((a, b) => a.sortDate - b.sortDate);
        return options;
    }

    function showEstimatePanel(estimate) {
        const isFlexible = formData.window === 'flexible';
        const hasFutureDate = formData.futureDate !== null && formData.futureDate !== '';

        const flexibleNotice = document.getElementById('flexibleNotice');
        const futureDateNotice = document.getElementById('futureDateNotice');

        if (isFlexible && flexibleNotice) {
            flexibleNotice.classList.remove('hidden');
            if (futureDateNotice) futureDateNotice.classList.add('hidden');
        } else if (hasFutureDate && futureDateNotice) {
            if (flexibleNotice) flexibleNotice.classList.add('hidden');
            futureDateNotice.classList.remove('hidden');
        } else {
            if (flexibleNotice) flexibleNotice.classList.add('hidden');
            if (futureDateNotice) futureDateNotice.classList.add('hidden');
        }

        const optionsContainer = document.getElementById('pricingOptions');
        optionsContainer.innerHTML = '';

        const hasSections = estimate.pricingOptions.some(opt => opt.sectionType);

        if (hasSections) {
            const sections = {};
            estimate.pricingOptions.forEach(option => {
                const sectionName = option.sectionType || 'Other';
                if (!sections[sectionName]) {
                    sections[sectionName] = [];
                }
                sections[sectionName].push(option);
            });

            const sectionOrder = ['Day Before (Better Value)', 'Your Selected Date', 'Your Selected Date (Saturday)', 'Day After (Better Value)'];

            sectionOrder.forEach(sectionName => {
                if (sections[sectionName]) {
                    if (optionsContainer.children.length > 0) {
                        const divider = document.createElement('div');
                        divider.className = 'section-divider';
                        optionsContainer.appendChild(divider);
                    }

                    const sectionHeader = document.createElement('div');
                    sectionHeader.className = 'section-header-wrapper';

                    let headerClass = 'text-base font-bold';
                    let icon = '';
                    let description = '';

                    if (sectionName.includes('Better Value')) {
                        headerClass += ' text-green-700';
                        icon = 'üí∞ ';
                        description = '<span class="text-xs font-normal text-green-600 ml-2">(Save money with these options)</span>';
                    } else if (sectionName.includes('Saturday')) {
                        headerClass += ' text-orange-700';
                        icon = 'üìÖ ';
                        description = '<span class="text-xs font-normal text-orange-600 ml-2">(Premium pricing applies)</span>';
                    } else {
                        headerClass += ' text-indigo-700';
                        icon = 'üìå ';
                    }

                    sectionHeader.innerHTML = `<div class="${headerClass}">${icon}${sectionName}${description}</div>`;
                    optionsContainer.appendChild(sectionHeader);

                    sections[sectionName].forEach((option, index) => {
                        const optionCard = createPricingOptionCard(option, estimate.hours, index === 0 && sectionName === 'Your Selected Date');
                        optionsContainer.appendChild(optionCard);
                    });
                }
            });
        } else {
            estimate.pricingOptions.forEach((option, index) => {
                const optionCard = createPricingOptionCard(option, estimate.hours, index === 0);
                optionsContainer.appendChild(optionCard);
            });
        }

        document.getElementById('estimateScope').innerHTML = (estimate.step_scope || []).map(s => `<li>${s}</li>`).join('');
        document.getElementById('estimateRisks').innerHTML = (estimate.risk_flags || []).map(r => `<li>${r}</li>`).join('');

        // Show the estimate panel and then show the pricing step
        document.getElementById('estimatePanel').classList.remove('hidden');
        showPricingStep('step-pricing');
        document.getElementById('estimatePanel').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function createPricingOptionCard(option, hours, autoSelect) {
        const optionCard = document.createElement('div');
        optionCard.className = 'pricing-option relative border-2 border-slate-200 rounded-xl p-4 cursor-pointer';
        optionCard.dataset.optionType = option.type;
        optionCard.dataset.window = option.window;

        let breakdownHTML = '';
        if (option.pricing.premiums && option.pricing.premiums.length > 0) {
            breakdownHTML = '<div class="text-xs text-slate-500 mt-2">';
            option.pricing.premiums.forEach(premium => {
                const sign = premium.amount >= 0 ? '+' : '';
                breakdownHTML += `<div>${premium.label}: ${sign}${Math.abs(premium.amount).toFixed(0)}</div>`;
            });
            breakdownHTML += '</div>';
        }

        optionCard.innerHTML = `
            <div class="pricing-badge ${option.badgeClass}">${option.badge}</div>
            <div class="flex items-center justify-between">
                <div>
                    <div class="font-semibold text-lg">${option.windowLabel}</div>
                    <div class="text-sm text-slate-600">${hours.toFixed(1)} hours estimated</div>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold">$${option.pricing.total.toFixed(0)}</div>
                </div>
            </div>
            ${breakdownHTML}
        `;

        optionCard.addEventListener('click', () => selectPricingOption(option, optionCard));

        if (autoSelect) {
            setTimeout(() => selectPricingOption(option, optionCard), 100);
        }

        return optionCard;
    }

    function selectPricingOption(option, cardElement) {
        document.querySelectorAll('.pricing-option').forEach(card => {
            card.classList.remove('selected');
        });
        cardElement.classList.add('selected');
        selectedPricingOption = {
            ...option,
            window: option.window,
            windowLabel: option.windowLabel,
            type: option.type,
            pricing: { ...option.pricing }
        };
        // Enable continue to info button instead of reserve button
        const continueToInfoBtn = document.getElementById('continueToInfoBtn');
        if (continueToInfoBtn) {
            continueToInfoBtn.disabled = false;
        }
        debugPricingFlow('OPTION_SELECTED', option);
        console.log('‚úÖ Selected pricing option:', selectedPricingOption);
    }

    async function showPaymentModal() {
        if (!selectedPricingOption) {
            alert('Please select a pricing option first');
            return;
        }
        if (!stripe) {
            alert('Payment system is still loading. Please try again in a moment.');
            return;
        }
        const finalAmount = selectedPricingOption.pricing.total;
        debugPricingFlow('PAYMENT_MODAL_OPENED', {
            selectedOption: selectedPricingOption,
            finalAmount: finalAmount
        });
        document.getElementById('paymentAmount').textContent = '$' + finalAmount.toFixed(0);
        document.getElementById('paymentTiming').textContent = selectedPricingOption.windowLabel;
        document.getElementById('paymentModal').classList.remove('hidden');

        // Clean up existing payment element if it exists
        if (paymentElement) {
            console.log('üßπ Cleaning up existing payment element');
            try {
                paymentElement.unmount();
            } catch (e) {
                console.log('Note: Payment element unmount not needed or failed');
            }
            paymentElement = null;
        }

        paymentElementReady = false;
        const paymentMessage = document.getElementById('paymentMessage');
        paymentMessage.classList.add('hidden');
        paymentMessage.textContent = '';
        try {
            console.log('üîÑ Setting up payment intent...');
            console.log('üí∞ Amount being sent:', finalAmount, 'USD');
            const response = await fetch('/.netlify/functions/create-payment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    amount: finalAmount,
                    currency: 'usd',
                    customer_info: {
                        name: formData.name,
                        email: formData.email,
                        phone: formData.phone
                    },
                    job_details: {
                        category: formData.category,
                        window: selectedPricingOption.window,
                        hours: estimateData.hours,
                        selected_option_type: selectedPricingOption.type,
                        futureDate: formData.futureDate
                    }
                })
            });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                console.error('‚ùå Payment intent creation failed:', {
                    status: response.status,
                    statusText: response.statusText,
                    error: errorData
                });
                throw new Error(errorData.error || `Payment setup failed: ${response.status}`);
            }
            const result = await response.json();
            console.log('‚úÖ Payment intent created successfully:', {
                id: result.payment_intent_id,
                hasClientSecret: !!result.client_secret,
                capture_method: result.capture_method,
                status: result.status
            });

            // üö® CRITICAL: Verify server returned manual capture method
            if (result.capture_method !== 'manual') {
                console.error('üö® ERROR: Server did not return manual capture method!', result.capture_method);
                alert('‚ö†Ô∏è ERROR: Payment system not configured for authorization holds. Contact support immediately.');
            } else {
                console.log('‚úÖ CONFIRMED: Server returned manual capture method for authorization hold');
            }

            if (!result.client_secret) {
                throw new Error('No client secret received from server');
            }
            paymentIntentId = result.payment_intent_id;
            console.log('‚úÖ Payment intent created:', paymentIntentId);
            if (elements) {
                try {
                    elements = null;
                } catch (e) {
                    console.log('Element cleanup:', e.message);
                }
            }
            if (paymentElement) {
                try {
                    paymentElement.unmount();
                    paymentElement = null;
                } catch (e) {
                    console.log('Previous element unmount:', e.message);
                }
            }
            console.log('üí≥ Initializing Stripe Elements...');
            elements = stripe.elements({
                clientSecret: result.client_secret,
                appearance: {
                    theme: 'stripe',
                    variables: {
                        colorPrimary: '#4f46e5',
                    }
                }
            });
            paymentElement = elements.create('payment', {
                layout: {
                    type: 'tabs',
                    defaultCollapsed: false
                },
                paymentMethodOrder: ['card', 'apple_pay', 'google_pay'],
                fields: {
                    billingDetails: {
                        name: 'auto',
                        email: 'auto',
                        phone: 'auto',
                        address: {
                            postalCode: 'auto'
                        }
                    }
                }
            });
            const mountTarget = document.getElementById('stripe-payment-element');
            if (!mountTarget) {
                throw new Error('Payment element container not found');
            }
            mountTarget.innerHTML = '';
            await new Promise((resolve, reject) => {
                let mounted = false;
                let readyFired = false;
                paymentElement.mount('#stripe-payment-element');
                paymentElement.on('ready', () => {
                    console.log('‚úÖ Payment element mounted and ready');
                    paymentElementReady = true;
                    mounted = true;
                    readyFired = true;
                    resolve();
                });
                paymentElement.on('loaderror', (error) => {
                    console.error('‚ùå Payment element load error:', error);
                    reject(new Error(error.error?.message || 'Failed to load payment form'));
                });
                let paymentElementComplete = false;
                paymentElement.on('change', (event) => {
                    console.log('üîÑ Payment element change event:', event);
                    paymentElementComplete = event.complete;
                    if (event.complete) {
                        console.log('‚úÖ Payment details complete');
                    }
                    if (event.error) {
                        console.warn('‚ö†Ô∏è Payment validation error:', event.error.message);
                    }
                    if (event.value) {
                        console.log('üí≥ Payment element value:', event.value);
                    }
                });
                setTimeout(() => {
                    if (!readyFired) {
                        console.warn('‚ö†Ô∏è Payment element ready event timeout');
                        const elementInDom = document.querySelector('#stripe-payment-element iframe');
                        if (elementInDom) {
                            console.log('‚úÖ Payment element iframe found in DOM, assuming ready');
                            paymentElementReady = true;
                            resolve();
                        } else {
                            reject(new Error('Payment element failed to mount'));
                        }
                    }
                }, 8000);
            });
        } catch (error) {
            console.error('‚ùå Payment setup error:', error);
            paymentMessage.textContent = 'Unable to load payment form. Please try again or contact support.';
            paymentMessage.classList.remove('hidden');
            paymentMessage.className = 'mt-4 text-sm text-red-600 p-3 bg-red-50 rounded-warm';
            setTimeout(() => {
                document.getElementById('paymentModal').classList.add('hidden');
            }, 3000);
        }
    }

    async function processPayment(event) {
        event.preventDefault();
        const submitBtn = document.getElementById('submitPayment');
        const btnText = document.getElementById('paymentButtonText');
        const paymentMessage = document.getElementById('paymentMessage');
        if (!stripe) {
            alert('Payment system not initialized. Please refresh the page.');
            return;
        }
        if (!elements || !paymentElement) {
            alert('Payment form not ready. Please close and reopen the payment window.');
            return;
        }
        if (!paymentElementReady) {
            alert('Payment form is still loading. Please wait a moment and try again.');
            return;
        }
        const elementInDom = document.querySelector('#stripe-payment-element iframe');
        if (!elementInDom) {
            console.error('‚ùå Payment element iframe not found in DOM');
            alert('Payment form not properly loaded. Please close and reopen the payment window.');
            return;
        }
        if (!selectedPricingOption) {
            alert('No pricing option selected. Please go back and select an option.');
            return;
        }
        console.log('‚úÖ All validation checks passed, proceeding with payment');
        submitBtn.disabled = true;
        btnText.textContent = 'Processing payment...';
        paymentMessage.classList.add('hidden');
        debugPricingFlow('PAYMENT_PROCESSING', null);
        try {
            console.log('üîÑ Confirming payment for amount:', selectedPricingOption.pricing.total);

            // First validate the payment element is complete
            const paymentElement = elements.getElement('payment');
            if (!paymentElement) {
                throw new Error('Payment element not found. Please refresh and try again.');
            }

            console.log('üîç Validating payment details before submission...');

            // Debug: Check elements state
            console.log('üîç Elements object:', elements);
            console.log('üîç Payment element object:', paymentElement);

            // Try to get the current value of the payment element
            try {
                const elementValue = await paymentElement.getValue();
                console.log('üîç Payment element current value:', elementValue);
            } catch (valueError) {
                console.warn('‚ö†Ô∏è Could not get payment element value:', valueError);
            }

            // Check if payment details are complete
            let paymentDetailsComplete = false;
            try {
                console.log('üîç Calling elements.submit()...');
                const { error: submitError } = await elements.submit();
                if (submitError) {
                    console.error('‚ùå Submit validation error:', submitError);
                    if (submitError.message.includes('incomplete') || submitError.message.includes('required')) {
                        throw new Error('Please complete all payment details before continuing.');
                    }
                    throw new Error(submitError.message);
                }
                paymentDetailsComplete = true;
                console.log('‚úÖ Payment details validated successfully');
            } catch (submitErr) {
                console.error('‚ùå Payment validation failed:', submitErr.message);
                throw new Error('Please fill in all payment details before continuing.');
            }

            if (!paymentDetailsComplete) {
                throw new Error('Please complete your payment information.');
            }

            console.log('üîç About to call stripe.confirmPayment with params:', {
                elementsExists: !!elements,
                returnUrl: `${window.location.origin}${window.location.pathname}#success`
            });

            const { error, paymentIntent } = await stripe.confirmPayment({
                elements,
                confirmParams: {
                    return_url: `${window.location.origin}${window.location.pathname}#success`,
                    payment_method_data: {
                        billing_details: {
                            name: formData.name,
                            email: formData.email,
                            phone: formData.phone,
                            address: {
                                postal_code: formData.zip
                            }
                        }
                    }
                },
                redirect: 'if_required'
            });
            if (error) {
                throw new Error(error.message);
            }
            // üîê AUTHORIZATION HOLD FLOW: Check for 'requires_capture' status
            // This means funds are authorized (held) on customer's card but NOT captured yet
            console.log('üîç Payment Intent Status Debug:', {
                id: paymentIntent?.id,
                status: paymentIntent?.status,
                amount: paymentIntent?.amount,
                capture_method: paymentIntent?.capture_method,
                charges: paymentIntent?.charges?.data?.[0]?.captured,
                latest_charge: paymentIntent?.latest_charge,
                charges_data: paymentIntent?.charges?.data
            });

            // üö® CRITICAL DEBUGGING: Log full payment intent details
            console.log('üîç FULL Payment Intent Object:', JSON.stringify(paymentIntent, null, 2));

            if (paymentIntent && (paymentIntent.status === 'requires_capture' || paymentIntent.status === 'succeeded')) {
                console.log('‚úÖ Payment authorization successful:', paymentIntent.id, 'Status:', paymentIntent.status);

                if (paymentIntent.status === 'requires_capture') {
                    console.log('üí≥ ‚úÖ CORRECT: Funds authorized and held on customer card (48hr hold)');

                    // Show user-friendly confirmation message
                    const holdMessage = document.createElement('div');
                    holdMessage.className = 'mt-4 p-4 bg-warm-50 border border-warm-200 rounded-warm text-warm-800';
                    holdMessage.innerHTML = `
                        <div class="flex items-center mb-2">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            <strong>Payment Authorization Successful</strong>
                        </div>
                        <p class="text-sm mb-2">‚úÖ $${(paymentIntent.amount / 100).toFixed(2)} has been <strong>authorized (held)</strong> on your payment method</p>
                        <p class="text-sm text-green-700">
                            üì± <strong>Important:</strong> This may appear as a "pending charge" on your bank/credit card app, but <strong>you have NOT been charged yet</strong>.
                            The funds are simply held and will only be captured after your handyman completes the work.
                        </p>
                    `;

                    // Find payment modal content and add message
                    const paymentModal = document.getElementById('paymentModal');
                    if (paymentModal) {
                        const existingMessage = paymentModal.querySelector('.authorization-hold-message');
                        if (existingMessage) existingMessage.remove();
                        holdMessage.classList.add('authorization-hold-message');
                        const modalContent = paymentModal.querySelector('.bg-white');
                        if (modalContent) modalContent.appendChild(holdMessage);
                    }

                    // Extra validation: Check if charge is actually captured
                    const charge = paymentIntent?.charges?.data?.[0];
                    if (charge) {
                        console.log('üí≥ üîç CHARGE DETAILS:', {
                            id: charge.id,
                            captured: charge.captured,
                            amount_captured: charge.amount_captured,
                            status: charge.status
                        });

                        if (charge.captured === true) {
                            console.log('üí≥ üö® ERROR: Charge shows as captured despite requires_capture status!');
                            alert('‚ö†Ô∏è WARNING: Payment may have been charged immediately instead of held. Please check your bank account and contact support if needed.');
                        } else {
                            console.log('üí≥ ‚úÖ CONFIRMED: Charge is properly held, not captured');
                        }
                    }
                } else if (paymentIntent.status === 'succeeded') {
                    console.log('üí≥ ‚ùå WARNING: Payment completed immediately - authorization hold may have failed!');
                    console.log('üí≥ Expected: requires_capture, Got: succeeded');
                    alert('‚ö†Ô∏è WARNING: Payment was processed immediately instead of being held. This should not happen. Please contact support.');
                }

                paymentIntentId = paymentIntent.id;
                document.getElementById('paymentModal').classList.add('hidden');
                showTaskInfoModal(); // This will create the task and trigger notifications
            } else if (paymentIntent && paymentIntent.status === 'requires_action') {
                console.log('‚è≥ Payment requires additional authentication');
                btnText.textContent = 'Authenticating...';
            } else {
                throw new Error('Payment was not completed successfully');
            }
        } catch (error) {
            console.error('‚ùå Payment failed:', error);
            let userMessage = 'Payment failed. Please try again.';
            if (error.message.includes('incomplete')) {
                userMessage = 'Please complete all payment details.';
            } else if (error.message.includes('card_declined')) {
                userMessage = 'Your card was declined. Please try a different card.';
            } else if (error.message.includes('insufficient_funds')) {
                userMessage = 'Insufficient funds. Please try a different card.';
            } else if (error.message.includes('expired_card')) {
                userMessage = 'Your card has expired. Please try a different card.';
            } else if (error.message.includes('incorrect_cvc')) {
                userMessage = 'Incorrect CVC code. Please check and try again.';
            } else if (error.message.includes('processing_error')) {
                userMessage = 'Processing error. Please try again in a moment.';
            } else if (error.message) {
                userMessage = error.message;
            }
            paymentMessage.textContent = userMessage;
            paymentMessage.classList.remove('hidden');
            paymentMessage.className = 'mt-4 text-sm text-red-600 p-3 bg-red-50 rounded-warm border border-red-200';
            submitBtn.disabled = false;
            btnText.textContent = 'Complete Payment';
        }
    }

    function showTaskInfoModal() {
        const taskId = generateTaskId();
        window.currentTaskId = taskId;
        const paidAmount = selectedPricingOption.pricing.total;
        document.getElementById('summaryTaskId').textContent = taskId;
        document.getElementById('summaryName').textContent = formData.name;
        document.getElementById('summaryPhone').textContent = formData.phone;
        document.getElementById('summaryEmail').textContent = formData.email;
        document.getElementById('summaryTask').textContent = TASKS[formData.category]?.label || formData.category;
        document.getElementById('summaryWindow').textContent = selectedPricingOption.windowLabel;
        document.getElementById('summaryDescription').textContent = formData.description || 'None provided';
        document.getElementById('summaryAmount').textContent = '$' + paidAmount.toFixed(2);
        document.getElementById('contactPhone').value = formData.phone;
        document.getElementById('taskInfoModal').classList.remove('hidden');
    }

    async function submitTaskInfo(event) {
        event.preventDefault();
        const propertyAddress = document.getElementById('propertyAddress').value;
        const addressValidation = validatePropertyAddress(propertyAddress);
        if (!addressValidation.valid) {
            alert('Address Error: ' + addressValidation.message);
            document.getElementById('propertyAddress').focus();
            return;
        }
        const submitBtn = event.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'üì§ Sending notification...';
        const taskId = window.currentTaskId;
        const currentFormData = saveFormData();
        if (!currentFormData.name || !currentFormData.phone || !currentFormData.email || !currentFormData.category) {
            console.error('‚ùå Missing critical form data');
            alert('Critical form data is missing. Please refresh and try again.');
            submitBtn.disabled = false;
            submitBtn.textContent = 'üöÄ Dispatch Handyman';
            return;
        }
        const completeJobData = {
            task_id: taskId,
            payment_intent_id: paymentIntentId,
            category: currentFormData.category,
            window: selectedPricingOption.window,
            name: currentFormData.name,
            phone: currentFormData.phone,
            email: currentFormData.email,
            zip: currentFormData.zip,
            address: currentFormData.address || '',
            description: currentFormData.description || '',
            rush: currentFormData.rush || false,
            property_address: propertyAddress,
            contact_phone: document.getElementById('contactPhone').value,
            access_details: document.getElementById('accessDetails').value || '',
            pets_and_special: document.getElementById('petsAndSpecial').value || '',
            additional_details: document.getElementById('additionalDetails').value || '',
            estimated_hours: estimateData.hours,
            total_amount: selectedPricingOption.pricing.total,
            base_amount: selectedPricingOption.pricing.base,
            premiums: selectedPricingOption.pricing.premiums || [],
            step_scope: estimateData.step_scope || [],
            risk_flags: estimateData.risk_flags || [],
            customer: {
                name: currentFormData.name,
                phone: currentFormData.phone,
                email: currentFormData.email,
                zip: currentFormData.zip,
                address: currentFormData.address || '',
                category: currentFormData.category,
                window: selectedPricingOption.window,
                description: currentFormData.description || '',
                rush: currentFormData.rush || false
            },
            task_info: {
                property_address: propertyAddress,
                contact_phone: document.getElementById('contactPhone').value,
                access_details: document.getElementById('accessDetails').value || '',
                pets_and_special: document.getElementById('petsAndSpecial').value || '',
                additional_details: document.getElementById('additionalDetails').value || ''
            },
            estimate: {
                hours: estimateData.hours,
                pricing: selectedPricingOption.pricing,
                step_scope: estimateData.step_scope || [],
                risk_flags: estimateData.risk_flags || []
            },
            amount: selectedPricingOption.pricing.total
        };
        // üóÑÔ∏è STEP 1: Create task in database
        try {
            const taskResponse = await fetch('/.netlify/functions/create-task', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(completeJobData)
            });

            if (!taskResponse.ok) {
                const errorData = await taskResponse.json();
                throw new Error(`Task creation failed: ${errorData.detail || 'Unknown error'}`);
            }

            const taskResult = await taskResponse.json();
            console.log('‚úÖ Task created in database:', taskResult.task_id);
        } catch (taskError) {
            console.error('‚ùå Task creation failed:', taskError);
            alert('Failed to create task in database. Please contact support.');
            submitBtn.disabled = false;
            submitBtn.textContent = 'üöÄ Dispatch Handyman';
            return;
        }

        // üì± STEP 2: Send SMS notification
        try {
            await sendSMSNotification('booking_confirmation', {
                customer_phone: completeJobData.phone,
                task_id: taskId,
                service_name: TASKS[completeJobData.category]?.label,
                time_window: TIME_WINDOWS[completeJobData.window]?.label || completeJobData.window,
                total_amount: selectedPricingOption.pricing.total.toFixed(0)
            });
        } catch (smsError) {
            console.log('üì± SMS failed but continuing:', smsError);
        }

        // üìß STEP 3: Send Zapier notification
        try {
            await sendZapierNotification(completeJobData);
        } catch (zapierError) {
            console.error('‚ùå Zapier notification failed:', zapierError);
        }
        try {
            const response = await fetch('/.netlify/functions/send-notification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(completeJobData)
            });
            if (response.ok) {
                const result = await response.json();
                console.log('‚úÖ Notification sent successfully:', result);
            }
        } catch (error) {
            console.error('‚ùå Notification error:', error);
        }
        document.getElementById('finalTaskId').textContent = taskId;
        document.getElementById('finalPaidAmount').textContent = '$' + selectedPricingOption.pricing.total.toFixed(2);
        document.getElementById('taskInfoModal').classList.add('hidden');
        document.getElementById('finalSuccessModal').classList.remove('hidden');
    }

    function initializeMobileMenu() {
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        mobileMenuBtn.addEventListener('click', () => {
            mobileMenu.classList.toggle('active');
        });
        document.querySelectorAll('#mobile-menu a').forEach(link => {
            link.addEventListener('click', () => {
                mobileMenu.classList.remove('active');
            });
        });
        document.addEventListener('click', (e) => {
            if (!mobileMenuBtn.contains(e.target) && !mobileMenu.contains(e.target)) {
                mobileMenu.classList.remove('active');
            }
        });
    }

    function initializeChatbot() {
        const chatToggle = document.getElementById('chatbot-toggle');
        const chatWindow = document.getElementById('chatbot-window');
        const chatClose = document.getElementById('chatbot-close');
        const chatInput = document.getElementById('chatbot-input');
        const chatSend = document.getElementById('chatbot-send');
        const chatMessages = document.getElementById('chatbot-messages');
        let conversationHistory = [];
        let isOpen = false;
        chatToggle.addEventListener('click', () => {
            isOpen = !isOpen;
            if (isOpen) {
                chatWindow.classList.remove('hidden');
                chatInput.focus();
            } else {
                chatWindow.classList.add('hidden');
            }
        });
        chatClose.addEventListener('click', () => {
            isOpen = false;
            chatWindow.classList.add('hidden');
        });
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        chatSend.addEventListener('click', sendMessage);
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            addMessage(message, 'user');
            chatInput.value = '';
            const typingIndicator = addTypingIndicator();
            try {
                const response = await fetch('/.netlify/functions/chatbot', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        conversationHistory: conversationHistory
                    })
                });
                typingIndicator.remove();
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const result = await response.json();
                if (result.error) {
                    addMessage(result.error, 'bot', true);
                } else {
                    addMessage(result.reply, 'bot');
                }
                conversationHistory.push(
                    { role: 'human', content: message },
                    { role: 'assistant', content: result.reply || 'Error occurred' }
                );
                if (conversationHistory.length > 20) {
                    conversationHistory = conversationHistory.slice(-20);
                }
            } catch (error) {
                console.error('Chatbot error:', error);
                typingIndicator.remove();
                addMessage('Sorry, I\'m having trouble connecting right now. Please try again or contact us directly at info@sendahandyman.com', 'bot', true);
            }
        }
        function addMessage(content, sender, isError = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start space-x-2';
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="flex-1"></div>
                    <div class="bg-warm-600 text-white rounded-warm p-3 max-w-xs">
                        <p class="text-sm">${escapeHtml(content)}</p>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center flex-shrink-0">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0">
                        <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                    </div>
                    <div class="bg-warm-100 rounded-warm p-3 max-w-xs ${isError ? 'border border-red-200 bg-red-50' : ''}">
                        <p class="text-sm text-slate-700">${formatBotMessage(content)}</p>
                    </div>
                `;
            }
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        function addTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'flex items-start space-x-2';
            typingDiv.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                </div>
                <div class="bg-warm-100 rounded-warm p-3">
                    <p class="text-sm text-slate-500 chatbot-typing">Typing</p>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return typingDiv;
        }
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        function formatBotMessage(content) {
            return escapeHtml(content)
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
        }
        console.log('‚úÖ Chatbot initialized');
    }

    // Service selection and step navigation functions
    function selectService(taskKey) {
        console.log('üéØ Selecting service:', taskKey);

        // Update the dropdown
        const taskSelect = document.getElementById('taskCategory');
        if (taskSelect) {
            taskSelect.value = taskKey;
        }

        // Show selected service in the display
        const selectedTaskDisplay = document.getElementById('selectedTaskDisplay');
        const selectedTaskName = document.getElementById('selectedTaskName');
        const selectedTaskPrice = document.getElementById('selectedTaskPrice');

        if (selectedTaskDisplay && selectedTaskName && selectedTaskPrice) {
            const serviceData = getServiceData(taskKey);
            console.log('üîß Service data for', taskKey, ':', serviceData);

            selectedTaskName.textContent = serviceData.name;
            selectedTaskPrice.textContent = serviceData.price;

            // Populate task details if available
            const includedList = document.getElementById('selectedTaskIncluded');
            const addonsList = document.getElementById('selectedTaskAddons');

            console.log('üìã Task detail elements:', {
                includedList: !!includedList,
                addonsList: !!addonsList,
                hasIncluded: !!serviceData.included,
                hasAddons: !!serviceData.addons
            });

            if (includedList && serviceData.included) {
                includedList.innerHTML = serviceData.included
                    .map(item => `<li>‚Ä¢ ${item}</li>`)
                    .join('');
                console.log('‚úÖ Populated included items:', serviceData.included.length);
            }

            if (addonsList && serviceData.addons) {
                addonsList.innerHTML = serviceData.addons
                    .map(item => `<li>‚Ä¢ ${item}</li>`)
                    .join('');
                console.log('‚ö†Ô∏è Populated addon items:', serviceData.addons.length);
            }

            selectedTaskDisplay.classList.remove('hidden');
        }

        // Enable continue button
        updateContinueButton();

        // Close all service details
        document.querySelectorAll('.service-details').forEach(details => {
            details.classList.add('hidden');
        });
        document.querySelectorAll('.expand-icon').forEach(icon => {
            icon.style.transform = 'rotate(0deg)';
        });

        // Navigate to booking section where additional information is requested
        setTimeout(() => {
            document.getElementById('book').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }, 300);
    }

    function getServiceData(taskKey) {
        const serviceMap = {
            'tv_mount': {
                name: 'üì∫ TV Wall Mount (32‚Äì65")',
                price: '~2.0 hr base ‚Ä¢ Starting at $160',
                included: [
                    'Mounting TV (32‚Äì65") on drywall with wood studs',
                    'Using customer-supplied mount',
                    'Cord cover (if provided)',
                    'Level installation and cable management'
                ],
                addons: [
                    '+$40: Mounting on brick, concrete, or over fireplace',
                    '+$50: TVs larger than 65"',
                    'New outlet/electrical work not included'
                ]
            },
            'ceiling_fan': {
                name: 'üí° Ceiling Fan Install/Replace',
                price: '~2.0 hr base ‚Ä¢ Starting at $160',
                included: [
                    'Remove old fixture and install new ceiling fan',
                    'Using existing electrical junction box',
                    'Basic wiring and switch connection',
                    'Test all functions (lights, fan speeds)'
                ],
                addons: [
                    '+$50: Installing new electrical box if needed',
                    '+$30: Remote control setup',
                    'New electrical wiring not included'
                ]
            },
            'light_fixture': {
                name: '‚ú® Light Fixture / Chandelier Swap',
                price: '~1.5 hr base ‚Ä¢ Starting at $120',
                included: [
                    'Remove old fixture and install new light fixture',
                    'Connect to existing wiring',
                    'Test functionality and switches',
                    'Basic fixture mounting'
                ],
                addons: [
                    '+$40: Heavy chandeliers requiring additional support',
                    '+$20: Dimmer switch installation',
                    'New electrical wiring not included'
                ]
            },
            'faucet_showerhead': {
                name: 'üö∞ Faucet / Showerhead Replace',
                price: '~1.5 hr base ‚Ä¢ Starting at $120',
                included: [
                    'Remove old faucet/showerhead',
                    'Install new fixture using existing connections',
                    'Test for leaks and proper water pressure',
                    'Basic cleaning of work area'
                ],
                addons: [
                    '+$50: New water supply lines if needed',
                    '+$30: Shut-off valve replacement',
                    'Plumbing modifications not included'
                ]
            },
            'smart_doorbell': {
                name: 'üîî Smart Doorbell Install',
                price: '~1.25 hr base ‚Ä¢ Starting at $100',
                included: [
                    'Install smart doorbell using existing wiring',
                    'Connect to home WiFi network',
                    'Basic app setup and testing',
                    'Mount doorbell and chime setup'
                ],
                addons: [
                    '+$40: New doorbell wiring installation',
                    '+$20: Transformer upgrade if needed',
                    'Advanced smart home integration extra'
                ]
            },
            'curtains_blinds': {
                name: 'ü™ü Curtain Rods / Blinds',
                price: 'Per item pricing ‚Ä¢ Starting at $80',
                included: [
                    'Professional installation per item',
                    'Mount brackets securely into studs',
                    'Hang curtains or mount blinds',
                    'Test operation and adjustments'
                ],
                addons: [
                    '1 item: $80 (1 hour)',
                    '2 items: $120 (1.5 hours)',
                    '3+ items: $40 per additional (+30 min)',
                    '+$40: Installation on brick/concrete walls',
                    'Custom cutting/hemming not included'
                ]
            },
            'floating_shelf': {
                name: 'üìö Floating Shelf Install',
                price: 'Per item pricing ‚Ä¢ Starting at $80',
                included: [
                    'Professional installation per shelf',
                    'Level mounting for straight installation',
                    'Secure mounting for typical shelf loads',
                    'Test stability and load capacity'
                ],
                addons: [
                    '1 shelf: $80 (1 hour)',
                    '2 shelves: $120 (1.5 hours)',
                    '3+ shelves: $40 per additional (+30 min)',
                    '+$30: Heavy-duty brackets for extra weight',
                    '+$40: Installation on brick/concrete walls'
                ]
            },
            'appliance_hookup': {
                name: '‚ö° Appliance Hookup (W/D/DW)',
                price: '~2.0 hr base ‚Ä¢ Starting at $160',
                included: [
                    'Connect washer, dryer, or dishwasher to existing hookups',
                    'Test all connections and functionality',
                    'Basic leveling and adjustments',
                    'Run test cycle to ensure proper operation'
                ],
                addons: [
                    '+$80: New water line or electrical connection',
                    '+$50: Vent installation or modification',
                    'Major plumbing/electrical work separate'
                ]
            },
            'furniture_assembly': {
                name: 'ü™ë Furniture Assembly (S‚ÄìM)',
                price: '~2.0 hr base ‚Ä¢ Starting at $160',
                included: [
                    'Complete assembly of small-medium furniture',
                    'Follow manufacturer instructions precisely',
                    'Ensure all joints are secure and level',
                    'Clean up packaging materials'
                ],
                addons: [
                    '+$50: Large/complex furniture (beds, armoires)',
                    '+$30: Wall mounting for safety',
                    'Furniture moving/placement in home'
                ]
            },
            'closet_organizer': {
                name: 'üëï Closet Organizer Install',
                price: '~2.5 hr base ‚Ä¢ Starting at $200',
                included: [
                    'Install closet organization system components',
                    'Mount shelves, rods, and organizer units',
                    'Ensure level and secure installation',
                    'Test all moving parts and adjustments'
                ],
                addons: [
                    '+$50: Custom cutting or modifications',
                    '+$30: Additional hardware or brackets',
                    'Closet clean-out service available separately'
                ]
            },
            'premium_moveout': {
                name: 'üè† Premium Move-Out Removal (Includes Patching & Cleanup)',
                price: '~3.0 hr base ‚Ä¢ Starting at $300',
                included: [
                    'Remove mounted items and hardware',
                    'Patch all holes with spackling compound',
                    'Sand smooth and touch-up paint',
                    'Clean and sweep work areas'
                ],
                addons: [
                    '+$100: Full room repainting',
                    '+$50: Deep cleaning service',
                    'Large furniture removal separate'
                ]
            },
            'general_handyman': {
                name: 'üîß General Handyman (3+ hours)',
                price: '~3 hr minimum ‚Ä¢ Starting at $240',
                included: [
                    'Comprehensive handyman services',
                    'Multiple small tasks in one visit',
                    'Professional consultation and assessment',
                    'Detailed work completion report'
                ],
                addons: [
                    'Pricing varies by specific tasks requested',
                    'Material costs additional',
                    'Electrical/plumbing work may require specialist'
                ]
            }
        };
        return serviceMap[taskKey] || {
            name: 'Unknown Service',
            price: 'Price varies',
            included: ['Service details will be provided upon selection'],
            addons: ['Additional services available upon request']
        };
    }

    function showStep(stepId) {
        console.log('üìã Showing step:', stepId);

        // Hide all booking steps
        document.querySelectorAll('.booking-step').forEach(step => {
            step.classList.add('hidden');
        });

        // Show the requested step
        const targetStep = document.getElementById(stepId);
        if (targetStep) {
            targetStep.classList.remove('hidden');

            // If moving to questions step, show questions for selected task
            if (stepId === 'step-questions') {
                const taskSelect = document.getElementById('taskCategory');
                if (taskSelect && taskSelect.value) {
                    showTaskQuestions(taskSelect.value);
                }
            }
        }

    }

    function showPricingStep(stepId) {
        console.log('üí∞ Showing pricing step:', stepId);

        // Hide all pricing steps
        document.querySelectorAll('.pricing-step').forEach(step => {
            step.classList.add('hidden');
        });

        // Show the requested step
        const targetStep = document.getElementById(stepId);
        if (targetStep) {
            targetStep.classList.remove('hidden');
        }
    }

    function updateContinueButton() {
        const taskSelect = document.getElementById('taskCategory');
        const continueBtn = document.getElementById('continueToTimingBtn');
        const selectedDisplay = document.getElementById('selectedTaskDisplay');

        if (continueBtn && taskSelect) {
            const hasSelection = taskSelect.value || !selectedDisplay.classList.contains('hidden');
            continueBtn.disabled = !hasSelection;
        }
    }

    function validatePersonalInfo() {
        const name = document.getElementById('customerName').value.trim();
        const phone = document.getElementById('customerPhone').value.trim();
        const email = document.getElementById('customerEmail').value.trim();
        const zip = document.getElementById('customerZip').value.trim();
        const reserveBtn = document.getElementById('reserveBtn');

        const isValid = name && phone && email && zip;

        if (reserveBtn) {
            reserveBtn.disabled = !isValid;
        }
    }

    function validateTaskDescription() {
        const descriptionField = document.getElementById('taskDescription');
        const getEstimateBtn = document.getElementById('getEstimateBtn');

        if (!descriptionField || !getEstimateBtn) return;

        const description = descriptionField.value.trim();
        const isValid = description.length > 0;

        // Update button state
        getEstimateBtn.disabled = !isValid;

        // Update field styling
        if (description.length > 0) {
            descriptionField.style.borderColor = '';
        } else {
            // Only show red border if user has started typing and then cleared it
            if (descriptionField.dataset.touched === 'true') {
                descriptionField.style.borderColor = '#ef4444';
            }
        }

        // Mark field as touched when user starts typing
        if (description.length > 0 && !descriptionField.dataset.touched) {
            descriptionField.dataset.touched = 'true';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        console.log('üöÄ DOM Content Loaded - Initializing app...');
        console.log('üìä App Version:', APP_VERSION);

        // Check for booking data from Uber-style interface
        checkForUberBookingData();

        function checkForUberBookingData() {
            console.log('üîç Checking for Uber booking data...');

            const keys = ['uberBookingData', 'prefilledService', 'sendahandyman_booking'];
            let bookingData = null;

            for (const key of keys) {
                const stored = sessionStorage.getItem(key);
                if (stored) {
                    try {
                        bookingData = JSON.parse(stored);
                        console.log(`‚úÖ Found booking data in ${key}:`, bookingData);
                        break;
                    } catch (e) {
                        console.warn(`‚ö†Ô∏è Invalid JSON in ${key}:`, e);
                    }
                }
            }

            if (bookingData && bookingData.fromUberInterface) {
                console.log('üéØ Processing Uber interface booking data...');
                processUberBookingData(bookingData);
            } else {
                console.log('‚ÑπÔ∏è No Uber booking data found, proceeding normally');
            }
        }

        function processUberBookingData(data) {
            console.log('üîÑ Processing booking data:', data);

            // Auto-populate form fields if available
            if (data.description) {
                const descField = document.getElementById('taskDescription');
                if (descField) {
                    descField.value = data.description;
                    console.log('üìù Pre-filled description');
                }
            }

            if (data.location) {
                const locationField = document.getElementById('taskLocation');
                if (locationField) {
                    locationField.value = data.location;
                    console.log('üìç Pre-filled location');
                }
            }

            // Show a notification that we received booking data
            setTimeout(() => {
                if (typeof showToast === 'function') {
                    showToast('Booking details transferred from selection interface', 'success', 3000);
                }
            }, 1000);

            // Clear the session data to prevent reuse
            setTimeout(() => {
                sessionStorage.removeItem('uberBookingData');
                sessionStorage.removeItem('prefilledService');
                sessionStorage.removeItem('sendahandyman_booking');
                console.log('üßπ Cleared session storage');
            }, 5000);
        }
        function populateTimeWindows() {
            const select = document.getElementById('taskWindow');
            if (!select) {
                console.error('‚ùå taskWindow select element not found');
                return;
            }
            const availableWindows = getAvailableTimeWindows();
            select.innerHTML = '<option value="flexible">I\'m flexible (best value)</option>';
            const separator = document.createElement('option');
            separator.disabled = true;
            separator.textContent = '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';
            select.appendChild(separator);
            availableWindows.forEach(windowKey => {
                const option = document.createElement('option');
                option.value = windowKey;
                option.textContent = TIME_WINDOWS[windowKey].label;
                select.appendChild(option);
            });
            console.log('‚è∞ Available time windows:', availableWindows);
            console.log('‚è∞ Dropdown populated with', select.options.length, 'options (Sundays excluded)');
        }
        try {
            populateTimeWindows();
            setInterval(populateTimeWindows, 60000);
        } catch (error) {
            console.error('‚ùå Error populating time windows:', error);
        }
        function setupDatePicker() {
            const dateInput = document.getElementById('futureDate');
            if (!dateInput) {
                console.error('‚ùå futureDate input not found');
                return;
            }
            const today = new Date();
            const minDate = new Date(today);
            minDate.setDate(minDate.getDate() + 2);
            const maxDate = new Date(today);
            maxDate.setDate(maxDate.getDate() + 14);
            dateInput.min = minDate.toISOString().split('T')[0];
            dateInput.max = maxDate.toISOString().split('T')[0];

            let warningDiv = document.getElementById('datePickerWarning');
            if (!warningDiv) {
                warningDiv = document.createElement('div');
                warningDiv.id = 'datePickerWarning';
                warningDiv.className = 'hidden mt-2 p-2 bg-red-50 border border-red-200 rounded-warm text-xs text-red-700 date-warning';
                dateInput.parentNode.appendChild(warningDiv);
            }

            const validateDate = (e) => {
                if (!e.target.value) {
                    warningDiv.classList.add('hidden');
                    dateInput.classList.remove('has-sunday-warning');
                    return;
                }

                const selectedDate = new Date(e.target.value + 'T00:00:00');

                if (isSunday(selectedDate)) {
                    warningDiv.textContent = 'üö´ SUNDAYS ARE NOT AVAILABLE - Please select Monday-Saturday';
                    warningDiv.classList.remove('hidden');
                    dateInput.classList.add('has-sunday-warning');
                    e.target.value = '';

                    setTimeout(() => {
                        alert('üö´ SUNDAYS NOT AVAILABLE\n\nWe do not offer service on Sundays. Please select Monday-Saturday.');
                    }, 100);
                    return;
                }

                warningDiv.classList.add('hidden');
                dateInput.classList.remove('has-sunday-warning');

                if (isSaturday(selectedDate)) {
                    warningDiv.textContent = 'üìÖ SATURDAY: Only 8AM-12PM available ‚Ä¢ 30% premium (no discount)';
                    warningDiv.classList.remove('hidden');
                    warningDiv.className = 'mt-2 p-2 bg-orange-50 border border-orange-200 rounded-warm text-xs text-orange-700 date-warning';

                    setTimeout(() => {
                        alert('üìÖ SATURDAY BOOKING NOTICE\n\n‚Ä¢ Only 8AM-12PM time slot available\n‚Ä¢ 30% Saturday premium applies\n‚Ä¢ NO 10% future booking discount\n\nNet result: +30% premium for Saturday service');
                    }, 100);
                } else {
                    warningDiv.className = 'hidden mt-2 p-2 bg-red-50 border border-red-200 rounded-warm text-xs text-red-700 date-warning';
                }
            };

            dateInput.addEventListener('change', validateDate);
            dateInput.addEventListener('input', validateDate);

            console.log('üìÖ Date picker configured: min=', dateInput.min, 'max=', dateInput.max, '(Sundays blocked, Saturdays +30%)');
        }
        try {
            setupDatePicker();
        } catch (error) {
            console.error('‚ùå Error setting up date picker:', error);
        }
        initializeStripe();
        console.log('üéØ Zapier webhook configured:', ZAPIER_CONFIG.ENABLED ? 'YES' : 'NO');
        initializeMobileMenu();
        const serviceCards = document.querySelectorAll('.service-card');
        console.log('üé¥ Found', serviceCards.length, 'service cards');
        document.querySelectorAll('.service-card').forEach(card => {
            const header = card.querySelector('.service-header');
            if (header) {
                header.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const taskKey = card.getAttribute('data-task');
                    console.log('üéØ Service card clicked:', taskKey);
                    const details = card.querySelector('.service-details');
                    const icon = card.querySelector('.expand-icon');
                    document.querySelectorAll('.service-card').forEach(otherCard => {
                        if (otherCard !== card) {
                            const otherDetails = otherCard.querySelector('.service-details');
                            const otherIcon = otherCard.querySelector('.expand-icon');
                            if (otherDetails) otherDetails.classList.add('hidden');
                            if (otherIcon) otherIcon.style.transform = 'rotate(0deg)';
                        }
                    });
                    if (details && icon) {
                        if (details.classList.contains('hidden')) {
                            details.classList.remove('hidden');
                            icon.style.transform = 'rotate(180deg)';
                            const taskDropdown = document.getElementById('taskCategory');
                            if (taskDropdown) {
                                taskDropdown.value = taskKey;
                                console.log('‚úÖ Task dropdown set to:', taskKey);
                            }
                            showTaskQuestions(taskKey);
                        } else {
                            details.classList.add('hidden');
                            icon.style.transform = 'rotate(0deg)';
                        }
                    }
                });
                console.log('‚úÖ Event listener added to service card:', card.getAttribute('data-task'));
            } else {
                console.warn('‚ö†Ô∏è Service header not found for card:', card.getAttribute('data-task'));
            }
        });
        const taskCategoryDropdown = document.getElementById('taskCategory');
        if (taskCategoryDropdown) {
            taskCategoryDropdown.addEventListener('change', (e) => {
                const taskKey = e.target.value;
                console.log('üìù Task category changed to:', taskKey);
                if (taskKey) {
                    selectService(taskKey); // This will show the service details
                    showTaskQuestions(taskKey);
                } else {
                    document.getElementById('taskQuestions').classList.add('hidden');
                    document.getElementById('selectedTaskDisplay').classList.add('hidden');
                }
            });
            console.log('‚úÖ Task category dropdown listener added');
        } else {
            console.error('‚ùå Task category dropdown not found');
        }

        // Add event listeners for new service selection buttons
        document.querySelectorAll('.select-service-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const taskKey = btn.getAttribute('data-task');
                console.log('üéØ Service selected via button:', taskKey);
                selectService(taskKey);
            });
        });

        // Add event listeners for step navigation
        const continueToTimingBtn = document.getElementById('continueToTimingBtn');
        const backToTaskBtn = document.getElementById('backToTaskBtn');
        const continueToQuestionsBtn = document.getElementById('continueToQuestionsBtn');
        const backToTimingBtn = document.getElementById('backToTimingBtn');
        const continueToInfoBtn = document.getElementById('continueToInfoBtn');
        const backToPricingBtn = document.getElementById('backToPricingBtn');

        if (continueToTimingBtn) {
            continueToTimingBtn.addEventListener('click', () => showStep('step-timing'));
        }
        if (backToTaskBtn) {
            backToTaskBtn.addEventListener('click', () => showStep('step-task-selection'));
        }
        if (continueToQuestionsBtn) {
            continueToQuestionsBtn.addEventListener('click', () => showStep('step-questions'));
        }
        if (backToTimingBtn) {
            backToTimingBtn.addEventListener('click', () => showStep('step-timing'));
        }
        if (continueToInfoBtn) {
            continueToInfoBtn.addEventListener('click', () => showPricingStep('step-personal-info'));
        }
        if (backToPricingBtn) {
            backToPricingBtn.addEventListener('click', () => showPricingStep('step-pricing'));
        }

        // Change task button - go back to service selection
        const changeTaskBtn = document.getElementById('changeTaskBtn');
        if (changeTaskBtn) {
            changeTaskBtn.addEventListener('click', () => {
                // Get currently selected service
                const currentSelection = document.getElementById('taskCategory').value;

                // Clear selected service from booking form
                document.getElementById('selectedTaskDisplay').classList.add('hidden');
                document.getElementById('taskCategory').value = '';

                // Scroll back to services section
                document.getElementById('tasks').scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });

                // After scrolling, expand the previously selected service for better UX
                if (currentSelection) {
                    setTimeout(() => {
                        const serviceCard = document.querySelector(`[data-task="${currentSelection}"]`);
                        if (serviceCard) {
                            // Highlight the card temporarily
                            serviceCard.style.border = '2px solid #4f46e5';
                            serviceCard.style.backgroundColor = '#f8fafc';

                            // Expand the service details
                            const detailsElement = serviceCard.querySelector('.service-details');
                            const expandIcon = serviceCard.querySelector('.expand-icon');
                            if (detailsElement && expandIcon) {
                                detailsElement.classList.remove('hidden');
                                expandIcon.style.transform = 'rotate(180deg)';
                            }

                            // Remove highlight after 3 seconds
                            setTimeout(() => {
                                serviceCard.style.border = '';
                                serviceCard.style.backgroundColor = '';
                            }, 3000);
                        }
                    }, 800); // Wait for scroll to complete
                }

                // Update continue button state
                updateContinueButton();
            });
        }

        // Make continue buttons responsive to selections
        const taskCategorySelect = document.getElementById('taskCategory');
        if (taskCategorySelect) {
            taskCategorySelect.addEventListener('change', () => {
                updateContinueButton();
            });
        }

        // Add validation for personal information form
        const personalInfoInputs = ['customerName', 'customerPhone', 'customerEmail', 'customerZip'];
        personalInfoInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                input.addEventListener('input', validatePersonalInfo);
            }
        });
        console.log('‚úÖ Service selection system initialized');
        const photoInput = document.getElementById('taskPhotos');
        if (photoInput) {
            photoInput.addEventListener('change', (e) => {
                const thumbs = document.getElementById('photoThumbs');
                if (thumbs) {
                    thumbs.innerHTML = '';
                    [...e.target.files].slice(0, 5).forEach(file => {
                        const url = URL.createObjectURL(file);
                        const img = document.createElement('img');
                        img.src = url;
                        img.className = 'h-16 w-16 object-cover rounded-warm border border-warm-200';
                        thumbs.appendChild(img);
                    });
                }
            });
            console.log('‚úÖ Photo upload listener added');
        } else {
            console.error('‚ùå Photo input not found');
        }
        const getEstimateBtn = document.getElementById('getEstimateBtn');
        if (getEstimateBtn) {
            getEstimateBtn.addEventListener('click', generateEstimate);
            console.log('‚úÖ Get estimate button listener added');
        } else {
            console.error('‚ùå Get estimate button not found');
        }

        // Add validation for task description field
        const taskDescriptionField = document.getElementById('taskDescription');
        if (taskDescriptionField) {
            taskDescriptionField.addEventListener('input', validateTaskDescription);
            console.log('‚úÖ Task description validation listener added');
        }
        const reserveBtn = document.getElementById('reserveBtn');
        if (reserveBtn) {
            reserveBtn.addEventListener('click', showPaymentModal);
            console.log('‚úÖ Reserve button listener added');
        } else {
            console.error('‚ùå Reserve button not found');
        }
        const paymentForm = document.getElementById('paymentForm');
        if (paymentForm) {
            paymentForm.addEventListener('submit', processPayment);
            console.log('‚úÖ Payment form listener added');
        } else {
            console.error('‚ùå Payment form not found');
        }
        const closePaymentBtn = document.getElementById('closePayment');
        if (closePaymentBtn) {
            closePaymentBtn.addEventListener('click', () => {
                if (paymentElement) {
                    try {
                        paymentElement.unmount();
                    } catch (e) {
                        console.log('Payment element cleanup:', e.message);
                    }
                    paymentElement = null;
                }
                if (elements) {
                    elements = null;
                }
                paymentElementReady = false;
                document.getElementById('paymentModal').classList.add('hidden');
            });
            console.log('‚úÖ Close payment button listener added');
        }
        const taskInfoForm = document.getElementById('taskInfoForm');
        if (taskInfoForm) {
            taskInfoForm.addEventListener('submit', submitTaskInfo);
            console.log('‚úÖ Task info form listener added');
        } else {
            console.error('‚ùå Task info form not found');
        }
        const closeFinalSuccessBtn = document.getElementById('closeFinalSuccess');
        if (closeFinalSuccessBtn) {
            closeFinalSuccessBtn.addEventListener('click', () => {
                document.getElementById('finalSuccessModal').classList.add('hidden');
                location.reload();
            });
            console.log('‚úÖ Close final success button listener added');
        }
        document.getElementById('year').textContent = new Date().getFullYear();
        document.getElementById('version').textContent = APP_VERSION;
        console.log('üéØ All event listeners initialized successfully');
        initializeChatbot();
        initializeCoverageMap();
        optimizeForMobile();
        initAIPhotoTriage();
    });

    // Coverage Map Functionality
    let coverageMap = null;
    let currentCoverageArea = 'florida';

    function initializeCoverageMap() {
        console.log('üó∫Ô∏è Initializing coverage area map...');

        // Initialize the map
        coverageMap = L.map('coverage-map', {
            zoomControl: true,
            scrollWheelZoom: false,
            doubleClickZoom: false,
            dragging: true,
            touchZoom: true
        });

        // Add map tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(coverageMap);

        // Set up tab functionality
        setupCoverageTabs();

        // Show Florida by default
        showCoverageArea('florida');

        console.log('‚úÖ Coverage map initialized successfully');
    }

    function setupCoverageTabs() {
        const floridaTab = document.getElementById('florida-tab');
        const austinTab = document.getElementById('austin-tab');

        if (floridaTab) {
            floridaTab.addEventListener('click', () => {
                switchCoverageTab('florida');
            });
        }

        if (austinTab) {
            austinTab.addEventListener('click', () => {
                switchCoverageTab('austin');
            });
        }
    }

    function switchCoverageTab(area) {
        // Update tab appearance
        document.querySelectorAll('.coverage-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.getElementById(`${area}-tab`).classList.add('active');

        // Update details display
        document.querySelectorAll('.coverage-details').forEach(details => {
            details.classList.add('hidden');
        });
        document.getElementById(`${area}-details`).classList.remove('hidden');

        // Update map
        showCoverageArea(area);
        currentCoverageArea = area;
    }

    function showCoverageArea(area) {
        if (!coverageMap) return;

        // Clear existing layers
        coverageMap.eachLayer((layer) => {
            if (layer instanceof L.Polygon || layer instanceof L.Circle || layer instanceof L.Marker) {
                coverageMap.removeLayer(layer);
            }
        });

        if (area === 'florida') {
            // South Florida coverage area
            const floridaBounds = [
                [25.7617, -80.1918], // Miami
                [26.3683, -80.1289], // Boca Raton
                [26.7153, -80.0534], // West Palm Beach
                [26.1224, -80.1373], // Fort Lauderdale
            ];

            // Create coverage polygon
            const floridaPolygon = L.polygon([
                [25.6, -80.6], // SW corner
                [27.0, -80.6], // NW corner
                [27.0, -79.8], // NE corner
                [25.6, -79.8]  // SE corner
            ], {
                color: '#10b981',
                fillColor: '#10b981',
                fillOpacity: 0.2,
                weight: 2
            }).addTo(coverageMap);

            // Add city markers
            const cities = [
                { name: 'Miami', coords: [25.7617, -80.1918] },
                { name: 'Fort Lauderdale', coords: [26.1224, -80.1373] },
                { name: 'Boca Raton', coords: [26.3683, -80.1289] },
                { name: 'West Palm Beach', coords: [26.7153, -80.0534] }
            ];

            cities.forEach(city => {
                L.marker(city.coords)
                    .bindPopup(`<strong>${city.name}</strong><br>‚úÖ Service Available`)
                    .addTo(coverageMap);
            });

            // Set map view to South Florida
            coverageMap.setView([26.2, -80.2], 8);

        } else if (area === 'austin') {
            // Austin coverage area
            const austinPolygon = L.polygon([
                [30.0, -98.0], // SW corner
                [30.8, -98.0], // NW corner
                [30.8, -97.3], // NE corner
                [30.0, -97.3]  // SE corner
            ], {
                color: '#3b82f6',
                fillColor: '#3b82f6',
                fillOpacity: 0.2,
                weight: 2
            }).addTo(coverageMap);

            // Add Austin area city markers
            const austinCities = [
                { name: 'Austin', coords: [30.2672, -97.7431] },
                { name: 'Round Rock', coords: [30.5082, -97.6789] },
                { name: 'Cedar Park', coords: [30.5052, -97.8203] },
                { name: 'Georgetown', coords: [30.6327, -97.6779] }
            ];

            austinCities.forEach(city => {
                L.marker(city.coords)
                    .bindPopup(`<strong>${city.name}</strong><br>üöÄ Now Available!`)
                    .addTo(coverageMap);
            });

            // Set map view to Austin area
            coverageMap.setView([30.4, -97.7], 9);
        }
    }

    // AI Photo Triage System
    let currentPhotoFile = null;

    function initAIPhotoTriage() {
        console.log('ü§ñ Initializing AI Photo Triage...');

        const photoInput = document.getElementById('photoInput');
        const browseInput = document.getElementById('browseInput');
        const uploadPrompt = document.getElementById('uploadPrompt');
        const photoPreview = document.getElementById('photoPreview');
        const previewImage = document.getElementById('previewImage');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const retakeBtn = document.getElementById('retakeBtn');
        const uploadArea = document.getElementById('photoUploadArea');
        const takePhotoBtn = uploadPrompt?.querySelector('button:first-of-type');
        const browsePhotoBtn = document.getElementById('browsePhotoBtn');

        // Debug element availability
        console.log('Elements found:', {
            photoInput: !!photoInput,
            browseInput: !!browseInput,
            uploadPrompt: !!uploadPrompt,
            browsePhotoBtn: !!browsePhotoBtn,
            takePhotoBtn: !!takePhotoBtn
        });

        if (!photoInput || !browseInput || !browsePhotoBtn) {
            console.error('‚ùå Critical AI photo elements missing!');
            return;
        }

        // File input change handlers
        photoInput.addEventListener('change', handlePhotoSelection);
        browseInput.addEventListener('change', handlePhotoSelection);
        console.log('‚úÖ Photo input event listeners added');

        // Mobile-specific button handlers
        takePhotoBtn.addEventListener('click', () => {
            // Trigger camera on mobile devices
            photoInput.click();
        });

        browsePhotoBtn.addEventListener('click', () => {
            // Trigger file browser
            browseInput.click();
        });

        // Drag and drop handlers (desktop only)
        if (!isMobileDevice()) {
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);
            uploadArea.addEventListener('dragleave', handleDragLeave);
        }

        // Touch optimizations for mobile
        if (isMobileDevice()) {
            // Add mobile-specific touch feedback
            addTouchFeedback(takePhotoBtn);
            addTouchFeedback(browsePhotoBtn);
            addTouchFeedback(analyzeBtn);
            addTouchFeedback(retakeBtn);
        }

        // Analysis button
        analyzeBtn.addEventListener('click', analyzePhoto);

        // Retake button
        retakeBtn.addEventListener('click', resetPhotoUpload);

        // Book service and view tasks buttons
        const bookServiceBtn = document.getElementById('bookServiceBtn');
        const viewTasksBtn = document.getElementById('viewTasksBtn');
        const analyzeAgainBtn = document.getElementById('analyzeAgainBtn');
        const uploadNewPhotoBtn = document.getElementById('uploadNewPhotoBtn');

        if (bookServiceBtn) {
            bookServiceBtn.addEventListener('click', () => {
                // Get the AI recommended service and pre-select it
                const recommendedTask = document.getElementById('recommendedTask').textContent;

                // Scroll to Select Your Service section
                document.getElementById('book').scrollIntoView({ behavior: 'smooth' });

                // Pre-select the recommended service after a short delay
                setTimeout(() => {
                    preSelectAIRecommendedService(recommendedTask);
                }, 500);
            });
        }

        if (viewTasksBtn) {
            viewTasksBtn.addEventListener('click', () => {
                document.getElementById('tasks').scrollIntoView({ behavior: 'smooth' });
            });
        }

        if (analyzeAgainBtn) {
            analyzeAgainBtn.addEventListener('click', () => {
                if (currentPhotoFile) {
                    analyzePhoto();
                } else {
                    alert('No photo available to re-analyze. Please upload a new photo.');
                }
            });
        }

        if (uploadNewPhotoBtn) {
            uploadNewPhotoBtn.addEventListener('click', resetPhotoUpload);
        }

        // Error dismiss button
        const dismissErrorBtn = document.getElementById('dismissErrorBtn');
        if (dismissErrorBtn) {
            dismissErrorBtn.addEventListener('click', hideFileError);
        }
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
        e.currentTarget.style.borderColor = '#2563eb';
        e.currentTarget.style.backgroundColor = '#eff6ff';
    }

    function handleDragLeave(e) {
        e.preventDefault();
        e.stopPropagation();
        e.currentTarget.style.borderColor = '#93c5fd';
        e.currentTarget.style.backgroundColor = '';
    }

    function handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const file = files[0];
            if (file.type.startsWith('image/')) {
                handlePhotoFile(file);
            } else {
                alert('Please drop an image file (JPG, PNG, WebP)');
            }
        }

        // Reset drag styling
        handleDragLeave(e);
    }

    function handlePhotoSelection(e) {
        console.log('üì∑ Photo selection triggered:', e.target.id, e.target.files.length);
        const file = e.target.files[0];
        if (file) {
            console.log('üì∑ File selected:', file.name, file.type, `${(file.size/1024/1024).toFixed(2)}MB`);
            handlePhotoFile(file);
        } else {
            console.log('‚ùå No file selected');
        }
    }

    function handlePhotoFile(file) {
        console.log('üì∑ Processing photo file:', file.name);

        // Hide any previous errors
        hideFileError();

        // Validate file type first
        if (!file.type.startsWith('image/')) {
            console.log('‚ùå Invalid file type:', file.type);
            showFileError('Invalid file type. Please select a photo (JPG, PNG, WebP, or GIF format).', false);
            return;
        }

        // Check for specific unsupported formats
        const supportedFormats = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];
        if (!supportedFormats.includes(file.type.toLowerCase())) {
            const formatName = file.type.split('/')[1]?.toUpperCase() || 'Unknown';
            showFileError(
                `${formatName} format is not supported by our AI analysis. Please use JPG, PNG, WebP, or GIF format. You can convert your image using most photo editing apps or online converters.`,
                false
            );
            return;
        }

        // Check file size - account for base64 encoding expansion (~33% increase)
        // API limit is 5MB after base64, so we need to limit uploads to ~3.7MB before encoding
        const maxSizeBeforeEncoding = 3.7 * 1024 * 1024; // ~3.7MB raw = ~5MB after base64

        if (file.size > maxSizeBeforeEncoding) {
            const sizeMB = (file.size / (1024 * 1024)).toFixed(1);
            const estimatedEncodedSizeMB = (file.size * 1.33 / (1024 * 1024)).toFixed(1);
            showFileError(
                `Photo is ${sizeMB}MB (${estimatedEncodedSizeMB}MB after processing). Our AI requires photos under 3.7MB for analysis. Would you like us to compress it automatically?`,
                true,
                file
            );
            return;
        }

        currentPhotoFile = file;

        // Create preview
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewImage = document.getElementById('previewImage');
            previewImage.src = e.target.result;

            // Show preview, hide upload prompt
            document.getElementById('uploadPrompt').classList.add('hidden');
            document.getElementById('photoPreview').classList.remove('hidden');

            // Hide any previous results
            document.getElementById('analysisResults').classList.add('hidden');
            document.getElementById('analysisError').classList.add('hidden');
        };
        reader.readAsDataURL(file);
    }

    function showFileError(message, showCompress = false, file = null) {
        document.getElementById('fileErrorMessage').textContent = message;
        document.getElementById('fileError').classList.remove('hidden');

        const compressBtn = document.getElementById('compressPhotoBtn');
        if (showCompress && file) {
            compressBtn.classList.remove('hidden');
            compressBtn.onclick = () => compressAndProcessImage(file);
        } else {
            compressBtn.classList.add('hidden');
        }
    }

    function hideFileError() {
        document.getElementById('fileError').classList.add('hidden');
        document.getElementById('compressPhotoBtn').classList.add('hidden');
    }

    async function compressAndProcessImage(file) {
        try {
            document.getElementById('fileError').classList.add('hidden');

            // Show a simple loading indicator
            const loadingMsg = document.createElement('div');
            loadingMsg.id = 'compressionLoading';
            loadingMsg.className = 'mt-4 p-3 bg-warm-50 border border-warm-200 rounded-warm text-warm-700 text-sm';
            loadingMsg.innerHTML = 'üóúÔ∏è Compressing photo... This may take a moment.';
            document.getElementById('photoUploadArea').appendChild(loadingMsg);

            // Use more aggressive compression for AI analysis (need to stay under 5MB after base64)
            const quality = 0.5; // More aggressive compression for AI analysis
            const maxWidth = 1280; // Smaller max width to ensure size reduction
            const compressedFile = await compressImage(file, quality, maxWidth);

            // Remove loading message
            const loading = document.getElementById('compressionLoading');
            if (loading) loading.remove();

            // Verify compressed file is small enough for AI analysis
            const compressedSizeMB = (compressedFile.size / (1024 * 1024)).toFixed(1);
            const estimatedEncodedSize = compressedFile.size * 1.33;

            if (estimatedEncodedSize > 5 * 1024 * 1024) {
                // Still too large, try more aggressive compression
                console.log(`First compression: ${compressedSizeMB}MB still too large, trying more aggressive compression...`);
                const veryCompressedFile = await compressImage(file, 0.3, 960); // Very aggressive

                const finalSizeMB = (veryCompressedFile.size / (1024 * 1024)).toFixed(1);
                const finalEncodedSize = veryCompressedFile.size * 1.33;

                if (finalEncodedSize > 5 * 1024 * 1024) {
                    showFileError(`Even after compression, the image (${finalSizeMB}MB) is too large for AI analysis. Please try a smaller image or take a new photo.`, false);
                    return;
                }

                console.log(`‚úÖ Aggressive compression successful: ${finalSizeMB}MB`);
                handlePhotoFile(veryCompressedFile);
            } else {
                console.log(`‚úÖ Compression successful: ${compressedSizeMB}MB`);
                // Process compressed file
                handlePhotoFile(compressedFile);
            }

        } catch (error) {
            const loading = document.getElementById('compressionLoading');
            if (loading) loading.remove();

            showFileError('Compression failed. Please try a different photo or reduce the file size manually.', false);
        }
    }

    function compressImage(file, quality = 0.7, maxWidth = 1920) {
        return new Promise((resolve) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();

            img.onload = function() {
                // Calculate new dimensions
                const ratio = Math.min(maxWidth / img.width, maxWidth / img.height);
                const newWidth = img.width * ratio;
                const newHeight = img.height * ratio;

                canvas.width = newWidth;
                canvas.height = newHeight;

                // Draw and compress
                ctx.drawImage(img, 0, 0, newWidth, newHeight);

                canvas.toBlob(function(blob) {
                    const compressedFile = new File([blob], file.name, {
                        type: 'image/jpeg',
                        lastModified: Date.now()
                    });
                    resolve(compressedFile);
                }, 'image/jpeg', quality);
            };

            img.src = URL.createObjectURL(file);
        });
    }

    function resetPhotoUpload() {
        currentPhotoFile = null;
        document.getElementById('photoInput').value = '';
        document.getElementById('uploadPrompt').classList.remove('hidden');
        document.getElementById('photoPreview').classList.add('hidden');
        document.getElementById('analysisResults').classList.add('hidden');
        document.getElementById('analysisError').classList.add('hidden');
        document.getElementById('analysisLoading').classList.add('hidden');
        hideFileError();

        // Remove any compression loading messages
        const loadingMsg = document.getElementById('compressionLoading');
        if (loadingMsg) loadingMsg.remove();
    }

    async function analyzePhoto() {
        if (!currentPhotoFile) {
            alert('Please select a photo first');
            return;
        }

        // Show loading state
        document.getElementById('photoPreview').classList.add('hidden');
        document.getElementById('analysisLoading').classList.remove('hidden');
        document.getElementById('analysisResults').classList.add('hidden');
        document.getElementById('analysisError').classList.add('hidden');

        try {
            // Convert image to base64
            const base64Image = await fileToBase64(currentPhotoFile);

            // Call AI analysis function with extended timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 45000); // 45 second timeout

            const response = await fetch('/.netlify/functions/ai-photo-analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    image: base64Image,
                    filename: currentPhotoFile.name
                }),
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
                throw new Error(`Analysis failed: ${response.statusText}`);
            }

            const result = await response.json();

            // Check if this is an unsupported format error
            if (result.error_type === 'unsupported_format') {
                showFileError(result.urgency_notes, false);
                return;
            }

            displayAnalysisResult(result);

        } catch (error) {
            console.error('AI analysis error:', error);

            // Show user-friendly error message
            let userMessage = 'Analysis temporarily unavailable. Please try again in a moment.';

            // Check for specific error types
            if (error.name === 'AbortError' || error.message.includes('aborted')) {
                userMessage = 'Analysis timed out after 45 seconds. This can happen with large images or slow connections. Try compressing your image or check your internet connection.';
            } else if (error.message.includes('Failed to fetch') || error.message.includes('ERR_TIMED_OUT')) {
                userMessage = 'Connection timeout or network issue. Please check your internet connection and try again. Large images may take longer to analyze.';
            } else if (error.message.includes('413') || error.message.includes('too large')) {
                userMessage = 'Photo is too large for analysis. Please try a smaller image or use the compression option.';
            } else if (error.message.includes('timeout') || error.message.includes('network')) {
                userMessage = 'Connection timeout. Please check your internet connection and try again.';
            } else if (error.message.includes('429')) {
                userMessage = 'Service temporarily busy. Please wait a moment and try again.';
            } else if (error.message.includes('media type') || error.message.includes('does not match')) {
                userMessage = 'Image format not supported. Please upload a JPG, PNG, WebP, or GIF image and try again.';
            } else if (error.message.includes('invalid_request_error')) {
                userMessage = 'Invalid image format detected. Please ensure your image is in JPG, PNG, WebP, or GIF format.';
            }

            showAnalysisError(userMessage);
        }
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }

    function displayAnalysisResult(result) {
        // Hide loading state
        document.getElementById('analysisLoading').classList.add('hidden');

        // Populate result fields
        document.getElementById('problemDescription').textContent = result.problem_description || 'Unable to identify specific problem';
        document.getElementById('recommendedTask').textContent = result.recommended_task || 'General repair consultation';
        document.getElementById('costEstimate').textContent = result.cost_estimate || 'Starting at $240';

        // Handle out-of-scope services
        const isOutOfScope = result.task_category === 'out_of_scope';
        const bookServiceBtn = document.getElementById('bookServiceBtn');

        if (isOutOfScope) {
            bookServiceBtn.textContent = 'üîç Find Specialized Contractor';
            bookServiceBtn.classList.remove('btn-warm-primary');
            bookServiceBtn.classList.add('bg-gray-500', 'text-white', 'rounded-warm');
            bookServiceBtn.onclick = () => {
                alert('This service falls outside our handyman offerings. We recommend searching for specialized contractors for this type of work.');
            };
        } else {
            bookServiceBtn.textContent = 'üìû Book This Service Now';
            bookServiceBtn.classList.remove('bg-gray-500');
            bookServiceBtn.classList.add('btn-warm-primary');
            bookServiceBtn.onclick = () => bookAIRecommendedService(result.task_category);
        }

        // Set risk level with appropriate styling
        const riskLevel = document.getElementById('riskLevel');
        const riskText = result.risk_level || 'moderate';
        const riskStyles = {
            'low': 'text-green-800 bg-green-100 border border-green-200',
            'moderate': 'text-yellow-800 bg-yellow-100 border border-yellow-200',
            'high': 'text-red-800 bg-red-100 border border-red-200',
            'urgent': 'text-red-900 bg-red-200 border border-red-300'
        };

        const styleClasses = riskStyles[riskText.toLowerCase()] || riskStyles['moderate'];

        riskLevel.innerHTML = `
            <span class="px-3 py-1 rounded-full text-sm font-semibold ${styleClasses}">
                ${riskText.toUpperCase()}
            </span>
        `;

        // Set urgency assessment
        const urgencyText = document.getElementById('urgencyText');
        const urgencySection = document.getElementById('urgencySection');

        urgencyText.textContent = result.urgency_notes || 'This repair should be addressed in a reasonable timeframe to prevent potential issues.';

        // Style urgency section based on risk level
        if (riskText.toLowerCase() === 'urgent' || riskText.toLowerCase() === 'high') {
            urgencySection.className = 'mt-6 p-4 rounded-warm bg-red-50 border border-red-200';
        } else if (riskText.toLowerCase() === 'moderate') {
            urgencySection.className = 'mt-6 p-4 rounded-warm bg-yellow-50 border border-yellow-200';
        } else {
            urgencySection.className = 'mt-6 p-4 rounded-warm bg-warm-50 border border-warm-200';
        }

        // Show results
        document.getElementById('analysisResults').classList.remove('hidden');
    }

    function showAnalysisError(customMessage = null) {
        document.getElementById('analysisLoading').classList.add('hidden');

        // Update error message if custom message provided
        if (customMessage) {
            const errorDiv = document.getElementById('analysisError');
            const errorText = errorDiv.querySelector('p');
            if (errorText) {
                errorText.textContent = customMessage;
            }
        }

        document.getElementById('analysisError').classList.remove('hidden');

        const retryBtn = document.getElementById('retryBtn');
        retryBtn.addEventListener('click', () => {
            document.getElementById('analysisError').classList.add('hidden');
            document.getElementById('photoPreview').classList.remove('hidden');
        });
    }

    // Mobile detection and touch optimization helpers
    function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
               window.innerWidth <= 768 ||
               ('ontouchstart' in window);
    }

    function addTouchFeedback(element) {
        if (!element) return;

        element.addEventListener('touchstart', function() {
            this.style.transform = 'scale(0.95)';
            this.style.opacity = '0.8';
        }, { passive: true });

        element.addEventListener('touchend', function() {
            this.style.transform = 'scale(1)';
            this.style.opacity = '1';
        }, { passive: true });

        element.addEventListener('touchcancel', function() {
            this.style.transform = 'scale(1)';
            this.style.opacity = '1';
        }, { passive: true });
    }

    // Improve mobile file handling
    function optimizeForMobile() {
        if (isMobileDevice()) {
            // Reduce image quality on mobile for faster processing
            const style = document.createElement('style');
            style.textContent = `
                #previewImage {
                    image-rendering: optimizeSpeed;
                }
                .touch-manipulation {
                    touch-action: manipulation;
                }
            `;
            document.head.appendChild(style);
        }
    }

    // Function to book AI recommended service (from "Book This Service" button)
    function bookAIRecommendedService(taskCategory) {
        console.log('üìÖ Booking AI recommended service:', taskCategory);

        // Use the existing selectService function to populate the form
        selectService(taskCategory);

        // Scroll to the booking section
        const bookingSection = document.getElementById('bookingSection');
        if (bookingSection) {
            bookingSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Show a brief confirmation message
        const confirmMsg = document.createElement('div');
        confirmMsg.innerHTML = `
            <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4 text-green-800">
                ‚úÖ Service selected based on AI analysis. Please review details below and book your appointment.
            </div>
        `;

        // Insert confirmation above the booking form
        const taskDetails = document.getElementById('taskDetails');
        if (taskDetails && taskDetails.style.display !== 'none') {
            taskDetails.insertAdjacentElement('beforebegin', confirmMsg);

            // Remove confirmation after 5 seconds
            setTimeout(() => {
                if (confirmMsg.parentNode) {
                    confirmMsg.remove();
                }
            }, 5000);
        }
    }

    // Function to pre-select AI recommended service
    function preSelectAIRecommendedService(recommendedTaskName) {
        // Map AI task names to dropdown values
        const taskMapping = {
            'TV Wall Mount (32‚Äì65")': 'tv_mount',
            'Ceiling Fan Install/Replace': 'ceiling_fan',
            'Light Fixture / Chandelier Swap': 'light_fixture',
            'Faucet / Showerhead Replace': 'faucet_showerhead',
            'Smart Doorbell Install': 'smart_doorbell',
            'Curtain Rods / Blinds': 'curtains_blinds',
            'Floating Shelf Install': 'floating_shelf',
            'Appliance Hookup (W/D/DW)': 'appliance_hookup',
            'Furniture Assembly (S‚ÄìM)': 'furniture_assembly',
            'Closet Organizer Install': 'closet_organizer',
            'General Handyman (3+ hours)': 'general_handyman'
        };

        const taskCategory = document.getElementById('taskCategory');
        const mappedValue = taskMapping[recommendedTaskName];

        if (mappedValue && taskCategory) {
            // Select the recommended service
            taskCategory.value = mappedValue;

            // Trigger the change event to populate the task details
            const changeEvent = new Event('change', { bubbles: true });
            taskCategory.dispatchEvent(changeEvent);

            // Highlight the selection temporarily
            taskCategory.style.background = '#f0f9ff';
            taskCategory.style.borderColor = '#0ea5e9';

            setTimeout(() => {
                taskCategory.style.background = '';
                taskCategory.style.borderColor = '';
            }, 2000);
        }
    }


    console.log('üìú JavaScript finished loading');
</script>
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PW9HC7HL"
                  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
</body>
</html>